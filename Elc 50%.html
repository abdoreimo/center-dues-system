<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج حساب تعويض 50% من استهلاك الكهرباء والغاز</title>
    <meta name="description" content="برنامج احترافي لحساب وإدارة تعويضات استهلاك الكهرباء والغاز">
    <meta name="theme-color" content="#0d9488">
    <!-- Include SheetJS library for XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS for styled XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <!-- Google Font for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- CSS Variables --- Aurora Teal Fresh Theme --- */
        :root {
            /* Primary Palette - Teal & Coral */
            --primary-color: #0d9488;
            --primary-dark-color: #0f766e;
            --secondary-color: #6366f1;
            --accent-color: #f97316;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #eab308;
            --info-color: #0ea5e9;
            --light-color: #f0fdfa;
            --dark-color: #134e4a;
            --background-light: #f8fffe;
            --background-white: #ffffff;
            --background-section: #f0fdfa;
            --border-color: rgba(13, 148, 136, 0.18);
            --border-light-color: rgba(13, 148, 136, 0.08);
            --text-color: #1e293b;
            --text-secondary-color: #64748b;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #0d9488 0%, #6366f1 100%);
            --gradient-secondary: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --gradient-success: linear-gradient(135deg, #22c55e 0%, #0d9488 100%);
            --gradient-honey: linear-gradient(135deg, #0d9488 0%, #0f766e 50%, #6366f1 100%);
            --gradient-sunset: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
            --gradient-warm: linear-gradient(135deg, #f97316 0%, #eab308 100%);
            
            /* Soft Glow Effects */
            --glow-primary: 0 8px 32px rgba(13, 148, 136, 0.2);
            --glow-success: 0 8px 25px rgba(34, 197, 94, 0.2);
            --glow-danger: 0 8px 25px rgba(239, 68, 68, 0.2);
            --glow-accent: 0 8px 30px rgba(249, 115, 22, 0.2);

            /* Spacing */
            --space-xs: 5px;
            --space-sm: 10px;
            --space-md: 20px;
            --space-lg: 30px;
            --space-xl: 40px;

            /* Typography */
            --font-family: 'IBM Plex Sans Arabic', 'Cairo', sans-serif;
            --font-size-base: 1em;
            --font-size-h1: 2.2em;
            --font-size-h2: 1.8em;
            --font-size-h3: 1.4em;
            --font-size-h4: 1.1em;

            /* Borders */
            --border-radius-sm: 5px;
            --border-radius-md: 10px;
            --border-radius-lg: 25px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 20px rgba(13, 148, 136, 0.08);
            --shadow-lg: 0 12px 40px rgba(13, 148, 136, 0.12);
            --shadow-xl: 0 20px 60px rgba(13, 148, 136, 0.15);
            --shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        /* --- General Styles --- */
        * {
            box-sizing: border-box;
        }
        
        /* Custom Scrollbar - Honey Theme */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #fef3c7;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
        }
        
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--background-light);
            direction: rtl;
            text-align: right;
            line-height: 1.7;
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* App Wrapper - Main Layout */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* =========== SIDEBAR STYLES =========== */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: linear-gradient(180deg, #fef3c7 0%, #fde68a 50%, #fcd34d 100%);
            color: #000;
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            box-shadow: -5px 0 30px rgba(120, 53, 15, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid #f59e0b;
        }

        .sidebar.collapsed {
            width: 80px;
            min-width: 80px;
        }

        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .nav-item span,
        .sidebar.collapsed .theme-toggle span,
        .sidebar.collapsed .stats-btn span,
        .sidebar.collapsed .sidebar-clock {
            display: none;
        }

        .sidebar.collapsed .nav-item,
        .sidebar.collapsed .theme-toggle,
        .sidebar.collapsed .stats-btn {
            justify-content: center;
            padding: 15px;
        }

        .sidebar.collapsed .nav-item i,
        .sidebar.collapsed .theme-toggle i,
        .sidebar.collapsed .stats-btn i {
            margin-left: 0;
            font-size: 1.3em;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-container i {
            font-size: 2em;
            color: #d97706;
            text-shadow: 0 0 20px rgba(217, 119, 6, 0.4);
        }

        .logo-text {
            font-size: 1.1em;
            font-weight: 700;
            white-space: nowrap;
            color: #000;
        }

        .sidebar-toggle {
            background: rgba(120, 53, 15, 0.1);
            border: none;
            color: #78350f;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-toggle:hover {
            background: rgba(120, 53, 15, 0.2);
            transform: scale(1.1);
        }

        .sidebar-clock {
            padding: 20px;
            text-align: center;
            background: rgba(245, 158, 11, 0.1);
            margin: 15px;
            border-radius: 15px;
            border: 1px solid rgba(120, 53, 15, 0.2);
        }

        .clock-time {
            font-size: 2em;
            font-weight: 700;
            color: #d97706;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 15px rgba(217, 119, 6, 0.4);
        }

        .clock-date {
            font-size: 0.9em;
            color: #78350f;
            margin-top: 5px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .nav-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            margin-bottom: 8px;
            background: transparent;
            border: none;
            color: #000000;
            font-size: 1em;
            font-family: inherit;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
            text-align: right;
        }

        .nav-item:hover {
            background: rgba(245, 158, 11, 0.2);
            color: #000;
            transform: translateX(-5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            color: #fff;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }

        .nav-item.home-btn {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.2) 100%);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #000;
        }

        .nav-item.home-btn:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.4) 0%, rgba(22, 163, 74, 0.4) 100%);
        }

        .nav-item i {
            font-size: 1.2em;
            width: 25px;
            text-align: center;
            color: #78350f;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(120, 53, 15, 0.2);
        }

        .theme-toggle, .stats-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            margin-bottom: 8px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(120, 53, 15, 0.2);
            color: #000000;
            font-size: 0.95em;
            font-family: inherit;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .theme-toggle:hover, .stats-btn:hover {
            background: rgba(245, 158, 11, 0.25);
            color: #000;
        }

        /* =========== MAIN CONTENT AREA =========== */
        .main-content {
            flex: 1;
            margin-right: 280px;
            background: var(--background-light);
            min-height: 100vh;
            transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed ~ .main-content {
            margin-right: 80px;
        }

        .top-bar {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 15px rgba(120, 53, 15, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid #f59e0b;
        }

        .page-title h1 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 700;
            color: #000000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title h1 i {
            color: #d97706;
            font-size: 1.2em;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .quick-stats {
            display: flex;
            gap: 15px;
        }

        .quick-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            font-weight: 600;
            color: #000000;
            font-size: 0.95em;
            border: 1px solid rgba(120, 53, 15, 0.2);
        }

        .quick-stat i {
            color: #d97706;
        }

        .quick-stat.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .quick-stat.success i {
            color: #16a34a;
        }

        .help-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            border: none;
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
        }

        .content-area {
            padding: 30px;
            padding-bottom: 80px;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(100px);
            z-index: -1;
        }

        header {
            background: var(--gradient-honey);
            color: white;
            padding: var(--space-lg) 0;
            text-align: center;
            margin-bottom: var(--space-xl);
            border-radius: 20px;
            box-shadow: var(--shadow-xl), 0 0 60px rgba(245, 158, 11, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: headerShine 8s linear infinite;
        }
        
        @keyframes headerShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        header h1 {
            margin: 0;
            font-size: var(--font-size-h1);
            font-weight: 700;
            font-family: 'Aref Ruqaa', 'Amiri', 'Cairo', serif;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3),
                         0 0 40px rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-sm);
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        header h1 i {
            display: inline-block;
            animation: floatIcon 3s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.7));
        }
        
        @keyframes floatIcon {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(10deg); }
        }

        nav {
            margin-top: var(--space-md);
        }

        nav button {
            margin: 0 8px;
            padding: 13px 28px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            color: white;
            border-radius: 50px;
            font-size: 1.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-family: var(--font-family);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            position: relative;
            overflow: hidden;
        }
        
        nav button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        nav button:hover::before {
            width: 300px;
            height: 300px;
        }

        nav button:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25));
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        nav button.active {
            background: linear-gradient(145deg, white, rgba(255, 255, 255, 0.9));
            color: var(--primary-dark-color);
            border-color: white;
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4),
                        inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        nav button:active {
             transform: translateY(0);
             box-shadow: var(--shadow-sm);
        }

        /* =========== NEW SECTION STYLES =========== */
        .app-section {
            background: #fff;
            padding: 0;
            margin-bottom: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            display: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .app-section::before {
            display: none;
        }
        
        .app-section.active {
            display: block;
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Header */
        .section-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 25px 30px;
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            color: #fff;
        }

        .section-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
        }

        .section-title-info h2 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 700;
            color: #ffffff !important;
            padding: 0;
            margin-bottom: 5px;
        }

        .section-title-info h2::after {
            display: none;
        }

        .section-desc {
            margin: 0;
            font-size: 0.95em;
            opacity: 0.9;
            color: #ffffff !important;
        }

        .section-content {
            padding: 30px;
        }

        .app-section h2, .app-section h3 {
            color: var(--primary-dark-color);
            padding-bottom: var(--space-md);
            margin-bottom: var(--space-lg);
            font-weight: 700;
            font-family: 'Aref Ruqaa', 'Amiri', 'Cairo', serif;
            position: relative;
            display: inline-block;
        }
        
        .app-section h2::after, .app-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-honey);
            border-radius: 3px;
        }
        
        .app-section h2 { font-size: var(--font-size-h2); }
        .app-section h3 { font-size: var(--font-size-h3); }

        /* Form Cards */
        .form-card {
            background: var(--background-section);
            border-radius: 16px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .form-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px 25px;
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: #ffffff;
            font-size: 1.1em;
        }

        .form-card-header i {
            color: #fbbf24;
            font-size: 1.2em;
        }

        .form-card-body {
            padding: 25px;
        }

        .form-group {
            flex: 1 1 300px;
        }
        
        .form-actions {
            margin-top: 30px;
            text-align: center;
        }
        
        .save-btn {
            padding: 16px 50px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: #fff;
            font-size: 1.15em;
            font-weight: 700;
            font-family: inherit;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .save-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
        }


        form > div {
            margin-bottom: var(--space-md);
        }
         .form-row > div {
             margin-bottom: 0;
         }

         .form-row {
             display: flex;
             gap: var(--space-lg);
             margin-bottom: var(--space-md);
             flex-wrap: wrap;
         }
         .form-row > div {
             flex: 1 1 250px;
         }
          #beneficiary-form .form-row > div {
              flex: 1 1 180px;
          }
         form button[type="submit"]:not(.modal-buttons button) {
            margin-top: var(--space-lg);
         }


        form label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--text-secondary-color);
            font-size: 1.05em;
        }

        form input[type="text"],
        form input[type="number"],
        form select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            box-sizing: border-box;
            text-align: right;
            font-size: var(--font-size-base);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-color);
            box-shadow: 0 2px 10px rgba(245, 158, 11, 0.08);
        }
         form input[type="text"]:focus,
         form input[type="number"]:focus,
         form select:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15),
                         0 4px 15px rgba(245, 158, 11, 0.2);
             outline: none;
             transform: translateY(-2px);
         }
        input[readonly] {
            background-color: var(--border-light-color) !important;
            cursor: not-allowed;
        }

        /* Primary form submit buttons */
        form button[type="submit"]:not(.modal-buttons button) {
            padding: 15px 35px;
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.35);
            font-weight: 700;
            font-family: var(--font-family);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
        }

        form button[type="submit"]:not(.modal-buttons button):hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.45);
        }
         form button[type="submit"]:not(.modal-buttons button):active {
             transform: translateY(0);
             box-shadow: var(--shadow-sm);
         }

        /* Generic Button Grouping */
        .button-group {
             display: flex;
             align-items: center;
             gap: var(--space-sm);
             margin-top: var(--space-md);
             flex-wrap: wrap;
        }
        .button-group button {
            margin-left: 0;
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            font-family: var(--font-family);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            color: white;
            font-weight: 600;
        }
        .button-group button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        #backup-restore-section .button-group button { 
            background: var(--gradient-sunset);
        }
        #backup-restore-section .button-group button:hover { 
            box-shadow: 0 10px 30px rgba(251, 146, 60, 0.4);
        }
        #reporting-section .button-group button { 
            background: var(--gradient-primary);
        }
        #reporting-section .button-group button:hover { 
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }
        #reporting-section .button-group button:disabled {
              background: linear-gradient(135deg, #9ca3af, #6b7280);
              cursor: not-allowed;
              transform: none;
              box-shadow: none;
        }
        .explanation {
             margin-top: var(--space-sm);
             font-size: 0.9em;
             color: var(--text-secondary-color);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: var(--space-md);
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.12);
            border-radius: 16px;
            overflow: hidden;
            background-color: white;
        }

        table th, table td {
            border-bottom: 1px solid rgba(245, 158, 11, 0.08);
            padding: 16px 20px;
            text-align: right;
            font-size: 0.95em;
        }

        th {
            background: var(--gradient-honey);
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        tbody tr:nth-child(even) {
            background-color: rgba(245, 158, 11, 0.03);
        }
         tbody tr:hover {
             background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), rgba(234, 88, 12, 0.08));
             transform: scale(1.01);
             box-shadow: 0 4px 15px rgba(245, 158, 11, 0.15);
             transition: all 0.3s ease;
         }

        .report-output {
            margin-top: var(--space-md);
            padding: var(--space-md);
            padding-bottom: 50px;
            border: 1px dashed var(--border-color);
            background-color: var(--background-white);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
            font-size: 12px;
            overflow-x: auto;
            font-family: 'Amiri', serif !important;
            position: relative;
        }

        .report-output table {
            border: 2px solid var(--dark-color);
            font-family: 'Amiri', serif !important;
        }
        .report-output th, .report-output td {
             border: 1px solid var(--text-color);
             padding: var(--space-sm);
             text-align: center;
             font-size: 11px;
             font-family: 'Amiri', serif !important;
        }
        .report-output th {
            background-color: #FFE0B2;
            color: var(--dark-color);
        }
        .report-output .total-row th,
        .report-output .total-row td {
            font-weight: bold;
            background-color: var(--border-color);
        }
        #compensation-summary-table .total-row td {
            font-weight: bold;
            background-color: var(--border-color);
        }

        /* Ticker Tape Styles */
        #ticker-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--gradient-honey);
            color: white;
            overflow: hidden;
            box-shadow: 0 -5px 30px rgba(245, 158, 11, 0.3);
            line-height: 50px;
            white-space: nowrap;
            z-index: 1000;
            font-size: 1em;
         }

         #ticker-content {
             display: inline-block;
             position: absolute;
             left: -100%;
             right: auto;
             animation: scrollTickerLeftToRight 35s linear infinite;
         }

         @keyframes scrollTickerLeftToRight {
             0% { transform: translateX(100vw); }
             100% { transform: translateX(-100%); }
         }

         #ticker-content span {
             margin-right: 50px;
         }

         .ticker-item {
             display: inline-block;
             padding: 0 30px;
             border-left: 2px solid rgba(255, 255, 255, 0.3);
         }

         .ticker-item i {
             margin-left: 8px;
             color: rgba(255, 255, 255, 0.9);
         }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(120, 53, 15, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible {
             display: flex;
             opacity: 1;
        }
        .modal-overlay.visible .modal-content {
             transform: translateY(0) scale(1);
             opacity: 1;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(245, 158, 11, 0.3);
            max-width: 550px;
            width: 90%;
            text-align: right;
            transform: translateY(-30px) scale(0.95);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
            border: 1px solid rgba(245, 158, 11, 0.1);
        }
         .modal-buttons {
             text-align: left;
             margin-top: var(--space-lg);
         }
          .modal-buttons button {
             margin-left: var(--space-sm);
             padding: 12px 24px;
             border: none;
             border-radius: 50px;
             cursor: pointer;
             font-size: 1em;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
             font-family: var(--font-family);
             display: inline-flex;
             align-items: center;
             gap: var(--space-xs);
             font-weight: 600;
          }
           .modal-buttons .save-button {
               background: var(--gradient-success);
               color: white;
           }
            .modal-buttons .save-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
           .modal-buttons .cancel-button {
               background: linear-gradient(135deg, #64748b, #475569);
               color: white;
           }
            .modal-buttons .cancel-button:hover {
                 transform: translateY(-2px);
                 box-shadow: 0 8px 25px rgba(146, 64, 14, 0.4);
            }

        /* Mode Selection Modal */
        #mode-selection-modal {
            background: rgba(120, 53, 15, 0.9);
            z-index: 2000;
        }
        #mode-selection-modal .modal-content {
            max-width: 650px;
            text-align: center;
            background: rgba(255, 255, 255, 0.98);
            padding: 50px;
        }
        .mode-btn {
            display: block;
            width: 100%;
            padding: 22px;
            margin: 12px 0;
            font-size: 1.2em;
            border: 2px solid transparent;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(234, 88, 12, 0.05));
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--dark-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .mode-btn:hover {
            background: var(--gradient-honey);
            color: white;
            transform: scale(1.03) translateY(-2px);
            border-color: transparent;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
        }
        .mode-btn i {
            font-size: 1.5em;
        }

        /* Focus indicator */
        *:focus-visible {
            outline: 3px solid rgba(245, 158, 11, 0.5);
            outline-offset: 3px;
        }
        input:focus, select:focus, button:focus {
           outline: none;
        }
        
        /* --- Compensation Grid Section Styles --- */
        #compensation-management-section {
            display: none; /* Managed by JS */
            flex-direction: column;
        }
        
        /* Credit Cards - New Design */
        .credit-summary-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .credit-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 25px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 16px;
            color: #fff;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
            transition: all 0.3s;
        }
        
        .credit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.4);
        }
        
        .credit-card i {
            font-size: 2.2em;
            opacity: 0.9;
        }
        
        .credit-info {
            display: flex;
            flex-direction: column;
        }
        
        .credit-label {
            font-size: 0.9em;
            opacity: 0.85;
            margin-bottom: 5px;
        }
        
        .credit-value {
            font-size: 1.4em;
            font-weight: 700;
        }
        
        .credit-card.spent {
            background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%);
        }
        
        .credit-card.discounts {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .credit-card.remaining {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .credit-card.remaining.negative-credit {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse-warning 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 15px 50px rgba(239, 68, 68, 0.5); }
        }
        
        .credit-card.remaining .remaining-credit-value.negative {
            color: #fef3c7;
            font-weight: bold;
        }
        
        /* Toggle Switch */
        .auto-save-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .auto-save-toggle input {
            display: none;
        }
        
        .toggle-slider {
            width: 50px;
            height: 26px;
            background: #fde68a;
            border-radius: 25px;
            position: relative;
            transition: all 0.3s;
        }
        
        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            top: 3px;
            right: 3px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .auto-save-toggle input:checked + .toggle-slider {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .auto-save-toggle input:checked + .toggle-slider::before {
            right: 27px;
        }
        
        .toggle-label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .primary-action-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            border: none;
            color: #fff;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.3);
        }
        
        .primary-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }
        
        /* Export Cards Grid */
        .export-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .export-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px 20px;
            background: #fff;
            border-radius: 16px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .export-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.15);
        }
        
        .export-icon {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        
        .export-icon.print { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; }
        .export-icon.excel { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; }
        .export-icon.text { background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); color: #fff; }
        .export-icon.cdrom { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; }
        
        .export-label {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--dark-color);
            margin-bottom: 5px;
        }
        
        .export-desc {
            font-size: 0.9em;
            color: var(--text-secondary-color);
        }
        
        .report-preview-section {
            background: var(--background-section);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }
        
        .report-preview-section h3 {
            margin-top: 0;
        }
        
        /* Backup Cards Grid */
        .backup-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .backup-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px;
            background: #fff;
            border-radius: 16px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .backup-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }
        
        .backup-card.create:hover { border-color: var(--primary-color); }
        .backup-card.restore:hover { border-color: var(--success-color); }
        .backup-card.danger:hover { border-color: var(--danger-color); }
        .backup-card.import-txt:hover { border-color: var(--info-color); }
        
        .backup-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        
        .backup-card.create .backup-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; }
        .backup-card.restore .backup-icon { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; }
        .backup-card.danger .backup-icon { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; }
        .backup-card.import-txt .backup-icon { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: #fff; }
        
        /* Import TXT Modal Styles - Compact Design */
        #import-txt-modal .modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px 25px;
        }
        
        #import-txt-modal h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #import-txt-modal > .modal-content > p {
            margin: 0 0 10px 0;
            font-size: 0.95em;
        }
        
        .import-format-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .import-option {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px;
            background: var(--background-section);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .import-option.highlight-option {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(2, 132, 199, 0.1));
            border-color: var(--info-color);
        }
        
        .import-option:hover {
            border-color: var(--primary-color);
            background: rgba(245, 158, 11, 0.05);
        }
        
        .import-option input[type="radio"] {
            margin-top: 2px;
            accent-color: var(--primary-color);
            flex-shrink: 0;
        }
        
        .import-option input[type="radio"]:checked + .option-text {
            color: var(--primary-dark-color);
        }
        
        .option-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .option-text strong {
            font-size: 0.95em;
        }
        
        .option-text small {
            color: var(--text-secondary-color);
            font-family: monospace;
            direction: ltr;
            text-align: left;
            font-size: 0.75em;
        }
        
        .import-options-extra {
            margin: 10px 0;
            padding: 10px 15px;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        /* ===== Pro TXT Editor Styles ===== */
        .pro-editor-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
        }
        .pro-editor-info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .info-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .info-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .info-card i { font-size: 1.8em; color: #8b5cf6; opacity: 0.9; }
        .info-card.highlight { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; }
        .info-card.highlight i { color: #fff; }
        .info-card.highlight .info-label { color: rgba(255,255,255,0.85); }
        .info-card.highlight .info-value { color: #fff; }
        .info-details { display: flex; flex-direction: column; gap: 4px; }
        .info-label { font-size: 0.85em; color: var(--text-secondary-color); }
        .info-value { font-size: 1.3em; font-weight: 700; color: var(--dark-color); }

        .pro-editor-actions { display: flex; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; }
        .pro-action-btn {
            display: flex; align-items: center; gap: 10px; padding: 14px 24px;
            border: none; border-radius: 50px; font-size: 1em; font-weight: 600;
            font-family: inherit; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .pro-action-btn.export-btn { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; }
        .pro-action-btn.export-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(34,197,94,0.4); }
        .pro-action-btn.print-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; }
        .pro-action-btn.print-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(245,158,11,0.4); }
        .pro-action-btn.reset-btn { background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: #fff; }
        .pro-action-btn.reset-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(100,116,139,0.4); }
        .pro-action-btn.import-btn { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; }
        .pro-action-btn.import-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(59,130,246,0.4); }
        .pro-action-btn.load-btn { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; }
        .pro-action-btn.load-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(139,92,246,0.4); }
        .pro-action-btn.clear-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; }
        .pro-action-btn.clear-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(239,68,68,0.4); }

        .pro-editor-controls {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .pro-editor-controls .control-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .pro-editor-controls .control-group { display: flex; flex-direction: column; gap: 6px; }
        .pro-editor-controls .control-group label { font-size: 0.85em; font-weight: 600; color: var(--text-secondary-color); display: flex; align-items: center; gap: 6px; }
        .pro-editor-controls .control-group label i { color: #8b5cf6; }
        .pro-editor-controls .control-group input,
        .pro-editor-controls .control-group select {
            padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 1em; font-family: inherit; transition: all 0.3s; background: #fff;
        }
        .pro-editor-controls .control-group input:focus,
        .pro-editor-controls .control-group select:focus {
            border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,0.15); outline: none;
        }

        .pro-editor-table-container { overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .pro-editor-table { width: 100%; border-collapse: collapse; background: #fff; }
        .pro-editor-table th, .pro-editor-table td { padding: 12px 15px; text-align: center; border: 1px solid var(--border-color); }
        .pro-editor-table thead th { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: #fff; font-weight: 600; font-size: 0.9em; position: sticky; top: 0; z-index: 10; }
        .pro-editor-table tbody tr:nth-child(even) { background: rgba(139,92,246,0.03); }
        .pro-editor-table tbody tr:hover { background: rgba(139,92,246,0.08); }
        .pro-editor-table td:nth-child(2) { text-align: right; padding-right: 20px; }
        .pro-editor-table td:nth-child(4) { font-family: monospace; font-size: 0.85em; direction: ltr; }
        .pro-editor-table .amount-input { width: 120px; padding: 8px 12px; text-align: center; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; font-weight: 600; transition: all 0.3s; background: #fff; }
        .pro-editor-table .amount-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,0.2); outline: none; }
        .pro-editor-table .amount-input.modified { border-color: #22c55e; background: rgba(34,197,94,0.05); }
        .pro-account-input { width: 100px; padding: 8px 10px; text-align: center; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9em; font-weight: 600; transition: all 0.3s; background: #fff; }
        .pro-account-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,0.2); outline: none; }
        .pro-rip-display { font-family: monospace; font-size: 0.85em; direction: ltr; }
        .pro-editor-table tfoot .total-row th,
        .pro-editor-table tfoot .total-row td { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: #fff; font-size: 1.1em; font-weight: 700; }
        .original-amount { color: var(--text-secondary-color); font-size: 0.95em; }
        .pro-editor-table .delete-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; border: none; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .pro-editor-table .delete-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(239,68,68,0.4); }

        .pro-empty-state { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; background: #f8fafc; border-radius: 12px; color: var(--text-secondary-color); }
        .pro-empty-state.visible { display: flex; }
        .pro-empty-state i { font-size: 4em; color: #cbd5e1; margin-bottom: 20px; }
        .pro-empty-state p { font-size: 1.2em; margin: 5px 0; }
        .pro-empty-state .hint { font-size: 0.95em; color: #94a3b8; }

        @media screen and (max-width: 768px) {
            .pro-editor-info-cards { grid-template-columns: repeat(2, 1fr); }
            .pro-editor-actions { justify-content: center; }
            .pro-action-btn { flex: 1; min-width: 140px; justify-content: center; }
            .pro-editor-controls .control-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media screen and (max-width: 480px) {
            .pro-editor-info-cards { grid-template-columns: 1fr; }
            .pro-editor-controls .control-row { grid-template-columns: 1fr; }
        }
        
        .import-preview {
            margin-top: 10px;
            padding: 12px;
            background: var(--background-white);
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }
        
        .import-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .import-preview h4 {
            margin: 0;
            color: var(--primary-dark-color);
            font-size: 1em;
        }
        
        .selection-buttons {
            display: flex;
            gap: 6px;
        }
        
        .btn-select-all, .btn-select-none {
            padding: 5px 10px;
            font-size: 0.8em;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-select-all {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        
        .btn-select-all:hover {
            background: #059669;
        }
        
        .btn-select-none {
            background: var(--background-white);
            color: var(--text-color);
        }
        
        .preview-table-container {
            max-height: 150px !important;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        
        #import-preview-table {
            font-size: 0.8em;
            margin: 0;
        }
        
        #import-preview-table th,
        #import-preview-table td {
            padding: 6px 8px;
        }
        
        .preview-count {
            margin: 8px 0 0 0;
            font-size: 0.9em;
        }
        
        #import-txt-modal .modal-buttons {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        #import-txt-modal .modal-buttons button {
            padding: 10px 20px;
            font-size: 0.95em;
        }
        
        @media screen and (max-width: 600px) {
            .import-format-options {
                grid-template-columns: 1fr;
            }
            
            #import-txt-modal .modal-content {
                max-width: 95%;
                padding: 15px;
            }
        }
        
        .btn-select-none:hover {
            background: var(--background-section);
        }
        
        .import-row-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        #import-preview-table th:first-child,
        #import-preview-table td:first-child {
            text-align: center;
            width: 40px;
        }
        
        .preview-table-container {
            max-height: 200px;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        #import-preview-table {
            width: 100%;
            font-size: 0.85em;
            margin: 0;
        }
        
        #import-preview-table th,
        #import-preview-table td {
            padding: 8px 12px;
            text-align: right;
            white-space: nowrap;
        }
        
        #import-preview-table th {
            background: var(--gradient-honey);
            color: #fff;
            font-weight: 600;
        }
        
        .preview-count {
            margin: 15px 0 0 0;
            text-align: center;
            font-weight: 600;
            color: var(--success-color);
        }
        
        .preview-count span {
            font-size: 1.2em;
            color: var(--primary-dark-color);
        }
        
        .backup-label {
            font-weight: 700;
            font-size: 1.15em;
            color: var(--dark-color);
            margin-bottom: 8px;
        }
        
        .backup-desc {
            font-size: 0.9em;
            color: var(--text-secondary-color);
        }
        
        .compensation-grid-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            gap: 20px;
            flex-wrap: wrap;
        }
        .compensation-grid-toolbar .search-container {
            position: relative;
            flex-grow: 1;
            min-width: 250px;
        }
        .compensation-grid-toolbar .search-container i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary-color);
        }
        #compensation-grid-search {
            width: 100%;
            padding: 14px 45px 14px 18px;
            border-radius: 50px;
            border: 2px solid rgba(245, 158, 11, 0.2);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }
        #compensation-grid-search:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
        }
        #add-beneficiary-btn {
            background: var(--gradient-honey);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.35);
        }
        #add-beneficiary-btn:hover { 
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(245, 158, 11, 0.45);
        }

        .compensation-grid-container {
            overflow-x: auto;
            max-height: 70vh;
        }
        #compensation-grid-table { 
            table-layout: fixed;
            border: 2px solid rgba(245, 158, 11, 0.3);
        }
        #compensation-grid-table th, #compensation-grid-table td {
            text-align: center;
            vertical-align: middle;
            padding: 12px;
            white-space: nowrap;
            border: 1px solid rgba(245, 158, 11, 0.15);
        }
        
        /* Beneficiary Name Column with Actions */
        #compensation-grid-table th:nth-child(2),
        #compensation-grid-table td:nth-child(2) {
            text-align: right;
            width: 280px;
            white-space: normal;
            border-bottom: none !important;
        }
        .beneficiary-name-cell {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-sm);
            border-bottom: 2px solid rgba(245, 158, 11, 0.2);
            padding-bottom: 10px;
        }
        .beneficiary-name-cell .beneficiary-actions {
            display: flex;
            gap: var(--space-xs);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        tr:hover .beneficiary-name-cell .beneficiary-actions {
            opacity: 1;
        }
        .beneficiary-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: var(--text-secondary-color);
            transition: all 0.2s ease;
        }
        .beneficiary-actions button:hover {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(234, 88, 12, 0.1));
            color: var(--primary-color);
        }
        .beneficiary-actions .edit-btn-inline:hover { color: var(--warning-color); }
        .beneficiary-actions .delete-btn-inline:hover { color: var(--danger-color); }


        #compensation-grid-table th:nth-child(1),
        #compensation-grid-table td:nth-child(1) { width: 50px; }
        #compensation-grid-table th.status-column { width: 120px; }

        .editable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
            border-radius: var(--border-radius-sm);
        }
        .editable-cell:hover {
            background-color: var(--light-color);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3) inset;
        }
        .grid-input {
            width: 100px;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            border: 2px solid rgba(245, 158, 11, 0.2);
            font-size: 0.95em;
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .grid-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
            outline: none;
        }
        .calculated-cell { font-weight: bold; color: var(--text-secondary-color); }
        .net-payable-cell { color: var(--success-color); font-size: 1.1em; }

        tr.is-dirty { background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(234, 88, 12, 0.08)) !important; }
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            text-align: center;
        }
        .status-badge.empty { background: linear-gradient(135deg, #9ca3af, #6b7280); color: white; }
        .status-badge.saved { background: var(--gradient-success); }
        .status-badge.unsaved { background: var(--gradient-sunset); color: white; }


        /* Responsive Design */
        @media screen and (max-width: 1200px) {
            .sidebar {
                width: 80px;
                min-width: 80px;
            }
            
            .sidebar .logo-text,
            .sidebar .nav-item span,
            .sidebar .theme-toggle span,
            .sidebar .stats-btn span,
            .sidebar .sidebar-clock {
                display: none;
            }
            
            .sidebar .nav-item,
            .sidebar .theme-toggle,
            .sidebar .stats-btn {
                justify-content: center;
                padding: 15px;
            }
            
            .sidebar .nav-item i,
            .sidebar .theme-toggle i,
            .sidebar .stats-btn i {
                margin-left: 0;
                font-size: 1.3em;
            }
            
            .main-content {
                margin-right: 80px;
            }
        }
        
        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1100;
            width: 50px;
            height: 50px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            border: none;
            color: #fff;
            font-size: 1.4em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }
        
        @media screen and (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .sidebar {
                position: fixed;
                right: -280px;
                width: 280px;
                min-width: 280px;
                transition: right 0.3s;
            }
            
            .sidebar.mobile-open {
                right: 0;
            }
            
            .sidebar.mobile-open .logo-text,
            .sidebar.mobile-open .nav-item span,
            .sidebar.mobile-open .theme-toggle span,
            .sidebar.mobile-open .stats-btn span,
            .sidebar.mobile-open .sidebar-clock {
                display: block;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding-top: 70px;
            }
            
            .page-title h1 {
                font-size: 1.1em;
            }
            
            .quick-stats {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .content-area {
                padding: 15px;
            }
            
            .credit-summary-container {
                grid-template-columns: 1fr;
            }
            
            .export-actions-grid,
            .backup-actions-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .compensation-grid-toolbar {
                flex-direction: column;
            }
            
            .compensation-grid-toolbar .search-container {
                width: 100%;
            }
            
            .actions-container {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        @media screen and (max-width: 480px) {
            .export-actions-grid,
            .backup-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .credit-card {
                padding: 18px;
            }
            
            .credit-card i {
                font-size: 1.6em;
            }
            
            .credit-value {
                font-size: 1.2em;
            }
        }

        /* Scroll to Top Button */
        .scroll-to-top-btn {
            position: fixed;
            bottom: 70px;
            left: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            color: #fff;
            border: none;
            font-size: 1.4em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .scroll-to-top-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .scroll-to-top-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.5);
        }
        
        /* Credit Warning Banner */
        .credit-warning-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 280px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 600;
            z-index: 1001;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }
        
        .credit-warning-banner.visible {
            transform: translateY(0);
        }
        
        .credit-warning-banner i {
            font-size: 1.3em;
            animation: pulse-icon 1s ease-in-out infinite;
        }
        
        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .credit-warning-banner .warning-text {
            flex: 1;
        }
        
        .credit-warning-banner .close-warning-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .credit-warning-banner .close-warning-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sidebar.collapsed ~ .main-content .credit-warning-banner {
            right: 80px;
        }
        
        @media screen and (max-width: 768px) {
            .credit-warning-banner {
                right: 0;
                font-size: 0.9em;
            }
            
            .scroll-to-top-btn {
                bottom: 60px;
                left: 15px;
                width: 45px;
                height: 45px;
            }
        }

        /* Print Specific Styles */
        @media print {
            body {
                padding: 0; margin: 0; background: #ffffff !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; font-family: 'Amiri', serif !important; color: #000 !important;
            }

            body::before {
                display: none !important;
            }
            
            body > * {
                display: none !important;
            }
            #print-report-content {
                display: block !important;
                background: #ffffff !important;
            }

            @page {
                size: landscape; 
                margin: 1cm 1cm 2cm 1cm;
                @bottom-left {
                    content: "الصفحة " counter(page) " من " counter(pages);
                    font-family: 'Amiri', serif;
                    font-size: 10pt;
                    color: #000;
                }
            }

            #print-report-content.report-output {
                padding: 0; margin: 0; border: none; box-shadow: none; overflow: hidden; 
                font-size: 10pt; color: #000 !important; background-color: #ffffff !important;
                font-family: 'Amiri', serif !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                height: auto;
                max-height: 100%;
            }
            
            #print-report-content * {
                page-break-after: avoid !important;
            }
            
            #print-report-content .report-footer {
                orphans: 3;
                widows: 3;
            }
            #print-report-content table {
                width: 100%; border-collapse: collapse; table-layout: fixed; 
                border: 2px solid #000 !important;
                background-color: #ffffff !important;
            }
            #print-report-content th, #print-report-content td {
                font-size: 9pt; padding: 3px 5px; text-align: center; 
                border: 1px solid #000 !important; color: #000 !important;
                background-color: #ffffff !important;
                word-wrap: break-word; /* Prevents text overflow */
                vertical-align: middle; /* Better vertical alignment */
            }
            
            #print-report-content tbody tr {
                background-color: #ffffff !important;
            }
            /* Defining column widths for better layout control */
            #print-report-content th:nth-child(1), #print-report-content td:nth-child(1) { width: 4%; }
            #print-report-content th:nth-child(2), #print-report-content td:nth-child(2) { width: 20%; text-align: right; padding-right: 8px; }
            #print-report-content th:nth-child(3), #print-report-content td:nth-child(3) { width: 8%; }
            #print-report-content th:nth-child(4), #print-report-content td:nth-child(4) { width: 16%; }
            #print-report-content th:nth-child(5), #print-report-content td:nth-child(5) { width: 6%; }
            #print-report-content th:nth-child(6), #print-report-content td:nth-child(6) { width: 6%; }
            #print-report-content th:nth-child(7), #print-report-content td:nth-child(7) { width: 6%; }
            #print-report-content th:nth-child(8), #print-report-content td:nth-child(8) { width: 6%; }
            #print-report-content th:nth-child(9), #print-report-content td:nth-child(9) { width: 8%; font-weight: bold; }
            #print-report-content th:nth-child(10), #print-report-content td:nth-child(10) { width: 8%; }
            #print-report-content th:nth-child(11), #print-report-content td:nth-child(11) { width: 12%; font-weight: bold; }
            
            #print-report-content th { 
                background-color: #E0E0E0 !important; 
            }
            
            /* تكرار رأس الجدول في كل صفحة */
            #print-report-content thead {
                display: table-header-group;
            }
            #print-report-content tbody {
                display: table-row-group;
            }
            
            #print-report-content .total-row th,
            #print-report-content .total-row td { 
                background-color: #E0E0E0 !important; 
                font-weight: bold;
            }
            #print-report-content .report-header, 
            #print-report-content .report-footer {
                color: #000 !important;
                page-break-after: avoid;
                page-break-inside: avoid;
            }
            
            #print-report-content .report-header p,
            #print-report-content .report-footer p {
                margin: 2px 0 !important;
                line-height: 1.2 !important;
            }
            
            #print-report-content .report-footer {
                margin-top: 8px !important;
                margin-bottom: 0 !important;
            }
            
            #print-report-content table {
                page-break-after: avoid;
                margin-bottom: 5px !important;
            }
        }

        /* ============================================= */
        /* ========== CREATIVE NEW FEATURES =========== */
        /* ============================================= */

        /* --- Floating Action Buttons --- */
        .fab-container {
            position: fixed;
            bottom: 70px;
            left: 25px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .fab-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
        }
        
        .fab-btn:hover {
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }
        
        .fab-btn.stats-toggle {
            background: var(--gradient-sunset);
        }
        
        .fab-btn.keyboard-help {
            background: var(--gradient-secondary);
        }
        
        .fab-btn.scroll-top {
            background: var(--gradient-success);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .fab-btn.scroll-top.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- Live Clock Widget --- */
        .live-clock {
            position: absolute;
            top: 15px;
            left: 25px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .live-clock .time {
            font-weight: bold;
            font-size: 1.1em;
            font-family: 'Courier New', monospace;
        }
        
        .live-clock .date {
            font-size: 0.85em;
            opacity: 0.9;
        }

        /* --- Statistics Dashboard --- */
        .stats-dashboard {
            position: fixed;
            top: 50%;
            right: -420px;
            transform: translateY(-50%);
            width: 400px;
            max-height: 80vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px 0 0 24px;
            box-shadow: -10px 0 50px rgba(245, 158, 11, 0.25);
            z-index: 1500;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 30px;
            border: 1px solid rgba(245, 158, 11, 0.1);
        }
        
        .stats-dashboard.open {
            right: 0;
        }
        
        .stats-dashboard h3 {
            margin: 0 0 25px 0;
            color: var(--primary-dark-color);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3em;
        }
        
        .stats-dashboard .close-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary-color);
            transition: all 0.3s ease;
        }
        
        .stats-dashboard .close-stats:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }
        
        .stat-card {
            background: var(--gradient-honey);
            color: white;
            padding: 22px;
            border-radius: 18px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(245, 158, 11, 0.4);
        }
        
        .stat-card.success { background: var(--gradient-success); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); }
        .stat-card.info { background: var(--gradient-sunset); box-shadow: 0 8px 25px rgba(251, 146, 60, 0.3); }
        .stat-card.warning { background: var(--gradient-sunset); box-shadow: 0 8px 25px rgba(250, 112, 154, 0.3); }
        
        .stat-card .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }
        
        .stat-card .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 18px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.1);
        }
        

        /* --- Keyboard Shortcuts Modal --- */
        .keyboard-modal {
            display: none;
        }
        
        .keyboard-modal.visible {
            display: flex;
        }
        
        .shortcut-list {
            display: grid;
            gap: 12px;
        }
        
        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(234, 88, 12, 0.08));
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .shortcut-item:hover {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(234, 88, 12, 0.15));
            transform: translateX(-5px);
        }
        
        .shortcut-key {
            background: var(--gradient-honey);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            min-width: 90px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        /* --- Particle Background --- */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        /* --- Achievement Popup --- */
        .achievement-popup {
            position: fixed;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-honey);
            color: white;
            padding: 18px 35px;
            border-radius: 60px;
            box-shadow: 0 15px 50px rgba(245, 158, 11, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: bold;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .achievement-popup.show {
            top: 25px;
        }
        
        .achievement-popup i {
            font-size: 1.6em;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        /* --- Progress Bar --- */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: rgba(245, 158, 11, 0.1);
            z-index: 9999;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--gradient-honey);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }

        /* --- Pulse Animation for important elements --- */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* --- Gradient Text --- */
        .gradient-text {
            background: var(--gradient-honey);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        /* --- Floating Labels Effect --- */
        .floating-label-group {
            position: relative;
        }
        
        .floating-label-group label {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            transition: all 0.3s ease;
            pointer-events: none;
            background: white;
            padding: 0 5px;
        }
        
        .floating-label-group input:focus + label,
        .floating-label-group input:not(:placeholder-shown) + label {
            top: 0;
            font-size: 0.8em;
            color: var(--primary-color);
        }

        /* --- Ripple Effect --- */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255,255,255,0.3) 10%, transparent 10%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10);
            opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
        }
        
        .ripple:active::after {
            transform: scale(0);
            opacity: 1;
            transition: 0s;
        }

        /* --- Glassmorphism Cards --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
        }
        
        /* --- Animated Counter --- */
        .animated-counter {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        
        .animated-counter.counting {
            animation: countPulse 0.3s ease;
        }
        
        @keyframes countPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); color: var(--success-color); }
        }

        /* --- Quick Actions Bar --- */
        .quick-actions-bar {
            position: fixed;
            bottom: 60px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .quick-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .quick-action-btn.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark-color));
            color: white;
        }
        
        .quick-action-btn.success {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            color: white;
        }

                        /* ================================================================ */
        /* ========== AURORA TEAL - COMPLETE FRESH REDESIGN ============= */
        /* ================================================================ */

        body {
            background: linear-gradient(135deg, #f0fdfa 0%, #ecfdf5 30%, #f0f9ff 70%, #faf5ff 100%) !important;
            color: #1e293b !important;
            font-family: 'IBM Plex Sans Arabic', 'Cairo', sans-serif !important;
        }
        body::before {
            content: '' !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important;
            background:
                radial-gradient(ellipse at 20% 50%, rgba(13, 148, 136, 0.06) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 20%, rgba(99, 102, 241, 0.06) 0%, transparent 60%),
                radial-gradient(ellipse at 50% 80%, rgba(249, 115, 22, 0.04) 0%, transparent 60%) !important;
            z-index: -2 !important;
            pointer-events: none !important;
        }
        body::after {
            content: '' !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important;
            background-image: radial-gradient(1px 1px at 50% 50%, rgba(13, 148, 136, 0.08) 50%, transparent 50%) !important;
            background-size: 60px 60px !important;
            z-index: -1 !important;
            pointer-events: none !important;
            opacity: 0.4 !important;
        }

        /* Scrollbar - Teal */
        ::-webkit-scrollbar { background: #f0fdfa !important; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #0d9488, #6366f1) !important;
            border-radius: 10px !important;
            border: 2px solid #f0fdfa !important;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #0d9488, #4f46e5) !important;
        }

        /* Sidebar - Fresh Light */
        .sidebar {
            background: linear-gradient(180deg, #ffffff 0%, #f0fdfa 50%, #ecfdf5 100%) !important;
            border-left: 1px solid rgba(13, 148, 136, 0.1) !important;
            box-shadow: -5px 0 30px rgba(13, 148, 136, 0.06) !important;
        }
        .sidebar-header {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.06), rgba(99, 102, 241, 0.06)) !important;
            border-bottom: 1px solid rgba(13, 148, 136, 0.1) !important;
        }
        .sidebar-header h3 {
            color: #0d9488 !important;
            text-shadow: none !important;
        }
        .sidebar-header p { color: #64748b !important; }
        .sidebar .live-clock {
            color: #0d9488 !important;
            text-shadow: none !important;
        }

        /* Nav Items - Light */
        .nav-item {
            background: rgba(255, 255, 255, 0.6) !important;
            border: 1px solid rgba(13, 148, 136, 0.06) !important;
            color: #475569 !important;
            border-radius: 12px !important;
            margin: 3px 10px !important;
            transition: all 0.3s ease !important;
        }
        .nav-item:hover {
            background: rgba(13, 148, 136, 0.06) !important;
            border-color: rgba(13, 148, 136, 0.18) !important;
            color: #0d9488 !important;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.06) !important;
            transform: translateX(-3px) !important;
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.08), rgba(99, 102, 241, 0.08)) !important;
            border-color: rgba(13, 148, 136, 0.2) !important;
            color: #0d9488 !important;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.08) !important;
        }
        .nav-item i { color: inherit !important; }
        .nav-item span { color: inherit !important; }

        .home-button {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.08), rgba(99, 102, 241, 0.08)) !important;
            border: 1px solid rgba(13, 148, 136, 0.15) !important;
            color: #0d9488 !important;
        }
        .home-button:hover {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.18), rgba(99, 102, 241, 0.18)) !important;
            border-color: rgba(13, 148, 136, 0.3) !important;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.1) !important;
        }

        /* Main Content */
        .main-content { background: transparent !important; }

        /* Top Bar - Light Glass */
        .top-bar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(20px) !important;
            border-bottom: 1px solid rgba(13, 148, 136, 0.08) !important;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.04) !important;
        }
        .top-bar h2 { color: #1e293b !important; }
        .top-bar h2 i { color: #0d9488 !important; }
        .quick-stats .stat-item {
            background: rgba(13, 148, 136, 0.04) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
            color: #475569 !important;
        }
        .quick-stats .stat-item .stat-number { color: #0d9488 !important; font-weight: 700 !important; }
        .help-btn {
            background: rgba(99, 102, 241, 0.06) !important;
            border: 1px solid rgba(99, 102, 241, 0.15) !important;
            color: #6366f1 !important;
        }
        .help-btn:hover {
            background: rgba(99, 102, 241, 0.12) !important;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1) !important;
        }

        /* Sections - Frosted Glass */
        .section {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(15px) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
            border-radius: 20px !important;
            box-shadow: 0 8px 32px rgba(13, 148, 136, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
            color: #1e293b !important;
        }
        .section-header {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.06), rgba(99, 102, 241, 0.06)) !important;
            border-bottom: 1px solid rgba(13, 148, 136, 0.08) !important;
            color: #1e293b !important;
        }
        .section-header i {
            color: #0d9488 !important;
            text-shadow: none !important;
        }
        .section-header h2 { color: #1e293b !important; }
        .section-header .header-badge {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            color: #fff !important;
        }

        /* Form Cards - Light */
        .form-card, .card {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
            border-radius: 16px !important;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.04) !important;
            color: #1e293b !important;
        }
        .form-card h3, .card h3, .form-card h4, .card h4 {
            color: #0d9488 !important;
        }
        .form-card label, .card label {
            color: #475569 !important;
            font-weight: 600 !important;
        }

        /* Form Inputs - Light */
        .form-card input, .form-card select, .form-card textarea,
        input[type="text"], input[type="number"], input[type="date"],
        input[type="email"], input[type="tel"], select, textarea {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(13, 148, 136, 0.12) !important;
            border-radius: 10px !important;
            color: #1e293b !important;
            padding: 10px 14px !important;
            transition: all 0.3s ease !important;
        }
        .form-card input:focus, .form-card select:focus, .form-card textarea:focus,
        input:focus, select:focus, textarea:focus {
            border-color: #0d9488 !important;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.08), 0 4px 12px rgba(13, 148, 136, 0.06) !important;
            outline: none !important;
            background: #fff !important;
        }
        .form-card input::placeholder, input::placeholder { color: #94a3b8 !important; }
        select option {
            background: #fff !important;
            color: #1e293b !important;
        }

        /* Buttons - Teal Gradient */
        .btn, button:not(.nav-item):not(.assistant-fab):not(.assistant-panel *):not(.mode-btn):not(.quick-action-btn):not(.mobile-menu-btn):not(.scroll-to-top-btn) {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            color: #fff !important;
            border: none !important;
            border-radius: 12px !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.2) !important;
            transition: all 0.3s ease !important;
        }
        .btn:hover, button:not(.nav-item):not(.assistant-fab):not(.assistant-panel *):not(.mode-btn):not(.quick-action-btn):not(.mobile-menu-btn):not(.scroll-to-top-btn):hover {
            box-shadow: 0 6px 25px rgba(13, 148, 136, 0.3) !important;
            transform: translateY(-2px) !important;
        }
        .btn-success, .btn.success {
            background: linear-gradient(135deg, #22c55e, #0d9488) !important;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2) !important;
        }
        .btn-danger, .btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2) !important;
        }
        .btn-warning, .btn.warning {
            background: linear-gradient(135deg, #f59e0b, #ea580c) !important;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2) !important;
        }

        /* Tables - Clean Light */
        table {
            border-collapse: separate !important;
            border-spacing: 0 !important;
            border-radius: 16px !important;
            overflow: hidden !important;
            box-shadow: 0 4px 20px rgba(13, 148, 136, 0.06) !important;
        }
        table thead th {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%) !important;
            color: #fff !important;
            font-weight: 700 !important;
            padding: 14px 12px !important;
            border-bottom: none !important;
            text-align: center !important;
        }
        table tbody tr { transition: all 0.3s ease !important; }
        table tbody td {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1e293b !important;
            padding: 12px !important;
            border-bottom: 1px solid rgba(13, 148, 136, 0.06) !important;
            text-align: center !important;
        }
        table tbody tr:hover td {
            background: rgba(13, 148, 136, 0.03) !important;
        }
        table tbody tr:nth-child(even) td {
            background: rgba(240, 253, 250, 0.7) !important;
        }
        table tbody tr:nth-child(even):hover td {
            background: rgba(13, 148, 136, 0.05) !important;
        }
        table tbody td .btn, table tbody td button {
            padding: 5px 12px !important;
            font-size: 0.85em !important;
            border-radius: 8px !important;
        }
        .actions-cell button, table .btn { margin: 2px !important; }

        /* Credit Cards - Teal Light */
        .credit-card {
            background: linear-gradient(145deg, #ffffff, #f0fdfa) !important;
            border: 1px solid rgba(13, 148, 136, 0.1) !important;
            border-radius: 18px !important;
            color: #1e293b !important;
            box-shadow: 0 8px 25px rgba(13, 148, 136, 0.06) !important;
            overflow: hidden !important;
            position: relative !important;
        }
        .credit-card::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important; left: 0 !important; right: 0 !important;
            height: 3px !important;
            background: linear-gradient(90deg, #0d9488, #6366f1, #f97316) !important;
        }
        .credit-card h3 { color: #0d9488 !important; }
        .credit-card .amount { color: #1e293b !important; font-weight: 700 !important; }
        .credit-card .label { color: #64748b !important; }

        /* Export & Backup Cards */
        .export-card, .backup-card {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
            border-radius: 16px !important;
            color: #1e293b !important;
        }
        .export-card i, .backup-card i {
            color: #0d9488 !important;
        }
        .export-card:hover, .backup-card:hover {
            border-color: rgba(13, 148, 136, 0.2) !important;
            box-shadow: 0 8px 25px rgba(13, 148, 136, 0.08) !important;
        }

        /* Modals - Light */
        .modal-overlay, .modal {
            background: rgba(13, 148, 136, 0.08) !important;
            backdrop-filter: blur(8px) !important;
        }
        .modal-content, .modal > div {
            background: rgba(255, 255, 255, 0.98) !important;
            border: 1px solid rgba(13, 148, 136, 0.1) !important;
            border-radius: 20px !important;
            color: #1e293b !important;
            box-shadow: 0 25px 60px rgba(13, 148, 136, 0.12) !important;
        }
        .modal-content h2, .modal-content h3 { color: #0d9488 !important; }
        .modal-content .close-btn { color: #94a3b8 !important; }
        .modal-content .close-btn:hover { color: #ef4444 !important; }

        /* Mode Selection */
        .mode-btn {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(13, 148, 136, 0.1) !important;
            color: #475569 !important;
            border-radius: 14px !important;
            transition: all 0.3s ease !important;
        }
        .mode-btn:hover {
            border-color: rgba(13, 148, 136, 0.25) !important;
            background: rgba(13, 148, 136, 0.04) !important;
            color: #0d9488 !important;
        }
        .mode-btn.active, .mode-btn.selected {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.08), rgba(99, 102, 241, 0.08)) !important;
            border-color: rgba(13, 148, 136, 0.25) !important;
            color: #0d9488 !important;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.08) !important;
        }
        .mode-btn i { color: inherit !important; }

        /* Grid Inputs */
        .grid-input, .month-input {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(13, 148, 136, 0.1) !important;
            color: #1e293b !important;
            border-radius: 8px !important;
        }
        .grid-input:focus, .month-input:focus {
            border-color: #0d9488 !important;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.08) !important;
        }
        .month-label { color: #475569 !important; }

        /* Status Badges */
        .status-badge, .badge {
            border-radius: 20px !important;
            padding: 4px 12px !important;
            font-weight: 600 !important;
            font-size: 0.8em !important;
        }
        .status-badge.success, .badge.success { background: rgba(34, 197, 94, 0.08) !important; color: #16a34a !important; border: 1px solid rgba(34, 197, 94, 0.2) !important; }
        .status-badge.warning, .badge.warning { background: rgba(245, 158, 11, 0.08) !important; color: #d97706 !important; border: 1px solid rgba(245, 158, 11, 0.2) !important; }
        .status-badge.danger, .badge.danger { background: rgba(239, 68, 68, 0.08) !important; color: #dc2626 !important; border: 1px solid rgba(239, 68, 68, 0.2) !important; }

        /* Ticker */
        .ticker, .news-ticker {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(13, 148, 136, 0.06) !important;
            color: #475569 !important;
        }

        /* Report Preview */
        .report-preview, .report-container {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
            color: #1e293b !important;
            border-radius: 16px !important;
        }
        .report-preview h3 { color: #0d9488 !important; }

        /* Pro Editor */
        .pro-editor-controls, .editor-controls {
            background: rgba(255, 255, 255, 0.95) !important;
            border-bottom: 1px solid rgba(13, 148, 136, 0.08) !important;
        }
        .pro-editor-controls button, .editor-controls button {
            background: rgba(13, 148, 136, 0.04) !important;
            border: 1px solid rgba(13, 148, 136, 0.1) !important;
            color: #475569 !important;
        }
        .pro-editor-controls button:hover, .editor-controls button:hover {
            background: rgba(13, 148, 136, 0.1) !important;
            color: #0d9488 !important;
        }
        .pro-editor-table th, .editor-table th {
            background: linear-gradient(135deg, #0d9488, #0f766e) !important;
            color: #fff !important;
            border-bottom: none !important;
        }
        .pro-editor-table td, .editor-table td {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1e293b !important;
            border: 1px solid rgba(13, 148, 136, 0.06) !important;
        }
        .summary-cards .card, .summary-card {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.04), rgba(99, 102, 241, 0.04)) !important;
            border: 1px solid rgba(13, 148, 136, 0.1) !important;
            color: #1e293b !important;
        }

        /* Import UI */
        .import-dropzone, .drop-zone {
            background: rgba(240, 253, 250, 0.6) !important;
            border: 2px dashed rgba(13, 148, 136, 0.25) !important;
            border-radius: 16px !important;
            color: #64748b !important;
        }
        .import-dropzone:hover, .drop-zone:hover {
            border-color: rgba(13, 148, 136, 0.45) !important;
            background: rgba(13, 148, 136, 0.04) !important;
        }
        .import-dropzone i, .drop-zone i { color: #0d9488 !important; }
        .import-preview, .preview-container {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
            color: #1e293b !important;
        }
        .beneficiary-search {
            background: rgba(255, 255, 255, 0.8) !important;
            color: #1e293b !important;
            border: 1px solid rgba(13, 148, 136, 0.15) !important;
        }
        #beneficiary-selection-list { background: rgba(255, 255, 255, 0.9) !important; border: 1px solid rgba(13, 148, 136, 0.12) !important; }
        #beneficiary-selection-list > div {
            background: rgba(240, 253, 250, 0.6) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
        }
        .explanation { color: #64748b !important; }

        /* === Miscellaneous Light === */
        .credit-warning-banner {
            background: linear-gradient(135deg, #ef4444, #f97316) !important;
            border-bottom: 1px solid rgba(255,255,255,0.15) !important;
        }
        .scroll-to-top-btn {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.3) !important;
        }
        .achievement-popup {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            box-shadow: 0 10px 40px rgba(13, 148, 136, 0.3) !important;
            border: 2px solid rgba(255,255,255,0.2) !important;
        }
        .progress-bar {
            background: linear-gradient(90deg, #0d9488, #6366f1, #f97316) !important;
            box-shadow: 0 2px 10px rgba(13, 148, 136, 0.3) !important;
        }
        .mobile-menu-btn {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.3) !important;
        }
        .fab-btn {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.25) !important;
        }
        .stats-dashboard {
            background: rgba(255, 255, 255, 0.97) !important;
            border: 1px solid rgba(13, 148, 136, 0.12) !important;
            box-shadow: -8px 0 40px rgba(13, 148, 136, 0.1) !important;
        }
        .stats-dashboard h3 { color: #134e4a !important; }
        .stat-card {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.2) !important;
        }
        .stat-card.success {
            background: linear-gradient(135deg, #22c55e, #0d9488) !important;
        }
        .chart-container { background: rgba(255, 255, 255, 0.8) !important; }
        header {
            background: linear-gradient(135deg, #0d9488, #0f766e, #6366f1) !important;
            box-shadow: 0 8px 30px rgba(13, 148, 136, 0.15) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        .toggle-slider { background: rgba(13, 148, 136, 0.12) !important; }
        .auto-save-toggle input:checked + .toggle-slider {
            background: linear-gradient(135deg, #22c55e, #0d9488) !important;
        }
        .shortcut-item { background: rgba(13, 148, 136, 0.04) !important; }
        .shortcut-item:hover { background: rgba(13, 148, 136, 0.08) !important; }
        .shortcut-key {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            box-shadow: 0 2px 8px rgba(13, 148, 136, 0.2) !important;
        }
        #restore-type-modal .modal-content,
        #beneficiary-selection-modal .modal-content {
            background: rgba(255, 255, 255, 0.98) !important;
            border: 1px solid rgba(13, 148, 136, 0.15) !important;
            color: #1e293b !important;
        }
        .quick-action-btn {
            background: rgba(255, 255, 255, 0.85) !important;
            border: 1px solid rgba(13, 148, 136, 0.08) !important;
            color: #475569 !important;
        }
        .quick-action-btn:hover {
            background: rgba(13, 148, 136, 0.06) !important;
            border-color: rgba(13, 148, 136, 0.2) !important;
            color: #0d9488 !important;
        }
        .quick-action-btn.success {
            background: linear-gradient(135deg, #4CAF50, #388E3C) !important;
            color: white !important;
        }

        /* ================================================================ */
        /* ============ AURORA ANIMATIONS ================================ */
        /* ================================================================ */

        @keyframes neonPulse {
            0%, 100% { filter: drop-shadow(0 2px 6px rgba(13, 148, 136, 0.3)); }
            50% { filter: drop-shadow(0 4px 12px rgba(13, 148, 136, 0.5)); }
        }
        @keyframes float3D {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-15px); }
            50% { transform: translateY(-8px); }
            75% { transform: translateY(-20px); }
        }
        @keyframes rotateCube {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg); }
        }
        @keyframes floatShape {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.4; }
            50% { transform: translateY(-25px) rotate(180deg); opacity: 0.7; }
        }
        @keyframes orbitalPath1 {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(80px, -40px) rotate(90deg); }
            50% { transform: translate(0, -80px) rotate(180deg); }
            75% { transform: translate(-80px, -40px) rotate(270deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        @keyframes orbitalPath2 {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-60px, 50px) rotate(-90deg); }
            50% { transform: translate(0, 100px) rotate(-180deg); }
            75% { transform: translate(60px, 50px) rotate(-270deg); }
            100% { transform: translate(0, 0) rotate(-360deg); }
        }
        @keyframes ringRotate {
            0% { transform: rotateX(70deg) rotateZ(0deg); }
            100% { transform: rotateX(70deg) rotateZ(360deg); }
        }
        @keyframes robotFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes robotBlink {
            0%, 45%, 55%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }
        @keyframes robotWave {
            0%, 60%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(14deg); }
            20% { transform: rotate(-8deg); }
            40% { transform: rotate(8deg); }
            50% { transform: rotate(-4deg); }
        }
        @keyframes scanline {
            0% { top: -100%; }
            100% { top: 100%; }
        }
        @keyframes glitchText {
            0%, 90%, 100% { opacity: 1; transform: translate(0); }
            92% { opacity: 0.8; transform: translate(-2px, 1px); }
            94% { opacity: 0.6; transform: translate(2px, -1px); }
            96% { opacity: 0.8; transform: translate(-1px, 2px); }
            98% { opacity: 1; transform: translate(1px, -1px); }
        }

        /* ================================================================ */
        /* ============ FLOATING SHAPES - TEAL THEME ===================== */
        /* ================================================================ */

        .floating-shapes-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
            overflow: hidden; perspective: 1000px;
        }
        .floating-shape { position: absolute; opacity: 0.08; }
        
        /* 3D Rotating Cube */
        .shape-cube {
            width: 60px; height: 60px;
            transform-style: preserve-3d;
            animation: rotateCube 25s linear infinite;
            top: 15%; left: 8%;
        }
        .shape-cube .face {
            position: absolute; width: 60px; height: 60px;
            border: 2px solid #0d9488;
            background: rgba(13, 148, 136, 0.05);
        }
        .shape-cube .face:nth-child(1) { transform: rotateY(0deg) translateZ(30px); }
        .shape-cube .face:nth-child(2) { transform: rotateY(90deg) translateZ(30px); }
        .shape-cube .face:nth-child(3) { transform: rotateY(180deg) translateZ(30px); }
        .shape-cube .face:nth-child(4) { transform: rotateY(270deg) translateZ(30px); }
        .shape-cube .face:nth-child(5) { transform: rotateX(90deg) translateZ(30px); }
        .shape-cube .face:nth-child(6) { transform: rotateX(-90deg) translateZ(30px); }

        /* Glowing Sphere */
        .shape-sphere {
            width: 100px; height: 100px; border-radius: 50%;
            border: 2px solid rgba(99, 102, 241, 0.2);
            box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.08), 0 0 30px rgba(99, 102, 241, 0.05);
            animation: floatShape 8s ease-in-out infinite;
            top: 60%; left: 5%;
        }

        /* Rotating Ring */
        .shape-ring {
            width: 120px; height: 120px; border-radius: 50%;
            border: 3px solid rgba(13, 148, 136, 0.15);
            transform-style: preserve-3d;
            animation: ringRotate 12s linear infinite;
            top: 25%; right: 12%;
        }

        /* Pyramid */
        .shape-pyramid {
            width: 0; height: 0;
            border-left: 40px solid transparent;
            border-right: 40px solid transparent;
            border-bottom: 70px solid rgba(249, 115, 22, 0.08);
            animation: orbitalPath2 25s linear infinite;
            top: 70%; right: 8%;
            filter: drop-shadow(0 2px 8px rgba(249, 115, 22, 0.1));
        }

        /* Diamond */
        .shape-diamond {
            width: 50px; height: 50px;
            background: rgba(13, 148, 136, 0.06);
            border: 2px solid rgba(13, 148, 136, 0.15);
            transform: rotate(45deg);
            animation: orbitalPath1 18s linear infinite;
            top: 45%; left: 15%;
        }

        /* Dots cluster */
        .shape-dots {
            top: 80%; left: 25%;
            animation: floatShape 12s ease-in-out infinite;
        }
        .shape-dots span {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background: rgba(13, 148, 136, 0.2); margin: 3px;
            animation: neonPulse 3s ease-in-out infinite;
        }
        .shape-dots span:nth-child(2) { animation-delay: 0.5s; background: rgba(99, 102, 241, 0.2); }
        .shape-dots span:nth-child(3) { animation-delay: 1s; background: rgba(249, 115, 22, 0.2); }

        /* Small floating cube 2 */
        .shape-cube-sm {
            width: 35px; height: 35px;
            transform-style: preserve-3d;
            animation: rotateCube 15s linear infinite reverse;
            top: 50%; right: 25%;
        }
        .shape-cube-sm .face {
            position: absolute; width: 35px; height: 35px;
            border: 1px solid rgba(249, 115, 22, 0.25);
            background: rgba(249, 115, 22, 0.04);
        }
        .shape-cube-sm .face:nth-child(1) { transform: rotateY(0deg) translateZ(17.5px); }
        .shape-cube-sm .face:nth-child(2) { transform: rotateY(90deg) translateZ(17.5px); }
        .shape-cube-sm .face:nth-child(3) { transform: rotateY(180deg) translateZ(17.5px); }
        .shape-cube-sm .face:nth-child(4) { transform: rotateY(270deg) translateZ(17.5px); }
        .shape-cube-sm .face:nth-child(5) { transform: rotateX(90deg) translateZ(17.5px); }
        .shape-cube-sm .face:nth-child(6) { transform: rotateX(-90deg) translateZ(17.5px); }

        /* Hexagon */
        .shape-hex {
            width: 70px; height: 40px; position: relative;
            background: rgba(99, 102, 241, 0.05);
            animation: floatShape 10s ease-in-out infinite reverse;
            top: 12%; right: 35%;
        }
        .shape-hex::before, .shape-hex::after {
            content: ''; position: absolute; width: 0;
            border-left: 35px solid transparent; border-right: 35px solid transparent;
        }
        .shape-hex::before { bottom: 100%; border-bottom: 20px solid rgba(99, 102, 241, 0.05); }
        .shape-hex::after { top: 100%; border-top: 20px solid rgba(99, 102, 241, 0.05); }

/* ================================================================ */
        /* ============ SMART ASSISTANT PANEL - TEAL THEME =============== */
        /* ================================================================ */

        /* --- Floating Action Button (Avatar) --- */
        .assistant-fab {
            position: fixed;
            bottom: 90px;
            left: 30px;
            z-index: 10000;
            cursor: pointer;
            animation: assistantBounce 3s ease-in-out infinite;
            transition: transform 0.3s;
        }
        .assistant-fab:hover { transform: scale(1.12); animation: none; }
        .assistant-avatar {
            width: 65px; height: 65px;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 25px rgba(13, 148, 136, 0.35);
            position: relative;
        }
        .avatar-ring {
            position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%; border: 2px solid rgba(13, 148, 136, 0.3);
            animation: ringPulse 2s ease-in-out infinite;
        }
        .avatar-face { position: relative; width: 35px; height: 35px; }
        .avatar-eyes { display: flex; justify-content: center; gap: 10px; padding-top: 6px; }
        .avatar-eye {
            width: 8px; height: 8px; border-radius: 50%; background: #fff;
            box-shadow: 0 0 6px rgba(255,255,255,0.8);
            animation: avatarBlink 4s ease-in-out infinite;
        }
        .avatar-eye.right { animation-delay: 0.15s; }
        .avatar-mouth {
            width: 14px; height: 5px; background: rgba(255,255,255,0.85);
            border-radius: 0 0 8px 8px; margin: 5px auto 0;
        }
        .assistant-badge {
            position: absolute; top: -4px; right: -4px;
            width: 22px; height: 22px; border-radius: 50%;
            background: #ef4444; color: #fff; font-size: 0.7em; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.5);
            animation: badgePop 0.4s ease-out;
        }
        .assistant-badge.hidden { display: none; }

        /* --- Panel --- */
        .assistant-panel {
            position: fixed;
            bottom: 90px;
            left: 30px;
            width: 380px;
            max-height: 550px;
            background: linear-gradient(165deg, rgba(255,255,255,0.98) 0%, rgba(240,253,250,0.98) 50%, rgba(238,242,255,0.98) 100%);
            border: 1px solid rgba(13, 148, 136, 0.15);
            border-radius: 24px;
            box-shadow:
                0 25px 80px rgba(13, 148, 136, 0.12),
                0 8px 32px rgba(99, 102, 241, 0.06),
                inset 0 1px 0 rgba(255,255,255,0.9);
            backdrop-filter: blur(30px) saturate(1.2);
            z-index: 10001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: panelSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-family: 'IBM Plex Sans Arabic', sans-serif;
        }
        .assistant-panel.open { display: flex; }
        .assistant-panel::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 3px; z-index: 2;
            background: linear-gradient(90deg, #0d9488, #6366f1, #f97316, #0d9488);
            background-size: 300% 100%;
            animation: shimmerBar 4s linear infinite;
        }
        @keyframes shimmerBar {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }
        .assistant-panel-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.05), rgba(99, 102, 241, 0.04));
            border-bottom: none;
            position: relative;
        }
        .assistant-header-info { display: flex; align-items: center; gap: 12px; }
        .assistant-header-avatar {
            width: 42px; height: 42px;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            border-radius: 14px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(13,148,136,0.25);
            position: relative;
        }
        .assistant-header-avatar::after {
            content: ''; position: absolute; inset: -3px; border-radius: 17px;
            border: 2px solid rgba(13,148,136,0.15);
            animation: avatarGlow 3s ease-in-out infinite;
        }
        @keyframes avatarGlow {
            0%, 100% { border-color: rgba(13,148,136,0.15); }
            50% { border-color: rgba(99,102,241,0.25); }
        }
        .mini-face { position: relative; width: 22px; height: 22px; }
        .mini-eyes { display: flex; justify-content: center; gap: 6px; padding-top: 3px; }
        .mini-eye { width: 5px; height: 5px; border-radius: 50%; background: #fff; }
        .mini-mouth { width: 8px; height: 3px; background: rgba(255,255,255,0.8); border-radius: 0 0 5px 5px; margin: 3px auto 0; }
        .assistant-panel-header h3 { margin: 0; color: #1e293b; font-size: 0.95em; }
        .assistant-status { font-size: 0.72em; color: #10b981; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; background: #10b981; display: inline-block; animation: statusPulse 2s infinite; box-shadow: 0 0 8px rgba(16,185,129,0.4); }
        .assistant-close {
            background: rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.06);
            color: #475569; width: 30px; height: 30px; border-radius: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .assistant-close:hover { background: rgba(239, 68, 68, 0.12); color: #ef4444; border-color: rgba(239, 68, 68, 0.25); transform: rotate(90deg); }

        /* --- Messages Area --- */
        .assistant-panel-body {
            flex: 1; overflow-y: auto; padding: 14px 16px;
            display: flex; flex-direction: column; gap: 10px;
            max-height: 350px;
            scrollbar-width: thin;
            scrollbar-color: rgba(13, 148, 136, 0.15) transparent;
        }
        .assistant-panel-body::-webkit-scrollbar { width: 4px; }
        .assistant-panel-body::-webkit-scrollbar-track { background: transparent; }
        .assistant-panel-body::-webkit-scrollbar-thumb { background: rgba(13,148,136,0.15); border-radius: 4px; }
        .assistant-msg {
            padding: 12px 16px; border-radius: 18px;
            font-size: 0.84em; line-height: 1.7;
            animation: msgSlideUp 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90%; position: relative;
        }
        @keyframes msgSlideUp {
            0% { opacity: 0; transform: translateY(12px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .assistant-msg.bot {
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(13, 148, 136, 0.08);
            box-shadow: 0 2px 12px rgba(13,148,136,0.04);
            color: #1e293b; align-self: flex-start;
            border-bottom-right-radius: 6px;
        }
        .assistant-msg.bot::before {
            content: ''; position: absolute; right: -6px; bottom: 8px;
            width: 12px; height: 12px; background: rgba(255,255,255,0.85);
            border: 1px solid rgba(13,148,136,0.08); border-top: none; border-left: none;
            transform: rotate(-45deg); border-radius: 0 0 3px 0;
        }
        .assistant-msg.bot .msg-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 22px; height: 22px; border-radius: 8px;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            margin-left: 8px; vertical-align: middle; font-size: 0.65em;
        }
        .assistant-msg.tip {
            background: linear-gradient(135deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02));
            border: 1px solid rgba(99, 102, 241, 0.1);
            color: #4f46e5; font-size: 0.8em;
            border-right: 3px solid #6366f1;
        }
        .assistant-msg.tip i { color: #6366f1; margin-left: 6px; }
        .assistant-msg.warning {
            background: linear-gradient(135deg, rgba(249,115,22,0.06), rgba(249,115,22,0.02));
            border: 1px solid rgba(249, 115, 22, 0.12);
            color: #ea580c; font-size: 0.8em;
            border-right: 3px solid #f97316;
        }
        .assistant-msg.warning i { color: #f97316; margin-left: 6px; }
        .assistant-msg.success {
            background: linear-gradient(135deg, rgba(34,197,94,0.06), rgba(34,197,94,0.02));
            border: 1px solid rgba(34, 197, 94, 0.12);
            color: #16a34a; font-size: 0.8em;
            border-right: 3px solid #22c55e;
        }
        .assistant-msg.success i { color: #22c55e; margin-left: 6px; }
        .assistant-msg .msg-title {
            font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
            color: #0d9488; font-size: 0.95em;
            padding-bottom: 6px; border-bottom: 1px dashed rgba(13,148,136,0.1);
        }
        .assistant-msg .step-list {
            list-style: none; padding: 0; margin: 8px 0 0;
        }
        .assistant-msg .step-list li {
            padding: 5px 0; display: flex; align-items: flex-start; gap: 8px;
        }
        .assistant-msg .step-list li .step-num {
            min-width: 22px; height: 22px; border-radius: 8px;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            color: #fff; font-size: 0.7em; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(13,148,136,0.2);
        }
        .assistant-msg .shortcut-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px;
        }
        .assistant-msg .shortcut-item {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 10px; background: rgba(13, 148, 136, 0.04);
            border-radius: 10px; font-size: 0.85em;
            border: 1px solid rgba(13,148,136,0.06);
            transition: all 0.2s;
        }
        .assistant-msg .shortcut-item:hover {
            background: rgba(13,148,136,0.08); transform: translateY(-1px);
        }
        .assistant-msg .shortcut-key {
            background: linear-gradient(135deg, #0d9488, #0f766e);
            color: #fff; padding: 3px 8px; border-radius: 6px;
            font-size: 0.78em; font-weight: 600; white-space: nowrap;
            box-shadow: 0 2px 6px rgba(13,148,136,0.2);
        }

        /* --- Quick Action Buttons --- */
        .assistant-quick-actions {
            display: flex; gap: 5px; padding: 8px 12px;
            border-top: 1px solid rgba(13, 148, 136, 0.06);
            flex-wrap: wrap;
            background: rgba(13,148,136,0.01);
        }
        .quick-help-btn {
            flex: 1; min-width: calc(33% - 6px);
            padding: 7px 8px; border-radius: 12px;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(13, 148, 136, 0.08);
            color: #0f766e; cursor: pointer; font-size: 0.7em;
            font-family: inherit; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; gap: 5px; justify-content: center;
            position: relative; overflow: hidden;
        }
        .quick-help-btn::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(13,148,136,0.08), rgba(99,102,241,0.06));
            opacity: 0; transition: opacity 0.3s;
        }
        .quick-help-btn:hover::before { opacity: 1; }
        .quick-help-btn:hover {
            border-color: rgba(13,148,136,0.2);
            color: #0d9488;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 16px rgba(13, 148, 136, 0.1);
        }
        .quick-help-btn:active { transform: translateY(0) scale(0.98); }
        .quick-help-btn i { font-size: 0.9em; position: relative; z-index: 1; }
        .quick-help-btn span, .quick-help-btn { position: relative; z-index: 1; }

        /* --- Assistant Animations --- */
        @keyframes assistantBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        @keyframes ringPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.4; }
        }
        @keyframes avatarBlink {
            0%, 42%, 58%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }
        @keyframes statusPulse {
            0%, 100% { opacity: 1; } 50% { opacity: 0.3; }
        }
        @keyframes panelSlideIn {
            0% { opacity: 0; transform: translateY(30px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes msgFadeIn {
            0% { opacity: 0; transform: translateX(-15px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        @keyframes badgePop {
            0% { transform: scale(0); } 100% { transform: scale(1); }
        }

        /* --- Welcome Overlay for First Visit --- */
        .welcome-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.4); z-index: 20000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        .welcome-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(13, 148, 136, 0.2);
            border-radius: 24px; padding: 40px; max-width: 520px; width: 90%;
            text-align: center; box-shadow: 0 25px 80px rgba(13, 148, 136, 0.15);
            animation: welcomePop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes welcomePop {
            0% { opacity: 0; transform: scale(0.8) translateY(30px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .welcome-card .welcome-avatar {
            width: 90px; height: 90px; margin: 0 auto 20px;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 30px rgba(13, 148, 136, 0.3);
        }
        .welcome-card .welcome-avatar i { font-size: 2.2em; color: #fff; }
        .welcome-card h2 {
            color: #1e293b; margin: 0 0 12px; font-size: 1.5em;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .welcome-card p { color: #64748b; line-height: 1.8; margin: 0 0 8px; font-size: 0.92em; }
        .welcome-card .welcome-features {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin: 20px 0; text-align: right;
        }
        .welcome-card .feature-item {
            padding: 12px; background: rgba(13, 148, 136, 0.04);
            border: 1px solid rgba(13, 148, 136, 0.08);
            border-radius: 12px; display: flex; align-items: center; gap: 10px;
        }
        .welcome-card .feature-item i { color: #0d9488; font-size: 1.1em; }
        .welcome-card .feature-item span { color: #475569; font-size: 0.82em; }
        .welcome-card .welcome-start-btn {
            margin-top: 24px; padding: 14px 40px;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            border: none; color: #fff; font-size: 1em; font-weight: 600;
            border-radius: 14px; cursor: pointer; font-family: inherit;
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
            transition: all 0.3s;
        }
        .welcome-card .welcome-start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(13, 148, 136, 0.4);
        }

        /* --- Section Tooltips --- */
        .section-guide-tip {
            position: absolute; top: 10px; left: 10px;
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.1), rgba(99, 102, 241, 0.08));
            border: 1px solid rgba(13, 148, 136, 0.15);
            border-radius: 12px; padding: 10px 14px;
            color: #0f766e; font-size: 0.78em;
            max-width: 280px; z-index: 100;
            animation: tipSlideIn 0.5s ease-out;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.08);
        }
        .section-guide-tip .tip-close {
            position: absolute; top: 4px; left: 4px;
            background: none; border: none; color: #475569;
            cursor: pointer; font-size: 0.8em; padding: 2px 5px;
        }
        @keyframes tipSlideIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* --- AI Badge --- */
        .assistant-ai-badge {
            display: inline-flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #6366f1, #6366f1);
            color: #fff; font-size: 0.55em; padding: 2px 7px;
            border-radius: 6px; font-weight: 700; margin-right: 6px;
            letter-spacing: 1px; vertical-align: middle;
            animation: aiBadgeGlow 2s ease-in-out infinite alternate;
        }
        @keyframes aiBadgeGlow {
            0% { box-shadow: 0 0 5px rgba(99,102,241,0.3); }
            100% { box-shadow: 0 0 15px rgba(99,102,241,0.6); }
        }

        /* --- Header Actions --- */
        .assistant-header-actions {
            display: flex; align-items: center; gap: 4px;
        }
        .assistant-header-btn {
            background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05);
            color: #475569; width: 28px; height: 28px; border-radius: 9px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.25s; font-size: 0.75em;
        }
        .assistant-header-btn:hover { background: rgba(13,148,136,0.1); color: #0d9488; transform: scale(1.1); }

        /* --- Tabs (Glass Pill Design) --- */
        .assistant-tabs {
            display: flex; gap: 4px;
            padding: 6px 12px 8px;
            background: transparent;
            position: relative;
        }
        .assistant-tabs::after {
            content: ''; position: absolute; bottom: 0; left: 12px; right: 12px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(13,148,136,0.12), rgba(99,102,241,0.08), transparent);
        }
        .assistant-tab {
            flex: 1; padding: 8px 6px; border: none;
            background: transparent;
            color: #475569; font-size: 0.7em; font-family: inherit;
            cursor: pointer; transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;
            border-radius: 12px;
        }
        .assistant-tab:hover {
            color: #0d9488;
            background: rgba(13,148,136,0.04);
        }
        .assistant-tab.active {
            color: #fff; font-weight: 600;
            background: linear-gradient(135deg, #0d9488, #0f766e);
            box-shadow: 0 4px 16px rgba(13,148,136,0.25), 0 2px 6px rgba(13,148,136,0.15);
            transform: translateY(-1px);
        }
        .assistant-tab.active::after { display: none; }
        .assistant-tab i {
            font-size: 1.05em;
            transition: transform 0.3s;
        }
        .assistant-tab:hover i { transform: scale(1.15); }
        .assistant-tab.active i { transform: scale(1.1); }
        .assistant-tab .tab-label {
            font-size: 0.88em; line-height: 1;
        }

        /* --- Tab Content --- */
        .assistant-tab-content {
            display: none; flex-direction: column; flex: 1; overflow: hidden;
        }
        .assistant-tab-content.active {
            display: flex;
            animation: tabFadeIn 0.35s ease-out;
        }
        @keyframes tabFadeIn {
            0% { opacity: 0; transform: translateY(6px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* --- Enhanced Panel --- */
        .assistant-panel {
            max-height: 650px !important;
            width: 420px !important;
        }
        .assistant-panel.fullscreen {
            width: 95vw !important; max-width: 700px !important;
            max-height: 85vh !important; bottom: 20px !important;
            left: 50% !important; transform: translateX(-50%) !important;
            border-radius: 28px !important;
        }

        /* --- Chat Input Area --- */
        .assistant-chat-input-area {
            padding: 8px 12px 12px;
            border-top: 1px solid rgba(13,148,136,0.06);
            background: linear-gradient(180deg, rgba(13,148,136,0.01), rgba(13,148,136,0.03));
        }
        .assistant-input-wrapper {
            display: flex; gap: 8px; align-items: center;
        }
        #assistant-chat-input {
            flex: 1; padding: 10px 16px; border-radius: 14px;
            border: 1.5px solid rgba(13,148,136,0.1);
            background: rgba(255,255,255,0.9); color: #1e293b;
            font-size: 0.82em; font-family: inherit; outline: none;
            transition: all 0.3s; direction: rtl;
        }
        #assistant-chat-input:focus {
            border-color: #0d9488;
            box-shadow: 0 0 0 4px rgba(13,148,136,0.08), 0 2px 8px rgba(13,148,136,0.06);
            background: #fff;
        }
        #assistant-chat-input::placeholder { color: #334155; }
        #assistant-send-btn {
            width: 38px; height: 38px; border-radius: 12px;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            border: none; color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); font-size: 0.85em;
            box-shadow: 0 3px 12px rgba(13,148,136,0.2);
        }
        #assistant-send-btn:hover {
            transform: scale(1.08) rotate(-5deg);
            box-shadow: 0 5px 20px rgba(13,148,136,0.3);
        }
        #assistant-send-btn:active {
            transform: scale(0.95);
        }

        /* --- Suggestions --- */
        .assistant-suggestions {
            display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px;
            max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .assistant-suggestions.visible { max-height: 80px; }
        .suggestion-chip {
            padding: 5px 12px; border-radius: 20px;
            background: rgba(255,255,255,0.8); border: 1px solid rgba(13,148,136,0.1);
            color: #0f766e; font-size: 0.7em; cursor: pointer;
            font-family: inherit; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); white-space: nowrap;
        }
        .suggestion-chip:hover {
            background: rgba(13,148,136,0.15); border-color: #0d9488;
            transform: translateY(-1px);
        }

        /* --- User Messages --- */
        .assistant-msg.user {
            background: linear-gradient(135deg, #0d9488, #0f766e);
            color: #fff; align-self: flex-end;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 18px;
            box-shadow: 0 3px 12px rgba(13,148,136,0.2);
            border: none;
        }
        .assistant-msg.user::before { display: none; }

        /* --- Typing Indicator --- */
        .typing-indicator {
            display: flex; align-items: center; gap: 4px; padding: 12px 16px;
            align-self: flex-start;
        }
        .typing-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: #0d9488; animation: typingBounce 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-8px); opacity: 1; }
        }

        /* --- Analytics Dashboard --- */
        .analytics-dashboard {
            padding: 14px; overflow-y: auto; max-height: 480px;
            display: flex; flex-direction: column; gap: 12px;
            scrollbar-width: thin; scrollbar-color: rgba(13,148,136,0.2) transparent;
        }
        .analytics-dashboard {
            padding: 14px; overflow-y: auto; max-height: 480px;
            display: flex; flex-direction: column; gap: 10px;
            scrollbar-width: thin; scrollbar-color: rgba(13,148,136,0.15) transparent;
        }
        .analytics-dashboard::-webkit-scrollbar { width: 4px; }
        .analytics-dashboard::-webkit-scrollbar-thumb { background: rgba(13,148,136,0.15); border-radius: 4px; }
        .analytics-card {
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(13,148,136,0.07);
            border-radius: 16px; padding: 16px;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        .analytics-card::before {
            content: ''; position: absolute; top: 0; right: 0;
            width: 60px; height: 60px; border-radius: 0 16px 0 30px;
            background: linear-gradient(135deg, rgba(13,148,136,0.04), rgba(99,102,241,0.03));
            transition: all 0.3s;
        }
        .analytics-card:hover {
            box-shadow: 0 8px 28px rgba(13,148,136,0.08), 0 2px 8px rgba(99,102,241,0.04);
            transform: translateY(-2px);
            border-color: rgba(13,148,136,0.15);
        }
        .analytics-card:hover::before {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, rgba(13,148,136,0.06), rgba(99,102,241,0.05));
        }
        .analytics-card-title {
            font-size: 0.73em; color: #475569; font-weight: 600;
            margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
            position: relative; z-index: 1;
        }
        .analytics-card-title i {
            color: #fff; font-size: 0.8em;
            width: 22px; height: 22px; border-radius: 7px;
            display: inline-flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #0d9488, #0f766e);
            box-shadow: 0 2px 6px rgba(13,148,136,0.2);
        }
        .analytics-card-value {
            font-size: 1.7em; font-weight: 800;
            background: linear-gradient(135deg, #0d9488, #6366f1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
            position: relative; z-index: 1;
        }
        .analytics-card-sub { font-size: 0.7em; color: #475569; margin-top: 4px; position: relative; z-index: 1; }
        .analytics-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .analytics-mini-chart {
            height: 8px; background: rgba(13,148,136,0.06); border-radius: 4px;
            margin-top: 10px; overflow: hidden; position: relative;
        }
        .analytics-mini-chart::after {
            content: ''; position: absolute; inset: 0;
            background: repeating-linear-gradient(90deg, transparent, transparent 20%, rgba(255,255,255,0.15) 20%, rgba(255,255,255,0.15) 20.5%);
        }
        .analytics-mini-chart-fill {
            height: 100%; border-radius: 4px;
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }
        .analytics-mini-chart-fill::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent 60%, rgba(255,255,255,0.2));
            border-radius: 4px;
        }
        .analytics-mini-chart-fill.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .analytics-mini-chart-fill.teal { background: linear-gradient(90deg, #0d9488, #14b8a6); }
        .analytics-mini-chart-fill.indigo { background: linear-gradient(90deg, #6366f1, #818cf8); }
        .analytics-mini-chart-fill.orange { background: linear-gradient(90deg, #f97316, #fb923c); }
        .analytics-mini-chart-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }

        /* Analytics List */
        .analytics-list { list-style: none; padding: 0; margin: 8px 0 0; }
        .analytics-list li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 8px; margin: 2px 0; border-radius: 10px;
            font-size: 0.78em; color: #475569;
            background: rgba(13,148,136,0.02);
            transition: all 0.2s;
        }
        .analytics-list li:hover { background: rgba(13,148,136,0.06); transform: translateX(-2px); }
        .analytics-list .label { display: flex; align-items: center; gap: 6px; }
        .analytics-list .value {
            font-weight: 700; color: #0f766e;
            background: rgba(13,148,136,0.05); padding: 2px 8px; border-radius: 6px;
        }

        /* --- Tools Grid --- */
        .assistant-tools-grid {
            padding: 12px; overflow-y: auto; max-height: 480px;
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
            scrollbar-width: thin; scrollbar-color: rgba(13,148,136,0.15) transparent;
        }
        .assistant-tools-grid::-webkit-scrollbar { width: 4px; }
        .assistant-tools-grid::-webkit-scrollbar-thumb { background: rgba(13,148,136,0.15); border-radius: 4px; }
        .tool-card {
            background: rgba(255,255,255,0.8);
            border: 1px solid rgba(13,148,136,0.06);
            border-radius: 16px; padding: 14px 8px 12px; text-align: center;
            cursor: pointer; transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        .tool-card::before {
            content: ''; position: absolute; bottom: -30px; left: -10px;
            width: 60px; height: 60px; border-radius: 50%;
            background: radial-gradient(circle, rgba(13,148,136,0.06), transparent 70%);
            transition: all 0.4s;
        }
        .tool-card:hover::before {
            width: 120px; height: 120px; bottom: -40px; left: -20px;
            background: radial-gradient(circle, rgba(13,148,136,0.1), transparent 70%);
        }
        .tool-card:hover {
            border-color: rgba(13,148,136,0.15);
            box-shadow: 0 8px 28px rgba(13,148,136,0.1), 0 2px 8px rgba(99,102,241,0.04);
            transform: translateY(-4px) scale(1.02);
        }
        .tool-card:active { transform: translateY(-1px) scale(0.98); }
        .tool-card-icon {
            width: 40px; height: 40px; border-radius: 12px;
            background: linear-gradient(135deg, rgba(13,148,136,0.08), rgba(99,102,241,0.05));
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 8px; font-size: 1em; color: #0d9488;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; z-index: 1;
        }
        .tool-card:hover .tool-card-icon {
            background: linear-gradient(135deg, #0d9488, #6366f1);
            color: #fff;
            transform: scale(1.1) rotate(-5deg);
            box-shadow: 0 4px 16px rgba(13,148,136,0.25);
        }
        .tool-card-name {
            font-size: 0.72em; font-weight: 600; color: #334155; margin-bottom: 3px;
            position: relative; z-index: 1;
        }
        .tool-card-desc {
            font-size: 0.6em; color: #475569; line-height: 1.4;
            position: relative; z-index: 1;
        }
        .tool-card-badge {
            position: absolute; top: 6px; left: 6px;
            background: linear-gradient(135deg, #f97316, #fb923c);
            color: #fff; font-size: 0.5em; padding: 2px 6px;
            border-radius: 6px; font-weight: 700;
            box-shadow: 0 2px 8px rgba(249,115,22,0.25);
            animation: badgePulse 2s infinite;
        }
        @keyframes badgePulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(249,115,22,0.25); }
            50% { box-shadow: 0 2px 16px rgba(249,115,22,0.4); }
        }

        /* --- Health Dashboard --- */
        .health-dashboard {
            padding: 14px; overflow-y: auto; max-height: 480px;
            display: flex; flex-direction: column; gap: 10px;
            scrollbar-width: thin; scrollbar-color: rgba(13,148,136,0.15) transparent;
        }
        .health-dashboard::-webkit-scrollbar { width: 4px; }
        .health-dashboard::-webkit-scrollbar-thumb { background: rgba(13,148,136,0.15); border-radius: 4px; }
        .health-score-card {
            text-align: center; padding: 24px 20px;
            background: linear-gradient(160deg, rgba(255,255,255,0.9), rgba(240,253,250,0.9), rgba(238,242,255,0.8));
            border: 1px solid rgba(13,148,136,0.08); border-radius: 20px;
            position: relative; overflow: hidden;
        }
        .health-score-card::before {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(13,148,136,0.03), transparent, rgba(99,102,241,0.03), transparent);
            animation: scoreRotate 8s linear infinite;
        }
        @keyframes scoreRotate { 100% { transform: rotate(360deg); } }
        .health-score-ring {
            width: 110px; height: 110px; margin: 0 auto 14px;
            position: relative; z-index: 1;
        }
        .health-score-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 3px 6px rgba(13,148,136,0.15)); }
        .health-score-ring .score-bg {
            fill: none; stroke: rgba(13,148,136,0.08); stroke-width: 7;
        }
        .health-score-ring .score-fill {
            fill: none; stroke-width: 7; stroke-linecap: round;
            transition: stroke-dashoffset 1.2s cubic-bezier(0.34, 1.56, 0.64, 1), stroke 0.5s;
        }
        .health-score-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em; font-weight: 800;
            z-index: 1;
        }
        .health-score-label { font-size: 0.82em; color: #64748b; position: relative; z-index: 1; }
        .health-issue-item {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 12px 14px; border-radius: 14px;
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(0,0,0,0.03);
            font-size: 0.78em;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .health-issue-item:hover {
            transform: translateX(-4px) scale(1.01);
            box-shadow: 0 4px 18px rgba(0,0,0,0.05);
            border-color: rgba(13,148,136,0.1);
        }
        .health-issue-icon {
            width: 34px; height: 34px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85em; flex-shrink: 0;
        }
        .health-issue-icon.error {
            background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(239,68,68,0.05));
            color: #ef4444; box-shadow: 0 2px 8px rgba(239,68,68,0.1);
        }
        .health-issue-icon.warning {
            background: linear-gradient(135deg, rgba(249,115,22,0.1), rgba(249,115,22,0.05));
            color: #f97316; box-shadow: 0 2px 8px rgba(249,115,22,0.1);
        }
        .health-issue-icon.good {
            background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,197,94,0.05));
            color: #22c55e; box-shadow: 0 2px 8px rgba(34,197,94,0.1);
        }
        .health-issue-text { flex: 1; }
        .health-issue-title { font-weight: 600; color: #334155; margin-bottom: 3px; }
        .health-issue-desc { color: #475569; font-size: 0.88em; line-height: 1.5; }
        .health-fix-btn {
            padding: 5px 12px; border-radius: 8px; border: none;
            font-size: 0.78em; cursor: pointer; font-family: inherit;
            background: linear-gradient(135deg, rgba(13,148,136,0.08), rgba(13,148,136,0.04));
            color: #0d9488; margin-top: 5px;
            transition: all 0.25s;
        }
        .health-fix-btn:hover {
            background: linear-gradient(135deg, #0d9488, #0f766e);
            color: #fff;
            box-shadow: 0 3px 12px rgba(13,148,136,0.2);
            transform: translateY(-1px);
        }

        /* --- Command Palette --- */
        .command-palette {
            position: absolute; bottom: 100%; left: 0; right: 0;
            background: rgba(255,255,255,0.98);
            border: 1px solid rgba(13,148,136,0.1);
            border-radius: 16px; margin-bottom: 6px; overflow: hidden;
            box-shadow: 0 -10px 50px rgba(13,148,136,0.1), 0 -4px 16px rgba(99,102,241,0.04);
            display: none; max-height: 260px; overflow-y: auto;
            backdrop-filter: blur(20px);
        }
        .command-palette.visible { display: block; animation: paletteSlideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes paletteSlideUp {
            0% { opacity: 0; transform: translateY(8px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .command-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(0,0,0,0.02);
        }
        .command-item:hover, .command-item.selected {
            background: linear-gradient(90deg, rgba(13,148,136,0.06), rgba(99,102,241,0.03));
            padding-right: 18px;
        }
        .command-item i {
            color: #fff; width: 22px; height: 22px; text-align: center;
            font-size: 0.7em; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #0d9488, #0f766e);
            box-shadow: 0 2px 6px rgba(13,148,136,0.15);
        }
        .command-item .cmd-name { font-size: 0.82em; font-weight: 600; color: #334155; }
        .command-item .cmd-desc { font-size: 0.68em; color: #475569; }
        .command-item .cmd-key {
            margin-right: auto; background: rgba(13,148,136,0.06);
            padding: 3px 8px; border-radius: 6px; font-size: 0.68em;
            color: #0f766e; font-family: monospace;
        }

        /* --- Activity Log in messages --- */
        .activity-log-entry {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 10px; border-radius: 10px;
            background: rgba(13,148,136,0.02);
            border: 1px solid rgba(13,148,136,0.05);
            font-size: 0.72em; color: #64748b;
            transition: all 0.2s;
        }
        .activity-log-entry:hover { background: rgba(13,148,136,0.05); transform: translateX(-2px); }
        .activity-log-entry .log-time {
            color: #475569; font-size: 0.85em; white-space: nowrap;
        }
        .activity-log-entry i { color: #0d9488; }

        /* --- Mood States for Avatar --- */
        .assistant-header-avatar.mood-happy .mini-mouth {
            height: 4px; border-radius: 0 0 8px 8px; background: rgba(255,255,255,0.9);
        }
        .assistant-header-avatar.mood-thinking .mini-eye:first-child {
            transform: scaleY(0.3);
        }
        .assistant-header-avatar.mood-thinking .mini-mouth {
            width: 4px; height: 4px; border-radius: 50%; margin: 3px auto 0;
        }
        .assistant-header-avatar.mood-alert {
            background: linear-gradient(135deg, #f97316, #ef4444) !important;
        }
        .assistant-header-avatar.mood-alert .mini-eye {
            background: #fff; animation: alertBlink 0.5s ease-in-out infinite;
        }
        @keyframes alertBlink {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); }
        }
        .assistant-header-avatar.mood-celebrate {
            animation: celebrateShake 0.5s ease-in-out;
        }
        @keyframes celebrateShake {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* --- Inline Calculator Result --- */
        .calc-result-card {
            background: linear-gradient(135deg, rgba(13,148,136,0.04), rgba(99,102,241,0.03));
            border: 1px solid rgba(13,148,136,0.08);
            border-radius: 14px; padding: 14px 16px; margin-top: 8px;
            position: relative; overflow: hidden;
        }
        .calc-result-card::before {
            content: ''; position: absolute; top: 0; right: 0;
            width: 50px; height: 50px;
            background: radial-gradient(circle, rgba(13,148,136,0.06), transparent 70%);
            border-radius: 0 14px 0 50%;
        }
        .calc-result-label { font-size: 0.72em; color: #475569; position: relative; z-index: 1; }
        .calc-result-value {
            font-size: 1.4em; font-weight: 800; color: #0d9488;
            position: relative; z-index: 1;
            letter-spacing: -0.02em;
        }
        .calc-result-details {
            display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;
            position: relative; z-index: 1;
        }
        .calc-detail-item {
            font-size: 0.7em; color: #64748b;
            display: flex; align-items: center; gap: 4px;
            background: rgba(255,255,255,0.5); padding: 3px 8px; border-radius: 6px;
        }
        .calc-detail-item i { color: #0d9488; font-size: 0.85em; }

        /* --- Action button in messages --- */
        .msg-action-btn {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 6px 14px; border-radius: 10px; margin: 4px 4px 0 0;
            border: 1px solid rgba(13,148,136,0.1);
            background: rgba(255,255,255,0.7);
            color: #0f766e; font-size: 0.78em; cursor: pointer;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        .msg-action-btn::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(135deg, #0d9488, #0f766e);
            opacity: 0; transition: opacity 0.3s;
        }
        .msg-action-btn:hover::before { opacity: 1; }
        .msg-action-btn:hover {
            color: #fff; border-color: transparent;
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 16px rgba(13,148,136,0.2);
        }
        .msg-action-btn:active { transform: translateY(0) scale(0.97); }
        .msg-action-btn i, .msg-action-btn span { position: relative; z-index: 1; }
        .msg-action-btn i { font-size: 0.9em; }

        /* --- Ranking List --- */
        .ranking-list { display: flex; flex-direction: column; gap: 6px; }
        .ranking-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 8px; border-radius: 8px;
            background: rgba(13,148,136,0.03);
            transition: background 0.2s;
        }
        .ranking-item:hover { background: rgba(13,148,136,0.08); }
        .ranking-medal { font-size: 1.1em; min-width: 24px; text-align: center; }
        .rank-num {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(99,102,241,0.1); color: #6366f1;
            font-size: 0.7em; font-weight: 700;
        }
        .ranking-info { flex: 1; min-width: 0; }
        .ranking-name { font-size: 0.78em; font-weight: 600; color: #334155; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ranking-bar-container { height: 4px; background: rgba(0,0,0,0.05); border-radius: 2px; overflow: hidden; }
        .ranking-bar { height: 100%; border-radius: 2px; background: linear-gradient(90deg, #0d9488, #6366f1); transition: width 0.6s ease; }
        .ranking-amount { font-size: 0.72em; font-weight: 700; color: #0d9488; white-space: nowrap; }

        /* --- Search Results --- */
        .search-result-item {
            padding: 8px; margin: 4px 0; border-radius: 8px;
            background: rgba(13,148,136,0.03); border: 1px solid rgba(13,148,136,0.08);
            transition: all 0.2s;
        }
        .search-result-item:hover { background: rgba(13,148,136,0.08); border-color: rgba(13,148,136,0.15); }
        .search-result-name { font-size: 0.82em; font-weight: 600; color: #334155; margin-bottom: 4px; }
        .search-result-details {
            display: flex; gap: 12px; font-size: 0.72em; color: #475569;
        }
        .search-result-details span { display: flex; align-items: center; gap: 4px; }

        /* --- Session Card --- */
        .session-card { padding: 10px; border-radius: 10px; background: linear-gradient(135deg, rgba(13,148,136,0.05), rgba(99,102,241,0.05)); }

        /* --- Notification Queue --- */
        .assistant-notification {
            position: fixed; z-index: 100010;
            left: 50%; transform: translateX(-50%); top: 20px;
            padding: 12px 24px; border-radius: 12px;
            background: #fff; color: #334155;
            font-size: 0.85em; font-family: 'Tajawal', sans-serif;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            border-right: 4px solid #0d9488;
            animation: slideNotif 0.4s ease;
            max-width: 400px;
        }
        .assistant-notification.warning { border-right-color: #f97316; }
        .assistant-notification.error { border-right-color: #ef4444; }
        .assistant-notification.success { border-right-color: #22c55e; }
        @keyframes slideNotif {
            from { transform: translateX(-50%) translateY(-30px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* --- Progress ring animation --- */
        @keyframes healthScoreFill {
            from { stroke-dashoffset: 283; }
        }

        @media screen and (max-width: 768px) {
            .assistant-fab { bottom: 75px; left: 15px; }
            .assistant-panel { left: 10px !important; right: 10px !important; width: auto !important; bottom: 75px !important; max-height: 80vh !important; }
            .assistant-panel.fullscreen { left: 5px !important; right: 5px !important; max-width: none !important; transform: none !important; }
            .welcome-card { padding: 25px; }
            .welcome-card .welcome-features { grid-template-columns: 1fr; }
            .assistant-tools-grid { grid-template-columns: 1fr 1fr; }
            .analytics-row { grid-template-columns: 1fr; }
            .assistant-tab .tab-label { font-size: 0.78em; }
            .assistant-tab { padding: 7px 4px; }
        }

        /* === Scanline effect on mode selection === */
        #mode-selection-modal .modal-content::before {
            content: ''; position: absolute; top: -100%; left: 0; right: 0;
            height: 100%; pointer-events: none;
            background: linear-gradient(transparent 50%, rgba(13, 148, 136, 0.02) 50%);
            background-size: 100% 4px;
            animation: scanline 8s linear infinite;
            z-index: 1; opacity: 0.5;
        }

        /* Mode buttons enhanced layout */
        .mode-btn { display: flex !important; align-items: center !important; gap: 15px !important; text-align: right !important; }
        .mode-btn i { font-size: 1.6em !important; min-width: 40px; text-align: center; }
        .mode-btn div { flex: 1; }
        .mode-btn small { font-weight: 400 !important; }

        /* Sidebar assistant button styling */
        #sidebar-assistant-btn {
            background: rgba(13, 148, 136, 0.05) !important;
            border: 1px solid rgba(13, 148, 136, 0.12) !important;
            margin-top: 8px !important;
        }
        #sidebar-assistant-btn i { color: #0d9488 !important; }
        #sidebar-assistant-btn:hover {
            background: linear-gradient(135deg, #0d9488, #6366f1) !important;
            color: #fff !important;
        }
        #sidebar-assistant-btn:hover i { color: #fff !important; }

        /* === Responsive === */
        @media screen and (max-width: 768px) {
            .floating-shapes-container { opacity: 0.15 !important; }
        }
    </style>
</head>
<body>

    <!-- Particle Canvas -->
    <canvas id="particles-canvas"></canvas>

    <!-- 3D Floating Geometric Shapes -->
    <div class="floating-shapes-container">
        <div class="floating-shape shape-cube">
            <div class="face"></div><div class="face"></div><div class="face"></div>
            <div class="face"></div><div class="face"></div><div class="face"></div>
        </div>
        <div class="floating-shape shape-sphere"></div>
        <div class="floating-shape shape-ring"></div>
        <div class="floating-shape shape-pyramid"></div>
        <div class="floating-shape shape-diamond"></div>
        <div class="floating-shape shape-hex"></div>
        <div class="floating-shape shape-dots">
            <span></span><span></span><span></span>
        </div>
        <div class="floating-shape shape-cube-sm">
            <div class="face"></div><div class="face"></div><div class="face"></div>
            <div class="face"></div><div class="face"></div><div class="face"></div>
        </div>
    </div>

    <!-- Smart Assistant Panel -->
    <div class="assistant-fab" id="assistant-fab" title="المساعد الذكي">
        <div class="assistant-avatar">
            <div class="avatar-face">
                <div class="avatar-eyes">
                    <div class="avatar-eye left"></div>
                    <div class="avatar-eye right"></div>
                </div>
                <div class="avatar-mouth"></div>
            </div>
            <div class="avatar-ring"></div>
        </div>
        <span class="assistant-badge" id="assistant-badge">!</span>
    </div>

    <div class="assistant-panel" id="assistant-panel">
        <div class="assistant-panel-header">
            <div class="assistant-header-info">
                <div class="assistant-header-avatar" id="assistant-mood-avatar">
                    <div class="mini-face">
                        <div class="mini-eyes">
                            <div class="mini-eye"></div>
                            <div class="mini-eye"></div>
                        </div>
                        <div class="mini-mouth" id="mini-mouth"></div>
                    </div>
                </div>
                <div>
                    <h3>المساعد الذكي <span class="assistant-ai-badge">AI</span></h3>
                    <span class="assistant-status"><span class="status-dot"></span> <span id="assistant-status-text">متصل ونشط</span></span>
                </div>
            </div>
            <div class="assistant-header-actions">
                <button class="assistant-header-btn" id="assistant-minimize" title="تصغير"><i class="fas fa-minus"></i></button>
                <button class="assistant-header-btn" id="assistant-fullscreen" title="تكبير"><i class="fas fa-expand"></i></button>
                <button class="assistant-close" id="assistant-close"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="assistant-tabs" id="assistant-tabs">
            <button class="assistant-tab active" data-tab="chat"><i class="fas fa-comments"></i> <span class="tab-label">محادثة</span></button>
            <button class="assistant-tab" data-tab="analytics"><i class="fas fa-chart-pie"></i> <span class="tab-label">تحليلات</span></button>
            <button class="assistant-tab" data-tab="tools"><i class="fas fa-toolbox"></i> <span class="tab-label">أدوات</span></button>
            <button class="assistant-tab" data-tab="health"><i class="fas fa-heartbeat"></i> <span class="tab-label">صحة</span></button>
        </div>

        <!-- Tab: Chat -->
        <div class="assistant-tab-content active" id="tab-chat">
            <div class="assistant-panel-body" id="assistant-body">
                <!-- Messages will be injected here -->
            </div>
            <div class="assistant-quick-actions" id="assistant-quick-actions">
                <button class="quick-help-btn" data-help="overview"><i class="fas fa-info-circle"></i> نظرة عامة</button>
                <button class="quick-help-btn" data-help="current"><i class="fas fa-crosshairs"></i> القسم الحالي</button>
                <button class="quick-help-btn" data-help="shortcuts"><i class="fas fa-keyboard"></i> اختصارات</button>
                <button class="quick-help-btn" data-help="tips"><i class="fas fa-lightbulb"></i> نصائح</button>
                <button class="quick-help-btn" data-help="analyze"><i class="fas fa-search-dollar"></i> تحليل البيانات</button>
                <button class="quick-help-btn" data-help="validate"><i class="fas fa-clipboard-check"></i> فحص الأخطاء</button>
            </div>
            <!-- Chat Input -->
            <div class="assistant-chat-input-area">
                <div class="assistant-suggestions" id="assistant-suggestions"></div>
                <div class="assistant-input-wrapper">
                    <input type="text" id="assistant-chat-input" placeholder="اكتب سؤالك أو أمرك هنا... (جرب /)" autocomplete="off" />
                    <button id="assistant-send-btn" title="إرسال"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- Tab: Analytics -->
        <div class="assistant-tab-content" id="tab-analytics">
            <div class="analytics-dashboard" id="analytics-dashboard">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Tab: Tools -->
        <div class="assistant-tab-content" id="tab-tools">
            <div class="assistant-tools-grid" id="assistant-tools-grid">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <!-- Tab: Health -->
        <div class="assistant-tab-content" id="tab-health">
            <div class="health-dashboard" id="health-dashboard">
                <!-- Will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>
    
    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievement-popup">
        <i class="fas fa-trophy"></i>
        <span id="achievement-text">إنجاز جديد!</span>
    </div>

    <!-- NEW LAYOUT: Sidebar + Main Content -->
    <div class="app-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <i class="fas fa-calculator"></i>
                    <span class="logo-text">تعويضات 50%</span>
                </div>
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div class="sidebar-clock">
                <div class="clock-time" id="live-time">--:--:--</div>
                <div class="clock-date" id="live-date">----/--/--</div>
            </div>
            
            <nav class="sidebar-nav">
                <button id="switch-mode-btn" class="nav-item home-btn">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </button>
                <button data-section="institution-info-section" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>معلومات المؤسسة</span>
                </button>
                <button data-section="compensation-management-section" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>إدارة التعويضات</span>
                </button>
                <button data-section="reporting-section" class="nav-item">
                    <i class="fas fa-file-alt"></i>
                    <span>التقارير والتصدير</span>
                </button>
                <button data-section="pro-txt-editor-section" class="nav-item">
                    <i class="fas fa-edit"></i>
                    <span>تعديل ملف TXT</span>
                </button>
                <button data-section="backup-restore-section" class="nav-item">
                    <i class="fas fa-database"></i>
                    <span>النسخ الاحتياطي</span>
                </button>
                <button class="nav-item theme-toggle" id="sound-toggle-btn">
                    <i class="fas fa-volume-up"></i>
                    <span>الأصوات</span>
                </button>
                <button class="nav-item" id="sidebar-assistant-btn" onclick="SmartAssistant.open()">
                    <i class="fas fa-robot"></i>
                    <span>المساعد الذكي</span>
                </button>
            </nav>
        </aside>
        
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="page-title">
                    <h1 id="current-page-title">
                        <i class="fas fa-certificate"></i>
                        برنامج حساب تعويض 50% من استهلاك الكهرباء والغاز
                    </h1>
                </div>
                <div class="top-bar-actions">
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <i class="fas fa-users"></i>
                            <span id="quick-beneficiary-count">0</span>
                        </div>
                        <div class="quick-stat success">
                            <i class="fas fa-coins"></i>
                            <span id="quick-total-compensation">0.00</span>
                        </div>
                    </div>
                    <button class="help-btn" title="المساعد الذكي (F1)" onclick="SmartAssistant.open()">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </header>
            
            <!-- Content Sections -->
            <div class="content-area">
        <!-- معلومات المؤسسة -->
        <section id="institution-info-section" class="app-section">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-building"></i></div>
                <div class="section-title-info">
                    <h2>معلومات المؤسسة</h2>
                    <p class="section-desc">قم بإدخال المعلومات الأساسية للمؤسسة التعليمية</p>
                </div>
            </div>
            <div class="section-content">
            <form id="institution-info-form">
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-flag"></i>
                        <span>المعلومات الرسمية</span>
                    </div>
                    <div class="form-card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="republic"><i class="fas fa-globe-africa"></i> الجمهورية:</label>
                        <input type="text" id="republic" value="الجمهورية الجزائرية الديمقراطية الشعبية">
                    </div>
                    <div class="form-group">
                        <label for="ministry"><i class="fas fa-landmark"></i> الوزارة:</label>
                        <input type="text" id="ministry" value="وزارة التربية الوطنية">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="directorate"><i class="fas fa-map-marker-alt"></i> المديرية:</label>
                        <input type="text" id="directorate" value="مديرية التربية لولاية أدرار">
                    </div>
                    <div class="form-group">
                        <label for="institution"><i class="fas fa-school"></i> المؤسسة:</label>
                        <input type="text" id="institution" value="متوسطة حكومي قدور بن علال">
                    </div>
                </div>
                    </div>
                </div>
                
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-calendar-alt"></i>
                        <span>المعلومات المالية</span>
                    </div>
                    <div class="form-card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fiscal-year"><i class="fas fa-calendar"></i> السنة المالية (YYYY):</label>
                        <input type="text" id="fiscal-year" value="2025" placeholder="مثال: 2025" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label for="financial-month"><i class="fas fa-calendar-day"></i> الشهر المالي (MM):</label>
                        <input type="text" id="financial-month" value="" placeholder="مثال: 04" maxlength="2">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="treasury-account"><i class="fas fa-credit-card"></i> رقم الحساب البريدي لدى الخزينة (CCP):</label>
                        <input type="text" id="treasury-account" value="" placeholder="حساب الخزينة CCP">
                    </div>
                    <div class="form-group">
                        <label for="treasury-key"><i class="fas fa-key"></i> مفتاح الحساب البريدي لدى الخزينة (CLE):</label>
                        <input type="text" id="treasury-key" value="" placeholder="مفتاح حساب الخزينة 02 رقم" maxlength="2">
                    </div>
                </div>
                    </div>
                </div>
                
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>معلومات الصرف</span>
                    </div>
                    <div class="form-card-body">
                <div class="form-row">
                     <div class="form-group">
                         <label for="order-number"><i class="fas fa-hashtag"></i> رقم الأمر بالصرف:</label>
                         <input type="text" id="order-number" value="">
                     </div>
                     <div class="form-group">
                         <label for="transfer-number"><i class="fas fa-exchange-alt"></i> رقم الحوالة:</label>
                         <input type="text" id="transfer-number" value="">
                     </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="open-credit"><i class="fas fa-coins"></i> الاعتماد المفتوح (دج):</label>
                        <input type="number" id="open-credit" value="0" step="0.01" placeholder="أدخل المبلغ الإجمالي للاعتماد">
                    </div>
                    <div class="form-group" id="equipment-grant-field" style="display: none;">
                        <label for="equipment-grant-value"><i class="fas fa-gift"></i> قيمة منحة التجهيز (دج):</label>
                        <input type="number" id="equipment-grant-value" value="0" step="0.01" placeholder="قيمة المنحة الثابتة">
                    </div>
                </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="save-btn"><i class="fas fa-save"></i> حفظ المعلومات</button>
                </div>
            </form>
            </div>
        </section>

        <!-- إدارة المستفيدين (Deprecated - kept for structure but hidden) -->
        <section id="beneficiary-management-section" class="app-section" style="display: none !important;"></section>

        <!-- إدارة التعويضات (NEW GRID UI) -->
        <section id="compensation-management-section" class="app-section">
            <div class="section-header management-header">
                <div class="section-icon"><i class="fas fa-users"></i></div>
                <div class="section-title-info">
                    <h2>إدارة التعويضات والمستفيدين</h2>
                    <p class="section-desc">إدارة وحساب تعويضات المستفيدين</p>
                </div>
            </div>
            <div class="section-content">
                <div class="credit-summary-container">
                    <div class="credit-card">
                        <i class="fas fa-wallet"></i>
                        <div class="credit-info">
                            <span class="credit-label">الاعتماد المفتوح</span>
                            <span class="credit-value" id="display-open-credit">0,00 دج</span>
                        </div>
                    </div>
                    <div class="credit-card spent">
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="credit-info">
                            <span class="credit-label">مجموع التعويضات (المصروف من الاعتماد)</span>
                            <span class="credit-value" id="display-amount-spent">0,00 دج</span>
                        </div>
                    </div>
                    <div class="credit-card discounts">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div class="credit-info">
                            <span class="credit-label">المبالغ المخصومة (تُحوَّل لجهة أخرى)</span>
                            <span class="credit-value" id="display-total-discounts">0,00 دج</span>
                        </div>
                    </div>
                    <div class="credit-card remaining">
                        <i class="fas fa-piggy-bank"></i>
                        <div class="credit-info">
                            <span class="credit-label">الاعتماد المتبقي</span>
                            <span class="credit-value remaining-credit-value" id="display-remaining-credit">0,00 دج</span>
                        </div>
                    </div>
                </div>
                <div class="compensation-grid-toolbar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="compensation-grid-search" placeholder="بحث بالاسم أو CCP...">
                    </div>
                    <div class="actions-container">
                        <!-- الحفظ التلقائي مفعل دائماً -->
                        <input type="checkbox" id="auto-save-checkbox" checked style="display: none;">
                        <button id="add-beneficiary-btn" class="primary-action-btn"><i class="fas fa-user-plus"></i> إضافة مستفيد جديد</button>
                    </div>
                </div>
                <div class="compensation-grid-container">
                    <table id="compensation-grid-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اللقب و الاسم</th>
                                <th>تعويض ث 1</th>
                                <th>تعويض ث 2</th>
                                <th>تعويض ث 3</th>
                                <th>تعويض ث 4</th>
                                <th>المجموع</th>
                                <th>الخصم</th>
                                <th>الصافي للدفع</th>
                                <th class="status-column">الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- التقارير والتصدير -->
        <section id="reporting-section" class="app-section">
            <div class="section-header reports-header">
                <div class="section-icon"><i class="fas fa-file-alt"></i></div>
                <div class="section-title-info">
                    <h2>التقارير والتصدير</h2>
                    <p class="section-desc">طباعة التقارير وتصدير البيانات بصيغ مختلفة</p>
                </div>
            </div>
            <div class="section-content">
                <div class="export-actions-grid">
                    <div class="export-card" id="print-report-btn">
                        <div class="export-icon print"><i class="fas fa-print"></i></div>
                        <span class="export-label">طباعة التقرير</span>
                        <span class="export-desc">طباعة تقرير شامل</span>
                    </div>
                    <div class="export-card" id="export-xlsx-btn">
                        <div class="export-icon excel"><i class="fas fa-file-excel"></i></div>
                        <span class="export-label">تصدير XLSX</span>
                        <span class="export-desc">ملف Excel</span>
                    </div>
                    <div class="export-card" id="export-txt-btn">
                        <div class="export-icon text"><i class="fas fa-file-code"></i></div>
                        <span class="export-label">تصدير TXT</span>
                        <span class="export-desc">ملف نصي</span>
                    </div>
                    <div class="export-card" id="print-cdrom-btn">
                        <div class="export-icon cdrom"><i class="fas fa-compact-disc"></i></div>
                        <span class="export-label">جدول CD-ROM</span>
                        <span class="export-desc">للدفع الإلكتروني</span>
                    </div>
                </div>
                
                <div class="report-preview-section">
                    <h3><i class="fas fa-eye"></i> معاينة التقرير</h3>
                    <div id="report-preview" class="report-output"></div>
                </div>
            </div>
        </section>

        <!-- التعديل الاحترافي على ملف TXT -->
        <section id="pro-txt-editor-section" class="app-section">
            <div class="section-header pro-editor-header">
                <div class="section-icon"><i class="fas fa-edit"></i></div>
                <div class="section-title-info">
                    <h2>التعديل الاحترافي على ملف TXT</h2>
                    <p class="section-desc">هذا التبويب مخصص من أجل التعديل على مبالغ المستفيدين في حالة وجود مبالغ إضافية لنفس المستفيد متعلقة إمّا بمبالغ مسترجعة لنفس المستفيد أو تعويضات من منح أخرى لنفس المستفيد. في هذه الحالة قم فقط بإضافة المبلغ الجديد إلى مبلغ التعويض وأدرج مجموعهما في المبلغ المعدّل ثم قم بتصدير ملف TXT الجديد.</p>
                    <p class="section-desc"><strong>ملاحظة :</strong> بإمكانك إما استدعاء التعويضات المحجوزة من خلال زر تحميل من التعويضات أو استيراد ملف TXT سابق والتعديل عليه، وبعد انتهاء التعديل تصدير الملف الجديد لحرقه على CD وطباعة جدول الإرسال CD.</p>
                </div>
            </div>
            <div class="section-content">
                <div class="pro-editor-controls">
                    <div class="control-row">
                        <div class="control-group">
                            <label><i class="fas fa-calendar-alt"></i> السنة المالية</label>
                            <input type="number" id="pro-fiscal-year-input" min="2020" max="2050" value="2025" onchange="updateProInfo()">
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-calendar-day"></i> الشهر المالي</label>
                            <select id="pro-fiscal-month-input" onchange="updateProInfo()">
                                <option value="1">جانفي (01)</option>
                                <option value="2">فيفري (02)</option>
                                <option value="3">مارس (03)</option>
                                <option value="4">أفريل (04)</option>
                                <option value="5">ماي (05)</option>
                                <option value="6">جوان (06)</option>
                                <option value="7">جويلية (07)</option>
                                <option value="8">أوت (08)</option>
                                <option value="9">سبتمبر (09)</option>
                                <option value="10">أكتوبر (10)</option>
                                <option value="11">نوفمبر (11)</option>
                                <option value="12">ديسمبر (12)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-file-invoice"></i> رقم الأمر بالصرف</label>
                            <input type="number" id="pro-order-number" min="0" value="0" onchange="updateProInfo()">
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-money-check-alt"></i> رقم الحوالة</label>
                            <input type="number" id="pro-transfer-number" min="0" value="0" onchange="updateProInfo()">
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-university"></i> رقم حساب الخزينة CCP</label>
                            <input type="text" id="pro-treasury-account" placeholder="رقم حساب الخزينة" onchange="updateProInfo()">
                        </div>
                        <div class="control-group">
                            <label><i class="fas fa-key"></i> رقم المفتاح</label>
                            <input type="text" id="pro-key-number" placeholder="رقم المفتاح" onchange="updateProInfo()">
                        </div>
                    </div>
                </div>

                <div class="pro-editor-info-cards">
                    <div class="info-card">
                        <i class="fas fa-users"></i>
                        <div class="info-details">
                            <span class="info-label">عدد المستفيدين</span>
                            <span class="info-value" id="pro-beneficiary-count">0</span>
                        </div>
                    </div>
                    <div class="info-card highlight">
                        <i class="fas fa-coins"></i>
                        <div class="info-details">
                            <span class="info-label">المجموع الكلي</span>
                            <span class="info-value" id="pro-total-amount">0,00 دج</span>
                        </div>
                    </div>
                    <div class="info-card" id="pro-source-card">
                        <i class="fas fa-database"></i>
                        <div class="info-details">
                            <span class="info-label">مصدر البيانات</span>
                            <span class="info-value" id="pro-data-source">التعويضات المحجوزة</span>
                        </div>
                    </div>
                </div>

                <div class="pro-editor-actions">
                    <button class="pro-action-btn import-btn" onclick="proImportTxt()">
                        <i class="fas fa-file-import"></i>
                        <span>استيراد ملف TXT</span>
                    </button>
                    <button class="pro-action-btn load-btn" onclick="proLoadFromCompensations()">
                        <i class="fas fa-sync-alt"></i>
                        <span>تحميل من التعويضات</span>
                    </button>
                    <button class="pro-action-btn export-btn" onclick="proExportTxt()">
                        <i class="fas fa-file-export"></i>
                        <span>تصدير ملف TXT</span>
                    </button>
                    <button class="pro-action-btn print-btn" onclick="proPrintCDRom()">
                        <i class="fas fa-print"></i>
                        <span>طباعة جدول CD-ROM</span>
                    </button>
                    <button class="pro-action-btn reset-btn" onclick="proResetAmounts()">
                        <i class="fas fa-undo"></i>
                        <span>استعادة المبالغ الأصلية</span>
                    </button>
                    <button class="pro-action-btn clear-btn" onclick="proClearTable()">
                        <i class="fas fa-trash-alt"></i>
                        <span>مسح الجدول</span>
                    </button>
                </div>

                <input type="file" id="pro-import-file-input" accept=".txt" style="display: none;" onchange="proHandleFileImport(event)">

                <div class="pro-editor-table-container">
                    <table id="pro-editor-table" class="pro-editor-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 180px;">اللقب والاسم</th>
                                <th style="width: 140px;">CCP (قابل للتعديل)</th>
                                <th style="width: 180px;">RIP</th>
                                <th style="width: 120px;">المبلغ الأصلي</th>
                                <th style="width: 140px;">المبلغ المعدل</th>
                                <th style="width: 50px;">حذف</th>
                            </tr>
                        </thead>
                        <tbody id="pro-editor-tbody"></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <th colspan="4">المجموع الكلي</th>
                                <th id="pro-original-total">0,00</th>
                                <th id="pro-modified-total">0,00</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="pro-empty-state" id="pro-empty-state">
                        <i class="fas fa-file-alt"></i>
                        <p>لا توجد بيانات حالياً</p>
                        <p class="hint">قم باستيراد ملف TXT أو تحميل البيانات من التعويضات المحجوزة</p>
                    </div>
                </div>
            </div>
         </section>

         <!-- Backup/Restore -->
         <section id="backup-restore-section" class="app-section">
            <div class="section-header backup-header">
                <div class="section-icon"><i class="fas fa-database"></i></div>
                <div class="section-title-info">
                    <h2>النسخ الاحتياطي والاستعادة</h2>
                    <p class="section-desc">حماية بياناتك واستعادتها عند الحاجة</p>
                </div>
            </div>
            <div class="section-content">
                <div class="backup-actions-grid">
                    <div class="backup-card create" id="create-backup-btn">
                        <div class="backup-icon"><i class="fas fa-download"></i></div>
                        <span class="backup-label">إنشاء نسخة احتياطية</span>
                        <span class="backup-desc">حفظ جميع البيانات</span>
                    </div>
                    <div class="backup-card restore" id="restore-backup-btn">
                        <div class="backup-icon"><i class="fas fa-upload"></i></div>
                        <span class="backup-label">استعادة من نسخة</span>
                        <span class="backup-desc">استيراد بيانات سابقة</span>
                    </div>
                    <div class="backup-card danger" id="delete-all-beneficiaries-btn">
                        <div class="backup-icon"><i class="fas fa-trash-alt"></i></div>
                        <span class="backup-label">حذف جميع المستفيدين</span>
                        <span class="backup-desc">سيتم حفظ نسخة تلقائياً</span>
                    </div>
                    <div class="backup-card import-txt" id="import-txt-btn">
                        <div class="backup-icon"><i class="fas fa-file-import"></i></div>
                        <span class="backup-label">استيراد من ملف TXT</span>
                        <span class="backup-desc">استيراد قائمة المستفيدين</span>
                    </div>
                </div>
                <input type="file" id="restore-file-input" accept=".json" style="display: none;">
                <input type="file" id="import-txt-input" accept=".txt,.csv" style="display: none;">
            </div>
         </section>
         
            </div><!-- End content-area -->
            
            <!-- Credit Warning Banner -->
            <div id="credit-warning-banner" class="credit-warning-banner">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="warning-text" id="warning-text">تحذير: تم تجاوز الاعتماد المفتوح!</span>
                <button class="close-warning-btn" onclick="closeCreditWarning()"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Scroll to Top Button -->
            <button id="scroll-to-top-btn" class="scroll-to-top-btn" title="العودة لأعلى الصفحة">
                <i class="fas fa-arrow-up"></i>
            </button>
        </div><!-- End main-content -->
    </div><!-- End app-wrapper -->

    <!-- News Ticker at bottom -->
    <div id="ticker-container">
        <div class="ticker-wrapper">
            <div class="ticker-content" id="ticker-content">
                <span class="ticker-item"><i class="fas fa-lightbulb"></i> نصيحة: استخدم Ctrl+S للحفظ السريع</span>
                <span class="ticker-item"><i class="fas fa-info-circle"></i> يمكنك تصدير البيانات إلى Excel أو ملف نصي</span>
                <span class="ticker-item"><i class="fas fa-shield-alt"></i> لا تنس إنشاء نسخة احتياطية بشكل دوري</span>
                <span class="ticker-item"><i class="fas fa-keyboard"></i> اضغط F1 لعرض اختصارات لوحة المفاتيح</span>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab-btn scroll-top" title="العودة للأعلى">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>

    <div id="print-report-content" class="report-output" style="display: none;"></div>

    <!-- Add/Edit Beneficiary Modal -->
    <div id="beneficiary-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="beneficiary-modal-title"></h3>
            <form id="beneficiary-form">
                 <input type="hidden" id="beneficiary-id">
                 <div>
                    <label for="beneficiary-name">اللقب و الاسم:</label>
                    <input type="text" id="beneficiary-name" required placeholder="الرجاء حجز الاسم و اللقب كاملا باللغة اللاتينية" pattern="^[a-zA-Z\s\-]+$" inputmode="latin">
                </div>
                <div class="form-row">
                    <div>
                        <label for="account-number">رقم الحساب (CCP):</label>
                        <input type="text" id="account-number" required oninput="updateCalculatedRIP()">
                    </div>
                    <div id="meter-field-group">
                        <label for="meter-number">رقم العداد:</label>
                        <input type="text" id="meter-number">
                    </div>
                    <div id="section-field-group" style="display: none;">
                        <label for="section-name">القسم:</label>
                        <input type="text" id="section-name" placeholder="القسم التربوي أو الإداري">
                    </div>
                    <div id="rank-field-group" style="display: none;">
                        <label for="rank-name">الرتبة:</label>
                        <input type="text" id="rank-name" placeholder="مثال: أستاذ، مقتصد...">
                    </div>
                    <div id="amount-field-group" style="display: none;">
                        <label for="initial-amount">مبلغ التعويض:</label>
                        <input type="number" id="initial-amount" step="0.01" placeholder="0.00">
                    </div>
                    <div>
                        <label for="calculated-rip">رقم RIP الكامل (20 رقم):</label>
                        <input type="text" id="calculated-rip" value="" readonly placeholder="يتم حسابه تلقائياً">
                    </div>
                </div>
                 <div class="modal-buttons">
                    <button type="submit" class="save-button"><i class="fas fa-save"></i> حفظ</button>
                    <button type="button" class="cancel-button" id="cancel-beneficiary-btn"><i class="fas fa-times-circle"></i> إلغاء</button>
                 </div>
            </form>
        </div>
    </div>
    
    <!-- Quarterly Details Modal -->
    <div id="quarterly-details-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <h3 id="quarterly-modal-title"></h3>
            <form id="quarterly-details-form">
                <input type="hidden" id="quarterly-beneficiary-id">
                <input type="hidden" id="quarterly-quarter-index">
                <div class="form-row">
                    <div>
                        <label for="quarterly-nofees">المبلغ دون رسوم:</label>
                        <input type="number" id="quarterly-nofees" step="0.01" value="0.00">
                    </div>
                    <div>
                        <label for="quarterly-value">القيمة المضافة:</label>
                        <input type="number" id="quarterly-value" step="0.01" value="0.00">
                    </div>
                </div>
                 <div>
                    <label for="quarterly-contrib">مساهمة الدولة:</label>
                    <input type="number" id="quarterly-contrib" step="0.01" value="0.00">
                 </div>
                <div class="modal-buttons">
                    <button type="submit" class="save-button"><i class="fas fa-check"></i> تأكيد</button>
                    <button type="button" class="cancel-button" id="cancel-quarterly-btn"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Import TXT Modal -->
    <div id="import-txt-modal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-file-import"></i> استيراد المستفيدين</h3>
            <p>حدد تنسيق الملف:</p>
            
            <div class="import-format-options">
                <label class="import-option highlight-option">
                    <input type="radio" name="import-format" value="payment-file" checked>
                    <span class="option-text">
                        <strong>📄 ملف الدفع الإلكتروني</strong>
                        <small>تنسيق Algérie Poste</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="semicolon">
                    <span class="option-text">
                        <strong>فاصلة منقوطة (;)</strong>
                        <small>الاسم;الحساب;العداد</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="comma">
                    <span class="option-text">
                        <strong>فاصلة (,)</strong>
                        <small>الاسم,الحساب,العداد</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="tab">
                    <span class="option-text">
                        <strong>تاب (Tab)</strong>
                        <small>الاسم[TAB]الحساب</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="pipe">
                    <span class="option-text">
                        <strong>خط عمودي (|)</strong>
                        <small>الاسم|الحساب|العداد</small>
                    </span>
                </label>
            </div>
            
            <div class="import-options-extra" id="header-option-container">
                <label class="checkbox-option">
                    <input type="checkbox" id="import-has-header">
                    <span>تخطي السطر الأول (عناوين)</span>
                </label>
            </div>
            
            <div class="import-preview" id="import-preview" style="display: none;">
                <div class="import-preview-header">
                    <h4>معاينة:</h4>
                    <div class="selection-buttons">
                        <button type="button" class="btn-select-all" onclick="selectAllImport(true)"><i class="fas fa-check-double"></i> الكل</button>
                        <button type="button" class="btn-select-none" onclick="selectAllImport(false)"><i class="fas fa-square"></i> لا شيء</button>
                    </div>
                </div>
                <div class="preview-table-container">
                    <table id="import-preview-table"></table>
                </div>
                <p class="preview-count">تم تحديد <span id="import-selected-count">0</span> من <span id="import-count">0</span></p>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="save-button" id="confirm-import-txt" style="display: none;"><i class="fas fa-check"></i> تأكيد الاستيراد</button>
                <button type="button" class="cancel-button" onclick="cancelImportTxt()"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Mode Selection Modal -->
    <div id="mode-selection-modal" class="modal-overlay visible" style="display: flex;">
        <div class="modal-content">
            <h2><i class="fas fa-cogs"></i> اختر نظام العمل</h2>
            <p>يرجى اختيار نوع التعويضات التي تريد العمل عليها:</p>
            <button class="mode-btn" onclick="selectMode('electricity')">
                <i class="fas fa-bolt"></i>
                <div>
                    <strong>تعويضات استهلاك الكهرباء والغاز</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">حساب 50% من فواتير الاستهلاك الفصلية</small>
                </div>
            </button>
            <button class="mode-btn" onclick="selectMode('equipment')">
                <i class="fas fa-chair"></i>
                <div>
                    <strong>تعويضات منحة التجهيز</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">صرف منحة التجهيز الخاصة بالموظفين</small>
                </div>
            </button>
            <button class="mode-btn" onclick="selectMode('transport')">
                <i class="fas fa-bus"></i>
                <div>
                    <strong>تعويض مصاريف التنقل</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">تسديد مصاريف النقل والتنقل</small>
                </div>
            </button>
            <button class="mode-btn" onclick="selectMode('training')">
                <i class="fas fa-chalkboard-teacher"></i>
                <div>
                    <strong>تعويض مصاريف العمليات التكوينية</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">تسديد مصاريف التكوين والتدريب</small>
                </div>
            </button>
        </div>
    </div>

    <!-- Restore Type Selection Modal -->
    <div id="restore-type-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h3><i class="fas fa-upload"></i> اختر نوع الاستعادة</h3>
            <p>اختر ما تريد استعادته من النسخة الاحتياطية:</p>
            <button class="mode-btn" onclick="selectRestoreType('full')">
                <i class="fas fa-database"></i>
                استعادة جميع البيانات (معلومات المؤسسة + المستفيدين + التعويضات)
            </button>
            <button class="mode-btn" onclick="selectRestoreType('beneficiaries')">
                <i class="fas fa-users"></i>
                استيراد معلومات المستفيدين فقط
            </button>
            <div class="modal-buttons">
                <button type="button" class="cancel-button" onclick="cancelRestoreType()">
                    <i class="fas fa-times-circle"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Beneficiary Selection Modal -->
    <div id="beneficiary-selection-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 650px; max-height: 80vh; overflow-y: auto;">
            <h3><i class="fas fa-user-check"></i> اختر المستفيدين للاستيراد</h3>
            <p>حدد المستفيدين الذين تريد استيراد بياناتهم:</p>
            <div style="margin-bottom: 15px;">
                <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold; color: var(--primary-dark-color);">
                    <input type="checkbox" id="select-all-beneficiaries" style="width: 18px; height: 18px; cursor: pointer;">
                    تحديد/إلغاء تحديد الكل
                </label>
            </div>
            <div id="beneficiary-selection-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; background: var(--background-white); border-radius: var(--border-radius-sm);">
                <!-- سيتم ملء القائمة ديناميكياً -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="save-button" onclick="confirmBeneficiarySelection()">
                    <i class="fas fa-check"></i> تأكيد الاستيراد
                </button>
                <button type="button" class="cancel-button" onclick="cancelBeneficiarySelection()">
                    <i class="fas fa-times-circle"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="ticker-container">
        <div id="ticker-content">
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
            <span>&nbsp;&nbsp;***&nbsp;&nbsp;</span>
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
            <span>&nbsp;&nbsp;***&nbsp;&nbsp;</span>
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
        </div>
    </div>

    <script>
        // --- Data Storage ---
        let currentMode = 'electricity'; // 'electricity' or 'equipment'
        let tempBackupData = null; // مؤقت لحفظ بيانات النسخة الاحتياطية
        
        let institutionInfo = {
            republic: "الجمهورية الجزائرية الديمقراطية الشعبية",
            ministry: "وزارة التربية الوطنية",
            directorate: "مديرية التربية لولاية أدرار",
            institution: "متوسطة حكومي قدور بن علال",
            fiscalYear: "2025",
            financialMonth: "",
            treasuryAccount: "",
            treasuryKey: "",
            orderNumber: "",
            transferNumber: "",
            openCredit: 0,
            equipmentGrantValue: 0,
            modeDetails: {
                electricity: { credit: 0, order: "", transfer: "", month: "" },
                equipment: { credit: 0, order: "", transfer: "", month: "" },
                transport: { credit: 0, order: "", transfer: "", month: "" },
                training: { credit: 0, order: "", transfer: "", month: "" }
            }
        };

        let beneficiaries = [];
        let compensations = []; // Electricity compensations
        let compensationsEquipment = []; // Equipment compensations
        let compensationsTransport = []; // Transport compensations
        let compensationsTraining = []; // Training compensations


        // --- Helper Functions ---
        function loadData() {
            try {
                const savedInstitutionInfo = localStorage.getItem('institutionInfo');
                const savedBeneficiaries = localStorage.getItem('beneficiaries');
                const savedCompensations = localStorage.getItem('compensations');
                const savedCompensationsEquipment = localStorage.getItem('compensationsEquipment');
                const savedCompensationsTransport = localStorage.getItem('compensationsTransport');
                const savedCompensationsTraining = localStorage.getItem('compensationsTraining');

                if (savedInstitutionInfo) {
                    const tempInfo = JSON.parse(savedInstitutionInfo);
                     institutionInfo = {
                         ...institutionInfo,
                         ...tempInfo
                     };
                     institutionInfo.openCredit = parseFloat(institutionInfo.openCredit) || 0;
                     institutionInfo.equipmentGrantValue = parseFloat(institutionInfo.equipmentGrantValue) || 0;
                     
                     if (!institutionInfo.modeDetails) {
                         institutionInfo.modeDetails = {
                            electricity: { credit: institutionInfo.openCredit, order: institutionInfo.orderNumber||"", transfer: institutionInfo.transferNumber||"", month: institutionInfo.financialMonth||"" },
                            equipment: { credit: 0, order: "", transfer: "", month: "" },
                            transport: { credit: 0, order: "", transfer: "", month: "" },
                            training: { credit: 0, order: "", transfer: "", month: "" }
                         };
                     }
                }

                if (savedBeneficiaries) {
                    beneficiaries = JSON.parse(savedBeneficiaries);
                    beneficiaries.forEach(b => {
                        b.id = parseInt(b.id) || 0;
                         if (b.meter === undefined) b.meter = "";
                         if (b.key !== undefined) delete b.key;
                    });
                    beneficiaries = beneficiaries.filter(b => b.id > 0);
                }

                if (savedCompensations) {
                    compensations = JSON.parse(savedCompensations);
                    compensations.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        const defaultQuarter = { nofees: 0, value: 0, contrib: 0, calculated: 0 };
                        comp.q1 = {...defaultQuarter, ...(comp.q1 || {})};
                        comp.q2 = {...defaultQuarter, ...(comp.q2 || {})};
                        comp.q3 = {...defaultQuarter, ...(comp.q3 || {})};
                        comp.q4 = {...defaultQuarter, ...(comp.q4 || {})};

                        comp.discount = roundToTwo(parseFloat(comp.discount) || 0);

                        comp.q1.calculated = calculateQuarterlyComp(comp.q1.nofees, comp.q1.value, comp.q1.contrib);
                        comp.q2.calculated = calculateQuarterlyComp(comp.q2.nofees, comp.q2.value, comp.q2.contrib);
                        comp.q3.calculated = calculateQuarterlyComp(comp.q3.nofees, comp.q3.value, comp.q3.contrib);
                        comp.q4.calculated = calculateQuarterlyComp(comp.q4.nofees, comp.q4.value, comp.q4.contrib);

                        const totalCalc = roundToTwo(comp.q1.calculated + comp.q2.calculated + comp.q3.calculated + comp.q4.calculated);
                        comp.netPayable = roundToTwo(totalCalc - comp.discount);
                    });
                    compensations = compensations.filter(comp => comp.beneficiaryId > 0);
                }
                
                if (savedCompensationsEquipment) {
                    compensationsEquipment = JSON.parse(savedCompensationsEquipment);
                    compensationsEquipment.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        comp.netPayable = roundToTwo(parseFloat(comp.netPayable) || 0);
                    });
                    compensationsEquipment = compensationsEquipment.filter(comp => comp.beneficiaryId > 0);
                }

                if (savedCompensationsTransport) {
                    compensationsTransport = JSON.parse(savedCompensationsTransport);
                    compensationsTransport.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        comp.netPayable = roundToTwo(parseFloat(comp.netPayable) || 0);
                    });
                    compensationsTransport = compensationsTransport.filter(comp => comp.beneficiaryId > 0);
                }

                if (savedCompensationsTraining) {
                    compensationsTraining = JSON.parse(savedCompensationsTraining);
                    compensationsTraining.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        comp.netPayable = roundToTwo(parseFloat(comp.netPayable) || 0);
                    });
                    compensationsTraining = compensationsTraining.filter(comp => comp.beneficiaryId > 0);
                }

                // --- MIGRATION: Assign types to legacy beneficiaries ---
                beneficiaries.forEach(b => {
                    if (!b.type) {
                        // Check if this beneficiary has explicit equipment data
                        const hasEquip = compensationsEquipment.some(c => c.beneficiaryId === b.id);
                        // Check if this beneficiary has explicit electricity data (non-zero)
                        const hasElec = compensations.some(c => c.beneficiaryId === b.id && c.netPayable > 0);
                        
                        if (hasEquip && !hasElec) {
                            b.type = 'equipment';
                        } else {
                            b.type = 'electricity'; // Default to electricity
                        }
                    }
                });

                 // Filter out compensations for deleted beneficiaries
                 compensations = compensations.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));
                 compensationsEquipment = compensationsEquipment.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));
                 compensationsTransport = compensationsTransport.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));
                 compensationsTraining = compensationsTraining.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));

            } catch (e) {
                console.error("An error occurred during data loading:", e);
                alert("حدث خطأ أثناء تحميل البيانات المحفوظة. قد يتم استخدام البيانات الافتراضية.");
            }
        }

        function saveData() {
            try {
                localStorage.setItem('institutionInfo', JSON.stringify(institutionInfo));
                localStorage.setItem('beneficiaries', JSON.stringify(beneficiaries));
                localStorage.setItem('compensations', JSON.stringify(compensations));
                localStorage.setItem('compensationsEquipment', JSON.stringify(compensationsEquipment));
                localStorage.setItem('compensationsTransport', JSON.stringify(compensationsTransport));
                localStorage.setItem('compensationsTraining', JSON.stringify(compensationsTraining));
            } catch (e) {
                console.error("An error occurred during data saving:", e);
                alert("حدث خطأ أثناء حفظ البيانات.");
            }
        }

        function selectMode(mode) {
            console.log('selectMode called with:', mode);
            currentMode = mode;
            const modal = document.getElementById('mode-selection-modal');
            
            // إخفاء النافذة فورًا
            modal.style.display = 'none';
            modal.classList.remove('visible');

            // Update UI based on mode
            const titleEl = document.querySelector('header h1');
            const equipmentField = document.getElementById('equipment-grant-field');
            
            if (mode === 'electricity') {
                titleEl.innerHTML = '<i class="fas fa-certificate" style="transform: rotate(30deg);"></i> برنامج حساب تعويض 50% من استهلاك الكهرباء والغاز';
                equipmentField.style.display = 'none';
            } else if (mode === 'equipment') {
                titleEl.innerHTML = '<i class="fas fa-chair"></i> برنامج تسديد منحة التجهيز';
                equipmentField.style.display = 'block';
            } else if (mode === 'transport') {
                titleEl.innerHTML = '<i class="fas fa-bus"></i> برنامج تعويض مصاريف التنقل';
                equipmentField.style.display = 'none';
            } else if (mode === 'training') {
                titleEl.innerHTML = '<i class="fas fa-chalkboard-teacher"></i> برنامج تعويض مصاريف العمليات التكوينية';
                equipmentField.style.display = 'none';
            }
            
            console.log('Loading mode specific info...');
            // Load mode specific info
            if (institutionInfo.modeDetails && institutionInfo.modeDetails[mode]) {
                const details = institutionInfo.modeDetails[mode];
                document.getElementById('open-credit').value = details.credit;
                document.getElementById('order-number').value = details.order;
                document.getElementById('transfer-number').value = details.transfer;
                document.getElementById('financial-month').value = details.month;
            }

            console.log('Calling showSection...');
            // Refresh views - go to compensation management section
            showSection('compensation-management-section');
            console.log('selectMode completed');
        }

        function getNextBeneficiaryId() {
            if (beneficiaries.length === 0) return 1;
            return Math.max(...beneficiaries.map(b => b.id)) + 1;
        }

        function formatCurrency(amount) {
            let parts = (parseFloat(amount) || 0).toFixed(2).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return parts.join(',');
        }

        function parseCurrency(str) {
            if (!str) return 0;
            const cleanStr = str.toString().replace(/\./g, '');
            const normalizedStr = cleanStr.replace(',', '.');
            return parseFloat(normalizedStr) || 0;
        }
        
        function numberToArabicText(amount) {
            const roundedAmount = Math.round(amount * 100) / 100;
            const [integerPart, decimalPart] = roundedAmount.toFixed(2).split('.');
            const onesArabic = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة', 'عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
            const tensArabic = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            
            function processThreeDigits(num) {
                if (num === 0) return '';
                const hundred = Math.floor(num / 100);
                const remainder = num % 100;
                let result = '';
                if (hundred > 0) result += hundreds[hundred] + (remainder > 0 ? ' و ' : '');
                if (remainder > 0 && remainder < 20) result += onesArabic[remainder];
                else if (remainder >= 20) {
                    const tens = Math.floor(remainder / 10), ones = remainder % 10;
                    result += (ones > 0 ? onesArabic[ones] + ' و ' : '') + tensArabic[tens];
                }
                return result;
            }
            
            const intValue = parseInt(integerPart);
            if (intValue === 0 && parseInt(decimalPart) === 0) return 'صفر دينار';
            
            const million = Math.floor(intValue / 1e6);
            const thousand = Math.floor((intValue % 1e6) / 1000);
            const remain = intValue % 1000;
            let result = '';

            if (million > 0) result += (million === 1 ? 'مليون' : million === 2 ? 'مليونان' : processThreeDigits(million) + (million > 10 ? ' مليون' : ' ملايين')) + (thousand > 0 || remain > 0 ? ' و ' : '');
            if (thousand > 0) result += (thousand === 1 ? 'ألف' : thousand === 2 ? 'ألفان' : processThreeDigits(thousand) + (thousand > 10 ? ' ألف' : ' آلاف')) + (remain > 0 ? ' و ' : '');
            if (remain > 0) result += processThreeDigits(remain);
            
            if (intValue > 0) result += (intValue === 1 ? ' دينار' : intValue === 2 ? ' ديناران' : intValue > 10 ? ' دينار' : ' دنانير');

            if (parseInt(decimalPart) > 0) {
                const decimalValue = parseInt(decimalPart);
                result += (intValue > 0 ? ' و ' : '') + processThreeDigits(decimalValue) + (decimalValue === 1 ? ' سنتيم' : decimalValue === 2 ? ' سنتيمان' : decimalValue > 10 ? ' سنتيم' : ' سنتيمات');
            }
            return result.replace(/^ و /, '').replace(/ و $/, '');
        }

         function calculateRIP(ccpNumberString) {
             if (!ccpNumberString || !/^\d+$/.test(ccpNumberString.trim())) return 'CCP غير صالح';
             const ccpPadded = ccpNumberString.trim().padStart(10, '0');
             let ripKey = (parseInt(ccpNumberString, 10) * 100) % 97;
             ripKey = 97 - (ripKey + 85) % 97;
             const rip = '00799999' + ccpPadded + ripKey.toString().padStart(2, '0');
             return rip.length === 20 ? rip : 'خطأ في الطول';
         }

        function updateCalculatedRIP() {
            const ccpInput = document.getElementById('account-number');
            const ripDisplay = document.getElementById('calculated-rip');
            ripDisplay.value = ccpInput.value.trim() ? calculateRIP(ccpInput.value) : '';
        }

        function showSection(sectionId) {
            // Update sidebar navigation
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.section === sectionId) {
                    button.classList.add('active');
                }
            });
            
            // Also update old nav if exists
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.section === sectionId) {
                    button.classList.add('active');
                }
            });

            document.querySelectorAll('.app-section').forEach(section => {
                if (section.id !== 'beneficiary-management-section') { 
                    section.style.display = 'none';
                    section.classList.remove('active');
                }
            });

            const sectionToShow = document.getElementById(sectionId);
            
            if (sectionToShow) {
                 const displayStyle = sectionId === 'compensation-management-section' ? 'flex' : 'block';
                 if (sectionId.includes('-modal')) {
                     sectionToShow.style.display = 'flex';
                     setTimeout(() => sectionToShow.classList.add('visible'), 10);
                 } else {
                     sectionToShow.style.display = displayStyle;
                     sectionToShow.classList.add('active');
                 }
            } else { return; }

            if (sectionId === 'institution-info-section') {
                for (const key in institutionInfo) {
                    if (key === 'openCredit' || key === 'orderNumber' || key === 'transferNumber' || key === 'financialMonth' || key === 'modeDetails') continue;
                    const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                    if (element) element.value = institutionInfo[key];
                }
                // تحميل البيانات الخاصة بنوع التعويض الحالي (الاعتماد المفتوح، رقم الحوالة، رقم الأمر، الشهر المالي)
                if (institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode]) {
                    const details = institutionInfo.modeDetails[currentMode];
                    document.getElementById('open-credit').value = details.credit || 0;
                    document.getElementById('order-number').value = details.order || '';
                    document.getElementById('transfer-number').value = details.transfer || '';
                    document.getElementById('financial-month').value = details.month || '';
                }
            } else if (sectionId === 'compensation-management-section') {
                renderCompensationGrid();
                updateCreditDisplay();
            } else if (sectionId === 'reporting-section') {
                generateReportPreview();
            } else if (sectionId === 'pro-txt-editor-section') {
                renderProEditorSection();
            }
        }

        function updateCreditDisplay() {
            let totalSpent = 0;  // المبلغ المصروف من الاعتماد (مجموع التعويضات الكلي)
            let totalDiscounts = 0;  // المبالغ المخصومة (تُحوَّل لجهة أخرى)
            
            if (currentMode === 'electricity') {
                // حساب مجموع التعويضات الكلي (ما يُصرف فعلياً من الاعتماد = مجموع التعويضات قبل الخصم)
                // المجموع = الصافي للدفع + الخصم (أي netPayable + discount)
                totalSpent = compensations.reduce((sum, comp) => {
                    const netPayable = parseFloat(comp.netPayable) || 0;
                    const discount = parseFloat(comp.discount) || 0;
                    return sum + netPayable + discount;
                }, 0);
                // حساب مجموع الخصومات (للعرض فقط - تُحوَّل لجهة أخرى)
                totalDiscounts = compensations.reduce((sum, comp) => sum + (parseFloat(comp.discount) || 0), 0);
            } else if (currentMode === 'equipment') {
                totalSpent = compensationsEquipment.reduce((sum, comp) => sum + (parseFloat(comp.netPayable) || 0), 0);
                totalDiscounts = 0; // لا يوجد خصومات في منحة التجهيز
            } else if (currentMode === 'transport') {
                totalSpent = compensationsTransport.reduce((sum, comp) => sum + (parseFloat(comp.netPayable) || 0), 0);
                totalDiscounts = 0; // لا يوجد خصومات في تعويض النقل
            } else if (currentMode === 'training') {
                totalSpent = compensationsTraining.reduce((sum, comp) => sum + (parseFloat(comp.netPayable) || 0), 0);
                totalDiscounts = 0; // لا يوجد خصومات في تعويض التكوين
            }
            
            // تقريب القيم إلى رقمين بعد الفاصلة
            totalSpent = Math.round(totalSpent * 100) / 100;
            totalDiscounts = Math.round(totalDiscounts * 100) / 100;
            
            const openCredit = (institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode]) ? parseFloat(institutionInfo.modeDetails[currentMode].credit) || 0 : 0;
            
            // الاعتماد المتبقي = الاعتماد المفتوح - مجموع التعويضات الكلي
            // ملاحظة: المبلغ المصروف هو المجموع الكلي (قبل الخصم) لأن الخصم يُحوَّل لجهة أخرى ولا يعود للاعتماد
            const remainingCredit = Math.round((openCredit - totalSpent) * 100) / 100;

            document.getElementById('display-open-credit').textContent = `${formatCurrency(openCredit)} دج`;
            document.getElementById('display-amount-spent').textContent = `${formatCurrency(totalSpent)} دج`;
            document.getElementById('display-total-discounts').textContent = `${formatCurrency(totalDiscounts)} دج`;
            
            const remainingEl = document.getElementById('display-remaining-credit');
            const remainingCard = remainingEl.closest('.credit-card');
            remainingEl.textContent = `${formatCurrency(remainingCredit)} دج`;
            
            // عرض تنبيه عند الاعتماد السالب
            const warningBanner = document.getElementById('credit-warning-banner');
            const warningText = document.getElementById('warning-text');
            
            if (remainingCredit < 0) {
                remainingEl.classList.add('negative');
                if (remainingCard) remainingCard.classList.add('negative-credit');
                
                // تحديث نص التنبيه وإظهار الشريط
                const exceededAmount = Math.abs(remainingCredit);
                warningText.textContent = `تحذير: تم تجاوز الاعتماد المفتوح بمبلغ ${formatCurrency(exceededAmount)} دج! (الاعتماد المتبقي: ${formatCurrency(remainingCredit)} دج)`;
                if (warningBanner) warningBanner.classList.add('visible');
                
                // إظهار إشعار Toast (مرة واحدة فقط عند التغيير)
                if (!window.lastNegativeCreditWarning || window.lastNegativeCreditWarning !== currentMode + remainingCredit) {
                    window.lastNegativeCreditWarning = currentMode + remainingCredit;
                    SoundSystem.creditAlert();
                    showToast(`تحذير: الاعتماد المتبقي سالب (${formatCurrency(remainingCredit)} دج)! تم تجاوز الاعتماد المفتوح بمبلغ ${formatCurrency(exceededAmount)} دج`, 'error');
                }
            } else {
                remainingEl.classList.remove('negative');
                if (remainingCard) remainingCard.classList.remove('negative-credit');
                if (warningBanner) warningBanner.classList.remove('visible');
                window.lastNegativeCreditWarning = null;
            }
        }
        
        // دالة إغلاق شريط التنبيه
        function closeCreditWarning() {
            const warningBanner = document.getElementById('credit-warning-banner');
            if (warningBanner) warningBanner.classList.remove('visible');
        }

        // --- Institution Info Management ---
        function saveInstitutionInfo(event) {
            event.preventDefault();
            
            // Validate fiscal year
            const fiscalYear = document.getElementById('fiscal-year').value.trim();
            if (!/^\d{4}$/.test(fiscalYear)) {
                showToast('السنة المالية يجب أن تكون 4 أرقام (مثال: 2025)', 'error');
                return;
            }
            
            const financialMonth = document.getElementById('financial-month').value.trim();
            if (financialMonth && !/^\d{1,2}$/.test(financialMonth)) {
                showToast('الشهر المالي يجب أن يكون رقماً بين 1 و 12', 'error');
                return;
            }

            for (const key in institutionInfo) {
                 if (key === 'openCredit' || key === 'equipmentGrantValue' || key === 'modeDetails' || key === 'orderNumber' || key === 'transferNumber' || key === 'financialMonth') continue;
                const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                if (element) institutionInfo[key] = element.value.trim();
            }
            
            const openCredit = parseFloat(document.getElementById('open-credit').value) || 0;
            if (openCredit < 0) {
                showToast('الاعتماد المفتوح لا يمكن أن يكون سالباً', 'error');
                return;
            }
            
            institutionInfo.equipmentGrantValue = parseFloat(document.getElementById('equipment-grant-value').value) || 0;
            
            // Save mode specific info
            if (!institutionInfo.modeDetails) institutionInfo.modeDetails = {};
            institutionInfo.modeDetails[currentMode] = {
                credit: openCredit,
                order: document.getElementById('order-number').value,
                transfer: document.getElementById('transfer-number').value,
                month: financialMonth
            };
            
            // Sync legacy fields
            institutionInfo.openCredit = institutionInfo.modeDetails[currentMode].credit;
            institutionInfo.orderNumber = institutionInfo.modeDetails[currentMode].order;
            institutionInfo.transferNumber = institutionInfo.modeDetails[currentMode].transfer;
            institutionInfo.financialMonth = institutionInfo.modeDetails[currentMode].month;
            
            saveData();
            showToast('تم حفظ معلومات المؤسسة بنجاح', 'success');
            updateCreditDisplay();
            if (document.getElementById('reporting-section').style.display === 'block') {
                 generateReportPreview();
            }
        }


        // --- Beneficiary Management ---
        function openBeneficiaryModal(id = null) {
            const modal = document.getElementById('beneficiary-modal');
            const form = document.getElementById('beneficiary-form');
            const title = document.getElementById('beneficiary-modal-title');
            
            form.reset(); 
            
            // Toggle fields based on mode
            const meterGroup = document.getElementById('meter-field-group');
            const sectionGroup = document.getElementById('section-field-group');
            const rankGroup = document.getElementById('rank-field-group');
            const amountGroup = document.getElementById('amount-field-group');
            
            meterGroup.style.display = 'none';
            sectionGroup.style.display = 'none';
            rankGroup.style.display = 'none';
            amountGroup.style.display = 'none';

            if (currentMode === 'electricity') {
                meterGroup.style.display = 'block';
            } else if (currentMode === 'equipment') {
                sectionGroup.style.display = 'block';
            } else if (currentMode === 'transport' || currentMode === 'training') {
                rankGroup.style.display = 'block';
                amountGroup.style.display = 'block';
            }

            if (id) { 
                const beneficiary = beneficiaries.find(b => b.id === id);
                if (!beneficiary) return;
                title.innerHTML = '<i class="fas fa-user-edit"></i> تعديل بيانات المستفيد';
                document.getElementById('beneficiary-id').value = beneficiary.id;
                document.getElementById('beneficiary-name').value = beneficiary.name;
                document.getElementById('account-number').value = beneficiary.account;
                document.getElementById('meter-number').value = beneficiary.meter || '';
                document.getElementById('section-name').value = beneficiary.section || '';
                document.getElementById('rank-name').value = beneficiary.rank || '';
                
                if (currentMode === 'transport' || currentMode === 'training') {
                    const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                    const comp = targetArray.find(c => c.beneficiaryId === id);
                    document.getElementById('initial-amount').value = comp ? comp.netPayable : '';
                }
            } else { 
                title.innerHTML = '<i class="fas fa-user-plus"></i> إضافة مستفيد جديد';
                document.getElementById('beneficiary-id').value = '';
            }
            
            updateCalculatedRIP(); 
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function cancelBeneficiaryEdit() {
            const modal = document.getElementById('beneficiary-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function saveBeneficiary(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('beneficiary-id').value) || null;
            const name = document.getElementById('beneficiary-name').value.trim();
            const account = document.getElementById('account-number').value.trim();
            const meter = document.getElementById('meter-number').value.trim();
            const section = document.getElementById('section-name').value.trim();
            const rank = document.getElementById('rank-name').value.trim();
            let amount = parseFloat(document.getElementById('initial-amount').value) || 0;
            
            // Validation
            if (!name || !account) {
                showToast('الرجاء ملء الاسم والحساب', 'error');
                return;
            }
            
            if (!/^[a-zA-Z\s\-]+$/.test(name)) {
                showToast('الرجاء إدخال الاسم بالأحرف اللاتينية فقط', 'error');
                return;
            }
            
            // التحقق من تكرار رقم الحساب فقط ضمن نفس نوع التعويض
            if (beneficiaries.some(b => b.account === account && b.id !== id && (b.type === currentMode || (!b.type && currentMode === 'electricity')))) {
                showToast('رقم الحساب مسجل بالفعل لمستفيد آخر في نفس نوع التعويض', 'error');
                return;
            }
            
            const rip = calculateRIP(account);
            if (rip.includes('خطأ')) {
                showToast('رقم الحساب غير صالح. تأكد من صحة الرقم', 'error');
                return;
            }

            // Validate amount for transport/training modes
            if ((currentMode === 'transport' || currentMode === 'training') && amount < 0) {
                showToast('المبلغ لا يمكن أن يكون سالباً', 'error');
                return;
            }

            if (id) { 
                const beneficiary = beneficiaries.find(b => b.id === id);
                if (beneficiary) {
                    beneficiary.name = name;
                    beneficiary.account = account;
                    beneficiary.meter = meter;
                    beneficiary.section = section;
                    beneficiary.rank = rank;
                }
                
                if (currentMode === 'transport' || currentMode === 'training') {
                     let targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                     let comp = targetArray.find(c => c.beneficiaryId === id);
                     if (comp) comp.netPayable = amount;
                     else targetArray.push({ beneficiaryId: id, netPayable: amount });
                }
                
                showToast('تم حفظ التعديلات بنجاح', 'success');
            } else { 
                const newId = getNextBeneficiaryId();
                beneficiaries.push({ id: newId, name, account, meter, section, rank, type: currentMode });
                
                if (currentMode === 'transport' || currentMode === 'training') {
                     let targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                     targetArray.push({ beneficiaryId: newId, netPayable: amount });
                }
                
                SoundSystem.add();
                showToast('تم إضافة المستفيد بنجاح', 'success');
            }

            saveData();
            renderCompensationGrid();
            updateCreditDisplay();
            cancelBeneficiaryEdit();
        }

        function deleteBeneficiary(id) {
            const beneficiary = beneficiaries.find(b => b.id === id);
            if (confirm(`هل أنت متأكد من حذف المستفيد "${beneficiary.name}" وكل تعويضاته؟`)) {
                // حذف المستفيد
                const deletedIndex = beneficiaries.findIndex(b => b.id === id);
                beneficiaries.splice(deletedIndex, 1);
                
                // حذف التعويضات المرتبطة
                compensations = compensations.filter(c => c.beneficiaryId !== id);
                compensationsEquipment = compensationsEquipment.filter(c => c.beneficiaryId !== id);
                compensationsTransport = compensationsTransport.filter(c => c.beneficiaryId !== id);
                compensationsTraining = compensationsTraining.filter(c => c.beneficiaryId !== id);
                
                // إعادة ترقيم المستفيدين بشكل صحيح
                beneficiaries.sort((a, b) => a.id - b.id);
                beneficiaries.forEach((b, index) => {
                    const oldId = b.id;
                    const newId = index + 1;
                    
                    if (oldId !== newId) {
                        // تحديث معرفات جميع التعويضات
                        compensations.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        compensationsEquipment.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        compensationsTransport.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        compensationsTraining.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        
                        b.id = newId;
                    }
                });

                saveData();
                renderCompensationGrid();
                updateCreditDisplay();
                SoundSystem.delete();
                alert('تم حذف المستفيد بنجاح وتحديث الترقيم.');
            }
        }
        
        // --- Compensation Grid ---
        // دالة مساعدة للتقريب إلى رقمين بعد الفاصلة
        function roundToTwo(num) {
            return Math.round((parseFloat(num) || 0) * 100) / 100;
        }
        
        function calculateQuarterlyComp(nofees, value, contrib) {
            const nofeesVal = roundToTwo(nofees);
            const valueVal = roundToTwo(value);
            const contribVal = roundToTwo(contrib);
            const comp = roundToTwo(((nofeesVal + valueVal) - contribVal) * 0.5);
            return comp > 0 ? comp : 0;
        }

        function renderCompensationGrid(searchTerm = '') {
            const tableHead = document.querySelector('#compensation-grid-table thead tr');
            const tableBody = document.querySelector('#compensation-grid-table tbody');
            tableBody.innerHTML = '';

            // Update Headers based on mode
            if (currentMode === 'electricity') {
                tableHead.innerHTML = `
                    <th>#</th>
                    <th>اللقب و الاسم</th>
                    <th>تعويض ث 1</th>
                    <th>تعويض ث 2</th>
                    <th>تعويض ث 3</th>
                    <th>تعويض ث 4</th>
                    <th>المجموع</th>
                    <th>الخصم</th>
                    <th>الصافي للدفع</th>
                    <th class="status-column">الحالة</th>
                `;
            } else if (currentMode === 'equipment') {
                tableHead.innerHTML = `
                    <th>#</th>
                    <th>اللقب و الاسم</th>
                    <th>القسم</th>
                    <th>الصافي للدفع</th>
                    <th class="status-column">الحالة</th>
                `;
            } else if (currentMode === 'transport' || currentMode === 'training') {
                tableHead.innerHTML = `
                    <th>#</th>
                    <th>اللقب و الاسم</th>
                    <th>الرتبة</th>
                    <th>مبلغ التعويض</th>
                    <th class="status-column">الحالة</th>
                `;
            }

            const filtered = beneficiaries.filter(b =>
                (b.type === currentMode || (!b.type && currentMode === 'electricity')) &&
                (searchTerm === '' ||
                b.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                b.account.includes(searchTerm))
            );

            filtered.sort((a,b) => a.id - b.id).forEach((b, index) => {
                const row = document.createElement('tr');
                row.dataset.beneficiaryId = b.id;
                const rowNumber = index + 1; // ترقيم متسلسل لكل نوع تعويض

                if (currentMode === 'electricity') {
                    const compData = compensations.find(c => c.beneficiaryId === b.id) || {
                        q1: { calculated: 0 }, q2: { calculated: 0 }, q3: { calculated: 0 }, q4: { calculated: 0 },
                        discount: 0, netPayable: 0
                    };
                    const totalComp = compData.q1.calculated + compData.q2.calculated + compData.q3.calculated + compData.q4.calculated;
                    const netPayable = totalComp - compData.discount;
                    const hasData = compensations.some(c => c.beneficiaryId === b.id);

                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td class="beneficiary-name-cell">
                            <span>${b.name}</span>
                            <div class="beneficiary-actions">
                                 <button class="edit-btn-inline" title="تعديل"><i class="fas fa-edit"></i></button>
                                 <button class="delete-btn-inline" title="حذف"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                        <td class="editable-cell" data-quarter="1" data-nofees="${compData.q1.nofees || 0}" data-value="${compData.q1.value || 0}" data-contrib="${compData.q1.contrib || 0}">${formatCurrency(compData.q1.calculated)}</td>
                        <td class="editable-cell" data-quarter="2" data-nofees="${compData.q2.nofees || 0}" data-value="${compData.q2.value || 0}" data-contrib="${compData.q2.contrib || 0}">${formatCurrency(compData.q2.calculated)}</td>
                        <td class="editable-cell" data-quarter="3" data-nofees="${compData.q3.nofees || 0}" data-value="${compData.q3.value || 0}" data-contrib="${compData.q3.contrib || 0}">${formatCurrency(compData.q3.calculated)}</td>
                        <td class="editable-cell" data-quarter="4" data-nofees="${compData.q4.nofees || 0}" data-value="${compData.q4.value || 0}" data-contrib="${compData.q4.contrib || 0}">${formatCurrency(compData.q4.calculated)}</td>
                        <td class="calculated-cell total-comp-cell">${formatCurrency(totalComp)}</td>
                        <td><input type="number" class="grid-input discount-input" value="${compData.discount.toFixed(2)}" step="0.01"></td>
                        <td class="calculated-cell net-payable-cell">${formatCurrency(netPayable)}</td>
                        <td class="status-column"><span class="status-badge ${hasData ? 'saved' : 'empty'}">${hasData ? 'محفوظ' : 'فارغ'}</span></td>
                    `;
                } else if (currentMode === 'equipment') {
                    // Equipment Mode
                    const compData = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const hasData = !!compData;
                    // Default to global value if not saved, otherwise use saved value
                    const netPayable = hasData ? compData.netPayable : institutionInfo.equipmentGrantValue;

                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td class="beneficiary-name-cell">
                            <span>${b.name}</span>
                            <div class="beneficiary-actions">
                                 <button class="edit-btn-inline" title="تعديل"><i class="fas fa-edit"></i></button>
                                 <button class="delete-btn-inline" title="حذف"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                        <td>${b.section || ''}</td>
                        <td class="calculated-cell net-payable-cell">${formatCurrency(netPayable)}</td>
                        <td class="status-column">
                            <button class="save-equipment-btn" style="background:none; border:none; cursor:pointer;">
                                <span class="status-badge ${hasData ? 'saved' : 'unsaved'}">${hasData ? 'محفوظ' : 'حفظ'}</span>
                            </button>
                        </td>
                    `;
                } else {
                    // Transport & Training Mode
                    let compData;
                    if (currentMode === 'transport') compData = compensationsTransport.find(c => c.beneficiaryId === b.id);
                    else compData = compensationsTraining.find(c => c.beneficiaryId === b.id);
                    
                    const hasData = !!compData;
                    const netPayable = hasData ? compData.netPayable : 0;

                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td class="beneficiary-name-cell">
                            <span>${b.name}</span>
                            <div class="beneficiary-actions">
                                 <button class="edit-btn-inline" title="تعديل"><i class="fas fa-edit"></i></button>
                                 <button class="delete-btn-inline" title="حذف"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                        <td>${b.rank || ''}</td>
                        <td><input type="number" class="grid-input manual-amount-input" value="${netPayable.toFixed(2)}" step="0.01"></td>
                        <td class="status-column">
                            <button class="save-manual-btn" style="background:none; border:none; cursor:pointer;">
                                <span class="status-badge ${hasData ? 'saved' : 'unsaved'}">${hasData ? 'محفوظ' : 'حفظ'}</span>
                            </button>
                        </td>
                    `;
                }
                tableBody.appendChild(row);
            });
        }
        
        function openQuarterlyModal(beneficiaryId, quarterIndex) {
            if (currentMode !== 'electricity') return;
            const beneficiary = beneficiaries.find(b => b.id === beneficiaryId);
            if (!beneficiary) return;

            const modal = document.getElementById('quarterly-details-modal');
            const compData = compensations.find(c => c.beneficiaryId === beneficiaryId);

            document.getElementById('quarterly-modal-title').textContent = `تفاصيل الثلاثي ${quarterIndex} لـ: ${beneficiary.name}`;
            document.getElementById('quarterly-beneficiary-id').value = beneficiaryId;
            document.getElementById('quarterly-quarter-index').value = quarterIndex;
            
            const qData = compData ? compData[`q${quarterIndex}`] : { nofees: 0, value: 0, contrib: 0 };
            document.getElementById('quarterly-nofees').value = (qData.nofees || 0).toFixed(2);
            document.getElementById('quarterly-value').value = (qData.value || 0).toFixed(2);
            document.getElementById('quarterly-contrib').value = (qData.contrib || 0).toFixed(2);

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function closeQuarterlyModal() {
            const modal = document.getElementById('quarterly-details-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // ============================================
        // نظام الأصوات - Sound System
        // ============================================
        const SoundSystem = {
            audioContext: null,
            enabled: true,
            volume: 0.3,
            
            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // Load saved preference
                    const savedPref = localStorage.getItem('soundEnabled');
                    this.enabled = savedPref !== 'false';
                } catch (e) {
                    console.log('Web Audio API not supported');
                    this.enabled = false;
                }
            },
            
            resume() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            },
            
            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('soundEnabled', this.enabled);
                return this.enabled;
            },
            
            playTone(frequency, duration, type = 'sine', volumeMultiplier = 1) {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                const vol = this.volume * volumeMultiplier;
                gainNode.gain.setValueAtTime(vol, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            },
            
            // صوت النجاح - نغمة صاعدة مبهجة
            success() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.15, 'sine', 0.8), i * 80);
                });
            },
            
            // صوت الخطأ - نغمة منخفضة متكررة
            error() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(200, 0.15, 'square', 0.5);
                setTimeout(() => this.playTone(180, 0.2, 'square', 0.5), 150);
            },
            
            // صوت التحذير - نغمتان متناوبتان
            warning() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(440, 0.1, 'triangle', 0.6);
                setTimeout(() => this.playTone(380, 0.1, 'triangle', 0.6), 120);
                setTimeout(() => this.playTone(440, 0.15, 'triangle', 0.6), 240);
            },
            
            // صوت المعلومات - نغمة خفيفة
            info() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(600, 0.1, 'sine', 0.4);
            },
            
            // صوت الحفظ - نغمة تأكيد
            save() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(880, 0.08, 'sine', 0.5);
                setTimeout(() => this.playTone(1100, 0.12, 'sine', 0.5), 80);
            },
            
            // صوت الحذف - نغمة هابطة
            delete() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(400, 0.1, 'sawtooth', 0.3);
                setTimeout(() => this.playTone(300, 0.15, 'sawtooth', 0.3), 100);
            },
            
            // صوت تجاوز الاعتماد - إنذار
            creditAlert() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        this.playTone(800, 0.1, 'square', 0.4);
                        setTimeout(() => this.playTone(600, 0.1, 'square', 0.4), 100);
                    }, i * 250);
                }
            },
            
            // صوت الإضافة - نغمة إيجابية
            add() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(523.25, 0.08, 'sine', 0.5);
                setTimeout(() => this.playTone(698.46, 0.1, 'sine', 0.5), 70);
            },
            
            // صوت النقر/التفاعل
            click() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(1000, 0.03, 'sine', 0.2);
            },
            
            // صوت التصدير
            export() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                const notes = [392, 523.25, 659.25, 783.99]; // G4, C5, E5, G5
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.12, 'sine', 0.5), i * 60);
                });
            },
            
            // صوت الاستيراد
            import() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(440, 0.1, 'sine', 0.5);
                setTimeout(() => this.playTone(554.37, 0.1, 'sine', 0.5), 100);
                setTimeout(() => this.playTone(659.25, 0.15, 'sine', 0.5), 200);
            }
        };
        
        // تهيئة نظام الأصوات
        SoundSystem.init();
        
        // تفعيل الصوت عند أول تفاعل من المستخدم
        document.addEventListener('click', () => SoundSystem.resume(), { once: true });

        function showToast(message, type = 'info') {
            // تشغيل الصوت المناسب
            switch(type) {
                case 'success':
                    SoundSystem.success();
                    break;
                case 'error':
                    SoundSystem.error();
                    break;
                case 'warning':
                    SoundSystem.warning();
                    break;
                default:
                    SoundSystem.info();
            }
            
            // Create a simple toast notification
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add toast animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        function handleQuarterlyFormSubmit(event) {
            event.preventDefault();
            const beneficiaryId = parseInt(document.getElementById('quarterly-beneficiary-id').value);
            const quarterIndex = parseInt(document.getElementById('quarterly-quarter-index').value);
            
            const nofees = parseFloat(document.getElementById('quarterly-nofees').value) || 0;
            const value = parseFloat(document.getElementById('quarterly-value').value) || 0;
            const contrib = parseFloat(document.getElementById('quarterly-contrib').value) || 0;

            const calculated = calculateQuarterlyComp(nofees, value, contrib);

            // تحديث أو إنشاء بيانات التعويض
            let compData = compensations.find(c => c.beneficiaryId === beneficiaryId);
            if (!compData) {
                compData = { 
                    beneficiaryId, 
                    q1: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    q2: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    q3: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    q4: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    discount: 0, 
                    netPayable: 0 
                };
                compensations.push(compData);
            }

            // حفظ البيانات في الكائن مباشرة مع التقريب
            compData[`q${quarterIndex}`] = {
                nofees: roundToTwo(nofees),
                value: roundToTwo(value),
                contrib: roundToTwo(contrib),
                calculated: roundToTwo(calculated)
            };

            // إعادة حساب المجموع من جميع الثلاثيات
            let totalComp = 0;
            for (let i = 1; i <= 4; i++) {
                totalComp = roundToTwo(totalComp + (compData[`q${i}`]?.calculated || 0));
            }
            
            // تحديث الخصم والصافي
            const targetRow = document.querySelector(`#compensation-grid-table tbody tr[data-beneficiary-id='${beneficiaryId}']`);
            if (targetRow) {
                const discountInput = targetRow.querySelector('.discount-input');
                const discount = roundToTwo(parseFloat(discountInput.value) || 0);
                compData.discount = discount;
                compData.netPayable = roundToTwo(totalComp - discount);
                
                // تحديث جميع خلايا الثلاثيات في الجدول مع حفظ البيانات الكاملة
                for (let i = 1; i <= 4; i++) {
                    const cell = targetRow.querySelector(`td[data-quarter='${i}']`);
                    if (cell) {
                        const qData = compData[`q${i}`] || {nofees: 0, value: 0, contrib: 0, calculated: 0};
                        cell.textContent = formatCurrency(qData.calculated);
                        cell.setAttribute('data-nofees', qData.nofees);
                        cell.setAttribute('data-value', qData.value);
                        cell.setAttribute('data-contrib', qData.contrib);
                    }
                }
                
                // تحديث المجموع والصافي
                targetRow.querySelector('.total-comp-cell').textContent = formatCurrency(totalComp);
                targetRow.querySelector('.net-payable-cell').textContent = formatCurrency(compData.netPayable);
                
                // تحديث حالة الحفظ
                targetRow.classList.remove('is-dirty');
                const statusBadge = targetRow.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge saved';
                    statusBadge.textContent = 'محفوظ';
                }
            }
            
            // حفظ جميع البيانات باستخدام saveData
            saveData();
            
            // تحديث عرض الرصيد
            updateCreditDisplay();
            
            // إغلاق النافذة
            closeQuarterlyModal();
        }

        function processAndSaveRow(rowElement) {
            const beneficiaryId = parseInt(rowElement.dataset.beneficiaryId);

            if (currentMode === 'electricity') {
                let totalComp = 0;
                for (let i = 1; i <= 4; i++) {
                    const cell = rowElement.querySelector(`td[data-quarter='${i}']`);
                    totalComp = roundToTwo(totalComp + parseCurrency(cell.textContent));
                }

                const discountInput = rowElement.querySelector('.discount-input');
                let discount = roundToTwo(parseFloat(discountInput.value) || 0);
                if (isNaN(discount) || discount < 0) discount = 0;
                discountInput.value = discount.toFixed(2);

                const netPayable = roundToTwo(totalComp - discount);
                rowElement.querySelector('.total-comp-cell').textContent = formatCurrency(totalComp);
                rowElement.querySelector('.net-payable-cell').textContent = formatCurrency(netPayable);

                let compData = compensations.find(c => c.beneficiaryId === beneficiaryId);
                if (!compData) {
                    compData = { 
                        beneficiaryId, 
                        q1: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        q2: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        q3: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        q4: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        discount: 0, 
                        netPayable: 0 
                    };
                    compensations.push(compData);
                }

                for(let i=1; i<=4; i++) {
                    const cell = rowElement.querySelector(`td[data-quarter='${i}']`);
                    let nofees = roundToTwo(parseFloat(cell.getAttribute('data-nofees')) || 0);
                    let value = roundToTwo(parseFloat(cell.getAttribute('data-value')) || 0);
                    let contrib = roundToTwo(parseFloat(cell.getAttribute('data-contrib')) || 0);
                    let calculated = calculateQuarterlyComp(nofees, value, contrib);

                    compData[`q${i}`] = {
                        nofees: nofees,
                        value: value,
                        contrib: contrib,
                        calculated: calculated
                    };
                }
                
                compData.discount = discount;
                compData.netPayable = netPayable;

                rowElement.classList.remove('is-dirty');
                const statusBadge = rowElement.querySelector('.status-badge');
                statusBadge.className = 'status-badge saved';
                statusBadge.textContent = 'محفوظ';

            } else if (currentMode === 'equipment') {
                const grantValue = roundToTwo(parseFloat(institutionInfo.equipmentGrantValue) || 0);
                
                let compData = compensationsEquipment.find(c => c.beneficiaryId === beneficiaryId);
                if (!compData) {
                    compData = { beneficiaryId, netPayable: grantValue };
                    compensationsEquipment.push(compData);
                } else {
                    compData.netPayable = grantValue;
                }
                
                rowElement.querySelector('.net-payable-cell').textContent = formatCurrency(grantValue);
                const statusBadge = rowElement.querySelector('.status-badge');
                statusBadge.className = 'status-badge saved';
                statusBadge.textContent = 'محفوظ';
            } else {
                const amountInput = rowElement.querySelector('.manual-amount-input');
                let amount = roundToTwo(parseFloat(amountInput.value) || 0);
                if (isNaN(amount) || amount < 0) amount = 0;
                amountInput.value = amount.toFixed(2);
                
                let targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                let compData = targetArray.find(c => c.beneficiaryId === beneficiaryId);
                
                if (!compData) {
                    compData = { beneficiaryId, netPayable: amount };
                    targetArray.push(compData);
                } else {
                    compData.netPayable = amount;
                }
                
                const statusBadge = rowElement.querySelector('.status-badge');
                statusBadge.className = 'status-badge saved';
                statusBadge.textContent = 'محفوظ';
            }

            saveData();
            updateCreditDisplay();
        }

        // --- Reporting & Export ---
        function generateReportHTML(forPrint = false) {
            let reportData = [];
            let totalNetPayable = 0;
            let totalSum = 0;
            let totalDiscount = 0;

            // Reset numbering for each mode (Separation requested)
            let startCounter = 1;

            if (currentMode === 'electricity') {
                reportData = compensations.map(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    return (b && (b.type === 'electricity' || !b.type)) ? { ...comp, name: b.name, meter: b.meter, rip: calculateRIP(b.account), id: b.id } : null;
                }).filter(Boolean).sort((a,b) => a.id - b.id);
                
                totalNetPayable = roundToTwo(reportData.reduce((sum, item) => sum + (item.netPayable || 0), 0));
                totalSum = roundToTwo(reportData.reduce((sum, item) => sum + ((item.q1.calculated || 0) + (item.q2.calculated || 0) + (item.q3.calculated || 0) + (item.q4.calculated || 0)), 0));
                totalDiscount = roundToTwo(reportData.reduce((sum, item) => sum + (item.discount || 0), 0));
            } else if (currentMode === 'equipment') {
                reportData = beneficiaries.filter(b => b.type === 'equipment').map(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? roundToTwo(comp.netPayable) : roundToTwo(institutionInfo.equipmentGrantValue);
                    return { 
                        id: b.id, 
                        name: b.name, 
                        section: b.section || '', 
                        rip: calculateRIP(b.account), 
                        netPayable: netPayable 
                    };
                }).sort((a,b) => a.id - b.id);
                
                totalNetPayable = roundToTwo(reportData.reduce((sum, item) => sum + (item.netPayable || 0), 0));
            } else {
                // Transport & Training
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                reportData = beneficiaries.filter(b => b.type === currentMode).map(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? roundToTwo(comp.netPayable) : 0;
                    return { 
                        id: b.id, 
                        name: b.name, 
                        rank: b.rank || '', 
                        rip: calculateRIP(b.account), 
                        netPayable: netPayable 
                    };
                }).sort((a,b) => a.id - b.id);
                
                totalNetPayable = roundToTwo(reportData.reduce((sum, item) => sum + (item.netPayable || 0), 0));
            }
            
            let tableContent = '';
            if (currentMode === 'electricity') {
                tableContent = `
                <table><thead><tr>
                    <th>الرقم</th><th>اسم المستفيد</th><th>رقم العداد</th><th>رقم RIP الكامل</th>
                    <th>تعويض ث 1</th><th>تعويض ث 2</th><th>تعويض ث 3</th><th>تعويض ث 4</th>
                    <th>المجموع</th><th>الخصم</th><th>الصافي للدفع</th>
                </tr></thead><tbody>
                    ${reportData.map((item, index) => {
                        const totalBeforeDiscount = item.q1.calculated + item.q2.calculated + item.q3.calculated + item.q4.calculated;
                        return `
                        <tr>
                            <td>${startCounter + index}</td><td>${item.name}</td><td>${item.meter}</td><td>${item.rip}</td>
                            <td>${formatCurrency(item.q1.calculated)}</td><td>${formatCurrency(item.q2.calculated)}</td>
                            <td>${formatCurrency(item.q3.calculated)}</td><td>${formatCurrency(item.q4.calculated)}</td>
                            <td>${formatCurrency(totalBeforeDiscount)}</td>
                            <td>${formatCurrency(item.discount)}</td><td>${formatCurrency(item.netPayable)}</td>
                        </tr>`;
                    }).join('')}
                    <tr class="total-row">
                        <td colspan="8">المجموع</td>
                        <td>${formatCurrency(totalSum)}</td>
                        <td>${formatCurrency(totalDiscount)}</td>
                        <td>${formatCurrency(totalNetPayable)}</td>
                    </tr>
                </tbody></table>`;
            } else if (currentMode === 'equipment') {
                tableContent = `
                <table><thead><tr>
                    <th>الرقم</th><th>اسم المستفيد</th><th>القسم</th><th>رقم RIP الكامل</th><th>الصافي للدفع</th>
                </tr></thead><tbody>
                    ${reportData.map((item, index) => `
                        <tr>
                            <td>${startCounter + index}</td><td>${item.name}</td><td>${item.section || ''}</td><td>${item.rip}</td>
                            <td>${formatCurrency(item.netPayable)}</td>
                        </tr>`).join('')}
                    <tr class="total-row">
                        <td colspan="4">المجموع</td>
                        <td>${formatCurrency(totalNetPayable)}</td>
                    </tr>
                </tbody></table>`;
            } else {
                tableContent = `
                <table><thead><tr>
                    <th>الرقم</th><th>اسم المستفيد</th><th>الرتبة</th><th>رقم RIP الكامل</th><th>الصافي للدفع</th>
                </tr></thead><tbody>
                    ${reportData.map((item, index) => `
                        <tr>
                            <td>${startCounter + index}</td><td>${item.name}</td><td>${item.rank || ''}</td><td>${item.rip}</td>
                            <td>${formatCurrency(item.netPayable)}</td>
                        </tr>`).join('')}
                    <tr class="total-row">
                        <td colspan="4">المجموع</td>
                        <td>${formatCurrency(totalNetPayable)}</td>
                    </tr>
                </tbody></table>`;
            }

            let title = '';
            if (currentMode === 'electricity') title = 'الجدول التفصيلي للمستفيدين من تعويض استهلاك الكهرباء و الغاز';
            else if (currentMode === 'equipment') title = 'الجدول التفصيلي للمستفيدين من منحة التجهيز';
            else if (currentMode === 'transport') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف التنقل';
            else if (currentMode === 'training') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف العمليات التكوينية';

            return `
                <div class="report-header" style="text-align: center; margin-bottom: 10px;">
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.republic}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.ministry}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.directorate}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.institution}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">السنة المالية: ${institutionInfo.fiscalYear}</p>
                    <h3 style="margin-top: 10px; margin-bottom: 10px; font-weight: bold; font-family: 'Aref Ruqaa', serif; font-size: 20pt; text-decoration: underline;">${title}</h3>
                </div>
                ${tableContent}
                <div class="report-footer" style="text-align: right; margin-top: 10px;">
                    <p style="margin: 3px 0;">أوقف الجدول على مجموع مستفيدين قدره: ${reportData.length}</p>
                    <p style="margin: 3px 0;">أوقف الجدول على مجموع كلي بالأرقام: ${formatCurrency(totalNetPayable)} دج</p>
                    <p style="margin: 3px 0;">أوقف الجدول على مجموع كلي بالأحرف: ${numberToArabicText(totalNetPayable)}</p>
                    ${forPrint ? `<div style="display: flex; justify-content: space-around; margin-top: 15px;"><p style="font-family: 'Aref Ruqaa', serif; font-weight: bold; font-size: 16pt;">المدير</p><p style="font-family: 'Aref Ruqaa', serif; font-weight: bold; font-size: 16pt;">المسير المالي</p></div>` : ''}
                </div>`;
        }

        function generateReportPreview() {
            document.getElementById('report-preview').innerHTML = generateReportHTML(false);
        }

        function printReport() {
            const printContent = document.getElementById('print-report-content');
            if (!printContent) {
                showToast('خطأ: عنصر الطباعة غير موجود', 'error');
                return;
            }
            
            const reportHTML = generateReportHTML(true);
            if (!reportHTML) {
                showToast('خطأ في توليد التقرير', 'error');
                return;
            }
            
            printContent.innerHTML = reportHTML;
            
            // Trigger print with a small delay to ensure content is rendered
            setTimeout(() => {
                window.print();
                showToast('تم فتح نافذة الطباعة', 'success');
            }, 100);
        }

        function exportXLSX() {
            let reportData = [];
            let startCounter = 1;

            if (currentMode === 'electricity') {
                reportData = compensations.map(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    if (!b || (b.type && b.type !== 'electricity')) return null;
                    return {
                        id: b.id, name: b.name, meter: b.meter, rip: calculateRIP(b.account),
                        q1: Math.round(comp.q1.calculated * 100) / 100, 
                        q2: Math.round(comp.q2.calculated * 100) / 100, 
                        q3: Math.round(comp.q3.calculated * 100) / 100, 
                        q4: Math.round(comp.q4.calculated * 100) / 100,
                        discount: Math.round(comp.discount * 100) / 100, 
                        netPayable: Math.round(comp.netPayable * 100) / 100
                    };
                }).filter(Boolean).sort((a, b) => a.id - b.id);
            } else if (currentMode === 'equipment') {
                reportData = beneficiaries.filter(b => b.type === 'equipment').map(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                    return {
                        id: b.id, name: b.name, section: b.section || '', rip: calculateRIP(b.account),
                        netPayable: Math.round(netPayable * 100) / 100
                    };
                }).sort((a, b) => a.id - b.id);
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                reportData = beneficiaries.filter(b => b.type === currentMode).map(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : 0;
                    return {
                        id: b.id, name: b.name, rank: b.rank || '', rip: calculateRIP(b.account),
                        netPayable: Math.round(netPayable * 100) / 100
                    };
                }).sort((a, b) => a.id - b.id);
            }

            if (reportData.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'error');
                return;
            }

            // استخدام ExcelJS لإنشاء ملف Excel منسق
            const workbook = new ExcelJS.Workbook();
            workbook.views = [{ rightToLeft: true }];
            const worksheet = workbook.addWorksheet('تقرير التعويضات', { views: [{ rightToLeft: true }] });

            // تحديد عدد الأعمدة حسب النوع
            let numCols = currentMode === 'electricity' ? 11 : 5;
            
            let title = '';
            if (currentMode === 'electricity') title = 'الجدول التفصيلي للمستفيدين من تعويض استهلاك الكهرباء و الغاز';
            else if (currentMode === 'equipment') title = 'الجدول التفصيلي للمستفيدين من منحة التجهيز';
            else if (currentMode === 'transport') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف التنقل';
            else if (currentMode === 'training') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف العمليات التكوينية';

            const modeDetails = institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode] ? institutionInfo.modeDetails[currentMode] : {};

            // تعريف نمط الحدود
            const thinBorder = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };

            // تعريف المحاذاة المركزية
            const centerAlign = { horizontal: 'center', vertical: 'middle', wrapText: true };
            
            // تعريف المحاذاة لليمين
            const rightAlign = { horizontal: 'right', vertical: 'middle', wrapText: true };

            // تحديد عرض الأعمدة
            if (currentMode === 'electricity') {
                worksheet.columns = [
                    { width: 8 },   // الرقم
                    { width: 28 },  // اسم المستفيد
                    { width: 14 },  // رقم العداد
                    { width: 24 },  // رقم RIP
                    { width: 12 },  // ث1
                    { width: 12 },  // ث2
                    { width: 12 },  // ث3
                    { width: 12 },  // ث4
                    { width: 14 },  // المجموع
                    { width: 12 },  // الخصم
                    { width: 16 }   // الصافي
                ];
            } else {
                worksheet.columns = [
                    { width: 8 },   // الرقم
                    { width: 32 },  // اسم المستفيد
                    { width: 20 },  // القسم/الرتبة
                    { width: 24 },  // رقم RIP
                    { width: 18 }   // الصافي
                ];
            }

            // دالة لإضافة صف مدمج بدون حدود (للعناوين)
            function addMergedRowNoBorder(text, rowNum, isBold = false, fontSize = 12) {
                const row = worksheet.addRow([text]);
                worksheet.mergeCells(rowNum, 1, rowNum, numCols);
                const cell = row.getCell(1);
                cell.alignment = centerAlign;
                cell.font = { bold: isBold, size: fontSize, name: 'Arial' };
                return row;
            }

            // صف 1: الجمهورية
            addMergedRowNoBorder(institutionInfo.republic, 1, true, 14);
            
            // صف 2: الوزارة
            addMergedRowNoBorder(institutionInfo.ministry, 2, false, 12);
            
            // صف 3: المديرية
            addMergedRowNoBorder(institutionInfo.directorate, 3, false, 12);
            
            // صف 4: المؤسسة
            addMergedRowNoBorder(institutionInfo.institution, 4, false, 12);
            
            // صف 5: فارغ
            const emptyRow1 = worksheet.addRow([]);
            worksheet.mergeCells(5, 1, 5, numCols);
            
            // صف 6: عنوان التقرير
            addMergedRowNoBorder(title, 6, true, 14);
            
            // صف 7: السنة والشهر المالي
            addMergedRowNoBorder(`السنة المالية: ${institutionInfo.fiscalYear} - الشهر: ${modeDetails.month || '...'}`, 7, false, 11);
            
            // صف 8: رقم الأمر بالصرف والحوالة
            addMergedRowNoBorder(`رقم الأمر بالصرف: ${modeDetails.order || '...'} - رقم الحوالة: ${modeDetails.transfer || '...'}`, 8, false, 11);
            
            // صف 9: فارغ
            const emptyRow2 = worksheet.addRow([]);
            worksheet.mergeCells(9, 1, 9, numCols);

            // صف 10: عناوين الجدول
            let headerRowData = [];
            if (currentMode === 'electricity') {
                headerRowData = ["الرقم", "اسم المستفيد", "رقم العداد", "رقم RIP الكامل", "تعويض ث 1", "تعويض ث 2", "تعويض ث 3", "تعويض ث 4", "المجموع", "الخصم", "الصافي للدفع"];
            } else if (currentMode === 'equipment') {
                headerRowData = ["الرقم", "اسم المستفيد", "القسم", "رقم RIP الكامل", "الصافي للدفع"];
            } else {
                headerRowData = ["الرقم", "اسم المستفيد", "الرتبة", "رقم RIP الكامل", "الصافي للدفع"];
            }
            
            const headerRow = worksheet.addRow(headerRowData);
            headerRow.eachCell((cell) => {
                cell.font = { bold: true, size: 11, name: 'Arial' };
                cell.alignment = centerAlign;
                cell.border = thinBorder;
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEEEEEE' } };
            });

            let totalNetPayable = 0;

            // إضافة بيانات المستفيدين
            if (currentMode === 'electricity') {
                reportData.forEach((item, index) => {
                    const totalBeforeDiscount = Math.round((item.q1 + item.q2 + item.q3 + item.q4) * 100) / 100;
                    const dataRow = worksheet.addRow([
                        startCounter + index, item.name, item.meter, item.rip,
                        item.q1, item.q2, item.q3, item.q4,
                        totalBeforeDiscount, item.discount, item.netPayable
                    ]);
                    dataRow.eachCell((cell) => {
                        cell.alignment = centerAlign;
                        cell.border = thinBorder;
                        cell.font = { size: 10, name: 'Arial' };
                    });
                    totalNetPayable += item.netPayable;
                });
                
                // صف المجموع
                const totalQ1 = Math.round(reportData.reduce((sum, item) => sum + item.q1, 0) * 100) / 100;
                const totalQ2 = Math.round(reportData.reduce((sum, item) => sum + item.q2, 0) * 100) / 100;
                const totalQ3 = Math.round(reportData.reduce((sum, item) => sum + item.q3, 0) * 100) / 100;
                const totalQ4 = Math.round(reportData.reduce((sum, item) => sum + item.q4, 0) * 100) / 100;
                const totalSum = Math.round((totalQ1 + totalQ2 + totalQ3 + totalQ4) * 100) / 100;
                const totalDiscount = Math.round(reportData.reduce((sum, item) => sum + item.discount, 0) * 100) / 100;
                
                const totalRow = worksheet.addRow(["المجموع", "", "", "", totalQ1, totalQ2, totalQ3, totalQ4, totalSum, totalDiscount, Math.round(totalNetPayable * 100) / 100]);
                const totalRowNum = worksheet.rowCount;
                worksheet.mergeCells(totalRowNum, 1, totalRowNum, 4);
                totalRow.eachCell((cell) => {
                    cell.font = { bold: true, size: 11, name: 'Arial' };
                    cell.alignment = centerAlign;
                    cell.border = thinBorder;
                });
            } else {
                reportData.forEach((item, index) => {
                    const thirdCol = currentMode === 'equipment' ? item.section : item.rank;
                    const dataRow = worksheet.addRow([startCounter + index, item.name, thirdCol, item.rip, item.netPayable]);
                    dataRow.eachCell((cell) => {
                        cell.alignment = centerAlign;
                        cell.border = thinBorder;
                        cell.font = { size: 10, name: 'Arial' };
                    });
                    totalNetPayable += item.netPayable;
                });
                
                // صف المجموع
                const totalRow = worksheet.addRow(["المجموع", "", "", "", Math.round(totalNetPayable * 100) / 100]);
                const totalRowNum = worksheet.rowCount;
                worksheet.mergeCells(totalRowNum, 1, totalRowNum, 4);
                totalRow.eachCell((cell) => {
                    cell.font = { bold: true, size: 11, name: 'Arial' };
                    cell.alignment = centerAlign;
                    cell.border = thinBorder;
                });
            }

            // صف فارغ
            worksheet.addRow([]);
            
            // صف: عدد المستفيدين
            const summaryRowNum1 = worksheet.rowCount + 1;
            addMergedRowNoBorder(`أوقف الجدول على مجموع مستفيدين قدره: ${reportData.length}`, summaryRowNum1, false, 11);
            
            // صف: المجموع بالأرقام
            const summaryRowNum2 = worksheet.rowCount + 1;
            addMergedRowNoBorder(`أوقف الجدول على مجموع كلي بالأرقام: ${formatCurrency(totalNetPayable)} دج`, summaryRowNum2, false, 11);
            
            // صف: المجموع بالأحرف
            const summaryRowNum3 = worksheet.rowCount + 1;
            addMergedRowNoBorder(`أوقف الجدول على مجموع كلي بالأحرف: ${numberToArabicText(totalNetPayable)}`, summaryRowNum3, false, 11);
            
            // صف فارغ
            worksheet.addRow([]);
            
            // صف التوقيعات (محاذاة لليمين وبدون حدود)
            const sigRowNum = worksheet.rowCount + 1;
            if (currentMode === 'electricity') {
                const sigRow = worksheet.addRow(["المقتصد", "", "", "", "", "المدير", "", "", "", "", ""]);
                worksheet.mergeCells(sigRowNum, 1, sigRowNum, 5);
                worksheet.mergeCells(sigRowNum, 6, sigRowNum, 11);
                sigRow.getCell(1).alignment = rightAlign;
                sigRow.getCell(1).font = { bold: true, size: 12, name: 'Arial' };
                sigRow.getCell(6).alignment = rightAlign;
                sigRow.getCell(6).font = { bold: true, size: 12, name: 'Arial' };
            } else {
                const sigRow = worksheet.addRow(["المقتصد", "", "المدير", "", ""]);
                worksheet.mergeCells(sigRowNum, 1, sigRowNum, 2);
                worksheet.mergeCells(sigRowNum, 3, sigRowNum, 5);
                sigRow.getCell(1).alignment = rightAlign;
                sigRow.getCell(1).font = { bold: true, size: 12, name: 'Arial' };
                sigRow.getCell(3).alignment = rightAlign;
                sigRow.getCell(3).font = { bold: true, size: 12, name: 'Arial' };
            }
            
            // تصدير الملف
            const filename = `تقرير_${currentMode}_${institutionInfo.fiscalYear || 'YYYY'}_${new Date().toLocaleDateString('ar-SA')}.xlsx`;
            
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
                SoundSystem.export();
                showToast(`تم تصدير الملف: ${filename}`, 'success');
            }).catch(err => {
                console.error('خطأ في تصدير Excel:', err);
                showToast('حدث خطأ أثناء تصدير الملف', 'error');
            });
        }

        function exportTxt() {
            let validRecords = [];
            let totalRoundedNetPayable = 0;
            let invalidRecords = 0;
            
            if (currentMode === 'electricity') {
                compensations.forEach(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    if (b && (b.type === 'electricity' || !b.type)) {
                        const rip = calculateRIP(b.account);
                        if (!rip.includes('خطأ') && /^[a-zA-Z\s\-]+$/.test(b.name)) {
                            const netPayableRounded = Math.round(comp.netPayable * 100) / 100;
                            totalRoundedNetPayable += netPayableRounded;
                            const amountCents = String(Math.round(netPayableRounded * 100)).padStart(13, '0');
                            const namePadded = (b.name + ' '.repeat(27)).substring(0, 27);
                            validRecords.push(`*${rip}${amountCents}${namePadded}1`);
                        } else {
                            invalidRecords++;
                        }
                    }
                });
            } else if (currentMode === 'equipment') {
                beneficiaries.filter(b => b.type === 'equipment').forEach(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                    const rip = calculateRIP(b.account);
                    
                    if (!rip.includes('خطأ') && /^[a-zA-Z\s\-]+$/.test(b.name)) {
                        const netPayableRounded = Math.round(netPayable * 100) / 100;
                        totalRoundedNetPayable += netPayableRounded;
                        const amountCents = String(Math.round(netPayableRounded * 100)).padStart(13, '0');
                        const namePadded = (b.name + ' '.repeat(27)).substring(0, 27);
                        validRecords.push(`*${rip}${amountCents}${namePadded}1`);
                    } else {
                        invalidRecords++;
                    }
                });
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                beneficiaries.filter(b => b.type === currentMode).forEach(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : 0;
                    const rip = calculateRIP(b.account);
                    
                    if (!rip.includes('خطأ') && /^[a-zA-Z\s\-]+$/.test(b.name)) {
                        const netPayableRounded = Math.round(netPayable * 100) / 100;
                        totalRoundedNetPayable += netPayableRounded;
                        const amountCents = String(Math.round(netPayableRounded * 100)).padStart(13, '0');
                        const namePadded = (b.name + ' '.repeat(27)).substring(0, 27);
                        validRecords.push(`*${rip}${amountCents}${namePadded}1`);
                    } else {
                        invalidRecords++;
                    }
                });
            }

            if (validRecords.length === 0) {
                showToast('لا توجد سجلات صحيحة للتصدير. تحقق من بيانات المستفيدين والحسابات', 'error');
                return;
            }

            const treasuryRIP = calculateRIP(institutionInfo.treasuryAccount);
            if (treasuryRIP.includes('خطأ')) {
                showToast('خطأ: رقم الحساب البريدي للخزينة غير صحيح. يرجى تحديث معلومات المؤسسة', 'error');
                return;
            }

            const details = (institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode]) ? 
                            institutionInfo.modeDetails[currentMode] : 
                            { month: institutionInfo.financialMonth, order: institutionInfo.orderNumber, transfer: institutionInfo.transferNumber };

            const totalAmountCents = String(Math.round(totalRoundedNetPayable * 100)).padStart(13, '0');
            const recordCount = String(validRecords.length).padStart(7, '0');
            const month = String(details.month || '01').padStart(2, '0');
            const year = String(institutionInfo.fiscalYear).padStart(4, '0');
            const order = String(details.order || '0').padStart(8, '0');
            const transfer = String(details.transfer || '0').padStart(6, '0');
            const header = `*${treasuryRIP}${totalAmountCents}${recordCount}${month}${year}${order}${transfer}0`;
            
            if (header.length !== 62) {
                showToast('خطأ في توليد السطر الأول للملف. تحقق من معلومات المؤسسة كاملة', 'error');
                return;
            }

            const txtContent = [header, ...validRecords].join('\n');
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = `Payment_File_${currentMode}_${institutionInfo.fiscalYear}_${new Date().toLocaleDateString('ar-SA')}.txt`;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            SoundSystem.export();
            let message = `تم تصدير الملف: ${filename}\n${validRecords.length} سجل صحيح`;
            if (invalidRecords > 0) {
                message += `\n⚠️ ${invalidRecords} سجل مرفوض (بيانات غير صحيحة)`;
            }
            showToast(message, 'success');
        }

        function printCDRomReport() {
            let reportData = [];
            
            if (currentMode === 'electricity') {
                reportData = compensations
                    .map(comp => {
                        const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                        if (!b || (b.type && b.type !== 'electricity')) return null;
                        const rip = calculateRIP(b.account);
                        if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) {
                            return null;
                        }
                        return {
                            id: b.id,
                            name: b.name,
                            accountPart: rip.substring(0, 18),
                            keyPart: rip.substring(18),
                            netPayable: comp.netPayable
                        };
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.id - b.id);
            } else if (currentMode === 'equipment') {
                reportData = beneficiaries.filter(b => b.type === 'equipment')
                    .map(b => {
                        const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                        const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                        const rip = calculateRIP(b.account);
                        if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) {
                            return null;
                        }
                        return {
                            id: b.id,
                            name: b.name,
                            accountPart: rip.substring(0, 18),
                            keyPart: rip.substring(18),
                            netPayable: netPayable
                        };
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.id - b.id);
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                reportData = beneficiaries.filter(b => b.type === currentMode)
                    .map(b => {
                        const comp = targetArray.find(c => c.beneficiaryId === b.id);
                        const netPayable = comp ? comp.netPayable : 0;
                        const rip = calculateRIP(b.account);
                        if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) {
                            return null;
                        }
                        return {
                            id: b.id,
                            name: b.name,
                            accountPart: rip.substring(0, 18),
                            keyPart: rip.substring(18),
                            netPayable: netPayable
                        };
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.id - b.id);
            }
            
            if (reportData.length === 0) {
                alert("لا توجد بيانات صالحة لطباعة التقرير.");
                return;
            }

            const months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            const monthName = months[parseInt(institutionInfo.financialMonth, 10) - 1] || 'N/A';
            const year = institutionInfo.fiscalYear || 'YYYY';
            const orgAccount = institutionInfo.treasuryAccount || 'N/A';
            const orgKey = institutionInfo.treasuryKey || 'N/A';
            const totalAmount = reportData.reduce((sum, item) => sum + item.netPayable, 0);
            const beneficiaryCount = reportData.length;

            const beneficiaryRows = reportData.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.accountPart} / ${item.keyPart}</td>
                    <td>${formatCurrency(item.netPayable)}</td>
                </tr>
            `).join('');

            const reportHTML = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Etat de virement sur le CD-ROM</title>
                    <style>
                        body { font-family: "Times New Roman", serif; margin: 40px; color: #000; }
                        h2 { text-align: center; text-decoration: underline; margin-bottom: 5px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .details { margin-bottom: 20px; line-height: 1.8; }
                        table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 10px; font-weight: bold; }
                        @media print {
                            body { margin: 20px; }
                            button { display: none; }
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    </style>
                </head>
                <body>
                    <h2>Etat de virement sur le CD-ROM</h2>
                    <div class="header">
                        <strong>Mois :</strong> ${monthName} &nbsp;&nbsp;&nbsp;
                        <strong>Année :</strong> ${year}
                    </div>
                    <div class="details">
                        <strong>Numéro de compte de l’organisme :</strong> ${orgAccount} &nbsp;&nbsp; <strong>Clé :</strong> ${orgKey}<br>
                        <strong>Montant global de virement :</strong> ${formatCurrency(totalAmount)}<br>
                        <strong>L’Effectif :</strong> ${beneficiaryCount}<br>
                        <strong>Code Ordonnateur :</strong> 0<br>
                        <strong>N° Mandat :</strong> 0
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>N</th>
                                <th>Nom et Prénom</th>
                                <th>Compte / Clé</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${beneficiaryRows}
                        </tbody>
                    </table>
                    <div class="footer">
                        Nombre de titres : ${beneficiaryCount} &nbsp;&nbsp;&nbsp; Montant global de détail : ${formatCurrency(totalAmount)}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() { window.close(); };
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank', 'height=700,width=900,scrollbars=yes');
            if (printWindow) {
                printWindow.document.write(reportHTML);
                printWindow.document.close();
            } else {
                alert("فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة لهذا الموقع.");
            }
        }


        // ============================================
        // ========== PRO TXT EDITOR ===========
        // ============================================

        let proEditorData = []; // بيانات المحرر مع المبالغ المعدلة
        let proEditorInfo = {
            fiscalYear: new Date().getFullYear(),
            fiscalMonth: 1,
            orderNumber: 0,
            transferNumber: 0,
            treasuryAccount: '',
            keyNumber: '',
            dataSource: 'التعويضات المحجوزة'
        };

        function renderProEditorSection() {
            proEditorInfo.fiscalYear = institutionInfo.fiscalYear || new Date().getFullYear();
            proEditorInfo.fiscalMonth = institutionInfo.financialMonth || 1;
            proEditorInfo.orderNumber = institutionInfo.orderNumber || 0;
            proEditorInfo.transferNumber = institutionInfo.transferNumber || 0;
            proEditorInfo.treasuryAccount = institutionInfo.treasuryAccount || '';
            proEditorInfo.keyNumber = institutionInfo.keyNumber || '';

            document.getElementById('pro-fiscal-year-input').value = proEditorInfo.fiscalYear;
            document.getElementById('pro-fiscal-month-input').value = proEditorInfo.fiscalMonth;
            document.getElementById('pro-order-number').value = proEditorInfo.orderNumber;
            document.getElementById('pro-transfer-number').value = proEditorInfo.transferNumber;
            document.getElementById('pro-treasury-account').value = proEditorInfo.treasuryAccount;
            document.getElementById('pro-key-number').value = proEditorInfo.keyNumber;

            if (proEditorData.length === 0) {
                proLoadFromCompensations();
            } else {
                renderProEditorTable();
                updateProTotals();
                updateProEmptyState();
            }
        }

        function updateProInfo() {
            proEditorInfo.fiscalYear = parseInt(document.getElementById('pro-fiscal-year-input').value) || new Date().getFullYear();
            proEditorInfo.fiscalMonth = parseInt(document.getElementById('pro-fiscal-month-input').value) || 1;
            proEditorInfo.orderNumber = parseInt(document.getElementById('pro-order-number').value) || 0;
            proEditorInfo.transferNumber = parseInt(document.getElementById('pro-transfer-number').value) || 0;
            proEditorInfo.treasuryAccount = document.getElementById('pro-treasury-account').value || '';
            proEditorInfo.keyNumber = document.getElementById('pro-key-number').value || '';
        }

        function proLoadFromCompensations() {
            proEditorData = [];

            if (currentMode === 'electricity') {
                compensations.forEach(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    if (!b || (b.type && b.type !== 'electricity')) return;
                    const rip = calculateRIP(b.account);
                    if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) return;

                    proEditorData.push({
                        id: b.id,
                        name: b.name,
                        account: b.account,
                        rip: rip,
                        originalAmount: comp.netPayable,
                        modifiedAmount: comp.netPayable
                    });
                });
            } else if (currentMode === 'equipment') {
                beneficiaries.filter(b => b.type === 'equipment').forEach(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                    const rip = calculateRIP(b.account);
                    if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) return;

                    proEditorData.push({
                        id: b.id,
                        name: b.name,
                        account: b.account,
                        rip: rip,
                        originalAmount: netPayable,
                        modifiedAmount: netPayable
                    });
                });
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                beneficiaries.filter(b => b.type === currentMode).forEach(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : 0;
                    const rip = calculateRIP(b.account);
                    if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) return;

                    proEditorData.push({
                        id: b.id,
                        name: b.name,
                        account: b.account,
                        rip: rip,
                        originalAmount: netPayable,
                        modifiedAmount: netPayable
                    });
                });
            }

            proEditorData.sort((a, b) => a.id - b.id);
            proEditorInfo.dataSource = 'التعويضات المحجوزة';
            document.getElementById('pro-data-source').textContent = proEditorInfo.dataSource;

            renderProEditorTable();
            updateProTotals();
            updateProEmptyState();

            if (proEditorData.length > 0) {
                showToast(`تم تحميل ${proEditorData.length} مستفيد من التعويضات المحجوزة`, 'success');
            }
        }

        function proImportTxt() {
            document.getElementById('pro-import-file-input').click();
        }

        function proHandleFileImport(event) {
            // ملاحظة: استيراد المحرر الاحترافي معزول ولا يضيف شيئاً إلى قوائم المستفيدين/التعويضات الرئيسية
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    showToast('الملف لا يحتوي على بيانات كافية', 'error');
                    return;
                }

                const headerLine = lines[0];
                if (!headerLine.startsWith('*')) {
                    showToast('تنسيق الملف غير صحيح', 'error');
                    return;
                }

                const headerData = headerLine.substring(1);
                if (headerData.length >= 51) {
                    const month = parseInt(headerData.substring(39, 41), 10);
                    const year = parseInt('20' + headerData.substring(41, 43), 10);
                    const order = parseInt(headerData.substring(43, 47), 10);
                    const transfer = parseInt(headerData.substring(47, 51), 10);

                    proEditorInfo.fiscalMonth = month || 1;
                    proEditorInfo.fiscalYear = year || new Date().getFullYear();
                    proEditorInfo.orderNumber = order || 0;
                    proEditorInfo.transferNumber = transfer || 0;

                    // استخراج رقم الحساب CCP ورقم المفتاح من أول سجل
                    if (lines.length > 1) {
                        const firstDataLine = lines[1].trim();
                        if (firstDataLine.startsWith('*') && firstDataLine.length >= 61) {
                            const data = firstDataLine.substring(1);
                            const rip = data.substring(0, 20);
                            // رقم الحساب من RIP (المواضع 10-18)
                            proEditorInfo.treasuryAccount = rip.substring(10, 18).trim();
                            // رقم المفتاح من RIP (المواضع 0-10)
                            proEditorInfo.keyNumber = rip.substring(0, 10).trim();
                        }
                    }

                    document.getElementById('pro-fiscal-year-input').value = proEditorInfo.fiscalYear;
                    document.getElementById('pro-fiscal-month-input').value = proEditorInfo.fiscalMonth;
                    document.getElementById('pro-order-number').value = proEditorInfo.orderNumber;
                    document.getElementById('pro-transfer-number').value = proEditorInfo.transferNumber;
                    document.getElementById('pro-treasury-account').value = proEditorInfo.treasuryAccount;
                    document.getElementById('pro-key-number').value = proEditorInfo.keyNumber;
                }

                proEditorData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line.startsWith('*') || line.length < 61) continue;

                    const data = line.substring(1);
                    const rip = data.substring(0, 20);
                    const amountCents = parseInt(data.substring(20, 33), 10);
                    const amount = amountCents / 100;
                    const name = data.substring(33, 60).trim();
                    const account = rip.substring(10, 18).replace(/^0+/, '');

                    proEditorData.push({
                        id: i,
                        name: name,
                        account: account,
                        rip: rip,
                        originalAmount: amount,
                        modifiedAmount: amount
                    });
                }

                proEditorInfo.dataSource = `ملف مستورد (${file.name})`;
                document.getElementById('pro-data-source').textContent = proEditorInfo.dataSource;

                renderProEditorTable();
                updateProTotals();
                updateProEmptyState();

                SoundSystem.import();
                showToast(`تم استيراد ${proEditorData.length} سجل من الملف`, 'success');
            };

            reader.readAsText(file);
            event.target.value = '';
        }

        function renderProEditorTable() {
            const tbody = document.getElementById('pro-editor-tbody');
            tbody.innerHTML = '';

            proEditorData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>
                        <input type="text" 
                               class="pro-account-input" 
                               value="${item.account}" 
                               data-index="${index}"
                               onchange="updateProAccountAndRIP(${index}, this.value)"
                               placeholder="رقم الحساب">
                    </td>
                    <td>
                        <span class="pro-rip-display" data-index="${index}">${item.rip}</span>
                    </td>
                    <td class="original-amount">${formatCurrency(item.originalAmount)}</td>
                    <td>
                        <input type="number" 
                               class="amount-input" 
                               value="${item.modifiedAmount.toFixed(2)}" 
                               step="0.01" 
                               min="0"
                               data-index="${index}"
                               onchange="updateProAmount(${index}, this.value)"
                               oninput="markProInputModified(this, ${item.originalAmount})">
                    </td>
                    <td>
                        <button class="delete-btn" onclick="proDeleteRow(${index})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pro-beneficiary-count').textContent = proEditorData.length;
        }

        function updateProEmptyState() {
            const emptyState = document.getElementById('pro-empty-state');
            const table = document.getElementById('pro-editor-table');

            if (proEditorData.length === 0) {
                emptyState.classList.add('visible');
                table.style.display = 'none';
            } else {
                emptyState.classList.remove('visible');
                table.style.display = 'table';
            }
        }

        function proDeleteRow(index) {
            if (!confirm('هل تريد حذف هذا السجل؟')) return;

            proEditorData.splice(index, 1);
            renderProEditorTable();
            updateProTotals();
            updateProEmptyState();
            SoundSystem.delete();
        }

        function proClearTable() {
            if (proEditorData.length === 0) {
                showToast('الجدول فارغ بالفعل', 'info');
                return;
            }

            if (!confirm('هل تريد مسح جميع البيانات من الجدول؟')) return;

            proEditorData = [];
            renderProEditorTable();
            updateProTotals();
            updateProEmptyState();
            SoundSystem.delete();
            showToast('تم مسح الجدول', 'success');
        }

        function markProInputModified(input, originalAmount) {
            const currentValue = parseFloat(input.value) || 0;
            if (Math.abs(currentValue - originalAmount) > 0.001) {
                input.classList.add('modified');
            } else {
                input.classList.remove('modified');
            }
        }

        function updateProAccountAndRIP(index, newAccount) {
            // تحديث رقم الحساب
            proEditorData[index].account = newAccount;
            
            // حساب RIP الجديد
            const newRIP = calculateRIP(newAccount);
            if (newRIP.includes('خطأ')) {
                showToast(`خطأ: رقم الحساب غير صحيح - ${newRIP}`, 'error');
                // استعادة البيانات السابقة في الحقل
                document.querySelector(`.pro-account-input[data-index="${index}"]`).value = proEditorData[index].account;
                return;
            }
            
            // تحديث RIP في البيانات
            proEditorData[index].rip = newRIP;
            
            // تحديث عرض RIP في الجدول
            const ripDisplay = document.querySelector(`.pro-rip-display[data-index="${index}"]`);
            if (ripDisplay) {
                ripDisplay.textContent = newRIP;
            }
            
            SoundSystem.click();
            showToast('تم تحديث RIP بنجاح', 'success');
        }

        function updateProAmount(index, value) {
            const newAmount = parseFloat(value) || 0;
            proEditorData[index].modifiedAmount = Math.round(newAmount * 100) / 100;
            updateProTotals();
            SoundSystem.click();
        }

        function updateProTotals() {
            const originalTotal = proEditorData.reduce((sum, item) => sum + item.originalAmount, 0);
            const modifiedTotal = proEditorData.reduce((sum, item) => sum + item.modifiedAmount, 0);

            document.getElementById('pro-original-total').textContent = formatCurrency(originalTotal);
            document.getElementById('pro-modified-total').textContent = formatCurrency(modifiedTotal);
            document.getElementById('pro-total-amount').textContent = formatCurrency(modifiedTotal) + ' دج';
            document.getElementById('pro-beneficiary-count').textContent = proEditorData.length;
        }

        function proResetAmounts() {
            if (proEditorData.length === 0) {
                showToast('لا توجد بيانات لاستعادتها', 'info');
                return;
            }

            if (!confirm('هل تريد استعادة جميع المبالغ الأصلية؟')) return;

            proEditorData.forEach(item => {
                item.modifiedAmount = item.originalAmount;
            });

            renderProEditorTable();
            updateProTotals();
            SoundSystem.success();
            showToast('تم استعادة المبالغ الأصلية', 'success');
        }

        function proExportTxt() {
            if (proEditorData.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'error');
                return;
            }

            updateProInfo();

            let validRecords = [];
            let totalAmount = 0;

            proEditorData.forEach(item => {
                if (item.modifiedAmount > 0) {
                    const amountCents = String(Math.round(item.modifiedAmount * 100)).padStart(13, '0');
                    const namePadded = (item.name + ' '.repeat(27)).substring(0, 27);
                    validRecords.push(`*${item.rip}${amountCents}${namePadded}1`);
                    totalAmount += item.modifiedAmount;
                }
            });

            if (validRecords.length === 0) {
                showToast('لا توجد سجلات صالحة للتصدير (جميع المبالغ صفر)', 'error');
                return;
            }

            // تحديد مصدر البيانات ورقم الحساب
            let treasuryAccount = '';
            let treasuryRIP = '';
            
            // إذا كانت البيانات مستوردة من ملف TXT، استخدم بيانات الملف المستورد
            if (proEditorInfo.dataSource.includes('ملف مستورد')) {
                treasuryAccount = proEditorInfo.treasuryAccount;
                // استخدام RIP من أول سجل في البيانات المستوردة (يحتوي على بيانات الخزينة)
                if (proEditorData.length > 0) {
                    treasuryRIP = proEditorData[0].rip ? proEditorData[0].rip.substring(0, 20) : calculateRIP(treasuryAccount);
                }
            } else {
                // إذا كانت البيانات محملة من التعويضات المحجوزة، استخدم بيانات المؤسسة
                treasuryAccount = institutionInfo.treasuryAccount;
                treasuryRIP = calculateRIP(treasuryAccount);
            }

            if (treasuryRIP.includes('خطأ') || !treasuryRIP || treasuryRIP.length < 20) {
                showToast('خطأ: رقم حساب الخزينة غير صحيح. يرجى التحقق من معلومات الحساب.', 'error');
                return;
            }

            const totalAmountCents = String(Math.round(totalAmount * 100)).padStart(13, '0');
            const recordCount = String(validRecords.length).padStart(7, '0');
            const month = String(proEditorInfo.fiscalMonth).padStart(2, '0');
            const year = String(proEditorInfo.fiscalYear).padStart(4, '0');
            const order = String(proEditorInfo.orderNumber).padStart(8, '0');
            const transfer = String(proEditorInfo.transferNumber).padStart(6, '0');

            const header = `*${treasuryRIP}${totalAmountCents}${recordCount}${month}${year}${order}${transfer}0`;
            
            if (header.length !== 62) {
                showToast(`خطأ في توليد السطر الأول: الطول = ${header.length} (يجب أن يكون 62)`, 'error');
                return;
            }

            const fileContent = header + '\n' + validRecords.join('\n');

            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = `Pro_Payment_${currentMode}_${proEditorInfo.fiscalYear}_${month}_${new Date().toLocaleDateString('ar-SA')}.txt`;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            SoundSystem.export();
            showToast(`تم تصدير الملف بنجاح\n${validRecords.length} سجل - المجموع: ${formatCurrency(totalAmount)} دج`, 'success');
        }

        function proPrintCDRom() {
            if (proEditorData.length === 0) {
                showToast('لا توجد بيانات للطباعة', 'error');
                return;
            }

            updateProInfo();

            const months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            const monthName = months[proEditorInfo.fiscalMonth - 1] || 'N/A';
            const year = proEditorInfo.fiscalYear;
            const orgAccount = proEditorInfo.treasuryAccount || institutionInfo.treasuryAccount || 'N/A';
            const orgKey = proEditorInfo.keyNumber || institutionInfo.treasuryKey || 'N/A';
            const totalAmount = proEditorData.reduce((sum, item) => sum + item.modifiedAmount, 0);
            const beneficiaryCount = proEditorData.length;
            const orderNum = proEditorInfo.orderNumber;
            const transferNum = proEditorInfo.transferNumber;

            const beneficiaryRows = proEditorData.filter(item => item.modifiedAmount > 0).map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.rip.substring(0, 18)} / ${item.rip.substring(18)}</td>
                    <td>${formatCurrency(item.modifiedAmount)}</td>
                </tr>
            `).join('');

            const reportHTML = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Etat de virement sur le CD-ROM (Pro)</title>
                    <style>
                        body { font-family: "Times New Roman", serif; margin: 40px; color: #000; }
                        h2 { text-align: center; text-decoration: underline; margin-bottom: 5px; }
                        .pro-badge { background: linear-gradient(135deg, #0d9488, #0f766e); color: #fff; padding: 3px 12px; border-radius: 5px; font-size: 11px; margin-right: 10px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .details { margin-bottom: 20px; line-height: 1.8; }
                        table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 10px; font-weight: bold; }
                        @media print {
                            body { margin: 20px; }
                            button { display: none; }
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    </style>
                </head>
                <body>
                    <h2><span class="pro-badge">PRO</span> Etat de virement sur le CD-ROM</h2>
                    <div class="header">
                        <strong>Mois :</strong> ${monthName} &nbsp;&nbsp;&nbsp;
                        <strong>Année :</strong> ${year}
                    </div>
                    <div class="details">
                        <strong>Numéro de compte de l'organisme :</strong> ${orgAccount} &nbsp;&nbsp; <strong>Clé :</strong> ${orgKey}<br>
                        <strong>Montant global de virement :</strong> ${formatCurrency(totalAmount)}<br>
                        <strong>L'Effectif :</strong> ${beneficiaryCount}<br>
                        <strong>Code Ordonnateur :</strong> ${orderNum}<br>
                        <strong>N° Mandat :</strong> ${transferNum}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>N</th>
                                <th>Nom et Prénom</th>
                                <th>Compte / Clé</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${beneficiaryRows}
                        </tbody>
                    </table>
                    <div class="footer">
                        Nombre de titres : ${beneficiaryCount} &nbsp;&nbsp;&nbsp; Montant global de détail : ${formatCurrency(totalAmount)}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() { window.close(); };
                        };
                    <\/script>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank', 'height=700,width=900,scrollbars=yes');
            if (printWindow) {
                printWindow.document.write(reportHTML);
                printWindow.document.close();
                SoundSystem.success();
            } else {
                showToast('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', 'error');
            }
        }


        // --- Import from TXT ---
        let importedTxtData = [];

        function openImportTxtModal() {
            document.getElementById('import-txt-input').click();
        }

        function handleTxtFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                showImportTxtModal(content);
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = ''; // Reset for selecting same file again
        }

        function showImportTxtModal(content) {
            const modal = document.getElementById('import-txt-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
            
            // Store content for later processing
            modal.dataset.content = content;
            
            // Add event listener for format change
            const formatRadios = document.querySelectorAll('input[name="import-format"]');
            formatRadios.forEach(radio => {
                radio.addEventListener('change', () => parseAndPreviewTxt(content));
            });
            
            document.getElementById('import-has-header').addEventListener('change', () => parseAndPreviewTxt(content));
            
            // Initial parse
            parseAndPreviewTxt(content);
        }
        
        function parseAndPreviewTxt(content) {
            const format = document.querySelector('input[name="import-format"]:checked').value;
            const hasHeader = document.getElementById('import-has-header').checked;
            const headerOptionContainer = document.getElementById('header-option-container');
            
            // Hide/show header option based on format
            if (format === 'payment-file') {
                headerOptionContainer.style.display = 'none';
            } else {
                headerOptionContainer.style.display = 'block';
            }
            
            const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
            importedTxtData = [];
            
            // Parse based on format
            if (format === 'payment-file') {
                // Parse Algérie Poste payment file format
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Skip if line doesn't start with * or is too short
                    if (!line.startsWith('*') || line.length < 35) continue;
                    
                    // Skip header line (contains treasury RIP - check if position 21-33 is all zeros for header)
                    // Header has specific format: *[RIP 20][Amount 13][Count 7][Month 2][Year 4][Order 8][Transfer 6][0]
                    // Beneficiary line: *[RIP 20][Amount 13][Name 30][1]
                    
                    // Check if this is a beneficiary line by checking line length and format
                    // Beneficiary lines are exactly 65 characters (or close) and end with "1"
                    const trimmedLine = line.trim();
                    
                    // Try to extract beneficiary data
                    // RIP: positions 1-20 (after *)
                    // Amount: positions 21-33 (13 digits)
                    // Name: positions 34-63 (30 characters)
                    // Code: position 64 (should be "1" for beneficiary)
                    
                    if (trimmedLine.length >= 34) {
                        const rip = trimmedLine.substring(1, 21);
                        const amountCentimes = trimmedLine.substring(21, 34);
                        const nameAndCode = trimmedLine.substring(34);
                        
                        // Check if this looks like a beneficiary line (has name with letters)
                        if (/[a-zA-Z]/.test(nameAndCode)) {
                            // Extract account number from RIP (positions 9-18 are the account)
                            // RIP format: 00799999 + XXXXXXXXXX (account 10 digits) + KK (RIP key 2 digits)
                            // Note: RIP key ≠ CCP key, so we only extract the account number
                            const accountNumberPadded = rip.substring(8, 18);
                            const accountNumber = accountNumberPadded.replace(/^0+/, ''); // Remove leading zeros
                            
                            // Extract name (remove trailing spaces and the "1" at the end)
                            let name = nameAndCode.replace(/\s*1?\s*$/, '').trim();
                            
                            // Calculate amount in DA
                            const amountDA = parseInt(amountCentimes, 10) / 100;
                            
                            if (accountNumber && name) {
                                importedTxtData.push({
                                    name: name,
                                    account: accountNumber, // Just the account number, RIP will be calculated automatically
                                    meter: '',
                                    section: '',
                                    rank: '',
                                    amount: amountDA // Store amount for reference
                                });
                            }
                        }
                    }
                }
            } else {
                // Parse CSV-style formats
                let separator;
                switch(format) {
                    case 'semicolon': separator = ';'; break;
                    case 'comma': separator = ','; break;
                    case 'tab': separator = '\t'; break;
                    case 'pipe': separator = '|'; break;
                    default: separator = ';';
                }
                
                const startIndex = hasHeader ? 1 : 0;
                
                for (let i = startIndex; i < lines.length; i++) {
                    const parts = lines[i].split(separator).map(p => p.trim());
                    if (parts.length >= 2 && parts[0] && parts[1]) {
                        importedTxtData.push({
                            name: parts[0] || '',
                            account: parts[1] || '',
                            meter: parts[2] || '',
                            section: parts[3] || '',
                            rank: parts[4] || ''
                        });
                    }
                }
            }
            
            // Show preview
            const previewDiv = document.getElementById('import-preview');
            const previewTable = document.getElementById('import-preview-table');
            const importCount = document.getElementById('import-count');
            const confirmBtn = document.getElementById('confirm-import-txt');
            
            if (importedTxtData.length > 0) {
                previewDiv.style.display = 'block';
                confirmBtn.style.display = 'inline-flex';
                importCount.textContent = importedTxtData.length;
                
                // Build preview table with checkboxes (show all rows)
                const showAmount = format === 'payment-file';
                
                previewTable.innerHTML = `
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="import-select-all-checkbox" checked onchange="selectAllImport(this.checked)"></th>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الحساب</th>
                            ${showAmount ? '<th>المبلغ (دج)</th>' : '<th>رقم العداد</th>'}
                            <th>القسم</th>
                            <th>الرتبة</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${importedTxtData.map((row, idx) => `
                            <tr>
                                <td><input type="checkbox" class="import-row-checkbox" data-index="${idx}" checked onchange="updateImportSelectionCount()"></td>
                                <td>${idx + 1}</td>
                                <td>${row.name}</td>
                                <td style="direction: ltr; text-align: center;">${row.account}</td>
                                ${showAmount ? `<td>${formatCurrency(row.amount || 0)}</td>` : `<td>${row.meter}</td>`}
                                <td>${row.section}</td>
                                <td>${row.rank}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
                // Update selection count
                updateImportSelectionCount();
            } else {
                previewDiv.style.display = 'none';
                confirmBtn.style.display = 'none';
                showToast('لم يتم العثور على بيانات صالحة. تحقق من تنسيق الملف', 'error');
            }
        }
        
        function cancelImportTxt() {
            const modal = document.getElementById('import-txt-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                importedTxtData = [];
                document.getElementById('import-preview').style.display = 'none';
                document.getElementById('confirm-import-txt').style.display = 'none';
            }, 300);
        }
        
        function selectAllImport(select) {
            const checkboxes = document.querySelectorAll('.import-row-checkbox');
            const selectAllCheckbox = document.getElementById('import-select-all-checkbox');
            checkboxes.forEach(cb => cb.checked = select);
            if (selectAllCheckbox) selectAllCheckbox.checked = select;
            updateImportSelectionCount();
        }
        
        function updateImportSelectionCount() {
            const checkboxes = document.querySelectorAll('.import-row-checkbox');
            const selectedCount = document.querySelectorAll('.import-row-checkbox:checked').length;
            const selectedCountEl = document.getElementById('import-selected-count');
            const selectAllCheckbox = document.getElementById('import-select-all-checkbox');
            
            if (selectedCountEl) selectedCountEl.textContent = selectedCount;
            if (selectAllCheckbox) selectAllCheckbox.checked = selectedCount === checkboxes.length;
        }
        
        function getSelectedImportIndices() {
            const checkboxes = document.querySelectorAll('.import-row-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
        }
        
        function confirmImportTxt() {
            const selectedIndices = getSelectedImportIndices();
            
            if (selectedIndices.length === 0) {
                showToast('يرجى تحديد مستفيد واحد على الأقل للاستيراد', 'error');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من استيراد ${selectedIndices.length} مستفيد إلى نوع التعويض الحالي (${getModeLabel(currentMode)})؟`)) {
                return;
            }
            
            let importedCount = 0;
            let skippedCount = 0;
            let invalidCount = 0;
            let nextId = getNextBeneficiaryId();
            
            // Get only selected rows
            const selectedData = selectedIndices.map(idx => importedTxtData[idx]);
            
            selectedData.forEach(row => {
                // Validate name (Latin characters only)
                if (!/^[a-zA-Z\s\-]+$/.test(row.name)) {
                    invalidCount++;
                    return;
                }
                
                // Check for duplicate account in same compensation type
                if (beneficiaries.some(b => b.account === row.account && (b.type === currentMode || (!b.type && currentMode === 'electricity')))) {
                    skippedCount++;
                    return;
                }
                
                // Validate account (RIP)
                const rip = calculateRIP(row.account);
                if (rip.includes('خطأ')) {
                    invalidCount++;
                    return;
                }
                
                // Add beneficiary
                beneficiaries.push({
                    id: nextId++,
                    name: row.name,
                    account: row.account,
                    meter: row.meter,
                    section: row.section,
                    rank: row.rank,
                    type: currentMode
                });
                importedCount++;
            });
            
            // Save and update UI
            saveData();
            renderCompensationGrid();
            updateCreditDisplay();
            
            // Close modal
            cancelImportTxt();
            
            // تشغيل صوت الاستيراد
            if (importedCount > 0) SoundSystem.import();
            
            // Show result message
            let message = `تم استيراد ${importedCount} مستفيد بنجاح`;
            if (skippedCount > 0) message += `\nتم تخطي ${skippedCount} (حساب مكرر)`;
            if (invalidCount > 0) message += `\nتم رفض ${invalidCount} (بيانات غير صالحة)`;
            
            showToast(message, importedCount > 0 ? 'success' : 'error');
            
            // Check achievements
            checkAchievements();
        }
        
        function getModeLabel(mode) {
            switch(mode) {
                case 'electricity': return 'كهرباء وغاز';
                case 'equipment': return 'منحة تجهيز';
                case 'transport': return 'تنقل';
                case 'training': return 'تكوين';
                default: return mode;
            }
        }

        // --- Backup and Restore ---
        function createBackup() {
            try {
                const backupData = { 
                    institutionInfo, 
                    beneficiaries, 
                    compensations, 
                    compensationsEquipment,
                    compensationsTransport,
                    compensationsTraining,
                    backupVersion: '2.0',
                    backupDate: new Date().toISOString()
                };
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const now = new Date();
                const filename = `CompData_Backup_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}.json`;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                showToast(`تم إنشاء النسخة الاحتياطية: ${filename}`, 'success');
            } catch (e) {
                console.error('Backup error:', e);
                showToast('خطأ في إنشاء النسخة الاحتياطية', 'error');
            }
        }

        function createAutoBackup(reason = 'قبل_الحذف') {
            try {
                const backupData = { 
                    institutionInfo, 
                    beneficiaries, 
                    compensations, 
                    compensationsEquipment,
                    compensationsTransport,
                    compensationsTraining,
                    backupVersion: '2.0',
                    backupDate: new Date().toISOString(),
                    reason: reason
                };
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const now = new Date();
                const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;
                const filename = `نسخة_تلقائية_${reason}_${timestamp}.json`;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                return filename;
            } catch (e) {
                console.error('Auto backup error:', e);
                throw e;
            }
        }

        function deleteAllBeneficiaries() {
            if (beneficiaries.length === 0) {
                showToast('لا يوجد مستفيدون للحذف', 'info');
                return;
            }

            const message = `⚠️ تحذير: سيتم حذف جميع المستفيدين (${beneficiaries.length} مستفيد) وجميع التعويضات المرتبطة بهم.\n\n` +
                          `سيتم حفظ نسخة احتياطية تلقائية قبل الحذف.\n\n` +
                          `هل أنت متأكد من المتابعة؟`;
            
            if (!confirm(message)) {
                return;
            }

            // حفظ نسخة احتياطية تلقائية
            try {
                const filename = createAutoBackup('قبل_حذف_جميع_المستفيدين');
                showToast(`تم حفظ نسخة احتياطية: ${filename}`, 'success');
            } catch (error) {
                console.error('Auto backup failed:', error);
                showToast('فشل إنشاء النسخة الاحتياطية. لن يتم الحذف', 'error');
                return;
            }

            // التأكيد النهائي
            if (!confirm('تم حفظ النسخة الاحتياطية. هل تريد المتابعة في حذف جميع المستفيدين؟')) {
                return;
            }

            // حذف جميع البيانات
            const deletedCount = beneficiaries.length;
            beneficiaries.length = 0;
            compensations.length = 0;
            compensationsEquipment.length = 0;
            compensationsTransport.length = 0;
            compensationsTraining.length = 0;

            // حفظ التغييرات
            saveData();

            // تحديث الواجهة
            renderCompensationGrid();
            updateCreditDisplay();

            showToast(`✓ تم حذف ${deletedCount} مستفيد بنجاح. النسخة الاحتياطية محفوظة`, 'success');
        }

        function restoreBackup() {
            document.getElementById('restore-file-input').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.json')) return alert('الرجاء اختيار ملف JSON صالح.');
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.institutionInfo && data.beneficiaries) {
                        tempBackupData = data;
                        showRestoreTypeModal();
                    } else { alert('ملف النسخة الاحتياطية غير صالح.'); }
                } catch (err) { alert('خطأ في قراءة الملف.'); }
            };
            reader.readAsText(file);
            // إعادة تعيين input لتمكين اختيار نفس الملف مرة أخرى
            event.target.value = '';
        }

        function showRestoreTypeModal() {
            const modal = document.getElementById('restore-type-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function cancelRestoreType() {
            const modal = document.getElementById('restore-type-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                tempBackupData = null;
            }, 300);
        }

        function selectRestoreType(type) {
            if (!tempBackupData) return;
            
            if (type === 'full') {
                // استعادة كاملة
                if (confirm('هل أنت متأكد من استعادة جميع البيانات؟ سيتم الكتابة فوق البيانات الحالية بالكامل.')) {
                    restoreFullBackup(tempBackupData);
                }
                cancelRestoreType(); // إفراغ البيانات بعد الاستعادة الكاملة
            } else if (type === 'beneficiaries') {
                // استيراد المستفيدين فقط - لا نفرغ tempBackupData هنا
                // إغلاق نافذة اختيار النوع فقط
                const modal = document.getElementById('restore-type-modal');
                modal.classList.remove('visible');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                
                // عرض نافذة اختيار المستفيدين
                showBeneficiarySelectionModal(tempBackupData, currentMode);
            }
        }

        function restoreFullBackup(data) {
            localStorage.setItem('institutionInfo', JSON.stringify(data.institutionInfo));
            localStorage.setItem('beneficiaries', JSON.stringify(data.beneficiaries));
            localStorage.setItem('compensations', JSON.stringify(data.compensations || []));
            localStorage.setItem('compensationsEquipment', JSON.stringify(data.compensationsEquipment || []));
            localStorage.setItem('compensationsTransport', JSON.stringify(data.compensationsTransport || []));
            localStorage.setItem('compensationsTraining', JSON.stringify(data.compensationsTraining || []));
            location.reload();
        }

        function showBeneficiarySelectionModal(backupData, compensationType) {
            tempBackupData = backupData; // حفظ البيانات للاستخدام عند التأكيد
            const modal = document.getElementById('beneficiary-selection-modal');
            const list = document.getElementById('beneficiary-selection-list');
            
            if (!backupData.beneficiaries || backupData.beneficiaries.length === 0) {
                alert('لا يوجد مستفيدون في النسخة الاحتياطية.');
                tempBackupData = null;
                return;
            }
            
            // تصفية المستفيدين حسب نوع التعويض الحالي
            const filteredBeneficiaries = backupData.beneficiaries.filter(b => b.type === compensationType);
            
            if (filteredBeneficiaries.length === 0) {
                const typeLabel = compensationType === 'electricity' ? 'كهرباء وغاز' :
                                 compensationType === 'equipment' ? 'منحة تجهيز' :
                                 compensationType === 'transport' ? 'تنقل' : 'تكوين';
                alert(`لا يوجد مستفيدون من نوع ${typeLabel} في النسخة الاحتياطية.`);
                tempBackupData = null;
                return;
            }
            
            // إنشاء قائمة المستفيدين المصفاة
            list.innerHTML = filteredBeneficiaries.map(b => {
                const typeLabel = b.type === 'electricity' ? 'كهرباء وغاز' :
                                 b.type === 'equipment' ? 'منحة تجهيز' :
                                 b.type === 'transport' ? 'تنقل' :
                                 b.type === 'training' ? 'تكوين' : 'غير محدد';
                
                const originalIndex = backupData.beneficiaries.indexOf(b);
                return `
                    <div style="margin-bottom: 12px; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background: white;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" class="beneficiary-checkbox" value="${b.id}" data-beneficiary-index="${originalIndex}" style="width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: var(--dark-color);">${b.name}</div>
                                <div style="font-size: 0.9em; color: var(--text-secondary-color);">
                                    <span><i class="fas fa-credit-card"></i> ${b.account}</span>
                                    ${b.meter ? `<span style="margin-right: 15px;"><i class="fas fa-tachometer-alt"></i> ${b.meter}</span>` : ''}
                                    <span style="margin-right: 15px;"><i class="fas fa-tag"></i> ${typeLabel}</span>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
            
            // إعداد زر تحديد الكل
            const selectAllCheckbox = document.getElementById('select-all-beneficiaries');
            selectAllCheckbox.checked = false;
            selectAllCheckbox.onchange = function() {
                const checkboxes = list.querySelectorAll('.beneficiary-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
            };
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function cancelBeneficiarySelection() {
            const modal = document.getElementById('beneficiary-selection-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                tempBackupData = null;
            }, 300);
        }

        function confirmBeneficiarySelection() {
            console.log('confirmBeneficiarySelection called');
            console.log('tempBackupData:', tempBackupData);
            
            if (!tempBackupData) {
                console.log('No tempBackupData - returning');
                alert('خطأ: لا توجد بيانات احتياطية. الرجاء إعادة المحاولة.');
                return;
            }
            
            const selectedCheckboxes = document.querySelectorAll('.beneficiary-checkbox:checked');
            console.log('Selected checkboxes:', selectedCheckboxes.length);
            
            if (selectedCheckboxes.length === 0) {
                alert('الرجاء تحديد مستفيد واحد على الأقل.');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من استيراد بيانات ${selectedCheckboxes.length} مستفيد؟`)) {
                return;
            }
            
            // جمع المستفيدين المحددين
            const selectedBeneficiaries = [];
            const selectedBeneficiaryIds = [];
            
            selectedCheckboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.beneficiaryIndex);
                const originalBeneficiary = tempBackupData.beneficiaries[index];
                selectedBeneficiaries.push(originalBeneficiary);
                selectedBeneficiaryIds.push(originalBeneficiary.id);
            });
            
            // دمج المستفيدين الجدد مع الموجودين
            let importedCount = 0;
            let skippedCount = 0;
            let nextId = getNextBeneficiaryId();
            
            selectedBeneficiaries.forEach(backupBen => {
                // التحقق من عدم وجود نفس الحساب
                if (beneficiaries.some(b => b.account === backupBen.account)) {
                    skippedCount++;
                    return; // تخطي هذا المستفيد
                }
                
                // إنشاء معرف جديد
                const oldId = backupBen.id;
                const newBen = {
                    ...backupBen,
                    id: nextId++
                };
                
                beneficiaries.push(newBen);
                importedCount++;
                
                // استيراد التعويضات إن وجدت (اختياري)
                // يمكن التعليق على هذا الجزء إذا أردت استيراد معلومات المستفيدين فقط بدون تعويضات
                /*
                if (tempBackupData.compensations) {
                    const comp = tempBackupData.compensations.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensations.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                
                if (tempBackupData.compensationsEquipment) {
                    const comp = tempBackupData.compensationsEquipment.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensationsEquipment.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                
                if (tempBackupData.compensationsTransport) {
                    const comp = tempBackupData.compensationsTransport.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensationsTransport.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                
                if (tempBackupData.compensationsTraining) {
                    const comp = tempBackupData.compensationsTraining.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensationsTraining.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                */
            });
            
            // حفظ البيانات
            saveData();
            
            // إغلاق المودال
            cancelBeneficiarySelection();
            
            // إعادة رسم الجدول
            renderCompensationGrid();
            updateCreditDisplay();
            
            // إظهار رسالة النتيجة
            console.log('Imported beneficiaries:', importedCount);
            console.log('Total beneficiaries now:', beneficiaries.length);
            console.log('Current mode:', currentMode);
            
            // تشغيل صوت الاستيراد
            if (importedCount > 0) SoundSystem.import();
            
            let message = `تم استيراد ${importedCount} مستفيد بنجاح إلى قائمة المستفيدين.`;
            if (skippedCount > 0) {
                message += ` تم تخطي ${skippedCount} مستفيد (حساب مكرر).`;
            }
            message += '\n\nالمستفيدون متاحون الآن في جدول إدارة التعويضات.';
            
            showToast(message, 'success');
            
            // تحديث القائمة لإظهار المستفيدين الجدد
            setTimeout(() => {
                renderCompensationGrid();
            }, 500);
        }
 
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Don't show section yet, wait for mode selection
            // showSection('institution-info-section'); 
            // updateCreditDisplay();

            // Main forms
            document.getElementById('institution-info-form').addEventListener('submit', saveInstitutionInfo);
            document.getElementById('beneficiary-form').addEventListener('submit', saveBeneficiary);
            document.getElementById('restore-file-input').addEventListener('change', handleFileSelect);
            document.getElementById('delete-all-beneficiaries-btn').addEventListener('click', deleteAllBeneficiaries);
            
            // Import TXT
            document.getElementById('import-txt-btn').addEventListener('click', openImportTxtModal);
            document.getElementById('import-txt-input').addEventListener('change', handleTxtFileSelect);
            document.getElementById('confirm-import-txt').addEventListener('click', confirmImportTxt);
            
            // Scroll to Top Button
            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            const mainContentArea = document.querySelector('.main-content');
            
            if (scrollToTopBtn && mainContentArea) {
                // Track scroll position on main content
                mainContentArea.addEventListener('scroll', () => {
                    if (mainContentArea.scrollTop > 300) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                
                // Also track window scroll
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 300 || document.documentElement.scrollTop > 300) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                
                // Scroll to top action
                scrollToTopBtn.addEventListener('click', () => {
                    // Scroll main content area
                    mainContentArea.scrollTo({ top: 0, behavior: 'smooth' });
                    // Also scroll window
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    document.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            // Sidebar Toggle
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }
            
            // Mobile Menu Toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn && sidebar) {
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('mobile-open');
                });
                
                // Close sidebar when clicking outside
                document.addEventListener('click', (e) => {
                    if (sidebar.classList.contains('mobile-open') && 
                        !sidebar.contains(e.target) && 
                        !mobileMenuBtn.contains(e.target)) {
                        sidebar.classList.remove('mobile-open');
                    }
                });
            }
            
            // Sidebar Navigation
            document.querySelectorAll('.sidebar-nav .nav-item[data-section]').forEach(button => {
                button.addEventListener('click', () => {
                    showSection(button.dataset.section);
                    // Close mobile sidebar after selection
                    if (window.innerWidth <= 768 && sidebar) {
                        sidebar.classList.remove('mobile-open');
                    }
                });
            });
            
            // Sound Toggle Button in Sidebar
            const soundToggleBtn = document.getElementById('sound-toggle-btn');
            if (soundToggleBtn) {
                // تحديث الأيقونة حسب حالة الصوت
                const updateSoundIcon = () => {
                    const icon = soundToggleBtn.querySelector('i');
                    const text = soundToggleBtn.querySelector('span');
                    if (SoundSystem.enabled) {
                        icon.className = 'fas fa-volume-up';
                        text.textContent = 'الأصوات';
                    } else {
                        icon.className = 'fas fa-volume-mute';
                        text.textContent = 'الأصوات (مغلقة)';
                    }
                };
                updateSoundIcon();
                
                soundToggleBtn.addEventListener('click', () => {
                    const enabled = SoundSystem.toggle();
                    updateSoundIcon();
                    if (enabled) {
                        SoundSystem.success();
                        showToast('تم تفعيل الأصوات', 'success');
                    } else {
                        showToast('تم تعطيل الأصوات', 'info');
                    }
                });
            }
            
            // Stats Button in Sidebar
            const statsBtn = document.getElementById('stats-btn');
            if (statsBtn) {
                statsBtn.addEventListener('click', () => {
                    const dashboard = document.getElementById('stats-dashboard');
                    if (dashboard) dashboard.classList.toggle('visible');
                });
            }
            
            // Quick Stats Update
            function updateQuickStats() {
                const currentData = getCurrentCompensationsArray();
                const quickCount = document.getElementById('quick-beneficiary-count');
                const quickTotal = document.getElementById('quick-total-compensation');
                if (quickCount) quickCount.textContent = currentData.length;
                if (quickTotal) {
                    const total = currentData.reduce((sum, c) => sum + (c.netPayable || 0), 0);
                    quickTotal.textContent = formatCurrency(total);
                }
            }
            // Call initially
            setTimeout(updateQuickStats, 1000);

            // Navigation - Main Switch Mode Button
            document.getElementById('switch-mode-btn').addEventListener('click', () => {
                const modal = document.getElementById('mode-selection-modal');
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('visible'), 10);
            });

            document.querySelectorAll('nav button[data-section]').forEach(button => {
                button.addEventListener('click', () => showSection(button.dataset.section));
            });
            // Reporting
            document.getElementById('print-report-btn').addEventListener('click', printReport);
            document.getElementById('export-xlsx-btn').addEventListener('click', exportXLSX);
            document.getElementById('export-txt-btn').addEventListener('click', exportTxt);
            document.getElementById('print-cdrom-btn').addEventListener('click', printCDRomReport);
            // Backup/Restore
            document.getElementById('create-backup-btn').addEventListener('click', createBackup);
            document.getElementById('restore-backup-btn').addEventListener('click', restoreBackup);
            // Modals
            document.getElementById('cancel-beneficiary-btn').addEventListener('click', cancelBeneficiaryEdit);
            document.getElementById('cancel-quarterly-btn').addEventListener('click', closeQuarterlyModal);
            
            // Compensation Grid Listeners
            document.getElementById('add-beneficiary-btn').addEventListener('click', () => openBeneficiaryModal());
            document.getElementById('compensation-grid-search').addEventListener('input', e => renderCompensationGrid(e.target.value));
            document.getElementById('quarterly-details-form').addEventListener('submit', handleQuarterlyFormSubmit);

            // Event delegation for the compensation grid
            const gridBody = document.querySelector('#compensation-grid-table tbody');
            gridBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (!row || !row.dataset.beneficiaryId) return;
                const beneficiaryId = parseInt(row.dataset.beneficiaryId);

                if (e.target.closest('.edit-btn-inline')) {
                    openBeneficiaryModal(beneficiaryId);
                } else if (e.target.closest('.delete-btn-inline')) {
                    deleteBeneficiary(beneficiaryId);
                } else if (e.target.closest('.editable-cell')) {
                    const quarterIndex = parseInt(e.target.closest('.editable-cell').dataset.quarter);
                    openQuarterlyModal(beneficiaryId, quarterIndex);
                } else if (e.target.closest('.save-equipment-btn') || e.target.closest('.save-manual-btn')) {
                    processAndSaveRow(row);
                }
            });
            gridBody.addEventListener('change', (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                
                // الحفظ التلقائي مفعل دائماً
                processAndSaveRow(row);
            });
            
            // Initialize Creative Features
            initCreativeFeatures();
        });

        // ============================================
        // ========== CREATIVE FEATURES JS ===========
        // ============================================

        // --- Live Clock ---
        function updateLiveClock() {
            const now = new Date();
            const timeElement = document.getElementById('live-time');
            const dateElement = document.getElementById('live-date');
            
            if (timeElement && dateElement) {
                // Time format
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}:${seconds}`;
                
                // Arabic date
                const arabicDays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                const arabicMonths = ['جانفي', 'فيفري', 'مارس', 'أفريل', 'ماي', 'جوان', 
                                      'جويلية', 'أوت', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                
                dateElement.textContent = `${arabicDays[now.getDay()]} ${now.getDate()} ${arabicMonths[now.getMonth()]} ${now.getFullYear()}`;
            }
        }

        // --- Smart Assistant System ---
        const SmartAssistant = {
            // === Core State ===
            panel: null, body: null, fab: null, badge: null, isOpen: false, isFullscreen: false,
            currentSection: 'compensation-management-section',
            currentTab: 'chat',
            shownTips: new Set(JSON.parse(localStorage.getItem('shownAssistantTips') || '[]')),
            activityLog: JSON.parse(localStorage.getItem('assistantActivityLog') || '[]'),
            commandPaletteVisible: false,
            selectedCommandIndex: -1,
            moodAvatar: null,
            statusText: null,

            // === Commands Registry ===
            commands: [
                { name: '/مستفيدين', desc: 'عرض عدد المستفيدين', icon: 'fas fa-users', action: 'cmdBeneficiaryCount' },
                { name: '/اعتماد', desc: 'عرض حالة الاعتماد المالي', icon: 'fas fa-money-bill-wave', action: 'cmdBudgetStatus' },
                { name: '/حفظ', desc: 'حفظ جميع البيانات', icon: 'fas fa-save', action: 'cmdSave' },
                { name: '/تصدير', desc: 'تصدير البيانات', icon: 'fas fa-file-export', action: 'cmdExport' },
                { name: '/نسخة', desc: 'إنشاء نسخة احتياطية', icon: 'fas fa-database', action: 'cmdBackup' },
                { name: '/فحص', desc: 'فحص صحة البيانات', icon: 'fas fa-heartbeat', action: 'cmdHealthCheck' },
                { name: '/حاسبة', desc: 'فتح الحاسبة المدمجة', icon: 'fas fa-calculator', action: 'cmdCalculator' },
                { name: '/انتقال', desc: 'الانتقال لقسم محدد', icon: 'fas fa-arrow-right', action: 'cmdNavigate' },
                { name: '/نظام', desc: 'تبديل نظام العمل', icon: 'fas fa-exchange-alt', action: 'cmdSwitchMode' },
                { name: '/سجل', desc: 'عرض سجل النشاطات', icon: 'fas fa-history', action: 'cmdShowLog' },
                { name: '/مسح', desc: 'مسح المحادثة', icon: 'fas fa-broom', action: 'cmdClear' },
                { name: '/مساعدة', desc: 'عرض جميع الأوامر', icon: 'fas fa-question-circle', action: 'cmdHelp' },
                { name: '/بحث', desc: 'البحث عن مستفيد بالاسم', icon: 'fas fa-search', action: 'cmdSearch' },
                { name: '/ترتيب', desc: 'ترتيب المستفيدين حسب المبالغ', icon: 'fas fa-sort-amount-down', action: 'cmdRanking' },
                { name: '/جلسة', desc: 'إحصائيات جلسة العمل', icon: 'fas fa-clock', action: 'cmdSession' },
                { name: '/نسبة', desc: 'حساب نسبة مئوية', icon: 'fas fa-percentage', action: 'cmdPercentage' },
                { name: '/مكرر', desc: 'الكشف عن CCP مكررة', icon: 'fas fa-clone', action: 'cmdDuplicates' },
            ],

            // === Initialization ===
            init() {
                this.panel = document.getElementById('assistant-panel');
                this.body = document.getElementById('assistant-body');
                this.fab = document.getElementById('assistant-fab');
                this.badge = document.getElementById('assistant-badge');
                this.moodAvatar = document.getElementById('assistant-mood-avatar');
                this.statusText = document.getElementById('assistant-status-text');
                this.chatInput = document.getElementById('assistant-chat-input');
                this.sendBtn = document.getElementById('assistant-send-btn');
                this.suggestionsEl = document.getElementById('assistant-suggestions');

                // FAB click
                this.fab.addEventListener('click', () => this.toggle());
                document.getElementById('assistant-close').addEventListener('click', () => this.close());

                // Header actions
                document.getElementById('assistant-minimize').addEventListener('click', () => this.close());
                document.getElementById('assistant-fullscreen').addEventListener('click', () => this.toggleFullscreen());

                // Tab switching
                document.querySelectorAll('.assistant-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Quick action buttons
                document.querySelectorAll('.quick-help-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const type = btn.dataset.help;
                        if (type === 'overview') this.showOverview();
                        else if (type === 'current') this.showSectionHelp(this.currentSection);
                        else if (type === 'shortcuts') this.showShortcuts();
                        else if (type === 'tips') this.showProTips();
                        else if (type === 'analyze') this.showDataAnalysis();
                        else if (type === 'validate') this.showDataValidation();
                    });
                });

                // Chat input
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); this.handleChatInput(); }
                    else if (e.key === 'ArrowDown' && this.commandPaletteVisible) { e.preventDefault(); this.navigateCommand(1); }
                    else if (e.key === 'ArrowUp' && this.commandPaletteVisible) { e.preventDefault(); this.navigateCommand(-1); }
                    else if (e.key === 'Escape') this.hideCommandPalette();
                });
                this.chatInput.addEventListener('input', () => this.onChatInputChange());
                this.sendBtn.addEventListener('click', () => this.handleChatInput());

                // Show welcome on first visit
                if (!localStorage.getItem('assistantWelcomed')) {
                    setTimeout(() => this.showWelcome(), 800);
                } else {
                    this.badge.classList.add('hidden');
                }

                // Auto-show section tips
                this.observeSectionChanges();

                // Listen for key events
                this.listenForActions();

                // Log init
                this.logActivity('تشغيل', 'تم تشغيل المساعد الذكي');

                // Auto-suggestions after a delay
                setTimeout(() => this.showContextualSuggestions(), 2000);

                // Bind real keyboard shortcuts
                this.bindKeyboardShortcuts();

                // Session tracking
                this.sessionStart = Date.now();
                this.sessionActions = 0;

                // Auto-save reminder (every 5 min)
                this.startAutoReminder();

                // Idle detection (after 10 min of no activity)
                this.lastActivity = Date.now();
                this.idleTimer = null;
                this.startIdleDetection();

                // Notification queue
                this._notifQueue = [];

                // Chat history persistence
                this.loadChatHistory();
            },

            // === Tab System ===
            switchTab(tabId) {
                this.currentTab = tabId;
                document.querySelectorAll('.assistant-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.assistant-tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.assistant-tab[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');

                if (tabId === 'analytics') this.renderAnalytics();
                else if (tabId === 'tools') this.renderTools();
                else if (tabId === 'health') this.renderHealthCheck();
            },

            // === Toggle & Fullscreen ===
            toggle() { this.isOpen ? this.close() : this.open(); },
            open() {
                this.isOpen = true;
                this.fab.style.display = 'none';
                this.panel.classList.add('open');
                this.badge.classList.add('hidden');
                if (this.body.children.length === 0) this.showGreeting();
                if (this._pendingNotification) {
                    this.addMessage(`<i class="fas fa-bell"></i> ${this._pendingNotification.message}`, this._pendingNotification.type);
                    this._pendingNotification = null;
                }
                this.setMood('happy');
                this.chatInput.focus();
            },
            close() {
                this.isOpen = false;
                this.panel.classList.remove('open');
                this.panel.classList.remove('fullscreen');
                this.isFullscreen = false;
                this.fab.style.display = '';
            },
            toggleFullscreen() {
                this.isFullscreen = !this.isFullscreen;
                this.panel.classList.toggle('fullscreen', this.isFullscreen);
                const icon = document.querySelector('#assistant-fullscreen i');
                icon.className = this.isFullscreen ? 'fas fa-compress' : 'fas fa-expand';
            },

            // === Mood System ===
            setMood(mood) {
                if (!this.moodAvatar) return;
                this.moodAvatar.className = 'assistant-header-avatar';
                if (mood !== 'default') this.moodAvatar.classList.add(`mood-${mood}`);
                const statusTexts = {
                    happy: 'متصل وسعيد 😊',
                    thinking: 'يفكر... 🤔',
                    alert: 'تنبيه! ⚠️',
                    celebrate: 'يحتفل! 🎉',
                    default: 'متصل ونشط'
                };
                if (this.statusText) this.statusText.textContent = statusTexts[mood] || statusTexts.default;
            },

            // === Message System ===
            addMessage(html, type = 'bot', animate = true) {
                const msg = document.createElement('div');
                msg.className = `assistant-msg ${type}`;
                if (animate) msg.style.animation = 'msgFadeIn 0.4s ease-out';
                msg.innerHTML = html;
                this.body.appendChild(msg);
                this.body.scrollTop = this.body.scrollHeight;
                // Auto-save chat history
                if (typeof this.saveChatHistory === 'function') {
                    clearTimeout(this._saveDebounce);
                    this._saveDebounce = setTimeout(() => this.saveChatHistory(), 1000);
                }
                return msg;
            },
            addUserMessage(text) {
                this.addMessage(`<i class="fas fa-user"></i> ${text}`, 'user');
            },
            addTypingIndicator() {
                const typing = document.createElement('div');
                typing.className = 'typing-indicator';
                typing.id = 'typing-indicator';
                typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
                this.body.appendChild(typing);
                this.body.scrollTop = this.body.scrollHeight;
                return typing;
            },
            removeTypingIndicator() {
                const el = document.getElementById('typing-indicator');
                if (el) el.remove();
            },
            clearMessages() { this.body.innerHTML = ''; },

            // === Typing Effect ===
            async typeMessage(html, type = 'bot') {
                this.setMood('thinking');
                const typing = this.addTypingIndicator();
                await this.delay(600 + Math.random() * 400);
                typing.remove();
                this.setMood('happy');
                return this.addMessage(html, type);
            },
            delay(ms) { return new Promise(r => setTimeout(r, ms)); },

            // === Chat Input Handler ===
            handleChatInput() {
                const text = this.chatInput.value.trim();
                if (!text) return;
                this.chatInput.value = '';
                this.hideCommandPalette();
                this.hideSuggestions();

                // If it's a command
                if (text.startsWith('/')) {
                    const cmd = this.commands.find(c => text.startsWith(c.name));
                    if (cmd) {
                        this.addUserMessage(text);
                        this[cmd.action](text.replace(cmd.name, '').trim());
                        return;
                    }
                }

                // Regular chat - process with NLP
                this.addUserMessage(text);
                this.processNaturalLanguage(text);
            },

            // === Natural Language Processing ===
            async processNaturalLanguage(text) {
                const lower = text.toLowerCase();

                // Greeting patterns
                if (/^(مرحبا|سلام|أهلا|هلا|صباح|مساء|أكتب\s*لك|كيف حالك)/i.test(lower)) {
                    const responses = [
                        'أهلاً وسهلاً! 😊 كيف يمكنني مساعدتك اليوم؟',
                        'مرحباً بك! أنا جاهز لخدمتك. ما الذي تحتاجه؟',
                        'أهلاً! يسعدني التحدث معك. هل تحتاج مساعدة في شيء؟'
                    ];
                    await this.typeMessage(`<i class="fas fa-hand-sparkles"></i> ${responses[Math.floor(Math.random() * responses.length)]}`);
                    return;
                }

                // Beneficiary queries
                if (/مستفيد|مستفيدين|موظف|عامل|بينيفيسيار/i.test(lower)) {
                    if (/كم|عدد|عدة|كام/i.test(lower)) {
                        await this.typeMessage(this.getBeneficiaryStats());
                        return;
                    }
                    if (/أضف|إضافة|اضافة|جديد|سجل/i.test(lower)) {
                        await this.typeMessage(`
                            <i class="fas fa-user-plus"></i> <strong>لإضافة مستفيد جديد:</strong><br>
                            اضغط على زر "إضافة مستفيد جديد" في قسم إدارة التعويضات، أو يمكنني فعل ذلك لك الآن!
                            <div style="margin-top:8px">
                                <button class="msg-action-btn" onclick="document.getElementById('add-beneficiary-btn').click(); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> تم فتح نافذة إضافة المستفيد!', 'success');">
                                    <i class="fas fa-plus"></i> إضافة مستفيد الآن
                                </button>
                            </div>
                        `);
                        return;
                    }
                    if (/بحث|ابحث|أين|وين/i.test(lower)) {
                        await this.typeMessage(`
                            <i class="fas fa-search"></i> <strong>للبحث عن مستفيد:</strong><br>
                            استخدم حقل البحث في قسم إدارة التعويضات. يمكنك البحث بالاسم أو رقم الحساب CCP.
                            <div style="margin-top:8px">
                                <button class="msg-action-btn" onclick="showSection('compensation-management-section'); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> تم الانتقال لقسم إدارة التعويضات', 'success');">
                                    <i class="fas fa-arrow-right"></i> الانتقال للبحث
                                </button>
                            </div>
                        `);
                        return;
                    }
                }

                // Budget / Credit queries
                if (/اعتماد|ميزانية|رصيد|متبقي|مصروف|credit|budget/i.test(lower)) {
                    this.cmdBudgetStatus();
                    return;
                }

                // Export queries
                if (/تصدير|اكسل|excel|xlsx|txt|طباعة|تقرير|report/i.test(lower)) {
                    await this.typeMessage(`
                        <span class="msg-title"><i class="fas fa-file-export"></i> خيارات التصدير</span>
                        اختر نوع التصدير المطلوب:
                        <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
                            <button class="msg-action-btn" onclick="printReport(); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> جارٍ إعداد التقرير للطباعة...', 'success');">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                            <button class="msg-action-btn" onclick="exportXLSX(); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> جارٍ تصدير XLSX...', 'success');">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="msg-action-btn" onclick="exportTxt(); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> جارٍ تصدير TXT...', 'success');">
                                <i class="fas fa-file-alt"></i> TXT
                            </button>
                        </div>
                    `);
                    return;
                }

                // Save
                if (/حفظ|احفظ|save/i.test(lower)) {
                    this.cmdSave();
                    return;
                }

                // Backup
                if (/نسخ|نسخة|احتياط|backup/i.test(lower)) {
                    this.cmdBackup();
                    return;
                }

                // Calculator
                if (/حاسبة|احسب|حساب|كم يساوي|ضرب|جمع|طرح|قسمة|calculator/i.test(lower)) {
                    // Try to extract a math expression
                    const mathMatch = text.match(/[\d\+\-\*\/\.\(\)\s]+/);
                    if (mathMatch && mathMatch[0].trim().length > 1) {
                        this.cmdCalculatorEval(mathMatch[0].trim());
                        return;
                    }
                    this.cmdCalculator();
                    return;
                }

                // Navigation
                if (/انتقل|اذهب|روح|فتح|قسم|واجهة|صفحة/i.test(lower)) {
                    if (/مؤسسة|مؤسس|معلومات/i.test(lower)) {
                        showSection('institution-info-section');
                        await this.typeMessage('<i class="fas fa-check"></i> تم الانتقال إلى قسم <strong>معلومات المؤسسة</strong>.', 'success');
                        return;
                    }
                    if (/تعويض|إدارة|ادارة|مستفيد/i.test(lower)) {
                        showSection('compensation-management-section');
                        await this.typeMessage('<i class="fas fa-check"></i> تم الانتقال إلى قسم <strong>إدارة التعويضات</strong>.', 'success');
                        return;
                    }
                    if (/تقارير|تقرير|تصدير/i.test(lower)) {
                        showSection('reporting-section');
                        await this.typeMessage('<i class="fas fa-check"></i> تم الانتقال إلى قسم <strong>التقارير</strong>.', 'success');
                        return;
                    }
                    if (/نسخ|احتياط/i.test(lower)) {
                        showSection('backup-restore-section');
                        await this.typeMessage('<i class="fas fa-check"></i> تم الانتقال إلى قسم <strong>النسخ الاحتياطي</strong>.', 'success');
                        return;
                    }
                    if (/تعديل|محرر|txt|احتراف/i.test(lower)) {
                        showSection('pro-txt-editor-section');
                        await this.typeMessage('<i class="fas fa-check"></i> تم الانتقال إلى <strong>المحرر الاحترافي</strong>.', 'success');
                        return;
                    }
                    this.cmdNavigate();
                    return;
                }

                // Help
                if (/مساعد|ساعد|help|شرح|كيف|ازاي|كيفية|طريقة/i.test(lower)) {
                    await this.typeMessage(`
                        <span class="msg-title"><i class="fas fa-life-ring"></i> كيف يمكنني مساعدتك؟</span>
                        يمكنك:
                        <ul class="step-list">
                            <li><span class="step-num"><i class="fas fa-comment" style="font-size:0.6em"></i></span> كتابة سؤالك بلغة طبيعية</li>
                            <li><span class="step-num"><i class="fas fa-terminal" style="font-size:0.6em"></i></span> استخدام الأوامر (اكتب <strong>/</strong> لرؤية القائمة)</li>
                            <li><span class="step-num"><i class="fas fa-mouse-pointer" style="font-size:0.6em"></i></span> الضغط على الأزرار السريعة أدناه</li>
                            <li><span class="step-num"><i class="fas fa-chart-pie" style="font-size:0.6em"></i></span> استعراض التحليلات والأدوات من التبويبات</li>
                        </ul>
                    `);
                    return;
                }

                // Health / validation
                if (/فحص|أخطاء|مشاكل|صحة|تحقق|check|valid/i.test(lower)) {
                    this.cmdHealthCheck();
                    return;
                }

                // Mode switch
                if (/نظام|وضع|كهرباء|غاز|تجهيز|نقل|تنقل|تكوين/i.test(lower)) {
                    if (/كهرباء|غاز/i.test(lower)) {
                        selectMode('electricity');
                        await this.typeMessage('<i class="fas fa-bolt"></i> تم التبديل إلى نظام <strong>الكهرباء والغاز</strong>.', 'success');
                        return;
                    }
                    if (/تجهيز/i.test(lower)) {
                        selectMode('equipment');
                        await this.typeMessage('<i class="fas fa-chair"></i> تم التبديل إلى نظام <strong>منحة التجهيز</strong>.', 'success');
                        return;
                    }
                    if (/نقل|تنقل/i.test(lower)) {
                        selectMode('transport');
                        await this.typeMessage('<i class="fas fa-bus"></i> تم التبديل إلى نظام <strong>مصاريف التنقل</strong>.', 'success');
                        return;
                    }
                    if (/تكوين/i.test(lower)) {
                        selectMode('training');
                        await this.typeMessage('<i class="fas fa-chalkboard-teacher"></i> تم التبديل إلى نظام <strong>العمليات التكوينية</strong>.', 'success');
                        return;
                    }
                }

                // Search
                if (/بحث\s*عن|ابحث\s*عن|اسم\s*(مستفيد)?|وين\s*(مستفيد)?|أين\s*(مستفيد)?|search/i.test(lower)) {
                    const nameMatch = text.match(/(?:بحث\s*عن|ابحث\s*عن|اسم\s*مستفيد?\s*|وين\s*مستفيد?\s*|أين\s*مستفيد?\s*|search\s*)(.+)/i);
                    const q = nameMatch ? nameMatch[1].trim() : '';
                    await this.cmdSearch(q);
                    return;
                }

                // Ranking
                if (/ترتيب|أعلى\s*تعويض|أكبر\s*مبلغ|أكثر\s*مستفيد|ranking|top/i.test(lower)) {
                    await this.cmdRanking();
                    return;
                }

                // Session / time
                if (/جلسة|وقت\s*العمل|مدة|كم\s*وقت|session|timer/i.test(lower)) {
                    await this.cmdSession();
                    return;
                }

                // Percentage
                if (/نسبة|بالم[ئي]ة|percentage|%\s*من/i.test(lower)) {
                    const pctMatch = text.match(/([\d.]+)\s*(?:بالم[ئي]ة\s*)?(?:من|%\s*من)\s*([\d.]+)/i);
                    if (pctMatch) {
                        await this.cmdPercentage(`${pctMatch[1]} من ${pctMatch[2]}`);
                    } else {
                        await this.cmdPercentage('');
                    }
                    return;
                }

                // Duplicates
                if (/مكرر|مكررة|تكرار|مزدوج|duplicate/i.test(lower)) {
                    await this.cmdDuplicates();
                    return;
                }

                // Thank you
                if (/شكر|شكرا|ممتاز|رائع|حلو|جميل|thank/i.test(lower)) {
                    this.setMood('celebrate');
                    const replies = [
                        'العفو! يسعدني مساعدتك دائماً 😊',
                        'لا شكر على واجب! أنا هنا لخدمتك 🌟',
                        'شكراً لك أنت! تواصلك يسعدني 💚'
                    ];
                    await this.typeMessage(`<i class="fas fa-heart"></i> ${replies[Math.floor(Math.random() * replies.length)]}`);
                    setTimeout(() => this.setMood('happy'), 2000);
                    return;
                }

                // Default - try to be helpful
                await this.typeMessage(`
                    <i class="fas fa-robot"></i> لم أتمكن من فهم طلبك بدقة، لكن يمكنني مساعدتك في:
                    <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
                        <button class="msg-action-btn" onclick="SmartAssistant.showOverview()"><i class="fas fa-info-circle"></i> نظرة عامة</button>
                        <button class="msg-action-btn" onclick="SmartAssistant.showSectionHelp(SmartAssistant.currentSection)"><i class="fas fa-crosshairs"></i> مساعدة القسم</button>
                        <button class="msg-action-btn" onclick="SmartAssistant.cmdHelp()"><i class="fas fa-terminal"></i> الأوامر</button>
                    </div>
                    <small style="color:#94a3b8; display:block; margin-top:6px;">💡 جرب كتابة <strong>/</strong> لرؤية قائمة الأوامر المتاحة</small>
                `);
            },

            // === Command Palette ===
            onChatInputChange() {
                const text = this.chatInput.value;
                if (text.startsWith('/')) {
                    const filter = text.slice(1);
                    const matches = this.commands.filter(c => c.name.includes(filter) || c.desc.includes(filter));
                    this.showCommandPalette(matches);
                } else {
                    this.hideCommandPalette();
                }
            },
            showCommandPalette(commands) {
                let palette = document.querySelector('.command-palette');
                if (!palette) {
                    palette = document.createElement('div');
                    palette.className = 'command-palette';
                    document.querySelector('.assistant-chat-input-area').style.position = 'relative';
                    document.querySelector('.assistant-chat-input-area').appendChild(palette);
                }
                if (commands.length === 0) { palette.classList.remove('visible'); return; }
                palette.innerHTML = commands.map((cmd, i) => `
                    <div class="command-item ${i === this.selectedCommandIndex ? 'selected' : ''}" data-index="${i}" onclick="SmartAssistant.selectCommand(${i})">
                        <i class="${cmd.icon}"></i>
                        <div>
                            <div class="cmd-name">${cmd.name}</div>
                            <div class="cmd-desc">${cmd.desc}</div>
                        </div>
                    </div>
                `).join('');
                palette.classList.add('visible');
                this.commandPaletteVisible = true;
                this._paletteCommands = commands;
            },
            hideCommandPalette() {
                const palette = document.querySelector('.command-palette');
                if (palette) palette.classList.remove('visible');
                this.commandPaletteVisible = false;
                this.selectedCommandIndex = -1;
            },
            navigateCommand(dir) {
                if (!this._paletteCommands) return;
                this.selectedCommandIndex = Math.max(-1, Math.min(this._paletteCommands.length - 1, this.selectedCommandIndex + dir));
                if (this.selectedCommandIndex >= 0) {
                    this.chatInput.value = this._paletteCommands[this.selectedCommandIndex].name + ' ';
                }
                this.showCommandPalette(this._paletteCommands);
            },
            selectCommand(index) {
                if (this._paletteCommands && this._paletteCommands[index]) {
                    this.chatInput.value = this._paletteCommands[index].name + ' ';
                    this.hideCommandPalette();
                    this.chatInput.focus();
                }
            },

            // === Contextual Suggestions ===
            showContextualSuggestions() {
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                const suggestions = [];
                if (bCount === 0) {
                    suggestions.push({ text: 'كيف أضيف مستفيد؟', query: 'كيف أضيف مستفيد جديد' });
                    suggestions.push({ text: 'نظرة عامة', query: '/مساعدة' });
                } else {
                    suggestions.push({ text: `تحليل ${bCount} مستفيد`, query: '/فحص' });
                    suggestions.push({ text: 'حالة الاعتماد', query: '/اعتماد' });
                    suggestions.push({ text: 'تصدير البيانات', query: 'تصدير' });
                }
                suggestions.push({ text: 'اختصارات', query: 'اختصارات' });
                this.updateSuggestions(suggestions);
            },
            updateSuggestions(suggestions) {
                if (!this.suggestionsEl) return;
                this.suggestionsEl.innerHTML = suggestions.map(s =>
                    `<button class="suggestion-chip" onclick="SmartAssistant.chatInput.value='${s.query}'; SmartAssistant.handleChatInput();">${s.text}</button>`
                ).join('');
                if (suggestions.length > 0) this.suggestionsEl.classList.add('visible');
            },
            hideSuggestions() {
                if (this.suggestionsEl) this.suggestionsEl.classList.remove('visible');
            },

            // === Command Implementations ===
            async cmdBeneficiaryCount() {
                const msg = this.getBeneficiaryStats();
                await this.typeMessage(msg);
            },
            getBeneficiaryStats() {
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                const cCount = typeof compensations !== 'undefined' ? compensations.length : 0;
                if (bCount === 0) {
                    return '<i class="fas fa-users"></i> لا يوجد مستفيدون مسجلون حالياً. أضف مستفيداً للبدء!';
                }
                let totalNet = 0;
                if (typeof compensations !== 'undefined') {
                    compensations.forEach(c => { totalNet += (c.netPayable || 0); });
                }
                return `
                    <span class="msg-title"><i class="fas fa-users"></i> إحصائيات المستفيدين</span>
                    <div class="calc-result-card">
                        <div class="calc-result-label">إجمالي المستفيدين</div>
                        <div class="calc-result-value">${bCount}</div>
                        <div class="calc-result-details">
                            <span class="calc-detail-item"><i class="fas fa-file-invoice-dollar"></i> ${cCount} تعويض مسجل</span>
                            <span class="calc-detail-item"><i class="fas fa-money-bill"></i> ${typeof formatCurrency==='function' ? formatCurrency(totalNet) : totalNet.toFixed(2)} دج إجمالي</span>
                        </div>
                    </div>
                `;
            },

            async cmdBudgetStatus() {
                this.setMood('thinking');
                const credit = typeof institutionInfo !== 'undefined' ? (parseFloat(institutionInfo.openCredit) || 0) : 0;
                let totalSpent = 0;
                if (typeof compensations !== 'undefined') {
                    compensations.forEach(c => { totalSpent += (c.netPayable || 0); });
                }
                const remaining = credit - totalSpent;
                const pct = credit > 0 ? ((totalSpent / credit) * 100) : 0;
                const barColor = pct > 90 ? 'red' : pct > 70 ? 'orange' : 'green';

                if (pct > 90) this.setMood('alert');
                else this.setMood('happy');

                await this.typeMessage(`
                    <span class="msg-title"><i class="fas fa-money-bill-wave"></i> حالة الاعتماد المالي</span>
                    <div class="calc-result-card">
                        <div class="calc-result-details" style="margin:0 0 8px">
                            <span class="calc-detail-item"><i class="fas fa-wallet"></i> الاعتماد: ${typeof formatCurrency==='function' ? formatCurrency(credit) : credit.toFixed(2)} دج</span>
                        </div>
                        <div class="calc-result-details">
                            <span class="calc-detail-item"><i class="fas fa-arrow-up" style="color:#ef4444"></i> مصروف: ${typeof formatCurrency==='function' ? formatCurrency(totalSpent) : totalSpent.toFixed(2)} دج</span>
                            <span class="calc-detail-item"><i class="fas fa-arrow-down" style="color:#22c55e"></i> متبقي: ${typeof formatCurrency==='function' ? formatCurrency(remaining) : remaining.toFixed(2)} دج</span>
                        </div>
                        <div class="analytics-mini-chart" style="margin-top:10px">
                            <div class="analytics-mini-chart-fill ${barColor}" style="width:${Math.min(pct, 100)}%"></div>
                        </div>
                        <div style="text-align:center; margin-top:4px; font-size:0.75em; color:#64748b">${pct.toFixed(1)}% مستهلك</div>
                    </div>
                    ${remaining < 0 ? '<div style="margin-top:8px; color:#ef4444; font-weight:600"><i class="fas fa-exclamation-triangle"></i> تحذير: تم تجاوز الاعتماد المفتوح!</div>' : ''}
                `);
            },

            async cmdSave() {
                const saveBtn = document.querySelector('.save-btn');
                if (saveBtn) saveBtn.click();
                if (typeof saveData === 'function') saveData();
                this.setMood('celebrate');
                await this.typeMessage('<i class="fas fa-check-circle"></i> تم حفظ جميع البيانات بنجاح! 💾', 'success');
                this.logActivity('حفظ', 'تم حفظ البيانات عبر المساعد');
                setTimeout(() => this.setMood('happy'), 1500);
            },

            async cmdExport() {
                await this.typeMessage(`
                    <span class="msg-title"><i class="fas fa-file-export"></i> تصدير البيانات</span>
                    اختر صيغة التصدير:
                    <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
                        <button class="msg-action-btn" onclick="printReport(); SmartAssistant.logActivity('تصدير', 'طباعة تقرير');">
                            <i class="fas fa-print"></i> طباعة تقرير
                        </button>
                        <button class="msg-action-btn" onclick="exportXLSX(); SmartAssistant.logActivity('تصدير', 'تصدير XLSX');">
                            <i class="fas fa-file-excel"></i> ملف Excel
                        </button>
                        <button class="msg-action-btn" onclick="exportTxt(); SmartAssistant.logActivity('تصدير', 'تصدير TXT');">
                            <i class="fas fa-file-alt"></i> ملف TXT
                        </button>
                    </div>
                `);
            },

            async cmdBackup() {
                const btn = document.getElementById('create-backup-btn');
                if (btn) btn.click();
                this.setMood('celebrate');
                await this.typeMessage('<i class="fas fa-database"></i> تم إنشاء نسخة احتياطية! 📦 احفظها في مكان آمن.', 'success');
                this.logActivity('نسخ احتياطي', 'تم إنشاء نسخة احتياطية');
                setTimeout(() => this.setMood('happy'), 1500);
            },

            async cmdHealthCheck() {
                this.switchTab('health');
            },

            async cmdCalculator() {
                await this.typeMessage(`
                    <span class="msg-title"><i class="fas fa-calculator"></i> الحاسبة المدمجة</span>
                    اكتب عملية حسابية للحساب. أمثلة:
                    <ul class="step-list">
                        <li><span class="step-num"><i class="fas fa-plus" style="font-size:0.6em"></i></span> <code>1500 + 2300</code></li>
                        <li><span class="step-num"><i class="fas fa-percent" style="font-size:0.6em"></i></span> <code>12500 * 0.5</code> (حساب 50%)</li>
                        <li><span class="step-num"><i class="fas fa-divide" style="font-size:0.6em"></i></span> <code>(3500 + 2100) / 4</code></li>
                    </ul>
                    <small style="color:#94a3b8">💡 يمكنك كتابة "احسب 1500+2300" مباشرة</small>
                `);
            },
            async cmdCalculatorEval(expr) {
                try {
                    const sanitized = expr.replace(/[^0-9\+\-\*\/\.\(\)\s]/g, '');
                    const result = Function('"use strict"; return (' + sanitized + ')')();
                    await this.typeMessage(`
                        <i class="fas fa-calculator"></i> <strong>نتيجة الحساب:</strong>
                        <div class="calc-result-card">
                            <div class="calc-result-label">${sanitized}</div>
                            <div class="calc-result-value">${typeof formatCurrency === 'function' ? formatCurrency(result) : result.toFixed(2)}</div>
                        </div>
                    `);
                } catch(e) {
                    await this.typeMessage('<i class="fas fa-exclamation-circle"></i> لم أتمكن من حساب هذه العملية. تأكد من صحة الصيغة.', 'warning');
                }
            },

            async cmdNavigate() {
                await this.typeMessage(`
                    <span class="msg-title"><i class="fas fa-compass"></i> الانتقال السريع</span>
                    اختر القسم المطلوب:
                    <div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">
                        <button class="msg-action-btn" onclick="showSection('institution-info-section'); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> تم الانتقال', 'success');">
                            <i class="fas fa-building"></i> معلومات المؤسسة
                        </button>
                        <button class="msg-action-btn" onclick="showSection('compensation-management-section'); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> تم الانتقال', 'success');">
                            <i class="fas fa-users"></i> إدارة التعويضات
                        </button>
                        <button class="msg-action-btn" onclick="showSection('reporting-section'); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> تم الانتقال', 'success');">
                            <i class="fas fa-file-alt"></i> التقارير والتصدير
                        </button>
                        <button class="msg-action-btn" onclick="showSection('pro-txt-editor-section'); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> تم الانتقال', 'success');">
                            <i class="fas fa-edit"></i> المحرر الاحترافي
                        </button>
                        <button class="msg-action-btn" onclick="showSection('backup-restore-section'); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> تم الانتقال', 'success');">
                            <i class="fas fa-database"></i> النسخ الاحتياطي
                        </button>
                    </div>
                `);
            },

            async cmdSwitchMode() {
                await this.typeMessage(`
                    <span class="msg-title"><i class="fas fa-exchange-alt"></i> تبديل نظام العمل</span>
                    <div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">
                        <button class="msg-action-btn" onclick="selectMode('electricity'); SmartAssistant.addMessage('<i class=\\'fas fa-bolt\\'></i> تم التبديل إلى الكهرباء والغاز', 'success');">
                            <i class="fas fa-bolt"></i> الكهرباء والغاز
                        </button>
                        <button class="msg-action-btn" onclick="selectMode('equipment'); SmartAssistant.addMessage('<i class=\\'fas fa-chair\\'></i> تم التبديل إلى منحة التجهيز', 'success');">
                            <i class="fas fa-chair"></i> منحة التجهيز
                        </button>
                        <button class="msg-action-btn" onclick="selectMode('transport'); SmartAssistant.addMessage('<i class=\\'fas fa-bus\\'></i> تم التبديل إلى مصاريف التنقل', 'success');">
                            <i class="fas fa-bus"></i> مصاريف التنقل
                        </button>
                        <button class="msg-action-btn" onclick="selectMode('training'); SmartAssistant.addMessage('<i class=\\'fas fa-chalkboard-teacher\\'></i> تم التبديل إلى العمليات التكوينية', 'success');">
                            <i class="fas fa-chalkboard-teacher"></i> العمليات التكوينية
                        </button>
                    </div>
                `);
            },

            async cmdShowLog() {
                if (this.activityLog.length === 0) {
                    await this.typeMessage('<i class="fas fa-history"></i> لا توجد نشاطات مسجلة بعد.');
                    return;
                }
                const recentLogs = this.activityLog.slice(-10).reverse();
                let html = '<span class="msg-title"><i class="fas fa-history"></i> سجل النشاطات الأخيرة</span>';
                recentLogs.forEach(log => {
                    html += `<div class="activity-log-entry">
                        <i class="fas fa-circle" style="font-size:0.4em"></i>
                        <span>${log.action}: ${log.detail}</span>
                        <span class="log-time">${log.time}</span>
                    </div>`;
                });
                await this.typeMessage(html);
            },

            async cmdClear() {
                this.clearMessages();
                await this.typeMessage('<i class="fas fa-broom"></i> تم مسح المحادثة. كيف يمكنني مساعدتك؟');
            },

            async cmdHelp() {
                let html = '<span class="msg-title"><i class="fas fa-terminal"></i> قائمة الأوامر المتاحة</span>';
                html += '<div style="display:flex; flex-direction:column; gap:4px; margin-top:8px;">';
                this.commands.forEach(cmd => {
                    html += `<div class="command-item" onclick="SmartAssistant.chatInput.value='${cmd.name} '; SmartAssistant.handleChatInput();" style="cursor:pointer; border-radius:8px; padding:8px 10px;">
                        <i class="${cmd.icon}"></i>
                        <div>
                            <div class="cmd-name">${cmd.name}</div>
                            <div class="cmd-desc">${cmd.desc}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
                await this.typeMessage(html);
            },

            // === Keyboard Shortcuts ===
            bindKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    this.lastActivity = Date.now();
                    this.sessionActions++;

                    // F1 - Toggle assistant
                    if (e.key === 'F1') {
                        e.preventDefault();
                        this.toggle();
                        if (this.isOpen) { this.showSectionHelp(this.currentSection); }
                        return;
                    }
                    // Ctrl+/ - Toggle assistant
                    if (e.ctrlKey && e.key === '/') {
                        e.preventDefault();
                        this.toggle();
                        return;
                    }
                    // Ctrl+S - Save
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        const saveBtn = document.querySelector('.save-btn');
                        if (saveBtn) saveBtn.click();
                        if (typeof saveData === 'function') saveData();
                        localStorage.setItem('lastSaveTime', Date.now().toString());
                        this.notify('✅ تم الحفظ السريع (Ctrl+S)', 'success');
                        this.logActivity('حفظ', 'اختصار Ctrl+S');
                        return;
                    }
                    // Ctrl+P - Print
                    if (e.ctrlKey && e.key === 'p') {
                        e.preventDefault();
                        if (typeof printReport === 'function') printReport();
                        this.logActivity('طباعة', 'اختصار Ctrl+P');
                        return;
                    }
                    // Ctrl+E - Export Excel
                    if (e.ctrlKey && e.key === 'e') {
                        e.preventDefault();
                        if (typeof exportXLSX === 'function') exportXLSX();
                        this.notify('📊 جارٍ تصدير Excel...', 'tip');
                        this.logActivity('تصدير', 'اختصار Ctrl+E');
                        return;
                    }
                    // Ctrl+N - New beneficiary
                    if (e.ctrlKey && e.key === 'n') {
                        e.preventDefault();
                        const addBtn = document.getElementById('add-beneficiary-btn');
                        if (addBtn) addBtn.click();
                        this.logActivity('إضافة', 'اختصار Ctrl+N');
                        return;
                    }
                    // Ctrl+B - Backup
                    if (e.ctrlKey && e.key === 'b') {
                        e.preventDefault();
                        const backupBtn = document.getElementById('create-backup-btn');
                        if (backupBtn) backupBtn.click();
                        this.logActivity('نسخ احتياطي', 'اختصار Ctrl+B');
                        return;
                    }
                    // Escape - Close assistant
                    if (e.key === 'Escape' && this.isOpen) {
                        this.close();
                        return;
                    }
                });
            },

            // === Auto-Save Reminder ===
            startAutoReminder() {
                this._autoReminderInterval = setInterval(() => {
                    const lastSave = localStorage.getItem('lastSaveTime');
                    const now = Date.now();
                    if (!lastSave || (now - parseInt(lastSave)) > 300000) { // 5 min
                        this.notify('⏰ تذكير: لم تحفظ البيانات منذ فترة. اضغط <strong>Ctrl+S</strong> للحفظ.', 'warning');
                    }
                }, 300000); // every 5 minutes
            },

            // === Idle Detection ===
            startIdleDetection() {
                // Listen for any interaction
                ['click', 'keydown', 'mousemove', 'scroll'].forEach(evt => {
                    document.addEventListener(evt, () => {
                        this.lastActivity = Date.now();
                        if (this.idleTimer) { clearTimeout(this.idleTimer); }
                        this.idleTimer = setTimeout(() => this.onIdle(), 600000); // 10 min
                    }, { passive: true, once: false });
                });
                this.idleTimer = setTimeout(() => this.onIdle(), 600000);
            },
            onIdle() {
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                if (bCount > 0) {
                    this.notify('💤 يبدو أنك توقفت عن العمل. تذكّر إنشاء <strong>نسخة احتياطية</strong> قبل المغادرة.', 'warning');
                }
            },

            // === Chat History Persistence ===
            loadChatHistory() {
                try {
                    const saved = localStorage.getItem('assistantChatHistory');
                    if (saved) {
                        const msgs = JSON.parse(saved);
                        if (msgs.length > 0 && this.body.children.length === 0) {
                            // Show last 15 messages from previous session
                            msgs.slice(-15).forEach(m => {
                                const msg = document.createElement('div');
                                msg.className = `assistant-msg ${m.type}`;
                                msg.innerHTML = m.html;
                                this.body.appendChild(msg);
                            });
                            this.addMessage(`<i class="fas fa-history"></i> <small style="color:#94a3b8">تم استعادة آخر ${Math.min(msgs.length, 15)} رسالة من الجلسة السابقة</small>`, 'bot');
                        }
                    }
                } catch(e) {}
            },
            saveChatHistory() {
                try {
                    const msgs = [];
                    this.body.querySelectorAll('.assistant-msg').forEach(m => {
                        if (!m.querySelector('.typing-indicator')) {
                            msgs.push({ html: m.innerHTML, type: m.className.replace('assistant-msg ', '') });
                        }
                    });
                    localStorage.setItem('assistantChatHistory', JSON.stringify(msgs.slice(-30)));
                } catch(e) {}
            },

            // === Session Stats ===
            async cmdSession() {
                const elapsed = Date.now() - this.sessionStart;
                const minutes = Math.floor(elapsed / 60000);
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                const timeStr = hours > 0 ? `${hours} ساعة و ${mins} دقيقة` : `${mins} دقيقة`;
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                const logCount = this.activityLog.filter(l => l.timestamp > this.sessionStart).length;

                await this.typeMessage(`
                    <span class="msg-title"><i class="fas fa-clock"></i> إحصائيات جلسة العمل</span>
                    <div class="calc-result-card">
                        <div class="calc-result-label">مدة الجلسة</div>
                        <div class="calc-result-value">${timeStr}</div>
                        <div class="calc-result-details" style="margin-top:8px">
                            <span class="calc-detail-item"><i class="fas fa-mouse-pointer"></i> ${this.sessionActions} تفاعل</span>
                            <span class="calc-detail-item"><i class="fas fa-list-check"></i> ${logCount} عملية</span>
                            <span class="calc-detail-item"><i class="fas fa-users"></i> ${bCount} مستفيد</span>
                        </div>
                    </div>
                    <small style="color:#94a3b8; margin-top:6px; display:block">🕐 بداية الجلسة: ${new Date(this.sessionStart).toLocaleTimeString('ar-DZ')}</small>
                `);
            },

            // === Search Beneficiary ===
            async cmdSearch(query) {
                if (!query || query.trim() === '') {
                    await this.typeMessage(`
                        <i class="fas fa-search"></i> <strong>البحث عن مستفيد</strong><br>
                        اكتب <code>/بحث [الاسم]</code> للبحث. مثال:<br>
                        <code>/بحث Mohamed</code>
                    `);
                    return;
                }
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                if (bCount === 0) {
                    await this.typeMessage('<i class="fas fa-info-circle"></i> لا يوجد مستفيدون مسجلون.', 'warning');
                    return;
                }

                const q = query.toLowerCase();
                const results = beneficiaries.filter(b => {
                    const name = (b.name || '').toLowerCase();
                    const ccp = (b.ccp || '').toString();
                    return name.includes(q) || ccp.includes(q);
                });

                if (results.length === 0) {
                    await this.typeMessage(`<i class="fas fa-search"></i> لم يتم العثور على نتائج لـ "<strong>${query}</strong>".`, 'warning');
                    return;
                }

                const fmtCur = typeof formatCurrency === 'function' ? formatCurrency : (v) => v.toFixed(2);
                let html = `<span class="msg-title"><i class="fas fa-search"></i> نتائج البحث: "${query}"</span>`;
                html += `<div style="font-size:0.75em; color:#94a3b8; margin-bottom:8px">${results.length} نتيجة</div>`;
                results.slice(0, 10).forEach(b => {
                    const comp = typeof compensations !== 'undefined' ? compensations.find(c => c.beneficiaryId === b.id) : null;
                    const netPay = comp ? (comp.netPayable || 0) : 0;
                    html += `<div class="search-result-item">
                        <div class="search-result-name"><i class="fas fa-user"></i> ${b.name || 'بدون اسم'}</div>
                        <div class="search-result-details">
                            <span><i class="fas fa-id-card"></i> CCP: ${b.ccp || 'غير محدد'}</span>
                            <span><i class="fas fa-money-bill"></i> ${fmtCur(netPay)} دج</span>
                        </div>
                    </div>`;
                });
                if (results.length > 10) html += `<small style="color:#94a3b8">... و ${results.length - 10} نتائج أخرى</small>`;
                await this.typeMessage(html);
            },

            // === Beneficiary Ranking ===
            async cmdRanking() {
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                if (bCount === 0) {
                    await this.typeMessage('<i class="fas fa-info-circle"></i> لا يوجد مستفيدون مسجلون.', 'warning');
                    return;
                }
                if (typeof compensations === 'undefined' || compensations.length === 0) {
                    await this.typeMessage('<i class="fas fa-info-circle"></i> لا توجد تعويضات مسجلة.', 'warning');
                    return;
                }

                const fmtCur = typeof formatCurrency === 'function' ? formatCurrency : (v) => v.toFixed(2);
                const ranked = compensations
                    .map(c => {
                        const b = beneficiaries.find(bb => bb.id === c.beneficiaryId);
                        return { name: b ? (b.name || `#${b.id}`) : `#${c.beneficiaryId}`, amount: c.netPayable || 0 };
                    })
                    .filter(r => r.amount > 0)
                    .sort((a, b) => b.amount - a.amount);

                let html = `<span class="msg-title"><i class="fas fa-trophy"></i> ترتيب المستفيدين حسب المبالغ</span>`;
                const medals = ['🥇', '🥈', '🥉'];
                const top = ranked.slice(0, 10);
                html += '<div class="ranking-list">';
                top.forEach((r, i) => {
                    const medal = i < 3 ? medals[i] : `<span class="rank-num">${i + 1}</span>`;
                    const barW = ranked[0].amount > 0 ? ((r.amount / ranked[0].amount) * 100) : 0;
                    html += `<div class="ranking-item">
                        <div class="ranking-medal">${medal}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${r.name}</div>
                            <div class="ranking-bar-container">
                                <div class="ranking-bar" style="width:${barW}%"></div>
                            </div>
                        </div>
                        <div class="ranking-amount">${fmtCur(r.amount)}</div>
                    </div>`;
                });
                html += '</div>';
                if (ranked.length > 10) html += `<small style="color:#94a3b8; display:block; margin-top:6px">عرض أعلى 10 من أصل ${ranked.length} مستفيد</small>`;
                await this.typeMessage(html);
            },

            // === Percentage Calculator ===
            async cmdPercentage(args) {
                if (!args || args.trim() === '') {
                    await this.typeMessage(`
                        <span class="msg-title"><i class="fas fa-percentage"></i> حاسبة النسبة المئوية</span>
                        أمثلة للاستخدام:
                        <ul class="step-list">
                            <li><span class="step-num">1</span> <code>/نسبة 50 من 12000</code> → 6000</li>
                            <li><span class="step-num">2</span> <code>/نسبة 25 من 8400</code> → 2100</li>
                            <li><span class="step-num">3</span> <code>/نسبة 100 من 5000</code> → 5000</li>
                        </ul>
                        <small style="color:#94a3b8">💡 مفيد لحساب تعويض 50% سريعاً!</small>
                    `);
                    return;
                }
                const match = args.match(/([\d.]+)\s*(?:من|%|of)\s*([\d.]+)/i);
                if (match) {
                    const pct = parseFloat(match[1]);
                    const total = parseFloat(match[2]);
                    const result = (pct / 100) * total;
                    const fmtCur = typeof formatCurrency === 'function' ? formatCurrency : (v) => v.toFixed(2);
                    await this.typeMessage(`
                        <i class="fas fa-percentage"></i> <strong>نتيجة الحساب:</strong>
                        <div class="calc-result-card">
                            <div class="calc-result-label">${pct}% من ${fmtCur(total)}</div>
                            <div class="calc-result-value">${fmtCur(result)} دج</div>
                        </div>
                    `);
                } else {
                    await this.typeMessage('<i class="fas fa-exclamation-circle"></i> صيغة غير صحيحة. استخدم: <code>/نسبة 50 من 12000</code>', 'warning');
                }
            },

            // === Duplicate CCP Detection ===
            async cmdDuplicates() {
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                if (bCount === 0) {
                    await this.typeMessage('<i class="fas fa-info-circle"></i> لا يوجد مستفيدون.', 'warning');
                    return;
                }

                const ccpMap = {};
                const duplicates = [];
                beneficiaries.forEach(b => {
                    const ccp = (b.ccp || '').toString().trim();
                    if (!ccp) return;
                    if (ccpMap[ccp]) {
                        ccpMap[ccp].push(b.name || `#${b.id}`);
                    } else {
                        ccpMap[ccp] = [b.name || `#${b.id}`];
                    }
                });
                Object.entries(ccpMap).forEach(([ccp, names]) => {
                    if (names.length > 1) duplicates.push({ ccp, names });
                });

                if (duplicates.length === 0) {
                    this.setMood('celebrate');
                    await this.typeMessage('<i class="fas fa-check-circle"></i> لا توجد أرقام CCP مكررة. ممتاز! ✨', 'success');
                    setTimeout(() => this.setMood('happy'), 1500);
                    return;
                }

                this.setMood('alert');
                let html = `<span class="msg-title"><i class="fas fa-clone"></i> أرقام CCP المكررة</span>`;
                html += `<div style="font-size:0.78em; color:#ef4444; margin-bottom:8px"><i class="fas fa-exclamation-triangle"></i> تم العثور على <strong>${duplicates.length}</strong> رقم CCP مكرر!</div>`;
                duplicates.forEach(d => {
                    html += `<div style="padding:6px 0; border-bottom:1px dashed rgba(0,0,0,0.05);">
                        <div style="font-weight:600; font-size:0.82em; color:#334155"><i class="fas fa-id-card"></i> CCP: ${d.ccp}</div>
                        <div style="font-size:0.75em; color:#94a3b8">المستفيدون: ${d.names.join(' ، ')}</div>
                    </div>`;
                });
                html += `<div style="margin-top:8px">
                    <button class="msg-action-btn" onclick="showSection('compensation-management-section'); SmartAssistant.addMessage('<i class=\\'fas fa-check\\'></i> انتقل للتعديل', 'success');">
                        <i class="fas fa-edit"></i> تعديل المستفيدين
                    </button>
                </div>`;
                await this.typeMessage(html, 'warning');
                setTimeout(() => this.setMood('happy'), 3000);
            },

            // === Analytics Tab ===
            renderAnalytics() {
                const dash = document.getElementById('analytics-dashboard');
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                const credit = typeof institutionInfo !== 'undefined' ? (parseFloat(institutionInfo.openCredit) || 0) : 0;
                let totalNet = 0, totalQ1 = 0, totalQ2 = 0, totalQ3 = 0, totalQ4 = 0;
                let filledQuarters = 0, totalQuarters = 0;

                if (typeof compensations !== 'undefined') {
                    compensations.forEach(c => {
                        totalNet += (c.netPayable || 0);
                        totalQ1 += (c.q1 ? c.q1.calculated : 0);
                        totalQ2 += (c.q2 ? c.q2.calculated : 0);
                        totalQ3 += (c.q3 ? c.q3.calculated : 0);
                        totalQ4 += (c.q4 ? c.q4.calculated : 0);
                        [c.q1, c.q2, c.q3, c.q4].forEach(q => {
                            totalQuarters++;
                            if (q && (q.value > 0 || q.calculated > 0)) filledQuarters++;
                        });
                    });
                }

                const remaining = credit - totalNet;
                const pct = credit > 0 ? ((totalNet / credit) * 100) : 0;
                const fillPct = totalQuarters > 0 ? ((filledQuarters / totalQuarters) * 100) : 0;
                const fmtCur = typeof formatCurrency === 'function' ? formatCurrency : (v) => v.toFixed(2);
                const barColor = pct > 90 ? 'red' : pct > 70 ? 'orange' : 'teal';

                dash.innerHTML = `
                    <div class="analytics-row">
                        <div class="analytics-card">
                            <div class="analytics-card-title"><i class="fas fa-users"></i> المستفيدين</div>
                            <div class="analytics-card-value">${bCount}</div>
                            <div class="analytics-card-sub">مستفيد مسجل</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-card-title"><i class="fas fa-money-bill-wave"></i> إجمالي التعويضات</div>
                            <div class="analytics-card-value" style="font-size:1.1em">${fmtCur(totalNet)}</div>
                            <div class="analytics-card-sub">دينار جزائري</div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <div class="analytics-card-title"><i class="fas fa-wallet"></i> استهلاك الاعتماد</div>
                        <div class="analytics-mini-chart">
                            <div class="analytics-mini-chart-fill ${barColor}" style="width:${Math.min(pct, 100)}%"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:0.72em; color:#64748b;">
                            <span>مصروف: ${fmtCur(totalNet)}</span>
                            <span>${pct.toFixed(1)}%</span>
                            <span>متبقي: ${fmtCur(remaining)}</span>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <div class="analytics-card-title"><i class="fas fa-chart-bar"></i> التعويضات حسب الفصل</div>
                        <ul class="analytics-list">
                            <li><span class="label"><i class="fas fa-circle" style="color:#0d9488; font-size:0.5em"></i> الفصل الأول</span><span class="value">${fmtCur(totalQ1)}</span></li>
                            <li><span class="label"><i class="fas fa-circle" style="color:#6366f1; font-size:0.5em"></i> الفصل الثاني</span><span class="value">${fmtCur(totalQ2)}</span></li>
                            <li><span class="label"><i class="fas fa-circle" style="color:#f97316; font-size:0.5em"></i> الفصل الثالث</span><span class="value">${fmtCur(totalQ3)}</span></li>
                            <li><span class="label"><i class="fas fa-circle" style="color:#22c55e; font-size:0.5em"></i> الفصل الرابع</span><span class="value">${fmtCur(totalQ4)}</span></li>
                        </ul>
                    </div>

                    <div class="analytics-card">
                        <div class="analytics-card-title"><i class="fas fa-tasks"></i> اكتمال البيانات</div>
                        <div class="analytics-mini-chart">
                            <div class="analytics-mini-chart-fill ${fillPct > 75 ? 'green' : fillPct > 40 ? 'indigo' : 'orange'}" style="width:${fillPct}%"></div>
                        </div>
                        <div class="analytics-card-sub">${filledQuarters} من ${totalQuarters} فصل مكتمل (${fillPct.toFixed(0)}%)</div>
                    </div>

                    ${bCount > 0 ? `
                    <div class="analytics-card">
                        <div class="analytics-card-title"><i class="fas fa-calculator"></i> متوسطات</div>
                        <ul class="analytics-list">
                            <li><span class="label"><i class="fas fa-user"></i> متوسط لكل مستفيد</span><span class="value">${fmtCur(bCount > 0 ? totalNet / bCount : 0)}</span></li>
                            <li><span class="label"><i class="fas fa-calendar-alt"></i> متوسط فصلي</span><span class="value">${fmtCur((totalQ1+totalQ2+totalQ3+totalQ4)/4)}</span></li>
                        </ul>
                    </div>` : ''}

                    ${(() => {
                        if (typeof compensations === 'undefined' || typeof beneficiaries === 'undefined' || bCount === 0) return '';
                        const ranked = compensations.map(c => {
                            const b = beneficiaries.find(bb => bb.id === c.beneficiaryId);
                            return { name: b ? (b.name || '#'+b.id) : '#'+c.beneficiaryId, amount: c.netPayable || 0 };
                        }).filter(r => r.amount > 0).sort((a, b) => b.amount - a.amount).slice(0, 5);
                        if (ranked.length === 0) return '';
                        const medals = ['🥇', '🥈', '🥉'];
                        let items = ranked.map((r, i) => {
                            const medal = i < 3 ? medals[i] : (i+1);
                            const barW = ranked[0].amount > 0 ? ((r.amount / ranked[0].amount) * 100) : 0;
                            return `<div class="ranking-item"><div class="ranking-medal">${medal}</div><div class="ranking-info"><div class="ranking-name">${r.name}</div><div class="ranking-bar-container"><div class="ranking-bar" style="width:${barW}%"></div></div></div><div class="ranking-amount">${fmtCur(r.amount)}</div></div>`;
                        }).join('');
                        return `<div class="analytics-card"><div class="analytics-card-title"><i class="fas fa-trophy"></i> أعلى 5 مستفيدين</div><div class="ranking-list">${items}</div></div>`;
                    })()}
                `;
            },

            // === Tools Tab ===
            renderTools() {
                const grid = document.getElementById('assistant-tools-grid');
                const tools = [
                    { icon: 'fas fa-calculator', name: 'حاسبة سريعة', desc: 'حساب مبالغ التعويضات', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdCalculator();" },
                    { icon: 'fas fa-search-dollar', name: 'تحليل مالي', desc: 'تحليل شامل للمبالغ', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.showDataAnalysis();" },
                    { icon: 'fas fa-clipboard-check', name: 'فحص الأخطاء', desc: 'كشف مشاكل البيانات', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.showDataValidation();" },
                    { icon: 'fas fa-save', name: 'حفظ سريع', desc: 'حفظ جميع البيانات', badge: '', action: "SmartAssistant.cmdSave();" },
                    { icon: 'fas fa-file-excel', name: 'تصدير Excel', desc: 'إنشاء ملف XLSX', badge: '', action: "exportXLSX(); SmartAssistant.logActivity('تصدير', 'Excel');" },
                    { icon: 'fas fa-file-alt', name: 'تصدير TXT', desc: 'ملف الدفع الإلكتروني', badge: '', action: "exportTxt(); SmartAssistant.logActivity('تصدير', 'TXT');" },
                    { icon: 'fas fa-print', name: 'طباعة تقرير', desc: 'طباعة شاملة', badge: '', action: "printReport(); SmartAssistant.logActivity('تصدير', 'طباعة');" },
                    { icon: 'fas fa-database', name: 'نسخة احتياطية', desc: 'حفظ نسخة آمنة', badge: 'مهم', action: "document.getElementById('create-backup-btn').click();" },
                    { icon: 'fas fa-compass', name: 'تنقل سريع', desc: 'الانتقال بين الأقسام', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdNavigate();" },
                    { icon: 'fas fa-exchange-alt', name: 'تبديل النظام', desc: 'تغيير نظام العمل', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdSwitchMode();" },
                    { icon: 'fas fa-history', name: 'سجل النشاطات', desc: 'مراجعة العمليات', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdShowLog();" },
                    { icon: 'fas fa-keyboard', name: 'اختصارات', desc: 'اختصارات لوحة المفاتيح', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.showShortcuts();" },
                    { icon: 'fas fa-search', name: 'بحث مستفيد', desc: 'البحث بالاسم أو CCP', badge: 'جديد', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdSearch('');" },
                    { icon: 'fas fa-trophy', name: 'الترتيب', desc: 'ترتيب حسب المبالغ', badge: 'جديد', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdRanking();" },
                    { icon: 'fas fa-clone', name: 'كشف المكرر', desc: 'اكتشاف CCP المكرر', badge: 'جديد', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdDuplicates();" },
                    { icon: 'fas fa-clock', name: 'إحصاء الجلسة', desc: 'وقت العمل والتفاعل', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdSession();" },
                    { icon: 'fas fa-percentage', name: 'حاسبة النسبة', desc: 'حساب النسبة المئوية', badge: '', action: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdPercentage('');" },
                ];

                grid.innerHTML = tools.map(t => `
                    <div class="tool-card" onclick="${t.action}">
                        ${t.badge ? `<span class="tool-card-badge">${t.badge}</span>` : ''}
                        <div class="tool-card-icon"><i class="${t.icon}"></i></div>
                        <div class="tool-card-name">${t.name}</div>
                        <div class="tool-card-desc">${t.desc}</div>
                    </div>
                `).join('');
            },

            // === Health Check Tab ===
            renderHealthCheck() {
                const dash = document.getElementById('health-dashboard');
                const issues = this.getDataIssues();
                const totalChecks = 10;
                const errorCount = issues.filter(i => i.type === 'error').length;
                const warningCount = issues.filter(i => i.type === 'warning').length;
                const goodCount = totalChecks - errorCount - warningCount;
                const score = Math.max(0, Math.round(((goodCount + warningCount * 0.5) / totalChecks) * 100));
                const circumference = 2 * Math.PI * 42;
                const strokeOffset = circumference - (score / 100) * circumference;
                const scoreColor = score >= 80 ? '#22c55e' : score >= 50 ? '#f97316' : '#ef4444';

                let issuesHtml = '';
                if (issues.length === 0) {
                    issuesHtml = `<div class="health-issue-item">
                        <div class="health-issue-icon good"><i class="fas fa-check-circle"></i></div>
                        <div class="health-issue-text">
                            <div class="health-issue-title" style="color:#22c55e">جميع البيانات سليمة!</div>
                            <div class="health-issue-desc">لم يتم العثور على أي مشاكل. عمل ممتاز! 🎉</div>
                        </div>
                    </div>`;
                } else {
                    issues.forEach(issue => {
                        issuesHtml += `<div class="health-issue-item">
                            <div class="health-issue-icon ${issue.type}"><i class="fas ${issue.type === 'error' ? 'fa-times-circle' : 'fa-exclamation-triangle'}"></i></div>
                            <div class="health-issue-text">
                                <div class="health-issue-title">${issue.title}</div>
                                <div class="health-issue-desc">${issue.desc}</div>
                                ${issue.fix ? `<button class="health-fix-btn" onclick="${issue.fix}"><i class="fas fa-wrench"></i> إصلاح</button>` : ''}
                            </div>
                        </div>`;
                    });
                }

                dash.innerHTML = `
                    <div class="health-score-card">
                        <div class="health-score-ring">
                            <svg viewBox="0 0 100 100">
                                <circle class="score-bg" cx="50" cy="50" r="42"/>
                                <circle class="score-fill" cx="50" cy="50" r="42"
                                    stroke="${scoreColor}"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${strokeOffset}"
                                    style="animation: healthScoreFill 1s ease forwards;"/>
                            </svg>
                            <div class="health-score-text" style="color:${scoreColor}">${score}%</div>
                        </div>
                        <div class="health-score-label">
                            ${score >= 80 ? 'صحة البيانات ممتازة ✨' : score >= 50 ? 'بعض المشاكل تحتاج اهتمام ⚠️' : 'مشاكل عديدة تحتاج إصلاح 🔴'}
                        </div>
                        <div style="display:flex; justify-content:center; gap:16px; margin-top:10px; font-size:0.75em;">
                            <span style="color:#ef4444"><i class="fas fa-times-circle"></i> ${errorCount} أخطاء</span>
                            <span style="color:#f97316"><i class="fas fa-exclamation-triangle"></i> ${warningCount} تحذيرات</span>
                            <span style="color:#22c55e"><i class="fas fa-check-circle"></i> ${goodCount} سليم</span>
                        </div>
                    </div>
                    ${issuesHtml}
                    <button class="msg-action-btn" style="width:100%; justify-content:center; margin-top:4px;" onclick="SmartAssistant.renderHealthCheck();">
                        <i class="fas fa-sync-alt"></i> إعادة الفحص
                    </button>
                `;
            },

            getDataIssues() {
                const issues = [];
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                const credit = typeof institutionInfo !== 'undefined' ? (parseFloat(institutionInfo.openCredit) || 0) : 0;

                // Check 1: No beneficiaries
                if (bCount === 0) {
                    issues.push({ type: 'warning', title: 'لا يوجد مستفيدون', desc: 'لم يتم إضافة أي مستفيد بعد. أضف مستفيداً للبدء.', fix: "document.getElementById('add-beneficiary-btn').click();" });
                }

                // Check 2: Credit not set
                if (credit === 0) {
                    issues.push({ type: 'warning', title: 'الاعتماد المفتوح غير محدد', desc: 'لم يتم تحديد مبلغ الاعتماد المفتوح. انتقل لمعلومات المؤسسة.', fix: "showSection('institution-info-section');" });
                }

                // Check 3: Budget overrun
                if (typeof compensations !== 'undefined' && credit > 0) {
                    let totalSpent = 0;
                    compensations.forEach(c => { totalSpent += (c.netPayable || 0); });
                    if (totalSpent > credit) {
                        issues.push({ type: 'error', title: 'تجاوز الاعتماد المفتوح!', desc: `المصروفات (${totalSpent.toFixed(2)}) تتجاوز الاعتماد (${credit.toFixed(2)}).` });
                    }
                }

                // Check 4: Missing CCP
                if (typeof beneficiaries !== 'undefined') {
                    const noCcp = beneficiaries.filter(b => !b.ccp || b.ccp.toString().trim() === '');
                    if (noCcp.length > 0) {
                        issues.push({ type: 'error', title: `${noCcp.length} مستفيد بدون CCP`, desc: 'وجود مستفيدين بدون رقم حساب بريدي. هذا سيمنع التصدير.', fix: "showSection('compensation-management-section');" });
                    }
                }

                // Check 5: Empty compensations
                if (typeof compensations !== 'undefined' && bCount > 0) {
                    const empty = compensations.filter(c =>
                        (!c.q1 || c.q1.calculated === 0) && (!c.q2 || c.q2.calculated === 0) &&
                        (!c.q3 || c.q3.calculated === 0) && (!c.q4 || c.q4.calculated === 0)
                    );
                    if (empty.length > 0) {
                        issues.push({ type: 'warning', title: `${empty.length} مستفيد بدون تعويضات`, desc: 'يوجد مستفيدون مسجلون لكن بدون أي مبالغ تعويض مدخلة.' });
                    }
                }

                // Check 6: Institution info missing
                if (typeof institutionInfo !== 'undefined') {
                    if (!institutionInfo.name || institutionInfo.name.trim() === '') {
                        issues.push({ type: 'warning', title: 'اسم المؤسسة غير محدد', desc: 'أدخل اسم المؤسسة في قسم المعلومات.', fix: "showSection('institution-info-section');" });
                    }
                }

                // Check 7: CCP format
                if (typeof institutionInfo !== 'undefined' && institutionInfo.ccpNumber) {
                    const ccp = institutionInfo.ccpNumber.toString().trim();
                    if (ccp.length < 5) {
                        issues.push({ type: 'warning', title: 'رقم CCP المؤسسة قصير', desc: 'رقم الحساب البريدي للمؤسسة يبدو قصيراً. تأكد من صحته.' });
                    }
                }

                // Check 8: No backup recently
                const lastBackup = localStorage.getItem('lastBackupDate');
                if (!lastBackup) {
                    issues.push({ type: 'warning', title: 'لم يتم إنشاء نسخة احتياطية', desc: 'يُنصح بإنشاء نسخة احتياطية لحماية بياناتك.', fix: "document.getElementById('create-backup-btn').click();" });
                }

                // Check 9: Duplicate CCP numbers
                if (typeof beneficiaries !== 'undefined' && beneficiaries.length > 1) {
                    const ccpMap = {};
                    let dupCount = 0;
                    beneficiaries.forEach(b => {
                        const ccp = (b.ccp || '').toString().trim();
                        if (!ccp) return;
                        if (ccpMap[ccp]) dupCount++;
                        else ccpMap[ccp] = true;
                    });
                    if (dupCount > 0) {
                        issues.push({ type: 'error', title: `${dupCount} رقم CCP مكرر`, desc: 'توجد أرقام حساب بريدي مكررة بين المستفيدين. استخدم /مكرر للتفاصيل.', fix: "SmartAssistant.switchTab('chat'); SmartAssistant.cmdDuplicates();" });
                    }
                }

                // Check 10: Negative net payable amounts
                if (typeof compensations !== 'undefined') {
                    const negCount = compensations.filter(c => (c.netPayable || 0) < 0).length;
                    if (negCount > 0) {
                        issues.push({ type: 'error', title: `${negCount} تعويض بمبلغ سالب`, desc: 'توجد تعويضات بمبالغ سالبة. تحقق من المدخلات.', fix: "showSection('compensation-management-section');" });
                    }
                }

                return issues;
            },

            // === Data Analysis (Chat) ===
            async showDataAnalysis() {
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                if (bCount === 0) {
                    await this.typeMessage('<i class="fas fa-info-circle"></i> لا توجد بيانات كافية للتحليل. أضف مستفيدين أولاً.', 'warning');
                    return;
                }

                const credit = typeof institutionInfo !== 'undefined' ? (parseFloat(institutionInfo.openCredit) || 0) : 0;
                let totalNet = 0, maxComp = 0, minComp = Infinity, maxName = '', minName = '';

                if (typeof compensations !== 'undefined' && typeof beneficiaries !== 'undefined') {
                    compensations.forEach(c => {
                        totalNet += (c.netPayable || 0);
                        const b = beneficiaries.find(bb => bb.id === c.beneficiaryId);
                        const bName = b ? (b.name || `#${b.id}`) : `#${c.beneficiaryId}`;
                        if (c.netPayable > maxComp) { maxComp = c.netPayable; maxName = bName; }
                        if (c.netPayable < minComp && c.netPayable > 0) { minComp = c.netPayable; minName = bName; }
                    });
                }
                if (minComp === Infinity) minComp = 0;
                const fmtCur = typeof formatCurrency === 'function' ? formatCurrency : (v) => v.toFixed(2);
                const avg = bCount > 0 ? totalNet / bCount : 0;

                this.setMood('thinking');
                await this.typeMessage(`
                    <span class="msg-title"><i class="fas fa-chart-line"></i> تحليل مالي شامل</span>
                    <div class="calc-result-card">
                        <div class="calc-result-label">إجمالي التعويضات</div>
                        <div class="calc-result-value">${fmtCur(totalNet)} دج</div>
                    </div>
                    <ul class="analytics-list" style="margin-top:10px">
                        <li><span class="label"><i class="fas fa-arrow-up" style="color:#ef4444; font-size:0.6em"></i> أعلى تعويض</span><span class="value">${fmtCur(maxComp)} (${maxName})</span></li>
                        <li><span class="label"><i class="fas fa-arrow-down" style="color:#22c55e; font-size:0.6em"></i> أقل تعويض</span><span class="value">${fmtCur(minComp)} (${minName})</span></li>
                        <li><span class="label"><i class="fas fa-balance-scale" style="color:#6366f1; font-size:0.6em"></i> المتوسط</span><span class="value">${fmtCur(avg)}</span></li>
                        ${credit > 0 ? `<li><span class="label"><i class="fas fa-wallet" style="color:#f97316; font-size:0.6em"></i> نسبة الاستهلاك</span><span class="value">${((totalNet/credit)*100).toFixed(1)}%</span></li>` : ''}
                    </ul>
                `);
                this.setMood('happy');
            },

            // === Data Validation (Chat) ===
            async showDataValidation() {
                this.setMood('thinking');
                const issues = this.getDataIssues();
                if (issues.length === 0) {
                    this.setMood('celebrate');
                    await this.typeMessage('<i class="fas fa-check-circle"></i> <strong>ممتاز!</strong> جميع البيانات سليمة ولا توجد أي مشاكل! 🎉', 'success');
                    setTimeout(() => this.setMood('happy'), 2000);
                    return;
                }

                this.setMood('alert');
                let html = `<span class="msg-title"><i class="fas fa-clipboard-check"></i> نتائج فحص البيانات</span>`;
                html += `<div style="font-size:0.78em; color:#64748b; margin-bottom:8px">تم العثور على <strong>${issues.length}</strong> مشكلة:</div>`;
                issues.forEach((issue, i) => {
                    const icon = issue.type === 'error' ? 'fa-times-circle' : 'fa-exclamation-triangle';
                    const color = issue.type === 'error' ? '#ef4444' : '#f97316';
                    html += `<div style="padding:6px 0; border-bottom:1px dashed rgba(0,0,0,0.05);">
                        <div style="font-weight:600; color:${color}; font-size:0.82em"><i class="fas ${icon}"></i> ${issue.title}</div>
                        <div style="font-size:0.75em; color:#94a3b8">${issue.desc}</div>
                    </div>`;
                });
                await this.typeMessage(html, 'warning');
                setTimeout(() => this.setMood('happy'), 3000);
            },

            // === Activity Logging ===
            logActivity(action, detail) {
                const now = new Date();
                const time = now.toLocaleTimeString('ar-DZ', { hour: '2-digit', minute: '2-digit' });
                this.activityLog.push({ action, detail, time, timestamp: now.getTime() });
                if (this.activityLog.length > 50) this.activityLog = this.activityLog.slice(-50);
                try { localStorage.setItem('assistantActivityLog', JSON.stringify(this.activityLog)); } catch(e) {}
            },

            // === Original Features (Enhanced) ===
            showGreeting() {
                this.clearMessages();
                const hour = new Date().getHours();
                let greeting = 'مساء الخير';
                let emoji = '🌙';
                if (hour < 12) { greeting = 'صباح الخير'; emoji = '☀️'; }
                else if (hour < 17) { greeting = 'مرحباً بك'; emoji = '👋'; }

                this.addMessage(`
                    <span class="msg-icon"><i class="fas fa-hand-sparkles"></i></span>
                    <strong>${greeting}! ${emoji}</strong><br>
                    أنا <strong>المساعد الذكي المتطور</strong>، جاهز لمساعدتك بكل الطرق!<br>
                    <small style="color:#94a3b8">💬 اكتب سؤالك أدناه أو استخدم <strong>/</strong> للأوامر السريعة. يمكنك أيضاً استكشاف التبويبات أعلاه!</small>
                `);

                // Context-aware tip
                const bCount = typeof beneficiaries !== 'undefined' ? beneficiaries.length : 0;
                if (bCount === 0) {
                    this.addMessage(`
                        <i class="fas fa-lightbulb"></i>
                        <strong>لنبدأ!</strong> لا يوجد مستفيدون بعد.
                        <div style="margin-top:6px">
                            <button class="msg-action-btn" onclick="showSection('compensation-management-section'); setTimeout(()=>document.getElementById('add-beneficiary-btn').click(), 300);">
                                <i class="fas fa-user-plus"></i> إضافة أول مستفيد
                            </button>
                        </div>
                    `, 'tip');
                } else {
                    const issues = this.getDataIssues();
                    if (issues.length > 0) {
                        this.addMessage(`
                            <i class="fas fa-heartbeat"></i>
                            لديك <strong>${bCount}</strong> مستفيد و <strong>${issues.length}</strong> مشكلة تحتاج اهتمام.
                            <div style="margin-top:6px">
                                <button class="msg-action-btn" onclick="SmartAssistant.switchTab('health')">
                                    <i class="fas fa-stethoscope"></i> فحص المشاكل
                                </button>
                                <button class="msg-action-btn" onclick="SmartAssistant.switchTab('analytics')">
                                    <i class="fas fa-chart-pie"></i> عرض التحليلات
                                </button>
                            </div>
                        `, 'warning');
                    } else {
                        this.addMessage(`
                            <i class="fas fa-check-circle"></i>
                            لديك <strong>${bCount}</strong> مستفيد مسجل وبياناتك سليمة! ✨
                            <div style="margin-top:6px">
                                <button class="msg-action-btn" onclick="SmartAssistant.switchTab('analytics')">
                                    <i class="fas fa-chart-pie"></i> عرض التحليلات
                                </button>
                                <button class="msg-action-btn" onclick="SmartAssistant.cmdExport()">
                                    <i class="fas fa-file-export"></i> تصدير
                                </button>
                            </div>
                        `, 'success');
                    }
                }
            },

            showOverview() {
                this.clearMessages();
                this.addMessage(`
                    <span class="msg-title"><i class="fas fa-map"></i> نظرة عامة على البرنامج</span>
                    برنامج متكامل لإدارة تعويضات الموظفين بأربعة أنظمة:
                    <ul class="step-list">
                        <li><span class="step-num">1</span> <strong>الكهرباء والغاز:</strong> تعويض 50% من الاستهلاك الفصلي</li>
                        <li><span class="step-num">2</span> <strong>منحة التجهيز:</strong> صرف منحة التجهيز</li>
                        <li><span class="step-num">3</span> <strong>مصاريف التنقل:</strong> تعويض مصاريف النقل</li>
                        <li><span class="step-num">4</span> <strong>العمليات التكوينية:</strong> تعويض التكوين</li>
                    </ul>
                    <div style="margin-top:8px">
                        <button class="msg-action-btn" onclick="SmartAssistant.showSectionHelp(SmartAssistant.currentSection)"><i class="fas fa-crosshairs"></i> مساعدة القسم الحالي</button>
                        <button class="msg-action-btn" onclick="SmartAssistant.cmdNavigate()"><i class="fas fa-compass"></i> تنقل سريع</button>
                    </div>
                `);
            },

            showSectionHelp(sectionId) {
                this.clearMessages();
                const helpData = this.getSectionHelpData(sectionId);
                this.addMessage(`
                    <span class="msg-title"><i class="${helpData.icon}"></i> ${helpData.title}</span>
                    ${helpData.description}
                `);
                if (helpData.steps) {
                    let stepsHtml = '<ul class="step-list">';
                    helpData.steps.forEach((step, i) => {
                        stepsHtml += `<li><span class="step-num">${i+1}</span> ${step}</li>`;
                    });
                    stepsHtml += '</ul>';
                    this.addMessage(`<i class="fas fa-shoe-prints"></i> <strong>الخطوات:</strong>${stepsHtml}`, 'tip');
                }
                if (helpData.warnings) {
                    helpData.warnings.forEach(w => {
                        this.addMessage(`<i class="fas fa-exclamation-triangle"></i> ${w}`, 'warning');
                    });
                }
                if (helpData.tips) {
                    helpData.tips.forEach(t => {
                        this.addMessage(`<i class="fas fa-star"></i> ${t}`, 'tip');
                    });
                }
            },

            getSectionHelpData(sectionId) {
                const data = {
                    'institution-info-section': {
                        icon: 'fas fa-building', title: 'معلومات المؤسسة',
                        description: 'هنا تُدخل جميع المعلومات الأساسية للمؤسسة التي ستظهر في التقارير.',
                        steps: ['تأكد من صحة اسم المؤسسة والمديرية', 'أدخل السنة والشهر المالي', 'أدخل <strong>CCP</strong> و<strong>CLE</strong>', 'حدد <strong>الاعتماد المفتوح</strong>', 'أدخل رقم الأمر والحوالة', 'اضغط <strong>حفظ</strong>'],
                        warnings: ['تأكد من كفاية الاعتماد المفتوح لتغطية التعويضات.'],
                        tips: ['كل نظام عمل له اعتماده الخاص.']
                    },
                    'compensation-management-section': {
                        icon: 'fas fa-users', title: 'إدارة التعويضات والمستفيدين',
                        description: 'القسم الرئيسي لإدارة المستفيدين والتعويضات الفصلية.',
                        steps: ['اضغط <strong>"إضافة مستفيد جديد"</strong>', 'أدخل الاسم <strong>بالحروف اللاتينية</strong> ورقم CCP', 'انقر على خانات التعويض (ث1-ث4) لإدخال المبالغ', 'أدخل تفاصيل الفاتورة في النافذة المنبثقة', 'خانة الخصم للمبالغ المخصومة', 'الصافي يُحسب تلقائياً'],
                        warnings: ['الاسم بالحروف اللاتينية فقط', 'راقب الاعتماد المتبقي'],
                        tips: ['البحث بالاسم أو CCP', 'الحفظ تلقائي', 'انقر الاسم للتعديل']
                    },
                    'reporting-section': {
                        icon: 'fas fa-file-alt', title: 'التقارير والتصدير',
                        description: 'طباعة التقارير وتصدير البيانات بصيغ مختلفة.',
                        steps: ['<strong>طباعة:</strong> تقرير شامل', '<strong>XLSX:</strong> ملف Excel', '<strong>TXT:</strong> ملف الدفع الإلكتروني', '<strong>CD-ROM:</strong> جدول الإرسال'],
                        tips: ['ملف TXT للخزينة', 'راجع قبل الطباعة']
                    },
                    'pro-txt-editor-section': {
                        icon: 'fas fa-edit', title: 'المحرر الاحترافي',
                        description: 'تعديل ملف TXT لدمج تعويضات متعددة.',
                        steps: ['اختر المصدر', 'عدّل المبالغ', 'حدّث المعلومات المالية', 'صدّر TXT النهائي', 'اطبع جدول CD-ROM'],
                        warnings: ['للمستخدمين المتقدمين فقط'],
                        tips: ['للمبالغ المسترجعة أو الإضافية']
                    },
                    'backup-restore-section': {
                        icon: 'fas fa-database', title: 'النسخ الاحتياطي',
                        description: 'إدارة النسخ الاحتياطية وحماية البيانات.',
                        steps: ['<strong>إنشاء نسخة:</strong> حفظ JSON', '<strong>استعادة:</strong> استيراد نسخة', '<strong>استيراد TXT:</strong> قائمة المستفيدين', '<strong>حذف:</strong> حذف الكل (نسخة تلقائية)'],
                        warnings: ['أنشئ نسخة يدوية دائماً'],
                        tips: ['نسخ دوري مهم', 'خيار استعادة جزئية متاح']
                    }
                };
                return data[sectionId] || { icon: 'fas fa-question-circle', title: 'مساعدة', description: 'اختر قسماً للمساعدة.' };
            },

            showShortcuts() {
                this.clearMessages();
                this.addMessage(`
                    <span class="msg-title"><i class="fas fa-keyboard"></i> اختصارات لوحة المفاتيح</span>
                    <div class="shortcut-grid">
                        <div class="shortcut-item"><span class="shortcut-key">Ctrl+S</span> حفظ سريع</div>
                        <div class="shortcut-item"><span class="shortcut-key">F1</span> المساعدة</div>
                        <div class="shortcut-item"><span class="shortcut-key">Ctrl+P</span> طباعة</div>
                        <div class="shortcut-item"><span class="shortcut-key">Ctrl+E</span> تصدير Excel</div>
                        <div class="shortcut-item"><span class="shortcut-key">Ctrl+N</span> مستفيد جديد</div>
                        <div class="shortcut-item"><span class="shortcut-key">Ctrl+B</span> نسخة احتياطية</div>
                    </div>
                    <small style="color:#94a3b8; display:block; margin-top:8px">💡 يمكنك أيضاً استخدام أوامر <strong>/</strong> في حقل الدردشة أدناه</small>
                `);
            },

            showProTips() {
                this.clearMessages();
                const tips = [
                    'يمكنك <strong>استيراد المستفيدين</strong> من ملف TXT بدلاً من إدخالهم يدوياً.',
                    'البيانات في <strong>المتصفح المحلي</strong>. مسح بيانات المتصفح = فقدان كل شيء! أنشئ نسخة.',
                    'كل أنظمة العمل الأربعة لها بياناتها الخاصة.',
                    'تأكد من صحة أرقام <strong>CCP</strong> قبل تصدير TXT.',
                    '<strong>"الخصم"</strong> للمبالغ المحولة لجهة أخرى (ضرائب، ديون...).',
                    'انقر <strong>اسم المستفيد</strong> في الجدول للتعديل.',
                    'بطاقات الائتمان تعرض ملخصاً مالياً حياً.',
                    'قسم <strong>"التعديل الاحترافي"</strong> لدمج تعويضات متعددة في ملف واحد.'
                ];
                const shuffled = tips.sort(() => 0.5 - Math.random()).slice(0, 3);
                shuffled.forEach((tip, i) => {
                    setTimeout(() => this.addMessage(`<i class="fas fa-lightbulb"></i> ${tip}`, 'tip'), i * 400);
                });
            },

            // === Contextual Notifications ===
            notify(message, type = 'tip') {
                if (this.isOpen && this.currentTab === 'chat') {
                    this.addMessage(`<i class="fas fa-bell"></i> ${message}`, type);
                } else {
                    this.badge.textContent = '!';
                    this.badge.classList.remove('hidden');
                    this._pendingNotification = { message, type };
                    // Show floating notification
                    this._showFloatingNotif(message, type);
                }
            },
            _showFloatingNotif(message, type) {
                const notif = document.createElement('div');
                notif.className = `assistant-notification ${type}`;
                notif.innerHTML = message;
                document.body.appendChild(notif);
                setTimeout(() => {
                    notif.style.transition = 'opacity 0.4s, transform 0.4s';
                    notif.style.opacity = '0';
                    notif.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => notif.remove(), 400);
                }, 4500);
            },

            observeSectionChanges() {
                const origShowSection = window.showSection;
                const self = this;
                window.showSection = function(sectionId) {
                    origShowSection.call(this, sectionId);
                    self.currentSection = sectionId;
                    self.onSectionChange(sectionId);
                };
            },

            onSectionChange(sectionId) {
                this.logActivity('تنقل', this.getSectionHelpData(sectionId).title || sectionId);
                const tipKey = `section_tip_${sectionId}`;
                if (this.shownTips.has(tipKey)) return;

                const tips = {
                    'institution-info-section': '💡 تأكد من إدخال الاعتماد المفتوح والحساب البريدي.',
                    'compensation-management-section': '💡 اضغط على خانة التعويض لإدخال تفاصيل الفاتورة.',
                    'reporting-section': '💡 راجع التقرير في المعاينة قبل الطباعة.',
                    'pro-txt-editor-section': '💡 هذا القسم متقدم. استخدمه فقط عند الحاجة.',
                    'backup-restore-section': '💡 أنشئ نسخة احتياطية دورياً لحماية بياناتك.'
                };

                if (tips[sectionId]) {
                    this.notify(tips[sectionId], 'tip');
                    this.shownTips.add(tipKey);
                    localStorage.setItem('shownAssistantTips', JSON.stringify([...this.shownTips]));
                }

                // Update suggestions for new section
                this.showContextualSuggestions();
            },

            listenForActions() {
                const saveBtn = document.querySelector('.save-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        setTimeout(() => {
                            this.notify('✅ تم حفظ معلومات المؤسسة بنجاح!', 'success');
                            this.logActivity('حفظ', 'معلومات المؤسسة');
                            localStorage.setItem('lastSaveTime', Date.now().toString());
                        }, 500);
                    });
                }

                const addBtn = document.getElementById('add-beneficiary-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', () => {
                        this.notify('📝 أدخل الاسم بالحروف اللاتينية ورقم CCP.', 'tip');
                        this.logActivity('إضافة', 'فتح نافذة مستفيد جديد');
                    });
                }

                ['print-report-btn', 'export-xlsx-btn', 'export-txt-btn', 'print-cdrom-btn'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('click', () => {
                            this.notify('⏳ جارٍ إعداد الملف...', 'tip');
                            this.logActivity('تصدير', id.replace(/-btn$/, '').replace(/-/g, ' '));
                        });
                    }
                });

                const createBackup = document.getElementById('create-backup-btn');
                if (createBackup) {
                    createBackup.addEventListener('click', () => {
                        setTimeout(() => {
                            this.notify('💾 تم إنشاء النسخة الاحتياطية!', 'success');
                            this.logActivity('نسخ احتياطي', 'تم إنشاء نسخة');
                            localStorage.setItem('lastBackupDate', new Date().toISOString());
                        }, 800);
                    });
                }
            },

            showWelcome() {
                const overlay = document.createElement('div');
                overlay.className = 'welcome-overlay';
                overlay.id = 'welcome-overlay';
                overlay.innerHTML = `
                    <div class="welcome-card">
                        <div class="welcome-avatar"><i class="fas fa-robot"></i></div>
                        <h2>مرحباً بك في المساعد الذكي المتطور!</h2>
                        <p>أنا مساعدك الذكي بتقنية AI، سأرافقك وأساعدك بطرق متعددة ومتقدمة.</p>
                        <div class="welcome-features">
                            <div class="feature-item"><i class="fas fa-comments"></i><span>محادثة ذكية باللغة العربية</span></div>
                            <div class="feature-item"><i class="fas fa-chart-pie"></i><span>تحليلات مالية تفاعلية</span></div>
                            <div class="feature-item"><i class="fas fa-heartbeat"></i><span>فحص صحة البيانات تلقائياً</span></div>
                            <div class="feature-item"><i class="fas fa-toolbox"></i><span>أدوات سريعة وقاموس أوامر</span></div>
                            <div class="feature-item"><i class="fas fa-calculator"></i><span>حاسبة مدمجة متطورة</span></div>
                            <div class="feature-item"><i class="fas fa-history"></i><span>سجل نشاطات وتتبع العمليات</span></div>
                        </div>
                        <p style="color:#64748b; font-size:0.82em;">اكتب <strong>/</strong> في حقل الدردشة لاستكشاف الأوامر المتاحة!</p>
                        <button class="welcome-start-btn" onclick="document.getElementById('welcome-overlay').remove(); localStorage.setItem('assistantWelcomed','1');">
                            <i class="fas fa-rocket"></i> ابدأ الآن
                        </button>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
        };

        // Initialize Smart Assistant after DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => SmartAssistant.init(), 500);
        });
        // Fallback: if DOM already loaded
        if (document.readyState !== 'loading') {
            setTimeout(() => SmartAssistant.init(), 500);
        }

        // --- Particle Animation ---
        function initParticles() {
            const canvas = document.getElementById('particles-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const particleCount = 50;
            
            class Particle {
                constructor() {
                    this.reset();
                }
                
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height + Math.random() * 100;
                    this.size = Math.random() * 5 + 2;
                    this.speedY = Math.random() * 1.5 + 0.5;
                    this.speedX = (Math.random() - 0.5) * 0.8;
                    this.opacity = Math.random() * 0.4 + 0.2;
                    // Aurora teal theme colors
                    const colors = ['#0d9488', '#6366f1', '#22c55e', '#0f766e', '#f97316'];
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                }
                
                update() {
                    this.y -= this.speedY;
                    this.x += this.speedX;
                    this.opacity -= 0.002;
                    
                    if (this.y < -10 || this.opacity <= 0) {
                        this.reset();
                    }
                }
                
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = this.opacity;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }
            }
            
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
            
            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                requestAnimationFrame(animateParticles);
            }
            
            animateParticles();
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // --- Statistics Dashboard ---
        let statsChart = null;
        
        function toggleStatsDashboard() {
            const dashboard = document.getElementById('stats-dashboard');
            if (dashboard) {
                dashboard.classList.toggle('open');
                if (dashboard.classList.contains('open')) {
                    updateStatistics();
                }
            }
        }
        
        function updateStatistics() {
            // Calculate statistics
            const totalBeneficiaries = beneficiaries.length;
            const typeCounts = {
                electricity: beneficiaries.filter(b => b.type === 'electricity').length,
                equipment: beneficiaries.filter(b => b.type === 'equipment').length,
                transport: beneficiaries.filter(b => b.type === 'transport').length,
                training: beneficiaries.filter(b => b.type === 'training').length
            };
            
            // Calculate total compensations
            let totalCompensation = 0;
            compensations.forEach(c => {
                (c.quarters || []).forEach(q => {
                    totalCompensation += q.reimbursement || 0;
                });
            });
            compensationsEquipment.forEach(c => totalCompensation += c.totalDue || 0);
            compensationsTransport.forEach(c => totalCompensation += c.totalDue || 0);
            compensationsTraining.forEach(c => totalCompensation += c.totalDue || 0);
            
            // Update stat cards
            document.getElementById('stat-total-beneficiaries').textContent = totalBeneficiaries;
            document.getElementById('stat-total-compensation').textContent = formatCurrency(totalCompensation);
            document.getElementById('stat-electricity-count').textContent = typeCounts.electricity;
            document.getElementById('stat-equipment-count').textContent = typeCounts.equipment;
            
            // Update chart
            updateStatisticsChart(typeCounts);
        }
        
        function updateStatisticsChart(typeCounts) {
            const chartCanvas = document.getElementById('stats-chart');
            if (!chartCanvas) return;
            
            if (statsChart) {
                statsChart.destroy();
            }
            
            statsChart = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['كهرباء وغاز', 'منحة تجهيز', 'تنقل', 'تكوين'],
                    datasets: [{
                        data: [
                            typeCounts?.electricity || 0,
                            typeCounts?.equipment || 0,
                            typeCounts?.transport || 0,
                            typeCounts?.training || 0
                        ],
                        backgroundColor: [
                            '#FFA726',
                            '#66BB6A',
                            '#42A5F5',
                            '#AB47BC'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333',
                                font: {
                                    family: 'IBM Plex Sans Arabic'
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Achievement System ---
        const achievements = {
            firstBeneficiary: { title: '🎉 أول مستفيد!', unlocked: false },
            tenBeneficiaries: { title: '🏆 عشرة مستفيدين!', unlocked: false },
            fiftyBeneficiaries: { title: '🌟 خمسون مستفيداً!', unlocked: false },
            firstExport: { title: '📊 أول تصدير!', unlocked: false },
            firstBackup: { title: '💾 أول نسخة احتياطية!', unlocked: false }
        };
        
        function checkAchievements() {
            const savedAchievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            
            // Check first beneficiary
            if (beneficiaries.length >= 1 && !savedAchievements.firstBeneficiary) {
                unlockAchievement('firstBeneficiary');
            }
            
            // Check ten beneficiaries
            if (beneficiaries.length >= 10 && !savedAchievements.tenBeneficiaries) {
                unlockAchievement('tenBeneficiaries');
            }
            
            // Check fifty beneficiaries
            if (beneficiaries.length >= 50 && !savedAchievements.fiftyBeneficiaries) {
                unlockAchievement('fiftyBeneficiaries');
            }
        }
        
        function unlockAchievement(key) {
            const savedAchievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            if (savedAchievements[key]) return;
            
            savedAchievements[key] = true;
            localStorage.setItem('achievements', JSON.stringify(savedAchievements));
            
            // Show achievement popup
            showAchievementPopup(achievements[key].title);
            
            // Trigger confetti
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
        
        function showAchievementPopup(text) {
            const popup = document.getElementById('achievement-popup');
            const textElement = document.getElementById('achievement-text');
            if (popup && textElement) {
                textElement.textContent = text;
                popup.classList.add('show');
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 4000);
            }
        }

        // --- Keyboard Shortcuts ---
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S: Save current form
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    const activeSection = document.querySelector('.app-section:not([style*="display: none"])');
                    if (activeSection) {
                        const saveBtn = activeSection.querySelector('button[type="submit"], .btn-primary');
                        if (saveBtn) saveBtn.click();
                    }
                    showToast('💾 تم الحفظ!', 'success');
                }
                
                // Ctrl/Cmd + N: New beneficiary
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openBeneficiaryModal();
                }
                
                // Ctrl/Cmd + P: Print report
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    printReport();
                }
                
                // Ctrl/Cmd + E: Export to Excel
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportXLSX();
                }
                
                // Ctrl/Cmd + B: Create backup
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    createBackup();
                }
                
                // Escape: Close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.visible').forEach(modal => {
                        modal.classList.remove('visible');
                        setTimeout(() => modal.style.display = 'none', 300);
                    });
                }
                // F1: Show keyboard shortcuts
                if (e.key === 'F1') {
                    e.preventDefault();
                    showKeyboardShortcutsModal();
                }
            });
        }
        
        function showKeyboardShortcutsModal() {
            const modal = document.getElementById('keyboard-shortcuts-modal');
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('visible'), 10);
            }
        }
        
        function closeKeyboardShortcutsModal() {
            const modal = document.getElementById('keyboard-shortcuts-modal');
            if (modal) {
                modal.classList.remove('visible');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        // --- Scroll to Top Button ---
        function initScrollToTop() {
            const scrollBtn = document.querySelector('.fab-btn.scroll-top');
            if (!scrollBtn) return;
            
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollBtn.classList.add('visible');
                } else {
                    scrollBtn.classList.remove('visible');
                }
            });
            
            scrollBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // --- Progress Bar for Scroll ---
        function initProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            if (!progressBar) return;
            
            window.addEventListener('scroll', () => {
                const scrollTop = window.scrollY;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                const progress = (scrollTop / docHeight) * 100;
                progressBar.style.width = progress + '%';
            });
        }

        // --- Celebration on Milestone ---
        function celebrateMilestone(message) {
            showToast(message, 'success');
            
            if (typeof confetti === 'function') {
                // Fire confetti from both corners
                const count = 200;
                const defaults = {
                    origin: { y: 0.7 }
                };

                function fire(particleRatio, opts) {
                    confetti({
                        ...defaults,
                        ...opts,
                        particleCount: Math.floor(count * particleRatio)
                    });
                }

                fire(0.25, { spread: 26, startVelocity: 55 });
                fire(0.2, { spread: 60 });
                fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
                fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
                fire(0.1, { spread: 120, startVelocity: 45 });
            }
        }

        // --- Quick Search with Highlight ---
        function enhanceSearch() {
            const searchInput = document.getElementById('compensation-grid-search');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                const rows = document.querySelectorAll('#compensation-grid-table tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (query && text.includes(query)) {
                        row.style.backgroundColor = 'rgba(252, 169, 3, 0.2)';
                    } else {
                        row.style.backgroundColor = '';
                    }
                });
            });
        }

        // --- Initialize All Creative Features ---
        function initCreativeFeatures() {
            // Initialize clock
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
            
            // Initialize particles
            initParticles();
            
            // Initialize keyboard shortcuts
            initKeyboardShortcuts();
            
            // Initialize scroll to top
            initScrollToTop();
            
            // Initialize progress bar
            initProgressBar();
            
            // Enhance search
            enhanceSearch();
            
            // Check achievements
            setTimeout(checkAchievements, 2000);
            
            // Add FAB container event listeners
            document.addEventListener('click', (e) => {
                if (e.target.closest('.stats-toggle')) {
                    toggleStatsDashboard();
                }
                if (e.target.closest('.keyboard-help')) {
                    showKeyboardShortcutsModal();
                }
                if (e.target.closest('.close-stats')) {
                    toggleStatsDashboard();
                }
                if (e.target.closest('.close-keyboard-modal')) {
                    closeKeyboardShortcutsModal();
                }
            });
            
            // Welcome message based on time
            showWelcomeMessage();
            
            console.log('✨ Creative features initialized successfully!');
        }
        
        // --- Welcome Message ---
        function showWelcomeMessage() {
            const hour = new Date().getHours();
            let greeting = '';
            let emoji = '';
            
            if (hour >= 5 && hour < 12) {
                greeting = 'صباح الخير';
                emoji = '🌅';
            } else if (hour >= 12 && hour < 17) {
                greeting = 'مرحباً بك';
                emoji = '☀️';
            } else if (hour >= 17 && hour < 21) {
                greeting = 'مساء الخير';
                emoji = '🌆';
            } else {
                greeting = 'مرحباً بك في الساعات المتأخرة';
                emoji = '🌙';
            }
            
            // Only show if first visit today
            const today = new Date().toDateString();
            const lastVisit = localStorage.getItem('lastVisitDate');
            
            if (lastVisit !== today) {
                localStorage.setItem('lastVisitDate', today);
                setTimeout(() => {
                    showToast(`${emoji} ${greeting}! مرحباً في برنامج حساب التعويضات`, 'info');
                }, 1500);
            }
        }
        
        // --- Sound Effects (Optional) ---
        function playSound(type) {
            // Sounds are optional - only play if user has enabled them
            const soundsEnabled = localStorage.getItem('soundsEnabled') === 'true';
            if (!soundsEnabled) return;
            
            // Simple beep using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'success':
                        oscillator.frequency.value = 880;
                        break;
                    case 'error':
                        oscillator.frequency.value = 220;
                        break;
                    case 'click':
                        oscillator.frequency.value = 440;
                        break;
                    default:
                        oscillator.frequency.value = 440;
                }
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Silently fail if audio is not available
            }
        }
        
        // --- Auto-update Stats when data changes ---
        const originalSaveData = typeof saveData === 'function' ? saveData : null;
        if (originalSaveData) {
            window.saveDataOriginal = saveData;
            window.saveData = function() {
                window.saveDataOriginal();
                // Update stats if dashboard is open
                const dashboard = document.getElementById('stats-dashboard');
                if (dashboard && dashboard.classList.contains('open')) {
                    updateStatistics();
                }
                // Check achievements after save
                setTimeout(checkAchievements, 500);
            };
        }
    </script>

</body>
</html>
