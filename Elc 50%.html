<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج حساب تعويض 50% من استهلاك الكهرباء والغاز</title>
    <meta name="description" content="برنامج احترافي لحساب وإدارة تعويضات استهلاك الكهرباء والغاز">
    <meta name="theme-color" content="#f59e0b">
    <!-- Include SheetJS library for XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS for styled XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <!-- Google Font for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
/* =============================================
   HONEY LIGHT THEME - الثيم العسلي الفاتح
   ============================================= */
:root {
    --bg-darkest: #fef3c7;
    --bg-dark: #fde68a;
    --bg-surface: #fffbeb;
    --bg-card: rgba(255, 255, 255, 0.92);
    --bg-card-hover: rgba(255, 251, 235, 0.95);
    --bg-elevated: rgba(255, 251, 235, 0.9);
    --gold: #f59e0b;
    --gold-light: #d97706;
    --gold-dark: #b45309;
    --gold-glow: rgba(245, 158, 11, 0.12);
    --accent-blue: #0ea5e9;
    --accent-purple: #8b5cf6;
    --accent-teal: #14b8a6;
    --success: #22c55e;
    --warning: #eab308;
    --danger: #ef4444;
    --text-primary: #451a03;
    --text-secondary: #92400e;
    --text-muted: #78350f;
    --border: rgba(245, 158, 11, 0.2);
    --border-light: rgba(245, 158, 11, 0.12);
    --glass: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(245, 158, 11, 0.2);
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-highlight: rgba(245, 158, 11, 0.05);
    --shadow: 0 4px 15px rgba(245, 158, 11, 0.15);
    --shadow-gold: 0 4px 20px rgba(245, 158, 11, 0.2);
    --shadow-glass: 0 10px 40px rgba(0, 0, 0, 0.08);
    --radius: 14px;
    --radius-sm: 10px;
    --radius-lg: 18px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --font-main: 'IBM Plex Sans Arabic', 'Cairo', sans-serif;
    --font-display: 'Cairo', sans-serif;
    --honey-gradient: linear-gradient(135deg, #fbbf24, #f59e0b, #ea580c);
    --honey-glow: 0 0 30px rgba(245, 158, 11, 0.4);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
    font-family: var(--font-main);
    background: var(--bg-darkest);
    background-image:
        radial-gradient(ellipse at 20% 20%, rgba(251, 191, 36, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(234, 88, 12, 0.05) 0%, transparent 60%);
    background-attachment: fixed;
    color: var(--text-primary);
    direction: rtl;
    min-height: 100vh;
    overflow-x: hidden;
    line-height: 1.6;
}

/* Scrollbar */
::-webkit-scrollbar { width: 7px; height: 7px; }
::-webkit-scrollbar-track { background: #fef3c7; border-radius: 5px; }
::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #d97706, #b45309); }

/* Selection */
::selection { background: rgba(245, 158, 11, 0.3); color: #451a03; }

/* ===== PARTICLES CANVAS ===== */
#particles-canvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none; opacity: 0.25;
}

/* ===== TOP NAVIGATION BAR ===== */
.top-navbar {
    position: fixed; top: 0; right: 0; left: 0; z-index: 1000;
    height: 60px;
    background: linear-gradient(180deg, #fef3c7, #fde68a);
    border-bottom: 2px solid #f59e0b;
    display: flex; align-items: center;
    padding: 0 16px; gap: 12px;
    box-shadow: 0 2px 15px rgba(245, 158, 11, 0.2);
}

.navbar-brand {
    display: flex; align-items: center; gap: 10px;
    padding-left: 16px; border-left: 1px solid rgba(245, 158, 11, 0.25);
    min-width: fit-content;
}

.navbar-brand > i {
    font-size: 1.3rem; color: #d97706;
    filter: drop-shadow(0 0 8px rgba(217, 119, 6, 0.3));
}

.navbar-brand > span {
    font-family: var(--font-display);
    font-weight: 700; font-size: 1rem;
    background: linear-gradient(135deg, #b45309, #d97706);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
}

.navbar-clock {
    display: flex; flex-direction: column; align-items: center;
    font-size: 0.68rem; color: var(--text-muted);
    margin-right: 10px; line-height: 1.3;
}

.navbar-clock #live-time {
    font-weight: 600; color: var(--text-secondary); font-size: 0.73rem;
    font-variant-numeric: tabular-nums;
}

.navbar-tabs {
    display: flex; align-items: center; gap: 4px;
    flex: 1; overflow-x: auto; padding: 0 6px;
    justify-content: center;
}

.navbar-tabs::-webkit-scrollbar { height: 0; }

.nav-tab, .nav-item {
    display: flex; align-items: center; gap: 7px;
    padding: 7px 16px; border: none; border-radius: 8px;
    background: transparent; color: #78350f;
    font-family: var(--font-main); font-size: 0.82rem; font-weight: 500;
    cursor: pointer; white-space: nowrap;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
}

.nav-tab i, .nav-item i {
    font-size: 0.9rem;
    transition: all 0.25s ease;
}

.nav-tab:hover, .nav-item:hover {
    background: rgba(245, 158, 11, 0.1);
    color: #451a03;
}

.nav-tab:hover i, .nav-item:hover i {
    color: var(--gold);
    transform: translateY(-1px);
}

.nav-tab.active, .nav-item.active {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.15));
    color: #b45309;
    font-weight: 600;
    border: 1px solid rgba(245, 158, 11, 0.3);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
}

.nav-tab.active::after, .nav-item.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    right: 15%; left: 15%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #f59e0b, #d97706, transparent);
    border-radius: 2px;
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
}

.nav-tab.active i, .nav-item.active i {
    color: #d97706;
    filter: drop-shadow(0 0 6px rgba(217, 119, 6, 0.4));
}

.nav-tab.home-tab {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(251, 191, 36, 0.08));
    border: 1px solid rgba(245, 158, 11, 0.2);
    padding: 7px 18px;
}

.nav-tab.home-tab:hover {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.18), rgba(251, 191, 36, 0.12));
    border-color: rgba(245, 158, 11, 0.3);
}

.nav-tab.home-tab.active {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.22), rgba(251, 191, 36, 0.15));
    border-color: rgba(245, 158, 11, 0.35);
    box-shadow: 0 2px 12px rgba(245, 158, 11, 0.15);
}

.navbar-actions {
    display: flex; align-items: center; gap: 6px;
    padding-right: 10px; border-right: 1px solid rgba(245, 158, 11, 0.25);
}

.navbar-btn {
    width: 34px; height: 34px; border: none; border-radius: 8px;
    background: rgba(245, 158, 11, 0.06); color: #78350f;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.25s ease; font-size: 0.9rem;
    border: 1px solid transparent;
}

.navbar-btn:hover {
    background: rgba(245, 158, 11, 0.15);
    color: #d97706;
    border-color: rgba(245, 158, 11, 0.3);
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.15);
}

/* Mobile menu */
.mobile-menu-btn {
    display: none; position: fixed; top: 12px; right: 12px; z-index: 1001;
    width: 40px; height: 40px; border: none; border-radius: var(--radius-sm);
    background: var(--bg-card); color: var(--gold); font-size: 1.2rem;
    cursor: pointer;
}

/* ===== MAIN CONTENT ===== */
.main-content {
    margin-top: 60px; padding: 20px 24px 48px 24px;
    min-height: calc(100vh - 60px);
    position: relative; z-index: 1;
    max-width: 1400px; margin-left: auto; margin-right: auto;
}

/* ===== MODE INDICATOR BAR ===== */
.mode-indicator {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px; margin-bottom: 20px;
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.mode-info {
    display: flex; align-items: center; gap: 10px;
    font-weight: 600; font-size: 1rem;
}

.mode-info i {
    font-size: 1.2rem; color: var(--gold);
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
    background: var(--gold-glow); border-radius: var(--radius-sm);
}

.change-mode-btn {
    padding: 6px 14px; border: 1px solid var(--border-light);
    border-radius: var(--radius-sm); background: var(--bg-elevated);
    color: var(--text-secondary); font-family: var(--font-main);
    font-size: 0.8rem; cursor: pointer; transition: var(--transition);
}

.change-mode-btn:hover {
    border-color: var(--gold-dark); color: var(--gold); background: var(--gold-glow);
}

/* Change Mode Nav Button */
.change-mode-nav-btn {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.1)) !important;
    border: 1px solid #d97706 !important;
    color: #b45309 !important;
    position: relative;
}
.change-mode-nav-btn:hover {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.25), rgba(251, 191, 36, 0.15)) !important;
    border-color: #f59e0b !important;
}
.change-mode-nav-btn i {
    color: var(--gold) !important;
}
.change-mode-nav-btn span {
    font-size: 0.72rem;
    max-width: 90px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ===== APP SECTIONS ===== */
.app-section {
    display: none;
    animation: sectionFadeIn 0.4s ease;
}

.app-section.active { display: block; }

@keyframes sectionFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Section Header */
.section-header {
    display: flex; align-items: center; gap: 16px;
    margin-bottom: 24px; padding: 20px 24px;
    background: linear-gradient(135deg, #fbbf24, #f59e0b, #ea580c);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
    color: #fff;
}

.section-icon {
    width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
    background: rgba(255, 255, 255, 0.25);
    border-radius: var(--radius); font-size: 1.3rem; color: #fff;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.section-title-info h2 {
    font-family: var(--font-display); font-size: 1.3rem;
    font-weight: 700; color: #fff; margin-bottom: 2px;
}

.section-desc {
    font-size: 0.85rem; color: rgba(255, 255, 255, 0.85);
}

/* ===== GUIDE / INSTRUCTIONS ===== */
.guide-header {
    text-align: center; padding: 30px 20px 20px;
    margin-bottom: 20px;
}
.guide-header-icon {
    width: 64px; height: 64px; margin: 0 auto 14px;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border-radius: 50%; color: #b45309; font-size: 1.8rem;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
}
.guide-header h2 {
    font-family: var(--font-display); font-size: 1.5rem;
    color: #78350f; margin-bottom: 6px; font-weight: 700;
}
.guide-header p {
    font-size: 0.9rem; color: var(--text-secondary);
}

.guide-card {
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: 12px;
    margin-bottom: 14px;
    overflow: hidden;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
}
.guide-card:hover {
    border-color: #f59e0b;
    box-shadow: 0 4px 20px rgba(245, 158, 11, 0.12);
}
.guide-card.open {
    border-color: #d97706;
    box-shadow: 0 6px 25px rgba(245, 158, 11, 0.18);
}

.guide-card-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px; cursor: pointer;
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    transition: background 0.2s ease;
    user-select: none;
}
.guide-card-header:hover {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
}
.guide-card-title {
    display: flex; align-items: center; gap: 12px;
}
.guide-card-title i {
    font-size: 1.3rem; width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    background: #fff; border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.guide-card-title h3 {
    font-size: 1rem; font-weight: 700; color: #451a03; margin: 0;
}
.guide-chevron {
    color: #92400e; font-size: 0.85rem;
    transition: transform 0.3s ease;
}
.guide-card.open .guide-chevron {
    transform: rotate(180deg);
}

.guide-card-body {
    display: none; padding: 0 20px 20px;
    border-top: 1px solid #fde68a;
}
.guide-card.open .guide-card-body {
    display: block;
}

.guide-section {
    padding: 14px 0;
    border-bottom: 1px solid #fef3c7;
}
.guide-section:last-child { border-bottom: none; }

.guide-section h4 {
    font-size: 0.92rem; font-weight: 700; color: #92400e;
    margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
}
.guide-section h4 i { color: #d97706; font-size: 0.85rem; }

.guide-section ul, .guide-section ol {
    padding-right: 22px; margin: 0;
}
.guide-section li {
    font-size: 0.87rem; color: #451a03; line-height: 1.8;
    margin-bottom: 4px;
}
.guide-section li strong {
    color: #78350f;
}
.guide-section li ul {
    margin-top: 4px;
}

.guide-section.guide-note {
    background: #fffbeb; border-radius: 8px;
    padding: 14px 16px; margin-top: 8px;
    border: 1px dashed #fbbf24; border-bottom: none;
}
.guide-section.guide-note h4 {
    color: #b45309;
}
.guide-section.guide-note h4 i {
    color: #f59e0b;
}

/* ===== FORM CARDS ===== */
.form-card {
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius); padding: 20px;
    margin-bottom: 16px; transition: var(--transition);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.form-card:hover { border-color: #f59e0b; }

.form-card h3, .card-title {
    font-size: 1rem; font-weight: 600; margin-bottom: 16px;
    padding-bottom: 10px; border-bottom: 1px solid #fde68a;
    display: flex; align-items: center; gap: 8px; color: #b45309;
}

.form-card h3 i, .card-title i { color: var(--gold); }

.form-row {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px;
}

label {
    display: block; font-size: 0.82rem; font-weight: 500;
    color: var(--text-secondary); margin-bottom: 6px;
}

input[type="text"], input[type="number"], input[type="password"],
select, textarea {
    width: 100%; padding: 10px 14px;
    background: #ffffff; border: 1px solid #fde68a;
    border-radius: var(--radius-sm); color: #451a03;
    font-family: var(--font-main); font-size: 0.9rem;
    transition: var(--transition); outline: none;
}

input:focus, select:focus, textarea:focus {
    border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
}

input[readonly] {
    background: #fef3c7; color: #78350f;
    cursor: default; border-style: dashed;
}

/* ===== BUTTONS ===== */
.save-button, .primary-action-btn, button[type="submit"] {
    padding: 10px 20px; border: none; border-radius: var(--radius-sm);
    background: var(--honey-gradient);
    color: #fff; font-family: var(--font-main);
    font-weight: 600; font-size: 0.9rem; cursor: pointer;
    transition: var(--transition); display: inline-flex;
    align-items: center; gap: 8px;
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.2);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.save-button:hover, .primary-action-btn:hover, button[type="submit"]:hover {
    background: linear-gradient(135deg, var(--gold-light), var(--gold), var(--gold-dark));
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(245, 158, 11, 0.3);
}

.cancel-button {
    padding: 10px 20px; border: 1px solid var(--border);
    border-radius: var(--radius-sm); background: var(--bg-elevated);
    color: var(--text-secondary); font-family: var(--font-main);
    font-weight: 500; font-size: 0.9rem; cursor: pointer;
    transition: var(--transition); display: inline-flex;
    align-items: center; gap: 8px;
}

.cancel-button:hover {
    background: rgba(239, 68, 68, 0.1); border-color: var(--danger);
    color: var(--danger);
}

.modal-buttons {
    display: flex; gap: 10px; justify-content: flex-end;
    margin-top: 20px; padding-top: 14px;
    border-top: 1px solid var(--border);
}

/* ===== CREDIT SUMMARY ===== */
.credit-summary-container {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px;
    margin-bottom: 20px;
}

.credit-card {
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius); padding: 16px;
    display: flex; align-items: center; gap: 12px;
    transition: var(--transition); position: relative; overflow: hidden;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.credit-card::before {
    content: ''; position: absolute; top: 0; right: 0; bottom: 0;
    width: 4px; border-radius: 0 var(--radius) var(--radius) 0;
}

.credit-card:nth-child(1)::before { background: var(--accent-blue); }
.credit-card.spent::before { background: var(--gold); }
.credit-card.discounts::before { background: var(--accent-purple); }
.credit-card.remaining::before { background: var(--success); }
.credit-card.negative-credit::before { background: var(--danger) !important; }

.credit-card > i {
    font-size: 1.3rem; color: var(--gold);
    width: 40px; height: 40px; display: flex; align-items: center;
    justify-content: center; background: var(--gold-glow);
    border-radius: var(--radius-sm); flex-shrink: 0;
}

.credit-card.spent > i { color: var(--warning); background: rgba(245,158,11,0.1); }
.credit-card.discounts > i { color: var(--accent-purple); background: rgba(139,92,246,0.1); }
.credit-card.remaining > i { color: var(--success); background: rgba(34,197,94,0.1); }

.credit-info { flex: 1; }

.credit-label {
    font-size: 0.75rem; color: var(--text-muted); display: block;
    margin-bottom: 2px; font-weight: 500;
}

.credit-value {
    font-family: var(--font-display); font-size: 1.1rem;
    font-weight: 700; color: var(--text-primary);
}

.credit-value.negative, .remaining-credit-value.negative { color: var(--danger) !important; }
.credit-card.negative-credit { border-color: rgba(239, 68, 68, 0.3) !important; }

/* ===== COMPENSATION GRID ===== */
.section-content { margin-top: 0; }

.compensation-grid-toolbar {
    display: flex; align-items: center; justify-content: space-between;
    gap: 12px; margin-bottom: 16px; flex-wrap: wrap;
}

.search-container {
    position: relative; flex: 1; max-width: 350px;
}

.search-container i {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    color: var(--text-muted); font-size: 0.85rem;
}

.search-container input {
    padding-right: 36px !important;
}

.actions-container {
    display: flex; align-items: center; gap: 10px;
}

/* Quarter Toggle Controls */
.quarter-toggles {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 14px; margin-bottom: 14px;
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius-sm);
}

.quarter-toggles-label {
    font-size: 0.82rem; color: var(--text-muted); font-weight: 500;
    margin-left: 10px;
}

.quarter-toggle {
    display: flex; align-items: center; gap: 6px;
    padding: 4px 10px; border-radius: 20px;
    background: var(--bg-elevated); border: 1px solid var(--border);
    cursor: pointer; transition: var(--transition);
    user-select: none;
}

.quarter-toggle.active {
    background: var(--gold-glow); border-color: var(--gold-dark);
}

.quarter-toggle input[type="checkbox"] { display: none; }

.quarter-toggle-indicator {
    width: 14px; height: 14px; border-radius: 50%;
    border: 2px solid var(--text-muted); transition: var(--transition);
}

.quarter-toggle.active .quarter-toggle-indicator {
    background: var(--gold); border-color: var(--gold);
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.45);
}

.quarter-toggle-text {
    font-size: 0.78rem; font-weight: 500; color: var(--text-muted);
    transition: var(--transition);
}

.quarter-toggle.active .quarter-toggle-text { color: var(--gold-light); }

/* Batch Operations */
.batch-toolbar {
    display: none; align-items: center; gap: 10px;
    padding: 10px 14px; margin-bottom: 12px;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(251, 191, 36, 0.05));
    border: 1px solid rgba(245, 158, 11, 0.25); border-radius: var(--radius-sm);
    animation: sectionFadeIn 0.3s ease;
}

.batch-toolbar.visible { display: flex; }

.batch-toolbar .batch-count {
    font-size: 0.85rem; color: var(--gold-light); font-weight: 600;
}

.batch-btn {
    padding: 6px 12px; border: 1px solid var(--border);
    border-radius: var(--radius-sm); background: var(--bg-elevated);
    color: var(--text-secondary); font-family: var(--font-main);
    font-size: 0.8rem; cursor: pointer; transition: var(--transition);
    display: flex; align-items: center; gap: 4px;
}

.batch-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
.batch-btn.danger:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: var(--danger); }

/* Grid Table */
.compensation-grid-container {
    overflow-x: auto; border-radius: 16px;
    background: #ffffff;
    box-shadow: 0 10px 40px rgba(245, 158, 11, 0.12);
    overflow: hidden;
}

#compensation-grid-table {
    width: 100%; border-collapse: collapse;
    font-size: 0.85rem;
    background-color: #fff;
    border: 2px solid #b45309;
    border-radius: 8px;
    overflow: hidden;
}

#compensation-grid-table thead th {
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%) !important;
    padding: 12px 8px; text-align: center;
    font-weight: 700; font-size: 0.82rem;
    color: #fff !important; border: 1px solid #92400e;
    border-bottom: 3px solid #78350f;
    white-space: nowrap; position: sticky; top: 0; z-index: 10;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    letter-spacing: 0.3px;
}

#compensation-grid-table tbody td {
    padding: 10px 8px; text-align: center;
    border: 1px solid #d4a373;
    color: #451a03; vertical-align: middle;
    font-weight: 500;
    white-space: nowrap;
}

/* Column widths */
.batch-col { width: 36px; }
#compensation-grid-table th:nth-child(2),
#compensation-grid-table td:nth-child(2) { width: 40px; }
#compensation-grid-table th:nth-child(3),
#compensation-grid-table td:nth-child(3) { 
    text-align: right; padding-right: 12px !important;
    white-space: nowrap;
}
#compensation-grid-table th.status-column { width: 100px; }

#compensation-grid-table tbody tr:hover td {
    background: rgba(245, 158, 11, 0.12) !important;
}

#compensation-grid-table tbody tr:nth-child(even) td {
    background-color: #fef9ee;
}

#compensation-grid-table tbody tr.is-dirty td {
    background: rgba(245, 158, 11, 0.08);
}

/* Quarter disabled state */
#compensation-grid-table td.quarter-disabled {
    opacity: 0.3; text-decoration: line-through;
    color: var(--text-muted) !important;
    background: var(--bg-dark) !important;
    cursor: not-allowed;
    position: relative;
}

#compensation-grid-table th.quarter-disabled {
    opacity: 0.4; position: relative;
}

#compensation-grid-table th.quarter-disabled::after {
    content: '✕'; position: absolute; top: 2px; left: 4px;
    font-size: 0.65rem; color: var(--danger);
}

/* Batch selection styles */
.batch-col { text-align: center; padding: 4px !important; }
.batch-col input[type="checkbox"] {
    width: 16px; height: 16px; cursor: pointer;
    accent-color: var(--gold);
}
#compensation-grid-table tbody tr.batch-selected {
    background: rgba(245, 158, 11, 0.12) !important;
    box-shadow: inset 3px 0 0 var(--gold);
}
#compensation-grid-table tbody tr.batch-selected td {
    background: transparent !important;
}

.editable-cell {
    cursor: pointer; position: relative;
    transition: background 0.15s ease;
}

.editable-cell:hover {
    background: rgba(217, 119, 6, 0.12) !important;
    color: #451a03 !important;
}

.grid-input {
    width: 80px; padding: 5px 6px; text-align: center;
    background: #fffdf7 !important; border: 1.5px solid #d4a373 !important;
    border-radius: 6px !important; color: #451a03 !important;
    font-size: 0.83rem !important; font-family: var(--font-main) !important;
    font-weight: 600 !important;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.grid-input:focus {
    border-color: #d97706 !important;
    box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.2) !important;
    outline: none;
}

.calculated-cell { font-weight: 600; color: #92400e !important; }
.total-comp-cell { color: #78350f !important; font-weight: 700; font-size: 0.9rem; }
.net-payable-cell { color: #166534 !important; font-weight: 700; font-size: 0.9rem; }

.beneficiary-name-cell {
    text-align: right !important;
    position: relative;
}

.beneficiary-name-cell span { font-weight: 700; color: #451a03; font-size: 0.88rem; white-space: nowrap; }

.beneficiary-actions {
    position: absolute; left: 4px; top: 50%; transform: translateY(-50%);
    display: flex; gap: 4px;
    opacity: 0; transition: opacity 0.2s ease;
}

tr:hover .beneficiary-name-cell .beneficiary-actions { opacity: 1; }

.edit-btn-inline, .delete-btn-inline {
    width: 28px; height: 28px; border: none; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem; transition: all 0.2s ease;
    background: none; color: #92400e;
}

.edit-btn-inline:hover { color: #d97706; background: rgba(217, 119, 6, 0.15); }
.delete-btn-inline:hover { color: #dc2626; background: rgba(220, 38, 38, 0.1); }

/* Batch checkbox in table */
.batch-checkbox {
    width: 16px; height: 16px; accent-color: var(--gold);
    cursor: pointer;
}

/* Status Badges */
.status-badge {
    display: inline-block; padding: 3px 10px; border-radius: 20px;
    font-size: 0.72rem; font-weight: 600; letter-spacing: 0.3px;
}

.status-badge.saved {
    background: #dcfce7; color: #166534;
    border: 1px solid #86efac;
    font-weight: 700;
}

.status-badge.empty, .status-badge.unsaved {
    background: #fef2f2; color: #991b1b;
    border: 1px solid #fca5a5;
    font-weight: 700;
}

.status-column { width: 100px; }

/* Completion indicator */
.completion-bar {
    width: 50px; height: 4px; background: var(--bg-elevated);
    border-radius: 2px; overflow: hidden; margin: 4px auto 0;
}

.completion-fill {
    height: 100%; border-radius: 2px;
    background: linear-gradient(90deg, var(--gold), var(--success));
    transition: width 0.3s ease;
}

/* ===== REPORT SECTION ===== */
.export-actions-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px; margin-bottom: 20px;
}

.export-card {
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius); padding: 20px; text-align: center;
    cursor: pointer; transition: var(--transition);
    display: flex; flex-direction: column; align-items: center; gap: 10px;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.export-card:hover {
    transform: translateY(-4px); border-color: #f59e0b;
    box-shadow: 0 8px 30px rgba(245, 158, 11, 0.2);
}

.export-card i {
    font-size: 2rem; color: var(--gold);
    width: 56px; height: 56px; display: flex; align-items: center;
    justify-content: center; background: var(--gold-glow);
    border-radius: 50%;
}

.export-card h4 {
    font-size: 0.9rem; font-weight: 600; color: var(--text-primary);
}

.export-card p {
    font-size: 0.75rem; color: var(--text-muted);
}

#report-preview {
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius); padding: 20px;
}

/* Report preview table styling (on-screen) */
#report-preview table {
    width: 100%; border-collapse: collapse;
    border: 2px solid #b45309; margin-top: 10px;
    background-color: #fff; border-radius: 8px; overflow: hidden;
}
#report-preview th, #report-preview td {
    border: 1px solid #d4a373; padding: 10px 8px;
    text-align: center; font-size: 0.85rem;
    color: #451a03; vertical-align: middle;
}
#report-preview thead th {
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%);
    color: #fff; font-weight: 700; font-size: 0.82rem;
    border: 1px solid #92400e;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    padding: 12px 8px;
}
#report-preview tbody tr:nth-child(even) { background-color: #fef9ee; }
#report-preview .total-row td {
    font-weight: 700; background: #fef3c7;
    border: 1px solid #d4a373; color: #78350f;
}

/* ===== BACKUP SECTION ===== */
.backup-cards {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px;
}

.backup-card {
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius); padding: 24px; text-align: center;
    cursor: pointer; transition: var(--transition);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.backup-card:hover {
    transform: translateY(-4px); border-color: #f59e0b;
    box-shadow: 0 8px 30px rgba(245, 158, 11, 0.2);
}

.backup-card i {
    font-size: 2.2rem; color: var(--gold); margin-bottom: 12px;
}

.backup-card h4 {
    font-size: 0.95rem; font-weight: 600; color: var(--text-primary);
    margin-bottom: 6px;
}

.backup-card p {
    font-size: 0.78rem; color: var(--text-muted);
}

.backup-card.danger-card:hover {
    border-color: var(--danger);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.1);
}

.backup-card.danger-card i { color: var(--danger); }

/* ===== PRO TXT EDITOR SECTION ===== */
.editor-controls {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px; margin-bottom: 16px;
}

.editor-info-cards {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;
    margin-bottom: 16px;
}

.info-card {
    background: #ffffff; border: 1px solid #fde68a;
    border-radius: var(--radius-sm); padding: 14px; text-align: center;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.info-card .info-value {
    font-family: var(--font-display); font-size: 1.4rem;
    font-weight: 700; color: var(--gold-light);
}

.info-card .info-label {
    font-size: 0.78rem; color: var(--text-muted);
}

.editor-actions {
    display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;
}

.editor-actions button {
    padding: 8px 16px; border: 1px solid var(--border);
    border-radius: var(--radius-sm); background: var(--bg-elevated);
    color: var(--text-secondary); font-family: var(--font-main);
    font-size: 0.83rem; cursor: pointer; transition: var(--transition);
    display: flex; align-items: center; gap: 6px;
}

.editor-actions button:hover {
    background: var(--bg-card-hover); color: var(--text-primary);
    border-color: var(--gold-dark);
}

.editor-actions button.primary-btn {
    background: var(--honey-gradient);
    color: #fff; border: none; font-weight: 600;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
}

.editor-actions button.primary-btn:hover {
    background: linear-gradient(135deg, var(--gold-light), var(--gold), var(--gold-dark));
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
}

.pro-editor-container {
    overflow-x: auto; border-radius: 8px;
    background: #ffffff;
    box-shadow: 0 4px 20px rgba(180, 83, 9, 0.1);
    overflow: hidden;
}

#pro-editor-table {
    width: 100%; border-collapse: collapse; font-size: 0.82rem;
}

#pro-editor-table thead th {
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%); padding: 12px 8px;
    font-weight: 700; color: white;
    border: 1px solid #92400e;
    border-bottom: 3px solid #78350f;
    white-space: nowrap; text-align: center;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

#pro-editor-table tbody td {
    padding: 8px 6px; text-align: center;
    border: 1px solid #d4a373; color: #451a03;
}

#pro-editor-table tbody tr:nth-child(even) { background: #fffbeb; }
#pro-editor-table tbody tr:hover td { background: var(--bg-card-hover); }

#pro-editor-table input {
    width: 100%; padding: 4px 6px; background: transparent;
    border: 1px solid transparent; border-radius: 4px;
    color: var(--text-primary); font-size: 0.82rem; text-align: center;
}

#pro-editor-table input:focus {
    background: var(--bg-elevated); border-color: var(--gold);
}

#pro-editor-table tfoot td {
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%); padding: 12px 8px;
    font-weight: 700; color: white;
    border-top: 3px solid #78350f;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

/* ===== MODALS ===== */
.modal-overlay {
    display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; z-index: 2000;
    background: rgba(69, 26, 3, 0.3); backdrop-filter: blur(10px);
    align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s ease;
}

.modal-overlay.visible { opacity: 1; }

.modal-content {
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius-lg); padding: 28px;
    width: 95%; max-width: 550px; max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 24px 80px rgba(245, 158, 11, 0.2);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from { transform: translateY(-20px) scale(0.95); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
}

.modal-content h2, .modal-content h3 {
    font-family: var(--font-display); font-size: 1.1rem;
    font-weight: 700; color: #b45309;
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}

.modal-content h2 i, .modal-content h3 i { color: var(--gold); }

/* Mode Selection Modal */
.mode-btn {
    display: flex; align-items: center; gap: 14px;
    width: 100%; padding: 16px 20px; margin-bottom: 10px;
    border: 1px solid #fde68a; border-radius: var(--radius);
    background: #fffbeb;
    color: #451a03;
    font-family: var(--font-main); font-size: 0.9rem;
    cursor: pointer; transition: var(--transition); text-align: right;
}

.mode-btn:hover {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
    transform: translateX(-4px);
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.15);
}

.mode-btn i {
    font-size: 1.5rem; color: var(--gold);
    width: 44px; height: 44px; display: flex; align-items: center;
    justify-content: center; background: var(--gold-glow);
    border-radius: var(--radius-sm); flex-shrink: 0;
}

.mode-btn strong { font-weight: 600; }

.mode-btn small { color: var(--text-muted) !important; }

/* Import TXT Modal */
.import-format-options { margin: 12px 0; }

.import-option {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; margin-bottom: 6px;
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    cursor: pointer; transition: var(--transition);
}

.import-option:hover { border-color: var(--gold-dark); background: var(--gold-glow); }
.import-option.highlight-option { border-color: var(--gold-dark); }

.import-option input[type="radio"] { accent-color: var(--gold); }

.option-text strong { font-weight: 600; display: block; }
.option-text small { color: var(--text-muted); font-size: 0.78rem; }

.import-options-extra {
    margin: 10px 0; padding: 8px 14px;
    background: var(--bg-elevated); border-radius: var(--radius-sm);
}

.checkbox-option {
    display: flex; align-items: center; gap: 8px;
    font-size: 0.85rem; cursor: pointer; color: var(--text-secondary);
}

.checkbox-option input[type="checkbox"] { accent-color: var(--gold); }

.import-preview {
    margin-top: 14px; padding: 14px;
    background: var(--bg-elevated); border-radius: var(--radius-sm);
    border: 1px solid var(--border);
}

.import-preview-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px;
}

.import-preview h4 { font-size: 0.9rem; color: var(--gold-light); }

.selection-buttons { display: flex; gap: 6px; }

.btn-select-all, .btn-select-none {
    padding: 4px 10px; border: 1px solid var(--border);
    border-radius: 4px; background: var(--bg-card);
    color: var(--text-secondary); font-size: 0.75rem;
    cursor: pointer; transition: var(--transition);
}

.btn-select-all:hover, .btn-select-none:hover {
    border-color: var(--gold-dark); color: var(--gold);
}

.preview-table-container {
    max-height: 200px; overflow-y: auto;
}

#import-preview-table {
    width: 100%; border-collapse: collapse; font-size: 0.82rem;
}

#import-preview-table th {
    background: var(--bg-card); padding: 6px 8px;
    color: var(--gold-light); font-weight: 600;
}

#import-preview-table td {
    padding: 6px 8px; border-bottom: 1px solid var(--border);
}

.preview-count {
    margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);
}

/* Restore Type Modal */
.restore-option {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 14px; margin-bottom: 8px;
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    cursor: pointer; transition: var(--transition);
}

.restore-option:hover { border-color: var(--gold-dark); background: var(--gold-glow); }

/* ===== CREDIT WARNING BANNER ===== */
#credit-warning-banner {
    position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%);
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: white; padding: 12px 24px;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    display: flex; align-items: center; gap: 10px;
    z-index: 900; font-size: 0.85rem; font-weight: 500;
    transition: bottom 0.4s ease; box-shadow: 0 -4px 20px rgba(239, 68, 68, 0.3);
    max-width: 90%;
}

#credit-warning-banner.visible { bottom: 0; }

#credit-warning-banner .close-warning {
    background: none; border: none; color: white;
    font-size: 1.2rem; cursor: pointer; margin-right: 8px;
    opacity: 0.8; transition: opacity 0.2s;
}

#credit-warning-banner .close-warning:hover { opacity: 1; }

/* ===== SCROLL TO TOP ===== */
.scroll-to-top-btn {
    position: fixed; bottom: 24px; left: 24px; z-index: 800;
    width: 44px; height: 44px; border: none;
    border-radius: 50%; background: var(--honey-gradient);
    color: #fff; font-size: 1.1rem;
    cursor: pointer; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
    display: none; align-items: center; justify-content: center;
    transition: var(--transition);
    border: 1px solid rgba(245, 158, 11, 0.1);
}

.scroll-to-top-btn:hover {
    transform: translateY(-3px); background: linear-gradient(135deg, var(--gold-light), var(--gold));
    box-shadow: 0 6px 28px rgba(245, 158, 11, 0.4);
}

/* ===== TICKER ===== */
#ticker-container {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    border-top: 2px solid #d97706;
    overflow: hidden; height: 32px; z-index: 500;
}

#ticker-content {
    display: flex; white-space: nowrap;
    animation: ticker-scroll 40s linear infinite;
    line-height: 32px; font-size: 0.78rem;
    color: #000; padding: 0 20px; font-weight: 500;
}

@keyframes ticker-scroll {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

/* ===== FLOATING SHAPES (Simplified) ===== */
.floating-shapes-container {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none; overflow: hidden; opacity: 0.15;
}

.floating-shape {
    position: absolute; animation: floatGentle 20s ease-in-out infinite;
}

.floating-shape.shape-sphere {
    width: 100px; height: 100px; top: 15%; left: 10%;
    background: radial-gradient(circle, rgba(245, 158, 11, 0.12), rgba(245, 197, 99, 0.04), transparent);
    border-radius: 50%; animation-delay: 0s;
}

.floating-shape.shape-ring {
    width: 70px; height: 70px; top: 60%; right: 15%;
    border: 2px solid rgba(245, 158, 11, 0.15); border-radius: 50%;
    animation-delay: -5s; opacity: 0.5;
}

.floating-shape.shape-diamond {
    width: 35px; height: 35px; top: 40%; left: 70%;
    background: rgba(245, 158, 11, 0.1); transform: rotate(45deg);
    animation-delay: -10s;
    border-radius: 4px;
}

.floating-shape.shape-cube,
.floating-shape.shape-cube-sm,
.floating-shape.shape-pyramid,
.floating-shape.shape-hex,
.floating-shape.shape-dots {
    display: none; /* Simplified - hide complex shapes */
}

.floating-shape .face { display: none; }
.floating-shape.shape-dots span { display: none; }

@keyframes floatGentle {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-20px) rotate(5deg); }
    50% { transform: translateY(-10px) rotate(-3deg); }
    75% { transform: translateY(-25px) rotate(7deg); }
}

/* ===== PROGRESS BAR ===== */
.progress-container {
    position: fixed; top: 60px; left: 0; right: 0;
    height: 3px; z-index: 999; background: transparent;
}

.progress-bar {
    height: 100%; width: 0;
    background: var(--honey-gradient);
    transition: width 0.3s ease;
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
}

/* ===== ACHIEVEMENT POPUP ===== */
.achievement-popup {
    position: fixed; top: 80px; left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius); padding: 12px 20px;
    display: flex; align-items: center; gap: 10px;
    z-index: 1800; transition: transform 0.4s ease, opacity 0.4s ease;
    box-shadow: 0 8px 32px rgba(245, 158, 11, 0.2);
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
}

.achievement-popup.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
    pointer-events: auto;
    visibility: visible;
}

.achievement-popup i { color: var(--gold); font-size: 1.2rem; }

/* ===== RESPONSIVE ===== */
@media screen and (max-width: 1024px) {
    .credit-summary-container { grid-template-columns: repeat(2, 1fr); }
}

@media screen and (max-width: 768px) {
    .top-navbar {
        flex-wrap: wrap; height: auto; padding: 8px 12px; gap: 6px;
    }

    .navbar-tabs {
        order: 3; width: 100%; overflow-x: auto;
        padding: 4px 0; gap: 3px; -webkit-overflow-scrolling: touch;
        justify-content: flex-start;
    }

    .nav-tab, .nav-item {
        padding: 6px 12px; font-size: 0.78rem;
    }

    .navbar-brand { padding-left: 0; border-left: none; }
    .navbar-clock { display: none; }
    .navbar-actions { margin-right: auto; border-right: none; padding-right: 0; }

    .main-content {
        margin-top: 100px; padding: 12px;
    }

    .credit-summary-container { grid-template-columns: 1fr; }
    .editor-info-cards { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }

    #compensation-management-section.app-section.active .credit-summary-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
        padding: 6px 8px;
    }

    #compensation-management-section.app-section.active .credit-card {
        padding: 6px 8px;
    }

    #compensation-management-section.app-section.active .credit-value {
        font-size: 0.82rem;
    }
    .export-actions-grid { grid-template-columns: 1fr 1fr; }
    .backup-cards { grid-template-columns: 1fr 1fr; }
    .floating-shapes-container { display: none; }

    .section-header { flex-direction: column; text-align: center; padding: 14px; }
    .section-icon { margin: 0 auto; }

    .compensation-grid-toolbar { flex-direction: column; }
    .search-container { max-width: 100%; }


    .quarter-toggles { flex-wrap: wrap; }
}

@media screen and (max-width: 480px) {
    .export-actions-grid { grid-template-columns: 1fr; }
    .backup-cards { grid-template-columns: 1fr; }
    .nav-tab span { display: none; }
    .nav-tab { padding: 8px 10px; }
}

/* ===== PRINT STYLES ===== */
@media print {
            body {
                padding: 0; margin: 0; background: #ffffff !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; font-family: 'Amiri', serif !important; color: #000 !important;
            }

            body::before {
                display: none !important;
            }
            
            body > * {
                display: none !important;
            }
            #print-report-content {
                display: block !important;
                background: #ffffff !important;
            }

            @page {
                size: landscape; 
                margin: 1cm 1cm 2cm 1cm;
                @bottom-left {
                    content: "الصفحة " counter(page) " من " counter(pages);
                    font-family: 'Amiri', serif;
                    font-size: 10pt;
                    color: #000;
                }
            }

            #print-report-content.report-output {
                padding: 0; margin: 0; border: none; box-shadow: none; overflow: hidden; 
                font-size: 10pt; color: #000 !important; background-color: #ffffff !important;
                font-family: 'Amiri', serif !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                height: auto;
                max-height: 100%;
            }
            
            #print-report-content * {
                page-break-after: avoid !important;
            }
            
            #print-report-content .report-footer {
                orphans: 3;
                widows: 3;
            }
            #print-report-content table {
                width: 100%; border-collapse: collapse; table-layout: fixed; 
                border: 2px solid #000 !important;
                background-color: #ffffff !important;
            }
            #print-report-content th, #print-report-content td {
                font-size: 9pt; padding: 3px 5px; text-align: center; 
                border: 1px solid #000 !important; color: #000 !important;
                background-color: #ffffff !important;
                word-wrap: break-word;
                vertical-align: middle;
            }
            
            #print-report-content tbody tr {
                background-color: #ffffff !important;
            }
            #print-report-content th:nth-child(1), #print-report-content td:nth-child(1) { width: 4%; }
            #print-report-content th:nth-child(2), #print-report-content td:nth-child(2) { width: 20%; text-align: right; padding-right: 8px; }
            #print-report-content th:nth-child(3), #print-report-content td:nth-child(3) { width: 8%; }
            #print-report-content th:nth-child(4), #print-report-content td:nth-child(4) { width: 16%; }
            #print-report-content th:nth-child(5), #print-report-content td:nth-child(5) { width: 6%; }
            #print-report-content th:nth-child(6), #print-report-content td:nth-child(6) { width: 6%; }
            #print-report-content th:nth-child(7), #print-report-content td:nth-child(7) { width: 6%; }
            #print-report-content th:nth-child(8), #print-report-content td:nth-child(8) { width: 6%; }
            #print-report-content th:nth-child(9), #print-report-content td:nth-child(9) { width: 8%; font-weight: bold; }
            #print-report-content th:nth-child(10), #print-report-content td:nth-child(10) { width: 8%; }
            #print-report-content th:nth-child(11), #print-report-content td:nth-child(11) { width: 12%; font-weight: bold; }
            
            #print-report-content th { 
                background-color: #E0E0E0 !important; 
            }
            
            #print-report-content thead {
                display: table-header-group;
            }
            #print-report-content tbody {
                display: table-row-group;
            }
            
            #print-report-content .total-row th,
            #print-report-content .total-row td { 
                background-color: #E0E0E0 !important; 
                font-weight: bold;
            }
            #print-report-content .report-header, 
            #print-report-content .report-footer {
                color: #000 !important;
                page-break-after: avoid;
                page-break-inside: avoid;
            }
            
            #print-report-content .report-header p,
            #print-report-content .report-footer p {
                margin: 2px 0 !important;
                line-height: 1.2 !important;
            }
            
            #print-report-content .report-footer {
                margin-top: 8px !important;
                margin-bottom: 0 !important;
            }
            
            #print-report-content table {
                page-break-after: avoid;
                margin-bottom: 5px !important;
            }
}

/* ===== TOAST ANIMATION ===== */
@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}

/* ===== TOP BAR (kept for compatibility) ===== */
.top-bar { display: none; }
.sidebar { display: none; }
.app-wrapper { display: contents; }

/* Equipment grant field */
#equipment-grant-field { margin-top: 14px; }

/* Beneficiary popup detail */
.beneficiary-popup {
    position: fixed; z-index: 1800;
    background: var(--bg-card); border: 1px solid #fde68a;
    border-radius: var(--radius); padding: 16px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    min-width: 280px; max-width: 350px;
    animation: modalSlideIn 0.2s ease;
}

.beneficiary-popup h4 {
    font-size: 0.95rem; color: var(--gold-light); margin-bottom: 10px;
    display: flex; align-items: center; gap: 6px;
    padding-bottom: 8px; border-bottom: 1px solid var(--border);
}

.popup-detail {
    display: flex; justify-content: space-between;
    padding: 4px 0; font-size: 0.82rem;
}

.popup-detail-label { color: var(--text-muted); }
.popup-detail-value { color: var(--text-primary); font-weight: 500; }

.popup-close {
    position: absolute; top: 8px; left: 8px;
    width: 24px; height: 24px; border: none;
    border-radius: 50%; background: var(--bg-elevated);
    color: var(--text-muted); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; transition: var(--transition);
}

.popup-close:hover { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

/* Fullscreen compensation section mode */
#compensation-management-section.app-section.active {
    position: fixed;
    top: 60px; left: 0; right: 0; bottom: 32px;
    z-index: 900;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    background: linear-gradient(180deg, #fef3c7, #fde68a);
    overflow: hidden;
    border-radius: 0;
    animation: none;
}

#compensation-management-section.app-section.active .section-header {
    display: none;
}

#compensation-management-section.app-section.active .section-content {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
    padding: 0;
    margin: 0;
}

/* Compact credit summary in fullscreen */
#compensation-management-section.app-section.active .credit-summary-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    padding: 8px 12px;
    margin: 0;
    background: linear-gradient(180deg, rgba(254, 243, 199, 0.95), rgba(254, 243, 199, 0.92));
    border-bottom: 1px solid #fde68a;
    flex-shrink: 0;
}

#compensation-management-section.app-section.active .credit-card {
    padding: 8px 12px;
    border-radius: 8px;
    gap: 8px;
}

#compensation-management-section.app-section.active .credit-card > i {
    width: 32px; height: 32px; font-size: 1rem;
    border-radius: 6px;
}

#compensation-management-section.app-section.active .credit-value {
    font-size: 0.95rem;
}

#compensation-management-section.app-section.active .credit-label {
    font-size: 0.68rem;
}

/* Compact toolbar area */
#compensation-management-section.app-section.active .quarter-toggles {
    padding: 5px 12px;
    margin: 0;
    border-radius: 0;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}

#compensation-management-section.app-section.active .batch-toolbar {
    margin: 0;
    border-radius: 0;
    padding: 6px 12px;
    flex-shrink: 0;
}

#compensation-management-section.app-section.active .compensation-grid-toolbar {
    padding: 6px 12px;
    margin: 0;
    flex-shrink: 0;
    background: rgba(254, 243, 199, 0.85);
    border-bottom: 1px solid var(--border);
}

/* Table fills remaining space */
#compensation-management-section.app-section.active .compensation-grid-container {
    flex: 1;
    overflow: auto;
    border-radius: 0;
    border: none;
    margin: 0;
}

#compensation-management-section.app-section.active #compensation-grid-table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%) !important;
    color: #fff !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

/* Exit fullscreen button */
.fullscreen-exit-btn {
    position: fixed;
    top: 66px;
    left: 12px;
    z-index: 950;
    width: 34px; height: 34px;
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.95);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.25s ease;
    display: none;
    align-items: center; justify-content: center;
}

.fullscreen-exit-btn.visible {
    display: flex;
}

.fullscreen-exit-btn:hover {
    color: var(--gold-light);
    border-color: rgba(245, 158, 11, 0.35);
    background: rgba(245, 158, 11, 0.12);
}

.fullscreen-btn {
    padding: 6px 10px; border: 1px solid var(--border);
    border-radius: var(--radius-sm); background: var(--bg-elevated);
    color: var(--text-muted); cursor: pointer; font-size: 0.8rem;
    transition: var(--transition);
}

.fullscreen-btn:hover { color: var(--gold); border-color: var(--gold-dark); }

/* Save all indicator */
.save-equipment-btn, .save-manual-btn {
    background: none !important; border: none !important;
    cursor: pointer !important;
}

/* ===== PRO TXT EDITOR EXTRA STYLES ===== */
.pro-empty-state {
    display: none;
}

.pro-empty-state.visible {
    display: block !important;
}

#pro-editor-table .amount-input {
    width: 110px; padding: 5px 8px; text-align: center;
    background: var(--bg-elevated); border: 1px solid var(--border);
    border-radius: 4px; color: var(--text-primary);
    font-size: 0.85rem; font-family: var(--font-main);
    transition: var(--transition);
}

#pro-editor-table .amount-input:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 2px var(--gold-glow);
}

#pro-editor-table .amount-input.modified {
    border-color: var(--warning);
    background: rgba(245, 158, 11, 0.08);
    color: var(--warning);
    font-weight: 600;
}

#pro-editor-table .pro-account-input {
    width: 120px; padding: 5px 8px; text-align: center;
    background: var(--bg-elevated); border: 1px solid var(--border);
    border-radius: 4px; color: var(--text-primary);
    font-size: 0.85rem; font-family: var(--font-main);
    transition: var(--transition);
}

#pro-editor-table .pro-account-input:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 2px var(--gold-glow);
}

#pro-editor-table .pro-rip-display {
    font-size: 0.78rem; color: var(--text-secondary);
    font-family: monospace; direction: ltr; display: inline-block;
}

#pro-editor-table .original-amount {
    color: var(--text-muted); font-size: 0.83rem;
}

#pro-editor-table .delete-btn {
    width: 30px; height: 30px; border: none; border-radius: 4px;
    background: rgba(239, 68, 68, 0.1); color: var(--danger);
    cursor: pointer; display: inline-flex; align-items: center;
    justify-content: center; transition: var(--transition);
    font-size: 0.8rem;
}

#pro-editor-table .delete-btn:hover {
    background: rgba(239, 68, 68, 0.25);
}

#pro-fiscal-month-input {
    width: 100%; padding: 10px 14px;
    background: var(--bg-elevated); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text-primary);
    font-family: var(--font-main); font-size: 0.9rem;
    transition: var(--transition); outline: none;
}

#pro-fiscal-month-input:focus {
    border-color: var(--gold); box-shadow: 0 0 0 3px var(--gold-glow);
}

/* ===== COMBINED COMPENSATIONS SECTION STYLES ===== */
.combined-filter-bar {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    padding: 10px 14px;
    background: #ffffff; border: 1px solid #fde68a;
    border-radius: var(--radius-sm);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.combined-filter-label {
    font-size: 0.82rem; color: var(--text-muted); font-weight: 500;
    margin-left: 8px; display: flex; align-items: center; gap: 6px;
}

.combined-filter-label i { color: var(--gold-light); }

.combined-filter-toggle {
    display: flex; align-items: center; gap: 6px;
    padding: 5px 12px; border-radius: 20px;
    background: #fffbeb; border: 1px solid var(--border);
    cursor: pointer; transition: var(--transition);
    user-select: none; font-size: 0.8rem; color: var(--text-muted);
}

.combined-filter-toggle input[type="checkbox"] { display: none; }

.combined-filter-toggle i {
    font-size: 0.75rem; transition: var(--transition);
}

.combined-filter-toggle.active {
    background: rgba(245, 158, 11, 0.12); border-color: rgba(245, 158, 11, 0.3);
    color: var(--gold-light);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.08);
}

.combined-filter-toggle.active i { color: var(--gold-light); }

.combined-filter-toggle:hover {
    border-color: rgba(245, 158, 11, 0.25); color: var(--text-primary);
}

.combined-financial-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 14px 16px;
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: 10px;
    align-items: flex-end;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}
.combined-field-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-width: 150px;
}
.combined-field-group label {
    font-size: 0.75rem;
    color: var(--gold-light);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
}
.combined-field-group label i {
    font-size: 0.7rem;
    opacity: 0.7;
}
.combined-field-group input,
.combined-field-group select {
    background: #fffbeb;
    border: 1px solid #fde68a;
    color: var(--text-primary);
    padding: 7px 10px;
    border-radius: 7px;
    font-size: 0.82rem;
    font-family: inherit;
    transition: border-color 0.2s;
    width: 100%;
    box-sizing: border-box;
}
.combined-field-group input:focus,
.combined-field-group select:focus {
    border-color: var(--gold-light);
    outline: none;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15), 0 0 12px rgba(245, 158, 11, 0.08);
}
.combined-field-group select option {
    background: #ffffff;
    color: #451a03;
}

.combined-summary-bar {
    display: flex; gap: 12px;
}

.combined-stat {
    flex: 1; display: flex; align-items: center; gap: 10px;
    padding: 10px 16px;
    background: #ffffff; border: 1px solid #fde68a;
    border-radius: var(--radius-sm);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

.combined-stat i {
    color: var(--gold-light); font-size: 1.1rem;
    width: 34px; height: 34px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(245, 158, 11, 0.15); border-radius: 8px; flex-shrink: 0;
}

.combined-stat span {
    font-family: var(--font-display); font-size: 1.15rem;
    font-weight: 700; color: var(--text-primary);
}

.combined-stat small {
    font-size: 0.72rem; color: var(--text-muted); font-weight: 500;
}

.combined-actions {
    display: flex; align-items: center; justify-content: space-between;
    gap: 10px; flex-wrap: wrap;
}

.combined-table-container {
    overflow-x: auto; border-radius: 8px;
    background: #ffffff;
    box-shadow: 0 4px 20px rgba(180, 83, 9, 0.1);
    overflow: hidden;
}

#combined-table {
    width: 100%; border-collapse: collapse;
    font-size: 0.85rem;
    background-color: white;
    border: 2px solid #b45309;
    border-radius: 8px;
    overflow: hidden;
}

#combined-table thead th {
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%);
    padding: 14px 12px; text-align: center;
    font-weight: 700; font-size: 0.8rem;
    color: white; border: 1px solid #92400e;
    border-bottom: 3px solid #78350f;
    white-space: nowrap; position: sticky; top: 0; z-index: 5;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    letter-spacing: 0.3px;
}

#combined-table tbody td {
    padding: 12px 10px; text-align: center;
    border: 1px solid #d4a373;
    color: #451a03;
}

#combined-table tbody tr:nth-child(even) td {
    background-color: #fef9ee;
}

#combined-table tbody tr:hover td {
    background: rgba(245, 158, 11, 0.12);
}

#combined-table tfoot td {
    padding: 12px 10px; text-align: center;
    border-top: 3px solid #78350f;
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%);
    color: white; font-weight: 700;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

/* Combined Detailed Report Table */
#combined-detailed-table thead th {
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%);
    padding: 12px 8px; text-align: center;
    font-weight: 700; font-size: 0.75rem;
    color: white; border: 1px solid #92400e;
    border-bottom: 3px solid #78350f;
    white-space: nowrap; position: sticky; top: 0; z-index: 5;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
#combined-detailed-table tbody td {
    padding: 10px 6px; text-align: center;
    border: 1px solid #d4a373;
    font-size: 0.82rem; color: #451a03;
}

#combined-detailed-table tbody tr:nth-child(even) td {
    background-color: #fef9ee;
}
#combined-detailed-table tbody tr:hover td {
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), rgba(234, 88, 12, 0.08));
}
#combined-detailed-table tfoot td {
    padding: 12px 8px; text-align: center;
    border-top: 3px solid #78350f;
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%);
    color: white; font-weight: 700;
    font-size: 0.82rem;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
#combined-report-preview {
    margin-top: 10px;
    padding: 14px;
    background: #ffffff;
    border: 1px solid #fde68a;
    border-radius: var(--radius);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
}

/* Combined report preview table styling (on-screen) */
#combined-report-preview table {
    width: 100%; border-collapse: collapse;
    border: 2px solid #b45309; margin-top: 10px;
    background-color: #fff; border-radius: 8px; overflow: hidden;
}
#combined-report-preview th, #combined-report-preview td {
    border: 1px solid #d4a373; padding: 10px 8px;
    text-align: center; font-size: 0.85rem;
    color: #451a03; vertical-align: middle;
}
#combined-report-preview thead th {
    background: linear-gradient(135deg, #92400e 0%, #b45309 40%, #d97706 100%);
    color: #fff; font-weight: 700; font-size: 0.82rem;
    border: 1px solid #92400e;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    padding: 12px 8px;
}
#combined-report-preview tbody tr:nth-child(even) { background-color: #fef9ee; }
#combined-report-preview .total-row td {
    font-weight: 700; background: #fef3c7;
    border: 1px solid #d4a373; color: #78350f;
}

.combined-type-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px; border-radius: 20px;
    font-size: 0.72rem; font-weight: 600;
}

.combined-type-badge.type-electricity {
    background: rgba(245, 158, 11, 0.1); color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.2);
}
.combined-type-badge.type-equipment {
    background: rgba(139, 92, 246, 0.1); color: #8b5cf6;
    border: 1px solid rgba(139, 92, 246, 0.2);
}
.combined-type-badge.type-transport {
    background: rgba(34, 197, 94, 0.1); color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.2);
}
.combined-type-badge.type-training {
    background: rgba(74, 158, 255, 0.1); color: #4a9eff;
    border: 1px solid rgba(74, 158, 255, 0.2);
}

.combined-rip-cell {
    font-family: monospace; font-size: 0.78rem;
    color: var(--text-secondary); direction: ltr; display: inline-block;
}

@media screen and (max-width: 768px) {
    .combined-summary-bar { flex-direction: column; }
    .combined-financial-bar { gap: 8px; }
    .combined-financial-bar .combined-field-group { min-width: 120px; }
    .combined-filter-bar { gap: 6px; }
    .combined-actions { flex-direction: column; }
    .combined-actions .search-container { max-width: 100% !important; }
}

    </style>
</head>
<body>

    <!-- Particle Canvas -->
    <canvas id="particles-canvas"></canvas>

    <!-- Floating Shapes (Simplified) -->
    <div class="floating-shapes-container">
        <div class="floating-shape shape-sphere"></div>
        <div class="floating-shape shape-ring"></div>
        <div class="floating-shape shape-diamond"></div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievement-popup">
        <i class="fas fa-trophy"></i>
        <span id="achievement-text">إنجاز جديد!</span>
    </div>

    <!-- TOP NAVIGATION BAR -->
    <nav class="top-navbar" id="top-navbar">
        <div class="navbar-brand">
            <i class="fas fa-calculator"></i>
            <span>تعويضات 50%</span>
            <div class="navbar-clock">
                <span id="live-time">--:--:--</span>
                <span id="live-date">----/--/--</span>
            </div>
        </div>
        <div class="navbar-tabs sidebar-nav">
            <button id="switch-mode-btn" class="nav-tab nav-item home-tab">
                <i class="fas fa-book-open"></i>
                <span>التعليمات</span>
            </button>
            <button class="nav-tab nav-item change-mode-nav-btn" onclick="document.getElementById('mode-selection-modal').style.display='flex'; setTimeout(()=>document.getElementById('mode-selection-modal').classList.add('visible'),10);" title="تغيير نوع التعويض">
                <i class="fas fa-exchange-alt"></i>
                <span id="nav-mode-label">الكهرباء والغاز</span>
            </button>
            <button data-section="institution-info-section" class="nav-tab nav-item">
                <i class="fas fa-building"></i>
                <span>المؤسسة</span>
            </button>
            <button data-section="compensation-management-section" class="nav-tab nav-item">
                <i class="fas fa-users"></i>
                <span>التعويضات</span>
            </button>
            <button data-section="combined-compensations-section" class="nav-tab nav-item">
                <i class="fas fa-layer-group"></i>
                <span>تعويضات متعددة</span>
            </button>
            <button data-section="reporting-section" class="nav-tab nav-item">
                <i class="fas fa-file-alt"></i>
                <span>التقارير</span>
            </button>
            <button data-section="pro-txt-editor-section" class="nav-tab nav-item">
                <i class="fas fa-edit"></i>
                <span>المحرر</span>
            </button>
            <button data-section="backup-restore-section" class="nav-tab nav-item">
                <i class="fas fa-database"></i>
                <span>النسخ الاحتياطي</span>
            </button>
        </div>
        <div class="navbar-actions">
            <button class="navbar-btn" id="sound-toggle-btn" title="الأصوات">
                <i class="fas fa-volume-up"></i>
            </button>

        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="main-content">



        <!-- ======= DASHBOARD SECTION (NEW) ======= -->
        <section id="dashboard-section" class="app-section" style="display: block;">
            <div class="guide-header">
                <div class="guide-header-icon"><i class="fas fa-book-open"></i></div>
                <h2>دليل التعليمات والإرشادات</h2>
                <p>دليل شامل ومفصّل لاستخدام البرنامج</p>
            </div>

            <!-- إرشادات عامة لاستخدام البرنامج -->
            <div class="guide-card open" id="guide-general">
                <div class="guide-card-header" onclick="toggleGuide('guide-general')">
                    <div class="guide-card-title">
                        <i class="fas fa-lightbulb" style="color: #0ea5e9;"></i>
                        <h3>إرشادات عامة لاستخدام البرنامج</h3>
                    </div>
                    <i class="fas fa-chevron-down guide-chevron"></i>
                </div>
                <div class="guide-card-body">
                    <div class="guide-section">
                        <h4><i class="fas fa-keyboard"></i> إدخال البيانات</h4>
                        <ul>
                            <li>الاسم واللقب يُكتبان <strong>باللغة اللاتينية (الفرنسية)</strong> حصراً، ولا يقبل البرنامج الحروف العربية في هذا الحقل.</li>
                            <li>رقم الحساب البريدي CCP يتكون من <strong>20 رقماً بالضبط</strong>. البرنامج يرفض أي رقم أقل أو أكثر.</li>
                            <li>رقم RIP (Relevé d'Identité Postale) يُحسب تلقائياً من رقم الحساب. لا حاجة لإدخاله يدوياً.</li>
                        </ul>
                    </div>
                    <div class="guide-section">
                        <h4><i class="fas fa-save"></i> الحفظ والنسخ الاحتياطي</h4>
                        <ul>
                            <li>جميع البيانات تُحفظ تلقائياً في ذاكرة المتصفح (localStorage).</li>
                            <li><strong>تحذير:</strong> مسح بيانات المتصفح أو إعادة تثبيته يؤدي إلى فقدان جميع البيانات!</li>
                            <li>يُنصح بشدة بعمل <strong>نسخ احتياطي</strong> دوري من قسم "النسخ الاحتياطي" وحفظ الملف في مكان آمن.</li>
                            <li>يمكنك استعادة البيانات لاحقاً من ملف النسخ الاحتياطي.</li>
                        </ul>
                    </div>
                    <div class="guide-section">
                        <h4><i class="fas fa-exchange-alt"></i> التبديل بين أنواع التعويضات</h4>
                        <ul>
                            <li>اضغط على زر تغيير نوع التعويض في شريط التنقل للتبديل بين الأوضاع.</li>
                            <li>كل نوع تعويض له بياناته ومستفيدوه المستقلين تماماً.</li>
                            <li>معلومات المؤسسة (الاعتماد، رقم الأمر بالدفع، رقم الحوالة) <strong>مستقلة لكل نوع تعويض</strong>.</li>
                            <li>الوضع "المُجمَّع" يسمح بدمج جميع أنواع التعويضات في جدول واحد.</li>
                        </ul>
                    </div>
                    <div class="guide-section">
                        <h4><i class="fas fa-print"></i> الطباعة والتقارير</h4>
                        <ul>
                            <li>قسم "التقارير والطباعة" يُولِّد جدولاً تفصيلياً جاهزاً للطباعة.</li>
                            <li>يتضمن التقرير المطبوع: رأس المؤسسة، الجدول التفصيلي، المجاميع.</li>
                            <li>يُنصح باستخدام إعدادات طباعة "أفقي" (Landscape) للجداول العريضة.</li>
                            <li>محرر TXT يُتيح تصدير البيانات بتنسيق نصي لاستخدامها في برامج أخرى.</li>
                        </ul>
                    </div>
                    <div class="guide-section">
                        <h4><i class="fas fa-tasks"></i> العمليات الجماعية</h4>
                        <ul>
                            <li>يمكنك تحديد عدة مستفيدين باستخدام مربعات الاختيار (✓) في العمود الأول.</li>
                            <li>"تحديد الكل" في رأس الجدول يُحدد جميع المستفيدين دفعة واحدة.</li>
                            <li>العمليات الجماعية تشمل: الحذف الجماعي، التصدير الجماعي.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- ======= INSTITUTION INFO SECTION ======= -->
        <section id="institution-info-section" class="app-section">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-building"></i></div>
                <div class="section-title-info">
                    <h2>معلومات المؤسسة</h2>
                    <p class="section-desc">بيانات المؤسسة والمعلومات المالية</p>
                </div>
            </div>
            <form id="institution-info-form" onsubmit="saveInstitutionInfo(event)">
                <div class="form-card">
                    <h3><i class="fas fa-landmark"></i> المعلومات الرسمية</h3>
                    <div class="form-row">
                        <div>
                            <label for="republic">الجمهورية:</label>
                            <input type="text" id="republic" value="الجمهورية الجزائرية الديمقراطية الشعبية">
                        </div>
                        <div>
                            <label for="ministry">الوزارة:</label>
                            <input type="text" id="ministry" value="وزارة التربية الوطنية">
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 14px;">
                        <div>
                            <label for="directorate">المديرية:</label>
                            <input type="text" id="directorate">
                        </div>
                        <div>
                            <label for="institution">المؤسسة:</label>
                            <input type="text" id="institution">
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <h3><i class="fas fa-coins"></i> المعلومات المالية</h3>
                    <div class="form-row">
                        <div>
                            <label for="fiscal-year">السنة المالية:</label>
                            <input type="text" id="fiscal-year" maxlength="4" pattern="\d{4}" placeholder="2025">
                        </div>
                        <div>
                            <label for="financial-month">الشهر المالي:</label>
                            <input type="text" id="financial-month" placeholder="مثال: 3">
                        </div>
                        <div>
                            <label for="treasury-account">حساب الخزينة:</label>
                            <input type="text" id="treasury-account">
                        </div>
                        <div>
                            <label for="treasury-key">مفتاح الخزينة:</label>
                            <input type="text" id="treasury-key">
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <h3><i class="fas fa-file-invoice-dollar"></i> معلومات الصرف</h3>
                    <div class="form-row">
                        <div>
                            <label for="order-number">رقم الأمر بالدفع:</label>
                            <input type="text" id="order-number">
                        </div>
                        <div>
                            <label for="transfer-number">رقم الحوالة:</label>
                            <input type="text" id="transfer-number">
                        </div>
                        <div>
                            <label for="open-credit">الاعتماد المفتوح:</label>
                            <input type="number" id="open-credit" step="0.01" value="0">
                        </div>
                    </div>
                    <div id="equipment-grant-field" style="display: none; margin-top: 14px;">
                        <label for="equipment-grant-value">قيمة منحة التجهيز للفرد:</label>
                        <input type="number" id="equipment-grant-value" step="0.01" value="0">
                    </div>
                </div>

                <button type="submit" class="save-button" style="margin-top: 10px;">
                    <i class="fas fa-save"></i> حفظ المعلومات
                </button>
            </form>
        </section>

        <!-- ======= COMPENSATION MANAGEMENT SECTION ======= -->
        <section id="compensation-management-section" class="app-section">
            <div class="section-header management-header">
                <div class="section-icon"><i class="fas fa-users"></i></div>
                <div class="section-title-info">
                    <h2>إدارة التعويضات والمستفيدين</h2>
                    <p class="section-desc">إدارة وحساب تعويضات المستفيدين</p>
                </div>
            </div>
            <div class="section-content">
                <div class="credit-summary-container">
                    <div class="credit-card">
                        <i class="fas fa-wallet"></i>
                        <div class="credit-info">
                            <span class="credit-label">الاعتماد المفتوح</span>
                            <span class="credit-value" id="display-open-credit">0,00 دج</span>
                        </div>
                    </div>
                    <div class="credit-card spent">
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="credit-info">
                            <span class="credit-label">مجموع التعويضات (المصروف من الاعتماد)</span>
                            <span class="credit-value" id="display-amount-spent">0,00 دج</span>
                        </div>
                    </div>
                    <div class="credit-card discounts">
                        <i class="fas fa-hand-holding-usd"></i>
                        <div class="credit-info">
                            <span class="credit-label">المبالغ المخصومة (تُحوَّل لجهة أخرى)</span>
                            <span class="credit-value" id="display-total-discounts">0,00 دج</span>
                        </div>
                    </div>
                    <div class="credit-card remaining">
                        <i class="fas fa-piggy-bank"></i>
                        <div class="credit-info">
                            <span class="credit-label">الاعتماد المتبقي</span>
                            <span class="credit-value remaining-credit-value" id="display-remaining-credit">0,00 دج</span>
                        </div>
                    </div>
                </div>

                <!-- Quarter Toggles (electricity mode only) -->
                <div class="quarter-toggles" id="quarter-toggles" style="display: none;">
                    <span class="quarter-toggles-label"><i class="fas fa-sliders-h"></i> تفعيل/تعطيل الثلاثيات:</span>
                    <label class="quarter-toggle active" data-quarter="1">
                        <input type="checkbox" checked>
                        <span class="quarter-toggle-indicator"></span>
                        <span class="quarter-toggle-text">ث 1</span>
                    </label>
                    <label class="quarter-toggle active" data-quarter="2">
                        <input type="checkbox" checked>
                        <span class="quarter-toggle-indicator"></span>
                        <span class="quarter-toggle-text">ث 2</span>
                    </label>
                    <label class="quarter-toggle active" data-quarter="3">
                        <input type="checkbox" checked>
                        <span class="quarter-toggle-indicator"></span>
                        <span class="quarter-toggle-text">ث 3</span>
                    </label>
                    <label class="quarter-toggle active" data-quarter="4">
                        <input type="checkbox" checked>
                        <span class="quarter-toggle-indicator"></span>
                        <span class="quarter-toggle-text">ث 4</span>
                    </label>
                </div>

                <!-- Batch Operations Toolbar -->
                <div class="batch-toolbar" id="batch-toolbar">
                    <span class="batch-count" id="batch-count">0 محدد</span>
                    <button class="batch-btn danger" onclick="batchDeleteBeneficiaries()">
                        <i class="fas fa-trash-alt"></i> حذف المحددين
                    </button>
                    <button class="batch-btn" onclick="clearBatchSelection()">
                        <i class="fas fa-times"></i> إلغاء التحديد
                    </button>
                </div>

                <div class="compensation-grid-toolbar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="compensation-grid-search" placeholder="بحث بالاسم أو CCP...">
                    </div>
                    <div class="actions-container">
                        <input type="checkbox" id="auto-save-checkbox" checked style="display: none;">
                        <button id="add-beneficiary-btn" class="primary-action-btn"><i class="fas fa-user-plus"></i> إضافة مستفيد جديد</button>
                    </div>
                </div>
                <div class="compensation-grid-container" id="compensation-grid-container">
                    <table id="compensation-grid-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اللقب و الاسم</th>
                                <th>تعويض ث 1</th>
                                <th>تعويض ث 2</th>
                                <th>تعويض ث 3</th>
                                <th>تعويض ث 4</th>
                                <th>المجموع</th>
                                <th>الخصم</th>
                                <th>الصافي للدفع</th>
                                <th class="status-column">الحالة</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ======= REPORTING SECTION ======= -->
        <section id="reporting-section" class="app-section">
            <div class="section-header reports-header">
                <div class="section-icon"><i class="fas fa-file-alt"></i></div>
                <div class="section-title-info">
                    <h2>التقارير والتصدير</h2>
                    <p class="section-desc">طباعة وتصدير البيانات بتنسيقات مختلفة</p>
                </div>
            </div>
            <div class="export-actions-grid">
                <div class="export-card" onclick="printReport()">
                    <i class="fas fa-print"></i>
                    <h4>طباعة التقرير</h4>
                    <p>طباعة حالة الحوالة كاملة</p>
                </div>
                <div class="export-card" onclick="exportXLSX()">
                    <i class="fas fa-file-excel"></i>
                    <h4>تصدير Excel</h4>
                    <p>تصدير البيانات بتنسيق XLSX</p>
                </div>
                <div class="export-card" onclick="exportTxt()">
                    <i class="fas fa-file-alt"></i>
                    <h4>تصدير TXT</h4>
                    <p>ملف الدفع الإلكتروني</p>
                </div>
                <div class="export-card" onclick="printCDRomReport()">
                    <i class="fas fa-compact-disc"></i>
                    <h4>حالة الحوالة CD-ROM</h4>
                    <p>طباعة حالة حوالة القرص المضغوط</p>
                </div>
            </div>
            <div id="report-preview"></div>
        </section>

        <!-- ======= PRO TXT EDITOR SECTION ======= -->
        <section id="pro-txt-editor-section" class="app-section">
            <div class="section-header editor-header">
                <div class="section-icon"><i class="fas fa-edit"></i></div>
                <div class="section-title-info">
                    <h2>محرر ملف TXT المتقدم <span style="background: var(--gold-glow); color: var(--gold); padding: 2px 8px; border-radius: 4px; font-size: 0.6em;">PRO</span></h2>
                    <p class="section-desc">هذا التبويب مخصص للتعديل على مبالغ المستفيدين في حالة وجود مبالغ إضافية أو مسترجعة. قم بتعديل المبلغ ثم تصدير ملف TXT الجديد.</p>
                    <p class="section-desc"><strong>ملاحظة:</strong> بإمكانك استدعاء التعويضات المحجوزة أو استيراد ملف TXT سابق والتعديل عليه، ثم تصدير الملف الجديد لحرقه على CD وطباعة جدول الإرسال.</p>
                </div>
            </div>

            <div class="editor-controls">
                <div>
                    <label for="pro-fiscal-year-input"><i class="fas fa-calendar-alt"></i> السنة المالية:</label>
                    <input type="number" id="pro-fiscal-year-input" min="2020" max="2050" value="2025" onchange="updateProInfo()">
                </div>
                <div>
                    <label for="pro-fiscal-month-input"><i class="fas fa-calendar-day"></i> الشهر المالي:</label>
                    <select id="pro-fiscal-month-input" onchange="updateProInfo()">
                        <option value="1">جانفي (01)</option>
                        <option value="2">فيفري (02)</option>
                        <option value="3">مارس (03)</option>
                        <option value="4">أفريل (04)</option>
                        <option value="5">ماي (05)</option>
                        <option value="6">جوان (06)</option>
                        <option value="7">جويلية (07)</option>
                        <option value="8">أوت (08)</option>
                        <option value="9">سبتمبر (09)</option>
                        <option value="10">أكتوبر (10)</option>
                        <option value="11">نوفمبر (11)</option>
                        <option value="12">ديسمبر (12)</option>
                    </select>
                </div>
                <div>
                    <label for="pro-order-number"><i class="fas fa-file-invoice"></i> رقم الأمر بالصرف:</label>
                    <input type="number" id="pro-order-number" min="0" value="0" onchange="updateProInfo()">
                </div>
                <div>
                    <label for="pro-transfer-number"><i class="fas fa-money-check-alt"></i> رقم الحوالة:</label>
                    <input type="number" id="pro-transfer-number" min="0" value="0" onchange="updateProInfo()">
                </div>
                <div>
                    <label for="pro-treasury-account"><i class="fas fa-university"></i> رقم حساب الخزينة CCP:</label>
                    <input type="text" id="pro-treasury-account" placeholder="رقم حساب الخزينة" onchange="updateProInfo()">
                </div>
                <div>
                    <label for="pro-key-number"><i class="fas fa-key"></i> رقم المفتاح:</label>
                    <input type="text" id="pro-key-number" placeholder="رقم المفتاح" onchange="updateProInfo()">
                </div>
            </div>

            <div class="editor-info-cards">
                <div class="info-card">
                    <div class="info-value" id="pro-beneficiary-count">0</div>
                    <div class="info-label">عدد المستفيدين</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="pro-total-amount">0,00 دج</div>
                    <div class="info-label">المجموع الكلي</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="pro-data-source">التعويضات المحجوزة</div>
                    <div class="info-label">مصدر البيانات</div>
                </div>
            </div>

            <div class="editor-actions">
                <button onclick="proImportTxt()" class="primary-btn"><i class="fas fa-file-import"></i> استيراد ملف TXT</button>
                <input type="file" id="pro-import-file-input" accept=".txt" style="display:none" onchange="proHandleFileImport(event)">
                <button onclick="proLoadFromCompensations()"><i class="fas fa-sync-alt"></i> تحميل من التعويضات</button>
                <button onclick="proExportTxt()"><i class="fas fa-file-export"></i> تصدير ملف TXT</button>
                <button onclick="proPrintCDRom()"><i class="fas fa-print"></i> طباعة جدول CD-ROM</button>
                <button onclick="proResetAmounts()"><i class="fas fa-undo"></i> استعادة المبالغ الأصلية</button>
                <button onclick="proClearTable()"><i class="fas fa-trash-alt"></i> مسح الجدول</button>
            </div>

            <div class="pro-editor-container">
                <table id="pro-editor-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th style="width: 180px;">اللقب والاسم</th>
                            <th style="width: 140px;">CCP (قابل للتعديل)</th>
                            <th style="width: 180px;">RIP</th>
                            <th style="width: 120px;">المبلغ الأصلي</th>
                            <th style="width: 140px;">المبلغ المعدل</th>
                            <th style="width: 50px;">حذف</th>
                        </tr>
                    </thead>
                    <tbody id="pro-editor-tbody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4">المجموع الكلي</td>
                            <td id="pro-original-total">0,00</td>
                            <td id="pro-modified-total">0,00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                <div class="pro-empty-state" id="pro-empty-state" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <i class="fas fa-file-alt" style="font-size: 2.5rem; color: var(--gold); margin-bottom: 12px; display: block;"></i>
                    <p style="font-size: 1rem; margin-bottom: 6px;">لا توجد بيانات حالياً</p>
                    <p style="font-size: 0.82rem;">قم باستيراد ملف TXT أو تحميل البيانات من التعويضات المحجوزة</p>
                </div>
            </div>
        </section>

        <!-- ======= BACKUP & RESTORE SECTION ======= -->
        <section id="backup-restore-section" class="app-section">
            <div class="section-header backup-header">
                <div class="section-icon"><i class="fas fa-database"></i></div>
                <div class="section-title-info">
                    <h2>النسخ الاحتياطي والاستعادة</h2>
                    <p class="section-desc">حماية البيانات والنسخ الاحتياطي</p>
                </div>
            </div>
            <div class="backup-cards">
                <div class="backup-card" onclick="createBackup()">
                    <i class="fas fa-download"></i>
                    <h4>إنشاء نسخة احتياطية</h4>
                    <p>حفظ جميع البيانات في ملف</p>
                </div>
                <div class="backup-card" onclick="document.getElementById('restore-file-input').click()">
                    <i class="fas fa-upload"></i>
                    <h4>استعادة نسخة احتياطية</h4>
                    <p>استيراد بيانات من ملف سابق</p>
                    <input type="file" id="restore-file-input" accept=".json" style="display:none">
                </div>
                <div class="backup-card danger-card" id="delete-all-beneficiaries-btn">
                    <i class="fas fa-trash-alt"></i>
                    <h4>حذف جميع البيانات</h4>
                    <p>مسح كل المستفيدين والتعويضات</p>
                </div>
                <div class="backup-card" id="import-txt-btn">
                    <i class="fas fa-file-import"></i>
                    <h4>استيراد من ملف TXT</h4>
                    <p>استيراد المستفيدين من ملف نصي</p>
                    <input type="file" id="import-txt-input" accept=".txt,.csv" style="display: none;">
                </div>
            </div>
        </section>

        <!-- ======= COMBINED COMPENSATIONS SECTION ======= -->
        <section id="combined-compensations-section" class="app-section">
            <div class="section-header combined-header">
                <div class="section-icon" style="background: linear-gradient(135deg, var(--gold-light), var(--accent-purple));"><i class="fas fa-layer-group"></i></div>
                <div class="section-title-info">
                    <h2>تعويضات متعددة ومختلفة</h2>
                    <p class="section-desc">جمع المستفيدين من جميع أنواع التعويضات - تصدير TXT وطباعة CD-ROM</p>
                </div>
            </div>
            <div class="section-content" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Filter toggles -->
                <div class="combined-filter-bar">
                    <span class="combined-filter-label"><i class="fas fa-filter"></i> أنواع التعويضات:</span>
                    <label class="combined-filter-toggle active" data-type="electricity">
                        <input type="checkbox" checked onchange="combinedFilterChanged()">
                        <i class="fas fa-bolt"></i>
                        <span>الكهرباء والغاز</span>
                    </label>
                    <label class="combined-filter-toggle active" data-type="equipment">
                        <input type="checkbox" checked onchange="combinedFilterChanged()">
                        <i class="fas fa-chair"></i>
                        <span>منحة التجهيز</span>
                    </label>
                    <label class="combined-filter-toggle active" data-type="transport">
                        <input type="checkbox" checked onchange="combinedFilterChanged()">
                        <i class="fas fa-bus"></i>
                        <span>مصاريف التنقل</span>
                    </label>
                    <label class="combined-filter-toggle active" data-type="training">
                        <input type="checkbox" checked onchange="combinedFilterChanged()">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>العمليات التكوينية</span>
                    </label>
                </div>

                <!-- Financial Info Fields -->
                <div class="combined-financial-bar">
                    <div class="combined-field-group">
                        <label for="combined-fiscal-year"><i class="fas fa-calendar"></i> السنة المالية</label>
                        <input type="number" id="combined-fiscal-year" placeholder="2026" min="2000" max="2100" value="2026">
                    </div>
                    <div class="combined-field-group">
                        <label for="combined-fiscal-month"><i class="fas fa-calendar-day"></i> الشهر المالي</label>
                        <select id="combined-fiscal-month">
                            <option value="1">جانفي (01)</option>
                            <option value="2">فيفري (02)</option>
                            <option value="3">مارس (03)</option>
                            <option value="4">أفريل (04)</option>
                            <option value="5">ماي (05)</option>
                            <option value="6">جوان (06)</option>
                            <option value="7">جويلية (07)</option>
                            <option value="8">أوت (08)</option>
                            <option value="9">سبتمبر (09)</option>
                            <option value="10">أكتوبر (10)</option>
                            <option value="11">نوفمبر (11)</option>
                            <option value="12">ديسمبر (12)</option>
                        </select>
                    </div>
                    <div class="combined-field-group">
                        <label for="combined-order-number"><i class="fas fa-file-invoice"></i> رقم الأمر بالصرف</label>
                        <input type="text" id="combined-order-number" placeholder="رقم الأمر بالصرف">
                    </div>
                    <div class="combined-field-group">
                        <label for="combined-transfer-number"><i class="fas fa-exchange-alt"></i> رقم الحوالة</label>
                        <input type="text" id="combined-transfer-number" placeholder="رقم الحوالة">
                    </div>
                    <div class="combined-field-group">
                        <label for="combined-treasury-account"><i class="fas fa-university"></i> حساب الخزينة البريدي</label>
                        <input type="text" id="combined-treasury-account" placeholder="رقم الحساب البريدي" value="">
                    </div>
                </div>

                <!-- Summary cards -->
                <div class="combined-summary-bar">
                    <div class="combined-stat">
                        <i class="fas fa-users"></i>
                        <span id="combined-count">0</span>
                        <small>مستفيد</small>
                    </div>
                    <div class="combined-stat">
                        <i class="fas fa-money-bill-wave"></i>
                        <span id="combined-total">0,00</span>
                        <small>دج إجمالي</small>
                    </div>
                    <div class="combined-stat">
                        <i class="fas fa-layer-group"></i>
                        <span id="combined-types-count">0</span>
                        <small>أنواع تعويضات</small>
                    </div>
                </div>

                <!-- Actions -->
                <div class="combined-actions">
                    <div class="search-container" style="max-width: 300px;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="combined-search-input" placeholder="بحث بالاسم أو رقم الحساب..." oninput="renderCombinedTable()">
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="combinedExportTxt()" class="primary-action-btn" style="font-size: 0.82rem;">
                            <i class="fas fa-file-export"></i> تصدير TXT
                        </button>
                        <button onclick="combinedPrintCDRom()" class="primary-action-btn" style="background: linear-gradient(135deg, var(--accent-blue), #3b82f6); font-size: 0.82rem;">
                            <i class="fas fa-print"></i> طباعة CD-ROM
                        </button>
                        <button onclick="combinedPrintDetailedReport()" class="primary-action-btn" style="background: linear-gradient(135deg, var(--accent-purple), #7c3aed); font-size: 0.82rem;">
                            <i class="fas fa-print"></i> طباعة التقرير
                        </button>
                    </div>
                </div>

                <!-- Table -->
                <div class="combined-table-container">
                    <table id="combined-table">
                        <thead>
                            <tr>
                                <th style="width:45px;">#</th>
                                <th>اللقب والاسم</th>
                                <th>رقم الحساب CCP</th>
                                <th>RIP</th>
                                <th>المبلغ</th>
                                <th>نوع التعويض</th>
                            </tr>
                        </thead>
                        <tbody id="combined-tbody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: 700; color: #000;">المجموع الكلي</td>
                                <td id="combined-footer-total" style="font-weight: 700; color: #000;">0,00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="combined-empty-state" style="text-align: center; padding: 40px 20px; color: var(--text-muted); display: none;">
                        <i class="fas fa-inbox" style="font-size: 2.5rem; color: var(--text-muted); margin-bottom: 12px; display: block;"></i>
                        <p>لا توجد بيانات. قم بحجز تعويضات في الأنواع المختلفة أولاً.</p>
                    </div>
                </div>

                <!-- Detailed Report Preview -->
                <div id="combined-report-preview" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <h3 style="color: var(--gold-light); font-size: 1rem; display: flex; align-items: center; gap: 8px; margin: 0;"><i class="fas fa-file-invoice-dollar"></i> التقرير المفصل للتعويضات</h3>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="combinedPrintDetailedReport()" class="primary-action-btn" style="font-size: 0.78rem; padding: 6px 14px;"><i class="fas fa-print"></i> طباعة</button>
                            <button onclick="document.getElementById('combined-report-preview').style.display='none'" class="cancel-button" style="font-size: 0.78rem; padding: 6px 14px;"><i class="fas fa-times"></i> إغلاق</button>
                        </div>
                    </div>
                    <div class="combined-table-container" style="max-height: 400px; overflow-y: auto;">
                        <table id="combined-detailed-table" style="width: 100%; border-collapse: collapse; font-size: 0.82rem;">
                            <thead>
                                <tr>
                                    <th style="width:40px;">الرقم</th>
                                    <th>اللقب والاسم</th>
                                    <th>RIP</th>
                                    <th>الكهرباء والغاز</th>
                                    <th>منحة التجهيز</th>
                                    <th>مصاريف التنقل</th>
                                    <th>العمليات التكوينية</th>
                                    <th>الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody id="combined-detailed-tbody"></tbody>
                            <tfoot>
                                <tr style="font-weight: 700; color: var(--gold-light);">
                                    <td colspan="3" style="text-align: right; padding-right: 12px;">المجموع</td>
                                    <td id="combined-detail-elec-total">0,00</td>
                                    <td id="combined-detail-equip-total">0,00</td>
                                    <td id="combined-detail-trans-total">0,00</td>
                                    <td id="combined-detail-train-total">0,00</td>
                                    <td id="combined-detail-grand-total">0,00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Fullscreen Exit Button -->
    <button class="fullscreen-exit-btn" id="fullscreen-exit-btn" title="تصغير">
        <i class="fas fa-compress"></i>
    </button>

    <!-- Credit Warning Banner -->
        <div id="credit-warning-banner">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="warning-text"></span>
            <button class="close-warning" onclick="closeCreditWarning()"><i class="fas fa-times"></i></button>
        </div>

        <!-- Scroll to Top Button -->
        <button class="scroll-to-top-btn" id="scroll-to-top-btn" onclick="window.scrollTo({top:0,behavior:'smooth'})">
            <i class="fas fa-chevron-up"></i>
        </button>

    </main>

    <div id="print-report-content" class="report-output" style="display: none;"></div>

    <!-- ======= ALL MODALS (PRESERVED) ======= -->
    <div id="beneficiary-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="beneficiary-modal-title"></h3>
            <form id="beneficiary-form">
                 <input type="hidden" id="beneficiary-id">
                 <div>
                    <label for="beneficiary-name">اللقب و الاسم:</label>
                    <input type="text" id="beneficiary-name" required placeholder="الرجاء حجز الاسم و اللقب كاملا باللغة اللاتينية" pattern="^[a-zA-Z\s\-]+$" inputmode="latin">
                </div>
                <div class="form-row">
                    <div>
                        <label for="account-number">رقم الحساب (CCP):</label>
                        <input type="text" id="account-number" required oninput="updateCalculatedRIP()">
                    </div>
                    <div id="meter-field-group">
                        <label for="meter-number">رقم العداد:</label>
                        <input type="text" id="meter-number">
                    </div>
                    <div id="section-field-group" style="display: none;">
                        <label for="section-name">القسم:</label>
                        <input type="text" id="section-name" placeholder="القسم التربوي أو الإداري">
                    </div>
                    <div id="rank-field-group" style="display: none;">
                        <label for="rank-name">الرتبة:</label>
                        <input type="text" id="rank-name" placeholder="مثال: أستاذ، مقتصد...">
                    </div>
                    <div id="amount-field-group" style="display: none;">
                        <label for="initial-amount">مبلغ التعويض:</label>
                        <input type="number" id="initial-amount" step="0.01" placeholder="0.00">
                    </div>
                    <div>
                        <label for="calculated-rip">رقم RIP الكامل (20 رقم):</label>
                        <input type="text" id="calculated-rip" value="" readonly placeholder="يتم حسابه تلقائياً">
                    </div>
                </div>
                 <div class="modal-buttons">
                    <button type="submit" class="save-button"><i class="fas fa-save"></i> حفظ</button>
                    <button type="button" class="cancel-button" id="cancel-beneficiary-btn"><i class="fas fa-times-circle"></i> إلغاء</button>
                 </div>
            </form>
        </div>
    </div>

    <!-- Quarterly Details Modal -->
    <div id="quarterly-details-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <h3 id="quarterly-modal-title"></h3>
            <form id="quarterly-details-form">
                <input type="hidden" id="quarterly-beneficiary-id">
                <input type="hidden" id="quarterly-quarter-index">
                <div class="form-row">
                    <div>
                        <label for="quarterly-nofees">المبلغ دون رسوم:</label>
                        <input type="number" id="quarterly-nofees" step="0.01" value="0.00">
                    </div>
                    <div>
                        <label for="quarterly-value">القيمة المضافة:</label>
                        <input type="number" id="quarterly-value" step="0.01" value="0.00">
                    </div>
                </div>
                 <div>
                    <label for="quarterly-contrib">مساهمة الدولة:</label>
                    <input type="number" id="quarterly-contrib" step="0.01" value="0.00">
                 </div>
                <div class="modal-buttons">
                    <button type="submit" class="save-button"><i class="fas fa-check"></i> تأكيد</button>
                    <button type="button" class="cancel-button" id="cancel-quarterly-btn"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import TXT Modal -->
    <div id="import-txt-modal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-file-import"></i> استيراد المستفيدين</h3>
            <p>حدد تنسيق الملف:</p>
            <div class="import-format-options">
                <label class="import-option highlight-option">
                    <input type="radio" name="import-format" value="payment-file" checked>
                    <span class="option-text">
                        <strong>📄 ملف الدفع الإلكتروني</strong>
                        <small>تنسيق Algérie Poste</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="semicolon">
                    <span class="option-text">
                        <strong>فاصلة منقوطة (;)</strong>
                        <small>الاسم;الحساب;العداد</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="comma">
                    <span class="option-text">
                        <strong>فاصلة (,)</strong>
                        <small>الاسم,الحساب,العداد</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="tab">
                    <span class="option-text">
                        <strong>جدولة (Tab)</strong>
                        <small>الاسم[tab]الحساب[tab]العداد</small>
                    </span>
                </label>
                <label class="import-option">
                    <input type="radio" name="import-format" value="pipe">
                    <span class="option-text">
                        <strong>خط عمودي (|)</strong>
                        <small>الاسم|الحساب|العداد</small>
                    </span>
                </label>
            </div>
            <div class="import-options-extra" id="header-option-container">
                <label class="checkbox-option">
                    <input type="checkbox" id="import-has-header">
                    <span>تخطي السطر الأول (عناوين)</span>
                </label>
            </div>
            <div class="import-preview" id="import-preview" style="display: none;">
                <div class="import-preview-header">
                    <h4>معاينة:</h4>
                    <div class="selection-buttons">
                        <button type="button" class="btn-select-all" onclick="selectAllImport(true)"><i class="fas fa-check-double"></i> الكل</button>
                        <button type="button" class="btn-select-none" onclick="selectAllImport(false)"><i class="fas fa-square"></i> لا شيء</button>
                    </div>
                </div>
                <div class="preview-table-container">
                    <table id="import-preview-table"></table>
                </div>
                <p class="preview-count">تم تحديد <span id="import-selected-count">0</span> من <span id="import-count">0</span></p>
            </div>
            <div class="modal-buttons">
                <button type="button" class="save-button" id="confirm-import-txt" style="display: none;"><i class="fas fa-check"></i> تأكيد الاستيراد</button>
                <button type="button" class="cancel-button" onclick="cancelImportTxt()"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Mode Selection Modal -->
    <div id="mode-selection-modal" class="modal-overlay visible" style="display: flex;">
        <div class="modal-content">
            <h2><i class="fas fa-cogs"></i> اختر نظام العمل</h2>
            <p>يرجى اختيار نوع التعويضات التي تريد العمل عليها:</p>
            <button class="mode-btn" onclick="selectMode('electricity')">
                <i class="fas fa-bolt"></i>
                <div>
                    <strong>تعويضات استهلاك الكهرباء والغاز</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">حساب 50% من فواتير الاستهلاك الفصلية</small>
                </div>
            </button>
            <button class="mode-btn" onclick="selectMode('equipment')">
                <i class="fas fa-chair"></i>
                <div>
                    <strong>تعويضات منحة التجهيز</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">صرف منحة التجهيز الخاصة بالموظفين</small>
                </div>
            </button>
            <button class="mode-btn" onclick="selectMode('transport')">
                <i class="fas fa-bus"></i>
                <div>
                    <strong>تعويض مصاريف التنقل</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">تسديد مصاريف النقل والتنقل</small>
                </div>
            </button>
            <button class="mode-btn" onclick="selectMode('training')">
                <i class="fas fa-chalkboard-teacher"></i>
                <div>
                    <strong>تعويض مصاريف العمليات التكوينية</strong>
                    <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">تعويضات مرتبطة بالتكوين والتدريب</small>
                </div>
            </button>
            <div style="border-top: 1px solid var(--border); margin: 8px 0; padding-top: 8px;">
                <button class="mode-btn" onclick="selectMode('combined')" style="border-color: var(--gold-dark); background: linear-gradient(135deg, rgba(212,163,115,0.08), var(--bg-elevated));">
                    <i class="fas fa-layer-group" style="color: var(--gold-light);"></i>
                    <div>
                        <strong>تعويضات متعددة ومختلفة</strong>
                        <small style="display:block;opacity:0.8;font-size:0.75em;margin-top:4px;">جمع المستفيدين من جميع أنواع التعويضات في جدول واحد مع تصدير TXT وطباعة CD-ROM</small>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Restore Type Modal -->
    <div id="restore-type-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <h3><i class="fas fa-question-circle"></i> اختر نوع الاستعادة</h3>
            <p style="margin-bottom: 14px; color: var(--text-secondary); font-size: 0.88rem;">كيف تريد استعادة النسخة الاحتياطية؟</p>
            <div class="restore-option" onclick="executeRestore('full')">
                <i class="fas fa-sync-alt" style="color: var(--gold); font-size: 1.2rem;"></i>
                <div>
                    <strong>استعادة كاملة</strong>
                    <small style="display:block; color: var(--text-muted); font-size:0.78em;">استبدال جميع البيانات الحالية</small>
                </div>
            </div>
            <div class="restore-option" onclick="executeRestore('beneficiaries')">
                <i class="fas fa-users" style="color: var(--accent-blue); font-size: 1.2rem;"></i>
                <div>
                    <strong>استعادة المستفيدين فقط</strong>
                    <small style="display:block; color: var(--text-muted); font-size:0.78em;">إضافة المستفيدين مع الحفاظ على الباقي</small>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-button" onclick="cancelRestore()"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Beneficiary Selection Modal -->
    <div id="beneficiary-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-user-check"></i> حدد المستفيدين للاستيراد</h3>
            <div class="import-preview-header" style="margin-bottom: 10px;">
                <div class="selection-buttons">
                    <button type="button" class="btn-select-all" onclick="selectAllBeneficiaryImport(true)"><i class="fas fa-check-double"></i> تحديد الكل</button>
                    <button type="button" class="btn-select-none" onclick="selectAllBeneficiaryImport(false)"><i class="fas fa-square"></i> إلغاء الكل</button>
                </div>
            </div>
            <div class="preview-table-container">
                <table id="beneficiary-selection-table"></table>
            </div>
            <p class="preview-count">تم تحديد <span id="beneficiary-selected-count">0</span> من <span id="beneficiary-total-count">0</span></p>
            <div class="modal-buttons">
                <button type="button" class="save-button" onclick="confirmBeneficiarySelection()">
                    <i class="fas fa-check"></i> تأكيد الاستيراد
                </button>
                <button type="button" class="cancel-button" onclick="cancelBeneficiarySelection()">
                    <i class="fas fa-times-circle"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="ticker-container">
        <div id="ticker-content">
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
            <span>&nbsp;&nbsp;***&nbsp;&nbsp;</span>
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
            <span>&nbsp;&nbsp;***&nbsp;&nbsp;</span>
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
        </div>
    </div>

    <script>
        // --- Data Storage ---
        let currentMode = 'electricity'; // 'electricity' or 'equipment'
        let tempBackupData = null; // مؤقت لحفظ بيانات النسخة الاحتياطية
        
        let institutionInfo = {
            republic: "الجمهورية الجزائرية الديمقراطية الشعبية",
            ministry: "وزارة التربية الوطنية",
            directorate: "مديرية التربية لولاية أدرار",
            institution: "متوسطة حكومي قدور بن علال",
            fiscalYear: "2025",
            financialMonth: "",
            treasuryAccount: "",
            treasuryKey: "",
            orderNumber: "",
            transferNumber: "",
            openCredit: 0,
            equipmentGrantValue: 0,
            modeDetails: {
                electricity: { credit: 0, order: "", transfer: "", month: "" },
                equipment: { credit: 0, order: "", transfer: "", month: "" },
                transport: { credit: 0, order: "", transfer: "", month: "" },
                training: { credit: 0, order: "", transfer: "", month: "" }
            }
        };

        let beneficiaries = [];
        let compensations = []; // Electricity compensations
        let compensationsEquipment = []; // Equipment compensations
        let compensationsTransport = []; // Transport compensations
        let compensationsTraining = []; // Training compensations


        // --- Helper Functions ---
        function loadData() {
            try {
                const savedInstitutionInfo = localStorage.getItem('institutionInfo');
                const savedBeneficiaries = localStorage.getItem('beneficiaries');
                const savedCompensations = localStorage.getItem('compensations');
                const savedCompensationsEquipment = localStorage.getItem('compensationsEquipment');
                const savedCompensationsTransport = localStorage.getItem('compensationsTransport');
                const savedCompensationsTraining = localStorage.getItem('compensationsTraining');

                if (savedInstitutionInfo) {
                    const tempInfo = JSON.parse(savedInstitutionInfo);
                     institutionInfo = {
                         ...institutionInfo,
                         ...tempInfo
                     };
                     institutionInfo.openCredit = parseFloat(institutionInfo.openCredit) || 0;
                     institutionInfo.equipmentGrantValue = parseFloat(institutionInfo.equipmentGrantValue) || 0;
                     
                     if (!institutionInfo.modeDetails) {
                         institutionInfo.modeDetails = {
                            electricity: { credit: institutionInfo.openCredit, order: institutionInfo.orderNumber||"", transfer: institutionInfo.transferNumber||"", month: institutionInfo.financialMonth||"" },
                            equipment: { credit: 0, order: "", transfer: "", month: "" },
                            transport: { credit: 0, order: "", transfer: "", month: "" },
                            training: { credit: 0, order: "", transfer: "", month: "" }
                         };
                     }
                }

                if (savedBeneficiaries) {
                    beneficiaries = JSON.parse(savedBeneficiaries);
                    beneficiaries.forEach(b => {
                        b.id = parseInt(b.id) || 0;
                         if (b.meter === undefined) b.meter = "";
                         if (b.key !== undefined) delete b.key;
                    });
                    beneficiaries = beneficiaries.filter(b => b.id > 0);
                }

                if (savedCompensations) {
                    compensations = JSON.parse(savedCompensations);
                    compensations.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        const defaultQuarter = { nofees: 0, value: 0, contrib: 0, calculated: 0 };
                        comp.q1 = {...defaultQuarter, ...(comp.q1 || {})};
                        comp.q2 = {...defaultQuarter, ...(comp.q2 || {})};
                        comp.q3 = {...defaultQuarter, ...(comp.q3 || {})};
                        comp.q4 = {...defaultQuarter, ...(comp.q4 || {})};

                        comp.discount = roundToTwo(parseFloat(comp.discount) || 0);

                        comp.q1.calculated = calculateQuarterlyComp(comp.q1.nofees, comp.q1.value, comp.q1.contrib);
                        comp.q2.calculated = calculateQuarterlyComp(comp.q2.nofees, comp.q2.value, comp.q2.contrib);
                        comp.q3.calculated = calculateQuarterlyComp(comp.q3.nofees, comp.q3.value, comp.q3.contrib);
                        comp.q4.calculated = calculateQuarterlyComp(comp.q4.nofees, comp.q4.value, comp.q4.contrib);

                        const totalCalc = roundToTwo(comp.q1.calculated + comp.q2.calculated + comp.q3.calculated + comp.q4.calculated);
                        comp.netPayable = roundToTwo(totalCalc - comp.discount);
                    });
                    compensations = compensations.filter(comp => comp.beneficiaryId > 0);
                }
                
                if (savedCompensationsEquipment) {
                    compensationsEquipment = JSON.parse(savedCompensationsEquipment);
                    compensationsEquipment.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        comp.netPayable = roundToTwo(parseFloat(comp.netPayable) || 0);
                    });
                    compensationsEquipment = compensationsEquipment.filter(comp => comp.beneficiaryId > 0);
                }

                if (savedCompensationsTransport) {
                    compensationsTransport = JSON.parse(savedCompensationsTransport);
                    compensationsTransport.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        comp.netPayable = roundToTwo(parseFloat(comp.netPayable) || 0);
                    });
                    compensationsTransport = compensationsTransport.filter(comp => comp.beneficiaryId > 0);
                }

                if (savedCompensationsTraining) {
                    compensationsTraining = JSON.parse(savedCompensationsTraining);
                    compensationsTraining.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        comp.netPayable = roundToTwo(parseFloat(comp.netPayable) || 0);
                    });
                    compensationsTraining = compensationsTraining.filter(comp => comp.beneficiaryId > 0);
                }

                // --- MIGRATION: Assign types to legacy beneficiaries ---
                beneficiaries.forEach(b => {
                    if (!b.type) {
                        // Check if this beneficiary has explicit equipment data
                        const hasEquip = compensationsEquipment.some(c => c.beneficiaryId === b.id);
                        // Check if this beneficiary has explicit electricity data (non-zero)
                        const hasElec = compensations.some(c => c.beneficiaryId === b.id && c.netPayable > 0);
                        
                        if (hasEquip && !hasElec) {
                            b.type = 'equipment';
                        } else {
                            b.type = 'electricity'; // Default to electricity
                        }
                    }
                });

                 // Filter out compensations for deleted beneficiaries
                 compensations = compensations.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));
                 compensationsEquipment = compensationsEquipment.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));
                 compensationsTransport = compensationsTransport.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));
                 compensationsTraining = compensationsTraining.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));

            } catch (e) {
                console.error("An error occurred during data loading:", e);
                alert("حدث خطأ أثناء تحميل البيانات المحفوظة. قد يتم استخدام البيانات الافتراضية.");
            }
        }

        function saveData() {
            try {
                localStorage.setItem('institutionInfo', JSON.stringify(institutionInfo));
                localStorage.setItem('beneficiaries', JSON.stringify(beneficiaries));
                localStorage.setItem('compensations', JSON.stringify(compensations));
                localStorage.setItem('compensationsEquipment', JSON.stringify(compensationsEquipment));
                localStorage.setItem('compensationsTransport', JSON.stringify(compensationsTransport));
                localStorage.setItem('compensationsTraining', JSON.stringify(compensationsTraining));
            } catch (e) {
                console.error("An error occurred during data saving:", e);
                alert("حدث خطأ أثناء حفظ البيانات.");
            }
        }

        function selectMode(mode) {
            console.log('selectMode called with:', mode);
            currentMode = mode;
            const modal = document.getElementById('mode-selection-modal');
            
            // إخفاء النافذة فورًا
            modal.style.display = 'none';
            modal.classList.remove('visible');

            // Update UI based on mode
            const equipmentField = document.getElementById('equipment-grant-field');
            
            if (mode === 'electricity') {
                if (equipmentField) equipmentField.style.display = 'none';
            } else if (mode === 'equipment') {
                if (equipmentField) equipmentField.style.display = 'block';
            } else if (mode === 'transport') {
                if (equipmentField) equipmentField.style.display = 'none';
            } else if (mode === 'training') {
                if (equipmentField) equipmentField.style.display = 'none';
            } else if (mode === 'combined') {
                if (equipmentField) equipmentField.style.display = 'none';
            }
            
            // Update mode indicator bar
            updateModeIndicator();
            
            // Load quarter states
            loadQuarterStates();
            initQuarterToggleUI();
            
            console.log('Loading mode specific info...');
            // Load mode specific info
            if (institutionInfo.modeDetails && institutionInfo.modeDetails[mode]) {
                const details = institutionInfo.modeDetails[mode];
                document.getElementById('open-credit').value = details.credit;
                document.getElementById('order-number').value = details.order;
                document.getElementById('transfer-number').value = details.transfer;
                document.getElementById('financial-month').value = details.month;
            }

            console.log('Calling showSection...');
            // Combined mode goes directly to its section; others go to dashboard
            if (mode === 'combined') {
                showSection('combined-compensations-section');
            } else {
                showDashboard();
            }
            console.log('selectMode completed');
        }

        function getNextBeneficiaryId() {
            if (beneficiaries.length === 0) return 1;
            return Math.max(...beneficiaries.map(b => b.id)) + 1;
        }

        function formatCurrency(amount) {
            let parts = (parseFloat(amount) || 0).toFixed(2).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return parts.join(',');
        }

        function parseCurrency(str) {
            if (!str) return 0;
            const cleanStr = str.toString().replace(/\./g, '');
            const normalizedStr = cleanStr.replace(',', '.');
            return parseFloat(normalizedStr) || 0;
        }
        
        function numberToArabicText(amount) {
            const roundedAmount = Math.round(amount * 100) / 100;
            const [integerPart, decimalPart] = roundedAmount.toFixed(2).split('.');
            const onesArabic = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة', 'عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
            const tensArabic = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            
            function processThreeDigits(num) {
                if (num === 0) return '';
                const hundred = Math.floor(num / 100);
                const remainder = num % 100;
                let result = '';
                if (hundred > 0) result += hundreds[hundred] + (remainder > 0 ? ' و ' : '');
                if (remainder > 0 && remainder < 20) result += onesArabic[remainder];
                else if (remainder >= 20) {
                    const tens = Math.floor(remainder / 10), ones = remainder % 10;
                    result += (ones > 0 ? onesArabic[ones] + ' و ' : '') + tensArabic[tens];
                }
                return result;
            }
            
            const intValue = parseInt(integerPart);
            if (intValue === 0 && parseInt(decimalPart) === 0) return 'صفر دينار';
            
            const million = Math.floor(intValue / 1e6);
            const thousand = Math.floor((intValue % 1e6) / 1000);
            const remain = intValue % 1000;
            let result = '';

            if (million > 0) result += (million === 1 ? 'مليون' : million === 2 ? 'مليونان' : processThreeDigits(million) + (million > 10 ? ' مليون' : ' ملايين')) + (thousand > 0 || remain > 0 ? ' و ' : '');
            if (thousand > 0) result += (thousand === 1 ? 'ألف' : thousand === 2 ? 'ألفان' : processThreeDigits(thousand) + (thousand > 10 ? ' ألف' : ' آلاف')) + (remain > 0 ? ' و ' : '');
            if (remain > 0) result += processThreeDigits(remain);
            
            if (intValue > 0) result += (intValue === 1 ? ' دينار' : intValue === 2 ? ' ديناران' : intValue > 10 ? ' دينار' : ' دنانير');

            if (parseInt(decimalPart) > 0) {
                const decimalValue = parseInt(decimalPart);
                result += (intValue > 0 ? ' و ' : '') + processThreeDigits(decimalValue) + (decimalValue === 1 ? ' سنتيم' : decimalValue === 2 ? ' سنتيمان' : decimalValue > 10 ? ' سنتيم' : ' سنتيمات');
            }
            return result.replace(/^ و /, '').replace(/ و $/, '');
        }

         function calculateRIP(ccpNumberString) {
             if (!ccpNumberString || !/^\d+$/.test(ccpNumberString.trim())) return 'CCP غير صالح';
             const ccpPadded = ccpNumberString.trim().padStart(10, '0');
             let ripKey = (parseInt(ccpNumberString, 10) * 100) % 97;
             ripKey = 97 - (ripKey + 85) % 97;
             const rip = '00799999' + ccpPadded + ripKey.toString().padStart(2, '0');
             return rip.length === 20 ? rip : 'خطأ في الطول';
         }

        function updateCalculatedRIP() {
            const ccpInput = document.getElementById('account-number');
            const ripDisplay = document.getElementById('calculated-rip');
            ripDisplay.value = ccpInput.value.trim() ? calculateRIP(ccpInput.value) : '';
        }

        // === Quarter Toggle State ===
        let quarterEnabled = { q1: true, q2: true, q3: true, q4: true };
        
        // Load saved quarter states
        function loadQuarterStates() {
            const saved = localStorage.getItem('quarterEnabled');
            if (saved) {
                try { quarterEnabled = JSON.parse(saved); } catch(e) {}
            }
        }
        
        function saveQuarterStates() {
            localStorage.setItem('quarterEnabled', JSON.stringify(quarterEnabled));
        }
        
        function initQuarterToggleUI() {
            document.querySelectorAll('.quarter-toggle').forEach(toggle => {
                const q = 'q' + toggle.dataset.quarter;
                const checkbox = toggle.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = quarterEnabled[q];
                }
                toggle.classList.toggle('active', quarterEnabled[q]);
            });
        }

        function showSection(sectionId) {
            // Update navigation - works with both sidebar-nav and top navbar
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.section === sectionId) {
                    button.classList.add('active');
                }
            });
            
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.section === sectionId) {
                    button.classList.add('active');
                }
            });

            // Hide dashboard when showing other sections
            const dashboard = document.getElementById('dashboard-section');
            if (dashboard && sectionId !== 'dashboard-section') {
                dashboard.style.display = 'none';
                dashboard.classList.remove('active');
            }

            document.querySelectorAll('.app-section').forEach(section => {
                if (section.id !== 'dashboard-section') { 
                    section.style.display = 'none';
                    section.classList.remove('active');
                }
            });

            const sectionToShow = document.getElementById(sectionId);

            if (sectionToShow) {
                 const displayStyle = sectionId === 'compensation-management-section' ? 'flex' : 'block';
                 if (sectionId.includes('-modal')) {
                     sectionToShow.style.display = 'flex';
                     setTimeout(() => sectionToShow.classList.add('visible'), 10);
                 } else {
                     sectionToShow.style.display = displayStyle;
                     sectionToShow.classList.add('active');
                 }
            } else { return; }

            // Show/hide quarter toggles based on mode and section
            const quarterToggles = document.getElementById('quarter-toggles');
            if (quarterToggles) {
                quarterToggles.style.display = (sectionId === 'compensation-management-section' && currentMode === 'electricity') ? 'flex' : 'none';
            }

            if (sectionId === 'institution-info-section') {
                for (const key in institutionInfo) {
                    if (key === 'openCredit' || key === 'orderNumber' || key === 'transferNumber' || key === 'financialMonth' || key === 'modeDetails') continue;
                    const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                    if (element) element.value = institutionInfo[key];
                }
                if (institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode]) {
                    const details = institutionInfo.modeDetails[currentMode];
                    document.getElementById('open-credit').value = details.credit || 0;
                    document.getElementById('order-number').value = details.order || '';
                    document.getElementById('transfer-number').value = details.transfer || '';
                    document.getElementById('financial-month').value = details.month || '';
                }
            } else if (sectionId === 'compensation-management-section') {
                renderCompensationGrid();
                updateCreditDisplay();
            } else if (sectionId === 'reporting-section') {
                generateReportPreview();
            } else if (sectionId === 'pro-txt-editor-section') {
                renderProEditorSection();
            } else if (sectionId === 'combined-compensations-section') {
                renderCombinedTable();
            } else if (sectionId === 'dashboard-section') {
                // Instructions section - no data update needed
            }
        }
        
        // === TOGGLE GUIDE CARD ===
        function toggleGuide(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const wasOpen = card.classList.contains('open');
            // Close all guide cards
            document.querySelectorAll('.guide-card').forEach(c => c.classList.remove('open'));
            // Toggle clicked card
            if (!wasOpen) card.classList.add('open');
        }
        
        // === SHOW INSTRUCTIONS ===
        function showDashboard() {
            document.querySelectorAll('.app-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            const dashboard = document.getElementById('dashboard-section');
            if (dashboard) {
                dashboard.style.display = 'block';
                dashboard.classList.add('active');
            }
            // Remove active from all nav items
            document.querySelectorAll('.nav-tab, .nav-item').forEach(btn => btn.classList.remove('active'));
            const homeBtn = document.getElementById('switch-mode-btn');
            if (homeBtn) homeBtn.classList.add('active');
        }
        
        // === BATCH OPERATIONS ===
        let batchSelected = new Set();
        
        function toggleBatchSelect(beneficiaryId, checked) {
            if (checked) {
                batchSelected.add(beneficiaryId);
            } else {
                batchSelected.delete(beneficiaryId);
            }
            // Update row highlight
            const row = document.querySelector(`#compensation-grid-table tbody tr[data-beneficiary-id='${beneficiaryId}']`);
            if (row) row.classList.toggle('batch-selected', batchSelected.has(beneficiaryId));
            updateBatchToolbar();
        }
        
        function toggleBatchSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.batch-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                const row = cb.closest('tr');
                if (row && row.dataset.beneficiaryId) {
                    const id = parseInt(row.dataset.beneficiaryId);
                    if (checked) {
                        batchSelected.add(id);
                        row.classList.add('batch-selected');
                    } else {
                        batchSelected.delete(id);
                        row.classList.remove('batch-selected');
                    }
                }
            });
            updateBatchToolbar();
        }
        
        function updateBatchToolbar() {
            const toolbar = document.getElementById('batch-toolbar');
            const count = document.getElementById('batch-count');
            if (toolbar) {
                toolbar.classList.toggle('visible', batchSelected.size > 0);
            }
            if (count) {
                count.textContent = batchSelected.size + ' محدد';
            }
        }
        
        function batchDeleteBeneficiaries() {
            if (batchSelected.size === 0) return;
            if (!confirm(`هل تريد حذف ${batchSelected.size} مستفيد(ين) المحددين وكل تعويضاتهم؟`)) return;
            
            batchSelected.forEach(id => {
                const idx = beneficiaries.findIndex(b => b.id === id);
                if (idx >= 0) beneficiaries.splice(idx, 1);
                compensations = compensations.filter(c => c.beneficiaryId !== id);
                compensationsEquipment = compensationsEquipment.filter(c => c.beneficiaryId !== id);
                compensationsTransport = compensationsTransport.filter(c => c.beneficiaryId !== id);
                compensationsTraining = compensationsTraining.filter(c => c.beneficiaryId !== id);
            });
            
            // Re-number
            beneficiaries.sort((a, b) => a.id - b.id);
            beneficiaries.forEach((b, index) => {
                const oldId = b.id;
                const newId = index + 1;
                if (oldId !== newId) {
                    [compensations, compensationsEquipment, compensationsTransport, compensationsTraining].forEach(arr => {
                        arr.forEach(c => { if (c.beneficiaryId === oldId) c.beneficiaryId = newId; });
                    });
                    b.id = newId;
                }
            });
            
            batchSelected.clear();
            updateBatchToolbar();
            saveData();
            renderCompensationGrid();
            updateCreditDisplay();
            SoundSystem.delete();
            showToast('تم حذف المستفيدين المحددين بنجاح', 'success');
        }
        
        function clearBatchSelection() {
            batchSelected.clear();
            updateBatchToolbar();
            document.querySelectorAll('.batch-checkbox').forEach(cb => cb.checked = false);
        }
        
        // === UPDATE MODE INDICATOR ===
        function updateModeIndicator() {
            const modes = {
                electricity: { icon: 'fas fa-bolt', text: 'تعويضات استهلاك الكهرباء والغاز', short: 'الكهرباء والغاز' },
                equipment: { icon: 'fas fa-chair', text: 'تعويضات منحة التجهيز', short: 'منحة التجهيز' },
                transport: { icon: 'fas fa-bus', text: 'تعويض مصاريف التنقل', short: 'التنقل' },
                training: { icon: 'fas fa-chalkboard-teacher', text: 'تعويض مصاريف العمليات التكوينية', short: 'التكوين' },
                combined: { icon: 'fas fa-layer-group', text: 'تعويضات متعددة ومختلفة', short: 'متعددة' }
            };
            
            const m = modes[currentMode] || modes.electricity;

            // Update old mode indicator (if still exists)
            const icon = document.getElementById('mode-icon');
            const label = document.getElementById('mode-label');
            if (icon) icon.className = m.icon;
            if (label) label.textContent = m.text;

            // Update navbar mode button
            const navLabel = document.getElementById('nav-mode-label');
            if (navLabel) navLabel.textContent = m.short;

            // Update tab visibility based on mode
            updateNavTabsVisibility();
        }

        function updateNavTabsVisibility() {
            const isCombined = (currentMode === 'combined');
            const navTabs = document.querySelectorAll('.sidebar-nav .nav-item[data-section]');
            navTabs.forEach(tab => {
                const section = tab.dataset.section;
                if (section === 'combined-compensations-section') {
                    // Combined tab: visible ONLY in combined mode
                    tab.style.display = isCombined ? '' : 'none';
                } else {
                    // All other tabs (institution, compensations, reporting, editor, backup): hidden in combined mode
                    tab.style.display = isCombined ? 'none' : '';
                }
            });
        }

        function updateCreditDisplay() {
            let totalSpent = 0;  // المبلغ المصروف من الاعتماد (مجموع التعويضات الكلي)
            let totalDiscounts = 0;  // المبالغ المخصومة (تُحوَّل لجهة أخرى)
            
            if (currentMode === 'electricity') {
                // حساب مجموع التعويضات مع مراعاة الثلاثيات المفعلة فقط
                totalSpent = compensations.reduce((sum, comp) => {
                    let compTotal = 0;
                    for (let i = 1; i <= 4; i++) {
                        if (quarterEnabled['q' + i]) {
                            compTotal += (comp['q' + i] && comp['q' + i].calculated) ? comp['q' + i].calculated : 0;
                        }
                    }
                    const discount = parseFloat(comp.discount) || 0;
                    // netPayable for this comp based on enabled quarters
                    // totalSpent = sum of (quarter totals) for all comps (before discount is subtracted, 
                    // but including discount as part of "spent from credit")
                    // Original logic: totalSpent = netPayable + discount = totalComp
                    return sum + compTotal;
                }, 0);
                // حساب مجموع الخصومات (للعرض فقط)
                totalDiscounts = compensations.reduce((sum, comp) => sum + (parseFloat(comp.discount) || 0), 0);
            } else if (currentMode === 'equipment') {
                totalSpent = compensationsEquipment.reduce((sum, comp) => sum + (parseFloat(comp.netPayable) || 0), 0);
                totalDiscounts = 0; // لا يوجد خصومات في منحة التجهيز
            } else if (currentMode === 'transport') {
                totalSpent = compensationsTransport.reduce((sum, comp) => sum + (parseFloat(comp.netPayable) || 0), 0);
                totalDiscounts = 0; // لا يوجد خصومات في تعويض النقل
            } else if (currentMode === 'training') {
                totalSpent = compensationsTraining.reduce((sum, comp) => sum + (parseFloat(comp.netPayable) || 0), 0);
                totalDiscounts = 0; // لا يوجد خصومات في تعويض التكوين
            }
            
            // تقريب القيم إلى رقمين بعد الفاصلة
            totalSpent = Math.round(totalSpent * 100) / 100;
            totalDiscounts = Math.round(totalDiscounts * 100) / 100;
            
            const openCredit = (institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode]) ? parseFloat(institutionInfo.modeDetails[currentMode].credit) || 0 : 0;
            
            // الاعتماد المتبقي = الاعتماد المفتوح - مجموع التعويضات الكلي
            // ملاحظة: المبلغ المصروف هو المجموع الكلي (قبل الخصم) لأن الخصم يُحوَّل لجهة أخرى ولا يعود للاعتماد
            const remainingCredit = Math.round((openCredit - totalSpent) * 100) / 100;

            document.getElementById('display-open-credit').textContent = `${formatCurrency(openCredit)} دج`;
            document.getElementById('display-amount-spent').textContent = `${formatCurrency(totalSpent)} دج`;
            document.getElementById('display-total-discounts').textContent = `${formatCurrency(totalDiscounts)} دج`;
            
            const remainingEl = document.getElementById('display-remaining-credit');
            const remainingCard = remainingEl.closest('.credit-card');
            remainingEl.textContent = `${formatCurrency(remainingCredit)} دج`;
            
            // عرض تنبيه عند الاعتماد السالب
            const warningBanner = document.getElementById('credit-warning-banner');
            const warningText = document.getElementById('warning-text');
            
            if (remainingCredit < 0) {
                remainingEl.classList.add('negative');
                if (remainingCard) remainingCard.classList.add('negative-credit');
                
                // تحديث نص التنبيه وإظهار الشريط
                const exceededAmount = Math.abs(remainingCredit);
                warningText.textContent = `تحذير: تم تجاوز الاعتماد المفتوح بمبلغ ${formatCurrency(exceededAmount)} دج! (الاعتماد المتبقي: ${formatCurrency(remainingCredit)} دج)`;
                if (warningBanner) warningBanner.classList.add('visible');
                
                // إظهار إشعار Toast (مرة واحدة فقط عند التغيير)
                if (!window.lastNegativeCreditWarning || window.lastNegativeCreditWarning !== currentMode + remainingCredit) {
                    window.lastNegativeCreditWarning = currentMode + remainingCredit;
                    SoundSystem.creditAlert();
                    showToast(`تحذير: الاعتماد المتبقي سالب (${formatCurrency(remainingCredit)} دج)! تم تجاوز الاعتماد المفتوح بمبلغ ${formatCurrency(exceededAmount)} دج`, 'error');
                }
            } else {
                remainingEl.classList.remove('negative');
                if (remainingCard) remainingCard.classList.remove('negative-credit');
                if (warningBanner) warningBanner.classList.remove('visible');
                window.lastNegativeCreditWarning = null;
            }
        }
        
        // دالة إغلاق شريط التنبيه
        function closeCreditWarning() {
            const warningBanner = document.getElementById('credit-warning-banner');
            if (warningBanner) warningBanner.classList.remove('visible');
        }

        // --- Institution Info Management ---
        function saveInstitutionInfo(event) {
            event.preventDefault();
            
            // Validate fiscal year
            const fiscalYear = document.getElementById('fiscal-year').value.trim();
            if (!/^\d{4}$/.test(fiscalYear)) {
                showToast('السنة المالية يجب أن تكون 4 أرقام (مثال: 2025)', 'error');
                return;
            }
            
            const financialMonth = document.getElementById('financial-month').value.trim();
            if (financialMonth && !/^\d{1,2}$/.test(financialMonth)) {
                showToast('الشهر المالي يجب أن يكون رقماً بين 1 و 12', 'error');
                return;
            }

            for (const key in institutionInfo) {
                 if (key === 'openCredit' || key === 'equipmentGrantValue' || key === 'modeDetails' || key === 'orderNumber' || key === 'transferNumber' || key === 'financialMonth') continue;
                const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                if (element) institutionInfo[key] = element.value.trim();
            }
            
            const openCredit = parseFloat(document.getElementById('open-credit').value) || 0;
            if (openCredit < 0) {
                showToast('الاعتماد المفتوح لا يمكن أن يكون سالباً', 'error');
                return;
            }
            
            institutionInfo.equipmentGrantValue = parseFloat(document.getElementById('equipment-grant-value').value) || 0;
            
            // Save mode specific info
            if (!institutionInfo.modeDetails) institutionInfo.modeDetails = {};
            institutionInfo.modeDetails[currentMode] = {
                credit: openCredit,
                order: document.getElementById('order-number').value,
                transfer: document.getElementById('transfer-number').value,
                month: financialMonth
            };
            
            // Sync legacy fields
            institutionInfo.openCredit = institutionInfo.modeDetails[currentMode].credit;
            institutionInfo.orderNumber = institutionInfo.modeDetails[currentMode].order;
            institutionInfo.transferNumber = institutionInfo.modeDetails[currentMode].transfer;
            institutionInfo.financialMonth = institutionInfo.modeDetails[currentMode].month;
            
            saveData();
            showToast('تم حفظ معلومات المؤسسة بنجاح', 'success');
            updateCreditDisplay();
            if (document.getElementById('reporting-section').style.display === 'block') {
                 generateReportPreview();
            }
        }


        // --- Beneficiary Management ---
        function openBeneficiaryModal(id = null) {
            const modal = document.getElementById('beneficiary-modal');
            const form = document.getElementById('beneficiary-form');
            const title = document.getElementById('beneficiary-modal-title');
            
            form.reset(); 
            
            // Toggle fields based on mode
            const meterGroup = document.getElementById('meter-field-group');
            const sectionGroup = document.getElementById('section-field-group');
            const rankGroup = document.getElementById('rank-field-group');
            const amountGroup = document.getElementById('amount-field-group');
            
            meterGroup.style.display = 'none';
            sectionGroup.style.display = 'none';
            rankGroup.style.display = 'none';
            amountGroup.style.display = 'none';

            if (currentMode === 'electricity') {
                meterGroup.style.display = 'block';
            } else if (currentMode === 'equipment') {
                sectionGroup.style.display = 'block';
            } else if (currentMode === 'transport' || currentMode === 'training') {
                rankGroup.style.display = 'block';
                amountGroup.style.display = 'block';
            }

            if (id) { 
                const beneficiary = beneficiaries.find(b => b.id === id);
                if (!beneficiary) return;
                title.innerHTML = '<i class="fas fa-user-edit"></i> تعديل بيانات المستفيد';
                document.getElementById('beneficiary-id').value = beneficiary.id;
                document.getElementById('beneficiary-name').value = beneficiary.name;
                document.getElementById('account-number').value = beneficiary.account;
                document.getElementById('meter-number').value = beneficiary.meter || '';
                document.getElementById('section-name').value = beneficiary.section || '';
                document.getElementById('rank-name').value = beneficiary.rank || '';
                
                if (currentMode === 'transport' || currentMode === 'training') {
                    const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                    const comp = targetArray.find(c => c.beneficiaryId === id);
                    document.getElementById('initial-amount').value = comp ? comp.netPayable : '';
                }
            } else { 
                title.innerHTML = '<i class="fas fa-user-plus"></i> إضافة مستفيد جديد';
                document.getElementById('beneficiary-id').value = '';
            }
            
            updateCalculatedRIP(); 
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function cancelBeneficiaryEdit() {
            const modal = document.getElementById('beneficiary-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function saveBeneficiary(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('beneficiary-id').value) || null;
            const name = document.getElementById('beneficiary-name').value.trim();
            const account = document.getElementById('account-number').value.trim();
            const meter = document.getElementById('meter-number').value.trim();
            const section = document.getElementById('section-name').value.trim();
            const rank = document.getElementById('rank-name').value.trim();
            let amount = parseFloat(document.getElementById('initial-amount').value) || 0;
            
            // Validation
            if (!name || !account) {
                showToast('الرجاء ملء الاسم والحساب', 'error');
                return;
            }
            
            if (!/^[a-zA-Z\s\-]+$/.test(name)) {
                showToast('الرجاء إدخال الاسم بالأحرف اللاتينية فقط', 'error');
                return;
            }
            
            // التحقق من تكرار رقم الحساب فقط ضمن نفس نوع التعويض
            if (beneficiaries.some(b => b.account === account && b.id !== id && (b.type === currentMode || (!b.type && currentMode === 'electricity')))) {
                showToast('رقم الحساب مسجل بالفعل لمستفيد آخر في نفس نوع التعويض', 'error');
                return;
            }
            
            const rip = calculateRIP(account);
            if (rip.includes('خطأ')) {
                showToast('رقم الحساب غير صالح. تأكد من صحة الرقم', 'error');
                return;
            }

            // Validate amount for transport/training modes
            if ((currentMode === 'transport' || currentMode === 'training') && amount < 0) {
                showToast('المبلغ لا يمكن أن يكون سالباً', 'error');
                return;
            }

            if (id) { 
                const beneficiary = beneficiaries.find(b => b.id === id);
                if (beneficiary) {
                    beneficiary.name = name;
                    beneficiary.account = account;
                    beneficiary.meter = meter;
                    beneficiary.section = section;
                    beneficiary.rank = rank;
                }
                
                if (currentMode === 'transport' || currentMode === 'training') {
                     let targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                     let comp = targetArray.find(c => c.beneficiaryId === id);
                     if (comp) comp.netPayable = amount;
                     else targetArray.push({ beneficiaryId: id, netPayable: amount });
                }
                
                showToast('تم حفظ التعديلات بنجاح', 'success');
            } else { 
                const newId = getNextBeneficiaryId();
                beneficiaries.push({ id: newId, name, account, meter, section, rank, type: currentMode });
                
                if (currentMode === 'transport' || currentMode === 'training') {
                     let targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                     targetArray.push({ beneficiaryId: newId, netPayable: amount });
                }
                
                SoundSystem.add();
                showToast('تم إضافة المستفيد بنجاح', 'success');
            }

            saveData();
            renderCompensationGrid();
            updateCreditDisplay();
            cancelBeneficiaryEdit();
        }

        function deleteBeneficiary(id) {
            const beneficiary = beneficiaries.find(b => b.id === id);
            if (confirm(`هل أنت متأكد من حذف المستفيد "${beneficiary.name}" وكل تعويضاته؟`)) {
                // حذف المستفيد
                const deletedIndex = beneficiaries.findIndex(b => b.id === id);
                beneficiaries.splice(deletedIndex, 1);
                
                // حذف التعويضات المرتبطة
                compensations = compensations.filter(c => c.beneficiaryId !== id);
                compensationsEquipment = compensationsEquipment.filter(c => c.beneficiaryId !== id);
                compensationsTransport = compensationsTransport.filter(c => c.beneficiaryId !== id);
                compensationsTraining = compensationsTraining.filter(c => c.beneficiaryId !== id);
                
                // إعادة ترقيم المستفيدين بشكل صحيح
                beneficiaries.sort((a, b) => a.id - b.id);
                beneficiaries.forEach((b, index) => {
                    const oldId = b.id;
                    const newId = index + 1;
                    
                    if (oldId !== newId) {
                        // تحديث معرفات جميع التعويضات
                        compensations.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        compensationsEquipment.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        compensationsTransport.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        compensationsTraining.forEach(c => {
                            if (c.beneficiaryId === oldId) c.beneficiaryId = newId;
                        });
                        
                        b.id = newId;
                    }
                });

                saveData();
                renderCompensationGrid();
                updateCreditDisplay();
                SoundSystem.delete();
                alert('تم حذف المستفيد بنجاح وتحديث الترقيم.');
            }
        }
        
        // --- Compensation Grid ---
        // دالة مساعدة للتقريب إلى رقمين بعد الفاصلة
        function roundToTwo(num) {
            return Math.round((parseFloat(num) || 0) * 100) / 100;
        }
        
        function calculateQuarterlyComp(nofees, value, contrib) {
            const nofeesVal = roundToTwo(nofees);
            const valueVal = roundToTwo(value);
            const contribVal = roundToTwo(contrib);
            const comp = roundToTwo(((nofeesVal + valueVal) - contribVal) * 0.5);
            return comp > 0 ? comp : 0;
        }

        function renderCompensationGrid(searchTerm = '') {
            const tableHead = document.querySelector('#compensation-grid-table thead tr');
            const tableBody = document.querySelector('#compensation-grid-table tbody');
            tableBody.innerHTML = '';

            // Batch checkbox header
            const batchCheckboxHeader = '<th class="batch-col"><input type="checkbox" id="batch-select-all" onchange="toggleBatchSelectAll(this.checked)" title="تحديد الكل"></th>';

            // Update Headers based on mode - with quarter enable/disable awareness
            if (currentMode === 'electricity') {
                tableHead.innerHTML = `
                    ${batchCheckboxHeader}
                    <th>#</th>
                    <th>اللقب و الاسم</th>
                    <th class="${!quarterEnabled.q1 ? 'quarter-disabled' : ''}">تعويض ث 1 ${!quarterEnabled.q1 ? '<i class="fas fa-ban" style="color:var(--danger);margin-right:4px;font-size:0.7em"></i>' : ''}</th>
                    <th class="${!quarterEnabled.q2 ? 'quarter-disabled' : ''}">تعويض ث 2 ${!quarterEnabled.q2 ? '<i class="fas fa-ban" style="color:var(--danger);margin-right:4px;font-size:0.7em"></i>' : ''}</th>
                    <th class="${!quarterEnabled.q3 ? 'quarter-disabled' : ''}">تعويض ث 3 ${!quarterEnabled.q3 ? '<i class="fas fa-ban" style="color:var(--danger);margin-right:4px;font-size:0.7em"></i>' : ''}</th>
                    <th class="${!quarterEnabled.q4 ? 'quarter-disabled' : ''}">تعويض ث 4 ${!quarterEnabled.q4 ? '<i class="fas fa-ban" style="color:var(--danger);margin-right:4px;font-size:0.7em"></i>' : ''}</th>
                    <th>المجموع</th>
                    <th>الخصم</th>
                    <th>الصافي للدفع</th>
                    <th class="status-column">الحالة</th>
                `;
            } else if (currentMode === 'equipment') {
                tableHead.innerHTML = `
                    ${batchCheckboxHeader}
                    <th>#</th>
                    <th>اللقب و الاسم</th>
                    <th>القسم</th>
                    <th>الصافي للدفع</th>
                    <th class="status-column">الحالة</th>
                `;
            } else if (currentMode === 'transport' || currentMode === 'training') {
                tableHead.innerHTML = `
                    ${batchCheckboxHeader}
                    <th>#</th>
                    <th>اللقب و الاسم</th>
                    <th>الرتبة</th>
                    <th>مبلغ التعويض</th>
                    <th class="status-column">الحالة</th>
                `;
            }

            const filtered = beneficiaries.filter(b =>
                (b.type === currentMode || (!b.type && currentMode === 'electricity')) &&
                (searchTerm === '' ||
                b.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                b.account.includes(searchTerm))
            );

            filtered.sort((a,b) => a.id - b.id).forEach((b, index) => {
                const row = document.createElement('tr');
                row.dataset.beneficiaryId = b.id;
                const rowNumber = index + 1;
                const isSelected = batchSelected.has(b.id);
                if (isSelected) row.classList.add('batch-selected');
                
                // Batch checkbox cell
                const batchCell = `<td class="batch-col"><input type="checkbox" class="batch-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleBatchSelect(${b.id}, this.checked)"></td>`;

                if (currentMode === 'electricity') {
                    const compData = compensations.find(c => c.beneficiaryId === b.id) || {
                        q1: { calculated: 0 }, q2: { calculated: 0 }, q3: { calculated: 0 }, q4: { calculated: 0 },
                        discount: 0, netPayable: 0
                    };
                    // Calculate total only from enabled quarters
                    let totalComp = 0;
                    for (let i = 1; i <= 4; i++) {
                        if (quarterEnabled['q' + i]) {
                            totalComp += compData['q' + i].calculated || 0;
                        }
                    }
                    const netPayable = totalComp - (compData.discount || 0);
                    const hasData = compensations.some(c => c.beneficiaryId === b.id);

                    row.innerHTML = `
                        ${batchCell}
                        <td>${rowNumber}</td>
                        <td class="beneficiary-name-cell">
                            <span>${b.name}</span>
                            <div class="beneficiary-actions">
                                 <button class="edit-btn-inline" title="تعديل"><i class="fas fa-edit"></i></button>
                                 <button class="delete-btn-inline" title="حذف"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                        <td class="editable-cell ${!quarterEnabled.q1 ? 'quarter-disabled' : ''}" data-quarter="1" data-nofees="${compData.q1.nofees || 0}" data-value="${compData.q1.value || 0}" data-contrib="${compData.q1.contrib || 0}">${formatCurrency(compData.q1.calculated)}</td>
                        <td class="editable-cell ${!quarterEnabled.q2 ? 'quarter-disabled' : ''}" data-quarter="2" data-nofees="${compData.q2.nofees || 0}" data-value="${compData.q2.value || 0}" data-contrib="${compData.q2.contrib || 0}">${formatCurrency(compData.q2.calculated)}</td>
                        <td class="editable-cell ${!quarterEnabled.q3 ? 'quarter-disabled' : ''}" data-quarter="3" data-nofees="${compData.q3.nofees || 0}" data-value="${compData.q3.value || 0}" data-contrib="${compData.q3.contrib || 0}">${formatCurrency(compData.q3.calculated)}</td>
                        <td class="editable-cell ${!quarterEnabled.q4 ? 'quarter-disabled' : ''}" data-quarter="4" data-nofees="${compData.q4.nofees || 0}" data-value="${compData.q4.value || 0}" data-contrib="${compData.q4.contrib || 0}">${formatCurrency(compData.q4.calculated)}</td>
                        <td class="calculated-cell total-comp-cell">${formatCurrency(totalComp)}</td>
                        <td><input type="number" class="grid-input discount-input" value="${(compData.discount || 0).toFixed(2)}" step="0.01"></td>
                        <td class="calculated-cell net-payable-cell">${formatCurrency(netPayable)}</td>
                        <td class="status-column"><span class="status-badge ${hasData ? 'saved' : 'empty'}">${hasData ? 'محفوظ' : 'فارغ'}</span></td>
                    `;
                } else if (currentMode === 'equipment') {
                    // Equipment Mode
                    const compData = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const hasData = !!compData;
                    const netPayable = hasData ? compData.netPayable : institutionInfo.equipmentGrantValue;

                    row.innerHTML = `
                        ${batchCell}
                        <td>${rowNumber}</td>
                        <td class="beneficiary-name-cell">
                            <span>${b.name}</span>
                            <div class="beneficiary-actions">
                                 <button class="edit-btn-inline" title="تعديل"><i class="fas fa-edit"></i></button>
                                 <button class="delete-btn-inline" title="حذف"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                        <td>${b.section || ''}</td>
                        <td class="calculated-cell net-payable-cell">${formatCurrency(netPayable)}</td>
                        <td class="status-column">
                            <button class="save-equipment-btn" style="background:none; border:none; cursor:pointer;">
                                <span class="status-badge ${hasData ? 'saved' : 'unsaved'}">${hasData ? 'محفوظ' : 'حفظ'}</span>
                            </button>
                        </td>
                    `;
                } else {
                    // Transport & Training Mode
                    let compData;
                    if (currentMode === 'transport') compData = compensationsTransport.find(c => c.beneficiaryId === b.id);
                    else compData = compensationsTraining.find(c => c.beneficiaryId === b.id);
                    
                    const hasData = !!compData;
                    const netPayable = hasData ? compData.netPayable : 0;

                    row.innerHTML = `
                        ${batchCell}
                        <td>${rowNumber}</td>
                        <td class="beneficiary-name-cell">
                            <span>${b.name}</span>
                            <div class="beneficiary-actions">
                                 <button class="edit-btn-inline" title="تعديل"><i class="fas fa-edit"></i></button>
                                 <button class="delete-btn-inline" title="حذف"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                        <td>${b.rank || ''}</td>
                        <td><input type="number" class="grid-input manual-amount-input" value="${netPayable.toFixed(2)}" step="0.01"></td>
                        <td class="status-column">
                            <button class="save-manual-btn" style="background:none; border:none; cursor:pointer;">
                                <span class="status-badge ${hasData ? 'saved' : 'unsaved'}">${hasData ? 'محفوظ' : 'حفظ'}</span>
                            </button>
                        </td>
                    `;
                }
                tableBody.appendChild(row);
            });
        }
        
        function openQuarterlyModal(beneficiaryId, quarterIndex) {
            if (currentMode !== 'electricity') return;
            
            // Check if quarter is enabled
            if (!quarterEnabled['q' + quarterIndex]) {
                showToast(`الثلاثي ${quarterIndex} معطّل حالياً. قم بتفعيله أولاً من أزرار التحكم بالثلاثيات`, 'warning');
                return;
            }
            
            const beneficiary = beneficiaries.find(b => b.id === beneficiaryId);
            if (!beneficiary) return;

            const modal = document.getElementById('quarterly-details-modal');
            const compData = compensations.find(c => c.beneficiaryId === beneficiaryId);

            document.getElementById('quarterly-modal-title').textContent = `تفاصيل الثلاثي ${quarterIndex} لـ: ${beneficiary.name}`;
            document.getElementById('quarterly-beneficiary-id').value = beneficiaryId;
            document.getElementById('quarterly-quarter-index').value = quarterIndex;
            
            const qData = compData ? compData[`q${quarterIndex}`] : { nofees: 0, value: 0, contrib: 0 };
            document.getElementById('quarterly-nofees').value = (qData.nofees || 0).toFixed(2);
            document.getElementById('quarterly-value').value = (qData.value || 0).toFixed(2);
            document.getElementById('quarterly-contrib').value = (qData.contrib || 0).toFixed(2);

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function closeQuarterlyModal() {
            const modal = document.getElementById('quarterly-details-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // ============================================
        // نظام الأصوات - Sound System
        // ============================================
        const SoundSystem = {
            audioContext: null,
            enabled: true,
            volume: 0.3,
            
            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // Load saved preference
                    const savedPref = localStorage.getItem('soundEnabled');
                    this.enabled = savedPref !== 'false';
                } catch (e) {
                    console.log('Web Audio API not supported');
                    this.enabled = false;
                }
            },
            
            resume() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            },
            
            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('soundEnabled', this.enabled);
                return this.enabled;
            },
            
            playTone(frequency, duration, type = 'sine', volumeMultiplier = 1) {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                const vol = this.volume * volumeMultiplier;
                gainNode.gain.setValueAtTime(vol, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            },
            
            // صوت النجاح - نغمة صاعدة مبهجة
            success() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.15, 'sine', 0.8), i * 80);
                });
            },
            
            // صوت الخطأ - نغمة منخفضة متكررة
            error() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(200, 0.15, 'square', 0.5);
                setTimeout(() => this.playTone(180, 0.2, 'square', 0.5), 150);
            },
            
            // صوت التحذير - نغمتان متناوبتان
            warning() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(440, 0.1, 'triangle', 0.6);
                setTimeout(() => this.playTone(380, 0.1, 'triangle', 0.6), 120);
                setTimeout(() => this.playTone(440, 0.15, 'triangle', 0.6), 240);
            },
            
            // صوت المعلومات - نغمة خفيفة
            info() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(600, 0.1, 'sine', 0.4);
            },
            
            // صوت الحفظ - نغمة تأكيد
            save() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(880, 0.08, 'sine', 0.5);
                setTimeout(() => this.playTone(1100, 0.12, 'sine', 0.5), 80);
            },
            
            // صوت الحذف - نغمة هابطة
            delete() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(400, 0.1, 'sawtooth', 0.3);
                setTimeout(() => this.playTone(300, 0.15, 'sawtooth', 0.3), 100);
            },
            
            // صوت تجاوز الاعتماد - إنذار
            creditAlert() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        this.playTone(800, 0.1, 'square', 0.4);
                        setTimeout(() => this.playTone(600, 0.1, 'square', 0.4), 100);
                    }, i * 250);
                }
            },
            
            // صوت الإضافة - نغمة إيجابية
            add() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(523.25, 0.08, 'sine', 0.5);
                setTimeout(() => this.playTone(698.46, 0.1, 'sine', 0.5), 70);
            },
            
            // صوت النقر/التفاعل
            click() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(1000, 0.03, 'sine', 0.2);
            },
            
            // صوت التصدير
            export() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                const notes = [392, 523.25, 659.25, 783.99]; // G4, C5, E5, G5
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.12, 'sine', 0.5), i * 60);
                });
            },
            
            // صوت الاستيراد
            import() {
                if (!this.enabled || !this.audioContext) return;
                this.resume();
                
                this.playTone(440, 0.1, 'sine', 0.5);
                setTimeout(() => this.playTone(554.37, 0.1, 'sine', 0.5), 100);
                setTimeout(() => this.playTone(659.25, 0.15, 'sine', 0.5), 200);
            }
        };
        
        // تهيئة نظام الأصوات
        SoundSystem.init();
        
        // تفعيل الصوت عند أول تفاعل من المستخدم
        document.addEventListener('click', () => SoundSystem.resume(), { once: true });

        function showToast(message, type = 'info') {
            // تشغيل الصوت المناسب
            switch(type) {
                case 'success':
                    SoundSystem.success();
                    break;
                case 'error':
                    SoundSystem.error();
                    break;
                case 'warning':
                    SoundSystem.warning();
                    break;
                default:
                    SoundSystem.info();
            }
            
            // Create a simple toast notification
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add toast animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        function handleQuarterlyFormSubmit(event) {
            event.preventDefault();
            const beneficiaryId = parseInt(document.getElementById('quarterly-beneficiary-id').value);
            const quarterIndex = parseInt(document.getElementById('quarterly-quarter-index').value);
            
            const nofees = parseFloat(document.getElementById('quarterly-nofees').value) || 0;
            const value = parseFloat(document.getElementById('quarterly-value').value) || 0;
            const contrib = parseFloat(document.getElementById('quarterly-contrib').value) || 0;

            const calculated = calculateQuarterlyComp(nofees, value, contrib);

            // تحديث أو إنشاء بيانات التعويض
            let compData = compensations.find(c => c.beneficiaryId === beneficiaryId);
            if (!compData) {
                compData = { 
                    beneficiaryId, 
                    q1: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    q2: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    q3: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    q4: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                    discount: 0, 
                    netPayable: 0 
                };
                compensations.push(compData);
            }

            // حفظ البيانات في الكائن مباشرة مع التقريب
            compData[`q${quarterIndex}`] = {
                nofees: roundToTwo(nofees),
                value: roundToTwo(value),
                contrib: roundToTwo(contrib),
                calculated: roundToTwo(calculated)
            };

            // إعادة حساب المجموع من الثلاثيات المفعلة فقط
            let totalComp = 0;
            for (let i = 1; i <= 4; i++) {
                if (quarterEnabled['q' + i]) {
                    totalComp = roundToTwo(totalComp + (compData[`q${i}`]?.calculated || 0));
                }
            }
            
            // تحديث الخصم والصافي
            const targetRow = document.querySelector(`#compensation-grid-table tbody tr[data-beneficiary-id='${beneficiaryId}']`);
            if (targetRow) {
                const discountInput = targetRow.querySelector('.discount-input');
                const discount = roundToTwo(parseFloat(discountInput.value) || 0);
                compData.discount = discount;
                compData.netPayable = roundToTwo(totalComp - discount);
                
                // تحديث جميع خلايا الثلاثيات في الجدول مع حفظ البيانات الكاملة
                for (let i = 1; i <= 4; i++) {
                    const cell = targetRow.querySelector(`td[data-quarter='${i}']`);
                    if (cell) {
                        const qData = compData[`q${i}`] || {nofees: 0, value: 0, contrib: 0, calculated: 0};
                        cell.textContent = formatCurrency(qData.calculated);
                        cell.setAttribute('data-nofees', qData.nofees);
                        cell.setAttribute('data-value', qData.value);
                        cell.setAttribute('data-contrib', qData.contrib);
                    }
                }
                
                // تحديث المجموع والصافي
                targetRow.querySelector('.total-comp-cell').textContent = formatCurrency(totalComp);
                targetRow.querySelector('.net-payable-cell').textContent = formatCurrency(compData.netPayable);
                
                // تحديث حالة الحفظ
                targetRow.classList.remove('is-dirty');
                const statusBadge = targetRow.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge saved';
                    statusBadge.textContent = 'محفوظ';
                }
            }
            
            // حفظ جميع البيانات باستخدام saveData
            saveData();
            
            // تحديث عرض الرصيد
            updateCreditDisplay();
            
            // إغلاق النافذة
            closeQuarterlyModal();
        }

        function processAndSaveRow(rowElement) {
            const beneficiaryId = parseInt(rowElement.dataset.beneficiaryId);

            if (currentMode === 'electricity') {
                let totalComp = 0;
                for (let i = 1; i <= 4; i++) {
                    if (quarterEnabled['q' + i]) {
                        const cell = rowElement.querySelector(`td[data-quarter='${i}']`);
                        totalComp = roundToTwo(totalComp + parseCurrency(cell.textContent));
                    }
                }

                const discountInput = rowElement.querySelector('.discount-input');
                let discount = roundToTwo(parseFloat(discountInput.value) || 0);
                if (isNaN(discount) || discount < 0) discount = 0;
                discountInput.value = discount.toFixed(2);

                const netPayable = roundToTwo(totalComp - discount);
                rowElement.querySelector('.total-comp-cell').textContent = formatCurrency(totalComp);
                rowElement.querySelector('.net-payable-cell').textContent = formatCurrency(netPayable);

                let compData = compensations.find(c => c.beneficiaryId === beneficiaryId);
                if (!compData) {
                    compData = { 
                        beneficiaryId, 
                        q1: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        q2: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        q3: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        q4: {nofees: 0, value: 0, contrib: 0, calculated: 0}, 
                        discount: 0, 
                        netPayable: 0 
                    };
                    compensations.push(compData);
                }

                for(let i=1; i<=4; i++) {
                    const cell = rowElement.querySelector(`td[data-quarter='${i}']`);
                    let nofees = roundToTwo(parseFloat(cell.getAttribute('data-nofees')) || 0);
                    let value = roundToTwo(parseFloat(cell.getAttribute('data-value')) || 0);
                    let contrib = roundToTwo(parseFloat(cell.getAttribute('data-contrib')) || 0);
                    let calculated = calculateQuarterlyComp(nofees, value, contrib);

                    compData[`q${i}`] = {
                        nofees: nofees,
                        value: value,
                        contrib: contrib,
                        calculated: calculated
                    };
                }
                
                compData.discount = discount;
                compData.netPayable = netPayable;

                rowElement.classList.remove('is-dirty');
                const statusBadge = rowElement.querySelector('.status-badge');
                statusBadge.className = 'status-badge saved';
                statusBadge.textContent = 'محفوظ';

            } else if (currentMode === 'equipment') {
                const grantValue = roundToTwo(parseFloat(institutionInfo.equipmentGrantValue) || 0);
                
                let compData = compensationsEquipment.find(c => c.beneficiaryId === beneficiaryId);
                if (!compData) {
                    compData = { beneficiaryId, netPayable: grantValue };
                    compensationsEquipment.push(compData);
                } else {
                    compData.netPayable = grantValue;
                }
                
                rowElement.querySelector('.net-payable-cell').textContent = formatCurrency(grantValue);
                const statusBadge = rowElement.querySelector('.status-badge');
                statusBadge.className = 'status-badge saved';
                statusBadge.textContent = 'محفوظ';
            } else {
                const amountInput = rowElement.querySelector('.manual-amount-input');
                let amount = roundToTwo(parseFloat(amountInput.value) || 0);
                if (isNaN(amount) || amount < 0) amount = 0;
                amountInput.value = amount.toFixed(2);
                
                let targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                let compData = targetArray.find(c => c.beneficiaryId === beneficiaryId);
                
                if (!compData) {
                    compData = { beneficiaryId, netPayable: amount };
                    targetArray.push(compData);
                } else {
                    compData.netPayable = amount;
                }
                
                const statusBadge = rowElement.querySelector('.status-badge');
                statusBadge.className = 'status-badge saved';
                statusBadge.textContent = 'محفوظ';
            }

            saveData();
            updateCreditDisplay();
        }

        // --- Reporting & Export ---
        function generateReportHTML(forPrint = false) {
            let reportData = [];
            let totalNetPayable = 0;
            let totalSum = 0;
            let totalDiscount = 0;

            // Reset numbering for each mode (Separation requested)
            let startCounter = 1;

            if (currentMode === 'electricity') {
                reportData = compensations.map(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    return (b && (b.type === 'electricity' || !b.type)) ? { ...comp, name: b.name, meter: b.meter, rip: calculateRIP(b.account), id: b.id } : null;
                }).filter(Boolean).sort((a,b) => a.id - b.id);
                
                totalNetPayable = roundToTwo(reportData.reduce((sum, item) => sum + (item.netPayable || 0), 0));
                totalSum = roundToTwo(reportData.reduce((sum, item) => sum + ((item.q1.calculated || 0) + (item.q2.calculated || 0) + (item.q3.calculated || 0) + (item.q4.calculated || 0)), 0));
                totalDiscount = roundToTwo(reportData.reduce((sum, item) => sum + (item.discount || 0), 0));
            } else if (currentMode === 'equipment') {
                reportData = beneficiaries.filter(b => b.type === 'equipment').map(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? roundToTwo(comp.netPayable) : roundToTwo(institutionInfo.equipmentGrantValue);
                    return { 
                        id: b.id, 
                        name: b.name, 
                        section: b.section || '', 
                        rip: calculateRIP(b.account), 
                        netPayable: netPayable 
                    };
                }).sort((a,b) => a.id - b.id);
                
                totalNetPayable = roundToTwo(reportData.reduce((sum, item) => sum + (item.netPayable || 0), 0));
            } else {
                // Transport & Training
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                reportData = beneficiaries.filter(b => b.type === currentMode).map(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? roundToTwo(comp.netPayable) : 0;
                    return { 
                        id: b.id, 
                        name: b.name, 
                        rank: b.rank || '', 
                        rip: calculateRIP(b.account), 
                        netPayable: netPayable 
                    };
                }).sort((a,b) => a.id - b.id);
                
                totalNetPayable = roundToTwo(reportData.reduce((sum, item) => sum + (item.netPayable || 0), 0));
            }
            
            let tableContent = '';
            if (currentMode === 'electricity') {
                tableContent = `
                <table><thead><tr>
                    <th>الرقم</th><th>اسم المستفيد</th><th>رقم العداد</th><th>رقم RIP الكامل</th>
                    <th>تعويض ث 1</th><th>تعويض ث 2</th><th>تعويض ث 3</th><th>تعويض ث 4</th>
                    <th>المجموع</th><th>الخصم</th><th>الصافي للدفع</th>
                </tr></thead><tbody>
                    ${reportData.map((item, index) => {
                        const totalBeforeDiscount = item.q1.calculated + item.q2.calculated + item.q3.calculated + item.q4.calculated;
                        return `
                        <tr>
                            <td>${startCounter + index}</td><td>${item.name}</td><td>${item.meter}</td><td>${item.rip}</td>
                            <td>${formatCurrency(item.q1.calculated)}</td><td>${formatCurrency(item.q2.calculated)}</td>
                            <td>${formatCurrency(item.q3.calculated)}</td><td>${formatCurrency(item.q4.calculated)}</td>
                            <td>${formatCurrency(totalBeforeDiscount)}</td>
                            <td>${formatCurrency(item.discount)}</td><td>${formatCurrency(item.netPayable)}</td>
                        </tr>`;
                    }).join('')}
                    <tr class="total-row">
                        <td colspan="8">المجموع</td>
                        <td>${formatCurrency(totalSum)}</td>
                        <td>${formatCurrency(totalDiscount)}</td>
                        <td>${formatCurrency(totalNetPayable)}</td>
                    </tr>
                </tbody></table>`;
            } else if (currentMode === 'equipment') {
                tableContent = `
                <table><thead><tr>
                    <th>الرقم</th><th>اسم المستفيد</th><th>القسم</th><th>رقم RIP الكامل</th><th>الصافي للدفع</th>
                </tr></thead><tbody>
                    ${reportData.map((item, index) => `
                        <tr>
                            <td>${startCounter + index}</td><td>${item.name}</td><td>${item.section || ''}</td><td>${item.rip}</td>
                            <td>${formatCurrency(item.netPayable)}</td>
                        </tr>`).join('')}
                    <tr class="total-row">
                        <td colspan="4">المجموع</td>
                        <td>${formatCurrency(totalNetPayable)}</td>
                    </tr>
                </tbody></table>`;
            } else {
                tableContent = `
                <table><thead><tr>
                    <th>الرقم</th><th>اسم المستفيد</th><th>الرتبة</th><th>رقم RIP الكامل</th><th>الصافي للدفع</th>
                </tr></thead><tbody>
                    ${reportData.map((item, index) => `
                        <tr>
                            <td>${startCounter + index}</td><td>${item.name}</td><td>${item.rank || ''}</td><td>${item.rip}</td>
                            <td>${formatCurrency(item.netPayable)}</td>
                        </tr>`).join('')}
                    <tr class="total-row">
                        <td colspan="4">المجموع</td>
                        <td>${formatCurrency(totalNetPayable)}</td>
                    </tr>
                </tbody></table>`;
            }

            let title = '';
            if (currentMode === 'electricity') title = 'الجدول التفصيلي للمستفيدين من تعويض استهلاك الكهرباء و الغاز';
            else if (currentMode === 'equipment') title = 'الجدول التفصيلي للمستفيدين من منحة التجهيز';
            else if (currentMode === 'transport') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف التنقل';
            else if (currentMode === 'training') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف العمليات التكوينية';

            return `
                <div class="report-header" style="text-align: center; margin-bottom: 10px;">
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.republic}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.ministry}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.directorate}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">${institutionInfo.institution}</p>
                    <p style="font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', serif; font-size: 15pt;">السنة المالية: ${institutionInfo.fiscalYear}</p>
                    <h3 style="margin-top: 10px; margin-bottom: 10px; font-weight: bold; font-family: 'Aref Ruqaa', serif; font-size: 20pt; text-decoration: underline;">${title}</h3>
                </div>
                ${tableContent}
                <div class="report-footer" style="text-align: right; margin-top: 10px;">
                    <p style="margin: 3px 0;">أوقف الجدول على مجموع مستفيدين قدره: ${reportData.length}</p>
                    <p style="margin: 3px 0;">أوقف الجدول على مجموع كلي بالأرقام: ${formatCurrency(totalNetPayable)} دج</p>
                    <p style="margin: 3px 0;">أوقف الجدول على مجموع كلي بالأحرف: ${numberToArabicText(totalNetPayable)}</p>
                    ${forPrint ? `<div style="display: flex; justify-content: space-around; margin-top: 15px;"><p style="font-family: 'Aref Ruqaa', serif; font-weight: bold; font-size: 16pt;">المدير</p><p style="font-family: 'Aref Ruqaa', serif; font-weight: bold; font-size: 16pt;">المسير المالي</p></div>` : ''}
                </div>`;
        }

        function generateReportPreview() {
            document.getElementById('report-preview').innerHTML = generateReportHTML(false);
        }

        function printReport() {
            const printContent = document.getElementById('print-report-content');
            if (!printContent) {
                showToast('خطأ: عنصر الطباعة غير موجود', 'error');
                return;
            }
            
            const reportHTML = generateReportHTML(true);
            if (!reportHTML) {
                showToast('خطأ في توليد التقرير', 'error');
                return;
            }
            
            printContent.innerHTML = reportHTML;
            
            // Trigger print with a small delay to ensure content is rendered
            setTimeout(() => {
                window.print();
                showToast('تم فتح نافذة الطباعة', 'success');
            }, 100);
        }

        function exportXLSX() {
            let reportData = [];
            let startCounter = 1;

            if (currentMode === 'electricity') {
                reportData = compensations.map(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    if (!b || (b.type && b.type !== 'electricity')) return null;
                    return {
                        id: b.id, name: b.name, meter: b.meter, rip: calculateRIP(b.account),
                        q1: Math.round(comp.q1.calculated * 100) / 100, 
                        q2: Math.round(comp.q2.calculated * 100) / 100, 
                        q3: Math.round(comp.q3.calculated * 100) / 100, 
                        q4: Math.round(comp.q4.calculated * 100) / 100,
                        discount: Math.round(comp.discount * 100) / 100, 
                        netPayable: Math.round(comp.netPayable * 100) / 100
                    };
                }).filter(Boolean).sort((a, b) => a.id - b.id);
            } else if (currentMode === 'equipment') {
                reportData = beneficiaries.filter(b => b.type === 'equipment').map(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                    return {
                        id: b.id, name: b.name, section: b.section || '', rip: calculateRIP(b.account),
                        netPayable: Math.round(netPayable * 100) / 100
                    };
                }).sort((a, b) => a.id - b.id);
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                reportData = beneficiaries.filter(b => b.type === currentMode).map(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : 0;
                    return {
                        id: b.id, name: b.name, rank: b.rank || '', rip: calculateRIP(b.account),
                        netPayable: Math.round(netPayable * 100) / 100
                    };
                }).sort((a, b) => a.id - b.id);
            }

            if (reportData.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'error');
                return;
            }

            // استخدام ExcelJS لإنشاء ملف Excel منسق
            const workbook = new ExcelJS.Workbook();
            workbook.views = [{ rightToLeft: true }];
            const worksheet = workbook.addWorksheet('تقرير التعويضات', { views: [{ rightToLeft: true }] });

            // تحديد عدد الأعمدة حسب النوع
            let numCols = currentMode === 'electricity' ? 11 : 5;
            
            let title = '';
            if (currentMode === 'electricity') title = 'الجدول التفصيلي للمستفيدين من تعويض استهلاك الكهرباء و الغاز';
            else if (currentMode === 'equipment') title = 'الجدول التفصيلي للمستفيدين من منحة التجهيز';
            else if (currentMode === 'transport') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف التنقل';
            else if (currentMode === 'training') title = 'الجدول التفصيلي للمستفيدين من تعويض مصاريف العمليات التكوينية';

            const modeDetails = institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode] ? institutionInfo.modeDetails[currentMode] : {};

            // تعريف نمط الحدود
            const thinBorder = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };

            // تعريف المحاذاة المركزية
            const centerAlign = { horizontal: 'center', vertical: 'middle', wrapText: true };
            
            // تعريف المحاذاة لليمين
            const rightAlign = { horizontal: 'right', vertical: 'middle', wrapText: true };

            // تحديد عرض الأعمدة
            if (currentMode === 'electricity') {
                worksheet.columns = [
                    { width: 8 },   // الرقم
                    { width: 28 },  // اسم المستفيد
                    { width: 14 },  // رقم العداد
                    { width: 24 },  // رقم RIP
                    { width: 12 },  // ث1
                    { width: 12 },  // ث2
                    { width: 12 },  // ث3
                    { width: 12 },  // ث4
                    { width: 14 },  // المجموع
                    { width: 12 },  // الخصم
                    { width: 16 }   // الصافي
                ];
            } else {
                worksheet.columns = [
                    { width: 8 },   // الرقم
                    { width: 32 },  // اسم المستفيد
                    { width: 20 },  // القسم/الرتبة
                    { width: 24 },  // رقم RIP
                    { width: 18 }   // الصافي
                ];
            }

            // دالة لإضافة صف مدمج بدون حدود (للعناوين)
            function addMergedRowNoBorder(text, rowNum, isBold = false, fontSize = 12) {
                const row = worksheet.addRow([text]);
                worksheet.mergeCells(rowNum, 1, rowNum, numCols);
                const cell = row.getCell(1);
                cell.alignment = centerAlign;
                cell.font = { bold: isBold, size: fontSize, name: 'Arial' };
                return row;
            }

            // صف 1: الجمهورية
            addMergedRowNoBorder(institutionInfo.republic, 1, true, 14);
            
            // صف 2: الوزارة
            addMergedRowNoBorder(institutionInfo.ministry, 2, false, 12);
            
            // صف 3: المديرية
            addMergedRowNoBorder(institutionInfo.directorate, 3, false, 12);
            
            // صف 4: المؤسسة
            addMergedRowNoBorder(institutionInfo.institution, 4, false, 12);
            
            // صف 5: فارغ
            const emptyRow1 = worksheet.addRow([]);
            worksheet.mergeCells(5, 1, 5, numCols);
            
            // صف 6: عنوان التقرير
            addMergedRowNoBorder(title, 6, true, 14);
            
            // صف 7: السنة والشهر المالي
            addMergedRowNoBorder(`السنة المالية: ${institutionInfo.fiscalYear} - الشهر: ${modeDetails.month || '...'}`, 7, false, 11);
            
            // صف 8: رقم الأمر بالصرف والحوالة
            addMergedRowNoBorder(`رقم الأمر بالصرف: ${modeDetails.order || '...'} - رقم الحوالة: ${modeDetails.transfer || '...'}`, 8, false, 11);
            
            // صف 9: فارغ
            const emptyRow2 = worksheet.addRow([]);
            worksheet.mergeCells(9, 1, 9, numCols);

            // صف 10: عناوين الجدول
            let headerRowData = [];
            if (currentMode === 'electricity') {
                headerRowData = ["الرقم", "اسم المستفيد", "رقم العداد", "رقم RIP الكامل", "تعويض ث 1", "تعويض ث 2", "تعويض ث 3", "تعويض ث 4", "المجموع", "الخصم", "الصافي للدفع"];
            } else if (currentMode === 'equipment') {
                headerRowData = ["الرقم", "اسم المستفيد", "القسم", "رقم RIP الكامل", "الصافي للدفع"];
            } else {
                headerRowData = ["الرقم", "اسم المستفيد", "الرتبة", "رقم RIP الكامل", "الصافي للدفع"];
            }
            
            const headerRow = worksheet.addRow(headerRowData);
            headerRow.eachCell((cell) => {
                cell.font = { bold: true, size: 11, name: 'Arial' };
                cell.alignment = centerAlign;
                cell.border = thinBorder;
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEEEEEE' } };
            });

            let totalNetPayable = 0;

            // إضافة بيانات المستفيدين
            if (currentMode === 'electricity') {
                reportData.forEach((item, index) => {
                    const totalBeforeDiscount = Math.round((item.q1 + item.q2 + item.q3 + item.q4) * 100) / 100;
                    const dataRow = worksheet.addRow([
                        startCounter + index, item.name, item.meter, item.rip,
                        item.q1, item.q2, item.q3, item.q4,
                        totalBeforeDiscount, item.discount, item.netPayable
                    ]);
                    dataRow.eachCell((cell) => {
                        cell.alignment = centerAlign;
                        cell.border = thinBorder;
                        cell.font = { size: 10, name: 'Arial' };
                    });
                    totalNetPayable += item.netPayable;
                });
                
                // صف المجموع
                const totalQ1 = Math.round(reportData.reduce((sum, item) => sum + item.q1, 0) * 100) / 100;
                const totalQ2 = Math.round(reportData.reduce((sum, item) => sum + item.q2, 0) * 100) / 100;
                const totalQ3 = Math.round(reportData.reduce((sum, item) => sum + item.q3, 0) * 100) / 100;
                const totalQ4 = Math.round(reportData.reduce((sum, item) => sum + item.q4, 0) * 100) / 100;
                const totalSum = Math.round((totalQ1 + totalQ2 + totalQ3 + totalQ4) * 100) / 100;
                const totalDiscount = Math.round(reportData.reduce((sum, item) => sum + item.discount, 0) * 100) / 100;
                
                const totalRow = worksheet.addRow(["المجموع", "", "", "", totalQ1, totalQ2, totalQ3, totalQ4, totalSum, totalDiscount, Math.round(totalNetPayable * 100) / 100]);
                const totalRowNum = worksheet.rowCount;
                worksheet.mergeCells(totalRowNum, 1, totalRowNum, 4);
                totalRow.eachCell((cell) => {
                    cell.font = { bold: true, size: 11, name: 'Arial' };
                    cell.alignment = centerAlign;
                    cell.border = thinBorder;
                });
            } else {
                reportData.forEach((item, index) => {
                    const thirdCol = currentMode === 'equipment' ? item.section : item.rank;
                    const dataRow = worksheet.addRow([startCounter + index, item.name, thirdCol, item.rip, item.netPayable]);
                    dataRow.eachCell((cell) => {
                        cell.alignment = centerAlign;
                        cell.border = thinBorder;
                        cell.font = { size: 10, name: 'Arial' };
                    });
                    totalNetPayable += item.netPayable;
                });
                
                // صف المجموع
                const totalRow = worksheet.addRow(["المجموع", "", "", "", Math.round(totalNetPayable * 100) / 100]);
                const totalRowNum = worksheet.rowCount;
                worksheet.mergeCells(totalRowNum, 1, totalRowNum, 4);
                totalRow.eachCell((cell) => {
                    cell.font = { bold: true, size: 11, name: 'Arial' };
                    cell.alignment = centerAlign;
                    cell.border = thinBorder;
                });
            }

            // صف فارغ
            worksheet.addRow([]);
            
            // صف: عدد المستفيدين
            const summaryRowNum1 = worksheet.rowCount + 1;
            addMergedRowNoBorder(`أوقف الجدول على مجموع مستفيدين قدره: ${reportData.length}`, summaryRowNum1, false, 11);
            
            // صف: المجموع بالأرقام
            const summaryRowNum2 = worksheet.rowCount + 1;
            addMergedRowNoBorder(`أوقف الجدول على مجموع كلي بالأرقام: ${formatCurrency(totalNetPayable)} دج`, summaryRowNum2, false, 11);
            
            // صف: المجموع بالأحرف
            const summaryRowNum3 = worksheet.rowCount + 1;
            addMergedRowNoBorder(`أوقف الجدول على مجموع كلي بالأحرف: ${numberToArabicText(totalNetPayable)}`, summaryRowNum3, false, 11);
            
            // صف فارغ
            worksheet.addRow([]);
            
            // صف التوقيعات (محاذاة لليمين وبدون حدود)
            const sigRowNum = worksheet.rowCount + 1;
            if (currentMode === 'electricity') {
                const sigRow = worksheet.addRow(["المقتصد", "", "", "", "", "المدير", "", "", "", "", ""]);
                worksheet.mergeCells(sigRowNum, 1, sigRowNum, 5);
                worksheet.mergeCells(sigRowNum, 6, sigRowNum, 11);
                sigRow.getCell(1).alignment = rightAlign;
                sigRow.getCell(1).font = { bold: true, size: 12, name: 'Arial' };
                sigRow.getCell(6).alignment = rightAlign;
                sigRow.getCell(6).font = { bold: true, size: 12, name: 'Arial' };
            } else {
                const sigRow = worksheet.addRow(["المقتصد", "", "المدير", "", ""]);
                worksheet.mergeCells(sigRowNum, 1, sigRowNum, 2);
                worksheet.mergeCells(sigRowNum, 3, sigRowNum, 5);
                sigRow.getCell(1).alignment = rightAlign;
                sigRow.getCell(1).font = { bold: true, size: 12, name: 'Arial' };
                sigRow.getCell(3).alignment = rightAlign;
                sigRow.getCell(3).font = { bold: true, size: 12, name: 'Arial' };
            }
            
            // تصدير الملف
            const filename = `تقرير_${currentMode}_${institutionInfo.fiscalYear || 'YYYY'}_${new Date().toLocaleDateString('ar-SA')}.xlsx`;
            
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
                SoundSystem.export();
                showToast(`تم تصدير الملف: ${filename}`, 'success');
            }).catch(err => {
                console.error('خطأ في تصدير Excel:', err);
                showToast('حدث خطأ أثناء تصدير الملف', 'error');
            });
        }

        function exportTxt() {
            let validRecords = [];
            let totalRoundedNetPayable = 0;
            let invalidRecords = 0;
            
            if (currentMode === 'electricity') {
                compensations.forEach(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    if (b && (b.type === 'electricity' || !b.type)) {
                        const rip = calculateRIP(b.account);
                        if (!rip.includes('خطأ') && /^[a-zA-Z\s\-]+$/.test(b.name)) {
                            const netPayableRounded = Math.round(comp.netPayable * 100) / 100;
                            totalRoundedNetPayable += netPayableRounded;
                            const amountCents = String(Math.round(netPayableRounded * 100)).padStart(13, '0');
                            const namePadded = (b.name + ' '.repeat(27)).substring(0, 27);
                            validRecords.push(`*${rip}${amountCents}${namePadded}1`);
                        } else {
                            invalidRecords++;
                        }
                    }
                });
            } else if (currentMode === 'equipment') {
                beneficiaries.filter(b => b.type === 'equipment').forEach(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                    const rip = calculateRIP(b.account);
                    
                    if (!rip.includes('خطأ') && /^[a-zA-Z\s\-]+$/.test(b.name)) {
                        const netPayableRounded = Math.round(netPayable * 100) / 100;
                        totalRoundedNetPayable += netPayableRounded;
                        const amountCents = String(Math.round(netPayableRounded * 100)).padStart(13, '0');
                        const namePadded = (b.name + ' '.repeat(27)).substring(0, 27);
                        validRecords.push(`*${rip}${amountCents}${namePadded}1`);
                    } else {
                        invalidRecords++;
                    }
                });
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                beneficiaries.filter(b => b.type === currentMode).forEach(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : 0;
                    const rip = calculateRIP(b.account);
                    
                    if (!rip.includes('خطأ') && /^[a-zA-Z\s\-]+$/.test(b.name)) {
                        const netPayableRounded = Math.round(netPayable * 100) / 100;
                        totalRoundedNetPayable += netPayableRounded;
                        const amountCents = String(Math.round(netPayableRounded * 100)).padStart(13, '0');
                        const namePadded = (b.name + ' '.repeat(27)).substring(0, 27);
                        validRecords.push(`*${rip}${amountCents}${namePadded}1`);
                    } else {
                        invalidRecords++;
                    }
                });
            }

            if (validRecords.length === 0) {
                showToast('لا توجد سجلات صحيحة للتصدير. تحقق من بيانات المستفيدين والحسابات', 'error');
                return;
            }

            const treasuryRIP = calculateRIP(institutionInfo.treasuryAccount);
            if (treasuryRIP.includes('خطأ')) {
                showToast('خطأ: رقم الحساب البريدي للخزينة غير صحيح. يرجى تحديث معلومات المؤسسة', 'error');
                return;
            }

            const details = (institutionInfo.modeDetails && institutionInfo.modeDetails[currentMode]) ? 
                            institutionInfo.modeDetails[currentMode] : 
                            { month: institutionInfo.financialMonth, order: institutionInfo.orderNumber, transfer: institutionInfo.transferNumber };

            const totalAmountCents = String(Math.round(totalRoundedNetPayable * 100)).padStart(13, '0');
            const recordCount = String(validRecords.length).padStart(7, '0');
            const month = String(details.month || '01').padStart(2, '0');
            const year = String(institutionInfo.fiscalYear).padStart(4, '0');
            const order = String(details.order || '0').padStart(8, '0');
            const transfer = String(details.transfer || '0').padStart(6, '0');
            const header = `*${treasuryRIP}${totalAmountCents}${recordCount}${month}${year}${order}${transfer}0`;
            
            if (header.length !== 62) {
                showToast('خطأ في توليد السطر الأول للملف. تحقق من معلومات المؤسسة كاملة', 'error');
                return;
            }

            const txtContent = [header, ...validRecords].join('\n');
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = `Payment_File_${currentMode}_${institutionInfo.fiscalYear}_${new Date().toLocaleDateString('ar-SA')}.txt`;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            SoundSystem.export();
            let message = `تم تصدير الملف: ${filename}\n${validRecords.length} سجل صحيح`;
            if (invalidRecords > 0) {
                message += `\n⚠️ ${invalidRecords} سجل مرفوض (بيانات غير صحيحة)`;
            }
            showToast(message, 'success');
        }

        function printCDRomReport() {
            let reportData = [];
            
            if (currentMode === 'electricity') {
                reportData = compensations
                    .map(comp => {
                        const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                        if (!b || (b.type && b.type !== 'electricity')) return null;
                        const rip = calculateRIP(b.account);
                        if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) {
                            return null;
                        }
                        return {
                            id: b.id,
                            name: b.name,
                            accountPart: rip.substring(0, 18),
                            keyPart: rip.substring(18),
                            netPayable: comp.netPayable
                        };
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.id - b.id);
            } else if (currentMode === 'equipment') {
                reportData = beneficiaries.filter(b => b.type === 'equipment')
                    .map(b => {
                        const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                        const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                        const rip = calculateRIP(b.account);
                        if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) {
                            return null;
                        }
                        return {
                            id: b.id,
                            name: b.name,
                            accountPart: rip.substring(0, 18),
                            keyPart: rip.substring(18),
                            netPayable: netPayable
                        };
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.id - b.id);
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                reportData = beneficiaries.filter(b => b.type === currentMode)
                    .map(b => {
                        const comp = targetArray.find(c => c.beneficiaryId === b.id);
                        const netPayable = comp ? comp.netPayable : 0;
                        const rip = calculateRIP(b.account);
                        if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) {
                            return null;
                        }
                        return {
                            id: b.id,
                            name: b.name,
                            accountPart: rip.substring(0, 18),
                            keyPart: rip.substring(18),
                            netPayable: netPayable
                        };
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.id - b.id);
            }
            
            if (reportData.length === 0) {
                alert("لا توجد بيانات صالحة لطباعة التقرير.");
                return;
            }

            const months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            const monthName = months[parseInt(institutionInfo.financialMonth, 10) - 1] || 'N/A';
            const year = institutionInfo.fiscalYear || 'YYYY';
            const orgAccount = institutionInfo.treasuryAccount || 'N/A';
            const orgKey = institutionInfo.treasuryKey || 'N/A';
            const totalAmount = reportData.reduce((sum, item) => sum + item.netPayable, 0);
            const beneficiaryCount = reportData.length;

            const beneficiaryRows = reportData.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.accountPart} / ${item.keyPart}</td>
                    <td>${formatCurrency(item.netPayable)}</td>
                </tr>
            `).join('');

            const reportHTML = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Etat de virement sur le CD-ROM</title>
                    <style>
                        body { font-family: "Times New Roman", serif; margin: 40px; color: #000; }
                        h2 { text-align: center; text-decoration: underline; margin-bottom: 5px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .details { margin-bottom: 20px; line-height: 1.8; }
                        table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 10px; font-weight: bold; }
                        @media print {
                            body { margin: 20px; }
                            button { display: none; }
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    </style>
                </head>
                <body>
                    <h2>Etat de virement sur le CD-ROM</h2>
                    <div class="header">
                        <strong>Mois :</strong> ${monthName} &nbsp;&nbsp;&nbsp;
                        <strong>Année :</strong> ${year}
                    </div>
                    <div class="details">
                        <strong>Numéro de compte de l’organisme :</strong> ${orgAccount} &nbsp;&nbsp; <strong>Clé :</strong> ${orgKey}<br>
                        <strong>Montant global de virement :</strong> ${formatCurrency(totalAmount)}<br>
                        <strong>L’Effectif :</strong> ${beneficiaryCount}<br>
                        <strong>Code Ordonnateur :</strong> 0<br>
                        <strong>N° Mandat :</strong> 0
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>N</th>
                                <th>Nom et Prénom</th>
                                <th>Compte / Clé</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${beneficiaryRows}
                        </tbody>
                    </table>
                    <div class="footer">
                        Nombre de titres : ${beneficiaryCount} &nbsp;&nbsp;&nbsp; Montant global de détail : ${formatCurrency(totalAmount)}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() { window.close(); };
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank', 'height=700,width=900,scrollbars=yes');
            if (printWindow) {
                printWindow.document.write(reportHTML);
                printWindow.document.close();
            } else {
                alert("فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة لهذا الموقع.");
            }
        }


        // ============================================
        // ========== PRO TXT EDITOR ===========
        // ============================================

        let proEditorData = []; // بيانات المحرر مع المبالغ المعدلة
        let proEditorInfo = {
            fiscalYear: new Date().getFullYear(),
            fiscalMonth: 1,
            orderNumber: 0,
            transferNumber: 0,
            treasuryAccount: '',
            keyNumber: '',
            dataSource: 'التعويضات المحجوزة'
        };

        function renderProEditorSection() {
            proEditorInfo.fiscalYear = institutionInfo.fiscalYear || new Date().getFullYear();
            proEditorInfo.fiscalMonth = institutionInfo.financialMonth || 1;
            proEditorInfo.orderNumber = institutionInfo.orderNumber || 0;
            proEditorInfo.transferNumber = institutionInfo.transferNumber || 0;
            proEditorInfo.treasuryAccount = institutionInfo.treasuryAccount || '';
            proEditorInfo.keyNumber = institutionInfo.keyNumber || '';

            document.getElementById('pro-fiscal-year-input').value = proEditorInfo.fiscalYear;
            document.getElementById('pro-fiscal-month-input').value = proEditorInfo.fiscalMonth;
            document.getElementById('pro-order-number').value = proEditorInfo.orderNumber;
            document.getElementById('pro-transfer-number').value = proEditorInfo.transferNumber;
            document.getElementById('pro-treasury-account').value = proEditorInfo.treasuryAccount;
            document.getElementById('pro-key-number').value = proEditorInfo.keyNumber;

            if (proEditorData.length === 0) {
                proLoadFromCompensations();
            } else {
                renderProEditorTable();
                updateProTotals();
                updateProEmptyState();
            }
        }

        function updateProInfo() {
            proEditorInfo.fiscalYear = parseInt(document.getElementById('pro-fiscal-year-input').value) || new Date().getFullYear();
            proEditorInfo.fiscalMonth = parseInt(document.getElementById('pro-fiscal-month-input').value) || 1;
            proEditorInfo.orderNumber = parseInt(document.getElementById('pro-order-number').value) || 0;
            proEditorInfo.transferNumber = parseInt(document.getElementById('pro-transfer-number').value) || 0;
            proEditorInfo.treasuryAccount = document.getElementById('pro-treasury-account').value || '';
            proEditorInfo.keyNumber = document.getElementById('pro-key-number').value || '';
        }

        function proLoadFromCompensations() {
            proEditorData = [];

            if (currentMode === 'electricity') {
                compensations.forEach(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    if (!b || (b.type && b.type !== 'electricity')) return;
                    const rip = calculateRIP(b.account);
                    if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) return;

                    proEditorData.push({
                        id: b.id,
                        name: b.name,
                        account: b.account,
                        rip: rip,
                        originalAmount: comp.netPayable,
                        modifiedAmount: comp.netPayable
                    });
                });
            } else if (currentMode === 'equipment') {
                beneficiaries.filter(b => b.type === 'equipment').forEach(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : institutionInfo.equipmentGrantValue;
                    const rip = calculateRIP(b.account);
                    if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) return;

                    proEditorData.push({
                        id: b.id,
                        name: b.name,
                        account: b.account,
                        rip: rip,
                        originalAmount: netPayable,
                        modifiedAmount: netPayable
                    });
                });
            } else {
                const targetArray = currentMode === 'transport' ? compensationsTransport : compensationsTraining;
                beneficiaries.filter(b => b.type === currentMode).forEach(b => {
                    const comp = targetArray.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? comp.netPayable : 0;
                    const rip = calculateRIP(b.account);
                    if (rip.includes('خطأ') || !/^[a-zA-Z\s\-]+$/.test(b.name)) return;

                    proEditorData.push({
                        id: b.id,
                        name: b.name,
                        account: b.account,
                        rip: rip,
                        originalAmount: netPayable,
                        modifiedAmount: netPayable
                    });
                });
            }

            proEditorData.sort((a, b) => a.id - b.id);
            proEditorInfo.dataSource = 'التعويضات المحجوزة';
            document.getElementById('pro-data-source').textContent = proEditorInfo.dataSource;

            renderProEditorTable();
            updateProTotals();
            updateProEmptyState();

            if (proEditorData.length > 0) {
                showToast(`تم تحميل ${proEditorData.length} مستفيد من التعويضات المحجوزة`, 'success');
            }
        }

        function proImportTxt() {
            document.getElementById('pro-import-file-input').click();
        }

        function proHandleFileImport(event) {
            // ملاحظة: استيراد المحرر الاحترافي معزول ولا يضيف شيئاً إلى قوائم المستفيدين/التعويضات الرئيسية
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    showToast('الملف لا يحتوي على بيانات كافية', 'error');
                    return;
                }

                const headerLine = lines[0];
                if (!headerLine.startsWith('*')) {
                    showToast('تنسيق الملف غير صحيح', 'error');
                    return;
                }

                const headerData = headerLine.substring(1);
                if (headerData.length >= 51) {
                    const month = parseInt(headerData.substring(39, 41), 10);
                    const year = parseInt('20' + headerData.substring(41, 43), 10);
                    const order = parseInt(headerData.substring(43, 47), 10);
                    const transfer = parseInt(headerData.substring(47, 51), 10);

                    proEditorInfo.fiscalMonth = month || 1;
                    proEditorInfo.fiscalYear = year || new Date().getFullYear();
                    proEditorInfo.orderNumber = order || 0;
                    proEditorInfo.transferNumber = transfer || 0;

                    // استخراج رقم الحساب CCP ورقم المفتاح من أول سجل
                    if (lines.length > 1) {
                        const firstDataLine = lines[1].trim();
                        if (firstDataLine.startsWith('*') && firstDataLine.length >= 61) {
                            const data = firstDataLine.substring(1);
                            const rip = data.substring(0, 20);
                            // رقم الحساب من RIP (المواضع 10-18)
                            proEditorInfo.treasuryAccount = rip.substring(10, 18).trim();
                            // رقم المفتاح من RIP (المواضع 0-10)
                            proEditorInfo.keyNumber = rip.substring(0, 10).trim();
                        }
                    }

                    document.getElementById('pro-fiscal-year-input').value = proEditorInfo.fiscalYear;
                    document.getElementById('pro-fiscal-month-input').value = proEditorInfo.fiscalMonth;
                    document.getElementById('pro-order-number').value = proEditorInfo.orderNumber;
                    document.getElementById('pro-transfer-number').value = proEditorInfo.transferNumber;
                    document.getElementById('pro-treasury-account').value = proEditorInfo.treasuryAccount;
                    document.getElementById('pro-key-number').value = proEditorInfo.keyNumber;
                }

                proEditorData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line.startsWith('*') || line.length < 61) continue;

                    const data = line.substring(1);
                    const rip = data.substring(0, 20);
                    const amountCents = parseInt(data.substring(20, 33), 10);
                    const amount = amountCents / 100;
                    const name = data.substring(33, 60).trim();
                    const account = rip.substring(10, 18).replace(/^0+/, '');

                    proEditorData.push({
                        id: i,
                        name: name,
                        account: account,
                        rip: rip,
                        originalAmount: amount,
                        modifiedAmount: amount
                    });
                }

                proEditorInfo.dataSource = `ملف مستورد (${file.name})`;
                document.getElementById('pro-data-source').textContent = proEditorInfo.dataSource;

                renderProEditorTable();
                updateProTotals();
                updateProEmptyState();

                SoundSystem.import();
                showToast(`تم استيراد ${proEditorData.length} سجل من الملف`, 'success');
            };

            reader.readAsText(file);
            event.target.value = '';
        }

        function renderProEditorTable() {
            const tbody = document.getElementById('pro-editor-tbody');
            tbody.innerHTML = '';

            proEditorData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>
                        <input type="text" 
                               class="pro-account-input" 
                               value="${item.account}" 
                               data-index="${index}"
                               onchange="updateProAccountAndRIP(${index}, this.value)"
                               placeholder="رقم الحساب">
                    </td>
                    <td>
                        <span class="pro-rip-display" data-index="${index}">${item.rip}</span>
                    </td>
                    <td class="original-amount">${formatCurrency(item.originalAmount)}</td>
                    <td>
                        <input type="number" 
                               class="amount-input" 
                               value="${item.modifiedAmount.toFixed(2)}" 
                               step="0.01" 
                               min="0"
                               data-index="${index}"
                               onchange="updateProAmount(${index}, this.value)"
                               oninput="markProInputModified(this, ${item.originalAmount})">
                    </td>
                    <td>
                        <button class="delete-btn" onclick="proDeleteRow(${index})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pro-beneficiary-count').textContent = proEditorData.length;
        }

        function updateProEmptyState() {
            const emptyState = document.getElementById('pro-empty-state');
            const table = document.getElementById('pro-editor-table');

            if (proEditorData.length === 0) {
                emptyState.classList.add('visible');
                table.style.display = 'none';
            } else {
                emptyState.classList.remove('visible');
                table.style.display = 'table';
            }
        }

        function proDeleteRow(index) {
            if (!confirm('هل تريد حذف هذا السجل؟')) return;

            proEditorData.splice(index, 1);
            renderProEditorTable();
            updateProTotals();
            updateProEmptyState();
            SoundSystem.delete();
        }

        function proClearTable() {
            if (proEditorData.length === 0) {
                showToast('الجدول فارغ بالفعل', 'info');
                return;
            }

            if (!confirm('هل تريد مسح جميع البيانات من الجدول؟')) return;

            proEditorData = [];
            renderProEditorTable();
            updateProTotals();
            updateProEmptyState();
            SoundSystem.delete();
            showToast('تم مسح الجدول', 'success');
        }

        function markProInputModified(input, originalAmount) {
            const currentValue = parseFloat(input.value) || 0;
            if (Math.abs(currentValue - originalAmount) > 0.001) {
                input.classList.add('modified');
            } else {
                input.classList.remove('modified');
            }
        }

        function updateProAccountAndRIP(index, newAccount) {
            // تحديث رقم الحساب
            proEditorData[index].account = newAccount;
            
            // حساب RIP الجديد
            const newRIP = calculateRIP(newAccount);
            if (newRIP.includes('خطأ')) {
                showToast(`خطأ: رقم الحساب غير صحيح - ${newRIP}`, 'error');
                // استعادة البيانات السابقة في الحقل
                document.querySelector(`.pro-account-input[data-index="${index}"]`).value = proEditorData[index].account;
                return;
            }
            
            // تحديث RIP في البيانات
            proEditorData[index].rip = newRIP;
            
            // تحديث عرض RIP في الجدول
            const ripDisplay = document.querySelector(`.pro-rip-display[data-index="${index}"]`);
            if (ripDisplay) {
                ripDisplay.textContent = newRIP;
            }
            
            SoundSystem.click();
            showToast('تم تحديث RIP بنجاح', 'success');
        }

        function updateProAmount(index, value) {
            const newAmount = parseFloat(value) || 0;
            proEditorData[index].modifiedAmount = Math.round(newAmount * 100) / 100;
            updateProTotals();
            SoundSystem.click();
        }

        function updateProTotals() {
            const originalTotal = proEditorData.reduce((sum, item) => sum + item.originalAmount, 0);
            const modifiedTotal = proEditorData.reduce((sum, item) => sum + item.modifiedAmount, 0);

            document.getElementById('pro-original-total').textContent = formatCurrency(originalTotal);
            document.getElementById('pro-modified-total').textContent = formatCurrency(modifiedTotal);
            document.getElementById('pro-total-amount').textContent = formatCurrency(modifiedTotal) + ' دج';
            document.getElementById('pro-beneficiary-count').textContent = proEditorData.length;
        }

        function proResetAmounts() {
            if (proEditorData.length === 0) {
                showToast('لا توجد بيانات لاستعادتها', 'info');
                return;
            }

            if (!confirm('هل تريد استعادة جميع المبالغ الأصلية؟')) return;

            proEditorData.forEach(item => {
                item.modifiedAmount = item.originalAmount;
            });

            renderProEditorTable();
            updateProTotals();
            SoundSystem.success();
            showToast('تم استعادة المبالغ الأصلية', 'success');
        }

        function proExportTxt() {
            if (proEditorData.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'error');
                return;
            }

            updateProInfo();

            let validRecords = [];
            let totalAmount = 0;

            proEditorData.forEach(item => {
                if (item.modifiedAmount > 0) {
                    const amountCents = String(Math.round(item.modifiedAmount * 100)).padStart(13, '0');
                    const namePadded = (item.name + ' '.repeat(27)).substring(0, 27);
                    validRecords.push(`*${item.rip}${amountCents}${namePadded}1`);
                    totalAmount += item.modifiedAmount;
                }
            });

            if (validRecords.length === 0) {
                showToast('لا توجد سجلات صالحة للتصدير (جميع المبالغ صفر)', 'error');
                return;
            }

            // تحديد مصدر البيانات ورقم الحساب
            let treasuryAccount = '';
            let treasuryRIP = '';
            
            // إذا كانت البيانات مستوردة من ملف TXT، استخدم بيانات الملف المستورد
            if (proEditorInfo.dataSource.includes('ملف مستورد')) {
                treasuryAccount = proEditorInfo.treasuryAccount;
                // استخدام RIP من أول سجل في البيانات المستوردة (يحتوي على بيانات الخزينة)
                if (proEditorData.length > 0) {
                    treasuryRIP = proEditorData[0].rip ? proEditorData[0].rip.substring(0, 20) : calculateRIP(treasuryAccount);
                }
            } else {
                // إذا كانت البيانات محملة من التعويضات المحجوزة، استخدم بيانات المؤسسة
                treasuryAccount = institutionInfo.treasuryAccount;
                treasuryRIP = calculateRIP(treasuryAccount);
            }

            if (treasuryRIP.includes('خطأ') || !treasuryRIP || treasuryRIP.length < 20) {
                showToast('خطأ: رقم حساب الخزينة غير صحيح. يرجى التحقق من معلومات الحساب.', 'error');
                return;
            }

            const totalAmountCents = String(Math.round(totalAmount * 100)).padStart(13, '0');
            const recordCount = String(validRecords.length).padStart(7, '0');
            const month = String(proEditorInfo.fiscalMonth).padStart(2, '0');
            const year = String(proEditorInfo.fiscalYear).padStart(4, '0');
            const order = String(proEditorInfo.orderNumber).padStart(8, '0');
            const transfer = String(proEditorInfo.transferNumber).padStart(6, '0');

            const header = `*${treasuryRIP}${totalAmountCents}${recordCount}${month}${year}${order}${transfer}0`;
            
            if (header.length !== 62) {
                showToast(`خطأ في توليد السطر الأول: الطول = ${header.length} (يجب أن يكون 62)`, 'error');
                return;
            }

            const fileContent = header + '\n' + validRecords.join('\n');

            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = `Pro_Payment_${currentMode}_${proEditorInfo.fiscalYear}_${month}_${new Date().toLocaleDateString('ar-SA')}.txt`;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            SoundSystem.export();
            showToast(`تم تصدير الملف بنجاح\n${validRecords.length} سجل - المجموع: ${formatCurrency(totalAmount)} دج`, 'success');
        }

        function proPrintCDRom() {
            if (proEditorData.length === 0) {
                showToast('لا توجد بيانات للطباعة', 'error');
                return;
            }

            updateProInfo();

            const months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            const monthName = months[proEditorInfo.fiscalMonth - 1] || 'N/A';
            const year = proEditorInfo.fiscalYear;
            const orgAccount = proEditorInfo.treasuryAccount || institutionInfo.treasuryAccount || 'N/A';
            const orgKey = proEditorInfo.keyNumber || institutionInfo.treasuryKey || 'N/A';
            const totalAmount = proEditorData.reduce((sum, item) => sum + item.modifiedAmount, 0);
            const beneficiaryCount = proEditorData.length;
            const orderNum = proEditorInfo.orderNumber;
            const transferNum = proEditorInfo.transferNumber;

            const beneficiaryRows = proEditorData.filter(item => item.modifiedAmount > 0).map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.rip.substring(0, 18)} / ${item.rip.substring(18)}</td>
                    <td>${formatCurrency(item.modifiedAmount)}</td>
                </tr>
            `).join('');

            const reportHTML = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Etat de virement sur le CD-ROM (Pro)</title>
                    <style>
                        body { font-family: "Times New Roman", serif; margin: 40px; color: #000; }
                        h2 { text-align: center; text-decoration: underline; margin-bottom: 5px; }
                        .pro-badge { background: linear-gradient(135deg, #0d9488, #0f766e); color: #fff; padding: 3px 12px; border-radius: 5px; font-size: 11px; margin-right: 10px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .details { margin-bottom: 20px; line-height: 1.8; }
                        table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 10px; font-weight: bold; }
                        @media print {
                            body { margin: 20px; }
                            button { display: none; }
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    </style>
                </head>
                <body>
                    <h2><span class="pro-badge">PRO</span> Etat de virement sur le CD-ROM</h2>
                    <div class="header">
                        <strong>Mois :</strong> ${monthName} &nbsp;&nbsp;&nbsp;
                        <strong>Année :</strong> ${year}
                    </div>
                    <div class="details">
                        <strong>Numéro de compte de l'organisme :</strong> ${orgAccount} &nbsp;&nbsp; <strong>Clé :</strong> ${orgKey}<br>
                        <strong>Montant global de virement :</strong> ${formatCurrency(totalAmount)}<br>
                        <strong>L'Effectif :</strong> ${beneficiaryCount}<br>
                        <strong>Code Ordonnateur :</strong> ${orderNum}<br>
                        <strong>N° Mandat :</strong> ${transferNum}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>N</th>
                                <th>Nom et Prénom</th>
                                <th>Compte / Clé</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${beneficiaryRows}
                        </tbody>
                    </table>
                    <div class="footer">
                        Nombre de titres : ${beneficiaryCount} &nbsp;&nbsp;&nbsp; Montant global de détail : ${formatCurrency(totalAmount)}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() { window.close(); };
                        };
                    <\/script>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank', 'height=700,width=900,scrollbars=yes');
            if (printWindow) {
                printWindow.document.write(reportHTML);
                printWindow.document.close();
                SoundSystem.success();
            } else {
                showToast('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', 'error');
            }
        }


        // ============================================
        // ========== COMBINED COMPENSATIONS ===========
        // ============================================

        function getCombinedData() {
            const filters = {};
            document.querySelectorAll('.combined-filter-toggle').forEach(toggle => {
                const type = toggle.dataset.type;
                const checked = toggle.querySelector('input[type="checkbox"]').checked;
                filters[type] = checked;
            });

            let allRecords = [];
            const typeLabels = {
                electricity: { name: 'الكهرباء والغاز', icon: 'fa-bolt', cssClass: 'type-electricity' },
                equipment: { name: 'منحة التجهيز', icon: 'fa-chair', cssClass: 'type-equipment' },
                transport: { name: 'مصاريف التنقل', icon: 'fa-bus', cssClass: 'type-transport' },
                training: { name: 'العمليات التكوينية', icon: 'fa-chalkboard-teacher', cssClass: 'type-training' }
            };

            // Electricity
            if (filters.electricity) {
                compensations.forEach(comp => {
                    const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                    if (!b || (b.type && b.type !== 'electricity')) return;
                    const netPayable = parseFloat(comp.netPayable) || 0;
                    if (netPayable <= 0) return;
                    const rip = calculateRIP(b.account);
                    allRecords.push({
                        id: b.id, name: b.name, account: b.account,
                        rip: rip, amount: netPayable, type: 'electricity',
                        typeInfo: typeLabels.electricity
                    });
                });
            }

            // Equipment
            if (filters.equipment) {
                beneficiaries.filter(b => b.type === 'equipment').forEach(b => {
                    const comp = compensationsEquipment.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? (parseFloat(comp.netPayable) || 0) : (parseFloat(institutionInfo.equipmentGrantValue) || 0);
                    if (netPayable <= 0) return;
                    const rip = calculateRIP(b.account);
                    allRecords.push({
                        id: b.id, name: b.name, account: b.account,
                        rip: rip, amount: netPayable, type: 'equipment',
                        typeInfo: typeLabels.equipment
                    });
                });
            }

            // Transport
            if (filters.transport) {
                beneficiaries.filter(b => b.type === 'transport').forEach(b => {
                    const comp = compensationsTransport.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? (parseFloat(comp.netPayable) || 0) : 0;
                    if (netPayable <= 0) return;
                    const rip = calculateRIP(b.account);
                    allRecords.push({
                        id: b.id, name: b.name, account: b.account,
                        rip: rip, amount: netPayable, type: 'transport',
                        typeInfo: typeLabels.transport
                    });
                });
            }

            // Training
            if (filters.training) {
                beneficiaries.filter(b => b.type === 'training').forEach(b => {
                    const comp = compensationsTraining.find(c => c.beneficiaryId === b.id);
                    const netPayable = comp ? (parseFloat(comp.netPayable) || 0) : 0;
                    if (netPayable <= 0) return;
                    const rip = calculateRIP(b.account);
                    allRecords.push({
                        id: b.id, name: b.name, account: b.account,
                        rip: rip, amount: netPayable, type: 'training',
                        typeInfo: typeLabels.training
                    });
                });
            }

            // Merge duplicates: same person (same account) gets amounts summed
            const merged = {};
            allRecords.forEach(rec => {
                const key = rec.account;
                if (merged[key]) {
                    merged[key].amount += rec.amount;
                    if (!merged[key].types.includes(rec.type)) {
                        merged[key].types.push(rec.type);
                        merged[key].typeInfos.push(rec.typeInfo);
                    }
                    // Track per-type amounts
                    merged[key].amountByType[rec.type] = (merged[key].amountByType[rec.type] || 0) + rec.amount;
                } else {
                    const amountByType = {};
                    amountByType[rec.type] = rec.amount;
                    merged[key] = {
                        ...rec,
                        types: [rec.type],
                        typeInfos: [rec.typeInfo],
                        amountByType: amountByType
                    };
                }
            });

            return Object.values(merged);
        }

        function combinedFilterChanged() {
            document.querySelectorAll('.combined-filter-toggle').forEach(toggle => {
                const checked = toggle.querySelector('input[type="checkbox"]').checked;
                toggle.classList.toggle('active', checked);
            });
            renderCombinedTable();
        }

        function renderCombinedTable() {
            const data = getCombinedData();
            const searchTerm = (document.getElementById('combined-search-input')?.value || '').trim().toLowerCase();

            const filtered = searchTerm
                ? data.filter(r => r.name.toLowerCase().includes(searchTerm) || r.account.includes(searchTerm))
                : data;

            const tbody = document.getElementById('combined-tbody');
            const emptyState = document.getElementById('combined-empty-state');
            const table = document.getElementById('combined-table');

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                if (table) table.style.display = 'none';
            } else {
                if (emptyState) emptyState.style.display = 'none';
                if (table) table.style.display = 'table';

                tbody.innerHTML = filtered.map((rec, idx) => {
                    const typeBadges = rec.typeInfos.map(ti =>
                        `<span class="combined-type-badge ${ti.cssClass}"><i class="fas ${ti.icon}"></i> ${ti.name}</span>`
                    ).join(' ');

                    return `<tr>
                        <td>${idx + 1}</td>
                        <td style="text-align: right; padding-right: 12px; font-weight: 500;">${rec.name}</td>
                        <td>${rec.account}</td>
                        <td><span class="combined-rip-cell">${rec.rip}</span></td>
                        <td style="font-weight: 600;">${formatCurrency(rec.amount)}</td>
                        <td>${typeBadges}</td>
                    </tr>`;
                }).join('');
            }

            // Update summary
            const totalAmount = filtered.reduce((s, r) => s + r.amount, 0);
            const activeTypes = new Set();
            filtered.forEach(r => r.types.forEach(t => activeTypes.add(t)));

            document.getElementById('combined-count').textContent = filtered.length;
            document.getElementById('combined-total').textContent = formatCurrency(totalAmount);
            document.getElementById('combined-types-count').textContent = activeTypes.size;
            document.getElementById('combined-footer-total').textContent = formatCurrency(totalAmount);
        }

        function combinedExportTxt() {
            const data = getCombinedData();
            if (data.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'error');
                return;
            }

            // Filter valid records
            let validRecords = [];
            let totalAmount = 0;

            data.forEach(item => {
                if (item.amount > 0 && !item.rip.includes('خطأ') && item.rip.length === 20) {
                    const amountCents = String(Math.round(item.amount * 100)).padStart(13, '0');
                    const namePadded = (item.name + ' '.repeat(27)).substring(0, 27);
                    validRecords.push(`*${item.rip}${amountCents}${namePadded}1`);
                    totalAmount += item.amount;
                }
            });

            if (validRecords.length === 0) {
                showToast('لا توجد سجلات صالحة للتصدير (تأكد من صحة أرقام الحسابات)', 'error');
                return;
            }

            // Read from combined section local fields
            const treasuryAccount = document.getElementById('combined-treasury-account').value.trim() || institutionInfo.treasuryAccount;
            const treasuryRIP = calculateRIP(treasuryAccount);

            if (!treasuryRIP || treasuryRIP.includes('خطأ') || treasuryRIP.length < 20) {
                showToast('خطأ: رقم حساب الخزينة غير صحيح. يرجى التحقق من الحقل في هذا التبويب.', 'error');
                return;
            }

            const month = String(document.getElementById('combined-fiscal-month').value || 1).padStart(2, '0');
            const year = String(document.getElementById('combined-fiscal-year').value || new Date().getFullYear()).padStart(4, '0');
            const order = String(document.getElementById('combined-order-number').value || 0).padStart(8, '0');
            const transfer = String(document.getElementById('combined-transfer-number').value || 0).padStart(6, '0');
            const totalAmountCents = String(Math.round(totalAmount * 100)).padStart(13, '0');
            const recordCount = String(validRecords.length).padStart(7, '0');

            const header = `*${treasuryRIP}${totalAmountCents}${recordCount}${month}${year}${order}${transfer}0`;
            const fileContent = header + '\n' + validRecords.join('\n');

            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Combined_Payment_${year}_${month}_${new Date().toLocaleDateString('ar-SA')}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            if (typeof SoundSystem !== 'undefined') SoundSystem.export();
            showToast(`تم تصدير الملف بنجاح: ${validRecords.length} سجل - المجموع: ${formatCurrency(totalAmount)} دج`, 'success');
        }

        function combinedPrintCDRom() {
            const data = getCombinedData().filter(item => item.amount > 0 && !item.rip.includes('خطأ'));
            if (data.length === 0) {
                showToast('لا توجد بيانات للطباعة', 'error');
                return;
            }

            const months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            // Read from combined section local fields
            const monthNum = parseInt(document.getElementById('combined-fiscal-month').value) || 1;
            const monthName = months[monthNum - 1] || 'N/A';
            const year = document.getElementById('combined-fiscal-year').value || new Date().getFullYear();
            const orgAccount = document.getElementById('combined-treasury-account').value.trim() || institutionInfo.treasuryAccount || 'N/A';
            const orgRIP = calculateRIP(orgAccount);
            const orgKey = (orgRIP && orgRIP.length === 20) ? orgRIP.substring(18) : (institutionInfo.treasuryKey || 'N/A');
            const totalAmount = data.reduce((sum, item) => sum + item.amount, 0);
            const beneficiaryCount = data.length;
            const orderNum = document.getElementById('combined-order-number').value || 'N/A';
            const transferNum = document.getElementById('combined-transfer-number').value || 'N/A';

            const typeNamesMap = {
                electricity: 'Électricité & Gaz',
                equipment: 'Prime d\'équipement',
                transport: 'Frais de transport',
                training: 'Frais de formation'
            };

            const beneficiaryRows = data.map((item, index) => {
                const typeNames = item.types.map(t => typeNamesMap[t] || t).join(', ');
                return `<tr>
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.rip.substring(0, 18)} / ${item.rip.substring(18)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                </tr>`;
            }).join('');

            const reportHTML = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Etat de virement sur le CD-ROM (Combiné)</title>
    <style>
        body { font-family: "Times New Roman", serif; margin: 40px; color: #000; }
        h2 { text-align: center; text-decoration: underline; margin-bottom: 5px; }
        .badge { background: linear-gradient(135deg, #d4a373, #b38b5d); color: #fff; padding: 3px 12px; border-radius: 5px; font-size: 11px; margin-right: 10px; }
        .header { text-align: center; margin-bottom: 20px; }
        .details { margin-bottom: 20px; line-height: 1.8; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #000; padding: 5px; text-align: center; }
        th { background-color: #f2f2f2; }
        .footer { margin-top: 10px; font-weight: bold; }
        @media print {
            body { margin: 20px; }
            button { display: none; }
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    </style>
</head>
<body>
    <h2><span class="badge">COMBINÉ</span> Etat de virement sur le CD-ROM</h2>
    <div class="header">
        <strong>Mois :</strong> ${monthName} &nbsp;&nbsp;&nbsp;
        <strong>Année :</strong> ${year}
    </div>
    <div class="details">
        <strong>Numéro de compte de l'organisme :</strong> ${orgAccount} &nbsp;&nbsp; <strong>Clé :</strong> ${orgKey}<br>
        <strong>Montant global de virement :</strong> ${formatCurrency(totalAmount)}<br>
        <strong>L'Effectif :</strong> ${beneficiaryCount}<br>
        <strong>Code Ordonnateur :</strong> ${orderNum}<br>
        <strong>N° Mandat :</strong> ${transferNum}
    </div>
    <table>
        <thead>
            <tr>
                <th>N</th>
                <th>Nom et Prénom</th>
                <th>Compte / Clé</th>
                <th>Montant</th>
            </tr>
        </thead>
        <tbody>
            ${beneficiaryRows}
        </tbody>
    </table>
    <div class="footer">
        Nombre de titres : ${beneficiaryCount} &nbsp;&nbsp;&nbsp; Montant global de détail : ${formatCurrency(totalAmount)}
    </div>
    <script>
        window.onload = function() {
            window.print();
            window.onafterprint = function() { window.close(); };
        };
    <\/script>
</body>
</html>`;

            const printWindow = window.open('', '_blank', 'height=700,width=950,scrollbars=yes');
            if (printWindow) {
                printWindow.document.write(reportHTML);
                printWindow.document.close();
                if (typeof SoundSystem !== 'undefined') SoundSystem.success();
            } else {
                showToast('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', 'error');
            }
        }

        function combinedDetailedReport() {
            const data = getCombinedData();
            if (data.length === 0) {
                showToast('لا توجد بيانات لعرض التقرير', 'error');
                return;
            }

            const tbody = document.getElementById('combined-detailed-tbody');
            let totalElec = 0, totalEquip = 0, totalTrans = 0, totalTrain = 0, grandTotal = 0;

            tbody.innerHTML = data.map((rec, idx) => {
                const elec = rec.amountByType?.electricity || 0;
                const equip = rec.amountByType?.equipment || 0;
                const trans = rec.amountByType?.transport || 0;
                const train = rec.amountByType?.training || 0;
                const total = elec + equip + trans + train;
                totalElec += elec; totalEquip += equip; totalTrans += trans; totalTrain += train; grandTotal += total;

                return `<tr>
                    <td>${idx + 1}</td>
                    <td style="text-align: right; padding-right: 10px; font-weight: 500;">${rec.name}</td>
                    <td><span class="combined-rip-cell">${rec.rip}</span></td>
                    <td style="color: ${elec > 0 ? 'var(--gold-light)' : 'var(--text-muted)'};">${elec > 0 ? formatCurrency(elec) : '-'}</td>
                    <td style="color: ${equip > 0 ? 'var(--accent-teal)' : 'var(--text-muted)'};">${equip > 0 ? formatCurrency(equip) : '-'}</td>
                    <td style="color: ${trans > 0 ? 'var(--accent-blue)' : 'var(--text-muted)'};">${trans > 0 ? formatCurrency(trans) : '-'}</td>
                    <td style="color: ${train > 0 ? 'var(--accent-purple)' : 'var(--text-muted)'};">${train > 0 ? formatCurrency(train) : '-'}</td>
                    <td style="font-weight: 700; color: var(--gold-light);">${formatCurrency(total)}</td>
                </tr>`;
            }).join('');

            document.getElementById('combined-detail-elec-total').textContent = formatCurrency(totalElec);
            document.getElementById('combined-detail-equip-total').textContent = formatCurrency(totalEquip);
            document.getElementById('combined-detail-trans-total').textContent = formatCurrency(totalTrans);
            document.getElementById('combined-detail-train-total').textContent = formatCurrency(totalTrain);
            document.getElementById('combined-detail-grand-total').textContent = formatCurrency(grandTotal);

            document.getElementById('combined-report-preview').style.display = 'block';
            document.getElementById('combined-report-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function combinedPrintDetailedReport() {
            const data = getCombinedData();
            if (data.length === 0) {
                showToast('لا توجد بيانات للطباعة', 'error');
                return;
            }

            const year = document.getElementById('combined-fiscal-year').value || new Date().getFullYear();
            const monthVal = parseInt(document.getElementById('combined-fiscal-month').value) || 1;
            const months = ["جانفي","فيفري","مارس","أفريل","ماي","جوان","جويلية","أوت","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
            const monthName = months[monthVal - 1] || '';
            const orderNum = document.getElementById('combined-order-number').value || '-';
            const transferNum = document.getElementById('combined-transfer-number').value || '-';
            const orgName = institutionInfo.institutionName || '-';

            let totalElec = 0, totalEquip = 0, totalTrans = 0, totalTrain = 0, grandTotal = 0;

            const rows = data.map((rec, idx) => {
                const elec = rec.amountByType?.electricity || 0;
                const equip = rec.amountByType?.equipment || 0;
                const trans = rec.amountByType?.transport || 0;
                const train = rec.amountByType?.training || 0;
                const total = elec + equip + trans + train;
                totalElec += elec; totalEquip += equip; totalTrans += trans; totalTrain += train; grandTotal += total;

                return `<tr>
                    <td>${idx + 1}</td>
                    <td style="text-align: right; padding-right: 6px;">${rec.name}</td>
                    <td style="font-size: 8pt; letter-spacing: 0.5px;">${rec.rip}</td>
                    <td>${elec > 0 ? formatCurrency(elec) : '-'}</td>
                    <td>${equip > 0 ? formatCurrency(equip) : '-'}</td>
                    <td>${trans > 0 ? formatCurrency(trans) : '-'}</td>
                    <td>${train > 0 ? formatCurrency(train) : '-'}</td>
                    <td style="font-weight: bold;">${formatCurrency(total)}</td>
                </tr>`;
            }).join('');

            const html = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقرير مفصل للتعويضات المتعددة</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&display=swap');
        body { font-family: 'Amiri', serif; margin: 30px; color: #000; direction: rtl; }
        .report-header { text-align: center; margin-bottom: 10px; }
        .report-header p { font-weight: bold; margin: 2px 0; font-family: 'Aref Ruqaa', 'Amiri', serif; font-size: 15pt; }
        .report-header h3 { margin-top: 10px; margin-bottom: 10px; font-weight: bold; font-family: 'Aref Ruqaa', 'Amiri', serif; font-size: 20pt; text-decoration: underline; }
        table { width: 100%; border-collapse: collapse; font-size: 9pt; }
        th, td { border: 1px solid #000; padding: 5px 4px; text-align: center; }
        th { background: #e8e0d0; font-weight: bold; font-size: 8.5pt; }
        .total-row td { background: #f0ebe0; font-weight: bold; border-top: 2px solid #000; }
        .report-footer { text-align: right; margin-top: 10px; }
        .report-footer p { margin: 3px 0; }
        .signatures { display: flex; justify-content: space-around; margin-top: 15px; }
        .signatures p { font-family: 'Aref Ruqaa', 'Amiri', serif; font-weight: bold; font-size: 16pt; }
        @media print {
            body { margin: 15px; }
            button { display: none; }
            @page { size: landscape; margin: 1cm; }
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    </style>
</head>
<body>
    <div class="report-header">
        <p>${institutionInfo.republic}</p>
        <p>${institutionInfo.ministry}</p>
        <p>${institutionInfo.directorate}</p>
        <p>${institutionInfo.institution}</p>
        <p>السنة المالية: ${institutionInfo.fiscalYear}</p>
        <h3>الجدول التفصيلي للتعويضات المتعددة والمختلفة</h3>
    </div>
    <table>
        <thead>
            <tr>
                <th style="width:30px;">الرقم</th>
                <th style="min-width:140px;">اللقب والاسم</th>
                <th style="min-width:130px;">RIP</th>
                <th>الكهرباء والغاز</th>
                <th>منحة التجهيز</th>
                <th>مصاريف التنقل</th>
                <th>العمليات التكوينية</th>
                <th>الإجمالي</th>
            </tr>
        </thead>
        <tbody>
            ${rows}
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="3" style="text-align: right; padding-right: 10px;">المجموع الكلي</td>
                <td>${formatCurrency(totalElec)}</td>
                <td>${formatCurrency(totalEquip)}</td>
                <td>${formatCurrency(totalTrans)}</td>
                <td>${formatCurrency(totalTrain)}</td>
                <td>${formatCurrency(grandTotal)}</td>
            </tr>
        </tfoot>
    </table>
    <div class="report-footer">
        <p>أوقف الجدول على مجموع مستفيدين قدره: ${data.length}</p>
        <p>أوقف الجدول على مجموع كلي بالأرقام: ${formatCurrency(grandTotal)} دج</p>
        <p>أوقف الجدول على مجموع كلي بالأحرف: ${numberToArabicText(grandTotal)}</p>
        <div class="signatures">
            <p>المدير</p>
            <p>المسير المالي</p>
        </div>
    </div>
    <script>
        window.onload = function() {
            window.print();
            window.onafterprint = function() { window.close(); };
        };
    <\/script>
</body>
</html>`;

            const printWindow = window.open('', '_blank', 'height=700,width=1100,scrollbars=yes');
            if (printWindow) {
                printWindow.document.write(html);
                printWindow.document.close();
                if (typeof SoundSystem !== 'undefined') SoundSystem.success();
            } else {
                showToast('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', 'error');
            }
        }


        // --- Import from TXT ---
        let importedTxtData = [];

        function openImportTxtModal() {
            document.getElementById('import-txt-input').click();
        }

        function handleTxtFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                showImportTxtModal(content);
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = ''; // Reset for selecting same file again
        }

        function showImportTxtModal(content) {
            const modal = document.getElementById('import-txt-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
            
            // Store content for later processing
            modal.dataset.content = content;
            
            // Add event listener for format change
            const formatRadios = document.querySelectorAll('input[name="import-format"]');
            formatRadios.forEach(radio => {
                radio.addEventListener('change', () => parseAndPreviewTxt(content));
            });
            
            document.getElementById('import-has-header').addEventListener('change', () => parseAndPreviewTxt(content));
            
            // Initial parse
            parseAndPreviewTxt(content);
        }
        
        function parseAndPreviewTxt(content) {
            const format = document.querySelector('input[name="import-format"]:checked').value;
            const hasHeader = document.getElementById('import-has-header').checked;
            const headerOptionContainer = document.getElementById('header-option-container');
            
            // Hide/show header option based on format
            if (format === 'payment-file') {
                headerOptionContainer.style.display = 'none';
            } else {
                headerOptionContainer.style.display = 'block';
            }
            
            const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
            importedTxtData = [];
            
            // Parse based on format
            if (format === 'payment-file') {
                // Parse Algérie Poste payment file format
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Skip if line doesn't start with * or is too short
                    if (!line.startsWith('*') || line.length < 35) continue;
                    
                    // Skip header line (contains treasury RIP - check if position 21-33 is all zeros for header)
                    // Header has specific format: *[RIP 20][Amount 13][Count 7][Month 2][Year 4][Order 8][Transfer 6][0]
                    // Beneficiary line: *[RIP 20][Amount 13][Name 30][1]
                    
                    // Check if this is a beneficiary line by checking line length and format
                    // Beneficiary lines are exactly 65 characters (or close) and end with "1"
                    const trimmedLine = line.trim();
                    
                    // Try to extract beneficiary data
                    // RIP: positions 1-20 (after *)
                    // Amount: positions 21-33 (13 digits)
                    // Name: positions 34-63 (30 characters)
                    // Code: position 64 (should be "1" for beneficiary)
                    
                    if (trimmedLine.length >= 34) {
                        const rip = trimmedLine.substring(1, 21);
                        const amountCentimes = trimmedLine.substring(21, 34);
                        const nameAndCode = trimmedLine.substring(34);
                        
                        // Check if this looks like a beneficiary line (has name with letters)
                        if (/[a-zA-Z]/.test(nameAndCode)) {
                            // Extract account number from RIP (positions 9-18 are the account)
                            // RIP format: 00799999 + XXXXXXXXXX (account 10 digits) + KK (RIP key 2 digits)
                            // Note: RIP key ≠ CCP key, so we only extract the account number
                            const accountNumberPadded = rip.substring(8, 18);
                            const accountNumber = accountNumberPadded.replace(/^0+/, ''); // Remove leading zeros
                            
                            // Extract name (remove trailing spaces and the "1" at the end)
                            let name = nameAndCode.replace(/\s*1?\s*$/, '').trim();
                            
                            // Calculate amount in DA
                            const amountDA = parseInt(amountCentimes, 10) / 100;
                            
                            if (accountNumber && name) {
                                importedTxtData.push({
                                    name: name,
                                    account: accountNumber, // Just the account number, RIP will be calculated automatically
                                    meter: '',
                                    section: '',
                                    rank: '',
                                    amount: amountDA // Store amount for reference
                                });
                            }
                        }
                    }
                }
            } else {
                // Parse CSV-style formats
                let separator;
                switch(format) {
                    case 'semicolon': separator = ';'; break;
                    case 'comma': separator = ','; break;
                    case 'tab': separator = '\t'; break;
                    case 'pipe': separator = '|'; break;
                    default: separator = ';';
                }
                
                const startIndex = hasHeader ? 1 : 0;
                
                for (let i = startIndex; i < lines.length; i++) {
                    const parts = lines[i].split(separator).map(p => p.trim());
                    if (parts.length >= 2 && parts[0] && parts[1]) {
                        importedTxtData.push({
                            name: parts[0] || '',
                            account: parts[1] || '',
                            meter: parts[2] || '',
                            section: parts[3] || '',
                            rank: parts[4] || ''
                        });
                    }
                }
            }
            
            // Show preview
            const previewDiv = document.getElementById('import-preview');
            const previewTable = document.getElementById('import-preview-table');
            const importCount = document.getElementById('import-count');
            const confirmBtn = document.getElementById('confirm-import-txt');
            
            if (importedTxtData.length > 0) {
                previewDiv.style.display = 'block';
                confirmBtn.style.display = 'inline-flex';
                importCount.textContent = importedTxtData.length;
                
                // Build preview table with checkboxes (show all rows)
                const showAmount = format === 'payment-file';
                
                previewTable.innerHTML = `
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="import-select-all-checkbox" checked onchange="selectAllImport(this.checked)"></th>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>رقم الحساب</th>
                            ${showAmount ? '<th>المبلغ (دج)</th>' : '<th>رقم العداد</th>'}
                            <th>القسم</th>
                            <th>الرتبة</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${importedTxtData.map((row, idx) => `
                            <tr>
                                <td><input type="checkbox" class="import-row-checkbox" data-index="${idx}" checked onchange="updateImportSelectionCount()"></td>
                                <td>${idx + 1}</td>
                                <td>${row.name}</td>
                                <td style="direction: ltr; text-align: center;">${row.account}</td>
                                ${showAmount ? `<td>${formatCurrency(row.amount || 0)}</td>` : `<td>${row.meter}</td>`}
                                <td>${row.section}</td>
                                <td>${row.rank}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
                // Update selection count
                updateImportSelectionCount();
            } else {
                previewDiv.style.display = 'none';
                confirmBtn.style.display = 'none';
                showToast('لم يتم العثور على بيانات صالحة. تحقق من تنسيق الملف', 'error');
            }
        }
        
        function cancelImportTxt() {
            const modal = document.getElementById('import-txt-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                importedTxtData = [];
                document.getElementById('import-preview').style.display = 'none';
                document.getElementById('confirm-import-txt').style.display = 'none';
            }, 300);
        }
        
        function selectAllImport(select) {
            const checkboxes = document.querySelectorAll('.import-row-checkbox');
            const selectAllCheckbox = document.getElementById('import-select-all-checkbox');
            checkboxes.forEach(cb => cb.checked = select);
            if (selectAllCheckbox) selectAllCheckbox.checked = select;
            updateImportSelectionCount();
        }
        
        function updateImportSelectionCount() {
            const checkboxes = document.querySelectorAll('.import-row-checkbox');
            const selectedCount = document.querySelectorAll('.import-row-checkbox:checked').length;
            const selectedCountEl = document.getElementById('import-selected-count');
            const selectAllCheckbox = document.getElementById('import-select-all-checkbox');
            
            if (selectedCountEl) selectedCountEl.textContent = selectedCount;
            if (selectAllCheckbox) selectAllCheckbox.checked = selectedCount === checkboxes.length;
        }
        
        function getSelectedImportIndices() {
            const checkboxes = document.querySelectorAll('.import-row-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
        }
        
        function confirmImportTxt() {
            const selectedIndices = getSelectedImportIndices();
            
            if (selectedIndices.length === 0) {
                showToast('يرجى تحديد مستفيد واحد على الأقل للاستيراد', 'error');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من استيراد ${selectedIndices.length} مستفيد إلى نوع التعويض الحالي (${getModeLabel(currentMode)})؟`)) {
                return;
            }
            
            let importedCount = 0;
            let skippedCount = 0;
            let invalidCount = 0;
            let nextId = getNextBeneficiaryId();
            
            // Get only selected rows
            const selectedData = selectedIndices.map(idx => importedTxtData[idx]);
            
            selectedData.forEach(row => {
                // Validate name (Latin characters only)
                if (!/^[a-zA-Z\s\-]+$/.test(row.name)) {
                    invalidCount++;
                    return;
                }
                
                // Check for duplicate account in same compensation type
                if (beneficiaries.some(b => b.account === row.account && (b.type === currentMode || (!b.type && currentMode === 'electricity')))) {
                    skippedCount++;
                    return;
                }
                
                // Validate account (RIP)
                const rip = calculateRIP(row.account);
                if (rip.includes('خطأ')) {
                    invalidCount++;
                    return;
                }
                
                // Add beneficiary
                beneficiaries.push({
                    id: nextId++,
                    name: row.name,
                    account: row.account,
                    meter: row.meter,
                    section: row.section,
                    rank: row.rank,
                    type: currentMode
                });
                importedCount++;
            });
            
            // Save and update UI
            saveData();
            renderCompensationGrid();
            updateCreditDisplay();
            
            // Close modal
            cancelImportTxt();
            
            // تشغيل صوت الاستيراد
            if (importedCount > 0) SoundSystem.import();
            
            // Show result message
            let message = `تم استيراد ${importedCount} مستفيد بنجاح`;
            if (skippedCount > 0) message += `\nتم تخطي ${skippedCount} (حساب مكرر)`;
            if (invalidCount > 0) message += `\nتم رفض ${invalidCount} (بيانات غير صالحة)`;
            
            showToast(message, importedCount > 0 ? 'success' : 'error');
            
            // Check achievements
            checkAchievements();
        }
        
        function getModeLabel(mode) {
            switch(mode) {
                case 'electricity': return 'كهرباء وغاز';
                case 'equipment': return 'منحة تجهيز';
                case 'transport': return 'تنقل';
                case 'training': return 'تكوين';
                default: return mode;
            }
        }

        // --- Backup and Restore ---
        function createBackup() {
            try {
                const backupData = { 
                    institutionInfo, 
                    beneficiaries, 
                    compensations, 
                    compensationsEquipment,
                    compensationsTransport,
                    compensationsTraining,
                    backupVersion: '2.0',
                    backupDate: new Date().toISOString()
                };
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const now = new Date();
                const filename = `CompData_Backup_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}.json`;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                showToast(`تم إنشاء النسخة الاحتياطية: ${filename}`, 'success');
            } catch (e) {
                console.error('Backup error:', e);
                showToast('خطأ في إنشاء النسخة الاحتياطية', 'error');
            }
        }

        function createAutoBackup(reason = 'قبل_الحذف') {
            try {
                const backupData = { 
                    institutionInfo, 
                    beneficiaries, 
                    compensations, 
                    compensationsEquipment,
                    compensationsTransport,
                    compensationsTraining,
                    backupVersion: '2.0',
                    backupDate: new Date().toISOString(),
                    reason: reason
                };
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const now = new Date();
                const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;
                const filename = `نسخة_تلقائية_${reason}_${timestamp}.json`;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                return filename;
            } catch (e) {
                console.error('Auto backup error:', e);
                throw e;
            }
        }

        function deleteAllBeneficiaries() {
            if (beneficiaries.length === 0) {
                showToast('لا يوجد مستفيدون للحذف', 'info');
                return;
            }

            const message = `⚠️ تحذير: سيتم حذف جميع المستفيدين (${beneficiaries.length} مستفيد) وجميع التعويضات المرتبطة بهم.\n\n` +
                          `سيتم حفظ نسخة احتياطية تلقائية قبل الحذف.\n\n` +
                          `هل أنت متأكد من المتابعة؟`;
            
            if (!confirm(message)) {
                return;
            }

            // حفظ نسخة احتياطية تلقائية
            try {
                const filename = createAutoBackup('قبل_حذف_جميع_المستفيدين');
                showToast(`تم حفظ نسخة احتياطية: ${filename}`, 'success');
            } catch (error) {
                console.error('Auto backup failed:', error);
                showToast('فشل إنشاء النسخة الاحتياطية. لن يتم الحذف', 'error');
                return;
            }

            // التأكيد النهائي
            if (!confirm('تم حفظ النسخة الاحتياطية. هل تريد المتابعة في حذف جميع المستفيدين؟')) {
                return;
            }

            // حذف جميع البيانات
            const deletedCount = beneficiaries.length;
            beneficiaries.length = 0;
            compensations.length = 0;
            compensationsEquipment.length = 0;
            compensationsTransport.length = 0;
            compensationsTraining.length = 0;

            // حفظ التغييرات
            saveData();

            // تحديث الواجهة
            renderCompensationGrid();
            updateCreditDisplay();

            showToast(`✓ تم حذف ${deletedCount} مستفيد بنجاح. النسخة الاحتياطية محفوظة`, 'success');
        }

        function restoreBackup() {
            document.getElementById('restore-file-input').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.json')) return alert('الرجاء اختيار ملف JSON صالح.');
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.institutionInfo && data.beneficiaries) {
                        tempBackupData = data;
                        showRestoreTypeModal();
                    } else { alert('ملف النسخة الاحتياطية غير صالح.'); }
                } catch (err) { alert('خطأ في قراءة الملف.'); }
            };
            reader.readAsText(file);
            // إعادة تعيين input لتمكين اختيار نفس الملف مرة أخرى
            event.target.value = '';
        }

        function showRestoreTypeModal() {
            const modal = document.getElementById('restore-type-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function cancelRestoreType() {
            const modal = document.getElementById('restore-type-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                tempBackupData = null;
            }, 300);
        }

        function selectRestoreType(type) {
            if (!tempBackupData) return;
            
            if (type === 'full') {
                // استعادة كاملة
                if (confirm('هل أنت متأكد من استعادة جميع البيانات؟ سيتم الكتابة فوق البيانات الحالية بالكامل.')) {
                    restoreFullBackup(tempBackupData);
                }
                cancelRestoreType(); // إفراغ البيانات بعد الاستعادة الكاملة
            } else if (type === 'beneficiaries') {
                // استيراد المستفيدين فقط - لا نفرغ tempBackupData هنا
                // إغلاق نافذة اختيار النوع فقط
                const modal = document.getElementById('restore-type-modal');
                modal.classList.remove('visible');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                
                // عرض نافذة اختيار المستفيدين
                showBeneficiarySelectionModal(tempBackupData, currentMode);
            }
        }

        function restoreFullBackup(data) {
            localStorage.setItem('institutionInfo', JSON.stringify(data.institutionInfo));
            localStorage.setItem('beneficiaries', JSON.stringify(data.beneficiaries));
            localStorage.setItem('compensations', JSON.stringify(data.compensations || []));
            localStorage.setItem('compensationsEquipment', JSON.stringify(data.compensationsEquipment || []));
            localStorage.setItem('compensationsTransport', JSON.stringify(data.compensationsTransport || []));
            localStorage.setItem('compensationsTraining', JSON.stringify(data.compensationsTraining || []));
            location.reload();
        }

        function showBeneficiarySelectionModal(backupData, compensationType) {
            tempBackupData = backupData; // حفظ البيانات للاستخدام عند التأكيد
            const modal = document.getElementById('beneficiary-selection-modal');
            const list = document.getElementById('beneficiary-selection-list');
            
            if (!backupData.beneficiaries || backupData.beneficiaries.length === 0) {
                alert('لا يوجد مستفيدون في النسخة الاحتياطية.');
                tempBackupData = null;
                return;
            }
            
            // تصفية المستفيدين حسب نوع التعويض الحالي
            const filteredBeneficiaries = backupData.beneficiaries.filter(b => b.type === compensationType);
            
            if (filteredBeneficiaries.length === 0) {
                const typeLabel = compensationType === 'electricity' ? 'كهرباء وغاز' :
                                 compensationType === 'equipment' ? 'منحة تجهيز' :
                                 compensationType === 'transport' ? 'تنقل' : 'تكوين';
                alert(`لا يوجد مستفيدون من نوع ${typeLabel} في النسخة الاحتياطية.`);
                tempBackupData = null;
                return;
            }
            
            // إنشاء قائمة المستفيدين المصفاة
            list.innerHTML = filteredBeneficiaries.map(b => {
                const typeLabel = b.type === 'electricity' ? 'كهرباء وغاز' :
                                 b.type === 'equipment' ? 'منحة تجهيز' :
                                 b.type === 'transport' ? 'تنقل' :
                                 b.type === 'training' ? 'تكوين' : 'غير محدد';
                
                const originalIndex = backupData.beneficiaries.indexOf(b);
                return `
                    <div style="margin-bottom: 12px; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background: white;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" class="beneficiary-checkbox" value="${b.id}" data-beneficiary-index="${originalIndex}" style="width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: var(--dark-color);">${b.name}</div>
                                <div style="font-size: 0.9em; color: var(--text-secondary-color);">
                                    <span><i class="fas fa-credit-card"></i> ${b.account}</span>
                                    ${b.meter ? `<span style="margin-right: 15px;"><i class="fas fa-tachometer-alt"></i> ${b.meter}</span>` : ''}
                                    <span style="margin-right: 15px;"><i class="fas fa-tag"></i> ${typeLabel}</span>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
            
            // إعداد زر تحديد الكل
            const selectAllCheckbox = document.getElementById('select-all-beneficiaries');
            selectAllCheckbox.checked = false;
            selectAllCheckbox.onchange = function() {
                const checkboxes = list.querySelectorAll('.beneficiary-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
            };
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function cancelBeneficiarySelection() {
            const modal = document.getElementById('beneficiary-selection-modal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                tempBackupData = null;
            }, 300);
        }

        function confirmBeneficiarySelection() {
            console.log('confirmBeneficiarySelection called');
            console.log('tempBackupData:', tempBackupData);
            
            if (!tempBackupData) {
                console.log('No tempBackupData - returning');
                alert('خطأ: لا توجد بيانات احتياطية. الرجاء إعادة المحاولة.');
                return;
            }
            
            const selectedCheckboxes = document.querySelectorAll('.beneficiary-checkbox:checked');
            console.log('Selected checkboxes:', selectedCheckboxes.length);
            
            if (selectedCheckboxes.length === 0) {
                alert('الرجاء تحديد مستفيد واحد على الأقل.');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من استيراد بيانات ${selectedCheckboxes.length} مستفيد؟`)) {
                return;
            }
            
            // جمع المستفيدين المحددين
            const selectedBeneficiaries = [];
            const selectedBeneficiaryIds = [];
            
            selectedCheckboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.beneficiaryIndex);
                const originalBeneficiary = tempBackupData.beneficiaries[index];
                selectedBeneficiaries.push(originalBeneficiary);
                selectedBeneficiaryIds.push(originalBeneficiary.id);
            });
            
            // دمج المستفيدين الجدد مع الموجودين
            let importedCount = 0;
            let skippedCount = 0;
            let nextId = getNextBeneficiaryId();
            
            selectedBeneficiaries.forEach(backupBen => {
                // التحقق من عدم وجود نفس الحساب
                if (beneficiaries.some(b => b.account === backupBen.account)) {
                    skippedCount++;
                    return; // تخطي هذا المستفيد
                }
                
                // إنشاء معرف جديد
                const oldId = backupBen.id;
                const newBen = {
                    ...backupBen,
                    id: nextId++
                };
                
                beneficiaries.push(newBen);
                importedCount++;
                
                // استيراد التعويضات إن وجدت (اختياري)
                // يمكن التعليق على هذا الجزء إذا أردت استيراد معلومات المستفيدين فقط بدون تعويضات
                /*
                if (tempBackupData.compensations) {
                    const comp = tempBackupData.compensations.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensations.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                
                if (tempBackupData.compensationsEquipment) {
                    const comp = tempBackupData.compensationsEquipment.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensationsEquipment.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                
                if (tempBackupData.compensationsTransport) {
                    const comp = tempBackupData.compensationsTransport.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensationsTransport.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                
                if (tempBackupData.compensationsTraining) {
                    const comp = tempBackupData.compensationsTraining.find(c => c.beneficiaryId === oldId);
                    if (comp) {
                        compensationsTraining.push({ ...comp, beneficiaryId: newBen.id });
                    }
                }
                */
            });
            
            // حفظ البيانات
            saveData();
            
            // إغلاق المودال
            cancelBeneficiarySelection();
            
            // إعادة رسم الجدول
            renderCompensationGrid();
            updateCreditDisplay();
            
            // إظهار رسالة النتيجة
            console.log('Imported beneficiaries:', importedCount);
            console.log('Total beneficiaries now:', beneficiaries.length);
            console.log('Current mode:', currentMode);
            
            // تشغيل صوت الاستيراد
            if (importedCount > 0) SoundSystem.import();
            
            let message = `تم استيراد ${importedCount} مستفيد بنجاح إلى قائمة المستفيدين.`;
            if (skippedCount > 0) {
                message += ` تم تخطي ${skippedCount} مستفيد (حساب مكرر).`;
            }
            message += '\n\nالمستفيدون متاحون الآن في جدول إدارة التعويضات.';
            
            showToast(message, 'success');
            
            // تحديث القائمة لإظهار المستفيدين الجدد
            setTimeout(() => {
                renderCompensationGrid();
            }, 500);
        }
        // Helper: get current mode's compensation array
        function getCurrentCompensationsArray() {
            if (currentMode === 'electricity') return compensations;
            if (currentMode === 'equipment') return compensationsEquipment;
            if (currentMode === 'transport') return compensationsTransport;
            if (currentMode === 'training') return compensationsTraining;
            return compensations;
        }
 
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Don't show section yet, wait for mode selection
            // showSection('institution-info-section'); 
            // updateCreditDisplay();

            // Main forms
            document.getElementById('institution-info-form').addEventListener('submit', saveInstitutionInfo);
            document.getElementById('beneficiary-form').addEventListener('submit', saveBeneficiary);
            document.getElementById('restore-file-input').addEventListener('change', handleFileSelect);
            document.getElementById('delete-all-beneficiaries-btn').addEventListener('click', deleteAllBeneficiaries);
            
            // Import TXT
            document.getElementById('import-txt-btn').addEventListener('click', openImportTxtModal);
            document.getElementById('import-txt-input').addEventListener('change', handleTxtFileSelect);
            document.getElementById('confirm-import-txt').addEventListener('click', confirmImportTxt);
            
            // Scroll to Top Button
            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            const mainContentArea = document.querySelector('.main-content');
            
            if (scrollToTopBtn && mainContentArea) {
                // Track scroll position on main content
                mainContentArea.addEventListener('scroll', () => {
                    if (mainContentArea.scrollTop > 300) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                
                // Also track window scroll
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 300 || document.documentElement.scrollTop > 300) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                
                // Scroll to top action
                scrollToTopBtn.addEventListener('click', () => {
                    // Scroll main content area
                    mainContentArea.scrollTo({ top: 0, behavior: 'smooth' });
                    // Also scroll window
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    document.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            // Sidebar Toggle
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }
            
            // Mobile Menu Toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn && sidebar) {
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('mobile-open');
                });
                
                // Close sidebar when clicking outside
                document.addEventListener('click', (e) => {
                    if (sidebar.classList.contains('mobile-open') && 
                        !sidebar.contains(e.target) && 
                        !mobileMenuBtn.contains(e.target)) {
                        sidebar.classList.remove('mobile-open');
                    }
                });
            }
            
            // Sidebar Navigation
            document.querySelectorAll('.sidebar-nav .nav-item[data-section]').forEach(button => {
                button.addEventListener('click', () => {
                    showSection(button.dataset.section);
                    // Close mobile sidebar after selection
                    if (window.innerWidth <= 768 && sidebar) {
                        sidebar.classList.remove('mobile-open');
                    }
                });
            });

            // Initial tab visibility
            updateNavTabsVisibility();
            
            // Sound Toggle Button
            const soundToggleBtn = document.getElementById('sound-toggle-btn');
            if (soundToggleBtn) {
                const updateSoundIcon = () => {
                    const icon = soundToggleBtn.querySelector('i');
                    const text = soundToggleBtn.querySelector('span');
                    if (icon) {
                        icon.className = SoundSystem.enabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
                    }
                    if (text) {
                        text.textContent = SoundSystem.enabled ? 'الأصوات' : 'الأصوات (مغلقة)';
                    }
                    soundToggleBtn.title = SoundSystem.enabled ? 'الأصوات مفعلة' : 'الأصوات معطلة';
                };
                updateSoundIcon();
                
                soundToggleBtn.addEventListener('click', () => {
                    const enabled = SoundSystem.toggle();
                    updateSoundIcon();
                    if (enabled) {
                        SoundSystem.success();
                        showToast('تم تفعيل الأصوات', 'success');
                    } else {
                        showToast('تم تعطيل الأصوات', 'info');
                    }
                });
            }
            
            // Stats Button in Sidebar
            const statsBtn = document.getElementById('stats-btn');
            if (statsBtn) {
                statsBtn.addEventListener('click', () => {
                    const dashboard = document.getElementById('stats-dashboard');
                    if (dashboard) dashboard.classList.toggle('visible');
                });
            }
            
            // Quick Stats Update
            function updateQuickStats() {
                const currentData = getCurrentCompensationsArray();
                const quickCount = document.getElementById('quick-beneficiary-count');
                const quickTotal = document.getElementById('quick-total-compensation');
                if (quickCount) quickCount.textContent = currentData.length;
                if (quickTotal) {
                    const total = currentData.reduce((sum, c) => sum + (c.netPayable || 0), 0);
                    quickTotal.textContent = formatCurrency(total);
                }
            }
            // Call initially
            setTimeout(updateQuickStats, 1000);

            // Navigation - Dashboard Button (was mode switch)
            document.getElementById('switch-mode-btn').addEventListener('click', () => {
                showDashboard();
            });

            // Quarter toggle listeners - listen on checkbox change to avoid double-toggle
            document.querySelectorAll('.quarter-toggle input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    e.stopPropagation(); // prevent label click from re-triggering
                    const toggle = this.closest('.quarter-toggle');
                    const q = 'q' + toggle.dataset.quarter;
                    quarterEnabled[q] = this.checked;
                    toggle.classList.toggle('active', this.checked);
                    saveQuarterStates();
                    // Recalculate and re-render
                    renderCompensationGrid();
                    updateCreditDisplay();
                    showToast(this.checked ? 
                        'تم تفعيل الثلاثي ' + toggle.dataset.quarter :
                        'تم تعطيل الثلاثي ' + toggle.dataset.quarter + ' (البيانات محفوظة)', 
                        this.checked ? 'success' : 'warning');
                });
            });
            
            // Fullscreen exit button for compensation section
            const fullscreenExitBtn = document.getElementById('fullscreen-exit-btn');
            if (fullscreenExitBtn) {
                // Show/hide exit button when compensation section is active
                const observer = new MutationObserver(() => {
                    const compSection = document.getElementById('compensation-management-section');
                    if (compSection && compSection.classList.contains('active')) {
                        fullscreenExitBtn.classList.add('visible');
                    } else {
                        fullscreenExitBtn.classList.remove('visible');
                    }
                });
                const compSection = document.getElementById('compensation-management-section');
                if (compSection) {
                    observer.observe(compSection, { attributes: true, attributeFilter: ['class'] });
                }
                
                fullscreenExitBtn.addEventListener('click', () => {
                    showSection('dashboard-section');
                });
            }
            
            // Report/Backup buttons (use onclick in HTML, safe if elements don't exist)
            const printBtn = document.getElementById('print-report-btn');
            const exportXlsx = document.getElementById('export-xlsx-btn');
            const exportTxtBtn = document.getElementById('export-txt-btn');
            const printCdrom = document.getElementById('print-cdrom-btn');
            const createBackupBtn = document.getElementById('create-backup-btn');
            const restoreBackupBtn = document.getElementById('restore-backup-btn');
            if (printBtn) printBtn.addEventListener('click', printReport);
            if (exportXlsx) exportXlsx.addEventListener('click', exportXLSX);
            if (exportTxtBtn) exportTxtBtn.addEventListener('click', exportTxt);
            if (printCdrom) printCdrom.addEventListener('click', printCDRomReport);
            if (createBackupBtn) createBackupBtn.addEventListener('click', createBackup);
            if (restoreBackupBtn) restoreBackupBtn.addEventListener('click', restoreBackup);
            // Modals
            document.getElementById('cancel-beneficiary-btn').addEventListener('click', cancelBeneficiaryEdit);
            document.getElementById('cancel-quarterly-btn').addEventListener('click', closeQuarterlyModal);
            
            // Compensation Grid Listeners
            document.getElementById('add-beneficiary-btn').addEventListener('click', () => openBeneficiaryModal());
            document.getElementById('compensation-grid-search').addEventListener('input', e => renderCompensationGrid(e.target.value));
            document.getElementById('quarterly-details-form').addEventListener('submit', handleQuarterlyFormSubmit);

            // Event delegation for the compensation grid
            const gridBody = document.querySelector('#compensation-grid-table tbody');
            gridBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (!row || !row.dataset.beneficiaryId) return;
                const beneficiaryId = parseInt(row.dataset.beneficiaryId);

                if (e.target.closest('.edit-btn-inline')) {
                    openBeneficiaryModal(beneficiaryId);
                } else if (e.target.closest('.delete-btn-inline')) {
                    deleteBeneficiary(beneficiaryId);
                } else if (e.target.closest('.editable-cell')) {
                    const quarterIndex = parseInt(e.target.closest('.editable-cell').dataset.quarter);
                    openQuarterlyModal(beneficiaryId, quarterIndex);
                } else if (e.target.closest('.save-equipment-btn') || e.target.closest('.save-manual-btn')) {
                    processAndSaveRow(row);
                }
            });
            gridBody.addEventListener('change', (e) => {
                // Skip batch checkbox changes
                if (e.target.classList.contains('batch-checkbox') || e.target.id === 'batch-select-all') return;
                const row = e.target.closest('tr');
                if (!row) return;
                
                // الحفظ التلقائي مفعل دائماً
                processAndSaveRow(row);
            });
            
            // Initialize Creative Features
            initCreativeFeatures();
        });

        // ============================================
        // ========== CREATIVE FEATURES JS ===========
        // ============================================

        // --- Live Clock ---
        function updateLiveClock() {
            const now = new Date();
            const timeElement = document.getElementById('live-time');
            const dateElement = document.getElementById('live-date');
            
            if (timeElement && dateElement) {
                // Time format
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}:${seconds}`;
                
                // Arabic date
                const arabicDays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                const arabicMonths = ['جانفي', 'فيفري', 'مارس', 'أفريل', 'ماي', 'جوان', 
                                      'جويلية', 'أوت', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                
                dateElement.textContent = `${arabicDays[now.getDay()]} ${now.getDate()} ${arabicMonths[now.getMonth()]} ${now.getFullYear()}`;
            }
        }

        // --- Particle Animation ---
        function initParticles() {
            const canvas = document.getElementById('particles-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const particleCount = 50;
            
            class Particle {
                constructor() {
                    this.reset();
                }
                
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height + Math.random() * 100;
                    this.size = Math.random() * 5 + 2;
                    this.speedY = Math.random() * 1.5 + 0.5;
                    this.speedX = (Math.random() - 0.5) * 0.8;
                    this.opacity = Math.random() * 0.4 + 0.2;
                    // Honey glass theme colors
                    const colors = ['#f59e0b', '#fbbf24', '#d97706', '#b45309', '#d4953a'];
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                }
                
                update() {
                    this.y -= this.speedY;
                    this.x += this.speedX;
                    this.opacity -= 0.002;
                    
                    if (this.y < -10 || this.opacity <= 0) {
                        this.reset();
                    }
                }
                
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = this.opacity;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }
            }
            
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
            
            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                requestAnimationFrame(animateParticles);
            }
            
            animateParticles();
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // --- Statistics Dashboard ---
        let statsChart = null;
        
        function toggleStatsDashboard() {
            const dashboard = document.getElementById('stats-dashboard');
            if (dashboard) {
                dashboard.classList.toggle('open');
                if (dashboard.classList.contains('open')) {
                    updateStatistics();
                }
            }
        }
        
        function updateStatistics() {
            // Calculate statistics
            const totalBeneficiaries = beneficiaries.length;
            const typeCounts = {
                electricity: beneficiaries.filter(b => b.type === 'electricity').length,
                equipment: beneficiaries.filter(b => b.type === 'equipment').length,
                transport: beneficiaries.filter(b => b.type === 'transport').length,
                training: beneficiaries.filter(b => b.type === 'training').length
            };
            
            // Calculate total compensations
            let totalCompensation = 0;
            compensations.forEach(c => {
                (c.quarters || []).forEach(q => {
                    totalCompensation += q.reimbursement || 0;
                });
            });
            compensationsEquipment.forEach(c => totalCompensation += c.totalDue || 0);
            compensationsTransport.forEach(c => totalCompensation += c.totalDue || 0);
            compensationsTraining.forEach(c => totalCompensation += c.totalDue || 0);
            
            // Update stat cards
            document.getElementById('stat-total-beneficiaries').textContent = totalBeneficiaries;
            document.getElementById('stat-total-compensation').textContent = formatCurrency(totalCompensation);
            document.getElementById('stat-electricity-count').textContent = typeCounts.electricity;
            document.getElementById('stat-equipment-count').textContent = typeCounts.equipment;
            
            // Update chart
            updateStatisticsChart(typeCounts);
        }
        
        function updateStatisticsChart(typeCounts) {
            const chartCanvas = document.getElementById('stats-chart');
            if (!chartCanvas) return;
            
            if (statsChart) {
                statsChart.destroy();
            }
            
            statsChart = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['كهرباء وغاز', 'منحة تجهيز', 'تنقل', 'تكوين'],
                    datasets: [{
                        data: [
                            typeCounts?.electricity || 0,
                            typeCounts?.equipment || 0,
                            typeCounts?.transport || 0,
                            typeCounts?.training || 0
                        ],
                        backgroundColor: [
                            '#FFA726',
                            '#66BB6A',
                            '#42A5F5',
                            '#AB47BC'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333',
                                font: {
                                    family: 'IBM Plex Sans Arabic'
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Achievement System ---
        const achievements = {
            firstBeneficiary: { title: '🎉 أول مستفيد!', unlocked: false },
            tenBeneficiaries: { title: '🏆 عشرة مستفيدين!', unlocked: false },
            fiftyBeneficiaries: { title: '🌟 خمسون مستفيداً!', unlocked: false },
            firstExport: { title: '📊 أول تصدير!', unlocked: false },
            firstBackup: { title: '💾 أول نسخة احتياطية!', unlocked: false }
        };
        
        function checkAchievements() {
            const savedAchievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            
            // Check first beneficiary
            if (beneficiaries.length >= 1 && !savedAchievements.firstBeneficiary) {
                unlockAchievement('firstBeneficiary');
            }
            
            // Check ten beneficiaries
            if (beneficiaries.length >= 10 && !savedAchievements.tenBeneficiaries) {
                unlockAchievement('tenBeneficiaries');
            }
            
            // Check fifty beneficiaries
            if (beneficiaries.length >= 50 && !savedAchievements.fiftyBeneficiaries) {
                unlockAchievement('fiftyBeneficiaries');
            }
        }
        
        function unlockAchievement(key) {
            const savedAchievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            if (savedAchievements[key]) return;
            
            savedAchievements[key] = true;
            localStorage.setItem('achievements', JSON.stringify(savedAchievements));
            
            // Show achievement popup
            showAchievementPopup(achievements[key].title);
            
            // Trigger confetti
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
        
        function showAchievementPopup(text) {
            const popup = document.getElementById('achievement-popup');
            const textElement = document.getElementById('achievement-text');
            if (popup && textElement) {
                textElement.textContent = text;
                popup.classList.add('show');
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 4000);
            }
        }

        // --- Keyboard Shortcuts ---
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S: Save current form
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    const activeSection = document.querySelector('.app-section:not([style*="display: none"])');
                    if (activeSection) {
                        const saveBtn = activeSection.querySelector('button[type="submit"], .btn-primary');
                        if (saveBtn) saveBtn.click();
                    }
                    showToast('💾 تم الحفظ!', 'success');
                }
                
                // Ctrl/Cmd + N: New beneficiary
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openBeneficiaryModal();
                }
                
                // Ctrl/Cmd + P: Print report
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    printReport();
                }
                
                // Ctrl/Cmd + E: Export to Excel
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportXLSX();
                }
                
                // Ctrl/Cmd + B: Create backup
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    createBackup();
                }
                
                // Escape: Close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.visible').forEach(modal => {
                        modal.classList.remove('visible');
                        setTimeout(() => modal.style.display = 'none', 300);
                    });
                }
                // F1: Show keyboard shortcuts
                if (e.key === 'F1') {
                    e.preventDefault();
                    showKeyboardShortcutsModal();
                }
            });
        }
        
        function showKeyboardShortcutsModal() {
            const modal = document.getElementById('keyboard-shortcuts-modal');
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('visible'), 10);
            }
        }
        
        function closeKeyboardShortcutsModal() {
            const modal = document.getElementById('keyboard-shortcuts-modal');
            if (modal) {
                modal.classList.remove('visible');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        // --- Scroll to Top Button ---
        function initScrollToTop() {
            const scrollBtn = document.querySelector('.fab-btn.scroll-top');
            if (!scrollBtn) return;
            
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollBtn.classList.add('visible');
                } else {
                    scrollBtn.classList.remove('visible');
                }
            });
            
            scrollBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // --- Progress Bar for Scroll ---
        function initProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            if (!progressBar) return;
            
            window.addEventListener('scroll', () => {
                const scrollTop = window.scrollY;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                const progress = (scrollTop / docHeight) * 100;
                progressBar.style.width = progress + '%';
            });
        }

        // --- Celebration on Milestone ---
        function celebrateMilestone(message) {
            showToast(message, 'success');
            
            if (typeof confetti === 'function') {
                // Fire confetti from both corners
                const count = 200;
                const defaults = {
                    origin: { y: 0.7 }
                };

                function fire(particleRatio, opts) {
                    confetti({
                        ...defaults,
                        ...opts,
                        particleCount: Math.floor(count * particleRatio)
                    });
                }

                fire(0.25, { spread: 26, startVelocity: 55 });
                fire(0.2, { spread: 60 });
                fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
                fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
                fire(0.1, { spread: 120, startVelocity: 45 });
            }
        }

        // --- Quick Search with Highlight ---
        function enhanceSearch() {
            const searchInput = document.getElementById('compensation-grid-search');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                const rows = document.querySelectorAll('#compensation-grid-table tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (query && text.includes(query)) {
                        row.style.backgroundColor = 'rgba(252, 169, 3, 0.2)';
                    } else {
                        row.style.backgroundColor = '';
                    }
                });
            });
        }

        // --- Initialize All Creative Features ---
        function initCreativeFeatures() {
            // Initialize clock
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
            
            // Initialize particles
            initParticles();
            
            // Initialize keyboard shortcuts
            initKeyboardShortcuts();
            
            // Initialize scroll to top
            initScrollToTop();
            
            // Initialize progress bar
            initProgressBar();
            
            // Enhance search
            enhanceSearch();
            
            // Check achievements
            setTimeout(checkAchievements, 2000);
            
            // Add FAB container event listeners
            document.addEventListener('click', (e) => {
                if (e.target.closest('.stats-toggle')) {
                    toggleStatsDashboard();
                }
                if (e.target.closest('.keyboard-help')) {
                    showKeyboardShortcutsModal();
                }
                if (e.target.closest('.close-stats')) {
                    toggleStatsDashboard();
                }
                if (e.target.closest('.close-keyboard-modal')) {
                    closeKeyboardShortcutsModal();
                }
            });
            
            // Welcome message based on time
            showWelcomeMessage();
            
            console.log('✨ Creative features initialized successfully!');
        }
        
        // --- Welcome Message ---
        function showWelcomeMessage() {
            const hour = new Date().getHours();
            let greeting = '';
            let emoji = '';
            
            if (hour >= 5 && hour < 12) {
                greeting = 'صباح الخير';
                emoji = '🌅';
            } else if (hour >= 12 && hour < 17) {
                greeting = 'مرحباً بك';
                emoji = '☀️';
            } else if (hour >= 17 && hour < 21) {
                greeting = 'مساء الخير';
                emoji = '🌆';
            } else {
                greeting = 'مرحباً بك في الساعات المتأخرة';
                emoji = '🌙';
            }
            
            // Only show if first visit today
            const today = new Date().toDateString();
            const lastVisit = localStorage.getItem('lastVisitDate');
            
            if (lastVisit !== today) {
                localStorage.setItem('lastVisitDate', today);
                setTimeout(() => {
                    showToast(`${emoji} ${greeting}! مرحباً في برنامج حساب التعويضات`, 'info');
                }, 1500);
            }
        }
        
        // --- Sound Effects (Optional) ---
        function playSound(type) {
            // Sounds are optional - only play if user has enabled them
            const soundsEnabled = localStorage.getItem('soundsEnabled') === 'true';
            if (!soundsEnabled) return;
            
            // Simple beep using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'success':
                        oscillator.frequency.value = 880;
                        break;
                    case 'error':
                        oscillator.frequency.value = 220;
                        break;
                    case 'click':
                        oscillator.frequency.value = 440;
                        break;
                    default:
                        oscillator.frequency.value = 440;
                }
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Silently fail if audio is not available
            }
        }
        
        // --- Auto-update Stats when data changes ---
        const originalSaveData = typeof saveData === 'function' ? saveData : null;
        if (originalSaveData) {
            window.saveDataOriginal = saveData;
            window.saveData = function() {
                window.saveDataOriginal();
                // Update stats if dashboard is open
                const dashboard = document.getElementById('stats-dashboard');
                if (dashboard && dashboard.classList.contains('open')) {
                    updateStatistics();
                }
                // Check achievements after save
                setTimeout(checkAchievements, 500);
            };
        }
    </script>

</body>
</html>
