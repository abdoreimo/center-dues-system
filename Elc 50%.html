<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج حساب تعويض 50% من استهلاك الكهرباء والغاز</title>
    <!-- Include SheetJS library for XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Font for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- CSS Variables --- Honey Theme --- */
        :root {
            /* Honey Theme Colors */
            --primary-color: #fca903;       /* Bright Amber/Orange */
            --primary-dark-color: #c77700;  /* Darker Honey/Brown */
            --secondary-color: #8D6E63;     /* Soft Brown */
            --success-color: #4CAF50;       /* A brighter, more positive green */
            --danger-color: #E53935;        /* A slightly softer red */
            --warning-color: #FFA000;       /* Amber */
            --info-color: #03A9F4;          /* A vibrant light blue */
            --light-color: #FFF8E1;         /* Light Cream */
            --dark-color: #4E342E;          /* Dark Brown for Text */
            --background-light: #FFECB3;   /* Light Honey */
            --background-white: #FFFAF0;    /* Floral White */
            --background-section: #FFF3E0;  /* Lighter Orange/Cream */
            --border-color: #D7CCC8;       /* Light Brown/Gray */
            --border-light-color: #EFEBE9; /* Very Light Brown/Gray */
            --text-color: #4E342E;         /* Dark Brown Text */
            --text-secondary-color: #795548; /* Medium Brown Text */

            /* Spacing */
            --space-xs: 5px;
            --space-sm: 10px;
            --space-md: 20px;
            --space-lg: 30px;
            --space-xl: 40px;

            /* Typography */
            --font-family: 'Cairo', sans-serif;
            --font-size-base: 1em;
            --font-size-h1: 2.2em;
            --font-size-h2: 1.8em;
            --font-size-h3: 1.4em;
            --font-size-h4: 1.1em;

            /* Borders */
            --border-radius-sm: 5px;
            --border-radius-md: 10px;
            --border-radius-lg: 25px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 6px 12px rgba(100, 50, 0, 0.15);
            --shadow-xl: 0 8px 16px rgba(100, 50, 0, 0.2);
            --shadow-inset: inset 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        /* --- General Styles --- */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: var(--space-md) var(--space-md) 60px var(--space-md);
            background-color: var(--background-light);
            direction: rtl;
            text-align: right;
            line-height: 1.6;
            color: var(--text-color);
            min-height: 100vh;
            box-sizing: border-box;
            background-image:
                linear-gradient(to bottom right, rgba(255, 236, 179, 0.8), rgba(255, 224, 130, 0.8), rgba(255, 213, 79, 0.8)),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23c77700' fill-opacity='0.12' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99 7.5V30L0 22.5zM15 15l12.99 7.5V30L15 22.5z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            background-attachment: fixed;
        }

        header {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark-color));
            color: white;
            padding: var(--space-md) 0;
            text-align: center;
            margin-bottom: var(--space-xl);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            position: relative;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
        }

        header h1 {
            margin: 0;
            font-size: var(--font-size-h1);
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-sm);
        }

        nav {
            margin-top: var(--space-md);
        }

        nav button {
            margin: 0 8px;
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-radius: var(--border-radius-lg);
            font-size: 1.05em;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            font-family: var(--font-family);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
        }

        nav button:hover, nav button.active {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        nav button:active {
             transform: translateY(0);
             box-shadow: var(--shadow-sm);
        }

        .app-section {
            background-color: var(--background-section);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light-color);
            display: none;
            border-top: 4px solid var(--primary-color);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        .app-section h2, .app-section h3 {
            color: var(--primary-dark-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: var(--space-sm);
            margin-bottom: var(--space-lg);
            font-weight: 700;
        }
        .app-section h2 { font-size: var(--font-size-h2); }
        .app-section h3 { font-size: var(--font-size-h3); }


        form > div {
            margin-bottom: var(--space-md);
        }
         .form-row > div {
             margin-bottom: 0;
         }

         .form-row {
             display: flex;
             gap: var(--space-lg);
             margin-bottom: var(--space-md);
             flex-wrap: wrap;
         }
         .form-row > div {
             flex: 1 1 250px;
         }
          #beneficiary-form .form-row > div {
              flex: 1 1 180px;
          }
         form button[type="submit"]:not(.modal-buttons button) {
            margin-top: var(--space-lg);
         }


        form label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--text-secondary-color);
            font-size: 1.05em;
        }

        form input[type="text"],
        form input[type="number"],
        form select {
            width: 100%;
            padding: 13px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-sizing: border-box;
            text-align: right;
            font-size: var(--font-size-base);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: var(--background-white);
            color: var(--text-color);
        }
         form input[type="text"]:focus,
         form input[type="number"]:focus,
         form select:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(252, 169, 3, 0.25);
             outline: none;
         }
        input[readonly] {
            background-color: var(--border-light-color) !important;
            cursor: not-allowed;
        }

        /* Primary form submit buttons */
        form button[type="submit"]:not(.modal-buttons button) {
            padding: 14px 30px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            font-weight: 700;
            font-family: var(--font-family);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
        }

        form button[type="submit"]:not(.modal-buttons button):hover {
            background-color: #388E3C; /* Darker Green */
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
         form button[type="submit"]:not(.modal-buttons button):active {
             transform: translateY(0);
             box-shadow: var(--shadow-sm);
         }

        /* Generic Button Grouping */
        .button-group {
             display: flex;
             align-items: center;
             gap: var(--space-sm);
             margin-top: var(--space-md);
        }
        .button-group button {
            margin-left: 0;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            font-family: var(--font-family);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            color: white;
        }
        .button-group button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        #backup-restore-section .button-group button { background-color: var(--info-color); }
        #backup-restore-section .button-group button:hover { background-color: #0288D1; }
        #reporting-section .button-group button { background-color: var(--primary-dark-color); }
        #reporting-section .button-group button:hover { background-color: #A16200; }
        #reporting-section .button-group button:disabled {
              background-color: #BDBDBD;
              cursor: not-allowed;
              transform: none;
              box-shadow: none;
        }
        .explanation {
             margin-top: var(--space-sm);
             font-size: 0.9em;
             color: var(--text-secondary-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-md);
            box-shadow: var(--shadow-sm);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            background-color: var(--background-white);
        }

        table th, table td {
            border-bottom: 1px solid var(--border-color);
            padding: var(--space-sm) var(--space-md);
            text-align: right;
            font-size: 0.95em;
        }

        th {
            background-color: var(--primary-dark-color);
            font-weight: 700;
            color: white;
        }

        tbody tr:nth-child(even) {
            background-color: #FFFDF5; /* Lighter than light-color for subtle striping */
        }
         tbody tr:hover {
             background-color: #FFE0B2; /* Light orange on hover */
         }

        .report-output {
            margin-top: var(--space-md);
            padding: var(--space-md);
            border: 1px dashed var(--border-color);
            background-color: var(--background-white);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
            font-size: 12px;
            overflow-x: auto;
        }

        .report-output table {
            border: 2px solid var(--dark-color);
        }
        .report-output th, .report-output td {
             border: 1px solid var(--text-color);
             padding: var(--space-sm);
             text-align: center;
             font-size: 11px;
        }
        .report-output th {
            background-color: #FFE0B2;
            color: var(--dark-color);
        }
        .report-output .total-row th,
        .report-output .total-row td {
            font-weight: bold;
            background-color: var(--border-color);
        }
        #compensation-summary-table .total-row td {
            font-weight: bold;
            background-color: var(--border-color);
        }

        /* Ticker Tape Styles */
        #ticker-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 45px;
            background-color: var(--dark-color);
            color: var(--light-color);
            overflow: hidden;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
            line-height: 45px;
            white-space: nowrap;
            z-index: 1000;
            font-size: 1em;
         }

         #ticker-content {
             display: inline-block;
             position: absolute;
             left: -100%;
             right: auto;
             animation: scrollTickerLeftToRight 35s linear infinite;
         }

         @keyframes scrollTickerLeftToRight {
             0% { transform: translateX(100vw); }
             100% { transform: translateX(-100%); }
         }

         #ticker-content span {
             margin-right: 50px;
         }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible {
             display: flex;
             opacity: 1;
        }
        .modal-overlay.visible .modal-content {
             transform: translateY(0);
             opacity: 1;
        }
        .modal-content {
            background-color: var(--background-section);
            padding: 35px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            max-width: 550px;
            width: 90%;
            text-align: right;
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
         .modal-buttons {
             text-align: left;
             margin-top: var(--space-lg);
         }
          .modal-buttons button {
             margin-left: var(--space-sm);
             padding: 10px 20px;
             border: none;
             border-radius: var(--border-radius-sm);
             cursor: pointer;
             font-size: 1em;
             transition: all 0.3s ease;
             box-shadow: var(--shadow-sm);
             font-family: var(--font-family);
             display: inline-flex;
             align-items: center;
             gap: var(--space-xs);
          }
           .modal-buttons .save-button {
               background-color: var(--success-color);
               color: white;
           }
            .modal-buttons .save-button:hover {
                background-color: #388E3C;
                transform: translateY(-1px);
            }
           .modal-buttons .cancel-button {
               background-color: var(--secondary-color);
               color: white;
           }
            .modal-buttons .cancel-button:hover {
                 background-color: #6D4C41;
                 transform: translateY(-1px);
            }

        /* Focus indicator */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        input:focus, select:focus, button:focus {
           outline: none;
        }
        
        /* --- Compensation Grid Section Styles --- */
        #compensation-management-section {
            display: none; /* Managed by JS */
            flex-direction: column;
        }
        .compensation-grid-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
            gap: var(--space-md);
            flex-wrap: wrap;
        }
        .compensation-grid-toolbar .search-container {
            position: relative;
            flex-grow: 1;
            min-width: 250px;
        }
        .compensation-grid-toolbar .search-container i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary-color);
        }
        #compensation-grid-search {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
        }
        #compensation-grid-search:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(252, 169, 3, 0.25);
        }
        #add-beneficiary-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-lg);
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }
        #add-beneficiary-btn:hover { 
            background-color: var(--primary-dark-color);
            transform: translateY(-2px);
        }

        .compensation-grid-container {
            overflow-x: auto;
            max-height: 70vh;
        }
        #compensation-grid-table { table-layout: fixed; }
        #compensation-grid-table th, #compensation-grid-table td {
            text-align: center;
            vertical-align: middle;
            padding: 10px;
            white-space: nowrap;
        }
        
        /* Beneficiary Name Column with Actions */
        #compensation-grid-table th:nth-child(2),
        #compensation-grid-table td:nth-child(2) {
            text-align: right;
            width: 280px;
            white-space: normal;
        }
        .beneficiary-name-cell {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-sm);
        }
        .beneficiary-name-cell .beneficiary-actions {
            display: flex;
            gap: var(--space-xs);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        tr:hover .beneficiary-name-cell .beneficiary-actions {
            opacity: 1;
        }
        .beneficiary-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: var(--text-secondary-color);
            transition: all 0.2s ease;
        }
        .beneficiary-actions button:hover {
            background-color: rgba(0,0,0,0.1);
            color: var(--dark-color);
        }
        .beneficiary-actions .edit-btn-inline:hover { color: var(--warning-color); }
        .beneficiary-actions .delete-btn-inline:hover { color: var(--danger-color); }


        #compensation-grid-table th:nth-child(1),
        #compensation-grid-table td:nth-child(1) { width: 50px; }
        #compensation-grid-table th.status-column { width: 120px; }

        .editable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
            border-radius: var(--border-radius-sm);
        }
        .editable-cell:hover {
            background-color: var(--light-color);
            box-shadow: 0 0 0 2px var(--primary-color) inset;
        }
        .grid-input {
            width: 100px;
            padding: 8px;
            text-align: center;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            font-size: 0.95em;
            background-color: var(--background-white);
            color: var(--text-color);
        }
        .grid-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(252, 169, 3, 0.25);
            outline: none;
        }
        .calculated-cell { font-weight: bold; color: var(--text-secondary-color); }
        .net-payable-cell { color: var(--success-color); font-size: 1.1em; }

        tr.is-dirty { background-color: var(--light-color) !important; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--border-radius-lg);
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            text-align: center;
        }
        .status-badge.empty { background-color: #BDBDBD; color: var(--dark-color); }
        .status-badge.saved { background-color: var(--success-color); }
        .status-badge.unsaved { background-color: var(--warning-color); color: var(--dark-color); }


        /* Print Specific Styles */
        @media print {
            body {
                padding: 0; margin: 0; background: none !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; font-family: 'Arial', sans-serif !important; color: #000 !important;
            }
            
            body > * {
                display: none !important;
            }
            #print-report-content {
                display: block !important;
            }

            @page {
                size: landscape; 
                margin: 1cm;
            }

            #print-report-content.report-output {
                padding: 0; margin: 0; border: none; box-shadow: none; overflow-x: visible; 
                font-size: 10pt; color: #000 !important; background-color: #ffffff !important;
            }
            #print-report-content table {
                width: 100%; border-collapse: collapse; table-layout: fixed; 
                border: 2px solid #000 !important;
            }
            #print-report-content th, #print-report-content td {
                font-size: 9pt; padding: 3px 5px; text-align: center; 
                border: 1px solid #000 !important; color: #000 !important;
                word-wrap: break-word; /* Prevents text overflow */
                vertical-align: middle; /* Better vertical alignment */
            }
            /* Defining column widths for better layout control */
            #print-report-content th:nth-child(1), #print-report-content td:nth-child(1) { width: 4%; }
            #print-report-content th:nth-child(2), #print-report-content td:nth-child(2) { width: 22%; text-align: right; padding-right: 8px; }
            #print-report-content th:nth-child(3), #print-report-content td:nth-child(3) { width: 8%; }
            #print-report-content th:nth-child(4), #print-report-content td:nth-child(4) { width: 18%; }
            #print-report-content th:nth-child(5), #print-report-content td:nth-child(5) { width: 7%; }
            #print-report-content th:nth-child(6), #print-report-content td:nth-child(6) { width: 7%; }
            #print-report-content th:nth-child(7), #print-report-content td:nth-child(7) { width: 7%; }
            #print-report-content th:nth-child(8), #print-report-content td:nth-child(8) { width: 7%; }
            #print-report-content th:nth-child(9), #print-report-content td:nth-child(9) { width: 8%; }
            #print-report-content th:nth-child(10), #print-report-content td:nth-child(10) { width: 12%; font-weight: bold; }
            
            #print-report-content th { 
                background-color: #E0E0E0 !important; 
            }
            #print-report-content .total-row th,
            #print-report-content .total-row td { 
                background-color: #E0E0E0 !important; 
                font-weight: bold;
            }
            #print-report-content .report-header, 
            #print-report-content .report-footer {
                color: #000 !important;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-certificate" style="transform: rotate(30deg);"></i> برنامج حساب تعويض 50% من استهلاك الكهرباء والغاز</h1>
        <nav>
            <button onclick="showSection('institution-info-section')"><i class="fas fa-building"></i> معلومات المؤسسة</button>
            <button onclick="showSection('compensation-management-section')"><i class="fas fa-users"></i> إدارة التعويضات والمستفيدين</button>
            <button onclick="showSection('reporting-section')"><i class="fas fa-file-alt"></i> التقارير والتصدير</button>
            <button onclick="showSection('backup-restore-section')"><i class="fas fa-database"></i> النسخ الاحتياطي</button>
        </nav>
    </header>

    <main>
        <!-- معلومات المؤسسة -->
        <section id="institution-info-section" class="app-section">
            <h2>معلومات المؤسسة</h2>
            <form id="institution-info-form">
                <div class="form-row">
                    <div>
                        <label for="republic">الجمهورية:</label>
                        <input type="text" id="republic" value="الجمهورية الجزائرية الديمقراطية الشعبية">
                    </div>
                    <div>
                        <label for="ministry">الوزارة:</label>
                        <input type="text" id="ministry" value="وزارة التربية الوطنية">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="directorate">المديرية:</label>
                        <input type="text" id="directorate" value="مديرية التربية لولاية أدرار">
                    </div>
                    <div>
                        <label for="institution">المؤسسة:</label>
                        <input type="text" id="institution" value="متوسطة حكومي قدور بن علال">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="fiscal-year">السنة المالية (YYYY):</label>
                        <input type="text" id="fiscal-year" value="2025" placeholder="مثال: 2025" maxlength="4">
                    </div>
                    <div>
                        <label for="financial-month">الشهر المالي (MM):</label>
                        <input type="text" id="financial-month" value="" placeholder="مثال: 04" maxlength="2">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="treasury-account">رقم الحساب البريدي لدى الخزينة (CCP):</label>
                        <input type="text" id="treasury-account" value="" placeholder="حساب الخزينة CCP">
                    </div>
                    <div>
                        <label for="treasury-key">مفتاح الحساب البريدي لدى الخزينة (CLE):</label>
                        <input type="text" id="treasury-key" value="" placeholder="مفتاح حساب الخزينة 02 رقم" maxlength="2">
                    </div>
                </div>
                <div class="form-row">
                     <div>
                         <label for="order-number">رقم الأمر بالصرف:</label>
                         <input type="text" id="order-number" value="">
                     </div>
                     <div>
                         <label for="transfer-number">رقم الحوالة:</label>
                         <input type="text" id="transfer-number" value="">
                     </div>
                </div>
                <div>
                    <button type="submit"><i class="fas fa-save"></i> حفظ المعلومات</button>
                </div>
            </form>
        </section>

        <!-- إدارة المستفيدين (Deprecated - kept for structure but hidden) -->
        <section id="beneficiary-management-section" class="app-section" style="display: none !important;"></section>

        <!-- إدارة التعويضات (NEW GRID UI) -->
        <section id="compensation-management-section" class="app-section">
            <div class="compensation-grid-toolbar">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="compensation-grid-search" placeholder="بحث بالاسم أو CCP...">
                </div>
                <div class="actions-container">
                    <button id="add-beneficiary-btn"><i class="fas fa-user-plus"></i> إضافة مستفيد جديد</button>
                </div>
            </div>
            <div class="compensation-grid-container">
                <table id="compensation-grid-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>اللقب و الاسم</th>
                            <th>تعويض ث 1</th>
                            <th>تعويض ث 2</th>
                            <th>تعويض ث 3</th>
                            <th>تعويض ث 4</th>
                            <th>الخصم</th>
                            <th>المجموع</th>
                            <th>الصافي للدفع</th>
                            <th class="status-column">الحالة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- التقارير والتصدير -->
        <section id="reporting-section" class="app-section">
             <h2>التقارير والتصدير</h2>
             <p>التقرير سيتم إنشاؤه بناءً على معلومات المؤسسة وقائمة المستفيدين وتعويضاتهم.</p>
             <div class="button-group">
                 <button onclick="printReport()"><i class="fas fa-print"></i> طباعة التقرير</button>
                 <button onclick="exportXLSX()"><i class="fas fa-file-excel"></i> تصدير XLSX</button>
                 <button onclick="exportTxt()"><i class="fas fa-file-code"></i> تصدير ملف TXT</button>
             </div>
             <p class="explanation">ملاحظة: يعرض المتصفح غالباً نافذة لاختيار مكان حفظ ملف التصدير.</p>
             
             <h3><i class="fas fa-eye"></i> معاينة التقرير</h3>
             <div id="report-preview" class="report-output"></div>
        </section>

         <!-- Backup/Restore -->
         <section id="backup-restore-section" class="app-section">
             <h2>النسخ الاحتياطي والاستعادة</h2>
             <p>يمكنك إنشاء نسخة احتياطية لبياناتك الحالية أو استعادة بيانات من ملف نسخة احتياطية سابق.</p>
             <div class="button-group">
                 <button onclick="createBackup()"><i class="fas fa-download"></i> إنشاء نسخة احتياطية</button>
                 <input type="file" id="restore-file-input" accept=".json" style="display: none;">
                 <button onclick="restoreBackup()"><i class="fas fa-upload"></i> استعادة من نسخة</button>
             </div>
             <p class="explanation">ملاحظة: عند إنشاء نسخة احتياطية، سيتم حفظ ملف بامتداد .json على جهازك.</p>
         </section>

    </main>

    <div id="print-report-content" class="report-output" style="display: none;"></div>

    <!-- Add/Edit Beneficiary Modal -->
    <div id="beneficiary-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="beneficiary-modal-title"></h3>
            <form id="beneficiary-form">
                 <input type="hidden" id="beneficiary-id">
                 <div>
                    <label for="beneficiary-name">اللقب و الاسم:</label>
                    <input type="text" id="beneficiary-name" required placeholder="الرجاء حجز الاسم و اللقب كاملا باللغة اللاتينية" pattern="^[a-zA-Z\s\-]+$" inputmode="latin">
                </div>
                <div class="form-row">
                    <div>
                        <label for="account-number">رقم الحساب (CCP):</label>
                        <input type="text" id="account-number" required oninput="updateCalculatedRIP()">
                    </div>
                    <div>
                        <label for="meter-number">رقم العداد:</label>
                        <input type="text" id="meter-number">
                    </div>
                    <div>
                        <label for="calculated-rip">رقم RIP الكامل (20 رقم):</label>
                        <input type="text" id="calculated-rip" value="" readonly placeholder="يتم حسابه تلقائياً">
                    </div>
                </div>
                 <div class="modal-buttons">
                    <button type="submit" class="save-button"><i class="fas fa-save"></i> حفظ</button>
                    <button type="button" class="cancel-button" onclick="cancelBeneficiaryEdit()"><i class="fas fa-times-circle"></i> إلغاء</button>
                 </div>
            </form>
        </div>
    </div>
    
    <!-- Quarterly Details Modal -->
    <div id="quarterly-details-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <h3 id="quarterly-modal-title"></h3>
            <form id="quarterly-details-form">
                <input type="hidden" id="quarterly-beneficiary-id">
                <input type="hidden" id="quarterly-quarter-index">
                <div class="form-row">
                    <div>
                        <label for="quarterly-nofees">المبلغ دون رسوم:</label>
                        <input type="number" id="quarterly-nofees" step="0.01" value="0.00">
                    </div>
                    <div>
                        <label for="quarterly-value">القيمة المضافة:</label>
                        <input type="number" id="quarterly-value" step="0.01" value="0.00">
                    </div>
                </div>
                 <div>
                    <label for="quarterly-contrib">مساهمة الدولة:</label>
                    <input type="number" id="quarterly-contrib" step="0.01" value="0.00">
                 </div>
                <div class="modal-buttons">
                    <button type="submit" class="save-button"><i class="fas fa-check"></i> تأكيد</button>
                    <button type="button" class="cancel-button" onclick="closeQuarterlyModal()"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>


    <div id="ticker-container">
        <div id="ticker-content">
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
            <span>&nbsp;&nbsp;***&nbsp;&nbsp;</span>
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
            <span>&nbsp;&nbsp;***&nbsp;&nbsp;</span>
            <span>هذا البرنامج من انجاز الزميلين اولفي عبد الرحمن و لروي حبيب صدقة جارية على ابويهما المتوفين فادعوا لهما بالرحمة و المغفرة ولجميع موتى المسلمين اللهم انصر اخواننا بغزة</span>
        </div>
    </div>

    <script>
        // --- Data Storage ---
        let institutionInfo = {
            republic: "الجمهورية الجزائرية الديمقراطية الشعبية",
            ministry: "وزارة التربية الوطنية",
            directorate: "مديرية التربية لولاية أدرار",
            institution: "متوسطة حكومي قدور بن علال",
            fiscalYear: "2025",
            financialMonth: "",
            treasuryAccount: "",
            treasuryKey: "",
            orderNumber: "",
            transferNumber: ""
        };

        let beneficiaries = [];
        let compensations = [];


        // --- Helper Functions ---
        function loadData() {
            try {
                const savedInstitutionInfo = localStorage.getItem('institutionInfo');
                const savedBeneficiaries = localStorage.getItem('beneficiaries');
                const savedCompensations = localStorage.getItem('compensations');

                if (savedInstitutionInfo) {
                    const tempInfo = JSON.parse(savedInstitutionInfo);
                     institutionInfo = {
                         ...institutionInfo,
                         ...tempInfo
                     };
                }

                if (savedBeneficiaries) {
                    beneficiaries = JSON.parse(savedBeneficiaries);
                    beneficiaries.forEach(b => {
                        b.id = parseInt(b.id) || 0;
                         if (b.meter === undefined) b.meter = "";
                         if (b.key !== undefined) delete b.key;
                    });
                    beneficiaries = beneficiaries.filter(b => b.id > 0);
                }

                if (savedCompensations) {
                    compensations = JSON.parse(savedCompensations);
                    compensations.forEach(comp => {
                        comp.beneficiaryId = parseInt(comp.beneficiaryId) || 0;
                        const defaultQuarter = { nofees: 0, value: 0, contrib: 0, calculated: 0 };
                        comp.q1 = {...defaultQuarter, ...(comp.q1 || {})};
                        comp.q2 = {...defaultQuarter, ...(comp.q2 || {})};
                        comp.q3 = {...defaultQuarter, ...(comp.q3 || {})};
                        comp.q4 = {...defaultQuarter, ...(comp.q4 || {})};

                        comp.discount = parseFloat(comp.discount) || 0;

                        comp.q1.calculated = calculateQuarterlyComp(comp.q1.nofees, comp.q1.value, comp.q1.contrib);
                        comp.q2.calculated = calculateQuarterlyComp(comp.q2.nofees, comp.q2.value, comp.q2.contrib);
                        comp.q3.calculated = calculateQuarterlyComp(comp.q3.nofees, comp.q3.value, comp.q3.contrib);
                        comp.q4.calculated = calculateQuarterlyComp(comp.q4.nofees, comp.q4.value, comp.q4.contrib);

                        comp.netPayable = Math.round(((comp.q1.calculated + comp.q2.calculated + comp.q3.calculated + comp.q4.calculated) - comp.discount) * 100) / 100;
                    });
                    compensations = compensations.filter(comp => comp.beneficiaryId > 0);
                }
                 compensations = compensations.filter(comp => beneficiaries.some(b => b.id === comp.beneficiaryId));
            } catch (e) {
                console.error("An error occurred during data loading:", e);
                alert("حدث خطأ أثناء تحميل البيانات المحفوظة. قد يتم استخدام البيانات الافتراضية.");
            }
        }

        function saveData() {
            try {
                 localStorage.setItem('institutionInfo', JSON.stringify(institutionInfo));
                localStorage.setItem('beneficiaries', JSON.stringify(beneficiaries));
                localStorage.setItem('compensations', JSON.stringify(compensations));
            } catch (e) {
                console.error("An error occurred during data saving:", e);
                alert("حدث خطأ أثناء حفظ البيانات.");
            }
        }

        function getNextBeneficiaryId() {
            if (beneficiaries.length === 0) return 1;
            return Math.max(...beneficiaries.map(b => b.id)) + 1;
        }

        function formatCurrency(amount) {
            return (parseFloat(amount) || 0).toFixed(2).replace('.', ',');
        }
        
        function numberToArabicText(amount) {
            const roundedAmount = Math.round(amount * 100) / 100;
            const [integerPart, decimalPart] = roundedAmount.toFixed(2).split('.');
            const onesArabic = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة', 'عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
            const tensArabic = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            
            function processThreeDigits(num) {
                if (num === 0) return '';
                const hundred = Math.floor(num / 100);
                const remainder = num % 100;
                let result = '';
                if (hundred > 0) result += hundreds[hundred] + (remainder > 0 ? ' و ' : '');
                if (remainder > 0 && remainder < 20) result += onesArabic[remainder];
                else if (remainder >= 20) {
                    const tens = Math.floor(remainder / 10), ones = remainder % 10;
                    result += (ones > 0 ? onesArabic[ones] + ' و ' : '') + tensArabic[tens];
                }
                return result;
            }
            
            const intValue = parseInt(integerPart);
            if (intValue === 0 && parseInt(decimalPart) === 0) return 'صفر دينار';
            
            const million = Math.floor(intValue / 1e6);
            const thousand = Math.floor((intValue % 1e6) / 1000);
            const remain = intValue % 1000;
            let result = '';

            if (million > 0) result += (million === 1 ? 'مليون' : million === 2 ? 'مليونان' : processThreeDigits(million) + (million > 10 ? ' مليون' : ' ملايين')) + (thousand > 0 || remain > 0 ? ' و ' : '');
            if (thousand > 0) result += (thousand === 1 ? 'ألف' : thousand === 2 ? 'ألفان' : processThreeDigits(thousand) + (thousand > 10 ? ' ألف' : ' آلاف')) + (remain > 0 ? ' و ' : '');
            if (remain > 0) result += processThreeDigits(remain);
            
            if (intValue > 0) result += (intValue === 1 ? ' دينار' : intValue === 2 ? ' ديناران' : intValue > 10 ? ' دينار' : ' دنانير');

            if (parseInt(decimalPart) > 0) {
                const decimalValue = parseInt(decimalPart);
                result += (intValue > 0 ? ' و ' : '') + processThreeDigits(decimalValue) + (decimalValue === 1 ? ' سنتيم' : decimalValue === 2 ? ' سنتيمان' : decimalValue > 10 ? ' سنتيم' : ' سنتيمات');
            }
            return result.replace(/^ و /, '').replace(/ و $/, '');
        }

         function calculateRIP(ccpNumberString) {
             if (!ccpNumberString || !/^\d+$/.test(ccpNumberString.trim())) return 'CCP غير صالح';
             const ccpPadded = ccpNumberString.trim().padStart(10, '0');
             let ripKey = (parseInt(ccpNumberString, 10) * 100) % 97;
             ripKey = 97 - (ripKey + 85) % 97;
             const rip = '00799999' + ccpPadded + ripKey.toString().padStart(2, '0');
             return rip.length === 20 ? rip : 'خطأ في الطول';
         }

        function updateCalculatedRIP() {
            const ccpInput = document.getElementById('account-number');
            const ripDisplay = document.getElementById('calculated-rip');
            ripDisplay.value = ccpInput.value.trim() ? calculateRIP(ccpInput.value) : '';
        }

        function showSection(sectionId) {
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('onclick') === `showSection('${sectionId}')`) {
                    button.classList.add('active');
                }
            });

            document.querySelectorAll('.app-section').forEach(section => {
                if (section.id !== 'beneficiary-management-section') { // Keep it hidden
                    section.style.display = 'none';
                }
            });

            const sectionToShow = document.getElementById(sectionId);
            
            if (sectionToShow) {
                 const displayStyle = sectionId === 'compensation-management-section' ? 'flex' : 'block';
                 if (sectionId.includes('-modal')) {
                     sectionToShow.style.display = 'flex';
                     setTimeout(() => sectionToShow.classList.add('visible'), 10);
                 } else {
                     sectionToShow.style.display = displayStyle;
                 }
            } else { return; }

            if (sectionId === 'institution-info-section') {
                for (const key in institutionInfo) {
                    const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                    if (element) element.value = institutionInfo[key];
                }
            } else if (sectionId === 'compensation-management-section') {
                renderCompensationGrid();
            } else if (sectionId === 'reporting-section') {
                generateReportPreview();
            }
        }


        // --- Institution Info Management ---
        function saveInstitutionInfo(event) {
            event.preventDefault();
            for (const key in institutionInfo) {
                const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                if (element) institutionInfo[key] = element.value.trim();
            }
            saveData();
            alert('تم حفظ معلومات المؤسسة.');
            if (document.getElementById('reporting-section').style.display === 'block') {
                 generateReportPreview();
            }
        }


        // --- Beneficiary Management (New Integrated Workflow) ---
        function openBeneficiaryModal(id = null) {
            const modal = document.getElementById('beneficiary-modal');
            const form = document.getElementById('beneficiary-form');
            const title = document.getElementById('beneficiary-modal-title');
            
            form.reset(); // Clear previous data
            
            if (id) { // Editing existing beneficiary
                const beneficiary = beneficiaries.find(b => b.id === id);
                if (!beneficiary) return;
                title.innerHTML = '<i class="fas fa-user-edit"></i> تعديل بيانات المستفيد';
                document.getElementById('beneficiary-id').value = beneficiary.id;
                document.getElementById('beneficiary-name').value = beneficiary.name;
                document.getElementById('account-number').value = beneficiary.account;
                document.getElementById('meter-number').value = beneficiary.meter;
            } else { // Adding new beneficiary
                title.innerHTML = '<i class="fas fa-user-plus"></i> إضافة مستفيد جديد';
                document.getElementById('beneficiary-id').value = '';
            }
            
            updateCalculatedRIP(); // Update RIP field
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function cancelBeneficiaryEdit() {
            const modal = document.getElementById('beneficiary-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function saveBeneficiary(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('beneficiary-id').value) || null;
            const name = document.getElementById('beneficiary-name').value.trim();
            const account = document.getElementById('account-number').value.trim();
            const meter = document.getElementById('meter-number').value.trim();
            
            if (!name || !account) return alert('الرجاء ملء الاسم والحساب.');
            if (!/^[a-zA-Z\s\-]+$/.test(name)) return alert('الرجاء إدخال الاسم بالأحرف اللاتينية.');
            if (beneficiaries.some(b => b.account === account && b.id !== id)) return alert('رقم الحساب مسجل لمستفيد آخر.');
            if (calculateRIP(account).includes('خطأ')) return alert('رقم الحساب غير صالح.');

            if (id) { // Update existing
                const beneficiary = beneficiaries.find(b => b.id === id);
                if (beneficiary) {
                    beneficiary.name = name;
                    beneficiary.account = account;
                    beneficiary.meter = meter;
                }
                alert('تم حفظ التعديلات.');
            } else { // Add new
                beneficiaries.push({ id: getNextBeneficiaryId(), name, account, meter });
                alert('تم إضافة المستفيد بنجاح.');
            }

            saveData();
            renderCompensationGrid();
            cancelBeneficiaryEdit();
        }

        function deleteBeneficiary(id) {
            const beneficiary = beneficiaries.find(b => b.id === id);
            if (confirm(`هل أنت متأكد من حذف المستفيد "${beneficiary.name}" وكل تعويضاته؟`)) {
                beneficiaries = beneficiaries.filter(b => b.id !== id);
                compensations = compensations.filter(c => c.beneficiaryId !== id);
                
                // Re-sequence IDs to keep them contiguous
                beneficiaries.sort((a, b) => a.id - b.id).forEach((b, index) => {
                    const oldId = b.id;
                    const newId = index + 1;
                    if (oldId !== newId) {
                        compensations.forEach(c => { if(c.beneficiaryId === oldId) c.beneficiaryId = newId; });
                        b.id = newId;
                    }
                });

                saveData();
                renderCompensationGrid();
                alert('تم حذف المستفيد وتحديث الترقيم.');
            }
        }
        
        // --- Compensation Grid ---
        function calculateQuarterlyComp(nofees, value, contrib) {
            const comp = (parseFloat(nofees||0) + parseFloat(value||0) - parseFloat(contrib||0)) / 2;
            return comp > 0 ? comp : 0;
        }

        function renderCompensationGrid(searchTerm = '') {
            const tableBody = document.querySelector('#compensation-grid-table tbody');
            tableBody.innerHTML = '';

            const filtered = beneficiaries.filter(b =>
                searchTerm === '' ||
                b.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                b.account.includes(searchTerm)
            );

            filtered.sort((a,b) => a.id - b.id).forEach(b => {
                const compData = compensations.find(c => c.beneficiaryId === b.id) || {
                    q1: { calculated: 0 }, q2: { calculated: 0 }, q3: { calculated: 0 }, q4: { calculated: 0 },
                    discount: 0, netPayable: 0
                };
                
                const totalComp = compData.q1.calculated + compData.q2.calculated + compData.q3.calculated + compData.q4.calculated;
                const netPayable = totalComp - compData.discount;
                const hasData = compensations.some(c => c.beneficiaryId === b.id);

                const row = document.createElement('tr');
                row.dataset.beneficiaryId = b.id;
                row.innerHTML = `
                    <td>${b.id}</td>
                    <td class="beneficiary-name-cell">
                        <span>${b.name}</span>
                        <div class="beneficiary-actions">
                             <button class="edit-btn-inline" onclick="openBeneficiaryModal(${b.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                             <button class="delete-btn-inline" onclick="deleteBeneficiary(${b.id})" title="حذف"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                    <td class="editable-cell" data-quarter="1">${formatCurrency(compData.q1.calculated)}</td>
                    <td class="editable-cell" data-quarter="2">${formatCurrency(compData.q2.calculated)}</td>
                    <td class="editable-cell" data-quarter="3">${formatCurrency(compData.q3.calculated)}</td>
                    <td class="editable-cell" data-quarter="4">${formatCurrency(compData.q4.calculated)}</td>
                    <td><input type="number" class="grid-input discount-input" value="${compData.discount.toFixed(2)}" step="0.01"></td>
                    <td class="calculated-cell total-comp-cell">${formatCurrency(totalComp)}</td>
                    <td class="calculated-cell net-payable-cell">${formatCurrency(netPayable)}</td>
                    <td class="status-column"><span class="status-badge ${hasData ? 'saved' : 'empty'}">${hasData ? 'محفوظ' : 'فارغ'}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function openQuarterlyModal(beneficiaryId, quarterIndex) {
            const beneficiary = beneficiaries.find(b => b.id === beneficiaryId);
            if (!beneficiary) return;

            const modal = document.getElementById('quarterly-details-modal');
            const compData = compensations.find(c => c.beneficiaryId === beneficiaryId);

            document.getElementById('quarterly-modal-title').textContent = `تفاصيل الثلاثي ${quarterIndex} لـ: ${beneficiary.name}`;
            document.getElementById('quarterly-beneficiary-id').value = beneficiaryId;
            document.getElementById('quarterly-quarter-index').value = quarterIndex;
            
            const qData = compData ? compData[`q${quarterIndex}`] : { nofees: 0, value: 0, contrib: 0 };
            document.getElementById('quarterly-nofees').value = (qData.nofees || 0).toFixed(2);
            document.getElementById('quarterly-value').value = (qData.value || 0).toFixed(2);
            document.getElementById('quarterly-contrib').value = (qData.contrib || 0).toFixed(2);

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function closeQuarterlyModal() {
            const modal = document.getElementById('quarterly-details-modal');
            modal.classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function handleQuarterlyFormSubmit(event) {
            event.preventDefault();
            const beneficiaryId = parseInt(document.getElementById('quarterly-beneficiary-id').value);
            const quarterIndex = document.getElementById('quarterly-quarter-index').value;
            
            const nofees = parseFloat(document.getElementById('quarterly-nofees').value) || 0;
            const value = parseFloat(document.getElementById('quarterly-value').value) || 0;
            const contrib = parseFloat(document.getElementById('quarterly-contrib').value) || 0;

            const calculated = calculateQuarterlyComp(nofees, value, contrib);

            const targetRow = document.querySelector(`#compensation-grid-table tbody tr[data-beneficiary-id='${beneficiaryId}']`);
            if (targetRow) {
                const targetCell = targetRow.querySelector(`td[data-quarter='${quarterIndex}']`);
                targetCell.textContent = formatCurrency(calculated);
                // Temporarily store detailed data on the element to be picked up by processAndSaveRow
                targetCell.dataset.nofees = nofees;
                targetCell.dataset.value = value;
                targetCell.dataset.contrib = contrib;
                processAndSaveRow(targetRow);
            }
            closeQuarterlyModal();
        }

        function processAndSaveRow(rowElement) {
            // Part 1: Update UI totals
            let totalComp = 0;
            for (let i = 1; i <= 4; i++) {
                const cell = rowElement.querySelector(`td[data-quarter='${i}']`);
                totalComp += parseFloat(cell.textContent.replace(',', '.')) || 0;
            }

            const discountInput = rowElement.querySelector('.discount-input');
            let discount = parseFloat(discountInput.value) || 0;
            if (discountInput.value !== discount.toFixed(2)) {
                discountInput.value = discount.toFixed(2);
            }

            const netPayable = totalComp - discount;
            rowElement.querySelector('.total-comp-cell').textContent = formatCurrency(totalComp);
            rowElement.querySelector('.net-payable-cell').textContent = formatCurrency(netPayable);

            // Part 2: Find or create data object and save
            const beneficiaryId = parseInt(rowElement.dataset.beneficiaryId);
            let compData = compensations.find(c => c.beneficiaryId === beneficiaryId);
            if (!compData) {
                compData = { beneficiaryId, q1:{}, q2:{}, q3:{}, q4:{}, discount: 0, netPayable: 0 };
                compensations.push(compData);
            }

            for(let i=1; i<=4; i++) {
                const cell = rowElement.querySelector(`td[data-quarter='${i}']`);
                compData[`q${i}`] = {
                    nofees: parseFloat(cell.dataset.nofees) || compData[`q${i}`]?.nofees || 0,
                    value: parseFloat(cell.dataset.value) || compData[`q${i}`]?.value || 0,
                    contrib: parseFloat(cell.dataset.contrib) || compData[`q${i}`]?.contrib || 0,
                    calculated: parseFloat(cell.textContent.replace(',', '.')) || 0
                };
                // Clean up temporary data attributes
                delete cell.dataset.nofees;
                delete cell.dataset.value;
                delete cell.dataset.contrib;
            }
            
            compData.discount = discount;
            compData.netPayable = totalComp - compData.discount;

            saveData();

            // Part 3: Update row status
            rowElement.classList.remove('is-dirty');
            const statusBadge = rowElement.querySelector('.status-badge');
            statusBadge.className = 'status-badge saved';
            statusBadge.textContent = 'محفوظ';
        }

        // --- Reporting & Export ---
        function generateReportHTML(forPrint = false) {
            const reportData = compensations.map(comp => {
                const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                return b ? { ...comp, name: b.name, meter: b.meter, rip: calculateRIP(b.account), id: b.id } : null;
            }).filter(Boolean).sort((a,b) => a.id - b.id);
            
            const totalNetPayable = reportData.reduce((sum, item) => sum + item.netPayable, 0);
            
            return `
                <div class="report-header" style="text-align: center; margin-bottom: 20px;">
                    <p>${institutionInfo.republic}</p><p>${institutionInfo.ministry}</p>
                    <p>${institutionInfo.directorate}</p><p>${institutionInfo.institution}</p>
                    <p>السنة المالية: ${institutionInfo.fiscalYear}</p>
                    <h3 style="margin-top: 20px;">الجدول التفصيلي للمستفيدين من تعويض استهلاك الكهرباء و الغاز</h3>
                </div>
                <table><thead><tr>
                    <th>الرقم</th><th>اسم المستفيد</th><th>رقم العداد</th><th>رقم RIP الكامل</th>
                    <th>تعويض ث 1</th><th>تعويض ث 2</th><th>تعويض ث 3</th><th>تعويض ث 4</th>
                    <th>الخصم</th><th>الصافي للدفع</th>
                </tr></thead><tbody>
                    ${reportData.map(item => `
                        <tr>
                            <td>${item.id}</td><td>${item.name}</td><td>${item.meter}</td><td>${item.rip}</td>
                            <td>${formatCurrency(item.q1.calculated)}</td><td>${formatCurrency(item.q2.calculated)}</td>
                            <td>${formatCurrency(item.q3.calculated)}</td><td>${formatCurrency(item.q4.calculated)}</td>
                            <td>${formatCurrency(item.discount)}</td><td>${formatCurrency(item.netPayable)}</td>
                        </tr>`).join('')}
                    <tr class="total-row">
                        <td colspan="8">المجموع</td>
                        <td>${formatCurrency(reportData.reduce((sum, item) => sum + item.discount, 0))}</td>
                        <td>${formatCurrency(totalNetPayable)}</td>
                    </tr>
                </tbody></table>
                <div class="report-footer" style="text-align: right; margin-top: 20px;">
                    <p>أوقف الجدول على مجموع مستفيدين قدره: ${reportData.length}</p>
                    <p>أوقف الجدول على مجموع كلي بالأرقام: ${formatCurrency(totalNetPayable)} دج</p>
                    <p>أوقف الجدول على مجموع كلي بالأحرف: ${numberToArabicText(totalNetPayable)}</p>
                    ${forPrint ? `<div style="display: flex; justify-content: space-around; margin-top: 40px;"><p>المدير</p><p>المسير المالي</p></div>` : ''}
                </div>`;
        }

        function generateReportPreview() {
            document.getElementById('report-preview').innerHTML = generateReportHTML(false);
        }

        function printReport() {
            const printContent = document.getElementById('print-report-content');
            printContent.innerHTML = generateReportHTML(true);
            window.print();
        }

        function exportXLSX() {
            const exportData = compensations.map(comp => {
                 const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                 if (!b) return null;
                 return {
                    "الرقم": b.id, "اسم المستفيد": b.name, "رقم العداد": b.meter, "رقم RIP الكامل": calculateRIP(b.account),
                    "تعويض ث 1": comp.q1.calculated, "تعويض ث 2": comp.q2.calculated, "تعويض ث 3": comp.q3.calculated, "تعويض ث 4": comp.q4.calculated,
                    "الخصم": comp.discount, "الصافي للدفع": comp.netPayable
                 };
            }).filter(Boolean).sort((a,b) => a["الرقم"] - b["الرقم"]);
            if (exportData.length === 0) return alert("لا توجد بيانات للتصدير.");

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "تقرير التعويضات");
            XLSX.writeFile(wb, `تقرير_التعويضات_${institutionInfo.fiscalYear}.xlsx`);
        }

        function exportTxt() {
            let validRecords = [];
            let totalRoundedNetPayable = 0;

            compensations.forEach(comp => {
                const b = beneficiaries.find(ben => ben.id === comp.beneficiaryId);
                const rip = b ? calculateRIP(b.account) : 'error';
                if (b && !rip.includes('خطأ') && /^[a-zA-Z\s\-]+$/.test(b.name)) {
                    const netPayableRounded = Math.round(comp.netPayable * 100) / 100;
                    totalRoundedNetPayable += netPayableRounded;
                    const amountCents = String(Math.round(netPayableRounded * 100)).padStart(13, '0');
                    const namePadded = (b.name + ' '.repeat(27)).substring(0, 27);
                    validRecords.push(`*${rip}${amountCents}${namePadded}1`);
                }
            });

            const treasuryRIP = calculateRIP(institutionInfo.treasuryAccount);
            if (treasuryRIP.includes('خطأ')) return alert('خطأ في حساب RIP الخاص بالخزينة. يرجى التحقق من معلومات المؤسسة.');

            const totalAmountCents = String(Math.round(totalRoundedNetPayable * 100)).padStart(13, '0');
            const recordCount = String(validRecords.length).padStart(7, '0');
            const month = String(institutionInfo.financialMonth).padStart(2, '0');
            const year = String(institutionInfo.fiscalYear).padStart(4, '0');
            const order = String(institutionInfo.orderNumber).padStart(8, '0');
            const transfer = String(institutionInfo.transferNumber).padStart(6, '0');
            const header = `*${treasuryRIP}${totalAmountCents}${recordCount}${month}${year}${order}${transfer}0`;
            
            if (header.length !== 62) return alert('خطأ في توليد السطر الأول للملف. تحقق من معلومات المؤسسة.');

            const txtContent = [header, ...validRecords].join('\n');
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Payment_File_${institutionInfo.fiscalYear}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Backup and Restore ---
        function createBackup() {
            const backupData = { institutionInfo, beneficiaries, compensations };
            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const now = new Date();
            const filename = `CompData_Backup_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.json`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function restoreBackup() {
            document.getElementById('restore-file-input').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.json')) return alert('الرجاء اختيار ملف JSON صالح.');
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.institutionInfo && data.beneficiaries && data.compensations) {
                        if (confirm('هل أنت متأكد من استعادة هذه البيانات؟ سيتم الكتابة فوق البيانات الحالية.')) {
                            localStorage.setItem('institutionInfo', JSON.stringify(data.institutionInfo));
                            localStorage.setItem('beneficiaries', JSON.stringify(data.beneficiaries));
                            localStorage.setItem('compensations', JSON.stringify(data.compensations));
                            location.reload();
                        }
                    } else { alert('ملف النسخة الاحتياطية غير صالح.'); }
                } catch (err) { alert('خطأ في قراءة الملف.'); }
            };
            reader.readAsText(file);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            showSection('institution-info-section');

            // Main forms
            document.getElementById('institution-info-form').addEventListener('submit', saveInstitutionInfo);
            document.getElementById('beneficiary-form').addEventListener('submit', saveBeneficiary);
            document.getElementById('restore-file-input').addEventListener('change', handleFileSelect);
            
            // Compensation Grid Listeners
            document.getElementById('add-beneficiary-btn').addEventListener('click', () => openBeneficiaryModal());
            document.getElementById('compensation-grid-search').addEventListener('input', e => renderCompensationGrid(e.target.value));
            document.getElementById('quarterly-details-form').addEventListener('submit', handleQuarterlyFormSubmit);

            // Event delegation for the compensation grid
            const gridBody = document.querySelector('#compensation-grid-table tbody');
            gridBody.addEventListener('click', (e) => {
                const editableCell = e.target.closest('.editable-cell');
                if (editableCell) {
                    const row = editableCell.closest('tr');
                    const beneficiaryId = parseInt(row.dataset.beneficiaryId);
                    const quarterIndex = parseInt(editableCell.dataset.quarter);
                    openQuarterlyModal(beneficiaryId, quarterIndex);
                }
            });
            gridBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('discount-input')) {
                     const row = e.target.closest('tr');
                     processAndSaveRow(row);
                }
            });
        });
    </script>
</body>
</html>
