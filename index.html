<style>
/* تحسين خلفية الصفحة وتظليل الحواف */
body {
    background: linear-gradient(135deg, #e3f0fa 0%, #f8fbff 100%) fixed;
    min-height: 100vh;
    font-family: 'Cairo', Tahoma, Arial, sans-serif;
    color: #212529;
.container {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 2px 18px #b6d4fe33, 0 1.5px 0 #e3f0fa;
    padding: 8px 6px 10px 6px;
    margin-top: 6px;
    margin-bottom: 6px;
    max-width: 900px;
    width: 100%;
header h1 {
    font-size: 1.35em;
    color: #1976d2;
    letter-spacing: 1px;
    font-weight: 800;
    margin-bottom: 4px;
    text-shadow: 0 1px 0 #fff, 0 2px 8px #b6d4fe22;
    text-align: center;
    width: 100%;
}
.tab-content {
    background: #fafdff;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 1px 8px #b6d4fe22;
    padding: 6px 4px 6px 4px;
}
.form-group label {
    color: #1976d2;
    font-size: 0.97em;
    font-weight: 600;
    text-align: center;
    width: 100%;
}
.form-group input[type="text"],
.form-group input[type="number"],
.form-group input[type="date"],
.form-group select {
    font-size: 0.97em;
    padding: 3px 7px;
    min-height: 21px;
    height: 21px;
    border-radius: 6px;
    border: 1.2px solid #b6d4fe;
    background: #fafdff;
    box-shadow: 0 1px 2px #b6d4fe22;
    margin-bottom: 1px;
    transition: border-color 0.18s, box-shadow 0.18s;
    text-align: center;
}
.form-group input[type="text"]:focus,
.form-group input[type="number"]:focus,
.form-group input[type="date"]:focus,
.form-group select:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 2px #2196f344;
    background: #e3f2fd;
}
.form-group input[type="text"]:hover,
.form-group input[type="number"]:hover,
.form-group input[type="date"]:hover,
.form-group select:hover {
    border-color: #1976d2;
}
button {
    font-size: 0.97em;
    padding: 4px 11px;
    min-height: 22px;
    border-radius: 6px;
    background: linear-gradient(90deg, #1976d2 0%, #43cea2 100%);
    color: #fff;
    border: none;
    box-shadow: 0 2px 8px #b6d4fe33, 0 1.5px 0 #e3f0fa;
    text-shadow: 0 1px 2px #0007, 0 0px 1px #fff2;
    transition: background 0.18s, box-shadow 0.18s, transform 0.1s;
    letter-spacing: 0.5px;
}
button:hover {
    background: linear-gradient(90deg, #185a9d 0%, #43cea2 100%);
    color: #fff;
    box-shadow: 0 4px 16px #185a9d44;
    text-shadow: 0 1px 2px #000a, 0 0px 1px #fff2;
}
button:active {
    transform: scale(0.97);
    box-shadow: 0 1px 2px #2196f322;
}
button:focus-visible {
    outline: 2px solid #1976d2;
    outline-offset: 2px;
}
.validation-feedback {
    font-size: 0.85em;
    margin-top: 1px;
    margin-bottom: 2px;
    color: #dc3545;
}
.tab-panel, .nested-tab-panel, #backup-panel {
    background: #fafdff;
    border-radius: 12px;
    box-shadow: 0 1px 8px #b6d4fe22;
}
.explanation {
    background: #f3f7fa;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 0.92em;
}
::-webkit-scrollbar {
    width: 7px;
    background: #e3f2fd;
}
::-webkit-scrollbar-thumb {
    background: #b6d4fe;
    border-radius: 6px;
}
::selection {
    background: #b6d4fe44;
}
</style>
<script>
// --- Beneficiary Search Logic ---
document.addEventListener('DOMContentLoaded', function() {
    let beneficiarySearchTerm = '';
    if (typeof window.currentBeneficiaryFilterType === 'undefined') {
        window.currentBeneficiaryFilterType = 'all';
    }
    const beneficiarySearchInput = document.getElementById('beneficiary-search-input');
    const beneficiarySearchClear = document.getElementById('beneficiary-search-clear');
    const beneficiaryFilterButtons = document.getElementById('beneficiary-filter-buttons');

    function applyBeneficiarySearchAndFilter() {
        let filteredList = Array.isArray(window.beneficiaries) ? [...window.beneficiaries] : [];
        if (typeof window.currentBeneficiaryFilterType !== 'undefined' && window.currentBeneficiaryFilterType !== 'all') {
            filteredList = filteredList.filter(b => b.compensation && b.compensation.type === window.currentBeneficiaryFilterType);
        }
        if (beneficiarySearchTerm.length > 0) {
            const term = beneficiarySearchTerm.toLowerCase();
            filteredList = filteredList.filter(b =>
                (b.lastName && b.lastName.toLowerCase().includes(term)) ||
                (b.firstName && b.firstName.toLowerCase().includes(term)) ||
                (b.ssNum && b.ssNum.includes(term))
            );
        }
        if (typeof window.renderBeneficiariesTable === 'function') {
            window.renderBeneficiariesTable(filteredList);
        }
    }

    if (beneficiarySearchInput) {
        beneficiarySearchInput.addEventListener('input', function() {
            beneficiarySearchTerm = this.value.trim();
            if (beneficiarySearchTerm.length > 0) {
                beneficiarySearchClear.style.display = '';
            } else {
                beneficiarySearchClear.style.display = 'none';
            }
            applyBeneficiarySearchAndFilter();
        });
    }
    if (beneficiarySearchClear) {
        beneficiarySearchClear.addEventListener('click', function() {
            beneficiarySearchInput.value = '';
            beneficiarySearchTerm = '';
            beneficiarySearchClear.style.display = 'none';
            applyBeneficiarySearchAndFilter();
            beneficiarySearchInput.focus();
        });
    }
    if (beneficiaryFilterButtons) {
        beneficiaryFilterButtons.addEventListener('click', function(e) {
            if (e.target.closest('button')) {
                setTimeout(applyBeneficiarySearchAndFilter, 0);
            }
        });
    }

    window.applyBeneficiaryFilter = function(filterType) {
        window.currentBeneficiaryFilterType = filterType;
        applyBeneficiarySearchAndFilter();
        document.querySelectorAll('#beneficiary-filter-buttons button').forEach(button => {
            button.classList.toggle('active', button.getAttribute('data-filter-type') === filterType);
        });
    };

    // التصفية التلقائية عند تحميل الصفحة لأول مرة
    applyBeneficiarySearchAndFilter();
});
</script>
</script>
</script>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج تسيير مستحقات  مركز  امتحان اثبات المستوى</title>
     <!-- Include SheetJS library for XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Optional: Include a Google Font for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* تحسينات جمالية إضافية للواجهة */
        html, body {
            font-size: 13px;
            background: linear-gradient(135deg, #e3f0fa 0%, #f8fbff 100%);
            height: 100%;
        }
        body {
            box-shadow: 0 0 0 1px #e0e7ef inset;
            min-height: 100vh;
            /* تم إلغاء التوسيط العمودي والأفقي للعناصر */
        }
        .container {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 18px #b6d4fe33, 0 1.5px 0 #e3f0fa;
            padding: 18px 12px 24px 12px;
            margin-top: 18px;
            margin-bottom: 18px;
            max-width: 900px;
            width: 100%;
            /* تم إلغاء display:flex والتوسيط */
        }
        header h1 {
            font-size: 1.25em;
            color: #1976d2;
            letter-spacing: 1px;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 1px 0 #fff, 0 2px 8px #b6d4fe22;
            text-align: center;
            width: 100%;
        }
        .tabs {
            background: #fafdff;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 1px 4px #b6d4fe22;
            padding: 2px 0 2px 0;
            display: block;
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-color: #b6d4fe #e3f2fd;
            scrollbar-width: thin;
        }
        .tab-button {
            font-size: 0.98em;
            padding: 6px 13px;
            border-radius: 7px 7px 0 0;
            margin: 0 2px;
            background: none;
            color: #1976d2;
            border: none;
            transition: background 0.18s, color 0.18s;
            display: inline-block;
            min-width: 120px;
            text-align: center;
        }
        .tab-button.active, .tab-button:focus {
            background: linear-gradient(90deg, #e3f2fd 60%, #fff 100%);
            color: #004085;
            font-weight: 700;
            box-shadow: 0 2px 8px #b6d4fe22;
            z-index: 2;
        }
        .tab-button:hover {
            background: #e3f2fd;
            color: #0056b3;
            z-index: 2;
        /* تخصيص شريط التمرير الأفقي للتبويبات */
        }
        .tabs::-webkit-scrollbar {
            height: 7px;
            background: #e3f2fd;
        }
        .tabs::-webkit-scrollbar-thumb {
            background: #b6d4fe;
            border-radius: 6px;
        }
        }
        .tab-content {
            background: #fafdff;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 1px 8px #b6d4fe22;
            padding: 18px 10px 10px 10px;
            /* تم إلغاء display:flex والتوسيط */
        }
        .form-group label {
            color: #1976d2;
            font-size: 0.92em;
            font-weight: 600;
            text-align: center;
            width: 100%;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            font-size: 0.92em;
            padding: 3px 7px;
            min-height: 21px;
            height: 21px;
            border-radius: 6px;
            border: 1.2px solid #b6d4fe;
            background: #fafdff;
            box-shadow: 0 1px 2px #b6d4fe22;
            margin-bottom: 2px;
            transition: border-color 0.18s, box-shadow 0.18s;
            text-align: center;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 2px #2196f344;
            background: #e3f2fd;
        }
        .form-group input[type="text"]:hover,
        .form-group input[type="number"]:hover,
        .form-group input[type="date"]:hover,
        .form-group select:hover {
            border-color: #1976d2;
        }
        button {
            font-size: 0.95em;
            padding: 4px 11px;
            min-height: 22px;
            border-radius: 6px;
            background: linear-gradient(90deg, #1976d2 0%, #43cea2 100%);
            color: #fff;
            border: none;
            box-shadow: 0 2px 8px #1976d233, 0 1.5px 0 #e3f0fa;
            text-shadow: 0 1px 2px #0007, 0 0px 1px #fff2;
            transition: background 0.18s, box-shadow 0.18s, transform 0.1s;
            letter-spacing: 0.5px;
        }
        button:hover {
            background: linear-gradient(90deg, #185a9d 0%, #43cea2 100%);
            color: #fff;
            box-shadow: 0 4px 16px #185a9d44;
            text-shadow: 0 1px 2px #000a, 0 0px 1px #fff2;
        }
        button:active {
            transform: scale(0.97);
            box-shadow: 0 1px 2px #2196f322;
        }
        button:focus-visible {
            outline: 2px solid #1976d2;
            outline-offset: 2px;
        }
        .modal-content {
            background: #fafdff;
            border-radius: 14px;
            box-shadow: 0 2px 18px #b6d4fe33;
            padding: 18px 10px 10px 10px;
            max-width: 420px;
        }
        .validation-feedback {
            font-size: 0.80em;
            margin-top: 1px;
            margin-bottom: 2px;
            color: #dc3545;
        }
        .tab-panel, .nested-tab-panel, #backup-panel {
            background: #fafdff;
            border-radius: 12px;
            box-shadow: 0 1px 8px #b6d4fe22;
            /* تم إلغاء display:flex والتوسيط */
        }
        .explanation {
            background: #f3f7fa;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.90em;
            /* تم إلغاء text-align: center; */
        }
        .filter-buttons button {
            font-size: 0.90em;
            padding: 2px 7px;
            min-height: 18px;
        }
        table th, table td {
            font-size: 0.91em;
            padding: 4px 6px;
            text-align: center;
        }
        table {
            border-radius: 10px;
            box-shadow: 0 1px 8px #b6d4fe22;
            margin-left: auto;
            margin-right: auto;
        }
        /* تحسينات على شريط التمرير */
        ::-webkit-scrollbar {
            width: 7px;
            background: #e3f2fd;
        }
        ::-webkit-scrollbar-thumb {
            background: #b6d4fe;
            border-radius: 6px;
        }
        ::selection {
            background: #b6d4fe44;
        }
        /* --- CSS Variables (from your provided file, adjusted) --- */
        :root {
            /* Colors */
            --primary-color: #0056b3;       /* Darker Blue */
            --primary-dark-color: #004085;  /* Even Darker Blue */
            --secondary-color: #6c757d;     /* Bootstrap Grey */
            --success-color: #28a745;       /* Bootstrap Green */
            --danger-color: #dc3545;       /* Bootstrap Red */
            --warning-color: #ffc107;       /* Bootstrap Yellow */
            --info-color: #17a2b8;         /* Bootstrap Cyan */
            --light-color: #f8f9fa;         /* Bootstrap Light Grey */
            --dark-color: #343a40;          /* Bootstrap Dark Grey */
            --background-light: #eef2f7;   /* Light background */
            --background-white: #fff;    /* White background */
            --background-section: #f8f9fa;  /* Light section background */
            --border-color: #ced4da;       /* Bootstrap Border Grey */
            --border-light-color: #dee2e6; /* Lighter Border Grey */
            --text-color: #212529;         /* Bootstrap Dark Text */
            --text-secondary-color: #6c757d; /* Bootstrap Muted Text */

            /* Spacing */
            --space-xs: 5px;
            --space-sm: 10px;
            --space-md: 20px;
            --space-lg: 30px;
            --space-xl: 40px;

            /* Typography */
            --font-family: 'Cairo', sans-serif; /* Use Cairo */
            --font-size-base: 1em;
            --font-size-h1: 2.5em; /* Slightly larger */
            --font-size-h2: 2em;
            --font-size-h3: 1.5em;
            --font-size-h4: 1.2em;

            /* Borders */
            --border-radius-sm: 4px; /* Adjusted */
            --border-radius-md: 8px; /* Adjusted */
            --border-radius-lg: 25px;
            --border-radius-xl: 30px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 6px 12px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.2);
            --shadow-inset: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }


        /* --- General Styles --- */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: var(--space-md);
            background-color: var(--background-light);
            direction: rtl;
            text-align: right;
            line-height: 1.6;
            color: var(--text-color);
            min-height: 100vh;
            box-sizing: border-box;
             background-image: linear-gradient(to bottom right, #c3e6f4, #a5d8f3, #8acbe9); /* Adjusted gradient */
            background-attachment: fixed;
        }

         .container {
             max-width: 1200px;
             margin: 20px auto;
             padding: 0 20px;
         }

         h2, h3 {
             color: var(--primary-dark-color);
             border-bottom: 2px solid var(--border-light-color);
             padding-bottom: var(--space-sm);
             margin-bottom: var(--space-lg);
             font-weight: 700;
             text-align: right;
         }
         h2 { font-size: var(--font-size-h2); }
         h3 { font-size: var(--font-size-h3); }

         /* Titles within sections */
         .app-section h3 {
              border-bottom: 1px solid var(--border-light-color); /* Lighter border for sub-titles */
              margin-top: var(--space-lg); /* Space above sub-titles */
         }


         /* --- Tabbed Interface Styles --- */
         .tabs {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: var(--space-md);
             flex-wrap: wrap;
             background-color: var(--background-white); /* Background for the tab bar */
             border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
             box-shadow: var(--shadow-sm);
         }

         .tab-button {
             background-color: transparent; /* No background for inactive */
             border: none; /* No border */
             border-bottom: 2px solid transparent; /* Underline for active */
             padding: 15px 20px;
             cursor: pointer;
             margin-left: 5px;
             transition: color 0.3s ease, border-bottom-color 0.3s ease;
             font-size: 1rem;
             color: var(--text-secondary-color);
             font-family: var(--font-family);
             font-weight: 600;
         }

         .tab-button:hover {
             color: var(--primary-color);
             border-bottom-color: var(--border-light-color);
         }

         .tab-button.active {
             color: var(--primary-dark-color);
             border-bottom-color: var(--primary-dark-color); /* Active tab underline */
             font-weight: 700;
         }

         .tab-content {
             background-color: var(--background-white);
             padding: var(--space-lg);
             border: 1px solid var(--border-color);
             border-top: none; /* Hide top border to connect visually with tabs */
             border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
             box-shadow: var(--shadow-md);
         }

         .tab-panel {
             display: none; /* Hide all panels by default */
         }

         .tab-panel.active {
             display: block; /* Show the active panel */
         }

         /* Nested Tabs (for Compensation Reports) */
         .nested-tabs {
             display: flex;
             border-bottom: 1px solid var(--border-color); /* Lighter border */
             margin-bottom: var(--space-md);
             flex-wrap: wrap;
             margin-top: var(--space-md); /* Space above nested tabs */
             padding-top: var(--space-sm); /* Padding inside */
         }

         .nested-tab-button {
              background-color: transparent;
              border: none;
              border-bottom: 2px solid transparent;
              padding: 10px 15px; /* Smaller padding */
              cursor: pointer;
              margin-left: 5px;
              transition: color 0.3s ease, border-bottom-color 0.3s ease;
              font-size: 0.95rem; /* Smaller font */
              color: var(--text-secondary-color);
              font-family: var(--font-family);
              font-weight: 500; /* Lighter weight */
         }
          .nested-tab-button:hover {
              color: var(--primary-color);
              border-bottom-color: var(--border-light-color);
          }
           .nested-tab-button.active {
               color: var(--primary-dark-color);
               border-bottom-color: var(--primary-dark-color);
               font-weight: 600;
           }



         .nested-tab-panel {
             display: none; /* Hide all nested panels */
             padding-top: var(--space-md); /* Add padding inside nested panels */
         }
          .nested-tab-panel.active {
              display: block; /* Show active nested panel */
          }


         /* --- Form Styles (Adapted from your file) --- */
         .form-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
              gap: var(--space-md); /* Space between grid items */
              margin-bottom: var(--space-lg); /* Space after the grid */
         }

          /* Specific layout for the add beneficiary form (includes comp inputs now) */
          #beneficiary-panel #add-beneficiary-form .form-grid {
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Adjust min-width */
              gap: var(--space-md);
          }


         .form-group {
             margin-bottom: var(--space-md); /* Added margin-bottom */
             overflow: visible;
         }
         /* Remove bottom margin for form groups within a grid */
         .form-grid .form-group {
             margin-bottom: 0;
         }


         .form-group label {
             display: block;
             margin-bottom: var(--space-sm);
             font-weight: 600; /* Adjusted */
             color: var(--text-secondary-color);
             font-size: var(--font-size-base);
         }

         .form-group input[type="text"],
         .form-group input[type="number"],
         .form-group input[type="date"], /* Style for date input */
         .form-group select {
             width: 100%;
             padding: 12px; /* Adjusted padding */
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius-sm);
             box-sizing: border-box;
             text-align: right;
             font-size: var(--font-size-base);
             transition: border-color 0.2s ease, box-shadow 0.2s ease;
             background-color: var(--background-white);
         }

         .form-group input[type="text"]:focus,
         .form-group input[type="number"]:focus,
         .form-group input[type="date"]:focus,
         .form-group select:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* Use a standard focus shadow */
             outline: none;
             background-color: var(--light-color); /* Light background on focus */
         }

         /* Style for readonly inputs */
         .form-group input[readonly] {
             background-color: var(--background-section); /* Light background for readonly */
             cursor: not-allowed;
             border-color: var(--border-light-color);
         }


         /* Style for invalid input */
         input.invalid {
             border-color: var(--danger-color) !important; /* Red border for invalid input */
         }
          input.invalid:focus {
             box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25); /* Red shadow on focus */
          }
          .validation-feedback {
              color: var(--danger-color); /* Red text for feedback */
              font-size: 0.875em; /* Smaller font size */
              margin-top: var(--space-xs); /* Space above */
              display: block; /* Ensure it takes its own line */
              min-height: 1.2em; /* Reserve space even when empty */
          }

          /* Hide specific calculated form groups in the beneficiary panel forms */
          /* Hide based on the element's ID pattern */
          /* Removed observations group */
          #beneficiary-panel .form-group[id^='add-'][id$='-taux-group'],
          #beneficiary-panel .form-group[id^='add-'][id$='-brut-group'],
          #beneficiary-panel .form-group[id^='add-'][id$='-ss-group'],
          #beneficiary-panel .form-group[id^='add-'][id$='-irg-group'],
          #beneficiary-panel .form-group[id^='add-'][id$='-net-group'] {
              display: none;
          }
           /* Hide specific calculated form groups in the edit modal forms */
           /* Removed observations group */
          .modal-content .form-group[id^='edit-'][id$='-taux-group'],
          .modal-content .form-group[id^='edit-'][id$='-brut-group'],
          .modal-content .form-group[id^='edit-'][id$='-ss-group'],
          .modal-content .form-group[id^='edit-'][id$='-irg-group'],
          .modal-content .form-group[id^='edit-'][id$='-net-group'] {
              display: none;
          }


         /* Styles for filter buttons */
         .filter-buttons {
             margin-bottom: var(--space-md);
             display: flex;
             flex-wrap: wrap;
             gap: var(--space-sm);
             align-items: center;
         }
          .filter-buttons button {
              padding: 8px 15px;
              font-size: 0.9em;
              background-color: var(--light-color); /* Greyish background */
              color: var(--dark-color); /* Dark text */
              border: 1px solid var(--border-color);
              border-radius: var(--border-radius-sm);
              box-shadow: none; /* Remove shadow for a flatter look */
          }
          .filter-buttons button:hover {
               background-color: var(--border-light-color); /* Slightly darker on hover */
               transform: none; /* No translateY on hover */
               box-shadow: none;
          }
           .filter-buttons button.active {
              background-color: var(--primary-color); /* Primary color background */
              color: white; /* White text */
              border-color: var(--primary-dark-color);
              font-weight: 600;
          }
          .filter-buttons button:active { transform: none; } /* No push down effect */


        /* --- Button Styles (Adapted from your file) --- */
        button {
            display: inline-flex; /* Use flex for icon/text alignment */
            align-items: center;
            gap: var(--space-xs);
            padding: 10px 20px; /* Default padding */
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: var(--shadow-sm);
             font-family: var(--font-family);
             font-weight: 600;
             color: white; /* Default text color */
             background-color: var(--primary-color); /* Default background */
        }

         button:hover {
             transform: translateY(-1px);
              box-shadow: var(--shadow-md);
         }
          button:active {
              transform: translateY(0);
              box-shadow: var(--shadow-sm);
          }
           button i { font-size: 1.1em; /* Icon size */ }


         /* Specific Button Styles */
        form button[type="submit"]:not(.modal-buttons button) {
            padding: 14px 30px;
            background: linear-gradient(90deg, #28a745 0%, #43cea2 100%); /* Green gradient */
            color: #fff;
            text-shadow: 0 1px 2px #0008, 0 0px 1px #fff2;
            border-radius: var(--border-radius-xl); /* Rounded */
            font-size: 1.1em;
            font-weight: 700;
            margin-top: var(--space-lg);
            display: block; /* Make form submit button block level */
            width: 100%;
            box-sizing: border-box; /* Include padding/border in width */
        }
         form button[type="submit"]:not(.modal-buttons button):hover { background-color: #218838; }
         form button[type="submit"]:not(.modal-buttons button):hover {
            background: linear-gradient(90deg, #218838 0%, #43cea2 100%);
            color: #fff;
            text-shadow: 0 1px 2px #000a, 0 0px 1px #fff2;
        }


        .delete-btn {
            background: linear-gradient(90deg, #ff5858 0%, #f857a6 100%);
            color: #fff;
            padding: 8px 15px;
            font-size: 0.95em;
            border-radius: var(--border-radius-sm);
            border: none;
            box-shadow: 0 2px 8px #f857a633;
            transition: background 0.18s, box-shadow 0.18s;
        }
        .delete-btn:hover {
            background: linear-gradient(90deg, #f857a6 0%, #ff5858 100%);
            color: #fff;
            box-shadow: 0 4px 16px #f857a644;
        }

        .edit-btn {
            background: linear-gradient(90deg, #f7971e 0%, #ffd200 100%);
            color: #333;
            padding: 8px 15px;
            font-size: 0.95em;
            border-radius: var(--border-radius-sm);
            border: none;
            box-shadow: 0 2px 8px #ffd20033;
            transition: background 0.18s, box-shadow 0.18s;
        }
        .edit-btn:hover {
            background: linear-gradient(90deg, #ffd200 0%, #f7971e 100%);
            color: #222;
            box-shadow: 0 4px 16px #ffd20044;
        }


        /* Backup/Restore buttons */
        #backup-panel .button-group button {
            background: linear-gradient(90deg, #1976d2 0%, #43cea2 100%);
            color: #fff;
            text-shadow: 0 1px 2px #0006, 0 0px 1px #fff2;
            padding: 8px 18px;
            font-size: 1em;
            border-radius: 7px;
            border: none;
            margin-left: var(--space-sm);
            box-shadow: 0 2px 8px #43cea233;
            transition: background 0.18s, box-shadow 0.18s;
        }
        #backup-panel .button-group button:hover {
            background: linear-gradient(90deg, #185a9d 0%, #43cea2 100%);
            color: #fff;
            box-shadow: 0 4px 16px #185a9d44;
            text-shadow: 0 1px 2px #0008, 0 0px 1px #fff2;
        }

        #backup-panel .explanation {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: var(--space-sm);
        }
         #backup-panel .button-group {
             display: flex;
             align-items: center;
             gap: var(--space-sm);
         }


         /* Report/Export buttons within Compensation Report Tabs */
         .nested-tab-panel .reporting-buttons {
             text-align: center; /* Center buttons */
             margin-bottom: var(--space-lg); /* Space below buttons */
         }
         .nested-tab-panel .reporting-buttons button {
             background-color: var(--success-color); /* Using success color */
             padding: 14px 30px;
             border-radius: var(--border-radius-xl);
             font-size: 1.1em;
             font-weight: 700;
             margin: 0 var(--space-sm); /* Space between buttons */
              width: auto; /* Allow auto width */
              display: inline-flex; /* Ensure inline-flex */
         }
          .nested-tab-panel .reporting-buttons button:hover { background-color: #218838; }

         /* Style for disabled button */
          .nested-tab-panel .reporting-buttons button:disabled {
              background-color: #cccccc;
              cursor: not-allowed;
              transform: none;
              box-shadow: none;
              gap: var(--space-xs);
          }
           .nested-tab-panel .reporting-buttons button i { font-size: 1.2em; }

          /* Add margin-top to the explanation text */
           .nested-tab-panel .explanation {
             margin-top: var(--space-sm);
             font-size: 0.85em;
             color: var(--text-secondary-color);
             text-align: right; /* Align explanation right */
         }

        /* Style for the custom report text group */
        .nested-tab-panel .custom-text-group {
             margin-bottom: var(--space-md);
             padding: var(--space-md);
             background-color: var(--background-section);
             border-radius: var(--border-radius-sm);
        }
         .nested-tab-panel .custom-text-group label {
              color: var(--dark-color);
         }
         /* Style for the custom report text input to match institution inputs */
         .nested-tab-panel .custom-text-group input[type="text"] {
             width: 100%;
             padding: 12px;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius-sm);
             box-sizing: border-box;
             font-size: var(--font-size-base);
             transition: border-color 0.2s ease, box-shadow 0.2s ease;
             background-color: var(--background-white); /* Match standard input background */
             /* Optional: Add specific readonly-like appearance if needed */
             /* background-color: var(--background-section); */
             /* border-color: var(--border-light-color); */
         }
         .nested-tab-panel .custom-text-group input[type="text"]:focus {
              border-color: var(--primary-color);
              box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
              outline: none;
              background-color: var(--light-color);
         }

         /* New style for the global edit button - Only in beneficiary panel */
         #beneficiary-panel .edit-global-btn {
              margin-top: var(--space-lg); /* Add space above the button */
              width: auto; /* Allow auto width */
              display: block; /* Make it block to be on its own line */
              margin-right: auto; /* Center block button in RTL */
              margin-left: auto; /* Center block button in RTL */
              /* Match styles of other non-form-submit buttons, e.g., modal buttons */
              background-color: var(--secondary-color); /* Using secondary grey */
               color: white;
               padding: 10px 20px;
               border-radius: var(--border-radius-sm);
         }
          #beneficiary-panel .edit-global-btn:hover { background-color: #5a6268; transform: translateY(-1px); }
          #beneficiary-panel .edit-global-btn:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }


        /* --- Table Styles (Adapted from your file) --- */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 8px;
            box-shadow: 0 2px 12px #b6d4fe33, 0 1.5px 0 #e3f0fa;
            border-radius: 14px;
            overflow: hidden;
            background: #fafdff;
        }

        table th, table td {
            border-bottom: 1px solid #e3f0fa;
            padding: 7px 8px;
            text-align: center;
            font-size: 1em;
            vertical-align: middle;
        }
        table thead tr {
            border-bottom: 2px solid var(--border-color);
        }

        th {
            background: linear-gradient(90deg, #e3f2fd 0%, #b6d4fe 100%);
            font-weight: 700;
            color: #1976d2;
            border-bottom: 2px solid #b6d4fe;
        }
        /* Add right border to first column header in RTL */
        th:first-child { border-right: 1px solid var(--border-light-color); }
        /* Remove last-child border rule as Observations is gone */
        /* th:last-child { border-left: 1px solid var(--border-light-color); } */


         /* Style for the specific actions column in the beneficiary table */
         #beneficiaries-table th.actions-cell,
         #beneficiaries-table td.actions-cell {
              text-align: center; /* Center align actions */
              vertical-align: middle;
              border-left: 1px solid var(--border-light-color); /* Add left border to actions column */
         }


        tbody tr:nth-child(even) {
            background-color: #f7fbff;
        }
         tbody tr:hover {
             background-color: #e3f2fd;
         }


          /* Action buttons container within the actions cell */
         #beneficiaries-table td.actions-cell div {
             display: flex;
             justify-content: center;
             align-items: center;
             gap: var(--space-xs);
         }
          /* Remove individual button margin within the container */
          #beneficiaries-table td.actions-cell button { margin-left: 0; }
         #beneficiaries-table td.actions-cell button {
            margin-left: 0;
            min-width: 32px;
            min-height: 32px;
            font-size: 1em;
            border-radius: 7px;
         }
            /* تحسين مظهر الترويسة عند الطباعة */
        }
        @media print {
            #beneficiaries-table th, #beneficiaries-table td {
                font-size: 10pt !important;
                padding: 4px 6px !important;
                color: #000 !important;
                border: 1px solid #000 !important;
            }
            #beneficiaries-table th {
                background: #e3f2fd !important;
                color: #000 !important;
            }
            #beneficiaries-table tr {
                background: #fff !important;
            }
        }


        /* Report Output Styles */
        .report-output {
            margin-top: var(--space-md);
            padding: 0; /* Match print padding */
            border: none; /* Match print border */
            background-color: var(--background-white);
            border-radius: var(--border-radius-md);
            box-shadow: none; /* Match print shadow */
            font-size: 10pt; /* Match print font size */
            overflow-x: visible; /* Match print overflow */
        }

        .report-output table {
            width: 100%; /* Use 100% width */
            border-collapse: collapse;
            /* table-layout: fixed; *//* Match print table layout - disabling fixed for better preview width */
            border: 2px solid #000; /* Match print border */
            min-width: auto; /* Match print min-width */
            box-shadow: none;
        }
        .report-output th, .report-output td {
             font-size: 9pt; /* Match print font size */
             padding: 3px 5px; /* Match print padding */
             word-wrap: break-word; /* Allow breaking long words */
             white-space: normal; /* Allow wrapping */
             text-align: center; /* Default center alignment for report cells */
             border: 1px solid #000; /* Match print border */
             color: #000; /* Match print color */
        }
        .report-output th {
            background-color: #adb5bd; /* Grey header */
            font-weight: bold;
            color: var(--dark-color);
        }
        .report-output .report-header,
        .report-output .report-footer {
            margin-bottom: 15px; /* Match print margin */
            text-align: center;
        }
        .report-output .report-header p,
        .report-output .report-footer p {
            margin: 1px 0; /* Match print margin */
        }
        /* Specific styles for the simplified report header in preview */
        .report-output .report-header .header-inst-info p {
             font-size: 1.2em; /* Match print font size */
             font-weight: bold; /* Match print font weight */
             margin: 1px 0; /* Match print spacing */
             color: #000; /* Match print color */
             text-align: center; /* Match print alignment */
        }
         .report-output .report-header .header-custom-line {
             font-size: 1.8em; /* Even Larger font for print as requested */
             font-weight: bold; /* Bold as requested */
             margin-top: 15px; /* Match print spacing */
             margin-bottom: 20px; /* Space before table */
             color: #000; /* Match print color */
             text-align: center; /* Match print alignment */
         }


        .report-output .total-row th,
        .report-output .total-row td {
            font-weight: bold;
             background-color: #ced4da; /* Match print background */
             color: #000; /* Match print color */
        }

        /* --- Print Specific Styles --- */
        @media print {
             body {
                 padding: 0;
                 margin: 0;
                 background-color: white !important;
                 -webkit-print-color-adjust: exact !important;
                 print-color-adjust: exact !important;
                 font-family: 'Arial', sans-serif !important;
                 color: #000 !important;
             }

             .container, header, main, #report-preview, #ticker-container, .modal-overlay, .app-section:not(#print-report-content),
             .tabs, .tab-content, .tab-panel, .nested-tabs, .nested-tab-button, .nested-tab-content,
             .edit-global-btn /* Hide the global edit button */
              { /* Hide all app UI except print content */
                 display: none !important;
             }

#print-report-content {
                 display: block !important;
                 margin: 0;
                 padding: 1cm; /* Add padding for printing */
                 border: none !important;
                 box-shadow: none !important;
                 outline: none !important;
                 width: 100%;
                 box-sizing: border-box;
                 background-color: #ffffff !important;
                 overflow-x: visible; /* Ensure no scroll in print */
             }

             @page {
               size: landscape; /* Landscape orientation */
               margin: 1cm; /* Minimal margin */
             }

             #print-report-content .report-output { /* Style the content inside the print div */
                  padding: 0;
                  border: none !important;
                  box-shadow: none !important;
                  outline: none !important;
                  overflow-x: visible;
                  font-size: 10pt;
                  color: #000 !important;
                  background-color: #ffffff !important;
                  font-family: 'Arial', sans-serif !important;
                  width: 100%; /* Ensure it takes full print width */
             }

             #print-report-content .report-output .report-header {
                  text-align: center !important;
                  margin-bottom: 15px !important;
                  color: #000 !important;
             }
             #print-report-content .report-output .report-header .header-inst-info {
                 text-align: center !important;
                 margin-left: auto !important;
                 margin-right: auto !important;
                 width: auto !important;
                 display: inline-block !important;
             }
             #print-report-content .report-output .report-header .header-inst-info p {
                 font-size: 1.2em !important;
                 font-weight: 900 !important;
                 margin: 1px 0 !important;
                 color: #000 !important;
                 text-align: center !important;
                 margin-left: auto !important;
                 margin-right: auto !important;
                 letter-spacing: 0.5px !important;
                 font-family: 'Arial Black', Arial, sans-serif !important;
                 width: fit-content !important;
                 display: block !important;
             }
             #print-report-content .report-output .report-header .header-custom-line {
                 font-size: 1em !important;
                 font-weight: 500 !important;
                 margin-top: 6px !important;
                 margin-bottom: 8px !important;
                 color: #1976d2 !important;
                 text-align: center !important;
                 letter-spacing: 0.2px;
                 line-height: 1.2;
                 padding: 0;
             }


             #print-report-content .report-output table {
                 width: 100%; /* Table takes full width */
                 border-collapse: collapse;
                 border: 2px solid #000 !important; /* Stronger table border */
                 min-width: auto; /* Remove min-width for print */
                 page-break-inside: auto;
             }

             #print-report-content .report-output thead {
                 display: table-header-group;
             }

             #print-report-content .report-output th, #print-report-content .report-output td {
                 font-size: 8pt; /* Adjusted for readability */
                 padding: 3px 5px;
                 text-align: center; /* Default center */
                 border: 1px solid #000 !important;
                 color: #000 !important;
             }

              /* Print Specific Text Alignment for Reports Table (type-reports) */
              #print-report-content .report-output.type-reports td:first-child, /* N° */
              #print-report-content .report-output.type-reports th:first-child {
                   display: none !important; /* Explicitly hide N° in print */
               }
               #print-report-content .report-output.type-reports td:nth-child(2), /* اللقب و الاسم (combined) - now first visible */
               #print-report-content .report-output.type-reports th:nth-child(2) {
                 text-align: right !important; /* Align names right */
               }
               /* Numeric columns (Nbr/F to Net) - indices 6 to 11 in the 11-column structure */
               /* After hiding N°, indices shift. New indices 5 to 10 */
               #print-report-content .report-output.type-reports td:nth-child(n+5):nth-child(-n+10),
               #print-report-content .report-output.type-reports th:nth-child(n+5):nth-child(-n+10) {
                    text-align: center !important; /* Center numeric values */
               }

              /* Print Specific Text Alignment for SS Reports Table (type-ss) */
               #print-report-content .report-output.type-ss td:first-child, /* N° */
               #print-report-content .report-output.type-ss th:first-child {
                   display: none !important; /* Explicitly hide N° in print */
               }
              #print-report-content .report-output.type-ss td:nth-child(2), /* اللقب - now first visible */
              #print-report-content .report-output.type-ss th:nth-child(2), /* اللقب */
               #print-report-content .report-output.type-ss td:nth-child(3), /* الاسم - now second visible */
               #print-report-content .report-output.type-ss th:nth-child(3) /* الاسم */
              {
                text-align: right !important; /* Align names right */
              }
               /* Remaining columns in SS table (تاريخ الميلاد, رقم الضمان الاجتماعي, المبلغ الخام) are 4th, 5th, 6th. */
               /* After hiding N°, indices shift. New indices 3, 4, 5. */
              #print-report-content .report-output.type-ss td:nth-child(n+3):nth-child(-n+5),
               #print-report-content .report-output.type-ss th:nth-child(n+3):nth-child(-n+5) {
                   text-align: center !important; /* Center these columns */
              }


              /* Ensure total row colspan is correct based on table type */
               #print-report-content .report-output.type-reports .total-row td:first-child {
                  /* Spans N°, Nom, Fonction, Grade, RIB (5 columns in the 11-col structure) */
                   /* After hiding N°, the text is in the cell corresponding to Nom (index 2). It needs to span Nom, Fonction, Grade, RIB */
                  /* That's 4 visible columns. So colspan is 4. */
                  /* colspan: 4;  خاصية HTML وليست CSS */
                  text-align: right !important; /* Align the total text itself to the right */
              }
               /* Add styles for the empty cells after the colspan and before the totals */
              #print-report-content .report-output.type-reports .total-row td:nth-child(2), /* Corresponds to Nbr/F - Index 6 in 11-col structure, index 5 after removing N° and colspan */
              #print-report-content .report-output.type-reports .total-row td:nth-child(3)  /* Corresponds to TAUX - Index 7 in 11-col structure, index 6 after removing N° and colspan */
              {
                   text-align: center !important; /* Center the empty cells like their headers */
              }


             #print-report-content .report-output.type-ss .total-row td:first-child {
                  /* Spans N°, اللقب, الاسم, تاريخ الميلاد, رقم الضمان الاجتماعي (5 columns in the 6-col structure) */
                 /* N° is hidden. Total text is in the cell for اللقب (index 2). It needs to span اللقب, الاسم, تاريخ الميلاد, رقم الضمان الاجتماعي. */
                 /* That's 4 visible columns. So colspan is 4. */
                  /* colspan: 4;  خاصية HTML وليست CSS */
                  text-align: right !important; /* Align the total text itself to the right */
             }
              /* The only subsequent total is BRUT, which is the last cell (index 6 in 6-col structure, index 5 after colspan) */
              #print-report-content .report-output.type-ss .total-row td:last-child {
                   text-align: center !important; /* Center the BRUT total */
              }


              #print-report-content .report-output .total-row th, #print-report-content .report-output .total-row td { background-color: #ced4da !important; color: #000 !important; }

            /* Print signature styles - side by side */
             #print-report-content .report-footer .signatures {
                display: flex;
                justify-content: space-between; /* Distribute space */
                margin-top: 30px; /* Space above signatures */
                margin-bottom: 30px; /* Space below signatures */
                text-align: center; /* Center text within each signature block */
             }
             #print-report-content .report-footer .signatures .signature {
                flex-basis: 48%; /* Give each signature block roughly half the width */
                /* Ensure text alignment is correct relative to the container sides */
                text-align: right; /* المسير المالي on the right */
             }
              #print-report-content .report-footer .signatures .signature:last-child { text-align: left; } /* المدير on the left */
               #print-report-content .report-footer .signatures .signature p { margin: 5px 0; } /* Adjust spacing within signature block */

            /* Ensure date below signatures aligns right */
             #print-report-content .report-footer p:last-child {
                text-align: right !important;
                margin-top: 20px; /* Add space above the date */
             }
        }


         /* --- Edit Modal/Overlay Styles (from your file) --- */
         .modal-overlay {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.6);
             backdrop-filter: blur(3px);
             display: flex;
             justify-content: center;
             align-items: center;
             z-index: 1050;
              display: none;
               opacity: 0;
               transition: opacity 0.3s ease-in-out;
         }

         .modal-overlay.visible {
              display: flex;
              opacity: 1;
         }
         .modal-overlay.visible .modal-content {
              transform: translateY(0);
              opacity: 1;
         }


         .modal-content {
             background-color: var(--background-white);
             padding: 35px;
             border-radius: var(--border-radius-md);
             box-shadow: var(--shadow-xl);
             max-width: 650px; /* Increased modal width for more fields */
             width: 90%;
             text-align: right;
             transform: translateY(-50px);
             opacity: 0;
             transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
              position: relative;
         }

          /* Modal form styles, similar to main form styles */
          .modal-content .form-grid { /* Override form-grid gap for modal */
               grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Adjust min-width */
               gap: var(--space-md); /* Keep same gap */
               margin-bottom: var(--space-lg); /* Margin below modal grid */
          }

           .modal-content form > div { /* Add margin to non-grid divs in modal form */
               margin-bottom: var(--space-md);
           }

          .modal-content form input[type="text"],
          .modal-content form input[type="number"],
          .modal-content form input[type="date"],
          .modal-content form select {
              width: 100%;
              font-size: 0.96em;
              padding: 4px 7px;
              min-height: 25px;
              height: 25px;
              border: 1px solid var(--border-color);
              border-radius: var(--border-radius-sm);
              box-sizing: border-box;
              transition: border-color 0.2s, box-shadow 0.2s;
              background-color: var(--background-white);
          }
           .modal-content form input[type="text"]:focus,
           .modal-content form input[type="number"]:focus,
           .modal-content form input[type="date"]:focus,
           .modal-content form select:focus {
               border-color: var(--primary-color);
               box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
               outline: none;
               background-color: var(--light-color);
           }
            .modal-content form input[readonly] {
                 background-color: var(--background-section);
                 cursor: not-allowed;
                 border-color: var(--border-light-color);
             }


          .modal-buttons {
              text-align: left; /* Buttons aligned left in RTL modal */
              margin-top: var(--space-lg);
          }
           .modal-buttons button {
              margin-left: var(--space-sm); /* Space between buttons */
              padding: 10px 20px;
              border: none;
              border-radius: var(--border-radius-sm);
              cursor: pointer;
              font-size: 1em;
              transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
              box-shadow: var(--shadow-sm);
               font-family: var(--font-family);
               font-weight: 600;
                display: inline-flex; /* Ensure inline-flex */
                align-items: center;
                gap: var(--space-xs);
           }
            .modal-buttons button i { font-size: 1.1em; }


            .modal-buttons .save-button { background-color: var(--success-color); color: white; }
             .modal-buttons .save-button:hover { background-color: #218838; transform: translateY(-1px); }
              .modal-buttons .save-button:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }

            .modal-buttons .cancel-button { background-color: var(--secondary-color); color: white; }
             .modal-buttons .cancel-button:hover { background-color: #5a6268; transform: translateY(-1px); }
              .modal-buttons .cancel-button:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }


         /* Improve focus indicator */
         *:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 2px;
         }
         /* Remove default outline for elements with custom focus styles */
         input:focus, select:focus, button:focus {
            outline: none;
         }
    </style>
</head>
<script>
// إصلاح التنقل بين التبويبات
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    // إظهار أول تبويب افتراضيًا إذا لم يكن هناك نشط
    let anyActive = false;
    tabPanels.forEach(panel => { if(panel.classList.contains('active')) anyActive = true; });
    if (!anyActive && tabPanels.length > 0) {
        tabPanels[0].classList.add('active');
        tabButtons[0].classList.add('active');
    }
    tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // إزالة التفعيل عن جميع التبويبات
            tabButtons.forEach(b => b.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            // تفعيل التبويب الحالي
            btn.classList.add('active');
            const tab = btn.getAttribute('data-tab');
            const panel = document.getElementById(tab + '-panel');
            if(panel) panel.classList.add('active');
        });
    });
});

// تحقق فوري من رقم الضمان الاجتماعي (12 رقمًا فقط)
function validateSSN(inputId, feedbackId) {
    const input = document.getElementById(inputId);
    const feedback = document.getElementById(feedbackId);
    if (!input || !feedback) return;
    input.addEventListener('input', function() {
        // فقط أرقام
        this.value = this.value.replace(/[^\d]/g, '');
        if (this.value.length === 0) {
            feedback.textContent = '';
            this.classList.remove('invalid');
        } else if (this.value.length !== 12) {
            feedback.textContent = 'يجب إدخال 12 رقمًا بالضبط.';
            feedback.style.color = '#dc3545';
            this.classList.add('invalid');
        } else {
            feedback.textContent = 'رقم صحيح.';
            feedback.style.color = '#28a745';
            this.classList.remove('invalid');
        }
    });
    input.addEventListener('blur', function() {
        if (this.value.length !== 12 && this.value.length > 0) {
            feedback.textContent = 'يجب إدخال 12 رقمًا بالضبط.';
            feedback.style.color = '#dc3545';
            this.classList.add('invalid');
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    validateSSN('ss-num', 'ss-num-feedback');
    validateSSN('edit-ss-num', 'edit-ss-num-feedback');
});
</script>
<body>
    <!-- شاشة تسجيل الدخول المحسنة -->
    <div id="login-overlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.60);z-index:2000;display:flex;align-items:center;justify-content:center;direction:rtl;backdrop-filter:blur(3px);">
        <form id="login-form" style="background:linear-gradient(135deg,#fff 80%,#e3f2fd 100%);padding:44px 32px 32px 32px;border-radius:22px;box-shadow:0 8px 40px #0004;min-width:320px;max-width:94vw;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;left:0;width:100%;height:8px;background:linear-gradient(90deg,#2196f3,#00bcd4,#4caf50,#ffc107,#f44336);background-size:200% 100%;animation:loginBar 3s linear infinite alternate;"></div>
            <h2 style="margin-bottom:18px;text-align:center;letter-spacing:1px;color:#1976d2;font-weight:800;">تسجيل الدخول</h2>
            <div class="form-group">
                <label for="login-username" style="font-weight:700;">اسم المستخدم:</label>
                <input type="text" id="login-username" required autocomplete="username" style="padding-left:8px;font-size:1.08em;">
            </div>
            <div class="form-group" style="position:relative;">
                <label for="login-password" style="font-weight:700;">كلمة المرور:</label>
                <input type="password" id="login-password" required autocomplete="current-password" style="padding-left:38px;font-size:1.08em;">
                <button type="button" id="toggle-login-password" tabindex="-1" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:none;border:none;outline:none;cursor:pointer;font-size:1.2em;color:#888;" aria-label="إظهار/إخفاء كلمة المرور">
                    <span id="eye-icon" style="pointer-events:none;">👁️</span>
                </button>
            </div>
            <div class="form-group" style="text-align:center;margin-top:18px;">
                <button type="submit" style="width:100%;font-size:1.13em;font-weight:700;background:linear-gradient(90deg,#2196f3,#00bcd4);border:none;">دخول</button>
            </div>
            <div id="login-error" style="color:#dc3545;text-align:center;margin-top:10px;display:none;font-size:1em;font-weight:600;"></div>
        </form>
    </div>
    <style>
    @keyframes loginBar {
        0% {background-position:0% 0;}
        100% {background-position:100% 0;}
    }
    #login-overlay input[type="text"], #login-overlay input[type="password"] {
        background: #f7fbff;
        border: 1.5px solid #b6d4fe;
        border-radius: 7px;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-shadow: 0 1px 2px #0001;
    }
    #login-overlay input[type="text"]:focus, #login-overlay input[type="password"]:focus {
        border-color: #2196f3;
        box-shadow: 0 0 0 2px #2196f344;
        background: #e3f2fd;
    }
    #login-overlay label {
        color: #1976d2;
        font-size: 1em;
    }
    #login-overlay button[type="submit"] {
        background: linear-gradient(90deg,#2196f3,#00bcd4);
        color: #fff;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px #2196f322;
        transition: background 0.2s, box-shadow 0.2s;
    }
    #login-overlay button[type="submit"]:hover {
        background: linear-gradient(90deg,#1976d2,#00bcd4);
        box-shadow: 0 4px 16px #2196f344;
    }
    #login-overlay #toggle-login-password:hover {
        color: #1976d2;
    }
    </style>
    <div class="container">
        <header>
            <h1>برنامج تسيير مستحقات  مركز  امتحان اثبات المستوى</h1>
            <nav class="tabs">
                <button class="tab-button" data-tab="institution"><i class="fas fa-building"></i> معلومات المؤسسة</button>
                <button class="tab-button" data-tab="beneficiary"><i class="fas fa-users"></i> إدارة المستفيدين والتعويضات</button>
                <button class="tab-button" data-tab="reports"><i class="fas fa-file-alt"></i> معاينة وطباعة تقارير التعويضات</button> <!-- Reports Tab -->
                <!-- NEW TAB: Social Security Reports -->
                 <button class="tab-button" data-tab="social-security-reports"><i class="fas fa-shield-alt"></i> تعويضات الضمان الاجتماعي</button>
                 <!-- End NEW TAB -->

            </nav>
        </header>

        <div class="tab-content">
            <!-- معلومات المؤسسة Panel -->
            <div id="institution-panel" class="tab-panel">
                <h2>معلومات المؤسسة</h2>
                <form id="institution-info-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="republic">الجمهورية:</label>
                            <input type="text" id="republic" value="الجمهورية الجزائرية الديمقراطية الشعبية" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ministry">الوزارة:</label>
                            <input type="text" id="ministry" value="وزارة التربية الوطنية" readonly>
                        </div>
                        <div class="form-group">
                            <label for="directorate">المديرية:</label>
                            <input type="text" id="directorate" value="مديرية التربية لولاية أدرار">
                        </div>
                         <div class="form-group">
                             <label for="onfed">الديوان:</label>
                             <input type="text" id="onfed" name="onfed" value="الديوان الوطني للتعليم والتكوين عن بعد" readonly>
                         </div>
                        <div class="form-group">
                            <label for="institution">المركز الولائي:</label>
                            <input type="text" id="institution" value="المركز الولائي أدرار">
                        </div>
                        <div class="form-group">
                            <label for="fiscal-year">السنة المالية (YYYY):</label>
                            <input type="text" id="fiscal-year" value="2023" placeholder="مثال: 2023" maxlength="4">
                        </div>
                        <div class="form-group">
                            <label for="financial-month">الشهر المالي (MM):</label>
                            <input type="text" id="financial-month" value="" placeholder="مثال: 06" maxlength="2">
                        </div>
                         <div class="form-group">
                            <label for="treasury-ccp-input">رقم الحساب البريدي لدى الخزينة (CCP):</label>
                            <input type="text" id="treasury-ccp-input" value="" placeholder="أدخل رقم حساب الخزينة (14 رقم)">
                            <span id="treasury-ccp-feedback" class="validation-feedback"></span>
                         </div>
                         <div class="form-group">
                             <label for="treasury-rib">رقم الحساب البريدي لدى الخزينة (RIP كامل):</label>
                             <input type="text" id="treasury-rib" value="" readonly placeholder="يتم حسابه تلقائياً">
                         </div>
                         <div class="form-group">
                             <label for="payment-order-num">رقم الأمر بالصرف:</label>
                             <input type="text" id="payment-order-num" value="">
                         </div>
                          <div class="form-group">
                              <label for="transfer-num">رقم الحوالة:</label>
                              <input type="text" id="transfer-num" value="">
                          </div>
                    </div>
                     <!-- Button remains in its own div for spacing -->
                    <div>
                        <button type="submit"><i class="fas fa-save"></i> حفظ معلومات المؤسسة</button>
                    </div>
                </form>
            </div>

            <!-- إدارة المستفيدين والتعويضات Panel -->
            <div id="beneficiary-panel" class="tab-panel">
                <h2>إدارة المستفيدين والتعويضات</h2>

                <!-- Add Beneficiary Form -->
                <form id="add-beneficiary-form">
                    <h3><i class="fas fa-user-plus"></i> إضافة مستفيد جديد وبيانات التعويض</h3>
                    <div class="form-grid">
                         <!-- Split Name Field -->
                         <div class="form-group">
                             <label for="last-name">اللقب:</label>
                             <input type="text" id="last-name" required placeholder="الرجاء حجز اللقب باللغة اللاتينية">
                         </div>
                          <div class="form-group">
                              <label for="first-name">الاسم:</label>
                              <input type="text" id="first-name" required placeholder="الرجاء حجز الاسم باللغة اللاتينية">
                          </div>
                         <!-- End Split Name Field -->
                         <div class="form-group">
                              <label for="function">الوظيفة في المركز:</label>
                              <input type="text" id="function" value="مصصح/مراقب" required>
                          </div>
                          <div class="form-group">
                              <label for="add-grade">الصنف (Grade):</label>
                              <!-- Corrected ID to add-grade -->
                              <!-- Added example placeholder values -->
                              <input type="text" id="add-grade" value="P-Ser" required placeholder="مثال: 9, 10, 12, 13, P-Ser">
                          </div>
                         <div class="form-group">
                             <label for="beneficiary-ccp-input">رقم الحساب البريدي (CCP):</label>
                             <input type="text" id="beneficiary-ccp-input" required placeholder="أدخل رقم الحساب ( رقم الحساب دون مفتاح)">
                              <span id="beneficiary-ccp-feedback" class="validation-feedback"></span>
                         </div>
                         <div class="form-group">
                              <label for="rib">رقم الحساب البريدي (RIP كامل):</label>
                              <input type="text" id="rib" value="" readonly required placeholder="يتم حسابه تلقائياً">
                          </div>
                         <!-- New fields -->
                          <div class="form-group">
<label for="ss-num">رقم الضمان الاجتماعي:</label>
<input type="text" id="ss-num" placeholder="أدخل رقم الضمان الاجتماعي" maxlength="12" pattern="\d{12}" inputmode="numeric">
<span id="ss-num-feedback" class="validation-feedback"></span>
                         </div>
                         <div class="form-group">
                             <label for="dob">تاريخ الميلاد:</label>
                             <input type="date" id="dob">
                         </div>
                         <!-- Compensation Type select to Add form -->
                          <div class="form-group">
                             <label for="compensation-type-add">نوع التعويض:</label>
                             <select id="compensation-type-add" required>
                                  <option value="اجراء">تعويضات مراكز الإجراء</option>
                                  <option value="تصحيح_متوسط">تعويضات مركز تصحيح امتحان اثبات المستوى للتعليم المتوسط</option>
                                  <option value="تصحيح_ثانوي">تعويضات مركز تصحيح امتحان اثبيت المستوى للتعليم الثانوي</option>
                                  <!-- NEW COMPENSATION TYPE OPTION -->
                                   <option value="امانة_تصحيح">تعويضات مركز امانة التصحيح</option>
                                   <!-- END NEW COMPENSATION TYPE OPTION -->
                             </select>
                         </div>
                          <!-- Compensation Inputs within Add Form (hidden by CSS, but still needed for calculation) -->
                         <div class="form-group" id="add-nbr-f-group">
                            <label for="add-nbr-f">عدد (ساعات / أوراق) العمل (Nbr/ F):</label>
                            <input type="number" id="add-nbr-f" value="0" required min="0">
                        </div>
                         <div class="form-group" id="add-taux-group">
                            <label for="add-taux">تعويض (الساعة / الورقة) (TAUX):</label>
                            <input type="number" id="add-taux" value="0.00" step="0.01" required min="0" readonly>
                        </div>
                         <div class="form-group" id="add-brut-group">
                            <label for="add-brut">المبلغ دون اقتطاع (BRUT):</label>
                            <input type="number" id="add-brut" value="0.00" step="0.01" readonly>
                        </div>
                         <div class="form-group" id="add-ss-group">
                            <label for="add-ss">تعويض الضمان الاجتماعي (S.S):</label>
                            <input type="number" id="add-ss" value="0.00" step="0.01" readonly>
                        </div>
                         <div class="form-group" id="add-irg-group">
                            <label for="add-irg">الضريبة على الدخل (I.R.G):</label>
                            <input type="number" id="add-irg" value="0.00" step="0.01" readonly>
                        </div>
                        <div class="form-group" id="add-net-group">
                            <label for="add-net">الصافي للدفع (NET):</label>
                            <input type="number" id="add-net" value="0.00" step="0.01" readonly>
                        </div>
                         <!-- Removed Observations form group -->
                    </div>
                    <button type="submit"><i class="fas fa-plus-circle"></i> إضافة المستفيد وحساب التعويض</button>
                </form>

                 <!-- Beneficiary List Table -->



                <h3 style="margin: 0 0 6px 0; font-size: 1.08em; color:#1976d2; letter-spacing:0.5px; font-weight:700; text-shadow:0 1px 0 #fff, 0 2px 8px #b6d4fe22;">قائمة المستفيدين</h3>
                <div class="filter-buttons" id="beneficiary-filter-buttons" style="margin-bottom: 6px; gap:4px;">
                    <button data-filter-type="all" class="active" style="background:#e3f2fd;color:#1976d2;"><i class="fas fa-list"></i> عرض الكل</button>
                    <!-- Buttons for specific types will be added by JS -->
                </div>
                <div style="display: flex; align-items: center; justify-content: flex-start; gap: 5px; flex-wrap: wrap; margin-bottom: 6px;">
                    <input type="text" id="beneficiary-search-input" placeholder="بحث بالاسم أو اللقب أو الضمان..." style="padding: 2px 7px; border-radius: 5px; border: 1px solid #b6d4fe; min-width: 140px; font-size: 0.97em; height: 26px; background:#fafdff; transition:box-shadow 0.2s;">
                    <span id="beneficiary-search-clear" title="مسح البحث" style="cursor:pointer; color:#1976d2; font-size:1.1em; display:none;"><i class="fas fa-times-circle"></i></span>
                </div>

                <div style="overflow-x:auto; border-radius:8px; box-shadow:0 1px 8px #b6d4fe22; background:#fafdff;">
                <table id="beneficiaries-table" style="font-size:0.92em; min-width:600px; width:100%; max-width:100%; border-radius:7px; border-collapse:separate; border-spacing:0;">
                    <thead style="background:#e3f2fd;">
                        <tr>
                            <th style="padding:3px 6px; background:#e3f2fd;">#</th>
                            <th style="padding:3px 6px; background:#e3f2fd;">اللقب</th>
                            <th style="padding:3px 6px; background:#e3f2fd;">الاسم</th>
                            <th style="padding:3px 6px; background:#e3f2fd;">تاريخ الميلاد</th>
                            <th style="padding:3px 6px; background:#e3f2fd;">RIP</th>
                            <th style="padding:3px 6px; background:#e3f2fd;">نوع التعويض</th>
                            <th style="padding:3px 6px; background:#e3f2fd;">الصافي</th>
                            <th class="actions-cell" style="padding:3px 6px; background:#e3f2fd;">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Beneficiary rows will be added here by JavaScript -->
                    </tbody>
                </table>
                </div>
<style>
/* تحسين مظهر أزرار الإجراءات في الجدول */
#beneficiaries-table td.actions-cell button {
    font-size: 0.93em;
    padding: 2px 7px;
    border-radius: 5px;
    margin: 0 1px;
    background: linear-gradient(90deg, #e3f2fd 0%, #b6d4fe 100%);
    color: #1976d2;
    border: 1px solid #b6d4fe;
    box-shadow: 0 1px 2px #b6d4fe22;
    transition: background 0.18s, color 0.18s;
}
#beneficiaries-table td.actions-cell button:hover {
    background: linear-gradient(90deg, #1976d2 0%, #43cea2 100%);
    color: #fff;
}
/* إبراز الصف عند تمرير الماوس */
#beneficiaries-table tbody tr:hover {
    background: #e3f2fd55;
    transition: background 0.18s;
}
/* إبراز حقل البحث عند التركيز */
#beneficiary-search-input:focus {
    box-shadow: 0 0 0 2px #1976d244;
    border-color: #1976d2;
    background: #e3f2fd;
}
/* تحسين مظهر أزرار التصفية */
#beneficiary-filter-buttons button {
    border-radius: 5px;
    padding: 2px 10px;
    font-size: 0.95em;
    margin-left: 2px;
    margin-right: 2px;
    border: 1px solid #b6d4fe;
    background: #fafdff;
    color: #1976d2;
    transition: background 0.18s, color 0.18s;
}
#beneficiary-filter-buttons button.active, #beneficiary-filter-buttons button:focus {
    background: linear-gradient(90deg, #e3f2fd 60%, #b6d4fe 100%);
    color: #004085;
    font-weight: 700;
    box-shadow: 0 2px 8px #b6d4fe22;
}
</style>
                 <!-- Added the global edit button here -->
                <!-- Removed the global edit button as it's confusing. Edit is per row.
                 <button type="button" class="edit-global-btn"><i class="fas fa-user-edit"></i> تعديل بيانات المستفيد والتعويض</button>
                 -->


            </div>

            <!-- تقارير التعويضات والتصدير Panel -->
            <div id="reports-panel" class="tab-panel">
                 <h2>تقارير التعويضات</h2>

                 <!-- Nested Tabs for Compensation Types -->
                 <div class="nested-tabs" data-panel-type="reports">
                     <button class="nested-tab-button active" data-nested-tab="اجراء">تعويضات مراكز الإجراء</button>
                     <button class="nested-tab-button" data-nested-tab="تصحيح_متوسط">  تصحيح  اثبات المستوى للتعليم المتوسط</button>
                     <button class="nested-tab-button" data-nested-tab="تصحيح_ثانوي">  تصحيح  اثبات المستوى للتعليم الثانوي</button>
                      <!-- NEW NESTED TAB FOR STANDARD REPORTS -->
                     <button class="nested-tab-button" data-nested-tab="امانة_تصحيح"> تعويضات مركز امانة التصحيح</button>
                      <!-- END NEW NESTED TAB -->
                 </div>

                 <div class="nested-tab-content">
                     <!-- Panel for Type 1 Reports -->
                     <div id="reports-اجراء-nested-panel" class="nested-tab-panel active">
                         <h3>تقرير: تعويضات مراكز الإجراء</h3>
                         <div class="custom-text-group">
                            <label for="reports-custom-report-text-اجراء">العبارة المخصصة لرأس تقرير هذا النوع:</label>
                            <input type="text" id="reports-custom-report-text-اجراء" placeholder="مثال: كشف بأسماء الأساتذة المصححين لإمتحان إثبات المستوى لسنة YYYY الشهر MM.">
                         </div>
                         <p class="explanation">يعرض هذا الجدول المستفيدين من نوع "مراكز الإجراء" وتعويضاتهم. استخدم الأزرار أدناه لطباعة أو تصدير هذا التقرير فقط.</p>
                         <div class="reporting-buttons">
                             <button data-report-type="اجراء" class="print-report-btn"><i class="fas fa-print"></i> طباعة التقرير</button>
                             <button data-report-type="اجراء" class="export-excel-btn"><i class="fas fa-file-excel"></i> تصدير إلى XLSX</button>
                             <button data-report-type="اجراء" class="export-txt-btn"><i class="fas fa-file-code"></i> تصدير ملف TXT</button>
                         </div>
                         <div class="report-output" id="reports-report-preview-اجراء">
                              <!-- Report HTML will be generated here by JavaScript -->
                         </div>
                     </div>

                     <!-- Panel for Type 2 Reports -->
                     <div id="reports-تصحيح_متوسط-nested-panel" class="nested-tab-panel">
                          <h3>تقرير: تعويضات مركز تصحيح امتحان اثبات المستوى للتعليم المتوسط</h3>
                          <div class="custom-text-group">
                            <label for="reports-custom-report-text-تصحيح_متوسط">العبارة المخصصة لرأس تقرير هذا النوع:</label>
                            <input type="text" id="reports-custom-report-text-تصحيح_متوسط" placeholder="مثال: كشف بأسماء الأساتذة المصححين لإمتحان إثبات المستوى للتعليم المتوسط لسنة YYYY الشهر MM.">
                         </div>
                          <p class="explanation">يعرض هذا الجدول المستفيدين من نوع "تصحيح امتحان اثبات المستوى للتعليم المتوسط" وتعويضاتهم. استخدم الأزرار أدناه لطباعة أو تصدير هذا التقرير فقط.</p>
                         <div class="reporting-buttons">
                              <button data-report-type="تصحيح_متوسط" class="print-report-btn"><i class="fas fa-print"></i> طباعة التقرير</button>
                              <button data-report-type="تصحيح_متوسط" class="export-excel-btn"><i class="fas fa-file-excel"></i> تصدير إلى XLSX</button>
                              <button data-report-type="تصحيح_متوسط" class="export-txt-btn"><i class="fas fa-file-code"></i> تصدير ملف TXT</button>
                         </div>
                         <div class="report-output" id="reports-report-preview-تصحيح_متوسط">
                             <!-- Report HTML will be generated here by JavaScript -->
                         </div>
                     </div>

                     <!-- Panel for Type 3 Reports -->
                     <div id="reports-تصحيح_ثانوي-nested-panel" class="nested-tab-panel">
                          <h3>تقرير: تعويضات مركز تصحيح امتحان اثبات المستوى للتعليم الثانوي</h3>
                           <div class="custom-text-group">
                            <label for="reports-custom-report-text-تصحيح_ثانوي">العبارة المخصصة لرأس تقرير هذا النوع:</label>
                            <input type="text" id="reports-custom-report-text-تصحيح_ثانوي" placeholder="مثال: كشف بأسماء الأساتذة المصححين لإمتحان إثبات المستوى للتعليم الثانوي لسنة YYYY الشهر MM.">
                         </div>
                          <p class="explanation">يعرض هذا الجدول المستفيدين من نوع "تصحيح امتحان اثبات المستوى للتعليم الثانوي" وتعويضاتهم. استخدم الأزرار أدناه لطباعة أو تصدير هذا التقرير فقط.</p>
                          <div class="reporting-buttons">
                              <button data-report-type="تصحيح_ثانوي" class="print-report-btn"><i class="fas fa-print"></i> طباعة التقرير</button>
                              <button data-report-type="تصحيح_ثانوي" class="export-excel-btn"><i class="fas fa-file-excel"></i> تصدير إلى XLSX</button>
                              <button data-report-type="تصحيح_ثانوي" class="export-txt-btn"><i class="fas fa-file-code"></i> تصدير ملف TXT</button>
                          </div>
                         <div class="report-output" id="reports-report-preview-تصحيح_ثانوي">
                             <!-- Report HTML will be generated here by JavaScript -->
                         </div>
                     </div>

                      <!-- NEW NESTED PANEL FOR STANDARD REPORTS -->
                      <div id="reports-امانة_تصحيح-nested-panel" class="nested-tab-panel">
                           <h3>تقرير: تعويضات مركز امانة التصحيح</h3>
                           <div class="custom-text-group">
                              <label for="reports-custom-report-text-امانة_تصحيح">العبارة المخصصة لرأس تقرير هذا النوع:</label>
                              <input type="text" id="reports-custom-report-text-امانة_تصحيح" placeholder="مثال: كشف بأسماء المكلفين بمركز امانة التصحيح لإمتحان إثبات المستوى لسنة YYYY الشهر MM.">
                           </div>
                           <p class="explanation">يعرض هذا الجدول المستفيدين من نوع "تعويضات مركز امانة التصحيح" وتعويضاتهم. استخدم الأزرار أدناه لطباعة أو تصدير هذا التقرير فقط.</p>
                           <div class="reporting-buttons">
                               <button data-report-type="امانة_تصحيح" class="print-report-btn"><i class="fas fa-print"></i> طباعة التقرير</button>
                               <button data-report-type="امانة_تصحيح" class="export-excel-btn"><i class="fas fa-file-excel"></i> تصدير إلى XLSX</button>
                               <button data-report-type="امانة_تصحيح" class="export-txt-btn"><i class="fas fa-file-code"></i> تصدير ملف TXT</button>
                           </div>
                           <div class="report-output" id="reports-report-preview-امانة_تصحيح">
                                <!-- Report HTML will be generated here by JavaScript -->
                           </div>
                       </div>
                      <!-- END NEW NESTED PANEL -->

                 </div>
            </div>

            <!-- NEW PANEL: تعويضات الضمان الاجتماعي -->
            <div id="social-security-reports-panel" class="tab-panel">
                <h2>تعويضات الضمان الاجتماعي</h2>

                 <!-- Nested Tabs for Compensation Types (excluding اجراء) -->
                 <div class="nested-tabs" data-panel-type="social-security-reports">
                     <button class="nested-tab-button active" data-nested-tab="تصحيح_متوسط">  تصحيح  اثبات المستوى للتعليم المتوسط</button>
                     <button class="nested-tab-button" data-nested-tab="تصحيح_ثانوي">  تصحيح  اثبات المستوى للتعليم الثانوي</button>
                     <!-- NEW NESTED TAB FOR SS REPORTS -->
                      <button class="nested-tab-button" data-nested-tab="امانة_تصحيح"> تعويضات مركز امانة التصحيح</button>
                     <!-- END NEW NESTED TAB -->
                 </div>

                 <div class="nested-tab-content">
                     <!-- Panel for Type 2 SS Reports -->
                     <div id="social-security-reports-تصحيح_متوسط-nested-panel" class="nested-tab-panel active">
                          <h3>تقرير الضمان الاجتماعي: تصحيح امتحان اثبات المستوى للتعليم المتوسط</h3>
                          <div class="custom-text-group">
                            <label for="ss-custom-report-text-تصحيح_متوسط">العبارة المخصصة لرأس تقرير الضمان الاجتماعي لهذا النوع:</label>
                            <input type="text" id="ss-custom-report-text-تصحيح_متوسط" placeholder="مثال: كشف بأسماء الأساتذة المصححين لإمتحان إثبات المستوى للتعليم المتوسط لسنة YYYY الشهر MM.">
                         </div>
                          <p class="explanation">يعرض هذا الجدول المستفيدين من نوع "تصحيح امتحان اثبات المستوى للتعليم المتوسط" وبيانات الضمان الاجتماعي والمبلغ الخام. استخدم الأزرار أدناه لطباعة أو تصدير هذا التقرير فقط.</p>
                         <div class="reporting-buttons">
                              <button data-report-type="تصحيح_متوسط" class="print-ss-report-btn"><i class="fas fa-print"></i> طباعة التقرير</button>
                              <button data-report-type="تصحيح_متوسط" class="export-ss-excel-btn"><i class="fas fa-file-excel"></i> تصدير إلى XLSX</button>
                              <!-- TXT export button removed as requested -->
                         </div>
                         <div class="report-output" id="social-security-reports-report-preview-تصحيح_متوسط">
                             <!-- Report HTML will be generated here by JavaScript -->
                         </div>
                     </div>

                     <!-- Panel for Type 3 SS Reports -->
                     <div id="social-security-reports-تصحيح_ثانوي-nested-panel" class="nested-tab-panel">
                          <h3>تقرير الضمان الاجتماعي: تصحيح امتحان اثبات المستوى للتعليم الثانوي</h3>
                           <div class="custom-text-group">
                            <label for="ss-custom-report-text-تصحيح_ثانوي">العبارة المخصصة لرأس تقرير الضمان الاجتماعي لهذا النوع:</label>
                            <input type="text" id="ss-custom-report-text-تصحيح_ثانوي" placeholder="مثال: كشف بأسماء الأساتذة المصححين لإمتحان إثبات المستوى للتعليم الثانوي لسنة YYYY الشهر MM.">
                         </div>
                          <p class="explanation">يعرض هذا الجدول المستفيدين من نوع "تصحيح امتحان اثبات المستوى للتعليم الثانوي" وبيانات الضمان الاجتماعي والمبلغ الخام. استخدم الأزرار أدناه لطباعة أو تصدير هذا التقرير فقط.</p>
                          <div class="reporting-buttons">
                              <button data-report-type="تصحيح_ثانوي" class="print-ss-report-btn"><i class="fas fa-print"></i> طباعة التقرير</button>
                              <button data-report-type="تصحيح_ثانوي" class="export-ss-excel-btn"><i class="fas fa-file-excel"></i> تصدير إلى XLSX</button>
                              <!-- TXT export button removed as requested -->
                          </div>
                         <div class="report-output" id="social-security-reports-report-preview-تصحيح_ثانوي">
                             <!-- Report HTML will be generated here by JavaScript -->
                         </div>
                     </div>

                      <!-- NEW NESTED PANEL FOR SS REPORTS -->
                      <div id="social-security-reports-امانة_تصحيح-nested-panel" class="nested-tab-panel">
                           <h3>تقرير الضمان الاجتماعي: تعويضات مركز امانة التصحيح</h3>
                            <div class="custom-text-group">
                              <label for="ss-custom-report-text-امانة_تصحيح">العبارة المخصصة لرأس تقرير الضمان الاجتماعي لهذا النوع:</label>
                              <input type="text" id="ss-custom-report-text-امانة_تصحيح" placeholder="مثال: كشف بأسماء المكلفين بمركز امانة التصحيح لإمتحان إثبات المستوى لسنة YYYY الشهر MM.">
                           </div>
                           <p class="explanation">يعرض هذا الجدول المستفيدين من نوع "تعويضات مركز امانة التصحيح" وبيانات الضمان الاجتماعي والمبلغ الخام. استخدم الأزرار أدناه لطباعة أو تصدير هذا التقرير فقط.</p>
                           <div class="reporting-buttons">
                               <button data-report-type="امانة_تصحيح" class="print-ss-report-btn"><i class="fas fa-print"></i> طباعة التقرير</button>
                               <button data-report-type="امانة_تصحيح" class="export-ss-excel-btn"><i class="fas fa-file-excel"></i> تصدير إلى XLSX</button>
                               <!-- TXT export button removed as requested -->
                           </div>
                           <div class="report-output" id="social-security-reports-report-preview-امانة_تصحيح">
                               <!-- Report HTML will be generated here by JavaScript -->
                           </div>
                       </div>
                      <!-- END NEW NESTED PANEL -->

                 </div>
            </div>
            <!-- End NEW PANEL -->


            <!-- النسخ الاحتياطي والاستعادة Panel -->


<!-- زر إعدادات عائم -->
<div id="settings-fab" style="position:fixed;left:30px;top:30px;z-index:120;">
  <button id="open-settings-menu" style="background:#1976d2;color:#fff;border:none;border-radius:50%;width:44px;height:44px;box-shadow:0 2px 8px #b6d4fe33;display:flex;align-items:center;justify-content:center;font-size:1.5em;cursor:pointer;transition:background 0.18s;">
    <i class="fas fa-cog"></i>
  </button>
  <div id="settings-menu" style="display:none;position:absolute;top:54px;left:0;min-width:220px;background:#fff;border-radius:10px;box-shadow:0 4px 16px #b6d4fe55;padding:12px 0 8px 0;flex-direction:column;gap:0.5em;">
    <button id="settings-change-user" style="background:none;color:#1976d2;border:none;width:100%;text-align:right;padding:8px 18px;font-size:1em;display:flex;align-items:center;gap:8px;cursor:pointer;"><i class="fas fa-user-cog"></i> تغيير بيانات الدخول</button>
    <button id="create-backup-btn" style="background:none;color:#1976d2;border:none;width:100%;text-align:right;padding:8px 18px;font-size:1em;display:flex;align-items:center;gap:8px;cursor:pointer;"><i class="fas fa-download"></i> إنشاء نسخة احتياطية</button>
    <button id="restore-backup-btn" style="background:none;color:#1976d2;border:none;width:100%;text-align:right;padding:8px 18px;font-size:1em;display:flex;align-items:center;gap:8px;cursor:pointer;"><i class="fas fa-upload"></i> استيراد نسخة احتياطية</button>
    <input type="file" id="restore-file-input" accept=".json" style="display: none;">
    <button id="empty-db-btn" style="background:none;color:var(--danger-color,#dc3545);border:none;width:100%;text-align:right;padding:8px 18px;font-size:1em;display:flex;align-items:center;gap:8px;cursor:pointer;"><i class="fas fa-trash"></i> تفريغ قاعدة البيانات</button>
  </div>
</div>
<style>
#settings-fab #open-settings-menu:hover {
  background: #185a9d;
}
#settings-menu button:hover {
  background: #e3f2fd;
}
#settings-menu button:active {
  background: #b6d4fe44;
}
</style>

        </div>
    </div>

    <!-- Edit Beneficiary Modal/Overlay -->
    <div id="edit-beneficiary-modal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-user-edit"></i> تعديل بيانات المستفيد والتعويض</h3>
            <form id="edit-beneficiary-form">
                 <!-- Hidden input to store the ID of the beneficiary being edited -->
                 <input type="hidden" id="edit-beneficiary-id">

                 <div class="form-grid">
                     <!-- Split Name Field -->
                     <div class="form-group">
                         <label for="edit-last-name">اللقب:</label>
                         <input type="text" id="edit-last-name" required placeholder="الرجاء حجز اللقب باللغة اللاتينية">
                     </div>
                      <div class="form-group">
                          <label for="edit-first-name">الاسم:</label>
                          <input type="text" id="edit-first-name" required placeholder="الرجاء حجز الاسم باللغة اللاتينية">
                      </div>
                     <!-- End Split Name Field -->
                    <div class="form-group">
                         <label for="edit-function">الوظيفة في المركز:</label>
                         <input type="text" id="edit-function" required>
                     </div>
                     <div class="form-group">
                         <label for="edit-grade">الصنف (Grade):</label>
                          <!-- Corrected ID to edit-grade -->
                          <!-- Added example placeholder values -->
                         <input type="text" id="edit-grade" value="P-Ser" required placeholder="مثال: 9, 10, 12, 13, P-Ser">
                     </div>
                    <div class="form-group">
                        <label for="edit-beneficiary-ccp-input">رقم الحساب البريدي (CCP):</label>
                        <input type="text" id="edit-beneficiary-ccp-input" required placeholder="أدخل رقم الحساب (14 رقم)">
                         <span id="edit-beneficiary-ccp-feedback" class="validation-feedback"></span>
                    </div>
                    <div class="form-group">
                         <label for="edit-rib">رقم الحساب البريدي (RIP كامل):</label>
                         <input type="text" id="edit-rib" value="" readonly required placeholder="يتم حسابه تلقائياً">
                     </div>
                     <!-- New fields in edit modal -->
                      <div class="form-group">
<label for="edit-ss-num">رقم الضمان الاجتماعي:</label>
<input type="text" id="edit-ss-num" placeholder="أدخل رقم الضمان الاجتماعي" maxlength="12" pattern="\d{12}" inputmode="numeric">
<span id="edit-ss-num-feedback" class="validation-feedback"></span>
                     </div>
                     <div class="form-group">
                         <label for="edit-dob">تاريخ الميلاد:</label>
                         <input type="date" id="edit-dob">
                     </div>
                     <!-- Compensation Type selector in edit modal -->
                      <div class="form-group">
                         <label for="edit-compensation-type">نوع التعويض:</label>
                         <select id="edit-compensation-type" required>
                               <option value="اجراء">تعويضات مراكز الإجراء</option>
                               <option value="تصحيح_متوسط">تعويضات مركز تصحيح امتحان اثبات المستوى للتعليم المتوسط</option>
                               <option value="تصحيح_ثانوي">تعويضات مركز تصحيح امتحان اثبيت المستوى للتعليم الثانوي</option>
                               <!-- NEW COMPENSATION TYPE OPTION -->
                                <option value="امانة_تصحيح">تعويضات مركز امانة التصحيح</option>
                                <!-- END NEW COMPENSATION TYPE OPTION -->
                         </select>
                     </div>
                      <!-- Compensation Inputs within Edit Modal (hidden by CSS) -->
                     <div class="form-group" id="edit-nbr-f-group">
                        <label for="edit-nbr-f">عدد (ساعات / أوراق) العمل (Nbr/ F):</label>
                        <input type="number" id="edit-nbr-f" value="0" required min="0">
                    </div>
                     <div class="form-group" id="edit-taux-group">
                        <label for="edit-taux">تعويض (الساعة / الورقة) (TAUX):</label>
                        <input type="number" id="edit-taux" value="0.00" step="0.01" required min="0" readonly>
                    </div>
                     <div class="form-group" id="edit-brut-group">
                        <label for="edit-brut">المبلغ دون اقتطاع (BRUT):</label>
                        <input type="number" id="edit-brut" value="0.00" step="0.01" readonly>
                    </div>
                     <div class="form-group" id="edit-ss-group">
                        <label for="edit-ss">تعويض الضمان الاجتماعي (S.S):</label>
                        <input type="number" id="edit-ss" value="0.00" step="0.01" readonly>
                    </div>
                     <div class="form-group" id="edit-irg-group">
                        <label for="edit-irg">الضريبة على الدخل (I.R.G):</label>
                        <input type="number" id="edit-irg" value="0.00" step="0.01" readonly>
                    </div>
                    <div class="form-group" id="edit-net-group">
                        <label for="edit-net">الصافي للدفع (NET):</label>
                        <input type="number" id="edit-net" value="0.00" step="0.01" readonly>
                    </div>
                    <!-- Removed Observations form group -->
                 </div>


                 <div class="modal-buttons">
                    <button type="submit" class="save-button"><i class="fas fa-save"></i> حفظ التعديلات</button>
                    <button type="button" class="cancel-button" id="cancel-edit-btn"><i class="fas fa-times-circle"></i> إلغاء</button>
                 </div>
            </form>
        </div>
    </div>

    <!-- Hidden div for print content -->
    <div id="print-report-content"></div>


    <script>
        // --- Data Storage (using localStorage for simple persistence) ---
        let institutionInfo = {
            republic: "الجمهورية الجزائرية الديمقراطية الشعبية",
            ministry: "وزارة التربية الوطنية",
            directorate: "", // Will be loaded/saved
            onfed: "الديوان الوطني للتعليم والتكوين عن بعد",
            institution: "المركز الولائي أدرار", // Center name
            fiscalYear: "2023",
            financialMonth: "",
            treasuryAccount: "", // CCP of the treasury account (14 digits)
            paymentOrderNum: "", // Order Number
            transferNum: ""   // Transfer Number
        };
// --- تسجيل الدخول المحسنة ---
let appUser = localStorage.getItem('appUser') ? JSON.parse(localStorage.getItem('appUser')) : {username:'', password:''};
function showLogin() {
    document.getElementById('login-overlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    setTimeout(()=>{
        document.getElementById('login-username').focus();
    }, 100);
}
function hideLogin() {
    document.getElementById('login-overlay').style.display = 'none';
    document.body.style.overflow = '';
}

// إظهار/إخفاء كلمة المرور
document.getElementById('toggle-login-password').onclick = function() {
    const pwInput = document.getElementById('login-password');
    const eyeIcon = document.getElementById('eye-icon');
    if (pwInput.type === 'password') {
        pwInput.type = 'text';
        eyeIcon.textContent = '🙈';
    } else {
        pwInput.type = 'password';
        eyeIcon.textContent = '👁️';
    }
    pwInput.focus();
};

// دعم الضغط على Enter
['login-username','login-password'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', function(e){
        if(e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('login-form').dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
        }
    });
});

document.getElementById('login-form').onsubmit = function(e) {
    e.preventDefault();
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value;
    if(appUser.username === '' && appUser.password === '') {
        // أول استخدام: احفظ أول اسم مستخدم وكلمة مرور
        if(u.length < 3 || p.length < 3) {
            document.getElementById('login-error').textContent = 'يرجى إدخال اسم مستخدم وكلمة مرور (3 أحرف أو أكثر)';
            document.getElementById('login-error').style.display = 'block';
            return;
        }
        appUser = {username: u, password: p};
        localStorage.setItem('appUser', JSON.stringify(appUser));
        hideLogin();
        alert('تم تعيين اسم المستخدم وكلمة المرور بنجاح!');
    } else if(u === appUser.username && p === appUser.password) {
        hideLogin();
    } else {
        document.getElementById('login-error').textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة';
        document.getElementById('login-error').style.display = 'block';
    }
};
window.addEventListener('DOMContentLoaded', showLogin);

// واجهة تغيير اسم المستخدم وكلمة المرور
function showChangeUserModal() {
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100vw';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.zIndex = '2100';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.innerHTML = `
        <form id="change-user-form" style="background:#fff;padding:35px 25px 25px 25px;border-radius:12px;box-shadow:0 4px 24px #0002;min-width:320px;max-width:90vw;direction:rtl;">
            <h3 style="margin-bottom:18px;text-align:center;">تغيير بيانات الدخول</h3>
            <div class="form-group">
                <label>اسم المستخدم الجديد:</label>
                <input type="text" id="new-username" value="${appUser.username}" required>
            </div>
            <div class="form-group">
                <label>كلمة المرور الجديدة:</label>
                <input type="password" id="new-password" value="${appUser.password}" required>
            </div>
            <div class="form-group" style="text-align:center;margin-top:18px;">
                <button type="submit">حفظ</button>
                <button type="button" id="cancel-change-user" style="background:#6c757d;margin-right:10px;">إلغاء</button>
            </div>
            <div id="change-user-error" style="color:#dc3545;text-align:center;margin-top:10px;display:none;"></div>
        </form>
    `;
    document.body.appendChild(modal);
    document.getElementById('cancel-change-user').onclick = function(){ document.body.removeChild(modal); };
    document.getElementById('change-user-form').onsubmit = function(e){
        e.preventDefault();
        const nu = document.getElementById('new-username').value.trim();
        const np = document.getElementById('new-password').value;
        if(nu.length < 3 || np.length < 3) {
            document.getElementById('change-user-error').textContent = 'يجب أن يكون اسم المستخدم وكلمة المرور 3 أحرف أو أكثر';
            document.getElementById('change-user-error').style.display = 'block';
            return;
        }
        appUser = {username: nu, password: np};
        localStorage.setItem('appUser', JSON.stringify(appUser));
        document.body.removeChild(modal);
        alert('تم تحديث بيانات الدخول بنجاح!');
    };
}

// إعدادات قائمة الإعدادات العائمة
document.addEventListener('DOMContentLoaded', function() {
  const settingsFab = document.getElementById('settings-fab');
  const openSettingsMenu = document.getElementById('open-settings-menu');
  const settingsMenu = document.getElementById('settings-menu');
  const changeUserBtn = document.getElementById('settings-change-user');
  const createBackupBtn = document.getElementById('create-backup-btn');
  const restoreBackupBtn = document.getElementById('restore-backup-btn');
  const restoreFileInput = document.getElementById('restore-file-input');
  const emptyDbBtn = document.getElementById('empty-db-btn');

  // إظهار/إخفاء القائمة
  openSettingsMenu.addEventListener('click', function(e) {
    e.stopPropagation();
    settingsMenu.style.display = settingsMenu.style.display === 'none' ? 'flex' : 'none';
  });
  // إغلاق القائمة عند الضغط خارجها
  document.addEventListener('click', function(e) {
    if (!settingsFab.contains(e.target)) {
      settingsMenu.style.display = 'none';
    }
  });
  // تغيير بيانات الدخول
  changeUserBtn.addEventListener('click', function() {
    settingsMenu.style.display = 'none';
    if (typeof showChangeUserModal === 'function') showChangeUserModal();
  });
  // إنشاء نسخة احتياطية
  createBackupBtn.addEventListener('click', function() {
    settingsMenu.style.display = 'none';
    if (typeof createBackup === 'function') createBackup();
  });
  // استيراد نسخة احتياطية
  restoreBackupBtn.addEventListener('click', function() {
    settingsMenu.style.display = 'none';
    restoreFileInput.click();
  });
  // تفريغ قاعدة البيانات
  emptyDbBtn.addEventListener('click', function() {
    settingsMenu.style.display = 'none';
    if (typeof emptyDbBtnClick === 'function') emptyDbBtnClick();
    else if (typeof emptyDb === 'function') emptyDb();
    else if (typeof window.emptyDb === 'function') window.emptyDb();
    else if (typeof window.emptyDbBtnClick === 'function') window.emptyDbBtnClick();
    else {
      // fallback: trigger click if there is a handler
      if (emptyDbBtn.onclick) emptyDbBtn.onclick();
    }
  });
});
        // Beneficiary structure: { id: N, lastName: "...", firstName: "...", function: "...", grade: "...", account: "..." (CCP),
        // ssNum: "", dob: "", // New fields
        // compensation: { type: "...", nbrF: 0, brut: 0, ss: 0, irg: 0, net: 0 } // Nested compensation data
        // Note: taux is NOT stored directly in compensation, it's derived from type/grade/nbrF
        window.beneficiaries = [];

         // Variable to keep track of the currently active filter type for beneficiaries table
         let currentBeneficiaryFilterType = 'all'; // Default is 'all'

         // Object to store custom text for each report type in the standard reports panel
         let reportCustomText = {}; // e.g., { 'اجراء': '...', 'تصحيح_متوسط': '...', 'تصحيح_ثانوي': '...', 'امانة_تصحيح': '...' }

         // Object to store custom text for each report type in the social security reports panel
         let ssReportCustomText = {}; // e.g., 'تصحيح_متوسط': '...', 'تصحيح_ثانوي': '...', 'امانة_تصحيح': '...' }


        // --- Compensation Type Definitions and Rates ---
        const compensationTypes = {
             'اجراء': {
                 name: 'تعويضات مراكز الإجراء',
                 unit: 'ساعة', // Unit for Nbr/F
                 tauxRates: { // Taux depends on Grade (use string keys or numeric range checks)
                     '<10': 135.00, // Grade < 10 (e.g., 9, 8, 7...)
                     '10-11': 180.00, // Grade 10 or 11 (including P-Ser if it maps here)
                     '12': 225.00, // Grade 12
                     '13': 300.00  // Grade 13
                 },
                 defaultTaux: 0
             },
             // Corrected the typo in the key from 'تصحي_متوسط' to 'تصحيح_متوسط'
             'تصحيح_متوسط': {
                 name: 'تعويضات مركز تصحيح امتحان اثبات المستوى للتعليم المتوسط',
                 unit: 'ورقة',
                 tauxRates: {
                     'default': 10.00
                 },
                 defaultTaux: 10.00
             },
             'تصحيح_ثانوي': {
                 name: 'تعويضات مركز تصحيح امتحان اثبيت المستوى للتعليم الثانوي',
                 unit: 'ورقة',
                 tauxRates: {
                     'default': 11.00
                 },
                 defaultTaux: 11.00
             },
             // NEW COMPENSATION TYPE DEFINITION
             'امانة_تصحيح': {
                 name: 'تعويضات مركز امانة التصحيح',
                 unit: 'ساعة', // Same unit as 'اجراء'
                 tauxRates: { // Same taux rates as 'اجراء'
                     '<10': 135.00,
                     '10-11': 180.00,
                     '12': 225.00,
                     '13': 300.00
                 },
                 defaultTaux: 0 // Same default taux as 'اجراء'
             }
             // Add other compensation types here if needed
        };

         // SS Rate (Global constant)
         const ssRate = 0.09; // 9%

         // IRG Rate (Global constant based on user provided rule)
         // IMPORTANT: This is a simplified IRG calculation (5% of taxable income).
         // A real Algerian IRG calculation requires using progressive tax brackets.
         // If the user's description is the intended simple rule, this is correct.
         // If the standard Algerian tax scale is needed, calculateIrg(taxableIncome) must be implemented.
         const irgRate = 0.05; // 5%


         // Default empty compensation structure for new beneficiaries (Observations removed)
         const defaultCompensation = {
             type: 'اجراء', // Default compensation type
             nbrF: 0, brut: 0, ss: 0, irg: 0, net: 0
         };


// Function to calculate pay components (Brut, SS, IRG, Net) based on Compensation Type, Grade, and Nbr/F
        function calculatePay(compensationType, grade, nbrF) {
            const typeInfo = compensationTypes[compensationType];
            if (!typeInfo) {
                console.error(`Unknown compensation type: ${compensationType}`);
                return { taux: 0, brut: 0, ss: 0, irg: 0, net: 0 }; // Return zero values for unknown type
            }

            const taux = getTaux(compensationType, grade); // Use the existing getTaux function

            const brut = nbrF * taux;
            const ss = brut * ssRate;
            // Assuming IRG is calculated as 5% of (Brut - SS) based on the comment in the code
            const taxableIncome = brut - ss;
            const irg = taxableIncome > 0 ? taxableIncome * irgRate : 0; // Ensure IRG is not negative
            const net = brut - ss - irg;

            // Ensure calculated values are finite numbers
            const isFiniteCheck = isFinite(brut) && isFinite(ss) && isFinite(irg) && isFinite(net);

            if (!isFiniteCheck) {
                 console.error(`Calculated pay contains non-finite values for type "${compensationType}", grade "${grade}", nbrF "${nbrF}". Calculated:`, { brut, ss, irg, net });
                 // Return NaN or a specific error indicator if calculation results are invalid
                 return { taux: NaN, brut: NaN, ss: NaN, irg: NaN, net: NaN };
            }


            return {
                taux: taux, // Include taux in the return object
                brut: brut,
                ss: ss,
                irg: irg,
                net: net
            };
        }
        // --- Helper Functions ---
        function loadData() {
            try {
                const savedInstitutionInfo = localStorage.getItem('institutionInfo');
                const savedBeneficiaries = localStorage.getItem('beneficiaries');
                const savedReportCustomText = localStorage.getItem('reportCustomText'); // Load custom text
                 const savedSsReportCustomText = localStorage.getItem('ssReportCustomText'); // Load SS custom text


                // Load institution info
                if (savedInstitutionInfo) {
                    try {
                         const tempInfo = JSON.parse(savedInstitutionInfo);
                          institutionInfo = {
                              ...institutionInfo, // Start with defaults
                              ...tempInfo // Overlay saved values
                          };
                           // Ensure expected fields exist with defaults for older saves
                          if (institutionInfo.directorate === undefined) institutionInfo.directorate = "";
                          if (institutionInfo.financialMonth === undefined) institutionInfo.financialMonth = "";
                          if (institutionInfo.treasuryAccount === undefined) institutionInfo.treasuryAccount = "";
                          if (institutionInfo.paymentOrderNum === undefined) institutionInfo.paymentOrderNum = "";
                          if (institutionInfo.transferNum === undefined) institutionInfo.transferNum = "";

                    } catch (e) {
                        console.error("Failed to parse institutionInfo from localStorage:", e);
                    }
                }

                // Load beneficiaries
                if (savedBeneficiaries) {
                    try {
                        beneficiaries = JSON.parse(savedBeneficiaries);
                        beneficiaries.forEach(b => {
                            b.id = parseInt(b.id) || 0;
                            // Add/Ensure new fields with defaults for older saves
                             // Handle migration from old 'name' field to new 'lastName'/'firstName'
                            if (b.lastName === undefined && b.firstName === undefined) {
                                 // Attempt to split the old 'name' field (Assuming Lastname Firstname)
                                 const oldName = (b.name || '').trim();
                                 const parts = oldName.split(' ');
                                  // Assign first part to lastName and rest to firstName
                                 b.lastName = parts.shift() || '';
                                 b.firstName = parts.join(' ') || '';

                                  if (oldName && (b.firstName === '' && b.lastName === oldName)) {
                                       // If splitting didn't work well (e.g., single word name), assign to lastName and leave firstName empty
                                       b.lastName = oldName;
                                       b.firstName = '';
                                  } else if (oldName && (b.firstName === '' || b.lastName === '')) {
                                       console.warn(`Migration Warning: Ambiguous name split for "${oldName}" during load. Please edit beneficiary ID ${b.id} to correct Last Name and First Name.`);
                                  }
                                  // Clean up old 'name' field
                                  delete b.name;
                             } else {
                                  // Ensure fields exist even if undefined in newer saves
                                 b.lastName = b.lastName || '';
                                 b.firstName = b.firstName || '';
                                  // Clean up old 'name' field if it somehow persists alongside new fields
                                  delete b.name;
                             }


                            if (b.function === undefined) b.function = "مصصح/مراقب";
                            if (b.grade === undefined) b.grade = "P-Ser"; // Default grade
                            if (b.account === undefined) b.account = "";
                            if (b.ssNum === undefined) b.ssNum = ""; // New field
                            if (b.dob === undefined) b.dob = ""; // New field

                             // Ensure compensation structure exists and has correct fields, then recalculate pay
                             if (b.compensation === undefined || typeof b.compensation !== 'object' || b.compensation === null) {
                                 b.compensation = { ...defaultCompensation }; // Use spread to copy defaults
                             } else {
                                  // Ensure required compensation fields exist with defaults if missing
                                  // Ensure type is validated against available types, use default if invalid
                                 b.compensation.type = compensationTypes[b.compensation.type] ? b.compensation.type : defaultCompensation.type;
                                 b.compensation.nbrF = parseFloat(b.compensation.nbrF) || 0;
                                  // Add calculated fields if missing (will be recalculated anyway)
                                 if (b.compensation.brut === undefined) b.compensation.brut = 0;
                                 if (b.compensation.ss === undefined) b.compensation.ss = 0;
                                 if (b.compensation.irg === undefined) b.compensation.irg = 0;
                                 if (b.compensation.net === undefined) b.compensation.net = 0;


                                 // IMPORTANT: Recalculate brut, ss, irg, net based on saved inputs (nbrF) and current rules (type, grade)
                                  // This ensures consistency if calculation logic/rates change
                                  // Pass beneficiary grade when recalculating during load
                                 const calculatedPay = calculatePay(b.compensation.type, b.grade, b.compensation.nbrF);
                                 b.compensation.brut = calculatedPay.brut;
                                 b.compensation.ss = calculatedPay.ss;
                                 b.compensation.irg = calculatedPay.irg;
                                 b.compensation.net = calculatedPay.net;
                                 // Note: taux is not stored, it's derived
                             }

                        });
                        // Filter out invalid beneficiaries (e.g., id 0 or missing account)
                         beneficiaries = beneficiaries.filter(b => b.id > 0 && b.account);

                    } catch (e) {
                        console.error("Failed to parse beneficiaries from localStorage:", e);
                        beneficiaries = []; // Reset beneficiaries on error
                    }
                } else {
                     beneficiaries = []; // Start fresh if no saved data
                }

                // Load report custom text for standard reports
                if (savedReportCustomText) {
                    try {
                        const tempText = JSON.parse(savedReportCustomText);
                         // Ensure reportCustomText only contains keys defined in compensationTypes
                        reportCustomText = {};
                         Object.keys(compensationTypes).forEach(typeKey => {
                             reportCustomText[typeKey] = tempText[typeKey] || ''; // Use saved text or empty string
                         });
                    } catch (e) {
                        console.error("Failed to parse reportCustomText from localStorage:", e);
                         // If parsing fails, initialize with defaults below
                        reportCustomText = {};
                    }
                } else {
                     reportCustomText = {};
                }

                 // Ensure all compensation types have an entry in reportCustomText (standard reports), even if loading failed or none was saved
                 Object.keys(compensationTypes).forEach(typeKey => {
                     if (reportCustomText[typeKey] === undefined || reportCustomText[typeKey] === '') {
                          const typeName = compensationTypes[typeKey]?.name || 'نوع غير محدد';
                           reportCustomText[typeKey] = `كشف بأسماء الأساتذة ... لـ ${typeName} لسنة YYYY الشهر MM.`;
                     }
                 });

                // Load report custom text for SS reports
                 if (savedSsReportCustomText) {
                     try {
                         const tempText = JSON.parse(savedSsReportCustomText);
                          // Ensure ssReportCustomText only contains keys relevant to SS reports
                          // Now include the new type 'امانة_تصحيح' in the list of types relevant for SS reports
                         const ssReportTypes = ['تصحيح_متوسط', 'تصحيح_ثانوي', 'امانة_تصحيح'];
                         ssReportCustomText = {};
                          ssReportTypes.forEach(typeKey => {
                             ssReportCustomText[typeKey] = tempText[typeKey] || ''; // Use saved text or empty string
                          });
                     } catch (e) {
                         console.error("Failed to parse ssReportCustomText from localStorage:", e);
                         ssReportCustomText = {};
                     }
                 } else {
                      ssReportCustomText = {};
                 }

                 // Ensure SS report types have entries, even if loading failed or none saved
                 // Now include the new type 'امانة_تصحيح' in the list of types relevant for SS reports defaults
                 const ssReportTypesDefaults = ['تصحيح_متوسط', 'تصحيح_ثانوي', 'امانة_تصحيح'];
                 ssReportTypesDefaults.forEach(typeKey => {
                      if (ssReportCustomText[typeKey] === undefined || ssReportCustomText[typeKey] === '') {
                           const typeName = compensationTypes[typeKey]?.name || 'نوع غير محدد';
                           ssReportCustomText[typeKey] = `كشف بأسماء الأساتذة ... لـ ${typeName} (ضمان اجتماعي) لسنة YYYY الشهر MM.`; // Default SS text
                      }
                 });


                 // After loading/cleaning, sort beneficiaries by ID
                 beneficiaries.sort((a, b) => a.id - b.id);

                  console.log("Loaded Institution Info:", institutionInfo);
                  console.log("Loaded Beneficiaries:", beneficiaries);
                  console.log("Loaded Report Custom Text:", reportCustomText);
                  console.log("Loaded SS Report Custom Text:", ssReportCustomText);


            } catch (e) {
                console.error("An error occurred during initial data loading:", e);
                alert("حدث خطأ أثناء تحميل البيانات المحفوظة. قد تكون البيانات قديمة أو تالفة.");
            }
        }

        function saveData() {
            try {
                 localStorage.setItem('institutionInfo', JSON.stringify(institutionInfo));
                // Stringify beneficiaries after ensuring 'observations' is removed from the objects
                 const beneficiariesToSave = beneficiaries.map(b => {
                      const bCopy = {...b}; // Create a shallow copy
                       // No need to explicitly remove observations here as it's not added anymore
                       // if (bCopy.compensation && bCopy.compensation.observations !== undefined) {
                       //      delete bCopy.compensation.observations;
                       // }
                       return bCopy;
                 });

                localStorage.setItem('beneficiaries', JSON.stringify(beneficiariesToSave));
                localStorage.setItem('reportCustomText', JSON.stringify(reportCustomText)); // Save standard custom text
                localStorage.setItem('ssReportCustomText', JSON.stringify(ssReportCustomText)); // Save SS custom text

                 console.log("Data saved to localStorage.");
            } catch (e) {
                console.error("An error occurred during data saving:", e);
                alert("حدث خطأ أثناء حفظ البيانات. قد لا يتم حفظ التغييرات.");
            }
        }

        function getNextBeneficiaryId() {
            if (beneficiaries.length === 0) {
                return 1;
            }
            const maxId = Math.max(...beneficiaries.map(b => parseInt(b.id) || 0));
            return maxId > 0 ? maxId + 1 : 1;
        }

        // Function to calculate the 20-digit RIP from a CCP number string (from your provided file)
        // Uses BigInt for accurate large number arithmetic. Returns 20-char RIP string or error string.
        function calculateRIP(ccpNumberString) {
            try {
                if (!ccpNumberString || typeof ccpNumberString !== 'string' || ccpNumberString.trim() === '') {
                    return ''; // Return empty string for empty input
                }

                const ccpValue = ccpNumberString.trim().replace(/\D/g, ''); // Remove non-digits

                 // Basic validation: must be digits only
                 if (!/^\d+$/.test(ccpValue)) {
                      console.warn(`RIP Calc Warning: Non-numeric CCP input "${ccpNumberString}".`);
                      return 'رقم CCP غير صالح'; // Return error indicator for non-numeric input
                 }

                 // Standard length check (14 digits for standard CCP)
                 if (ccpValue.length !== 14) {
                       console.warn(`RIP Calc Warning: CCP input "${ccpValue}" has invalid length (${ccpValue.length}). Expected 14 digits for standard CCP.`);
                       // Proceed with calculation anyway, but warn.
                 }


                let ccpBigIntValue;
                try {
                     ccpBigIntValue = BigInt(ccpValue);
                } catch (e) {
                    console.error(`RIP Calc Error: Cannot convert CCP "${ccpNumberString}" to BigInt.`, e);
                     return 'خطأ في التحويل'; // Return error indicator if conversion fails
                }


                // Calculate ripKey (0-96 range, based on the original code logic)
                // Using BigInt for intermediate steps for precision
                const ccpTimes100BigInt = ccpBigIntValue * BigInt(100);
                const remainder97BigInt = ccpTimes100BigInt % BigInt(97);
                let ripKeyCalcBigInt = BigInt(85) + remainder97BigInt;
                let finalRipKeyBigInt = ripKeyCalcBigInt;

                if (finalRipKeyBigInt > BigInt(97)) {
                    finalRipKeyBigInt = BigInt(97) - (finalRipKeyBigInt - BigInt(97));
                } else {
                    finalRipKeyBigInt = BigInt(97) - finalRipKeyBigInt;
                }

                // Calculate the 'r' part (13 digits) using BigInt
                const constantToAddBigInt = BigInt('9000000000000'); // The large constant from the external page
                const r_part_bigint = (ccpBigIntValue * BigInt(100)) + finalRipKeyBigInt + constantToAddBigInt;

                // Convert r_part_bigint to string and pad/truncate to exactly 13 digits
                const r_part_string = r_part_bigint.toString();
                // Pad with leading zeros to ensure a minimum length of 13 characters
                const padded_r_part_string = r_part_string.padStart(13, '0');
                // Take the rightmost 13 characters (handles cases where the number might become slightly longer than 13 after calculation)
                const final_r_part_string = padded_r_part_string.substring(padded_r_part_string.length - 13);


                // Concatenate fixed prefix and padded r_part_string
                const fixedPrefix = "0079999"; // Bank and Branch codes (7 chars)
                const fullRIP = fixedPrefix + final_r_part_string;

                // Final length check (should be 7 + 13 = 20)
                if (fullRIP.length !== 20) {
                     console.error(`RIP Calc Error: Generated RIP "${fullRIP}" has incorrect length (${fullRIP.length}) for CCP: "${ccpNumberString}".`);
                     return 'خطأ في الطول'; // Return specific error indicator for length mismatch
                }

                return fullRIP; // Return the calculated 20-character RIP

            } catch (e) {
                console.error(`An unexpected error occurred during RIP calculation for CCP "${ccpNumberString}".`, e);
                return 'خطأ غير متوقع'; // Return generic error indicator for unexpected errors
            }
        }

        // Helper function to update RIP display for an input field
        function updateCalculatedRIPDisplay(ccpInputId, ripOutputId, feedbackSpanId) {
             const ccpInput = document.getElementById(ccpInputId);
             const ripOutput = document.getElementById(ripOutputId);
             const feedbackSpan = document.getElementById(feedbackSpanId);

             if (!ccpInput || !ripOutput || !feedbackSpan) {
                 console.error(`Missing elements for RIP display update: CCP=${ccpInputId}, RIP=${ripOutputId}, Feedback=${feedbackSpanId}`);
                 return;
             }

             const ccpValue = ccpInput.value.trim();
             ripOutput.value = ''; // Clear output initially
             feedbackSpan.textContent = ''; // Clear feedback initially
             ccpInput.classList.remove('invalid'); // Remove invalid class initially


             if (ccpValue === '') {
                 return; // Do nothing if input is empty
             }

              // Basic validation: must be digits only
              if (!/^\d+$/.test(ccpValue)) {
                  feedbackSpan.textContent = 'يجب أن يحتوي رقم الحساب على أرقام فقط.';
                  ccpInput.classList.add('invalid');
                   console.warn(`RIP Calc Warning: Non-numeric CCP input "${ccpValue}".`);
                  return;
              }

              // Standard length check (14 digits for standard CCP)
             if (ccpValue.length !== 14) {
                  feedbackSpan.textContent = 'تنبيه: رقم الحساب يتكون من ' + ccpValue.length + ' رقماً. رقم CCP القياسي يتكون من 14 رقماً.';
                  // Don't mark as strictly invalid just for length warning unless calculateRIP also fails
             }


             const rip = calculateRIP(ccpValue);

             if (rip && !rip.includes('خطأ') && rip.length === 20) { // Check for calculated length too
                 ripOutput.value = rip;
                 feedbackSpan.textContent = ''; // Clear any previous warning/error
                 ccpInput.classList.remove('invalid');
             } else {
                 ripOutput.value = ''; // Clear RIP if calculation fails
                 feedbackSpan.textContent = `خطأ في حساب رقم RIP: ${rip}`; // Display the error message from calculateRIP
                 ccpInput.classList.add('invalid'); // Mark input as invalid if RIP calc failed or length is wrong
                  console.error(`RIP calculation failed for CCP "${ccpValue}": ${rip}`);
             }
         }


        // Function to format currency with Algerian separators
        function formatCurrency(amount) {
            const numAmount = parseFloat(amount) || 0;
             // Check for non-finite numbers
             if (!isFinite(numAmount)) {
                  console.warn(`formatCurrency: Invalid number input "${amount}". Returning "خطأ".`);
                  return "خطأ";
             }
            // Format with 2 decimal places, use '٫' for decimal, and '٬' for thousands
            return numAmount.toFixed(2).replace('.', '٫').replace(/\B(?=(\d{3})+(?!\d))/g, '٬');
        }

        // Function to convert numbers to Arabic text representation (from your provided file)
        function numberToArabicText(amount) {
             // Round to 2 decimal places and separate integer and decimal parts
            const roundedAmount = Math.round(amount * 100) / 100;
            const [integerPart, decimalPart] = roundedAmount.toFixed(2).split('.');

            // Arrays for Arabic number naming
            const onesArabic = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة', 'عشرة',
                              'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
            const tensArabic = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
             // Simplified plural forms for thousands and millions
             const thousandForms = ['', 'ألف', 'ألفان', 'آلاف']; // for 1, 2, 3-10
             const millionForms = ['', 'مليون', 'مليونان', 'ملايين']; // for 1, 2, 3-10


            function processThreeDigits(num) {
                if (num === 0) return '';

                const hundred = Math.floor(num / 100);
                const remainder = num % 100;

                let result = '';
                if (hundred > 0) {
                    result += hundreds[hundred];
                    if (remainder > 0) result += ' و ';
                }

                if (remainder > 0 && remainder < 20) {
                    result += onesArabic[remainder];
                } else if (remainder >= 20) {
                    const tens = Math.floor(remainder / 10);
                    const ones = remainder % 10;

                    if (ones > 0) {
                        result += onesArabic[ones] + ' و ' + tensArabic[tens];
                    } else {
                        result += tensArabic[tens];
                    }
                }

                return result;
            }

             // Helper to get the correct plural form for thousands or millions
             function getPluralForm(count, forms) {
                  if (count === 1) return forms[1]; // ألف, مليون
                  if (count === 2) return forms[2]; // ألفان, مليونان
                  if (count >= 3 && count <= 10) return forms[3]; // آلاف, ملايين
                  return forms[1]; // Default singular form for > 10 (e.g., ثلاثون ألف)
             }


            // Convert integer part
            const intValue = parseInt(integerPart);
            if (isNaN(intValue)) intValue = 0; // Handle cases where integerPart is not a number
            const decValue = parseInt(decimalPart);
            if (isNaN(decValue)) decValue = 0; // Handle cases where decimalPart is not a number


            if (intValue === 0 && decValue === 0) return 'صفر دينار'; // Handle exact zero

            let result = '';
            const parts = [];

             // Process millions
             const millionPart = Math.floor(intValue / 1000000);
             const remainingAfterMillions = intValue % 1000000;

             if (millionPart > 0) {
                  const millionText = processThreeDigits(millionPart);
                   parts.push(millionText + ' ' + getPluralForm(millionPart, millionForms));
             }


             // Process thousands
             const thousandPart = Math.floor(remainingAfterMillions / 1000);
              const remainingAfterThousands = remainingAfterMillions % 1000;

              if (thousandPart > 0) {
                   const thousandText = processThreeDigits(thousandPart);
                   // Special case for 1000, 2000, 3000-10000 (handled by getPluralForm)
                   // Also need to correctly handle "واحد ألف" vs "ألف"
                    if (thousandPart === 1 && remainingAfterThousands === 0 && millionPart === 0) {
                       // If it's exactly 1000 and nothing else
                       parts.push('ألف');
                   } else {
                      parts.push(thousandText + ' ' + getPluralForm(thousandPart, thousandForms));
                   }
              }


             // Process remainder (hundreds, tens, ones)
             const remainPart = intValue % 1000;
             if (remainPart > 0) {
                 parts.push(processThreeDigits(remainPart));
             }


             // Combine parts with " و "
            result = parts.join(' و ');


            // Add currency unit for integer part
            if (intValue > 0) {
                 if (intValue === 1) result += ' دينار';
                 else if (intValue === 2) result += ' ديناران';
                 else if (intValue >= 3 && intValue <= 10) result += ' دنانير';
                 else result += ' دينار'; // Default for > 10
             } else if (decValue > 0 && result === '') {
                  // If integer part is 0 but decimal part exists and no integer text was generated (e.g., 0.50),
                  // we don't add "دينار". The decimal part adds "سنتيم".
                  // Example: 0.50 should be "خمسون سنتيم", not "صفر دينار و خمسون سنتيم"
             } else { // intValue is 0 and decValue is 0, or intValue is 0 but there were thousands/millions
                 // If result is empty and intValue is 0, it means the number is less than 1000 (and no millions/thousands).
                 // We only add "دينار" if the integer part is > 0, or if the integer part is 0 but there were thousands/millions,
                 // AND we are not adding a decimal part later.
                 if (intValue === 0 && (millionPart > 0 || thousandPart > 0) && remainPart === 0 && decValue === 0) {
                       // Case like 1,000,000 or 10,000 or 2000 - need "دينار"
                       result += ' دينار';
                 }
             }


            // Add decimal part if not zero
            if (decValue > 0) {
                 const decimalValue = decValue;
                 let centsUnit = 'سنتيم';
                 if (decimalValue === 1) centsUnit = 'سنتيم';
                 else if (decimalValue === 2) centsUnit = 'سنتيمان';
                 else if (decimalValue >= 3 && decimalValue <= 10) centsUnit = 'سنتيمات';
                 else centsUnit = 'سنتيم';

                 // Add "و" only if there was an integer part or if the integer part was zero but contained thousands/millions
                 if (result !== '' && result !== 'صفر دينار') { // Check for non-empty integer text
                      result += ' و ';
                 } else if (result === 'صفر دينار') { // If it was just "صفر دينار", replace it
                     result = '';
                 }


                result += processThreeDigits(decimalValue) + ' ' + centsUnit;

            }

            // Clean up leading/trailing spaces and " و "
            result = result.replace(/^ و /, '').replace(/ و $/, '');
             // Ensure at least "دينار" or "سنتيم" is included if result is empty after processing
             if (result === '') {
                 if (decValue > 0) return processThreeDigits(decValue) + ' سنتيم';
                 if (intValue > 0) return processThreeDigits(intValue) + ' دينار';
                  // This case should logically not happen for intValue >= 0, decValue >= 0 unless both are 0.
                  // The original check for 0,0 handled this.
                 console.warn("numberToArabicText: Unexpected empty result for non-zero input or logic error.");
                 return 'خطأ في التحويل'; // Indicate conversion issue if logic fails
             }


            return result;
        }


        // --- Tab Navigation ---
        function showSection(sectionId) {
            // Hide all main panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });

            // Deactivate all main tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the requested main panel and activate its button
            const panelToShow = document.getElementById(sectionId + '-panel');
            if (panelToShow) {
                 panelToShow.style.display = 'block';
                 const buttonToActivate = document.querySelector(`.tab-button[data-tab="${sectionId}"]`);
                 if(buttonToActivate) {
                     buttonToActivate.classList.add('active');
                 }

                 // Perform section-specific actions when showing
                 if (sectionId === 'institution') {
                      populateInstitutionForm();
                 } else if (sectionId === 'beneficiary') {
                      // When showing beneficiary panel, apply the *current* filter
                      applyBeneficiaryFilter(currentBeneficiaryFilterType); // Use the global filter type
                      // Clear beneficiary add form and compensation inputs
                      document.getElementById('add-beneficiary-form').reset();
                       document.getElementById('rib').value = ''; // Calculated RIP
                       document.getElementById('beneficiary-ccp-input').classList.remove('invalid');
                       document.getElementById('beneficiary-ccp-feedback').textContent = '';
                       document.getElementById('ss-num').value = ''; // SSN
                       document.getElementById('dob').value = ''; // DoB
                       document.getElementById('last-name').value = ''; // Clear lastName
                       document.getElementById('first-name').value = ''; // Clear firstName


                       // Compensation inputs in add form (using add- prefix)
                       document.getElementById('add-nbr-f').value = '0';
                       document.getElementById('compensation-type-add').value = defaultCompensation.type; // Reset type
                       document.getElementById('add-grade').value = 'P-Ser'; // Reset grade (corrected ID)

                       // Trigger calculation update for the add form based on default values
                       updatePayCalculations('add');


                 } else if (sectionId === 'reports') {
                    // When showing the reports tab, show the first nested tab by default and force preview
                    const firstAvailableTabButton = reportsPanel.querySelector('.nested-tab-button');
                    let tabToShow = firstAvailableTabButton ? firstAvailableTabButton.getAttribute('data-nested-tab') : Object.keys(compensationTypes)[0];
                    showNestedReportTab('reports', tabToShow);


                 } else if (sectionId === 'social-security-reports') {
                    // When showing the SS reports tab, show the first SS nested tab by default and force preview
                    const ssReportsPanelNestedTabs = ssReportsPanel.querySelector('.nested-tabs');
                    const firstAvailableSsTabButton = ssReportsPanelNestedTabs.querySelector('.nested-tab-button');
                    let firstSsReportType = firstAvailableSsTabButton ? firstAvailableSsTabButton.getAttribute('data-nested-tab') : 'تصحيح_متوسط';
                    showNestedReportTab('social-security-reports', firstSsReportType);


                 }
                 else if (sectionId === 'backup') {
                      // Nothing specific to do for backup
                 }

            } else {
                console.error("Main panel not found for tab:", sectionId);
            }
        }

         // --- Nested Tab Navigation for Reports ---
         // Modified to accept containerId (e.g., 'reports', 'social-security-reports')
         function showNestedReportTab(containerId, reportType) {
              const containerElement = document.getElementById(`${containerId}-panel`);
              if (!containerElement) {
                  console.error(`Nested tab container panel not found: ${containerId}-panel`);
                  return;
              }

              // Hide all nested panels within this container
             containerElement.querySelectorAll('.nested-tab-panel').forEach(panel => {
                 panel.style.display = 'none';
             });

             // Deactivate all nested tab buttons within this container
             containerElement.querySelectorAll('.nested-tab-button').forEach(button => {
                 button.classList.remove('active');
             });

             // Show the requested nested panel and activate its button within this container
             const panelToShow = containerElement.querySelector(`#${containerId}-${reportType}-nested-panel`);
              if (panelToShow) {
                  panelToShow.style.display = 'block';
                  const buttonToActivate = containerElement.querySelector(`.nested-tab-button[data-nested-tab="${reportType}"]`);
                  if(buttonToActivate) {
                      buttonToActivate.classList.add('active');
                  }

                  // Populate the custom text input for this report type and container
                  // Use the correct storage object (reportCustomText or ssReportCustomText)
                  const customTextStorage = containerId === 'reports' ? reportCustomText : ssReportCustomText;
                  // FIX: Correctly form the custom text input ID based on containerId
                  const customTextInputId = containerId === 'social-security-reports'
                                            ? `ss-custom-report-text-${reportType}` // Use 'ss-' prefix for social-security-reports panel inputs
                                            : `${containerId}-custom-report-text-${reportType}`; // Use containerId prefix for others (like 'reports')

                   const customTextInput = document.getElementById(customTextInputId);
                   if (customTextInput) {
                       customTextInput.value = customTextStorage[reportType] || '';
                   } else {
                       // This warning is less critical now with the ID fix, but still useful if an ID is missing in HTML
                       console.warn(`Custom text input not found for report type: ${reportType} in container ${containerId}. Looked for ID: "${customTextInputId}"`);
                   }


                  // Generate report preview for the selected type and container
                  generateReportPreview(containerId, reportType);

              } else {
                  console.error(`Nested panel not found for type: ${reportType} in container ${containerId}.`);
              }
         }


        // --- Institution Info Management ---
        function populateInstitutionForm() {
             document.getElementById('republic').value = institutionInfo.republic;
             document.getElementById('ministry').value = institutionInfo.ministry;
             document.getElementById('directorate').value = institutionInfo.directorate;
             document.getElementById('onfed').value = institutionInfo.onfed;
             document.getElementById('institution').value = institutionInfo.institution;
             document.getElementById('fiscal-year').value = institutionInfo.fiscalYear;
             document.getElementById('financial-month').value = institutionInfo.financialMonth;
             document.getElementById('treasury-ccp-input').value = institutionInfo.treasuryAccount;
             document.getElementById('payment-order-num').value = institutionInfo.paymentOrderNum;
             document.getElementById('transfer-num').value = institutionInfo.transferNum;

            // Immediately calculate and display RIP based on loaded CCP
             updateCalculatedRIPDisplay('treasury-ccp-input', 'treasury-rib', 'treasury-ccp-feedback');
        }

        function saveInstitutionInfo(event) {
            event.preventDefault();
            try {
                 // Validate Treasury CCP before saving institution info
                 const treasuryCcpInput = document.getElementById('treasury-ccp-input');
                  if (treasuryCcpInput.classList.contains('invalid') || !document.getElementById('treasury-rib').value) {
                      alert("لا يمكن حفظ معلومات المؤسسة.\nالرجاء تصحيح رقم الحساب البريدي للخزينة وإدخاله بشكل صحيح.");
                      treasuryCcpInput.focus();
                      return;
                  }


                institutionInfo.directorate = document.getElementById('directorate').value.trim();
                institutionInfo.fiscalYear = document.getElementById('fiscal-year').value.trim();
                institutionInfo.financialMonth = document.getElementById('financial-month').value.trim();
                institutionInfo.treasuryAccount = document.getElementById('treasury-ccp-input').value.trim();
                 institutionInfo.paymentOrderNum = document.getElementById('payment-order-num').value.trim();
                 institutionInfo.transferNum = document.getElementById('transfer-num').value.trim();

                // Fixed values (get from readonly fields just in case they were changed in HTML)
                institutionInfo.republic = document.getElementById('republic').value;
                institutionInfo.ministry = document.getElementById('ministry').value;
                institutionInfo.onfed = document.getElementById('onfed').value;
                institutionInfo.institution = document.getElementById('institution').value;


                saveData();
                alert('تم حفظ معلومات المؤسسة بنجاح.');

                // After saving institution info, update ALL report previews as header info might change
                // Update standard reports
                Object.keys(compensationTypes).forEach(type => {
                    if (document.getElementById(`reports-${type}-nested-panel`)) { // Check if panel exists
                        generateReportPreview('reports', type);
                    }
                });
                // Update SS reports
                 // Include the new type 'امانة_تصحيح' in the list of types relevant for SS reports
                 ['تصحيح_متوسط', 'تصحيح_ثانوي', 'امانة_تصحيح'].forEach(type => {
                     if (document.getElementById(`social-security-reports-${type}-nested-panel`)) { // Check if panel exists
                        generateReportPreview('social-security-reports', type);
                     }
                 });


            } catch (e) {
                console.error("Error saving institution info:", e);
                alert("حدث خطأ أثناء حفظ معلومات المؤسسة.");
            }
        }


        // --- Beneficiary Management (Add/Edit/Delete) ---

         // Function to get the correct Taux value based on Compensation Type and Grade
         function getTaux(compensationType, grade) {
             // console.log(`getTaux called with Type: ${compensationType}, Grade: ${grade}`); // Log inputs
             const typeInfo = compensationTypes[compensationType];
             if (!typeInfo) {
                 console.error(`Unknown compensation type: ${compensationType}`);
                 return 0; // Default to 0 for unknown type
             }

             // --- MODIFIED: Include 'امانة_تصحيح' in the grade-dependent calculation logic ---
             if (compensationType === 'اجراء' || compensationType === 'امانة_تصحيح') {
                 // Logic for 'اجراء' and 'امانة_تصحيح' types depends on Grade
                 const gradeUpper = (grade || '').toUpperCase().trim();
                 const gradeNum = parseInt(gradeUpper);

                 if (gradeUpper === 'P-SER') {
                     // Assuming P-Ser maps to the 10-11 range based on your Excel example
                      // console.log(`Grade P-Ser mapped to 10-11 range. Taux: ${typeInfo.tauxRates['10-11']}`);
                      return typeInfo.tauxRates['10-11'] || typeInfo.defaultTaux; // Fallback to default if specific rate is missing
                 }

                 if (!isNaN(gradeNum)) {
                     if (gradeNum < 10) { // console.log(`Grade < 10 (${gradeNum}). Taux: ${typeInfo.tauxRates['<10']}`);
                         return typeInfo.tauxRates['<10'] || typeInfo.defaultTaux; }
                     if (gradeNum >= 10 && gradeNum <= 11) { // console.log(`Grade 10-11 (${gradeNum}). Taux: ${typeInfo.tauxRates['10-11']}`);
                         return typeInfo.tauxRates['10-11'] || typeInfo.defaultTaux; }
                     if (gradeNum === 12) { // console.log(`Grade 12 (${gradeNum}). Taux: ${typeInfo.tauxRates['12']}`);
                         return typeInfo.tauxRates['12'] || typeInfo.defaultTaux; }
                     if (gradeNum === 13) { // console.log(`Grade 13 (${gradeNum}). Taux: ${typeInfo.tauxRates['13']}`);
                         return typeInfo.tauxRates['13'] || typeInfo.defaultTaux; }
                     // Handle other numeric grades if needed, default below
                 }

                 // Default for 'اجراء' or 'امانة_تصحيح' if grade doesn't match any specific rate
                 console.warn(`No specific taux rate found for grade "${grade}" in compensation type "${compensationType}". Using default "${typeInfo.defaultTaux}".`);
                 return typeInfo.defaultTaux; // which is 0 for 'اجراء' and 'امانة_تصحيح' default
             } else {
                 // Fixed taux for other types (تصحيح_متوسط, تصحيح_ثانوي)
                 // console.log(`Fixed taux for type ${compensationType}: ${typeInfo.tauxRates['default']}`);
                 return typeInfo.tauxRates['default'];
             }
         }


     // Update calculated pay fields in the form whenever inputs change
     // This function ONLY updates the READONLY fields in the form,
     // it does NOT update the beneficiary object directly.
     // The actual object update happens in addBeneficiary and saveEditedBeneficiary.
    function updatePayCalculations(formPrefix = 'add') { // 'add' or 'edit'
        try {
             // Get inputs from the specified form
             const nbrFInput = document.getElementById(`${formPrefix}-nbr-f`);
             const compTypeInput = document.getElementById(`${formPrefix}-compensation-type${formPrefix === 'add' ? '-add' : ''}`);
             const gradeInput = document.getElementById(`${formPrefix}-grade`);

             // Get output fields from the same form (these are hidden in the UI now, but we still update their values)
             const tauxInput = document.getElementById(`${formPrefix}-taux`);
             const brutInput = document.getElementById(`${formPrefix}-brut`);
             const ssInput = document.getElementById(`${formPrefix}-ss`);
             const irgInput = document.getElementById(`${formPrefix}-irg`);
             const netInput = document.getElementById(`${formPrefix}-net`);

             // console.log(`updatePayCalculations called for form: ${formPrefix}`); // Log function call

             if (!nbrFInput || !compTypeInput || !gradeInput || !tauxInput || !brutInput || !ssInput || !irgInput || !netInput) {
                 console.error(`Missing elements for pay calculation update for form: ${formPrefix}. Cannot perform calculations.`);
                  // Reset calculated fields to error state
                  if (tauxInput) tauxInput.value = 'خطأ';
                  if (brutInput) brutInput.value = 'خطأ';
                  if (ssInput) ssInput.value = 'خطأ';
                  if (irgInput) irgInput.value = 'خطأ';
                  if (netInput) netInput.value = 'خطأ';
                 return;
             }

             const nbrF = parseFloat(nbrFInput.value) || 0;
             const compType = compTypeInput.value;
             const grade = gradeInput.value.trim();

              // console.log(`Inputs read for ${formPrefix} form: Nbr/F=${nbrF}, Type=${compType}, Grade=${grade}`); // Log inputs read


             // Perform calculations using the gathered inputs
             const calculatedPay = calculatePay(compType, grade, nbrF);

             // Update the readonly output fields (even if hidden)
             tauxInput.value = isFinite(calculatedPay.taux) ? calculatedPay.taux.toFixed(2) : 'خطأ';
             brutInput.value = isFinite(calculatedPay.brut) ? calculatedPay.brut.toFixed(2) : 'خطأ';
             ssInput.value = isFinite(calculatedPay.ss) ? calculatedPay.ss.toFixed(2) : 'خطأ';
             irgInput.value = isFinite(calculatedPay.irg) ? calculatedPay.irg.toFixed(2) : 'خطأ';
             netInput.value = isFinite(calculatedPay.net) ? calculatedPay.net.toFixed(2) : 'خطأ';

         } catch (e) {
            console.error(`Error in updatePayCalculations for form "${formPrefix}":`, e);
            // Display error on fields (even if hidden)
             document.getElementById(`${formPrefix}-taux`).value = 'خطأ';
             document.getElementById(`${formPrefix}-brut`).value = 'خطأ';
             document.getElementById(`${formPrefix}-ss`).value = 'خطأ';
             document.getElementById(`${formPrefix}-irg`).value = 'خطأ';
             document.getElementById(`${formPrefix}-net`).value = 'خطأ';
         }
    }


        function addBeneficiary(event) {
            event.preventDefault();
            try {
                // Get all inputs from the add form
                const lastNameInput = document.getElementById('last-name');
                const firstNameInput = document.getElementById('first-name');
                const functionInput = document.getElementById('function');
                const gradeInput = document.getElementById('add-grade');
                const ccpInput = document.getElementById('beneficiary-ccp-input');
                const ripDisplay = document.getElementById('rib');
                const feedbackSpan = document.getElementById('beneficiary-ccp-feedback');
                const ssNumInput = document.getElementById('ss-num');
                const dobInput = document.getElementById('dob');
                const compTypeAddInput = document.getElementById('compensation-type-add');
                const nbrFInput = document.getElementById('add-nbr-f');


                const lastName = lastNameInput.value.trim();
                const firstName = firstNameInput.value.trim();
                const functionValue = functionInput.value.trim();
                const gradeValue = gradeInput.value.trim();
                const account = ccpInput.value.trim(); // CCP
                const ssNum = ssNumInput.value.trim();
                const dob = dobInput.value;
                const compensationType = compTypeAddInput.value;
                const nbrF = parseFloat(nbrFInput.value) || 0; // Get nbrF input


                 // Combine name for validation requiring Latin characters
                 const fullName = ((lastName || '').trim() + ' ' + (firstName || '').trim()).trim();
                 // Regex allows Latin letters, spaces, hyphens, and Arabic characters (to allow mixed names if needed, but TXT needs Latin)
                 // Let's stick to the Latin-only requirement for names that go into TXT/XLSX.
                 const latinPattern = /^[a-zA-Z\s\-]+$/;


                // --- Validation ---

                if (!lastName || !firstName || !account || !functionValue || !gradeValue || !compensationType) {
                    alert('الرجاء ملء جميع الحقول الإلزامية في قسم "إضافة مستفيد جديد".');
                    return;
                }

                if (!fullName || !latinPattern.test(fullName)) {
                    alert('الرجاء إدخال اللقب والاسم باستخدام الأحرف اللاتينية والمسافات وعلامة الطرح (-) فقط لضمان صحة ملفات التصدير.');
                    lastNameInput.focus(); // Focus the first name field for correction
                    return;
                }

                // Social Security Number validation (12 digits if not "اجراء")
                if (compensationType !== 'اجراء') {
                    if (!/^\d{12}$/.test(ssNum)) {
                        alert('رقم الضمان الاجتماعي يجب أن يتكون من 12 رقمًا (أرقام فقط) لهذا النوع من التعويض.');
                        ssNumInput.focus();
                        return;
                    }
                }


                const calculatedRIP = ripDisplay.value; // Get the automatically calculated RIP
                if (!calculatedRIP || calculatedRIP.includes('خطأ')) {
                    alert('رقم الحساب (CCP) المدخل غير صالح لحساب رقم RIP. الرجاء التحقق من الرقم المدخل.');
                     ccpInput.focus();
                    return;
                }
                 // Check for invalid class from the input handler
                 if (ccpInput.classList.contains('invalid')) {
                     alert(feedbackSpan.textContent || 'رقم الحساب (CCP) المدخل غير صالح.');
                     ccpInput.focus();
                     return;
                 }

                // Check for duplicate CCP (ignoring non-digits for comparison)
                 const cleanedAccount = account.replace(/\D/g, '');
                 if (beneficiaries.some(b => b.account.replace(/\D/g, '') === cleanedAccount)) {
                     alert(`رقم الحساب (CCP) "${account}" مسجل بالفعل لمستفيد آخر.`);
                     ccpInput.focus();
                     return;
                 }

                // --- Perform Pay Calculation based on current form INPUTS ---
                 // Calculate pay directly using input values, not readonly fields
                 const calculatedPay = calculatePay(compensationType, gradeValue, nbrF);

                 // Basic validation of calculated net amount
                 if (!isFinite(calculatedPay.net)) {
                     alert("لا يمكن إضافة المستفيد. القيمة النهائية للصافي غير صالحة.\nالرجاء التحقق من مدخلات عدد الساعات/الأوراق أو الصنف.");
                     console.error("Attempted to add beneficiary with invalid calculated net amount:", calculatedPay.net);
                     return;
                 }


                 // --- Create new beneficiary object ---
                 const newBeneficiary = {
                     id: getNextBeneficiaryId(),
                     lastName: lastName, // Store separately
                     firstName: firstName, // Store separately
                     function: functionValue,
                     grade: gradeValue,
                     account: account, // Store the entered CCP
                     ssNum: ssNum, // Store SSN
                     dob: dob, // Store DoB
                     compensation: { // Store compensation data (inputs and calculated)
                         type: compensationType, // Use the type from input
                         nbrF: nbrF, // Use nbrF from input
                         // Use the freshly calculated values:
                         brut: calculatedPay.brut,
                         ss: calculatedPay.ss,
                         irg: calculatedPay.irg,
                         net: calculatedPay.net
                     }
                 };

                beneficiaries.push(newBeneficiary);
                saveData(); // Save updated beneficiaries list

                // Apply the current filter after adding, then re-render the table
                 applyBeneficiaryFilter(currentBeneficiaryFilterType);


                // Refresh the report preview ONLY for the type that was just added in BOTH report panels if applicable
                 if (document.getElementById(`reports-${newBeneficiary.compensation.type}-nested-panel`)) {
                     generateReportPreview('reports', newBeneficiary.compensation.type);
                 }
                 if (document.getElementById(`social-security-reports-${newBeneficiary.compensation.type}-nested-panel`)) {
                     generateReportPreview('social-security-reports', newBeneficiary.compensation.type);
                 }


                // Clear form and reset calculated fields/feedback
                document.getElementById('add-beneficiary-form').reset();
                 ripDisplay.value = '';
                 feedbackSpan.textContent = '';
                 ccpInput.classList.remove('invalid');
                 dobInput.value = ''; // Explicitly clear date input
                 document.getElementById('last-name').value = ''; // Clear lastName
                 document.getElementById('first-name').value = ''; // Clear firstName

                 // Reset compensation inputs and calculated fields in the add form
                 document.getElementById('add-nbr-f').value = '0';
                 document.getElementById('compensation-type-add').value = defaultCompensation.type; // Reset type
                 document.getElementById('add-grade').value = 'P-Ser'; // Reset grade in add form

                 // Trigger calculation update for the add form based on reset values
                 updatePayCalculations('add');


                lastNameInput.focus(); // Focus the first input field for the next entry
                 alert('تم إضافة المستفيد بنجاح.');
             } catch (e) {
                 console.error("Error adding beneficiary:", e);
                 alert("حدث خطأ أثناء إضافة المستفيد.");
             }
        }

    function deleteBeneficiary(beneficiaryIdToDelete) {
        const beneficiaryToDelete = beneficiaries.find(b => b.id === beneficiaryIdToDelete);
        // Get type before deleting the beneficiary from the array
        const typeToDelete = beneficiaryToDelete?.compensation?.type;

         // Combine name for confirmation message
        const beneficiaryFullName = ((beneficiaryToDelete?.lastName || '').trim() + ' ' + (beneficiaryToDelete?.firstName || '').trim()).trim();


        if (confirm(`هل أنت متأكد من حذف المستفيد "${beneficiaryFullName}" (رقم ${beneficiaryIdToDelete}) وجميع بياناته؟`)) {
            try {
                beneficiaries = beneficiaries.filter(b => b.id !== beneficiaryIdToDelete);

                 // Re-index beneficiaries from 1
                 beneficiaries.forEach((beneficiary, index) => {
                     beneficiary.id = index + 1;
                 });

                saveData(); // Save updated list

                // Apply the current filter after deleting, then re-render the table
                applyBeneficiaryFilter(currentBeneficiaryFilterType);


                 // Refresh the report preview for the type that was just deleted in BOTH panels if applicable
                 if (typeToDelete) {
                     if (document.getElementById(`reports-${typeToDelete}-nested-panel`)) {
                          generateReportPreview('reports', typeToDelete);
                     }
                      if (document.getElementById(`social-security-reports-${typeToDelete}-nested-panel`)) {
                         generateReportPreview('social-security-reports', typeToDelete);
                     }
                 }


                  alert(`تم حذف المستفيد "${beneficiaryFullName}". تم تحديث الترقيم والقوائم.`);

            } catch (e) {
                console.error("Error during beneficiary deletion:", e);
                alert("حدث خطأ أثناء حذف المستفيد.");
            }
        }
    }

    function editBeneficiary(beneficiaryIdToEdit) {
         try {
             const beneficiary = beneficiaries.find(b => b.id === beneficiaryIdToEdit);

             if (!beneficiary) {
                 alert('خطأ: لم يتم العثور على بيانات المستفيد المراد تعديله.');
                 console.error(`Attempted to edit non-existent beneficiary ID: ${beneficiaryIdToEdit}`);
                 return;
             }

             // Store original compensation type in a data attribute on the modal
             // This is needed later to update the old report preview if the type changes
             document.getElementById('edit-beneficiary-modal').dataset.originalCompType = beneficiary.compensation?.type || defaultCompensation.type;


             // Populate the edit modal form
             document.getElementById('edit-beneficiary-id').value = beneficiary.id;
             document.getElementById('edit-last-name').value = beneficiary.lastName || ''; // Populate lastName
             document.getElementById('edit-first-name').value = beneficiary.firstName || ''; // Populate firstName
             document.getElementById('edit-function').value = beneficiary.function || '';
             document.getElementById('edit-grade').value = beneficiary.grade || '';
             document.getElementById('edit-beneficiary-ccp-input').value = beneficiary.account || ''; // Populate CCP input
              document.getElementById('edit-ss-num').value = beneficiary.ssNum || ''; // Populate SSN
              document.getElementById('edit-dob').value = beneficiary.dob || ''; // Populate DoB

             // Populate compensation fields in the edit modal
             document.getElementById('edit-compensation-type').value = beneficiary.compensation?.type || defaultCompensation.type; // Populate Compensation Type
             document.getElementById('edit-nbr-f').value = beneficiary.compensation?.nbrF || 0;


             // Immediately calculate and display RIP for the edit modal based on loaded CCP
              updateCalculatedRIPDisplay(
                  'edit-beneficiary-ccp-input',
                  'edit-rib',
                  'edit-beneficiary-ccp-feedback'
              );

             // Immediately calculate and display pay in the edit modal based on loaded *compensation inputs*
             updatePayCalculations('edit'); // Use 'edit' form inputs


             // Show the modal
             const modalOverlay = document.getElementById('edit-beneficiary-modal');
             modalOverlay.style.display = 'flex'; // Make it visible using flex
             setTimeout(() => { // Use a small delay to allow display change before adding class
                  modalOverlay.classList.add('visible'); // Add class for transition effects
             }, 10);


             document.getElementById('edit-last-name').focus(); // Focus the first input in the modal

         } catch (e) {
             console.error("Error opening edit modal:", e);
             alert("حدث خطأ أثناء فتح نافذة تعديل المستفيد.");
         }
    }

    function cancelEdit() {
        try {
             const modalOverlay = document.getElementById('edit-beneficiary-modal');

             modalOverlay.classList.remove('visible'); // Remove class for transition effects
             setTimeout(() => {
                  modalOverlay.style.display = 'none'; // Hide after transition
                   // Clear the original compensation type stored in the modal data attribute
                  delete modalOverlay.dataset.originalCompType;

             }, 300); // Match CSS transition duration


             // Clear the edit form fields and feedback
             document.getElementById('edit-beneficiary-form').reset();
             document.getElementById('edit-beneficiary-id').value = '';
             document.getElementById('edit-last-name').value = ''; // Clear lastName
             document.getElementById('edit-first-name').value = ''; // Clear firstName
             document.getElementById('edit-rib').value = '';
             document.getElementById('edit-beneficiary-ccp-input').classList.remove('invalid');
             document.getElementById('edit-beneficiary-ccp-feedback').textContent = '';
             document.getElementById('edit-ss-num').value = '';
             document.getElementById('edit-dob').value = '';

             // Clear compensation fields in edit modal and reset calculated fields
             document.getElementById('edit-nbr-f').value = '0';
             document.getElementById('edit-compensation-type').value = defaultCompensation.type; // Reset type
             document.getElementById('edit-grade').value = 'P-Ser'; // Reset grade in modal

             // Trigger calculation update for the edit form based on reset values to clear readonly fields
             updatePayCalculations('edit');


        } catch (e) {
            console.error("Error cancelling edit:", e);
        }
    }

    function saveEditedBeneficiary(event) {
         event.preventDefault();
         try {
             const beneficiaryId = parseInt(document.getElementById('edit-beneficiary-id').value);
              const modalOverlay = document.getElementById('edit-beneficiary-modal');
             // Retrieve the original type stored when modal opened
             const originalType = modalOverlay.dataset.originalCompType;


             // Get all inputs from the edit modal form
             const editedLastNameInput = document.getElementById('edit-last-name');
             const editedFirstNameInput = document.getElementById('edit-first-name');
             const editedFunctionInput = document.getElementById('edit-function');
             const editedGradeInput = document.getElementById('edit-grade');
             const editedCcpInput = document.getElementById('edit-beneficiary-ccp-input');
             const editedRipDisplay = document.getElementById('edit-rib');
             const editedFeedbackSpan = document.getElementById('edit-beneficiary-ccp-feedback');
             const editedSsNumInput = document.getElementById('edit-ss-num');
             const editedDobInput = document.getElementById('edit-dob');
             const editedCompTypeSelect = document.getElementById('edit-compensation-type');
             const editedNbrFInput = document.getElementById('edit-nbr-f');


             const editedLastName = editedLastNameInput.value.trim();
             const editedFirstName = editedFirstNameInput.value.trim();
             const editedFunction = editedFunctionInput.value.trim();
             const editedGrade = editedGradeInput.value.trim();
             const editedAccount = editedCcpInput.value.trim(); // Edited CCP
             const editedSsNum = editedSsNumInput.value.trim();
             const editedDob = editedDobInput.value;
             const editedCompensationType = editedCompTypeSelect.value;
             const editedNbrF = parseFloat(editedNbrFInput.value) || 0; // Get nbrF input


              // Combine name for validation requiring Latin characters
             const editedFullName = ((editedLastName || '').trim() + ' ' + (editedFirstName || '').trim()).trim();
             // Regex allows Latin letters, spaces, and hyphens
             const latinPattern = /^[a-zA-Z\s\-]+$/;


             // --- Validation ---

            if (!editedLastName || !editedFirstName || !editedAccount || !editedFunction || !editedGrade || !editedCompensationType) {
                alert('الرجاء ملء جميع الحقول الإلزامية في نموذج التعديل.');
                return;
            }

            if (!editedFullName || !latinPattern.test(editedFullName)) {
                alert('الرجاء إدخال اللقب والاسم باستخدام الأحرف اللاتينية والمسافات وعلامة الطرح (-) فقط لضمان صحة ملفات التصدير.');
                editedLastNameInput.focus(); // Focus the first name field for correction
                return;
            }

            // Social Security Number validation (12 digits if not "اجراء")
            if (editedCompensationType !== 'اجراء') {
                if (!/^\d{12}$/.test(editedSsNum)) {
                    alert('رقم الضمان الاجتماعي يجب أن يتكون من 12 رقمًا (أرقام فقط) لهذا النوع من التعويض.');
                    editedSsNumInput.focus();
                    return;
                }
            }

             const editedRip = editedRipDisplay.value;
              if (!editedRip || editedRip.includes('خطأ')) {
                   alert('رقم الحساب (CCP) المعدل غير صالح لحساب رقم RIP. الرجاء التحقق من الرقم المدخل.');
                   editedCcpInput.focus();
                   return;
              }
               // Check for invalid class from the input handler
              if (editedCcpInput.classList.contains('invalid')) {
                  alert(editedFeedbackSpan.textContent || 'رقم الحساب (CCP) المعدل غير صالح.');
                  editedCcpInput.focus();
                  return;
              }


             // Check for duplicate CCP (excluding the beneficiary being edited)
             const cleanedEditedAccount = editedAccount.replace(/\D/g, '');
             const isDuplicateAccount = beneficiaries.some(
                 b => b.id !== beneficiaryId && b.account.replace(/\D/g, '') === cleanedEditedAccount
             );

             if (isDuplicateAccount) {
                 alert(`رقم الحساب (CCP) "${editedAccount}" مسجل بالفعل لمستفيد آخر.`);
                 editedCcpInput.focus();
                 return;
             }

             // Find the beneficiary object in the array
             const beneficiaryIndex = beneficiaries.findIndex(b => b.id === beneficiaryId);

             if (beneficiaryIndex === -1) {
                 alert('خطأ: لم يتم العثور على المستفيد المراد تعديله في قائمة البيانات.');
                 console.error(`Attempted to save non-existent beneficiary ID: ${beneficiaryId}`);
                 cancelEdit(); // Close modal
                 applyBeneficiaryFilter(currentBeneficiaryFilterType); // Refresh tables just in case
                 return;
             }

              const beneficiary = beneficiaries[beneficiaryIndex];


             // --- Perform Pay Calculation based on current modal INPUTS ---
              // Calculate pay directly using input values from the modal
             const calculatedPay = calculatePay(editedCompensationType, editedGrade, editedNbrF);


               // Basic validation of calculated net amount
              if (!isFinite(calculatedPay.net)) {
                  alert("لا يمكن حفظ التعديلات. القيمة النهائية للصافي غير صالحة.\nالرجاء التحقق من مدخلات عدد الساعات/الأوراق أو الصنف في نموذج التعديل.");
                  console.error("Attempted to save beneficiary with invalid calculated net amount:", calculatedPay.net);
                  return;
              }


             // --- Update beneficiary properties ---
             beneficiary.lastName = editedLastName; // Update lastName
             beneficiary.firstName = editedFirstName; // Update firstName
             beneficiary.function = editedFunction;
             beneficiary.grade = editedGrade;
             beneficiary.account = editedAccount;
             beneficiary.ssNum = editedSsNum;
             beneficiary.dob = editedDob;

             // Update compensation data within the beneficiary object using freshly calculated values
              beneficiary.compensation = {
                 type: editedCompensationType, // Save the selected type from input
                 nbrF: editedNbrF, // Save the edited nbrF from input
                 // Use the freshly calculated values:
                 brut: calculatedPay.brut,
                 ss: calculatedPay.ss,
                 irg: calculatedPay.irg,
                 net: calculatedPay.net
              };


             saveData();

             // Apply the current filter after editing, then re-render the table
             applyBeneficiaryFilter(currentBeneficiaryFilterType);


             // Refresh report preview(s) affected by this edit in BOTH report panels if applicable
             // Update the report for the new type
             if (document.getElementById(`reports-${editedCompensationType}-nested-panel`)) {
                 generateReportPreview('reports', editedCompensationType);
             }
              if (document.getElementById(`social-security-reports-${editedCompensationType}-nested-panel`)) {
                 generateReportPreview('social-security-reports', editedCompensationType);
             }

             // Update the report for the old type if it changed
             if (originalType && originalType !== editedCompensationType) {
                 if (document.getElementById(`reports-${originalType}-nested-panel`)) {
                      generateReportPreview('reports', originalType);
                 }
                  if (document.getElementById(`social-security-reports-${originalType}-nested-panel`)) {
                     generateReportPreview('social-security-reports', originalType);
                 }
             }


             alert('تم حفظ تعديلات المستفيد بنجاح.');
             cancelEdit(); // Close the modal
         } catch (e) {
             console.error("Error saving edited beneficiary:", e);
             alert("حدث خطأ أثناء حفظ تعديلات المستفيد.");
         }
    }

    // New function to filter and render the beneficiary table
     function applyBeneficiaryFilter(filterType) {
         currentBeneficiaryFilterType = filterType; // Update the global state variable
          let filteredList = [];

         if (filterType === 'all') {
              filteredList = [...beneficiaries]; // Use a copy of the full list
         } else {
             // Filter by the selected type and ensure net is a finite number
             filteredList = beneficiaries.filter(b => b.compensation?.type === filterType && isFinite(b.compensation?.net));
         }

         renderBeneficiariesTable(filteredList); // Pass the filtered list to the render function

         // Update active button state
         document.querySelectorAll('#beneficiary-filter-buttons button').forEach(button => {
              if (button.getAttribute('data-filter-type') === filterType) {
                  button.classList.add('active');
              } else {
                  button.classList.remove('active');
              }
         });
     }


    // Modify render function to accept the list to display
    function renderBeneficiariesTable(listToRender) {
        try {
            const tableBody = document.getElementById('beneficiaries-table').querySelector('tbody');
             if (!tableBody) {
                  console.error("Beneficiaries table body not found.");
                  return;
             }
            tableBody.innerHTML = ''; // Clear existing rows

            // Use the provided listToRender instead of the global beneficiaries array
            const sortedListToRender = [...listToRender].sort((a, b) => a.id - b.id);

            // The number of visible columns excluding actions is 7 in the main table
            const visibleColumnCount = 7; // الرقم, اللقب, الاسم, تاريخ الميلاد, RIP, نوع التعويض, الصافي للدفع

            if (sortedListToRender.length === 0) {
                 // Adjust colspan for the message row (visible columns + actions column)
                 tableBody.innerHTML = `<tr><td colspan="${visibleColumnCount + 1}" style="text-align: center; color: var(--text-secondary-color);">لا يوجد مستفيدون لعرضهم بهذا النوع من التعويض.</td></tr>`;
                 return;
            }


            sortedListToRender.forEach(beneficiary => {
                 const row = tableBody.insertRow();

                 // Add cells for the 7 visible columns
                 row.insertCell().textContent = beneficiary.id; // الرقم
                 row.insertCell().textContent = beneficiary.lastName || ''; // اللقب
                 row.insertCell().textContent = beneficiary.firstName || ''; // الاسم
                 row.insertCell().textContent = beneficiary.dob || ''; // تاريخ الميلاد
                 row.insertCell().textContent = calculateRIP(beneficiary.account || ''); // رقم RIP الكامل
                 row.insertCell().textContent = compensationTypes[beneficiary.compensation?.type]?.name || 'غير محدد'; // نوع التعويض
                 row.insertCell().textContent = formatCurrency(beneficiary.compensation?.net || 0); // الصافي للدفع


                 // Action buttons cell (now the last cell in the 8-column table)
                 const actionCell = row.insertCell();
                 actionCell.classList.add('actions-cell'); // Add class for styling
                 const actionsContainer = document.createElement('div');
                 actionCell.appendChild(actionsContainer);

                 const editButton = document.createElement('button');
                 editButton.textContent = ' تعديل';
                 editButton.innerHTML = '<i class="fas fa-edit"></i>' + editButton.innerHTML;
                 editButton.classList.add('edit-btn');
                 editButton.title = 'تعديل بيانات المستفيد';
                 editButton.onclick = () => editBeneficiary(beneficiary.id);
                 actionsContainer.appendChild(editButton);

                 const deleteButton = document.createElement('button');
                 deleteButton.textContent = ' حذف';
                 deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>' + deleteButton.innerHTML;
                 deleteButton.classList.add('delete-btn');
                 deleteButton.title = 'حذف المستفيد وجميع بياناته';
                 deleteButton.onclick = () => deleteBeneficiary(beneficiary.id);
                 actionsContainer.appendChild(deleteButton);
            });

        } catch (e) {
            console.error("Error rendering beneficiaries table:", e);
             const tableBody = document.getElementById('beneficiaries-table').querySelector('tbody');
             if (tableBody) {
                  const visibleColumnCount = 7; // Recalculate or use a const
                  tableBody.innerHTML = `<tr><td colspan="${visibleColumnCount + 1}" style="color: var(--danger-color); text-align: center;">حدث خطأ أثناء عرض قائمة المستفيدين: ${e.message || e}.</td></tr>`;
             } else {
                 alert("حدث خطأ فادح أثناء عرض قائمة المستفيدين.");
             }
        }
    }


    // --- Reports ---

     // Function to generate the HTML table for a specific compensation type report
     // Accepts containerId ('reports' or 'social-security-reports') to determine table structure and totals
function generateReportTableHTML(containerId, reportType, forceFullBorders = false) {
        try {
             // Filter beneficiaries based on the requested report type and valid pay
             const filteredBeneficiaries = beneficiaries.filter(b => {
                  const comp = b.compensation;
                 if (comp?.type === reportType) {
                     // For standard reports, filter by finite NET. For SS reports, filter by finite BRUT.
                     // This ensures totals and rows are based on valid calculable amounts.
                      return containerId === 'reports' ? isFinite(comp.net) : isFinite(comp.brut);
                 }
                 return false;
             });


            // Prepare data for rendering, ensuring all fields are present and calculated pay is finite
             const reportData = filteredBeneficiaries.map((b, index) => {
                  // Ensure compensation data exists, add defaults if missing
                  const comp = b.compensation || { type: reportType, nbrF: 0, brut: 0, ss: 0, irg: 0, net: 0 };

                  // Calculate RIP for the report row
                  const rip = calculateRIP(b.account || '');
                  const displayedRip = (rip && !rip.includes('خطأ')) ? rip : 'غير صالح'; // Show 'غير صالح' for invalid RIP

                  // Recalculate Taux for display based on type and grade
                  const effectiveTaux = getTaux(comp.type, b.grade);

                  // Combine lastName and firstName for report display (format: LASTNAME FIRSTNAME)
                  const fullName = ((b.lastName || '').trim() + ' ' + (b.firstName || '').trim()).trim();

                  // Get SS Number
                  const ssNum = b.ssNum || '';

                  // Use stored calculated pay values
                   const brut = comp.brut;
                   const ss = comp.ss;
                   const irg = comp.irg;
                   const net = comp.net;


                 // Return structure varies slightly based on containerId
                 if (containerId === 'reports') {
                     // Standard Reports Columns (11 columns)
                      return `
                          <tr>
                              <td>${index + 1}</td>
                              <td>${fullName}</td>
                              <td>${b.function || ''}</td>
                              <td>${b.grade || ''}</td>
                              <td>${displayedRip}</td>
                              <td>${comp.nbrF || 0}</td>
                              <td>${formatCurrency(effectiveTaux)}</td>
                              <td>${formatCurrency(brut)}</td>
                              <td>${formatCurrency(ss)}</td>
                              <td>${formatCurrency(irg)}</td>
                              <td>${formatCurrency(net)}</td>
                          </tr>
                     `;
                 } else if (containerId === 'social-security-reports') {
                      // Social Security Reports Columns (6 columns)
                      return `
                           <tr>
                               <td>${index + 1}</td>
                               <td>${b.lastName || ''}</td>
                               <td>${b.firstName || ''}</td>
                               <td>${b.dob || ''}</td>
                               <td>${ssNum}</td>
                               <td>${formatCurrency(brut)}</td>
                           </tr>
                      `;
                 }
                 return ''; // Should not happen
            }).join('');


             // Calculate totals based on the *filtered* beneficiaries list
             // Ensure totals are also calculated based on the correct field (Net for reports, Brut for SS)
             const totalBrutNumeric = filteredBeneficiaries.reduce((sum, item) => sum + (isFinite(item.compensation?.brut) ? item.compensation?.brut : 0), 0);
             const totalSsNumeric = filteredBeneficiaries.reduce((sum, item) => sum + (isFinite(item.compensation?.ss) ? item.compensation?.ss : 0), 0);
             const totalIrgNumeric = filteredBeneficiaries.reduce((sum, item) => sum + (isFinite(item.compensation?.irg) ? item.compensation?.irg : 0), 0);
             const totalNetNumeric = filteredBeneficiaries.reduce((sum, item) => sum + (isFinite(item.compensation?.net) ? item.compensation?.net : 0), 0);


            let totalRowHtml = '';
             if (containerId === 'reports') {
                 totalRowHtml = `
                     <tr class="total-row">
                          <!-- Colspan 4 covers اللقب و الاسم, الوظيفة, الصنف, RIB (4 visible columns after hiding N°) -->
                         <td colspan="5">الإجمالي (Total)</td> <!-- Colspan 5 including the hidden N° column in the table structure -->
                         <td></td><!-- Empty cell for Nbr/F -->
                         <td></td><!-- Empty cell for TAUX -->
                         <td>${formatCurrency(totalBrutNumeric)}</td>
                         <td>${formatCurrency(totalSsNumeric)}</td>
                         <td>${formatCurrency(totalIrgNumeric)}</td>
                         <td>${formatCurrency(totalNetNumeric)}</td>
                     </tr>
                 `;
             } else if (containerId === 'social-security-reports') {
                  totalRowHtml = `
                     <tr class="total-row">
                          <!-- Colspan 4 covers اللقب, الاسم, تاريخ الميلاد, رقم الضمان الاجتماعي (4 visible columns after hiding N°) -->
                         <td colspan="5">الإجمالي (Total)</td> <!-- Colspan 5 including the hidden N° column in the table structure -->
                         <td>${formatCurrency(totalBrutNumeric)}</td> <!-- Total BRUT -->
                     </tr>
                 `;
             }


            let tableHtml = '';
            const borderStyle = forceFullBorders ? 'border:2px solid #000 !important;' : '';
            const thtdBorder = forceFullBorders ? 'border:1px solid #000 !important;' : '';
            if (filteredBeneficiaries.length === 0) {
                // Adjust colspan for the message row based on container type
                const messageColspan = containerId === 'reports' ? 11 : 6; // 11 cols for reports, 6 for SS
                tableHtml = `
                    <table class="report-table ${containerId === 'reports' ? 'type-reports' : 'type-ss'}" style="border-collapse:collapse;${borderStyle}">
                       <thead>
                           <tr>
                                ${containerId === 'reports' ? `
                                   <th style="${thtdBorder}">N°</th><th style="${thtdBorder}">اللقب و الاسم<br>(NOM_PRENOM)</th><th style="${thtdBorder}">الوظيفة<br>(FONCTION)</th><th style="${thtdBorder}">الصنف<br>(GRADE)</th><th style="${thtdBorder}">الحساب البنكي<br>(RIB)</th><th style="${thtdBorder}">عدد ${compensationTypes[reportType]?.unit || 'الوحدات'}<br>(Nbr/ F)</th><th style="${thtdBorder}">تعويض ${compensationTypes[reportType]?.unit || 'الوحدة'}<br>(TAUX)</th><th style="${thtdBorder}">المبلغ الخام<br>(BRUT)</th><th style="${thtdBorder}">ضمان اجتماعي<br>(S.S)</th><th style="${thtdBorder}">ضريبة<br>(I.R.G)</th><th style="${thtdBorder}">الصافي<br>(NET)</th>
                                ` : `
                                   <th style="${thtdBorder}">الرقم</th><th style="${thtdBorder}">اللقب</th><th style="${thtdBorder}">الاسم</th><th style="${thtdBorder}">تاريخ الميلاد</th><th style="${thtdBorder}">رقم الضمان الاجتماعي</th><th style="${thtdBorder}">المبلغ الخام<br>(BRUT)</th>
                                `}
                           </tr>
                       </thead>
                       <tbody>
                           <tr><td colspan="${messageColspan}" style="text-align: center; color: var(--text-secondary-color);${thtdBorder}">لا يوجد مستفيدون بهذا النوع من التعويض أو لا توجد بيانات صالحة لإنشاء التقرير.</td></tr>
                       </tbody>
                   </table>
                `;
            } else {
                tableHtml = `
                    <table class="report-table ${containerId === 'reports' ? 'type-reports' : 'type-ss'}" style="border-collapse:collapse;${borderStyle}">
                        <thead>
                            <tr>
                                ${containerId === 'reports' ? `
                                   <th style="${thtdBorder}">N°</th><th style="${thtdBorder}">اللقب و الاسم<br>(NOM_PRENOM)</th><th style="${thtdBorder}">الوظيفة<br>(FONCTION)</th><th style="${thtdBorder}">الصنف<br>(GRADE)</th><th style="${thtdBorder}">الحساب البنكي<br>(RIB)</th><th style="${thtdBorder}">عدد ${compensationTypes[reportType]?.unit || 'الوحدات'}<br>(Nbr/ F)</th><th style="${thtdBorder}">تعويض ${compensationTypes[reportType]?.unit || 'الوحدة'}<br>(TAUX)</th><th style="${thtdBorder}">المبلغ الخام<br>(BRUT)</th><th style="${thtdBorder}">ضمان اجتماعي<br>(S.S)</th><th style="${thtdBorder}">ضريبة<br>(I.R.G)</th><th style="${thtdBorder}">الصافي<br>(NET)</th>
                                ` : `
                                   <th style="${thtdBorder}">الرقم</th><th style="${thtdBorder}">اللقب</th><th style="${thtdBorder}">الاسم</th><th style="${thtdBorder}">تاريخ الميلاد</th><th style="${thtdBorder}">رقم الضمان الاجتماعي</th><th style="${thtdBorder}">المبلغ الخام<br>(BRUT)</th>
                                `}
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData}
                            ${totalRowHtml}
                        </tbody>
                    </table>
                `;
            }


             return tableHtml;
         } catch (e) {
             console.error(`Error generating report table HTML for container "${containerId}" and type "${reportType}":`, e);
             return `<div style="color: var(--danger-color); text-align: center;">حدث خطأ أثناء إنشاء جدول التقرير: ${e.message || e}. الرجاء التحقق من بيانات المستفيدين وتعويضاتهم لنوع التعويض هذا.</div>`;
         }
    }


    function generateReportHTML(containerId, reportType, forPrint = false) {
        try {
            // We need the report data again to calculate totals and get beneficiary count for the header/footer
             const filteredBeneficiaries = beneficiaries.filter(b => {
                   const comp = b.compensation;
                 if (comp?.type === reportType) {
                      // Filter by finiteness based on container type
                      return containerId === 'reports' ? isFinite(comp.net) : isFinite(comp.brut);
                 }
                 return false;
             });

             const totalBeneficiariesCount = filteredBeneficiaries.length;

             // Use correct total based on containerId
             const totalAmountNumeric = containerId === 'reports'
                 ? filteredBeneficiaries.reduce((sum, item) => sum + (isFinite(item.compensation?.net) ? item.compensation?.net : 0), 0)
                 : filteredBeneficiaries.reduce((sum, item) => sum + (isFinite(item.compensation?.brut) ? item.compensation?.brut : 0), 0); // For SS, total is BRUT

             const totalAmountPayableText = numberToArabicText(totalAmountNumeric);

             // Get the custom text for this report type based on containerId
             // Replace YYYY and MM placeholders in the custom text
             const customTextStorage = containerId === 'reports' ? reportCustomText : ssReportCustomText;
             let customText = customTextStorage[reportType] || `[نص مخصص لتقرير "${compensationTypes[reportType]?.name || reportType}" غير محدد]`;
             customText = customText.replace(/YYYY/g, institutionInfo.fiscalYear || '....');
             customText = customText.replace(/MM/g, institutionInfo.financialMonth || '..');


            let html = `
                <div class="report-header">
                    <table class="header-inst-table" style="margin-left:auto;margin-right:auto;border-collapse:collapse;width:auto;border:none;background:none;">
                        <tbody>
                            <tr><td style="text-align:center;font-size:1.2em;font-weight:900;color:#000;font-family:'Arial Black',Arial,sans-serif;padding:1px 12px;border:none;background:none;">${institutionInfo.republic || ''}</td></tr>
                            <tr><td style="text-align:center;font-size:1.2em;font-weight:900;color:#000;font-family:'Arial Black',Arial,sans-serif;padding:1px 12px;border:none;background:none;">${institutionInfo.ministry || ''}</td></tr>
                            <tr><td style="text-align:center;font-size:1.2em;font-weight:900;color:#000;font-family:'Arial Black',Arial,sans-serif;padding:1px 12px;border:none;background:none;">${institutionInfo.directorate || ''}</td></tr>
                            <tr><td style="text-align:center;font-size:1.2em;font-weight:900;color:#000;font-family:'Arial Black',Arial,sans-serif;padding:1px 12px;border:none;background:none;">${institutionInfo.onfed || ''}</td></tr>
                            <tr><td style="text-align:center;font-size:1.2em;font-weight:900;color:#000;font-family:'Arial Black',Arial,sans-serif;padding:1px 12px;border:none;background:none;">${institutionInfo.institution || ''}</td></tr>
                        </tbody>
                    </table>
                    <table class="header-custom-line-table" style="margin-left:auto;margin-right:auto;border-collapse:collapse;width:auto;border:none;background:none;margin-top:8px;margin-bottom:8px;">
                        <tbody>
                            <tr>
                                <td style="text-align:center;font-size:1.8em;font-weight:bold;color:#000;font-family:'Arial Black',Arial,sans-serif;padding:2px 18px;border:none;background:none;">${customText}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                ${generateReportTableHTML(containerId, reportType)} <!-- Insert the generated table -->
                <div class="report-footer">
                    <p>أوقف الجدول على مجموع مستفيدين قدره: ${totalBeneficiariesCount}</p>
                     <!-- Adjust total text based on containerId -->
                    <p>أوقف الجدول على مجموع كلي بالأرقام: ${formatCurrency(totalAmountNumeric)} دج (${containerId === 'reports' ? 'الصافي' : 'الخام'})</p>
                    <p>أوقف الجدول على مجموع كلي بالأحرف: ${totalAmountPayableText} دج</p>
                     ${forPrint ? `
                        <div class="signatures">
                            <div class="signature">
                                <p>المسير المالي</p>
                                 <br><br>
                                <p> </p>
                            </div>
                             <div class="signature">
                                <p>المدير</p>
                                <br><br>
                                <p> </p>
                            </div>
                        </div>
                     ` : ''}
                     <p>${forPrint ? ' ' : (new Date()).toLocaleDateString('ar-DZ')}</p>
                </div>
            `;
            return html;
        } catch (e) {
            console.error(`Error generating report HTML for container "${containerId}" and type "${reportType}":`, e);
             // Return an error message specific to the HTML generation step
            return `<div style="color: var(--danger-color); text-align: center;">حدث خطأ أثناء إنشاء محتوى التقرير لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في الواجهة "${containerId}": ${e.message || e}.</div>`;
        }
    }

    // Generate report preview for a specific type and put it in the correct preview div
    // Modified to accept containerId ('reports' or 'social-security-reports')
    function generateReportPreview(containerId, reportType) {
        const previewAreaId = `${containerId}-report-preview-${reportType}`;
        const previewArea = document.getElementById(previewAreaId);

         if (!previewArea) {
             console.error(`Report preview area not found for container "${containerId}" and type: ${reportType}`);
             return;
         }

         // Generate HTML for the specific report type and container (using forPrint=false for preview)
         const reportContent = generateReportHTML(containerId, reportType, false);

         // Insert the generated HTML into the preview area
         if (reportContent) {
            previewArea.innerHTML = reportContent;
         } else {
             previewArea.innerHTML = `<div style="color: var(--danger-color); text-align: center;">فشل في إنشاء معاينة التقرير لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في الواجهة "${containerId}".</div>`;
         }
    }


     // Print report for a specific type and container
     // Modified to accept containerId ('reports' or 'social-security-reports')
    function printReport(containerId, reportType) {
        try {
            const printContentDiv = document.getElementById('print-report-content');
             if (!printContentDiv) {
                 console.error("Print content div not found.");
                 alert("خطأ داخلي: عنصر الطباعة غير موجود.");
                 return;
             }

             // Generate HTML specifically for printing (includes signatures etc.)
            const reportContent = generateReportHTML(containerId, reportType, true);

             // Check if report generation failed
             if (!reportContent || reportContent.trim() === '' || reportContent.includes('<div style="color: var(--danger-color)')) {
                 alert(`لا يمكن طباعة التقرير لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في الواجهة "${containerId}".\nالرجاء التحقق من معلومات المؤسسة وبيانات التعويض للمستفيدين لهذا النوع.`);
                 printContentDiv.innerHTML = reportContent || `<div style="color: var(--danger-color); text-align: center;">فشل في إنشاء محتوى الطباعة لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في الواجهة "${containerId}".</div>`;
                  console.warn(`Print aborted due to report generation error for container "${containerId}" and type "${reportType}".`);
                  return;
             }

            // Put the generated HTML into the hidden print div
            printContentDiv.innerHTML = reportContent;

            // Use a slight delay to ensure the content is rendered before printing
            setTimeout(() => {
                window.print();

                // Clear the print div after printing (optional, but good practice)
                setTimeout(() => {
                    printContentDiv.innerHTML = '';
                }, 100); // Delay slightly more than the print dialog likely takes
            }, 50); // Small initial delay


        } catch (e) {
            console.error(`Error initiating print for container "${containerId}" and type "${reportType}":`, e);
            alert(`حدث خطأ أثناء محاولة طباعة التقرير لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في الواجهة "${containerId}".`);
        }
    }

    // --- XLSX Export using SheetJS (Filtered by Type and Container) ---
    // Modified to accept containerId ('reports' or 'social-security-reports')
     async function exportXLSX(containerId, reportType) {
         try {
             console.log("Export XLSX: Started for Report Type:", reportType, "Container:", containerId);

              // Filter beneficiaries based on the requested report type and valid pay (Net for reports, Brut for SS)
              const filteredBeneficiaries = beneficiaries.filter(b => {
                  const comp = b.compensation;
                  if (comp?.type === reportType) {
                      // Check finiteness of the relevant amount for this report type
                      return containerId === 'reports' ? isFinite(comp.net) : isFinite(comp.brut);
                  }
                  return false;
              });

              console.log("Export XLSX: Filtered Beneficiaries Count:", filteredBeneficiaries.length);


              // Prepare data for XLSX export (columns vary by containerId)
              const exportData = filteredBeneficiaries.map(b => {
                   // Ensure compensation data exists
                   const comp = b.compensation || { type: reportType, nbrF: 0, brut: 0, ss: 0, irg: 0, net: 0 };

                   // Calculate RIP
                   const rip = calculateRIP(b.account || '');
                   const displayedRip = (rip && !rip.includes('خطأ')) ? rip : 'غير صالح'; // Show 'غير صالح' for invalid RIP

                    // Get the effective taux used in calculation (derived from type/grade)
                   const effectiveTaux = getTaux(comp.type, b.grade);

                    // Combine lastName and firstName for XLSX export (format: LASTNAME FIRSTNAME) - Used in standard report
                   const fullName = ((b.lastName || '').trim() + ' ' + (b.firstName || '').trim()).trim();

                    // Get SS Number
                   const ssNum = b.ssNum || '';

                   // Round numeric values to 2 decimal places for Excel export
                   const brut = Math.round((parseFloat(comp.brut) || 0) * 100) / 100;
                   const ss = Math.round((parseFloat(comp.ss) || 0) * 100) / 100;
                   const irg = Math.round((parseFloat(comp.irg) || 0) * 100) / 100;
                   const net = Math.round((parseFloat(comp.net) || 0) * 100) / 100;


                   // Define the row structure based on the container
                   if (containerId === 'reports') {
                        // Standard Reports Columns (11 columns)
                       return {
                           "N°": b.id,
                           "اللقب و الاسم": fullName,
                           "الوظيفة": b.function || '',
                           "الصنف": b.grade || '',
                           "رقم الحساب البنكي (RIB)": displayedRip,
                           "عدد الوحدات (Nbr/ F)": comp.nbrF || 0,
                           "تعويض الوحدة (TAUX)": effectiveTaux,
                           "المبلغ الخام (BRUT)": isFinite(brut) ? brut : 'خطأ',
                           "ضمان اجتماعي (S.S)": isFinite(ss) ? ss : 'خطأ',
                           "ضريبة (I.R.G)": isFinite(irg) ? irg : 'خطأ',
                           "الصافي للدفع (NET)": isFinite(net) ? net : 'خطأ'
                       };
                   } else if (containerId === 'social-security-reports') {
                        // Social Security Reports Columns (6 columns)
                       return {
                           "الرقم": b.id,
                           "اللقب": b.lastName || '',
                           "الاسم": b.firstName || '',
                           "تاريخ الميلاد": b.dob || '',
                           "رقم الضمان الاجتماعي": ssNum,
                           "المبلغ الخام (BRUT)": isFinite(brut) ? brut : 'خطأ'
                       };
                   }
                   return null; // Should not happen
              }).filter(item => item !== null); // Filter out any null items if logic failed


              exportData.sort((a, b) => {
                   // Sort by ID, key name depends on containerId
                   const idKey = containerId === 'reports' ? "N°" : "الرقم";
                   return a[idKey] - b[idKey];
              });

             console.log("Export XLSX: Prepared Data (first 5 rows):", exportData.slice(0, 5));


              if (exportData.length === 0) {
                  alert(`لا توجد بيانات مستفيدين لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في الواجهة "${containerId}" بـ تعويضات صالحة للتصدير إلى ملف XLSX.\nالرجاء التأكد من وجود مستفيدين بهذا النوع و${containerId === 'reports' ? 'بـ CCP صحيح' : 'ببيانات كاملة'} ومن وجود بيانات تعويض مدخلة لهم وقيم محسوبة صالحة.`);
                  return;
              }

             // Add totals row to the export data array itself
              let totalRow = {};
              let numberCols = []; // Columns that should have number formatting

              if (containerId === 'reports') {
                  const totalBrutNumeric = exportData.reduce((sum, item) => sum + (isFinite(item["المبلغ الخام (BRUT)"]) ? item["المبلغ الخام (BRUT)"] : 0), 0);
                  const totalSsNumeric = exportData.reduce((sum, item) => sum + (isFinite(item["ضمان اجتماعي (S.S)"]) ? item["ضمان اجتماعي (S.S)"] : 0), 0);
                  const totalIrgNumeric = exportData.reduce((sum, item) => sum + (isFinite(item["ضريبة (I.R.G)"]) ? item["ضريبة (I.R.G)"] : 0), 0);
                  const totalNetNumeric = exportData.reduce((sum, item) => sum + (isFinite(item["الصافي للدفع (NET)"]) ? item["الصافي للدفع (NET)"] : 0), 0);

                   // Total row structure for Reports (matches 11 columns)
                  totalRow = {
                       "N°": "", "اللقب و الاسم": "الإجمالي (Total)", "الوظيفة": "", "الصنف": "",
                       "رقم الحساب البنكي (RIB)": "",
                       "عدد الوحدات (Nbr/ F)": null, // Use null for blank numeric cells in total row
                       "تعويض الوحدة (TAUX)": null, // Use null
                       "المبلغ الخام (BRUT)": totalBrutNumeric,
                       "ضمان اجتماعي (S.S)": totalSsNumeric,
                       "ضريبة (I.R.G)": totalIrgNumeric,
                       "الافي للدفع (NET)": totalNetNumeric // FIX: Corrected column name
                  };
                  // FIX: Corrected column names in numberCols array
                  numberCols = ["عدد الوحدات (Nbr/ F)", "تعويض الوحدة (TAUX)", "المبلغ الخام (BRUT)", "ضمان اجتماعي (S.S)", "ضريبة (I.R.G)", "الصافي للدفع (NET)"];

              } else if (containerId === 'social-security-reports') {
                  const totalBrutNumeric = exportData.reduce((sum, item) => sum + (isFinite(item["المبلغ الخام (BRUT)"]) ? item["المبلغ الخام (BRUT)"] : 0), 0);

                   // Total row structure for SS Reports (matches 6 columns)
                  totalRow = {
                       "الرقم": "", "اللقب": "الإجمالي (Total)", "الاسم": "", "تاريخ الميلاد": "", "رقم الضمان الاجتماعي": "",
                       "المبلغ الخام (BRUT)": totalBrutNumeric
                   };
                  numberCols = ["المبلغ الخام (BRUT)"]; // Only BRUT is numeric total here
              }

             console.log("Export XLSX: Total Row Object:", totalRow);
             exportData.push(totalRow); // Add total row
             console.log("Export XLSX: Final Data Length (including total):", exportData.length);


             const ws = XLSX.utils.json_to_sheet(exportData);
             console.log("Export XLSX: Sheet created successfully.");

              // Apply number format to numeric columns (including the total row)
              const colHeaders = Object.keys(exportData[0]);

              if (ws['!ref']) {
                 const range = XLSX.utils.decode_range(ws['!ref']);
                 for (let C = range.s.c; C <= range.e.c; ++C) {
                    const header = colHeaders[C];
                    if (numberCols.includes(header)) {
                       for (let R = range.s.r + 1; R <= range.e.r; ++R) { // Start from row 1 (after header)
                          const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                          const cell = ws[cell_address];
                          // Apply format only to number cells that are NOT null (nulls are blank cells in total row)
                          if (cell && cell.t === 'n' && cell.v !== null) {
                               cell.z = '#,##0.00'; // Excel format with thousand separator and 2 decimals
                          }
                       }
                    }
                 }
              }
             console.log("Export XLSX: Number formatting applied.");


             const wb = XLSX.utils.book_new();
             // FIX: Use the shorter reportType key as the sheet name to avoid the 31-char limit
             const sheetName = reportType; // Use the internal key e.g., 'تصحيح_متوسط'

             // Validate sheetName length before appending
             if (sheetName.length > 31) {
                 const errorMessage = `خطأ: اسم الورقة "${sheetName}" تجاوز الحد الأقصى المسموح به (31 حرفاً). لا يمكن تصدير ملف XLSX لهذا النوع.`;
                 console.error(errorMessage);
                 alert(errorMessage);
                 return; // Stop export
             }
             // Also, replace potentially invalid characters in sheet name (though keys should be safe)
             const safeSheetName = sheetName.replace(/[\\\/\*\?\[\]]/g, '_'); // Replace common invalid sheet characters
              if (safeSheetName !== sheetName) {
                   console.warn(`Export XLSX: Replaced invalid characters in sheet name "${sheetName}" to "${safeSheetName}".`);
              }


              const panelName = containerId === 'reports' ? 'التعويضات' : 'الضمان_الاجتماعي';
             // Use the safeSheetName when appending the sheet
             XLSX.utils.book_append_sheet(wb, ws, safeSheetName);
             console.log(`Export XLSX: Sheet "${safeSheetName}" added to workbook.`);


             // Try using File System Access API first
             // Use the full name for the filename, but the short key for the sheet name
             const fullSheetNameForFilename = compensationTypes[reportType]?.name || reportType;
             const filename = `تقرير_${panelName}_${fullSheetNameForFilename}_${institutionInfo.fiscalYear || 'YYYY'}_${institutionInfo.financialMonth || 'MM'}.xlsx`;

             try {
                 if (window.showSaveFilePicker) {
                     console.log("Export XLSX: Attempting save using showSaveFilePicker...");
                     const options = {
                         suggestedName: filename,
                         types: [{
                             description: 'ملف إكسل (XLSX)',
                             accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']}
                         }]
                     };

                     const fileHandle = await window.showSaveFilePicker(options);

                     const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                     const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                     const writableStream = await fileHandle.createWritable();
                     await writableStream.write(blob);
                     await writableStream.close();

                     console.log(`Export XLSX: File saved successfully via showSaveFilePicker to "${filename}".`);
                     alert('تم حفظ ملف الإكسل في المكان الذي اخترته.');
                     return; // Exit after successful save
                 }
             } catch (error) {
                  // Check if the error is AbortError (user cancelled)
                 if (error.name === 'AbortError') {
                      console.warn("Export XLSX: showSaveFilePicker cancelled by user.");
                      // Do nothing, user cancelled intentionally
                 } else {
                     console.error("Export XLSX: showSaveFilePicker failed, falling back to download.", error);
                     // Fallback if API fails
                      // Fallback download method
                      console.log("Export XLSX: Falling back to standard download method.");
                      XLSX.writeFile(wb, filename);
                      console.log(`Export XLSX: File download initiated for "${filename}".`);
                      alert('تم بدء تنزيل ملف الإكسل. سيطلب منك المتصفح اختيار مكان الحفظ إذا كان يدعم ذلك.\n\nإذا لم يظهر حوار اختيار مكان الحفظ، فيرجى التحقق من إعدادات المتصفح الخاص بك.');
                 }
                  return; // Exit after handling error or fallback
             }

             // This fallback part should only be reached if showSaveFilePicker was not available or explicitly failed *and* the error was not AbortError
             // Since we handle non-AbortError failures within the catch block now,
             // this final fallback section might be redundant if showSaveFilePicker is available.
             // However, keeping it for browsers that don't support showSaveFilePicker at all.
             // If showSaveFilePicker is not available (window.showSaveFilePicker is undefined)
             if (!window.showSaveFilePicker) {
                 console.log("Export XLSX: showSaveFilePicker not available, falling back to standard download method.");
                 XLSX.writeFile(wb, filename);
                 console.log(`Export XLSX: File download initiated for "${filename}".`);
                 alert('تم بدء تنزيل ملف الإكسل. سيطلب منك المتصفح اختيار مكان الحفظ إذا كان يدعم ذلك.\n\nإذا لم يظهر حوار اختيار مكان الحفظ، فيرجى التحقق من إعدادات المتصفح الخاص بك.');
             }


         } catch (e) {
              console.error(`Error during XLSX export process for container "${containerId}" and type "${reportType}":`, e);
              alert(`حدث خطأ أثناء تصدير ملف XLSX لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في الواجهة "${containerId}".`);
         }
     }


    // --- Generate TXT Header Line (Only for 'reports' container) ---
    function generateTxtHeaderLine(reportType) {
        try {
             // This function is ONLY called from the 'reports' container TXT export button
             // If it were called from 'social-security-reports', we would return an error or empty string
             // Let's add a check just in case it's misused, though event listeners prevent this.
             // if (containerId !== 'reports') {
             //     console.error("generateTxtHeaderLine called for non-reports container.");
             //     return '*'.padEnd(61, 'X') + '0'; // Indicate wrong panel error
             // }

            const inst = institutionInfo;

            const startChar = '*'; // 1 char

            // Calculate RIP for the Treasury Account based on saved CCP
            const treasuryRIP = calculateRIP(inst.treasuryAccount || '');

            // Use the calculated RIP (20 chars) if valid, otherwise use error indicator string
            const ripSection = (treasuryRIP && !treasuryRIP.includes('خطأ') && treasuryRIP.length === 20) ? treasuryRIP : '*'.repeat(20); // 20 chars


            // Calculate Total Net Payable for TXT Header (13 chars, in cents)
             // Only include compensation in total if beneficiary has the correct type
             // AND RIP can be calculated AND amount is valid number
             const totalNetPayableNumeric = beneficiaries.reduce((sum, b) => {
                  const comp = b.compensation;
                 const beneficiaryRip = calculateRIP(b.account || '');
                  // Include if beneficiary has the correct type, RIP calc succeeded, and net is a valid number
                 if (comp?.type === reportType && beneficiaryRip && !beneficiaryRip.includes('خطأ') && isFinite(comp.net)) {
                     return sum + (parseFloat(comp.net) || 0);
                 }
                 return sum;
            }, 0);

            const totalPayableCentsString = String(Math.round(totalNetPayableNumeric * 100));
            const finalPaddedTotalPayable = totalPayableCentsString.padStart(13, '0').substring(0, 13); // Pad with leading zeros, ensure max 13 chars


            // Calculate Number of Beneficiaries for TXT body (7 chars)
             // Count beneficiaries who have the correct type
             // AND whose CCP is valid (allows RIP calculation)
             // AND whose COMBINED name is valid (non-empty Latin characters)
             // AND who have valid calculated compensation data (net is finite)
             const numberOfBeneficiariesForBody = beneficiaries.filter(b => {
                  const comp = b.compensation;
                 const rip = calculateRIP(b.account || '');
                 // Use combined name for validation (format: LASTNAME FIRSTNAME)
                 const fullName = ((b.lastName || '').trim() + ' ' + (b.firstName || '').trim()).trim(); // Ensure correct combining order for TXT
                 // Regex allows Latin letters, spaces, and hyphens
                 const latinPattern = /^[a-zA-Z\s\-]+$/;


                 // Include in count if type matches, RIP is calculable, combined name is valid (non-empty & Latin), and net is finite
                 return comp?.type === reportType && rip && !rip.includes('خطأ') && fullName !== '' && latinPattern.test(fullName) && isFinite(comp.net);
             }).length;


            const finalPaddedBeneficiaryCount = String(numberOfBeneficiariesForBody).padStart(7, '0').substring(0, 7); // Pad with leading zeros, ensure max 7 chars


            // Financial Month (2 chars)
            const financialMonth = String(inst.financialMonth || '').trim();
             let finalPaddedFinancialMonth;
             if (financialMonth === '' || !/^\d+$/.test(financialMonth)) {
                  console.warn(`TXT Header Warning: Invalid or missing financial month: "${financialMonth}". Using "00".`);
                  finalPaddedFinancialMonth = '00';
             } else {
                  finalPaddedFinancialMonth = financialMonth.padStart(2, '0').substring(0, 2); // Pad and truncate
             }


            // Fiscal Year (4 chars)
            const fiscalYear = String(inst.fiscalYear || '').trim();
            let finalPaddedFiscalYear;
            if (fiscalYear === '' || !/^\d{4}$/.test(fiscalYear)) {
                 console.warn(`TXT Header Warning: Invalid or missing fiscal year: "${fiscalYear}". Using "0000".`);
                 finalPaddedFiscalYear = '0000';
            } else {
                 finalPaddedFiscalYear = fiscalYear.substring(0, 4); // Truncate to 4 chars if longer, don't pad
            }


            // Order Number (8 chars)
            const orderNumber = String(inst.paymentOrderNum || '').trim(); // Use correct property name
            const paddedOrderNumber = orderNumber.padStart(8, '0').substring(0, 8); // Pad and truncate

            // Transfer Number (6 chars)
            const transferNumber = String(inst.transferNum || '').trim(); // Use correct property name
            const paddedTransferNumber = transferNumber.padStart(6, '0').substring(0, 6); // Pad and truncate


            // Combined field (Order + Transfer) = 8 + 6 = 14 chars
            const orderTransferSection = paddedOrderNumber + paddedTransferNumber;


            // End char (1 char) - Hardcoded '0' based on your file
            const endChar = '0';

             // Header line format: * + TreasuryRIP(20) + TotalNetInCents(13) + BeneficiaryCount(7) + Month(2) + Year(4) + Order+Transfer(14) + 0(1) = 62
            const headerLine = startChar +
                               ripSection +              // 20 chars (Calculated RIP of Treasury CCP)
                               finalPaddedTotalPayable + // 13 chars (Total Net Payable in Cents for this type)
                               finalPaddedBeneficiaryCount + // 7 chars (Number of valid beneficiaries for this type)
                               finalPaddedFinancialMonth + // 2 chars
                               finalPaddedFiscalYear +     // 4 chars
                               orderTransferSection +    // 14 chars (Order + Transfer Numbers)
                               endChar;                     // 1 char (End of header marker)

            // Final length check (should be 62)
            if (headerLine.length !== 62) {
                 console.error(`FATAL: Generated TXT header line has incorrect total length (${headerLine.length}). Generated: "${headerLine}"`);
                 // Return an error indicator string of the correct length
                 return '*'.padEnd(61, 'H') + '0'; // Indicate Header generation error
            }

            return headerLine;

        } catch (e) {
             console.error(`Error generating TXT header line for type "${reportType}":`, e);
             // Return a generic error indicator string of the correct length
             return '*'.padEnd(61, 'E') + '0'; // Indicate general Error
        }
    }


    // --- Generate TXT Record Line for Beneficiary (Only for 'reports' container) ---
    function generateTxtRecordLine(beneficiary) {
        try {
             const comp = beneficiary.compensation;

             // Check if beneficiary and their compensation data are valid for TXT export
             // Removed observations check
             if (!beneficiary || !comp || !isFinite(comp.net) || comp.type === undefined) {
                 console.warn(`Skipping TXT record line for beneficiary ID ${beneficiary?.id}: Invalid compensation data or type.`, comp);
                 return null; // Skip if compensation data is missing or invalid
             }

             const account = String(beneficiary.account || '').trim(); // CCP

             // Combine lastName and firstName for the name field in TXT (format: LASTNAME FIRSTNAME)
             const fullName = ((beneficiary.lastName || '').trim() + ' ' + (beneficiary.firstName || '').trim()).trim();
             // Regex allows Latin letters, spaces, and hyphens
             const latinPattern = /^[a-zA-Z\s\-]+$/;

              // Validate essential data required for the TXT record line itself
              // Added check for non-empty combined name and pattern test
              if (account === '' || fullName === '' || !latinPattern.test(fullName)) {
                  console.warn(`Skipping TXT export record for beneficiary ID ${beneficiary.id}: Invalid account "${account}" or non-Latin/empty name "${fullName}".`);
                   return null; // Skip records with invalid essential data
              }

             // Calculate RIP for this specific beneficiary record
             const fullRIP = calculateRIP(account);
             if (!fullRIP || fullRIP.includes('خطأ')) {
                  console.warn(`Skipping TXT export record for beneficiary ID ${beneficiary.id}: Failed RIP calculation for CCP "${account}" (Result: ${fullRIP}).`);
                  return null; // Skip records where RIP calculation fails
             }

             // --- Build the 62-character string ---
             const startChar = '*'; // 1 char
             const ripSection = fullRIP; // 20 chars, should be valid now
             const netPayableCentsString = String(Math.round((parseFloat(comp.net) || 0) * 100));
             const finalPaddedNetPayable = netPayableCentsString.padStart(13, '0').substring(0, 13); // 13 chars, pad with 0s

             // Name field (27 chars) - Pad with spaces on the right
             const nameLength = fullName.length;
             const spacesNeededForName = 27 - nameLength;
             const finalNameField = (fullName + (spacesNeededForName > 0 ? ' '.repeat(spacesNeededForName) : '')).substring(0, 27); // Ensure max 27 chars


             const endChar = '1'; // 1 char - Hardcoded '1' based on your file

             // Record format: * + BeneficiaryRIP(20) + NetInCents(13) + Name(27) + 1(1) = 62
             const txtRecord = startChar +
                               ripSection +            // 20 chars (Calculated RIP of beneficiary CCP)
                               finalPaddedNetPayable + // 13 chars (Net Payable in Cents)
                               finalNameField +        // 27 chars (Beneficiary Name)
                               endChar;                 // 1 char (End of record marker)


             if (txtRecord.length !== 62) {
                  console.error(`FATAL: Generated TXT record has incorrect length (${txtRecord.length}) for beneficiary ID ${beneficiary.id}. Record: "${txtRecord}". This should not happen if RIP calculation is correct.`);
                  return null; // Indicates a critical error for this record
             }

             return txtRecord;

        } catch (e) {
             console.error(`Error generating TXT record line for beneficiary ID ${beneficiary?.id}:`, e);
             return null; // Indicates an unexpected error for this record
        }
    }


    // --- Export TXT (Only from 'reports' container) ---
     // This function is only triggered by buttons within the 'reports' panel's nested tabs.
     // The logic here correctly filters beneficiaries by the requested reportType and generates
     // the header and record lines based on that filtered data, using the logic from generateTxtHeaderLine
     // and generateTxtRecordLine, which are designed for the standard report structure.
     async function exportTxt(reportType) {
         try {
              // Check if the user is trying to export TXT from the SS panel (shouldn't happen due to button removal, but safety)
              // const currentPanelId = document.querySelector('.tab-panel.active').id;
              // if (currentPanelId !== 'reports-panel') {
              //      console.error("Attempted to export TXT from non-reports panel.");
              //      alert("خطأ: لا يمكن تصدير ملف TXT من هذه الواجهة.");
              //      return;
              // }


              // Generate the header line first
              const headerLine = generateTxtHeaderLine(reportType); // This function already assumes 'reports' context and filters by reportType
               // Check if header line generation failed critically
              if (headerLine.includes('H') || headerLine.includes('E') || headerLine.length !== 62) {
                   alert(`لا يمكن تصدير ملف TXT لنوع التعويض "${compensationTypes[reportType]?.name || reportType}".\nالرجاء التأكد من صحة واكتمال معلومات المؤسسة (حساب الخزينة، الشهر، السنة المالية، رقم الأمر بالصرف، رقم الحوالة) وأنها تحتوي على أرقام فقط حيث يجب، وأن حساب الخزينة صالح لحساب رقم RIP (20 رقماً).`);
                   console.error(`TXT export aborted due to malformed header line for type "${reportType}". Header: "${headerLine}"`);
                   return;
              }


              // Filter beneficiaries by type and generate the data lines, filtering invalid ones
              const txtDataLines = [];
              beneficiaries.forEach(b => {
                   if (b.compensation?.type === reportType) { // Only process beneficiaries with the correct type
                       const recordLine = generateTxtRecordLine(b); // Generate line for this beneficiary (which checks for validity itself)
                       if (recordLine) { // Only add if line generation was successful (valid beneficiary for TXT)
                           txtDataLines.push(recordLine);
                       }
                   }
              });

              let txtContent = headerLine; // Start with the header

              if (txtDataLines.length > 0) {
                  txtContent += '\r\n' + txtDataLines.join('\r\n'); // Use CRLF for line breaks
              } else {
                  // If no valid data lines were generated for this type
                  alert(`تم إنشاء ملف TXT بالسطر الأول (معلومات الدفعة) فقط لنوع التعويض "${compensationTypes[reportType]?.name || reportType}".\n\nلا توجد بيانات مستفيدين صالحة من هذا النوع ليتم تضمينها في جسم الملف.\nالرجاء التأكد من:\n- وجود مستفيدين بنوع التعويض "${compensationTypes[reportType]?.name || reportType}".\n- وجود بيانات تعويض مدخلة لهم.\n- أن لكل مستفيد رقم حساب (CCP) صحيح (14 رقماً غالباً) وقابل لحساب رقم RIP (20 رقماً).\n- أن اللقب و الاسم للمستفيد مكتوبان بالأحرف اللاتينية فقط والمسافات وعلامة الطرح (-).`);
              }


              const blob = new Blob([txtContent], { type: 'text/plain;charset=windows-1256' }); // Use Windows-1256 for Arabic TXT files
              const sheetNameSlug = (compensationTypes[reportType]?.name || reportType).replace(/[^a-zA-Z0-9_\u0600-\u06FF]/g, '_').replace(/__+/g, '_').trim('_'); // Create a file-safe slug including Arabic
              const filename = `PAIE-${institutionInfo.financialMonth || 'MM'}-${institutionInfo.fiscalYear || 'YYYY'}_${sheetNameSlug}.txt`; // Standard naming convention + type slug

             try {
                 if (window.showSaveFilePicker) {
                     const options = {
                         suggestedName: filename,
                         types: [{
                             description: 'ملف نصي (TXT)',
                             accept: {'text/plain': ['.txt']}
                         }]
                     };

                     const fileHandle = await window.showSaveFilePicker(options);

                     const writableStream = await fileHandle.createWritable();
                     await writableStream.write(blob);
                     await writableStream.close();

                     alert(`تم حفظ ملف TXT لنوع التعويض "${compensationTypes[reportType]?.name || reportType}" في المكان الذي اخترته.`);
                     return; // Exit after successful save
                 }
             } catch (error) {
                 console.error("Error using File System Access API for TXT export:", error);
                 // Fallback
             }

             // Fallback download method
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = filename;

             document.body.appendChild(a);
             a.click();

             document.body.removeChild(a);
             URL.revokeObjectURL(url);

              if (txtDataLines.length > 0) {
                 alert(`تم بدء تنزيل ملف TXT لنوع التعويض "${compensationTypes[reportType]?.name || reportType}". سيطلب منك المتصفح اختيار مكان الحفظ إذا كان يدعم ذلك.\n\nإذا لم يظهر حوار اختيار مكان الحفظ، فيرجى التحقق من إعدادات المتصفح الخاص بك.`);
              }
         } catch (e) {
              console.error(`Error during TXT export process for type "${reportType}":`, e);
              alert(`حدث خطأ أثناء تصدير ملف TXT لنوع التعويض "${compensationTypes[reportType]?.name || reportType}".`);
         }
     }


    // --- Backup and Restore Functions ---
     async function createBackup() {
         try {
             const backupData = {
                 institutionInfo: institutionInfo,
                 // Ensure 'observations' is removed from beneficiaries before backing up
                 beneficiaries: beneficiaries.map(b => {
                      const bCopy = {...b}; // Create a shallow copy
                       // No need to explicitly remove observations here as it's not added anymore
                       // if (bCopy.compensation && bCopy.compensation.observations !== undefined) {
                       //      delete bCopy.compensation.observations;
                       // }
                       return bCopy;
                 }),
                 reportCustomText: reportCustomText, // Include standard custom text
                 ssReportCustomText: ssReportCustomText // Include SS custom text
             };

             const jsonString = JSON.stringify(backupData, null, 2);
             const blob = new Blob([jsonString], { type: 'application/json' });
             const now = new Date();
             const filename = `CompData_Backup_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}-${now.getSeconds().toString().padStart(2, '0')}.json`;

             try {
                 if (window.showSaveFilePicker) {
                     const options = {
                         suggestedName: filename,
                         types: [{
                             description: 'ملف نسخة احتياطية (JSON)',
                             accept: {'application/json': ['.json']}
                         }]
                     };

                     const fileHandle = await window.showSaveFilePicker(options);
                     const writableStream = await fileHandle.createWritable();
                     await writableStream.write(blob);
                     await writableStream.close();

                     alert('تم حفظ النسخة الاحتياطية في المكان الذي اخترته.');
                     return;
                 }
             } catch (error) {
                 console.error("Error using File System Access API for backup:", error);
                 // Fallback
             }

             // Fallback download method
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = filename;

             document.body.appendChild(a);
             a.click();

             document.body.removeChild(a);
             URL.revokeObjectURL(url);
             alert('تم بدء تنزيل ملف النسخة الاحتياطية. سيطلب منك المتصفح اختيار مكان الحفظ إذا كان يدعم ذلك.\n\nإذا لم يظهر حوار اختيار مكان الحفظ، فيرجى التحقق من إعدادات المتصفح الخاص بك.');
         } catch (e) {
             console.error("Error during backup creation:", e);
             alert("حدث خطأ أثناء إنشاء النسخة الاحتياطية.");
         }
     }

     function restoreBackup() {
         const fileInput = document.getElementById('restore-file-input');
         fileInput.value = null; // Clear previous selection
         fileInput.click(); // Trigger file selection dialog
     }

     function handleFileSelect(event) {
         const file = event.target.files[0];

         if (!file) {
             return; // User cancelled file selection
         }

         if (!file.name.toLowerCase().endsWith('.json')) {
              alert('الرجاء اختيار ملف JSON صالح لعملية الاستعادة.');
              return;
         }

         const reader = new FileReader();

         reader.onload = (e) => {
             try {
                 const fileContent = e.target.result;
                 const restoredData = JSON.parse(fileContent);

                 // Basic structure validation (check for institutionInfo, beneficiaries array)
                 // ssReportCustomText is optional for compatibility with older backups
                 if (restoredData && restoredData.institutionInfo !== undefined && Array.isArray(restoredData.beneficiaries)) {
                     if (confirm('هل أنت متأكد من استعادة هذه البيانات؟ سيؤدي ذلك إلى مسح البيانات الحالية واستبدالها.\n\nالرجاء التأكد من أن هذا هو ملف النسخة الاحتياطية الصحيح والمتوافق مع هذا البرنامج.')) {
                         // Clear current data in localStorage before storing restored data
                          localStorage.removeItem('institutionInfo');
                          localStorage.removeItem('beneficiaries');
                          localStorage.removeItem('reportCustomText'); // Clear old standard custom text data
                          localStorage.removeItem('ssReportCustomText'); // Clear old SS custom text data


                          // Save restored data to localStorage
                          localStorage.setItem('institutionInfo', JSON.stringify(restoredData.institutionInfo));
                           // Store beneficiaries after ensuring observations is removed during load (handled in loadData)
                          localStorage.setItem('beneficiaries', JSON.stringify(restoredData.beneficiaries));

                          // Save custom text, handling cases where ssReportCustomText might be missing in older backups
                           if (restoredData.reportCustomText !== undefined) {
                                localStorage.setItem('reportCustomText', JSON.stringify(restoredData.reportCustomText));
                           }
                            if (restoredData.ssReportCustomText !== undefined) {
                                localStorage.setItem('ssReportCustomText', JSON.stringify(restoredData.ssReportCustomText));
                           } else {
                                // If ssReportCustomText is missing in backup, initialize with defaults
                                console.warn("ssReportCustomText not found in backup, initializing with defaults.");
                                const ssReportTypesDefaults = ['تصحيح_متوسط', 'تصحيح_ثانوي', 'امانة_تصحيح']; // Include the new type here
                                 const defaultSsText = {};
                                 ssReportTypesDefaults.forEach(typeKey => {
                                      const typeName = compensationTypes[typeKey]?.name || 'نوع غير محدد';
                                      defaultSsText[typeKey] = `كشف بأسماء الأساتذة ... لـ ${typeName} (ضمان اجتماعي) لسنة YYYY الشهر MM.`;
                                 });
                                 localStorage.setItem('ssReportCustomText', JSON.stringify(defaultSsText));
                           }


                         // Reload the application's data from localStorage (applies defaults/recalculation during load)
                         loadData();

                         // Reset filter type after restore
                         currentBeneficiaryFilterType = 'all';

                         // Refresh the currently visible tab (which will re-apply the filter and render)
                         const activeTabButton = document.querySelector('.tab-button.active');
                         if (activeTabButton) {
                              showSection(activeTabButton.getAttribute('data-tab'));
                         } else {
                             // Fallback to showing the first section
                             showSection('institution');
                         }

                         // After successful restore and rendering the active tab,
                         // ensure ALL report previews are updated as the entire dataset changed
                         // Update standard reports
                         Object.keys(compensationTypes).forEach(typeKey => {
                             if (document.getElementById(`reports-${typeKey}-nested-panel`)) {
                                generateReportPreview('reports', typeKey);
                             }
                         });
                          // Update SS reports
                          // Include the new type 'امانة_تصحيح' in the list of types relevant for SS reports
                         ['تصحيح_متوسط', 'تصحيح_ثانوي', 'امانة_تصحيح'].forEach(typeKey => {
                             if (document.getElementById(`social-security-reports-${typeKey}-nested-panel`)) {
                                 generateReportPreview('social-security-reports', typeKey);
                             }
                         });


                         alert('تم استعادة البيانات بنجاح.');
                     }
                 } else {
                     alert('هيكل ملف النسخة الاحتياطية غير صالح. لا يمكن استعادة البيانات.');
                 }
             } catch (error) {
                 alert('حدث خطأ أثناء قراءة أو تحليل ملف النسخة الاحتياطية. قد يكون الملف تالفاً أو بصيغة غير صحيحة.');
                 console.error("Restore error:", error);
              }
          };

         reader.onerror = (error) => {
             alert('حدث خطأ أثناء قراءة الملف.');
             console.error("File reading error:", error);
          };

         reader.readAsText(file);
     }

     // Function to populate beneficiary filter buttons dynamically
     function populateBeneficiaryFilterButtons() {
         const filterButtonContainer = document.getElementById('beneficiary-filter-buttons');
         if (!filterButtonContainer) {
             console.error("Beneficiary filter button container not found.");
             return;
         }

         // Clear existing buttons except "Show All"
         filterButtonContainer.querySelectorAll('button:not([data-filter-type="all"])').forEach(button => button.remove());

         // Add buttons for each compensation type
         Object.keys(compensationTypes).forEach(typeKey => {
             const typeInfo = compensationTypes[typeKey];
             if (typeInfo) {
                 const button = document.createElement('button');
                 button.textContent = typeInfo.name;
                 button.setAttribute('data-filter-type', typeKey);
                 // Add a class or icon if needed, e.g., button.classList.add('filter-btn');
                 button.addEventListener('click', function() {
                     applyBeneficiaryFilter(typeKey);
                 });
                 filterButtonContainer.appendChild(button);
             }
         });
     }

     // Function to save custom report text for a specific type and container
     function saveCustomReportText(containerId, reportType, text) {
          const customTextStorage = containerId === 'reports' ? reportCustomText : ssReportCustomText;
          customTextStorage[reportType] = text.trim(); // Update the custom text object
          saveData(); // Save all data (including the updated custom text)
          generateReportPreview(containerId, reportType); // Update the preview for this type
     }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {

    // --- SSN Real-time Validation (Add Form) ---
    const ssNumInput = document.getElementById('ss-num');
    const ssNumFeedback = document.getElementById('ss-num-feedback');
    const compTypeAddInput = document.getElementById('compensation-type-add');
    function validateSSNum(input, feedbackSpan, compType) {
        const value = input.value.trim();
        const needsSSN = compType !== 'اجراء';
        if (!needsSSN) {
            input.classList.remove('invalid');
            feedbackSpan.textContent = 'غير مطلوب لهذا النوع.';
            feedbackSpan.style.color = '#6c757d';
            return true;
        }
        if (value.length === 0) {
            input.classList.add('invalid');
            feedbackSpan.textContent = 'يرجى إدخال رقم الضمان الاجتماعي (12 رقمًا).';
            feedbackSpan.style.color = 'var(--danger-color)';
            return false;
        }
        if (!/^\d{12}$/.test(value)) {
            input.classList.add('invalid');
            feedbackSpan.textContent = 'رقم الضمان الاجتماعي يجب أن يتكون من 12 رقمًا (أرقام فقط).';
            feedbackSpan.style.color = 'var(--danger-color)';
            return false;
        }
        input.classList.remove('invalid');
        feedbackSpan.textContent = 'صحيح';
        feedbackSpan.style.color = 'var(--success-color)';
        return true;
    }
    function validateAddSSNum() {
        validateSSNum(ssNumInput, ssNumFeedback, compTypeAddInput.value);
    }
    if (ssNumInput && ssNumFeedback && compTypeAddInput) {
        ssNumInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^\d]/g, '').slice(0,12);
            validateAddSSNum();
        });
        compTypeAddInput.addEventListener('change', validateAddSSNum);
        validateAddSSNum();
    }

    // --- SSN Real-time Validation (Edit Modal) ---
    const editSsNumInput = document.getElementById('edit-ss-num');
    const editSsNumFeedback = document.getElementById('edit-ss-num-feedback');
    const editCompTypeInput = document.getElementById('edit-compensation-type');
    function validateEditSSNum() {
        validateSSNum(editSsNumInput, editSsNumFeedback, editCompTypeInput.value);
    }
    if (editSsNumInput && editSsNumFeedback && editCompTypeInput) {
        editSsNumInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^\d]/g, '').slice(0,12);
            validateEditSSNum();
        });
        editCompTypeInput.addEventListener('change', validateEditSSNum);
        validateEditSSNum();
    }

    // زر تفريغ قاعدة البيانات
    const emptyDbBtn = document.getElementById('empty-db-btn');
    if (emptyDbBtn) {
        emptyDbBtn.addEventListener('click', async function() {
            await createBackup();
            if (confirm('هل أنت متأكد أنك تريد تفريغ قاعدة البيانات بالكامل؟ سيتم حذف جميع البيانات نهائياً بعد حفظ نسخة احتياطية.')) {
                localStorage.removeItem('institutionInfo');
                localStorage.removeItem('beneficiaries');
                localStorage.removeItem('reportCustomText');
                localStorage.removeItem('ssReportCustomText');
                localStorage.removeItem('appUser');
                location.reload();
            }
        });
    }
        loadData(); // Load saved data

        // Populate filter buttons AFTER loading data and compensation types
        populateBeneficiaryFilterButtons();


        // Add event listeners for main tab buttons
         document.querySelectorAll('.tab-button').forEach(button => {
             button.addEventListener('click', function() {
                 showSection(this.getAttribute('data-tab'));
             });
         });

        // Add event listeners for forms
        document.getElementById('institution-info-form').addEventListener('submit', saveInstitutionInfo);
        document.getElementById('add-beneficiary-form').addEventListener('submit', addBeneficiary);
        document.getElementById('edit-beneficiary-form').addEventListener('submit', saveEditedBeneficiary);


        // --- Listeners for Add Beneficiary form (includes compensation inputs) ---
         const addCcpInput = document.getElementById('beneficiary-ccp-input');
         const addNbrFInput = document.getElementById('add-nbr-f');
         const addCompTypeInput = document.getElementById('compensation-type-add');
         const addGradeInput = document.getElementById('add-grade');

         if(addCcpInput) {
             addCcpInput.addEventListener('input', () => {
                 updateCalculatedRIPDisplay('beneficiary-ccp-input', 'rib', 'beneficiary-ccp-feedback');
                 // CCP change doesn't directly affect pay calculations, only RIP display
             });
         } else { console.error("Add beneficiary CCP input not found."); }

         if(addNbrFInput) {
              // Listener for Nbr/F input change (triggers recalculation of readonly fields)
              addNbrFInput.addEventListener('input', () => updatePayCalculations('add'));
         } else { console.error("Add Nbr/F input not found."); }

         if(addCompTypeInput) {
              // Listener for Compensation Type change (triggers recalculation of readonly fields)
             addCompTypeInput.addEventListener('change', () => updatePayCalculations('add'));
         } else { console.error("Add Compensation Type select not found."); }

          if(addGradeInput) {
              // Listener for Grade change (triggers recalculation of readonly fields)
              // Use 'input' for grades that might be typed freely (e.g., P-Ser)
              addGradeInput.addEventListener('input', () => updatePayCalculations('add'));
          } else { console.error("Add Grade input not found."); }

         // Add listener for the "Show All" filter button
         const showAllFilterButton = document.querySelector('#beneficiary-filter-buttons button[data-filter-type="all"]');
         if(showAllFilterButton) {
             showAllFilterButton.addEventListener('click', function() {
                 applyBeneficiaryFilter('all');
             });
         } else { console.error("Show All filter button not found."); }


         // --- Listeners for Edit Beneficiary modal (includes compensation inputs) ---
         // Listeners for edit modal inputs will be added/removed when modal is shown/hidden
         // See the event listener setup using `editModalOverlay.addEventListener('transitionend', ...)` below.


         // Add event listener for Treasury CCP input
         document.getElementById('treasury-ccp-input').addEventListener('input', () => {
             updateCalculatedRIPDisplay('treasury-ccp-input', 'treasury-rib', 'treasury-ccp-feedback');
             // Note: Saving institution info also triggers report updates, so no need to update reports here on every input
         });


         // --- Reports Tab Listeners (Nested Tabs and Buttons) ---
         // Add event listeners for nested tab buttons within the reports panel
          const reportsPanel = document.getElementById('reports-panel');
          if (reportsPanel) {
              reportsPanel.querySelectorAll('.nested-tab-button').forEach(button => {
                  button.addEventListener('click', function() {
                      showNestedReportTab('reports', this.getAttribute('data-nested-tab'));
                  });
              });

              // Add input listeners for the custom report text fields using delegation within the reports panel
              reportsPanel.addEventListener('input', function(event) {
                  if (event.target.tagName === 'INPUT' && event.target.id.startsWith('reports-custom-report-text-')) {
                      const reportType = event.target.id.replace('reports-custom-report-text-', '');
                      // Check if the reportType is a valid key in reportCustomText storage
                       if (reportCustomText.hasOwnProperty(reportType)) {
                           saveCustomReportText('reports', reportType, event.target.value);
                       } else {
                           console.warn(`Input on unknown custom text ID ignored: ${event.target.id}`);
                       }
                  }
              });

              // Add event listeners for report action buttons (Print, Excel, TXT) within nested panels of reports panel
              reportsPanel.querySelectorAll('.print-report-btn').forEach(button => {
                   button.addEventListener('click', function() {
                       const reportType = this.getAttribute('data-report-type');
                       printReport('reports', reportType);
                   });
              });
               reportsPanel.querySelectorAll('.export-excel-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const reportType = this.getAttribute('data-report-type');
                        exportXLSX('reports', reportType);
                    });
               });
                reportsPanel.querySelectorAll('.export-txt-btn').forEach(button => {
                     button.addEventListener('click', function() {
                         const reportType = this.getAttribute('data-report-type');
                         exportTxt(reportType); // TXT export logic is tied to standard reports
                     });
                });
          } else { console.error("Reports panel not found."); }


         // --- NEW: Social Security Reports Tab Listeners (Nested Tabs and Buttons) ---
         const ssReportsPanel = document.getElementById('social-security-reports-panel');
          if (ssReportsPanel) {
               // Add event listeners for nested tab buttons within the SS reports panel
               ssReportsPanel.querySelectorAll('.nested-tab-button').forEach(button => {
                   button.addEventListener('click', function() {
                       showNestedReportTab('social-security-reports', this.getAttribute('data-nested-tab'));
                   });
               });

                // Add input listeners for the custom report text fields using delegation within the SS reports panel
               ssReportsPanel.addEventListener('input', function(event) {
                   // FIX: Listen for input on fields starting with 'ss-custom-report-text-'
                   if (event.target.tagName === 'INPUT' && event.target.id.startsWith('ss-custom-report-text-')) {
                       const reportType = event.target.id.replace('ss-custom-report-text-', '');
                        // Check if the reportType is a valid key in ssReportCustomText storage
                        if (ssReportCustomText.hasOwnProperty(reportType)) {
                             // Use 'social-security-reports' containerId when saving custom text for SS reports
                            saveCustomReportText('social-security-reports', reportType, event.target.value);
                        } else {
                            console.warn(`Input on unknown custom text ID ignored: ${event.target.id}`);
                        }
                   }
               });

               // Add event listeners for report action buttons (Print, Excel) within nested panels of SS reports panel
                ssReportsPanel.querySelectorAll('.print-ss-report-btn').forEach(button => {
                     button.addEventListener('click', function() {
                         const reportType = this.getAttribute('data-report-type');
                         printReport('social-security-reports', reportType);
                     });
                });
                ssReportsPanel.querySelectorAll('.export-ss-excel-btn').forEach(button => {
                     button.addEventListener('click', function() {
                         const reportType = this.getAttribute('data-report-type');
                         exportXLSX('social-security-reports', reportType);
                     });
                });
                // TXT export button is intentionally excluded from the HTML in this panel
          } else { console.error("Social Security Reports panel not found."); }


        // --- Backup/Restore Functions ---
         document.getElementById('create-backup-btn').addEventListener('click', createBackup);
         document.getElementById('restore-backup-btn').addEventListener('click', restoreBackup); // This triggers the file input click
         document.getElementById('restore-file-input').addEventListener('change', handleFileSelect); // This handles the file selection


        // Add event listener for the cancel button in the edit modal
        document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);

        // Remove the global edit button listener if it exists
         const globalEditButton = document.querySelector('#beneficiary-panel .edit-global-btn');
         if(globalEditButton) {
             // If you wanted to keep the button but disable it:
             // globalEditButton.setAttribute('disabled', true);
             // globalEditButton.textContent = 'عدّل من الجدول فقط'; // Optional: change text
             // If you want to remove it completely (adjust HTML as well):
             // globalEditButton.remove();
             // For now, just removing the listener as per HTML update
             globalEditButton.removeEventListener('click', function(){}); // Remove any existing listener
             // The HTML element was commented out, so no need to actively remove it here.
         }


        // Show the first main tab by default on page load
        showSection('institution');
    });

    // --- Add/Remove Event listeners for Edit Modal inputs when modal is shown/hidden ---
     const editModalOverlay = document.getElementById('edit-beneficiary-modal');

     if(editModalOverlay) {
         // Use 'transitionend' to reliably add/remove listeners when the modal is fully shown/hidden
         editModalOverlay.addEventListener('transitionend', function() {
             // Get input elements inside the modal
             const editCcpInput = document.getElementById('edit-beneficiary-ccp-input');
             const editNbrFInput = document.getElementById('edit-nbr-f');
             const editCompTypeSelect = document.getElementById('edit-compensation-type');
             const editGradeInput = document.getElementById('edit-grade');


             // Define handler functions (using 'edit' form prefix)
             const handleEditInput = () => updatePayCalculations('edit');
             const handleEditCcpInput = () => updateCalculatedRIPDisplay('edit-beneficiary-ccp-input', 'edit-rib', 'edit-beneficiary-ccp-feedback');


             // Check if the modal is now visible (has the 'visible' class)
             if (editModalOverlay.classList.contains('visible')) {
                 // Add event listeners when modal is shown
                 if (editCcpInput) editCcpInput.addEventListener('input', handleEditCcpInput);
                 if (editNbrFInput) editNbrFInput.addEventListener('input', handleEditInput);
                 if (editCompTypeSelect) editCompTypeSelect.addEventListener('change', handleEditInput);
                 if (editGradeInput) editGradeInput.addEventListener('input', handleEditInput); // Use input for grade


                 // Immediately update RIP and pay calculations on modal open based on populated values
                 handleEditCcpInput(); // Update RIP display in modal
                 handleEditInput(); // Update Pay Calculations display in modal


             } else {
                 // Remove event listeners when modal is hidden (after transition)
                 // This prevents handlers from firing on hidden inputs and is good practice
                  if (editCcpInput) editCcpInput.removeEventListener('input', handleEditCcpInput);
                  if (editNbrFInput) editNbrFInput.removeEventListener('input', handleEditInput);
                  if (editCompTypeSelect) editCompTypeSelect.removeEventListener('change', handleEditInput);
                  if (editGradeInput) editGradeInput.removeEventListener('input', handleEditInput);
             }
         });
     } else {
         console.error("Edit modal overlay not found.");
     }


</script>
</body>
</html>